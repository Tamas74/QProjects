using System;
using System.Collections;
using System.ComponentModel;
using System.Data;
using System.Data.SqlClient;
using System.Drawing;
using System.Runtime.InteropServices;
using System.Text;
using System.Windows.Forms;
using C1.Win.C1FlexGrid;
using gloAuditTrail;
using gloBilling.Collections;
using gloBilling.Common;
using gloContacts;
using gloPatient;
using gloPMGeneral.gloPriorAuthorization;
using gloSettings;
using gloAccountsV2;
using gloEDI;
using ChargeRules;
using System.Collections.Generic;
using System.Linq;
using System.ServiceModel;

namespace gloBilling
{
    public partial class frmBillingModifyCharges : Form
    {
        [DllImport("user32.dll")]
        static extern bool LockWindowUpdate(IntPtr hWnd);

        #region " Variable Declarations

        System.Collections.Specialized.NameValueCollection appSettings = System.Configuration.ConfigurationManager.AppSettings;
        gloBillingTransaction UC_gloBillingTransactionLines;
        gloListControl.gloListControl oListControl;
        private gloListControl.gloListControlType _CurrentControlType = gloListControl.gloListControlType.Other;
        //   private static frmBillingModifyCharges frm;
        Transaction _InitialTransaction = null;
        ClaimHold _oClaimHold = new ClaimHold();
        ClaimStructure _ClaimStructure;
        private ComboBox combo;
        System.Windows.Forms.ToolTip ToolTip1 = new System.Windows.Forms.ToolTip();



        private string _TransStatus = "";
        private string _AlphaIIServerName = "";
        private string _AlphaIIDatabase = "";
        private string _AlphaIIUserName = "";
        private string _AlphaIIPassword = "";
        private string _AlphaIIAuthentication = "";
        private string _AlphaIIValidation = "";
        private string _sClaimNo = "";
        private string _WorkerCompType = "";
        private string _WorkerCompNo = "";
        private string _AutoClaimNo = "";
        private string _OtherAccidentNo = "";
        private string _WorkerInjuryDate = "";
        private string _AccidentDate = "";
        private string _OtherDate = "";
        private string VoidMessage = "";
        private string _RenderingProviderName = "";
        private string PartyNo = "";
        private Int64 _TransAccountID = 0;
        private Boolean _bIsResult = true;
        public Int64 _MasterTransactionID = 0;
        private Int64 _ClaimNo = 0;
        private Int64 _PatientPoviderID = 0;
        private Int64 _ClaimNumberForSaveAndCopay = 0;
        private Int64 _ResendInsuranceId = 0;
        private Int64 _nClaimNo = 0;
        private Int64 _DefaultTOSID = 0;
        private Int64 _DefaultPOSID = 0;
        private Int32 InsParty = 0;
        private int nCurrentResponsibleParty = 0;
        private Int64 _ContactID = 0;
        private Int64 _FeeScheduleID = 0;
        private Int64 _RenderingProviderID = 0;
        private string PriorAuthNo = "";
        private Int64 PriorAuthID = 0;

        private Int32 _NoOfMaxServiceLines = 30;
        private Int32 _NoOfMaxDiagnosis;

        private int _iCurrentResponsiblePosition = 0;
        // private int _iDelCount = 0;
        private int _iDeletedParty = 0;
        private int _iBeforeEditValue = 0;

        private bool _SaveFlag = true;
        private bool _OpenViewMode = false;
        private bool _IsOpenForModify = false;
        private bool _IsOpenForExternal = false;
        private bool _IsEMRTransactionSaved = false;
        private bool _IsSaveCopayStart = false;
        private bool _IsSaveCopayStop = false;
        private bool _IsFormLoading = false;
        private bool _IsBatchModify = true;
        private bool _IsAplhaIIValidated = true;
        private bool _isDxListLoading = false;
        private bool _IsCheckInvalidICD9 = false;
        private bool _IsScrubber = false;
        private bool _FacilityFee = false;
        private bool _IsSaveToHistoryForModify = false;
        private bool _IsOpenForResend = false;
        private bool blnDisposed;
        private bool _IsDayClosed = false;
        public bool isFormLoading = false;
        public bool _isTextBoxLoading = false;
        private bool _isClaimVoided = false;
        private bool _IsModifyed = false;
        // private bool _bIsRightClicked = false;
        public bool _isRemoved = false;
        private bool _IsResnd = false;
        private bool bisDuplicatePlan = false;
        public String _sClaimRefNo = "";
        public Boolean _IsbCliamReplacement = false;
        public Boolean _bIsPlanCorrectRplmnt = false;

        private Int64 nReplacementByTransMasterID = 0;
        private Int64 nReplacingTransMasterID = 0;

        private DateTime _ExternalDateTime = DateTime.Now;
        private TransactionStatus _BatchModifyStatus = TransactionStatus.None;
        private InsuranceTypeFlag _IsResendToInsType = InsuranceTypeFlag.None;
        private DataTable _dtEOBPayments = new DataTable();
        private DataTable _dtEOBNextAction = new DataTable();
        private StringBuilder sb_ExcludeTransDtlID;
        ArrayList _arrDxCodes = null;
        ArrayList _arrValidDxCodes = null;
        DataTable dtC1Insurance = new DataTable();
        ClaimBox19Note _oBox19Note = new ClaimBox19Note();
        ClaimBox19Notes _oBox19Notes = new ClaimBox19Notes();

        private string _sBox10dNote = string.Empty;

        UB04Data oUB = new UB04Data();

        private Boolean _bDxFlag = false;
        private Int64 _IllnessDate;
        private Int64 _LastSeenDate;
        private Int64 _UnableToWorkFromDate_MoreClaimData;
        private Int64 _UnableToWorkTillDate_MoreClaimData;
        //  private bool _mskUnableFromDateEnabled_MoreClaimData=true;
        //   private bool _mskUnableTillDateEnabled_MoreClaimData = true;
        public string DefaultProviderQualifierCode { get; set; }
        private Int64 _nResponsibleParty = 0;
        private Int64 _nPrimaryParty = 0;
        private Int64 nInitialStripPatientID = 0;
        private Int64 nInitialStripAccountID = 0;
        private String nInitialStripGuarantorName = "";
        private bool _isPatientChanged = false;
        private bool _isAccountChanged = false;
        private Int64 CountResponsibilityNo = 0;
        public Int64 _InitialReferalProviderId = 0;
        public Boolean bIsReplacementClaimRequired = false;
        public ReplacementClaimCreationType ReplacementClaimCreationType = ReplacementClaimCreationType.None;
        public Boolean bIsCopiedClaim = false;
        public string DefaultDateQualifierCode { get; set; }
        private bool IsInsurancePaymentClicked =false;
        List<gloUIControlLibrary.Classes.ClaimRules.TriggeredRuleInfo> triggeredRuleInfo = null;
        List<gloUIControlLibrary.Classes.ClaimRules.TriggeredRuleInfo> triggeredRuleInfoGlobal = null;
        private Int64 LastnTransactionId = 0;
        private Int64 LastnTransactionMasterId = 0;
        private DateTime LastnTransactionModifiedDate = DateTime.Now;
        private string sDeletedNoteHistoryID = string.Empty;
        #endregion

        #region Column Contants for C1.Flex.Grid

        // To Define Column Constant for Insurance Grid
        const int COL_SELECT = 0;

        const int COL_INSURANCERESPONSIBILITY = 1;
        const int COL_INSURANCEID = 2;
        const int COL_INSURANCENAME = 3;
        const int COL_INSURANCETYPE = 4;
        const int COL_INSSELFMODE = 5;
        const int COL_INSURANCECOPAYAMT = 6;
        const int COL_INSURANCEWORKERCOMP = 7;
        const int COL_INSURANCEAUTOCLAIM = 8;
        const int COL_INSURANCECONTACTID = 9;
        const int COL_INSURANCEPARTY = 10;
        const int COL_INSVIEW_PARTYSTATUS = 11;
        const int COL_INS_INTERNAL_PARTYSTATUS = 12;
        const int COL_SELECT_CURRENT_RESPONSIBLE_PARTY = 13;
        const int COL_INSURANCEPLANONHOLD = 14;
        const int COL_ISINSTITUTIONALBILLING = 15;
        const int COL_INSVIEW_COUNT = 18;

        const int COL_INSSTARTENDDATE = 16;
        const int COL_INSCOMMENT = 17;

        const int COL_SUBSCRIBERID = 7;
        const int COL_SUBSCRIBERNAME = 8;
        const int COL_SUBSCRIBERGROUPNO = 9;
        const int COL_SUBSCRIBERPOLICYNO = 10;
        const int COL_INSURANCEPAYMENT = 11;
        //const int COL_INSURANCECOPAYAMT = 10;


        const int COL_INSPAYMENT_COUNT = 12;

        const int COL_DX_SELECT = 0;
        const int COL_DX_CODE = 1;
        const int COL_DX_DESC = 2;
        const int COL_DX_ISPRIMARY = 3;
        const int COL_DX_COUNT = 4;
        const int COL_CPT_CODE = 11;
        const int COL_NDCCODE = 86;

        const int COL_EXAM_SELECT = 0;
        const int COL_EXAM_PATIENTID = 1;
        const int COL_EXAM_EXAMID = 2;
        const int COL_EXAM_VISITID = 3;
        const int COL_EXAM_DOS = 4;
        const int COL_EXAM_NAME = 5;
        const int COL_EXAM_EMRPatientCode = 6;
        const int COL_EXAM_EMRPatientFN = 7;
        const int COL_EXAM_EMRPatientMN = 8;
        const int COL_EXAM_EMRPatientLN = 9;
        const int COL_EXAM_EMRPatientSSN = 10;
        const int COL_EXAM_EMRPatientDOB = 11;
        const int COL_EXAM_PROVIDERID = 12;
        const int COL_EXAM_PROVIDERNAME = 13;
        const int COL_EXAM_PROVIDERFNAME = 14;
        const int COL_EXAM_PROVIDERMNAME = 15;
        const int COL_EXAM_PROVIDERLNAME = 16;

        const int COL_EXAM_COUNT = 17;

        #endregion

        #region " Property Procedures "

        private bool PatientHasCases { get; set; }

        public Int64 PatientID
        {
            get { return _TransPatientID; }
            set { _TransPatientID = value; }
        }

        public Int64 ClinicID
        {
            get { return _ClinicID; }
            set { _ClinicID = value; }
        }

        public Int64 UserID
        {
            get { return _UserID; }
            set { _UserID = value; }
        }

        public string UserName
        {
            get { return _UserName; }
            set { _UserName = value; }
        }

        public Int64 PatientPoviderID
        {
            get { return _PatientPoviderID; }
            set { _PatientPoviderID = value; }
        }

        public string PatientProviderName
        {
            get { return _PatientProviderName; }
            set { _PatientProviderName = value; }
        }

        public bool OpenChargesForExternal
        {
            get { return _IsOpenForExternal; }
            set { _IsOpenForExternal = value; }
        }

        public DateTime OpenChargesExternalDateTime
        {
            get { return _ExternalDateTime; }
            set { _ExternalDateTime = value; }
        }

        public bool IsEMRTransactionSaved
        {
            get { return _IsEMRTransactionSaved; }
            set { _IsEMRTransactionSaved = value; }
        }

        public ClaimValidationService ClaimValidationServiceType
        {
            get { return _claimValidationService; }
            set { _claimValidationService = value; }
        }

        public bool OpenViewMode
        {
            get { return _OpenViewMode; }
            set { _OpenViewMode = value; }
        }

        public bool IsBatchModify
        {
            get { return _IsBatchModify; }
            set { _IsBatchModify = value; }
        }

        public bool IsSaveToHistoryForModify
        {
            get { return _IsSaveToHistoryForModify; }
            set { _IsSaveToHistoryForModify = value; }
        }

        public TransactionStatus BatchModifyStatus
        {
            get { return _BatchModifyStatus; }
            set { _BatchModifyStatus = value; }
        }

        public bool FacilityFee
        {
            get { return _FacilityFee; }
            set { _FacilityFee = value; }
        }

        public bool IsOpenForResend
        {
            get { return _IsOpenForResend; }
            set { _IsOpenForResend = value; }
        }

        public InsuranceTypeFlag IsResendToInsType
        {
            get { return _IsResendToInsType; }
            set { _IsResendToInsType = value; }
        }

        public Int64 ResendInsuranceID
        {
            get { return _ResendInsuranceId; }
            set { _ResendInsuranceId = value; }
        }

        public Int64 IsWorkerComp
        {
            get { return _ResendInsuranceId; }
            set { _ResendInsuranceId = value; }
        }

        public Int64 ClaimNo
        {
            get { return _nClaimNo; }
            set { _nClaimNo = value; }
        }

        public String sClaimNo
        {
            get { return _sClaimNo; }
            set { _sClaimNo = value; }
        }

        public bool IsClaimVoided
        {
            get { return _isClaimVoided; }
            set { _isClaimVoided = value; }
        }

        public Int64 RenderingProviderID
        {
            get { return _RenderingProviderID; }
            set { _RenderingProviderID = value; }
        }

        public string RenderingProviderName
        {
            get { return _RenderingProviderName; }
            set { _RenderingProviderName = value; }
        }

        public Boolean IsModified { get; set; }

        public string CallingContainer { get; set; }

        public bool IsPatientChanged
        {
            get { return _isPatientChanged; }
            set { _isPatientChanged = value; }
        }

        public bool IsAccountChanged
        {
            get { return _isAccountChanged; }
            set { _isAccountChanged = value; }
        }

        public bool EPSDTEnabled { get; set; }
        public EPSDTFamilyPlanningClaim ClaimEPSDT { get; set; }


        public bool bIsAnesthesiaEnabled { get; set; }

        //protected override CreateParams CreateParams
        //{
        //    get
        //    {
        //        CreateParams cp = base.CreateParams;
        //        cp.ExStyle |= 0x02000000;
        //        return cp;
        //    }
        //}
        protected override CreateParams CreateParams
        {
            get
            {
                CreateParams cp = base.CreateParams;
                //cp.ExStyle |= 0x02000000;
                //cp.ExStyle |= 0x00000020;//WS_EX_TRANSPARENT
                return cp;
            }
        }

        public bool bEnableSupervisorOption { get; set; }
        public Boolean bIsDublicteCPTsWarningEnable { get; set; }
        private List<long> lstAppointmentIDs = new List<long>();
        private List<PatientAppointment> ListOfPatientAppointments = new List<PatientAppointment>();
        private Boolean MorePatientAppointmentsAvailable = false;
        #endregion

        #region " Constructor "

        public frmBillingModifyCharges(Int64 PatientID, Int64 TransactionID, bool SaveFlag_NewTrue_FalseModify, string databaseConnectionString, string emrdatabaseConnectionString)
        {
            InitializeComponent();
            ReadApplicationSettings();

            this.cmbReferralProvider.DrawMode = DrawMode.OwnerDrawFixed;
            this.cmbReferralProvider.DrawItem += new DrawItemEventHandler(ShowTooltipOnComboBox);

            cmbFacility.DrawMode = DrawMode.OwnerDrawFixed;
            cmbFacility.DrawItem += new DrawItemEventHandler(ShowTooltipOnComboBox);
            _TransPatientID = PatientID;
            _TransactionID = TransactionID;
            _SaveFlag = SaveFlag_NewTrue_FalseModify;
            _DatabaseConnectionString = databaseConnectionString;
            _emrdatabaseConnectionString = emrdatabaseConnectionString;

            //if (oUB != null && Convert.ToString(oUB.sTypeofbill) == "" && oUB.TypeofbillDeleted == false)
            //{
            //    oUB.sTypeofbill = TypeOfBill;
            //}

        }

        private void ReadApplicationSettings()
        {

            _ClinicID = gloGlobal.gloPMGlobal.ClinicID;
            _DatabaseConnectionString = gloGlobal.gloPMGlobal.DatabaseConnectionString;
            _UserID = gloGlobal.gloPMGlobal.UserID;
            _UserName = gloGlobal.gloPMGlobal.UserName;
            _messageBoxCaption = gloGlobal.gloPMGlobal.MessageBoxCaption;
            _IsPatientAccountFeature = gloGlobal.gloPMGlobal.IsAccountsOn;

            #region " Retrieve ClaimValidation from AppSettings "

            if (appSettings["ClaimValidationSetting"] != null)
            {
                if (appSettings["ClaimValidationSetting"] != "")
                {
                    if (appSettings["ClaimValidationSetting"] == "Alpha2")
                    {
                        _claimValidationService = ClaimValidationService.Alpha2;
                    }
                    else if (appSettings["ClaimValidationSetting"] == "YOST")
                    {
                        _claimValidationService = ClaimValidationService.YOST;
                    }
                    else if (appSettings["ClaimValidationSetting"] == "None")
                    {
                        _claimValidationService = ClaimValidationService.None;
                    }
                }
            }
            else
            { _claimValidationService = ClaimValidationService.None; }

            #endregion


        }

        #endregion

        #region " Form Load "
        
        private void frmBillingModifyCharges_Load(object sender, EventArgs e)
        {                
            lblPleaseWait.Show();
            IsUBEnabled = false;
            tls_Top.Enabled = false;
            mskOnsiteDate.BringToFront();
            this.Cursor = Cursors.WaitCursor;
            LockWindowUpdate(this.Handle);
            Int64 _TransMasterID = 0;
            Int64 _nClaimNo = 0;
            DateTime _ModifyDate = DateTime.Now;

            //CFormFlickering pFlickering = new CFormFlickering(this, true);
            if (_TransPatientID > 0 && _TransactionID > 0)
            {
                _IsFormLoading = true;
                PerformFormLoad();
                _IsFormLoading = false;

            }
            else
            {
                MessageBox.Show("Error opening claim. ", _messageBoxCaption, MessageBoxButtons.OK, MessageBoxIcon.Error);
                this.Close();
            }

            //pFlickering.Unfreeze(true);
            this.Cursor = Cursors.Default;
            tls_Top.Enabled = true;
            lblPleaseWait.Hide();
            LockWindowUpdate(IntPtr.Zero);
            oPatientControl.IsCalledFromChargesOrModifyCharges = true;
            UC_gloBillingTransactionLines.IsFormLoading = false;
            cmbClaimCategory.DrawMode = DrawMode.OwnerDrawFixed;
            cmbClaimCategory.DrawItem += new DrawItemEventHandler(ShowTooltipOnComboBox);
            if (rbICD9.Checked)
            { tlsICD10CoddingRules.Visible = false; }
            else
            { tlsICD10CoddingRules.Visible = true; }

            gloCharges.GetMasterTransactionID(_TransactionID, out _TransMasterID, out _nClaimNo, out _ModifyDate);
            LastnTransactionId = _TransactionID;
            LastnTransactionMasterId = _TransMasterID;
            LastnTransactionModifiedDate = _ModifyDate;

            gloSettings.GeneralSettings oSettings = new gloSettings.GeneralSettings(_DatabaseConnectionString);
            object oValue = null;
            oSettings.GetSetting("EnableDublicateCPTsWarning", out oValue);

            if (oValue != null && Convert.ToString(oValue).Trim() != "")
            {
                if (oValue.ToString().ToUpper() == "FALSE")
                    bIsDublicteCPTsWarningEnable = false;
                else
                    bIsDublicteCPTsWarningEnable = true;
            }
        }

        private void PerformFormLoad()
        {
            gloBilling ogloBilling = new gloBilling(_DatabaseConnectionString, _emrdatabaseConnectionString);

            try
            {
                ShowHide(ShowHideType.ModifyLoad);
                Cls_GlobalSettings.IsPaymentVoided = false;
                this.c1Insurance.EnterCell -= new System.EventHandler(this.c1Insurance_EnterCell);

                SetupData(_TransactionID);
                SetCurrentResPartyStatus();

                if (cmbBillingProvider.SelectedIndex >= 0)
                {
                    if (UC_gloBillingTransactionLines != null)
                    {
                        UC_gloBillingTransactionLines.BillingProviderID = Convert.ToInt64(cmbBillingProvider.SelectedValue);
                    }
                }

                ChangeInsuranceGridColor();

                if (_InitialTransaction.IsVoid)
                {
                    IsClaimVoided = true;
                    tls_SplitClaim.Enabled = false;
                }
                else
                {
                    IsClaimVoided = false;
                }

                if (IsClaimVoided == true)
                {
                    SetVoidViewMode();
                    tls_Hold.Enabled = false;
                    FetchVoidedInformation();
                }
                else
                {
                    lblmsgVoid.Text = "";
                }

                if (IsUBEnabled == true && (gloCharges.GetBillingType(_TransactionID, _MasterTransactionID) == Convert.ToInt16(BillingType.Institutional)))
                {
                    tls_AddUBData.Visible = true;

                }
                else
                {
                    tls_AddUBData.Visible = false;
                }

                FillUB04Data(_MasterTransactionID, _TransactionID);

                if (IsClaimVoided != true)
                {
                    SetHoldnMoreClaimDataMesseges();
                }

                SetLastGlobalPeriods();

                #region "Code for Displaying Split Message for parent Claim"

                if (IsClaimVoided != true)
                {

                    //if (ogloBilling.IsClaimSplitted(_InitialTransaction))
                    if (_InitialTransaction.IsClaimSplitted)
                    {
                        tls_FollowUpActionDate.Enabled = false;
                        tsbClaimGenerateTemp.Enabled = false;
                        tls_SplitClaim.Enabled = false;
                    }

                }

                #endregion

                if (cmbFacility.Enabled)
                {
                    cmbFacility.DrawMode = DrawMode.OwnerDrawFixed;
                }
                else
                {
                    cmbFacility.DrawMode = DrawMode.Normal;
                }

                if (cmbReferralProvider.Enabled)
                {
                    cmbReferralProvider.DrawMode = DrawMode.OwnerDrawFixed;
                }
                else
                {
                    cmbReferralProvider.DrawMode = DrawMode.Normal;
                }

                if (bShowInitialTreatmentDate && CmbAccidentType.SelectedIndex == -1)
                {
                    lblInitDate.Visible = false;
                    mskInitTreatment.Visible = false;
                }
                else
                {
                    lblInitDate.Visible = false;
                    mskInitTreatment.Visible = false;
                }
                //this.FillPatientAppointments();
                //this.FillLinkedPatientAppointments();
                this.FillPatientAppointmentsOnLoad();
                CheckForEPSDTEnabled();
                IsAnesthesiaEnabled();
                c1Insurance_KeyPress(null, null);


                if (_InitialTransaction.IsBadDebt == true)
                {
                    SetViewModeForBadDebt();


                }


            }
            catch (Exception ex)
            {
                MessageBox.Show("ERROR : " + ex.Message, _messageBoxCaption, MessageBoxButtons.OK, MessageBoxIcon.Information);
            }
            finally
            {

                ogloBilling.Dispose();
                this.c1Insurance.EnterCell += new System.EventHandler(this.c1Insurance_EnterCell);
                Cls_TabIndexSettings.TabScheme scheme = Cls_TabIndexSettings.TabScheme.AcrossFirst;
                Cls_TabIndexSettings tom = new Cls_TabIndexSettings(this);
                tom.SetTabOrder(scheme);
                txtClaimNo.Focus();
            }

        }

        #endregion " Form Load "

        #region "Form Dispose Methods"

        protected override void Dispose(bool disposing)
        {
            // Check to see if Dispose has already been called. 
            if (!(this.blnDisposed))
            {
                // If disposing equals true, dispose all managed 
                // and unmanaged resources. 
                if ((components != null))
                {
                    components.Dispose();
                }
                if ((disposing))
                {
                    try
                    {
                        gloGlobal.cEventHelper.RemoveAllEventHandlers(this);
                    }
                    catch
                    {
                    }
                    try
                    {
                        System.Windows.Forms.ContextMenuStrip[] cntmenuControls = { cmnu_ChangeInsResponsiblity };
                        System.Windows.Forms.Control[] cntControls = { cmnu_ChangeInsResponsiblity };
                        if (cntmenuControls != null)
                        {
                            if (cntmenuControls.Length > 0)
                            {
                                gloGlobal.cEventHelper.RemoveAllEventHandlers(ref cntmenuControls);

                            }
                        }
                        if (cntControls != null)
                        {
                            if (cntControls.Length > 0)
                            {
                                gloGlobal.cEventHelper.DisposeAllControls(ref cntControls);

                            }
                        }
                        //if (cmnu_ChangeInsResponsiblity != null)
                        //{
                        //    gloGlobal.cEventHelper.RemoveAllEventHandlers(cmnu_ChangeInsResponsiblity);
                        //    if (cmnu_ChangeInsResponsiblity.Items != null)
                        //    {
                        //        cmnu_ChangeInsResponsiblity.Items.Clear();

                        //    }
                        //    cmnu_ChangeInsResponsiblity.Dispose();
                        //    cmnu_ChangeInsResponsiblity = null;
                        //}
                    }
                    catch (Exception ex)
                    {
                        gloAuditTrail.gloAuditTrail.ExceptionLog(ex, false);
                    }

                    // Dispose managed resources. 

                    if ((ToolTip1 != null))
                    {
                        ToolTip1.RemoveAll();
                        ToolTip1.Dispose();
                        ToolTip1 = null;
                    }
                    //frm = Nothing 
                }
                // Release unmanaged resources. If disposing is false, 
                // only the following code is executed. 

                // Note that this is not thread safe. 
                // Another thread could start disposing the object 
                // after the managed resources are disposed, 
                // but before the disposed flag is set to true. 
                // If thread safety is necessary, it must be 
                // implemented by the client. 
            }
            //frm = null;
            this.blnDisposed = true;
            base.Dispose(disposing);
        }

        public void Disposer()
        {
            Dispose(true);
            // Take yourself off of the finalization queue 
            // to prevent finalization code for this object 
            // from executing a second time. 
            System.GC.SuppressFinalize(this);
        }

        #endregion "Form Dispose Methods"

        #region " Public & Private Methods "

        private void CheckForEPSDTEnabled()
        {
            bool bEnableEPSDT = false;
            int iCurrentResponsible = 0;
            try
            {
                Boolean.TryParse(GetSetting("EnableEPSDTFamilyPlanning"), out bEnableEPSDT);

                for (int icount = 1; icount <= c1Insurance.Rows.Count - 1; icount++)
                {
                    if (c1Insurance.GetCellCheck(icount, COL_SELECT_CURRENT_RESPONSIBLE_PARTY) == CheckEnum.Checked)
                    {
                        ////iCurrentResponsible = icount;
                        //if (!c1Insurance.GetData(icount, COL_INSURANCEPARTY).ToString().Replace("/0", "").Contains("X"))
                        //    iCurrentResponsible = Convert.ToInt16(c1Insurance.GetData(icount, COL_INSURANCEPARTY).ToString().Replace("/0", ""));
                        //else
                        iCurrentResponsible = icount;
                        break;
                    }
                }

                //bool bEnableEPSDTPlan = gloCharges.GetPromptForEPSDT(Convert.ToInt64(c1Insurance.GetData(iCurrentResponsible, COL_INSURANCECONTACTID)));
                string sInsuranceIds = string.Empty;
                for (int iCount = 1; iCount <= c1Insurance.Rows.Count - 1; iCount++)
                {
                    Int16 partySequence = 0;
                    Int16.TryParse(Convert.ToString(c1Insurance.GetData(iCount, COL_INSURANCERESPONSIBILITY)), out partySequence);

                    if (Convert.ToString(partySequence) != string.Empty && Convert.ToString(partySequence) != "0")
                    {
                        if (sInsuranceIds == string.Empty)
                        {
                            sInsuranceIds = "'" + Convert.ToString(c1Insurance.GetData(iCount, COL_INSURANCEID)) + "'";
                        }
                        else
                        {
                            sInsuranceIds += ",'" + Convert.ToString(c1Insurance.GetData(iCount, COL_INSURANCEID)) + "'";
                        }
                    }
                }
                bool bEnableEPSDTPlan = gloCharges.GetPromptForEPSDT(oPatientControl.PatientID, sInsuranceIds);
                bool bISClaimEPSDTExists = false;
                bool bISServiceEPSDTExists = false;

                TransactionLines oLineTransactions = UC_gloBillingTransactionLines.GetLineTransactions();
                TransactionLine oLineTransaction = null;
                if (oLineTransactions.Count > 0)
                {
                    for (int iCount = 0; iCount <= oLineTransactions.Count - 1; iCount++)
                    {
                        oLineTransaction = oLineTransactions[iCount];
                        if (oLineTransaction.ServiceFamilyPlanningIndicator || oLineTransaction.ServiceIsTheScreening || oLineTransaction.ServiceIsTheResultOfScreening)
                        {
                            bISServiceEPSDTExists = true;
                            break;
                        }
                    }
                }

                if (ClaimEPSDT.PatientGivenEPSDTReferral || ClaimEPSDT.ClaimIncludeEPSDTScreening)
                {
                    bISClaimEPSDTExists = true;
                }

                if ((bISServiceEPSDTExists || bISClaimEPSDTExists) || (bEnableEPSDTPlan && bEnableEPSDT))
                {
                    EPSDTEnabled = true;
                }
                else
                {
                    EPSDTEnabled = false;
                }

                if (!EPSDTEnabled)
                {
                    tlb_AddEPSDT.Visible = false;
                }
                else
                {
                    tlb_AddEPSDT.Visible = true;
                }
            }
            catch (Exception ex)
            {
                gloAuditTrail.gloAuditTrail.ExceptionLog(ex, false);
            }
        }

        private void IsAnesthesiaEnabled()
        {
            if (!bIsAnesthesiaEnabled)
            {
                tls_Anesthesia.Visible = false;
            }
            else
            {
                tls_Anesthesia.Visible = true;
            }
        }

        private String GetSetting(String SettingName)
        {
            gloSettings.GeneralSettings ogloSettings = new gloSettings.GeneralSettings(_DatabaseConnectionString);
            object value = null;
            string _Result = "";
            try
            {

                ogloSettings.GetSetting(SettingName, out value);
                if (value != null && Convert.ToString(value) != "")
                {
                    _Result = Convert.ToString(value);
                }
            }
            catch (Exception ex)
            {
                gloAuditTrail.gloAuditTrail.ExceptionLog(ex, true);
                _Result = "";
            }
            finally
            {
                ogloSettings.Dispose();
                ogloSettings = null;
            }
            return _Result;
        }

        public void RefreshModifyCharges()
        {


            gloBilling ogloBilling = new gloBilling(_DatabaseConnectionString, _emrdatabaseConnectionString);
            Transaction _Transaction = new Transaction();
            Int64 _ContactId = 0;
            try
            {
                this.c1Insurance.EnterCell -= new System.EventHandler(this.c1Insurance_EnterCell);

                if (oPatientControl.PatientID > 0)
                {


                    c1Insurance_BeforeEdit(null, null);
                    this.c1Insurance.BeforeEdit -= new C1.Win.C1FlexGrid.RowColEventHandler(this.c1Insurance_BeforeEdit);
                    _TransPatientID = oPatientControl.PatientID;
                    SetPatientChangeData(false);
                    //FillPatientInsurances(_TransPatientID);
                    SelectPrimaryInsurance();
                    SetInsuranceParty();
                    GetPatientProvider(_TransPatientID);
                    //FillClaim(_TransPatientID);

                    cmbFacility.SelectedValue = UC_gloBillingTransactionLines.FacilityID;

                    if (UC_gloBillingTransactionLines != null)
                    {
                        UC_gloBillingTransactionLines.PatientID = this.PatientID;
                        UC_gloBillingTransactionLines.DefaultPOSID = _DefaultPOSID;
                        UC_gloBillingTransactionLines.DefaultTOSID = _DefaultTOSID;
                        UC_gloBillingTransactionLines.PatientProviderID = _PatientPoviderID;

                    }

                    //FillReferralProviders(_TransPatientID);

                    //20100503 - Hot Fix Rendering Provider Issue -- To resolve the Same as Billing Provider Issue
                    chk_SameasBillingProvider_CheckedChanged(null, null);

                    #region "Refresh View Claim Button"

                    //GetMasterTransactionID(_TransactionID, out _TransMasterID, out _nClaimNo);
                    //// For View Claim button Visibility
                    //SetViewClaim(_TransMasterID);
                    //

                    #endregion""

                    #region "Get Selected Insurance"

                    string _fillInsuranceName = "";
                    Int64 _fillInsuranceID = 0;
                    Int32 _fillInsSelfMode = 0;

                    if (c1Insurance.Rows.Count > 0)
                    {
                        for (int i = 1; i <= c1Insurance.Rows.Count - 1; i++)
                        {
                            if (c1Insurance.GetCellCheck(i, COL_SELECT) == CheckEnum.Checked)
                            {
                                _fillInsuranceID = Convert.ToInt64(c1Insurance.GetData(i, COL_INSURANCEID));
                                _fillInsuranceName = Convert.ToString(c1Insurance.GetData(i, COL_INSURANCENAME));
                                _fillInsSelfMode = Convert.ToInt32(c1Insurance.GetData(i, COL_INSSELFMODE));
                                break;
                            }
                        }
                    }

                    if (UC_gloBillingTransactionLines != null)
                    {
                        if (_fillInsuranceID > 0)
                        {
                            UC_gloBillingTransactionLines.AddInsurance(UC_gloBillingTransactionLines.CurrentTransactionLine, _fillInsuranceID, _fillInsuranceName, _fillInsSelfMode);
                        }
                    }

                    ChangeInsuranceGridColor();

                    #endregion

                    #region "Mark the Current party "


                    //To Remove the Previous Flag
                    for (int i = 0; i <= c1Insurance.Rows.Count - 1; i++)
                    {
                        c1Insurance.SetCellImage(i, COL_INSURANCERESPONSIBILITY, null);
                        c1Insurance.SetCellCheck(i, COL_SELECT_CURRENT_RESPONSIBLE_PARTY, CheckEnum.Unchecked);
                    }


                    //DataTable _dt = GetCurrentPartyNumber();
                    DataTable _dt = gloCharges.GetCurrentPartyNumber(_TransactionID, _MasterTransactionID);
                    if (_dt != null && _dt.Rows.Count > 0)
                    {

                        Int16 _party = -1;
                        _party = Convert.ToInt16(_dt.Rows[0]["PartyNo"]);

                        c1Insurance.SetCellCheck(_party, COL_SELECT_CURRENT_RESPONSIBLE_PARTY, CheckEnum.Checked);
                        System.Drawing.Image imgFlag = global::gloBilling.Properties.Resources.Normal_Priority;
                        c1Insurance.SetCellImage(_party, COL_INSURANCERESPONSIBILITY, imgFlag);
                        c1Insurance.SetCellCheck(_party, COL_SELECT_CURRENT_RESPONSIBLE_PARTY, CheckEnum.Checked);
                    }

                    if (!_InitialTransaction.IsVoid) // --- If Voided then dont Relaod the Insurance Grid and tool bars buse in void no changes are allowed
                    {
                        IsEditable(_InitialTransaction);
                    }

                    //Method to Display Hold Message indication
                    //**GetHoldMessage();
                    SetHoldnMoreClaimDataMesseges();
                    //**
                    SetLastGlobalPeriods();

                    CheckForEPSDTEnabled();
                    IsAnesthesiaEnabled();

                    for (int iCount = 1; iCount <= c1Insurance.Rows.Count - 1; iCount++)
                    {
                        c1Insurance.SetData(iCount, COL_INSVIEW_PARTYSTATUS, "");
                        c1Insurance.SetData(iCount, COL_INS_INTERNAL_PARTYSTATUS, "");
                    }
                    c1Insurance.SetData(Convert.ToInt16(nCurrentResponsibleParty), COL_INS_INTERNAL_PARTYSTATUS, PartyNo);
                    if (c1Insurance.GetData(Convert.ToInt16(nCurrentResponsibleParty), COL_INSURANCENAME).ToString().ToLower() != "self")
                    {
                        c1Insurance.SetData(Convert.ToInt16(nCurrentResponsibleParty), COL_INSVIEW_PARTYSTATUS, PartyNo);
                    }

                    this.c1Insurance.BeforeEdit += new C1.Win.C1FlexGrid.RowColEventHandler(this.c1Insurance_BeforeEdit);

                    #endregion

                    #region " Expanded Claim Settings "

                    for (int i = 1; i <= c1Insurance.Rows.Count - 1; i++)
                    {
                        if (c1Insurance.GetCellCheck(i, COL_SELECT_CURRENT_RESPONSIBLE_PARTY) == CheckEnum.Checked)
                        {
                            _ContactId = Convert.ToInt64(c1Insurance.GetData(i, COL_INSURANCECONTACTID));
                            break;
                        }
                    }

                    ogloBilling.GetExpandedClaimSetting(_ContactId, _ClinicID, out _NoOfMaxServiceLines, out _NoOfMaxDiagnosis);
                    _Transaction.NoOfServiceLine = _NoOfMaxServiceLines;
                    _Transaction.NoOfDiagnosis = _NoOfMaxDiagnosis;
                    UC_gloBillingTransactionLines._NoOfDiagnosis = _NoOfMaxDiagnosis;
                    UC_gloBillingTransactionLines._NoOfServiceLines = _NoOfMaxServiceLines;

                    #endregion

                }
            }
            catch (Exception ex)
            {
                gloAuditTrail.gloAuditTrail.ExceptionLog(ex, true);
            }
            finally
            {
                this.c1Insurance.EnterCell += new System.EventHandler(this.c1Insurance_EnterCell);
                if (_Transaction != null) { _Transaction.Dispose(); }
                if (ogloBilling != null) { ogloBilling.Dispose(); }
            }


        }

        private bool IsDxSelected()
        {
            bool _result = false;
            try
            {
                for (int i = 1; i < c1Dx.Rows.Count; i++)
                {
                    if (c1Dx.GetCellCheck(i, COL_DX_SELECT) == CheckEnum.Checked)
                    { _result = true; break; }
                }
            }
            catch (Exception ex)
            {
                gloAuditTrail.gloAuditTrail.ExceptionLog(ex, false);
                //ex.ToString();
                //ex = null;
            }
            return _result;
        }

        private ArrayList GetSelectedDx()
        {
            ArrayList _dxlist = new ArrayList();
            for (int i = 1; i < c1Dx.Rows.Count; i++)
            {
                if (c1Dx.GetCellCheck(i, COL_DX_SELECT) == CheckEnum.Checked)
                {
                    _dxlist.Add(Convert.ToString(c1Dx.GetData(i, COL_DX_CODE)).Trim());
                }
            }
            return _dxlist;
        }

        private bool AddTransaction(bool IsSplit)
        {
            gloBilling ogloBilling = new gloBilling(_DatabaseConnectionString, _emrdatabaseConnectionString);
            ClsBL_Hold oClsBL_Hold = new ClsBL_Hold(_DatabaseConnectionString, _emrdatabaseConnectionString);
            Transaction MasterTransaction = new Transaction();
            TransactionInsurance Insurance = new TransactionInsurance();
            TransactionLines oLineTransactions = null;
            clsgloResend oclsgloResend = new clsgloResend();

            SplitClaimDetails oSplitClaimDetails;

            Int64 _returnID = 0;
            Int64 _MasterTransactionPrefixId = 0;
            Int64 _MasterTransactionAppointmentId = 0;
            Int64 _MasterTransactionVisitId = 0;
            Int64 _ContactID = 0;
            Int16 _TempParty = 1;
            Int64 TransactionID = 0;
            DataTable _dtParty = null;
            string _NextActionCode = "T";
            string _NextActionDescription = "Transacted";
            string _InsTransferCloseDate = "";

            bool _result = false;
            bool isFinishEditing;
            bool _IsPartyChanged = false;
            bool _IsMstPartyChanged = false;
            bool bPromptToAlterInsurance = false;
            try
            {


                #region "Get PartyNumber"

                _dtParty = gloCharges.GetCurrentPartyNumber(_TransactionID, _MasterTransactionID);
                //DataTable _dtParty = GetCurrentPartyNumber();

                if (_dtParty != null && _dtParty.Rows.Count > 0)
                {
                    if (Convert.ToInt16(_dtParty.Rows[0]["PartyNo"]) > 0)
                    {
                        _TempParty = Convert.ToInt16(_dtParty.Rows[0]["PartyNo"]);
                        _NextActionCode = Convert.ToString(_dtParty.Rows[0]["sNextActionCode"]);
                    }
                    //Code Added By Debasish
                    for (int iCount = 1; iCount <= c1Insurance.Rows.Count - 1; iCount++)
                    {
                        if (c1Insurance.GetCellCheck(iCount, COL_SELECT_CURRENT_RESPONSIBLE_PARTY) == CheckEnum.Checked)
                        {
                            _TempParty = Convert.ToInt16(iCount);
                        }
                    }
                    //**
                }
                _dtParty = null;

                #endregion

                //***********************************************
                //Fields not implemented yet, so hard coded

                _MasterTransactionPrefixId = 123;
                _MasterTransactionAppointmentId = 999;
                _MasterTransactionVisitId = 987;

                //***********************************************

                mskClaimDate.TextMaskFormat = MaskFormat.ExcludePromptAndLiterals;
                if (mskClaimDate.Text != "")
                {
                    mskClaimDate.TextMaskFormat = MaskFormat.IncludePromptAndLiterals;
                    UC_gloBillingTransactionLines.ColseDate = mskClaimDate.Text;

                }
                else
                {
                    UC_gloBillingTransactionLines.ColseDate = "";
                    mskClaimDate.TextMaskFormat = MaskFormat.IncludePromptAndLiterals;
                }



                if (_dtEOBPayments != null && _dtEOBPayments.Rows.Count > 0)
                {
                    DateTime dr = Convert.ToDateTime(_dtEOBPayments.Compute("MIN(dtCloseDate)", String.Empty));

                    if (dr != null)
                    {
                        UC_gloBillingTransactionLines.MaxPaymentDate = dr.ToShortDateString();
                    }
                    else
                    {
                        UC_gloBillingTransactionLines.MaxPaymentDate = "";
                    }
                }

                for (int iCount = 1; iCount <= c1Insurance.Rows.Count - 1; iCount++)
                {
                    if (c1Insurance.GetCellCheck(iCount, COL_SELECT_CURRENT_RESPONSIBLE_PARTY) == CheckEnum.Checked)
                    {
                        UC_gloBillingTransactionLines._nCurrentContactID = Convert.ToInt64(c1Insurance.GetData(iCount, COL_INSURANCECONTACTID));
                    }
                }

                #region " Save Transaction "

                if (!(UC_gloBillingTransactionLines == null))
                {
                    isFinishEditing = UC_gloBillingTransactionLines.FinishEditing();

                    if (ValidateMasterTransaction())
                    {
                        UC_gloBillingTransactionLines.IsPlanOrAdminEPSDTEnabled = EPSDTEnabled;
                        if (UC_gloBillingTransactionLines.ValidateTransaction(_InitialTransaction))
                        {
                            if (IsDxSelected())
                            {
                                if (UC_gloBillingTransactionLines.ValidateDxList(GetSelectedDx(), IsSplit))
                                {

                                    #region " Check for Insurance Responsibility Transfer "


                                    if (IsPartyChanged())
                                    {

                                        //Added by Subashish_b on 11/Mar /2011 (integration made on date-10/May/2011) for  checking whether patient is changed (if yes then it will not allow to split the claim )***
                                        if (!_isPatientChanged)
                                        {
                                            _IsPartyChanged = true;
                                            isReponsibilityTransfer = _IsPartyChanged;
                                        }

                                    }
                                    else
                                    {
                                        _IsPartyChanged = false;
                                        isReponsibilityTransfer = _IsPartyChanged;
                                    }

                                    #endregion

                                    if (_IsPartyChanged && _IsResnd)
                                    {
                                        _IsResnd = false;
                                        MasterTransaction.IsResend = true;
                                    }
                                    else
                                    {
                                        MasterTransaction.IsResend = false;
                                    }


                                    bPromptToAlterInsurance = gloCharges.CheckForSplitClaim(_InitialTransaction.TransactionID);
                                    if (bPromptToAlterInsurance)
                                    {
                                        if (_InitialTransaction.IsClaimSplitted)
                                        {
                                            _IsMstPartyChanged = IsPartyChanged(true);
                                        }
                                    }

                                    //    oLineTransactions = new TransactionLines();
                                    if (_TransactionID <= 0)
                                    {
                                        txtClaimNo.Text = gloCharges.FormattedClaimNumberGeneration(Convert.ToString(GenerateClaimNumber()));
                                    }


                                    #region " Transaction Object "

                                    //MasterTransaction.ClaimNo = Convert.ToInt64(txtClaimNo.Text);
                                    MasterTransaction.ClaimNo = Convert.ToInt64(sClaimNo);
                                    MasterTransaction.SubClaimNo = txtClaimNo.Tag.ToString();
                                    MasterTransaction.CaseNoPrefix = "Claim ";
                                    MasterTransaction.AppointmentID = _MasterTransactionAppointmentId;
                                    MasterTransaction.ClinicID = _ClinicID;
                                    MasterTransaction.FacilityCode = Convert.ToString(cmbFacility.SelectedValue);
                                    MasterTransaction.FacilityDescription = Convert.ToString(cmbFacility.Text);
                                    oLineTransactions = UC_gloBillingTransactionLines.GetLineTransactions();
                                    MasterTransaction.Lines = oLineTransactions;
                                    MasterTransaction.MaritalStatus = oPatientControl.PatientsMaritalStatus; //"Single";
                                    //MasterTransaction.MasterAppointmentID = 2111;
                                    MasterTransaction.PatientID = _TransPatientID;
                                    MasterTransaction.PrefixID = _MasterTransactionPrefixId;
                                    MasterTransaction.ProviderID = Convert.ToInt64(cmbBillingProvider.SelectedValue);

                                    //Code added on 20090505 by - Sagar Ghodke

                                    MasterTransaction.TransactionUserID = this.UserID;
                                    MasterTransaction.TransactionUserName = this.UserName;

                                    //End Code add 20090505,Sagar Ghodke

                                    //Added by Subashish_b on 20/Jan /2011 (integration made on date-10/May/2011) for  set the PAF values to the MasterTransaction object

                                    MasterTransaction.AccountPatientID = this.nAccountPatientID;
                                    MasterTransaction.PAccountID = this.nPAccountID;
                                    MasterTransaction.GuarantorID = this.nGuarantorID;
                                    MasterTransaction.PatientID = this.PatientID;

                                    //End
                                    if (rbICD10.Checked == true)
                                        MasterTransaction.nICDRevision = (int)gloGlobal.gloICD.CodeRevision.ICD10;
                                    if (rbICD9.Checked == true)
                                        MasterTransaction.nICDRevision = (int)gloGlobal.gloICD.CodeRevision.ICD9;

                                    if (CmbAccidentType.Text.Trim() == "Work")
                                    {
                                        //if (txt_WcAc.Text.Trim() != "")
                                        //{
                                        //if (CheckWC(1) == true)
                                        //{
                                        MasterTransaction.WorkersCompNo = txt_WcAc.Text;
                                        mskInjuryDate.TextMaskFormat = MaskFormat.IncludeLiterals;

                                        if (IsValidDate(mskInjuryDate.Text))
                                        { MasterTransaction.InjuryDate = gloDateMaster.gloDate.DateAsNumber(mskInjuryDate.Text.ToString()); }
                                        else
                                        { MasterTransaction.InjuryDate = 0; }
                                        MasterTransaction.WorkersComp = true;
                                        MasterTransaction.WorkersCompPrintonCMS1500 = chkPrintWorkersComp.Checked;
                                        MasterTransaction.State = string.Empty;
                                        //}
                                        //}
                                    }
                                    else if (CmbAccidentType.Text.Trim() == "Auto")
                                    {
                                        //if (txt_WcAc.Text.Trim() != "")
                                        //{
                                        //if (CheckWC(2) == true)
                                        //{
                                        MasterTransaction.WorkersCompNo = txt_WcAc.Text;
                                        mskAccidentDate.TextMaskFormat = MaskFormat.IncludeLiterals;

                                        if (IsValidDate(mskAccidentDate.Text))
                                        { MasterTransaction.AccidentDate = gloDateMaster.gloDate.DateAsNumber(mskAccidentDate.Text.ToString()); }
                                        else
                                        { MasterTransaction.AccidentDate = 0; }
                                        //}
                                        MasterTransaction.AutoClaim = true;

                                        if (cmbState != null && cmbState.Items.Count > 0 & cmbState.SelectedIndex != -1)
                                        {
                                            MasterTransaction.State = cmbState.Text;
                                        }
                                        //}
                                    }
                                    else if (CmbAccidentType.Text.Trim() == "Other")
                                    {
                                        mskOtherDate.TextMaskFormat = MaskFormat.IncludeLiterals;

                                        if (IsValidDate(mskOtherDate.Text))
                                        { MasterTransaction.OtherAccidentDate = gloDateMaster.gloDate.DateAsNumber(mskOtherDate.Text.ToString()); }
                                        else
                                        { MasterTransaction.OtherAccidentDate = 0; }
                                        MasterTransaction.OtherAccident = true;

                                        MasterTransaction.State = string.Empty;
                                    }
                                    else
                                    {
                                        mskOnsiteDate.TextMaskFormat = MaskFormat.IncludeLiterals;

                                        if (IsValidDate(mskOnsiteDate.Text))
                                        { MasterTransaction.OnsiteDate = gloDateMaster.gloDate.DateAsNumber(mskOnsiteDate.Text.ToString()); }
                                        else
                                        { MasterTransaction.OnsiteDate = 0; }
                                        MasterTransaction.AutoClaim = false;
                                        MasterTransaction.WorkersComp = false;
                                        MasterTransaction.State = string.Empty;
                                    }


                                    //if (IsValidDate(mskUnableFromDate.Text))
                                    //{ MasterTransaction.UnableToWorkFromDate = gloDateMaster.gloDate.DateAsNumber(mskUnableFromDate.Text.ToString()); }
                                    //else
                                    //{ MasterTransaction.UnableToWorkFromDate = 0; }

                                    //if (IsValidDate(mskUnableTillDate.Text))
                                    //{ MasterTransaction.UnableToWorkTillDate = gloDateMaster.gloDate.DateAsNumber(mskUnableTillDate.Text.ToString()); }
                                    //else
                                    //{ MasterTransaction.UnableToWorkTillDate = 0; }

                                    if (_UnableToWorkFromDate_MoreClaimData > 0)
                                    { MasterTransaction.UnableToWorkFromDate = _UnableToWorkFromDate_MoreClaimData; }
                                    else
                                    { MasterTransaction.UnableToWorkFromDate = 0; }

                                    if (_UnableToWorkTillDate_MoreClaimData > 0)
                                    { MasterTransaction.UnableToWorkTillDate = _UnableToWorkTillDate_MoreClaimData; }
                                    else
                                    { MasterTransaction.UnableToWorkTillDate = 0; }

                                    //oTransaction.ProviderQualifierCode = Convert.ToString(dtTrans.Rows[0]["sProviderQualifier"]);
                                    //oTransaction.ClaimBox15QualifierCode = Convert.ToString(dtTrans.Rows[0]["sBox15DateQualifier"]);
                                    //oTransaction.ClaimBox15Date = Convert.ToDateTime(dtTrans.Rows[0]["dtBox15Date"]);


                                    // changes for default date qualification validation  12182013 Sameer
                                    if (IsValidDate(mskBox15Date.Text))
                                    {
                                        MasterTransaction.ClaimBox15Date = Convert.ToDateTime(mskBox15Date.Text);
                                        MasterTransaction.ClaimBox15QualifierCode = Convert.ToString(cmbBox15DateQualifier.SelectedValue);
                                    }
                                    else
                                    {
                                        MasterTransaction.ClaimBox15Date = null;
                                        MasterTransaction.ClaimBox15QualifierCode = null;
                                    }

                                    if (IsValidDate(mskOnsiteDate.Text) && mskOnsiteDate.MaskCompleted)
                                    {
                                        MasterTransaction.ClaimBox14QualifierCode = Convert.ToString(cmbBox14DateQualifier.SelectedValue);
                                    }
                                    else
                                    {
                                        MasterTransaction.ClaimBox14QualifierCode = null;
                                    }

                                    //if (cmbBox15DateQualifier != null && cmbBox15DateQualifier.SelectedValue != null && cmbBox15DateQualifier.SelectedValue.ToString() != "")
                                    //{ MasterTransaction.ClaimBox15QualifierCode = Convert.ToString(cmbBox15DateQualifier.SelectedValue); }
                                    //else
                                    //{ MasterTransaction.ClaimBox15QualifierCode = ""; }

                                    //if (cmbProviderType != null && cmbProviderType.SelectedValue != null && cmbProviderType.SelectedValue.ToString() != "")
                                    //{ MasterTransaction.ProviderQualifierCode = Convert.ToString(cmbProviderType.SelectedValue); }
                                    //else
                                    //{ MasterTransaction.ProviderQualifierCode = ""; }

                                    MasterTransaction.TransactionDate = gloDateMaster.gloDate.DateAsNumber(mskClaimDate.Text.ToString());

                                    if (_IsOpenForModify == true)
                                    {
                                        MasterTransaction.TransactionID = _TransactionID;
                                        MasterTransaction.TransactionMasterID = _MasterTransactionID;
                                    }
                                    else
                                    {
                                        MasterTransaction.TransactionID = 0;
                                    }
                                    MasterTransaction.TransactionMode = TransactionType.Billed;
                                    MasterTransaction.VisitID = _MasterTransactionVisitId;


                                    if (IsValidDate(mskHospitaliztionFrom.Text))
                                    { MasterTransaction.HospitalizationDateFrom = gloDateMaster.gloDate.DateAsNumber(mskHospitaliztionFrom.Text.ToString()); }
                                    else
                                    { MasterTransaction.HospitalizationDateFrom = 0; }

                                    if (IsValidDate(mskInitTreatment.Text))
                                    { MasterTransaction.dtInitTreatmentDate = Convert.ToDateTime(mskInitTreatment.Text); }
                                    else
                                    {
                                        MasterTransaction.dtInitTreatmentDate = null;
                                    }


                                    mskHospitaliztionTo.TextMaskFormat = MaskFormat.IncludeLiterals;
                                    if (IsValidDate(mskHospitaliztionTo.Text))
                                    { MasterTransaction.HospitalizationDateTo = gloDateMaster.gloDate.DateAsNumber(mskHospitaliztionTo.Text.ToString()); }
                                    else
                                    { MasterTransaction.HospitalizationDateTo = 0; }


                                    MasterTransaction.OutSideLab = chkOutSideLab.Checked;
                                    if (chkOutSideLab.Checked)
                                    {
                                        MasterTransaction.OutSideLabCharges = Convert.ToDecimal(txtOutSideLabCharges.Text.Trim());
                                    }
                                    MasterTransaction.CLIANumber = Convert.ToString(txtClaimCLIAno.Text);
                                    
                                    MasterTransaction.Insurances = new TransactionInsurances();
                                    Insurance.ClinicID = _ClinicID;
                                    Insurance.TransactionID = MasterTransaction.TransactionID;  //oLineTransactions[0].TransactionId;
                                    Insurance.TransactionDetailID = 0;
                                    Insurance.TransactionLineNo = 0;
                                    MasterTransaction.Insurances.Add(Insurance);

                                    if (txtPriorAuthorizationNo.Tag != null)
                                    {
                                        Int64 _PriorAuthorizationNo = 0;
                                        if (Int64.TryParse(txtPriorAuthorizationNo.Tag.ToString(), out _PriorAuthorizationNo))
                                        {
                                            MasterTransaction.PriorAuthorizationID = Convert.ToInt64(txtPriorAuthorizationNo.Tag);

                                            if (!MasterTransaction.PriorAuthorizationID.Equals(0))
                                            { MasterTransaction.PriorAuthorizationNo = txtPriorAuthorizationNo.Text.Trim(); }
                                        }
                                    }

                                    if (cmbReferralProvider.Text != "")
                                    {
                                        if (chk_SameasBillingProvider.Checked == true)
                                        {
                                            ////////Commented By Debasish Das on 10th June 2010
                                            ////////_ContactID = RegisterProviderAsPhysician(Convert.ToInt64(cmbBillingProvider.SelectedValue));

                                            //////FillReferralProviders(PatientID);
                                            //////cmbReferralProvider.Text = cmbBillingProvider.Text;
                                            //////for (int i = 0; i < cmbReferralProvider.Items.Count; i++)
                                            //////{
                                            //////    cmbReferralProvider.SelectedIndex = i;

                                            //////    if (cmbReferralProvider.Text == cmbBillingProvider.Text)
                                            //////    {
                                            //////        break;
                                            //////    }
                                            //////}
                                            ////////***
                                        }

                                        if (cmbReferralProvider.Items.Count > 0 && cmbReferralProvider.SelectedIndex != -1)
                                        {
                                            MasterTransaction.ReferralProviderID = Convert.ToInt64(cmbReferralProvider.SelectedValue);
                                            MasterTransaction.ReferralProviderName = cmbReferralProvider.Text;

                                            //By Debasish Das on 16th June 2010
                                            MasterTransaction.ReferalProviderID_New = Convert.ToInt64(cmbReferralProvider.SelectedValue);
                                            //***
                                        }
                                        if (cmbProviderType != null && cmbProviderType.SelectedValue != null && cmbProviderType.SelectedValue.ToString() != "")
                                        { MasterTransaction.ProviderQualifierCode = Convert.ToString(cmbProviderType.SelectedValue); }
                                        else
                                        { MasterTransaction.ProviderQualifierCode = ""; }


                                    }
                                    else
                                    {
                                        MasterTransaction.ProviderQualifierCode = null;
                                    }
                                    MasterTransaction.SendCounter = 0;
                                    MasterTransaction.SendToRejection = 0;

                                    //if (cmbCloseDayTray.SelectedIndex >= 0)
                                    //{
                                    //    //20100204 Mahesh Nawal Add the filter description wise and then save the data
                                    //    DataRowView dvr = (DataRowView)cmbCloseDayTray.SelectedItem;

                                    //    dvr.DataView.RowFilter = "sDescription='" + lblCloseDayTray.Text.Replace("'", "''") + "'";
                                    //    if (dvr != null)
                                    //    {
                                    //        // cmbCloseDayTray.ValueMember = lblCloseDayTray.Text;
                                    //        // _CloseDayTrayID = Convert.ToInt64(cmbCloseDayTray.SelectedValue.ToString());
                                    //        //_CloseDayTrayID = Convert.ToInt64(lblCloseDayTray.Tag.ToString());
                                    //        _CloseDayTrayID = Convert.ToInt64(dvr.Row["nChargeTrayID"]);
                                    //        _CloseDayTrayCode = dvr.Row["sCode"].ToString();
                                    //        _CloseDayTrayName = cmbCloseDayTray.Text;
                                    //    }
                                    //    if (dvr != null) { dvr = null; }
                                    //}
                                    //MasterTransaction.CloseDayTrayID = _CloseDayTrayID;
                                    //MasterTransaction.CloseDayTrayCode = _CloseDayTrayCode;
                                    //MasterTransaction.CloseDayTrayName = _CloseDayTrayName;

                                    MasterTransaction.CloseDayTrayID = _selectedChargeTrayId;
                                    MasterTransaction.CloseDayTrayCode = "";
                                    MasterTransaction.CloseDayTrayName = _selectedChargeTrayDescription;


                                    if (_IsOpenForModify == true || _IsBatchModify == true)
                                    {
                                        if (txtClaimLastStatus.Text.Trim() != "")
                                        {
                                            MasterTransaction.Transaction_Status = ((TransactionStatus)Convert.ToInt32(txtClaimLastStatus.Text.Trim()));
                                        }

                                        if (txtSendCounter.Text.Trim() != "")
                                        { MasterTransaction.SendCounter = Convert.ToInt32(txtSendCounter.Text); }

                                        if (txtSendToRejection.Text.Trim() != "")
                                        { MasterTransaction.SendToRejection = Convert.ToInt32(txtSendToRejection.Text); }
                                    }
                                    else
                                    {
                                        MasterTransaction.Transaction_Status = TransactionStatus.Queue;
                                    }

                                    MasterTransaction.LastStatusId = Convert.ToInt64(txtLastStatusId.Text.Trim());
                                    MasterTransaction.SendToInsuranceFlag = this._IsResendToInsType;

                                    //**End code add
                                    if (oLineTransactions != null && oLineTransactions.Count > 0)
                                    { _TransactionID = oLineTransactions[0].TransactionId; }

                                    //Code added on 20091104 By - Mukesh Patel
                                    //Added by Subashish_b on 20/Jan /2011 (integration made on date-10/May/2011) for  saving the transaction changes in the transaction history and track history  table

                                    ////if (_IsOpenForModify == true && _TransactionID > 0)
                                    ////{
                                    ////    if (IsSaveToHistoryForModify == true)
                                    ////    {
                                    ////        Int64 _trnHstId = 0;
                                    ////        _trnHstId = ogloBilling.SaveTransactionHistory(_TransactionID, UserID, UserName);
                                    ////        ogloBilling.SaveTransactionTrackHistory(MasterTransaction.TransactionMasterID, _TransactionID, UserID, UserName);
                                    ////    }
                                    ////}

                                    //End

                                    #region " Insurance Plan "

                                    if (oPatientControl != null)
                                    {
                                        //DataTable _dtInsurance;
                                        Int64 _InsuranceID = 0;

                                        String _InsuranceName = "";
                                        InsuranceTypeFlag _InsurancePrimarySecondaryTertiary = InsuranceTypeFlag.None;
                                        PayerMode _InsuranceSelfMode = PayerMode.None;
                                        if (c1Insurance.Rows.Count > 0)
                                        {
                                            for (int i = 1; i < c1Insurance.Rows.Count; i++)
                                            {
                                                if (c1Insurance.GetData(i, COL_INSURANCERESPONSIBILITY) != null && c1Insurance.GetData(i, COL_INSURANCERESPONSIBILITY).ToString().Trim().Length > 0)
                                                {

                                                    Int16 _Party = 0;

                                                    if (Int16.TryParse(c1Insurance.GetData(i, COL_INSURANCERESPONSIBILITY).ToString(), out  _Party) == true)
                                                    {
                                                        if (_Party > 0)
                                                        {
                                                            TransactionInsurancePlan _InsurancePlan = new TransactionInsurancePlan();
                                                            _InsurancePlan.TransactionId = _MasterTransactionID;//_TransactionID;
                                                            _InsurancePlan.PatientId = _TransPatientID;
                                                            _InsurancePlan.ClaimNo = _ClaimNo;
                                                            _InsurancePlan.InsuranceID = Convert.ToInt64(c1Insurance.GetData(i, COL_INSURANCEID));
                                                            _InsurancePlan.ContactID = Convert.ToInt64(c1Insurance.GetData(i, COL_INSURANCECONTACTID));



                                                            _InsurancePlan.ResponsibilityNo = _Party;
                                                            _InsurancePlan.ResponsibilityType = Convert.ToInt16(c1Insurance.GetData(i, COL_INSSELFMODE));

                                                            if (_TempParty == _Party)
                                                            {
                                                                _TempParty = _Party;
                                                                _InsuranceID = _InsurancePlan.InsuranceID;
                                                                _InsuranceName = Convert.ToString(c1Insurance.GetData(i, COL_INSURANCENAME));
                                                                _InsuranceSelfMode = (PayerMode)_InsurancePlan.ResponsibilityType;
                                                                _ContactID = _InsurancePlan.ContactID;

                                                                if (Convert.ToString(c1Insurance.GetData(i, COL_INSURANCETYPE)) == InsuranceTypeFlag.Primary.ToString())
                                                                { _InsurancePrimarySecondaryTertiary = InsuranceTypeFlag.Primary; }
                                                                else if (Convert.ToString(c1Insurance.GetData(i, COL_INSURANCETYPE)) == InsuranceTypeFlag.Secondary.ToString())
                                                                { _InsurancePrimarySecondaryTertiary = InsuranceTypeFlag.Secondary; }
                                                                else if (Convert.ToString(c1Insurance.GetData(i, COL_INSURANCETYPE)) == InsuranceTypeFlag.Tertiary.ToString())
                                                                { _InsurancePrimarySecondaryTertiary = InsuranceTypeFlag.Tertiary; }
                                                                else
                                                                { _InsurancePrimarySecondaryTertiary = InsuranceTypeFlag.None; }

                                                            }

                                                            _InsurancePlan.ClinicID = _ClinicID;
                                                            MasterTransaction.InsurancePlans.Add(_InsurancePlan);
                                                        }
                                                    }
                                                    else
                                                    {

                                                    }
                                                }
                                            }
                                        }

                                        MasterTransaction.InsuranceID = _InsuranceID;
                                        MasterTransaction.ContactID = _ContactID;
                                        MasterTransaction.ResponsibilityNo = _TempParty;
                                        MasterTransaction.ResponsibilityType = _InsuranceSelfMode;


                                        for (int i = 0; i < MasterTransaction.Lines.Count; i++)
                                        {
                                            MasterTransaction.Lines[i].InsuranceID = _InsuranceID;
                                            MasterTransaction.Lines[i].InsuranceName = _InsuranceName;
                                            MasterTransaction.Lines[i].InsurancePrimarySecondaryTertiary = _InsurancePrimarySecondaryTertiary.ToString();
                                            MasterTransaction.Lines[i].InsuranceSelfMode = _InsuranceSelfMode;
                                        }

                                    }

                                    #endregion

                                    if (!UC_gloBillingTransactionLines.ValidateDOS(MasterTransaction.Lines, _InitialTransaction))
                                    {
                                        return false;
                                    }



                                    if (_IsPartyChanged == true)
                                    {

                                        frmInsTransCloseDate ofrmInsTransCloseDate = new frmInsTransCloseDate(_DatabaseConnectionString, _InitialTransaction.TransactionID, _InitialTransaction.TransactionMasterID, mskClaimDate.Text);
                                        ofrmInsTransCloseDate.ShowDialog(this);

                                        if (ofrmInsTransCloseDate.oDialogResult)
                                        {
                                            _InsTransferCloseDate = ofrmInsTransCloseDate.InsTransferCloseDate;
                                            responsiblitytransferdate = _InsTransferCloseDate;
                                            ofrmInsTransCloseDate.Dispose();

                                        }
                                        else
                                        {
                                            responsiblitytransferdate = string.Empty;
                                            ofrmInsTransCloseDate.Dispose();
                                            return false;
                                        }


                                    }





                                    #region " Fee-Schedule "

                                    if (chkFeeSchedule.Checked)
                                    {
                                        MasterTransaction.FeeScheduleType = FeeScheduleType.UserSelected;
                                        if (cmbFeeSchedule.SelectedValue != null)
                                        {
                                            MasterTransaction.FeeScheduleID = Convert.ToInt64(cmbFeeSchedule.SelectedValue);
                                        }
                                    }
                                    else
                                    {
                                        if (UC_gloBillingTransactionLines.Fee_ScheduleType == FeeScheduleType.CPT && Convert.ToInt64(cmbFeeSchedule.SelectedValue) > 0)
                                        {
                                            MasterTransaction.FeeScheduleType = UC_gloBillingTransactionLines.Fee_ScheduleType;
                                            MasterTransaction.FeeScheduleID = Convert.ToInt64(cmbFeeSchedule.SelectedValue);
                                        }
                                        else
                                        {
                                            MasterTransaction.FeeScheduleType = UC_gloBillingTransactionLines.Fee_ScheduleType;
                                            MasterTransaction.FeeScheduleID = UC_gloBillingTransactionLines.Fee_ScheduleID;
                                        }
                                    }
                                    if (chkFacilityFeeSchedule.Checked == true)
                                    { MasterTransaction.FacilityType = FacilityType.Facility; }
                                    else if (chkNonFacilityCharges.Checked == true)
                                    { MasterTransaction.FacilityType = FacilityType.NonFacility; }
                                    else
                                    { MasterTransaction.FacilityType = FacilityType.None; }

                                    #endregion " Fee-Schedule "

                                    #endregion

                                    if (MasterTransaction != null && MasterTransaction.Lines != null && MasterTransaction.Lines.Count > 0)
                                    {

                                        MasterTransaction.ClaimEPSDT = ClaimEPSDT;
                                        MasterTransaction.Hold = _oClaimHold;//Added By Debasish on 20th Apr 2010.


                                        if (chk_SameasBillingProvider.Checked)
                                        {
                                            MasterTransaction.IsSameAsBillingProvider = true;
                                        }
                                        else
                                        {
                                            MasterTransaction.IsSameAsBillingProvider = false;
                                        }

                                        MasterTransaction.IsReplacementClaim = _IsbCliamReplacement;

                                        MasterTransaction.IllnessDate = _IllnessDate;
                                        MasterTransaction.LastSeenDate = _LastSeenDate;
                                        MasterTransaction.UnableToWorkFromDate = _UnableToWorkFromDate_MoreClaimData;
                                        MasterTransaction.UnableToWorkTillDate = _UnableToWorkTillDate_MoreClaimData;

                                        MasterTransaction.DelayReasonCodeID = _sDelayReasonCode;
                                        MasterTransaction.ServiceAuthExceCode = _sServiceAuthExceptionCode;
                                        MasterTransaction.MedicaidResubmissioncode = _sMedicaidResubmissionCode;

                                        MasterTransaction.PWKReportTypeCode = _sPWKReportTypeCode; 
                                        MasterTransaction.PWKReportTransmissionCode = _sPWKReportTransmissionCode; 
                                        MasterTransaction.PWKAttachmentControlNumber = _sPWKAttachmentControlNumber;
                                        MasterTransaction.MammogramCertNumber = _sMammogramCertNumber;
                                        MasterTransaction.IDENo = _sIDENo; 
                                        if (Convert.ToString(txtCases.Tag) != string.Empty)
                                        {
                                            MasterTransaction.CaseID = Convert.ToInt64(txtCases.Tag);
                                        }
                                        else
                                        {
                                            MasterTransaction.CaseID = 0;
                                        }
                                        MasterTransaction.CaseName = Convert.ToString(txtCases.Text);
                                        MasterTransaction.bIsRefprovAsSupervisor = bIsRefProvAsSupervisor;
                                        if (Convert.ToInt64(cmbClaimCategory.SelectedValue) > 0)
                                        {
                                            MasterTransaction.nClaimCategoryID = Convert.ToInt64(cmbClaimCategory.SelectedValue);
                                        }
                                        else
                                        {
                                            MasterTransaction.nClaimCategoryID = 0;
                                        }

                                        bool IsMammogramCPTPresent = false;
                                        if (MasterTransaction.Lines != null && MasterTransaction.Lines.Count > 0)
                                        {
                                            string sMammogramNo = string.Empty;
                                            for (int i = 0; i <= MasterTransaction.Lines.Count - 1; i++)
                                            {
                                                IsMammogramCPTPresent = gloCharges.IsMammogramCPTPresentOnClaim(MasterTransaction.Lines[i].CPTCode);
                                                if (IsMammogramCPTPresent)
                                                {
                                                    break;
                                                }
                                            }
                                        }
                                        if (MasterTransaction.MammogramCertNumber != "")
                                        {
                                            if (IsMammogramCPTPresent == false)
                                            {
                                                MasterTransaction.MammogramCertNumber = "";
                                            }
                                        }
                                        else
                                        {
                                            if (IsMammogramCPTPresent)
                                            {
                                                DialogResult dgWarning = MessageBox.Show("Missing Mammogram Certification number\nBilling mammogram procedure requires reporting of mammogram certification number on claim. Missing mammogram certification number may cause rejection.\nDo you want to continue? \n\nYes: Save claim without Mammogram Certification Number.\n No: Add Mammogram Certification Number in More Claim Data.", _messageBoxCaption, MessageBoxButtons.YesNo, MessageBoxIcon.Warning, MessageBoxDefaultButton.Button2);

                                                if (dgWarning == DialogResult.No)
                                                {
                                                    return false;
                                                }
                                                else if (dgWarning == DialogResult.Yes)
                                                {
                                                    gloAuditTrail.gloAuditTrail.CreateAuditLog(ActivityModule.Billing, ActivityCategory.SetupCharges, ActivityType.Modify, "User hit Yes on Mammogram certification warning while modify charge.", MasterTransaction.PatientID, MasterTransaction.TransactionID, MasterTransaction.ProviderID, ActivityOutCome.Success);
                                                }
                                            }
                                        }
                                        #region "Check Duplicate CPT and Diagnosis"
                                        if (bIsDublicteCPTsWarningEnable == true)
                                        {
                                            if (MasterTransaction.Lines.Count > 0)
                                            {
                                                List<string> sCPTCodes = new List<string>();
                                                for (int i = 0; i < MasterTransaction.Lines.Count; i++)
                                                {
                                                    sCPTCodes.Add(MasterTransaction.Lines[i].CPTCode);
                                                }

                                                List<string> sDuplicateCPTs = sCPTCodes.GroupBy(x => x).Where(g => g.Count() > 1).Select(y => y.Key).ToList();
                                                if (sDuplicateCPTs.Count > 0)
                                                {
                                                    if ((MessageBox.Show("Procedure: Duplicate procedure code entered. \n Stop to review?", _messageBoxCaption, MessageBoxButtons.YesNo, MessageBoxIcon.Warning, MessageBoxDefaultButton.Button1)) == DialogResult.Yes)
                                                    {
                                                        return false;
                                                    }
                                                }
                                                sCPTCodes = null;
                                                sDuplicateCPTs = null;

                                                for (int i = 0; i < MasterTransaction.Lines.Count; i++)
                                                {
                                                    List<string> sDxCodes = new List<string>();

                                                    sDxCodes.Add(MasterTransaction.Lines[i].Dx1Code != "" ? MasterTransaction.Lines[i].Dx1Code : "1");
                                                    sDxCodes.Add(MasterTransaction.Lines[i].Dx2Code != "" ? MasterTransaction.Lines[i].Dx2Code : "2");
                                                    sDxCodes.Add(MasterTransaction.Lines[i].Dx3Code != "" ? MasterTransaction.Lines[i].Dx3Code : "3");
                                                    sDxCodes.Add(MasterTransaction.Lines[i].Dx4Code != "" ? MasterTransaction.Lines[i].Dx4Code : "4");
                                                    string sCurrentCPT = MasterTransaction.Lines[i].CPTCode;
                                                    List<string> sDuplicateDxCode = sDxCodes.GroupBy(x => x).Where(g => g.Count() > 1).Select(y => y.Key).ToList();
                                                    if (sDuplicateDxCode.Count > 0)
                                                    {
                                                        MessageBox.Show("Diagnosis: Same diagnosis entered twice for the procedure code : \"" + sCurrentCPT + "\".\n Stop to Review.  ", _messageBoxCaption, MessageBoxButtons.OK, MessageBoxIcon.Warning);
                                                        return false;
                                                    }
                                                    sDxCodes = null;
                                                    sDuplicateDxCode = null;
                                                }
                                            }
                                        }
                                        #endregion "Check Duplicate CPT and Diagnosis"
                                        //Saving Data to Database - Updates The Tracking Tables
                                        TransactionID = ogloBilling.AddTransactionClaim(MasterTransaction, _ClinicID);
                                        if (MasterTransaction != null)
                                        {
                                            if (_IsPatientAccountFeature)
                                            {
                                                if (_InitialTransaction.PAccountID != MasterTransaction.PAccountID)
                                                    ogloBilling.UpdateClaimAccount(_MasterTransactionID, MasterTransaction.PAccountID);
                                            }
                                        }

                                        //Update UB Claim Details
                                        if (tls_AddUBData.Visible == true && oUB != null)
                                        {
                                            ogloBilling.UBClaimSave(MasterTransaction, _MasterTransactionID, _TransactionID, _ClinicID, oUB.sTypeofbill, oUB.sAdmissionType, oUB.sAdmitDate, oUB.sAdmitHour, oUB.sDischargeHour, oUB.sDischargeStatus);
                                        }
                                        //*****

                                        //*******MP
                                        #region " Update Master claim Lines Data on Split Claims "

                                        gloDatabaseLayer.DBLayer oDBsplit = new gloDatabaseLayer.DBLayer(_DatabaseConnectionString);
                                        gloDatabaseLayer.DBParameters oDBParameters1 = new gloDatabaseLayer.DBParameters();
                                        oDBsplit.Connect(false);
                                        for (int i = 0; i < MasterTransaction.Lines.Count; i++)
                                        {
                                            oDBParameters1.Clear();
                                            oDBParameters1.Add("@nTransactionID", MasterTransaction.Lines[i].TransactionId, ParameterDirection.Input, SqlDbType.BigInt);
                                            oDBParameters1.Add("@nTransactionDetailID", MasterTransaction.Lines[i].TransactionDetailID, ParameterDirection.Input, SqlDbType.BigInt);
                                            oDBsplit.Execute("BL_UP_SPLITCLIAMS", oDBParameters1);
                                        }
                                        oDBsplit.Dispose();

                                        #endregion


                                        MasterTransaction.TransactionID = _MasterTransactionID;

                                        //Modified by Pramod Nair For Split Claims -- 
                                        string _NextAction = "";
                                        DataTable dtNextAction = gloCharges.GetNextAction(_MasterTransactionID);
                                        if (dtNextAction != null && dtNextAction.Rows.Count > 0)
                                        {
                                            _NextAction = Convert.ToString(dtNextAction.Rows[0]["sNextActionCode"]);
                                        }

                                        _NextAction = _NextActionCode;



                                        #region "Add Next Party Action"

                                        //if (!ogloBilling.IsClaimSplitted(_InitialTransaction))
                                        if (!_InitialTransaction.IsClaimSplitted)
                                        {
                                            if (MasterTransaction != null && MasterTransaction.Lines != null)
                                            {
                                                for (int i = 0; i < MasterTransaction.Lines.Count; i++)
                                                {


                                                    if (_InitialTransaction != null)
                                                    {
                                                        if (_InitialTransaction.Transaction_Status != TransactionStatus.InsurancePaid && _IsPartyChanged == false)
                                                        {
                                                            //Updates only the Responsibility No,ContactID and InsuranceID
                                                            if (MasterTransaction.Lines[i].InsuranceSelfMode == PayerMode.Self)
                                                            {
                                                                // ogloBilling.UpdateNextParty(MasterTransaction.ClaimNo, MasterTransaction.SubClaimNo, MasterTransaction.TransactionMasterID, MasterTransaction.Lines[i].TransactionMasterDetailID, MasterTransaction.TransactionID, MasterTransaction.Lines[i].TransactionDetailID, MasterTransaction.PatientID, oPatientControl.PatientName, _TempParty, PayerMode.Self, 0, MasterTransaction.Lines[i].Total, MasterTransaction.ClinicID, _NextActionCode, _NextActionDescription, gloDateMaster.gloDate.DateAsNumber(mskClaimDate.Text));
                                                                ogloBilling.UpdateNextParty(MasterTransaction.ClaimNo, MasterTransaction.SubClaimNo, MasterTransaction.TransactionMasterID, MasterTransaction.Lines[i].TransactionMasterDetailID, TransactionID, MasterTransaction.Lines[i].TransactionDetailID, MasterTransaction.PatientID, PayerMode.Self.ToString(), _TempParty, PayerMode.Self, 0, MasterTransaction.Lines[i].Total, MasterTransaction.ClinicID, _NextActionCode, _NextActionDescription, gloDateMaster.gloDate.DateAsNumber(mskClaimDate.Text));
                                                            }
                                                            else if (MasterTransaction.Lines[i].InsuranceSelfMode == PayerMode.BadDebt)
                                                            {
                                                                // ogloBilling.UpdateNextParty(MasterTransaction.ClaimNo, MasterTransaction.SubClaimNo, MasterTransaction.TransactionMasterID, MasterTransaction.Lines[i].TransactionMasterDetailID, MasterTransaction.TransactionID, MasterTransaction.Lines[i].TransactionDetailID, MasterTransaction.PatientID, oPatientControl.PatientName, _TempParty, PayerMode.Self, 0, MasterTransaction.Lines[i].Total, MasterTransaction.ClinicID, _NextActionCode, _NextActionDescription, gloDateMaster.gloDate.DateAsNumber(mskClaimDate.Text));
                                                                string collectionAgency = "";
                                                                collectionAgency = ogloBilling.GetCollectionAgencyname(_ContactID);
                                                                ogloBilling.UpdateNextParty(MasterTransaction.ClaimNo, MasterTransaction.SubClaimNo, MasterTransaction.TransactionMasterID, MasterTransaction.Lines[i].TransactionMasterDetailID, TransactionID, MasterTransaction.Lines[i].TransactionDetailID, MasterTransaction.Lines[i].InsuranceID, collectionAgency, _TempParty, PayerMode.BadDebt, _ContactID, MasterTransaction.Lines[i].Charges, MasterTransaction.Lines[i].ClinicID, _NextActionCode, _NextActionDescription, gloDateMaster.gloDate.DateAsNumber(mskClaimDate.Text));
                                                            }
                                                            else
                                                            {
                                                                //ogloBilling.UpdateNextParty(MasterTransaction.ClaimNo, MasterTransaction.SubClaimNo, MasterTransaction.TransactionMasterID, MasterTransaction.Lines[i].TransactionMasterDetailID, MasterTransaction.TransactionMasterID, MasterTransaction.Lines[i].TransactionMasterDetailID, MasterTransaction.Lines[i].InsuranceID, MasterTransaction.Lines[i].InsuranceName, _TempParty, PayerMode.Insurance, _ContactID, MasterTransaction.Lines[i].Charges, MasterTransaction.Lines[i].ClinicID, _NextActionCode, _NextActionDescription, gloDateMaster.gloDate.DateAsNumber(mskClaimDate.Text));
                                                                //ogloBilling.UpdateNextParty(MasterTransaction.ClaimNo, MasterTransaction.SubClaimNo, MasterTransaction.TransactionMasterID, MasterTransaction.Lines[i].TransactionMasterDetailID, TransactionID, MasterTransaction.Lines[i].TransactionDetailID, MasterTransaction.Lines[i].InsuranceID, MasterTransaction.Lines[i].InsuranceName.ToUpper(), _TempParty, PayerMode.Insurance, _ContactID, MasterTransaction.Lines[i].Charges, MasterTransaction.Lines[i].ClinicID, _NextActionCode, _NextActionDescription, gloDateMaster.gloDate.DateAsNumber(mskClaimDate.Text));

                                                                //Removed ToUpper from Insurance Name
                                                                ogloBilling.UpdateNextParty(MasterTransaction.ClaimNo, MasterTransaction.SubClaimNo, MasterTransaction.TransactionMasterID, MasterTransaction.Lines[i].TransactionMasterDetailID, TransactionID, MasterTransaction.Lines[i].TransactionDetailID, MasterTransaction.Lines[i].InsuranceID, MasterTransaction.Lines[i].InsuranceName, _TempParty, PayerMode.Insurance, _ContactID, MasterTransaction.Lines[i].Charges, MasterTransaction.Lines[i].ClinicID, _NextActionCode, _NextActionDescription, gloDateMaster.gloDate.DateAsNumber(mskClaimDate.Text));
                                                                //**
                                                            }
                                                        }
                                                    }
                                                }
                                            }
                                        }

                                        #endregion "Add Next Party Action"


                                        //update the transaction Lines only if a Add Line Feature is available
                                        //if ((MasterTransaction.ResponsibilityNo <= 1) && (MasterTransaction.Transaction_Status == TransactionStatus.Queue || MasterTransaction.Transaction_Status == TransactionStatus.Batch) && _NextAction == "T")
                                        if (_NextAction == "T")
                                        //if (_NextAction != "" && _NextAction !=null)
                                        {
                                            for (int i = 0; i < MasterTransaction.Lines.Count; i++)
                                            {
                                                MasterTransaction.Lines[i].TransactionId = MasterTransaction.Lines[i].TransactionMasterID;
                                                MasterTransaction.Lines[i].TransactionDetailID = MasterTransaction.Lines[i].TransactionMasterDetailID;
                                                //MasterTransaction.Lines[i].LineNotes = null;

                                            }

                                            gloDatabaseLayer.DBLayer oDB = new gloDatabaseLayer.DBLayer(_DatabaseConnectionString);
                                            String _sqlQuery = "";
                                            try
                                            {
                                                oDB.Connect(false);
                                                _sqlQuery = " delete from BL_Transaction_Lines_Notes where  nTransactionID=" + MasterTransaction.TransactionMasterID + " and nTransactionDetailID=0 AND nNoteType <> 12 ";
                                                oDB.Execute_Query(_sqlQuery);

                                            }
                                            catch (Exception ex)
                                            {
                                                gloAuditTrail.gloAuditTrail.ExceptionLog(ex, false);
                                            }
                                            finally
                                            {
                                                if (oDB != null)
                                                {
                                                    oDB.Disconnect();
                                                    oDB.Dispose();
                                                }
                                            }

                                            //To insert the Details in the TransactionMaster
                                            _returnID = ogloBilling.AddChargesModifySave(MasterTransaction, _ClinicID);

                                            //////..Sagar Ghodke - 20110729
                                            //////..The tracking transaction ids are set as master transaction ids prior to AddChargeModifySave method
                                            //////..is done as existing id where generated same for master as well as tracking tables
                                            //////..and the add charges method will not have changes
                                            //////..next loop will reverse the above operation of id assignment

                                            ////for (int i = 0; i < MasterTransaction.Lines.Count; i++)
                                            ////{
                                            ////    if (_InitialTransaction != null && _InitialTransaction.Lines != null && _InitialTransaction.Lines.Count > 0
                                            ////        && _InitialTransaction.Lines.Count == MasterTransaction.Lines.Count)
                                            ////    {
                                            ////        MasterTransaction.Lines[i].TransactionId = _InitialTransaction.Lines[i].TransactionId;
                                            ////        MasterTransaction.Lines[i].TransactionDetailID = _InitialTransaction.Lines[i].TransactionDetailID;
                                            ////    }
                                            ////}

                                            //////..End Sagar Ghodke - 20110728


                                            //Added by Subashish_b on 22/Feb /2011 (integration made on date-10/May/2011) for  update patient change informaton in db.

                                            //if (_IsPatientAccountFeature)
                                            //{
                                            //    if (_isPatientChanged && _isAccountChanged)
                                            //    {
                                            //        UpdateOldPatientPayement_To_NewPatient(MasterTransaction.TransactionMasterID, nInitialStripPatientID, oPatientControl.CmbSelectedPatientID);
                                            //    }
                                            //    if (_isPatientChanged)
                                            //    {
                                            //        UpdateOldPatientPayement_To_NewPatient(MasterTransaction.TransactionMasterID, nInitialStripPatientID, oPatientControl.CmbSelectedPatientID);
                                            //    }
                                            //    if (_isAccountChanged)
                                            //    {
                                            //        UpdateOldPatientPayement_To_NewPatient(MasterTransaction.TransactionMasterID, nInitialStripPatientID, oPatientControl.CmbSelectedPatientID);
                                            //    }

                                            //}


                                            ogloBilling.UpdateNewLine(_MasterTransactionID, _TransactionID);




                                            _TransactionID = _returnID;

                                            #region " Delete the Previous TransactionLines if any Lines are Removed While Modifying"

                                            gloDatabaseLayer.DBLayer oDBLines = null;
                                            //  String _sqlQueryLines = "";
                                            sb_ExcludeTransDtlID = new StringBuilder();
                                            try
                                            {
                                                //oDBLines.Connect(false);

                                                for (int i = 0; i < MasterTransaction.Lines.Count; i++)
                                                {
                                                    if (i == MasterTransaction.Lines.Count - 1)
                                                    {
                                                        sb_ExcludeTransDtlID.Append(MasterTransaction.Lines[i].TransactionDetailID.ToString());
                                                    }
                                                    else
                                                    {
                                                        sb_ExcludeTransDtlID.Append(MasterTransaction.Lines[i].TransactionDetailID.ToString() + ",");
                                                    }


                                                }
                                                //_sqlQueryLines = " delete from BL_Transaction_Claim_Lines where  nTransactionID=" + MasterTransaction.TransactionMasterID + " and nTransactionDetailID NOT IN ( " + sb_ExcludeTransDtlID + ")";



                                                //_sqlQueryLines = " delete from BL_Transaction_Claim_Lines WITH(READPAST) where  nTransactionMasterID=" + MasterTransaction.TransactionMasterID + " and nTransactionMasterDetailID NOT IN ( " + sb_ExcludeTransDtlID + ")";

                                                //_sqlQueryLines = @"  IF NOT EXISTS "+
                                                //                 "  (             "+
                                                //                 "         SELECT 1 FROM BL_Transaction_Claim_MST WITH (NOLOCK) "+
                                                //                 "         WHERE nTransactionMasterID = " + MasterTransaction.TransactionMasterID + " AND ISNULL(nSubClaimNo,'') > 0 "+
                                                //                 "  ) "+
                                                //                 "     BEGIN "+
                                                //                 "      DELETE from BL_Transaction_Claim_Lines WITH(READPAST) WHERE  "+
                                                //                 "      nTransactionMasterID=" + MasterTransaction.TransactionMasterID + " and nTransactionMasterDetailID NOT IN ( " + sb_ExcludeTransDtlID + ") "+
                                                //                 "                                                                    "+          
                                                //                 "      DELETE FROM BL_Transaction_Anesthesia WITH(READPAST) WHERE  "+
                                                //                 "      nTransactionMasterID=" + MasterTransaction.TransactionMasterID + " and nTransactionMasterDetailID NOT IN ( " + sb_ExcludeTransDtlID + ") "+
                                                //                 "     END ";

                                                if (Convert.ToString(sb_ExcludeTransDtlID).Trim() != "")
                                                {
                                                    oDBLines = new gloDatabaseLayer.DBLayer(_DatabaseConnectionString);

                                                    gloDatabaseLayer.DBParameters oDBParameters = new gloDatabaseLayer.DBParameters();

                                                    oDBParameters.Add("@TransactionMasterID", MasterTransaction.TransactionMasterID, ParameterDirection.Input, SqlDbType.BigInt);
                                                    oDBParameters.Add("@TransactionID", 0, ParameterDirection.Input, SqlDbType.VarChar);
                                                    oDBParameters.Add("@nUserId", gloGlobal.gloPMGlobal.UserID, ParameterDirection.Input, SqlDbType.BigInt);
                                                    oDBParameters.Add("@sMachineName", Environment.MachineName, ParameterDirection.Input, SqlDbType.VarChar);
                                                    oDBParameters.Add("@sTransactionDetailID", Convert.ToString(sb_ExcludeTransDtlID), ParameterDirection.Input, SqlDbType.VarChar);

                                                    oDBLines.Connect(false);
                                                    oDBLines.Execute("BL_Delete_Transaction_Claim_Lines", oDBParameters);
                                                    oDBLines.Disconnect();

                                                    if (oDBParameters != null) { oDBParameters.Clear(); oDBParameters.Dispose(); }
                                                }


                                                //oDBLines.Execute_Query(_sqlQueryLines);


                                                //_sqlQueryLines = " delete from BL_Transaction_Anesthesia WITH(READPAST) where  nTransactionMasterID=" + MasterTransaction.TransactionMasterID + " and nTransactionMasterDetailID NOT IN ( " + sb_ExcludeTransDtlID + ")";
                                                //oDBLines.Execute_Query(_sqlQueryLines);



                                            }
                                            catch (Exception ex)
                                            {
                                                gloAuditTrail.gloAuditTrail.ExceptionLog(ex, false);
                                            }
                                            finally
                                            {

                                                if (oDBLines != null)
                                                {
                                                    oDBLines.Dispose();
                                                }
                                            }

                                            #endregion

                                            # region Commented Box19 Notes"

                                            ////Insert Box19 Notes in transaction line notes Added by Abhisekh 0n 18 aug 2010
                                            //gloDatabaseLayer.DBLayer oDBBox19Notes = new gloDatabaseLayer.DBLayer(_DatabaseConnectionString);
                                            //gloDatabaseLayer.DBParameters oDBParametersBox19 = new gloDatabaseLayer.DBParameters();
                                            //oDBBox19Notes.Connect(false);
                                            //if (_oBox19Notes != null)
                                            //{
                                            //    for (int j = 0; j < _oBox19Notes.Count; j++)
                                            //    {

                                            //        oDBParametersBox19.Clear();
                                            //        //@nTransactionID numeric(18,0),@nLineNo numeric (18,0), @nNoteType int, @nNoteId numeric (18,0), 
                                            //        //@nNoteDateTime numeric (18,0), @nUserID numeric (18,0), @nNoteDescription varchar(255),@nClinicID numeric(18,0)

                                            //        oDBParametersBox19.Add("@nTransactionID", TransactionID, ParameterDirection.Input, SqlDbType.BigInt);
                                            //        oDBParametersBox19.Add("@nLineNo", 0, ParameterDirection.Input, SqlDbType.BigInt);
                                            //        oDBParametersBox19.Add("@nTransactionDetailID", 0, ParameterDirection.Input, SqlDbType.BigInt);
                                            //        oDBParametersBox19.Add("@nNoteType", _oBox19Notes[j].NoteType, ParameterDirection.Input, SqlDbType.Int);
                                            //        oDBParametersBox19.Add("@nNoteId", 0, ParameterDirection.InputOutput, SqlDbType.BigInt);
                                            //        oDBParametersBox19.Add("@nNoteDateTime", _oBox19Notes[j].NoteDate, ParameterDirection.Input, SqlDbType.BigInt);
                                            //        oDBParametersBox19.Add("@nUserID", _oBox19Notes[j].UserID, ParameterDirection.Input, SqlDbType.BigInt);
                                            //        oDBParametersBox19.Add("@sNoteDescription", _oBox19Notes[j].Box19NoteDescription, ParameterDirection.Input, SqlDbType.VarChar);
                                            //        oDBParametersBox19.Add("@nClinicID", _oBox19Notes[j].ClinicID, ParameterDirection.Input, SqlDbType.BigInt);
                                            //        oDBParametersBox19.Add("@MachineID", oDBBox19Notes.GetPrefixTransactionID(0), ParameterDirection.Input, SqlDbType.BigInt);
                                            //        oDBParametersBox19.Add("@nBillingNoteType", _oBox19Notes[j].BillingNoteType, ParameterDirection.Input, SqlDbType.Int);
                                            //        oDBParametersBox19.Add("@nCloseDate", null, ParameterDirection.Input, SqlDbType.Int);

                                            //        oDBBox19Notes.Execute("BL_INUP_Transaction_Lines_Notes", oDBParametersBox19);
                                            //        MasterTransaction.IsReplacementClaim = _oBox19Notes[j].IsReplacementClaim;

                                            //        oDBParametersBox19.Clear();
                                            //        if (MasterTransaction.ResponsibilityType == PayerMode.Insurance)
                                            //        {
                                            //            oDBParametersBox19.Add("@nTransactionID", MasterTransaction.TransactionMasterID, ParameterDirection.Input, SqlDbType.Decimal);// numeric(18,2),
                                            //            oDBParametersBox19.Add("@nContactID", MasterTransaction.ContactID, ParameterDirection.Input, SqlDbType.Decimal);// numeric(18,2),
                                            //            oDBParametersBox19.Add("@nInsuranceID", MasterTransaction.InsuranceID, ParameterDirection.Input, SqlDbType.Decimal);// numeric(18,2),
                                            //            oDBParametersBox19.Add("@nResponsibilityNo", MasterTransaction.ResponsibilityNo, ParameterDirection.Input, SqlDbType.Decimal);// numeric(18,2),
                                            //            oDBParametersBox19.Add("@sClaimRemittanceRefNo", _oBox19Notes[0].sClaimRemittRefNo, ParameterDirection.Input, SqlDbType.VarChar, 50);// numeric(18,2),
                                            //            oDBParametersBox19.Add("@nClinicID", _oBox19Notes[0].ClinicID, ParameterDirection.Input, SqlDbType.BigInt);//  numeric(18,0),

                                            //            //int _retVal = oDB.Execute("BL_UP_ClaimRemittanceRefNo", oParameters);

                                            //            int _retVal = 0;
                                            //            _retVal = oDBBox19Notes.Execute("BL_INUP_ClaimRemittanceRefNo", oDBParametersBox19);
                                            //        }
                                            //    }//End Lines Notes 
                                            //}

                                            # endregion

                                            # region "Box19 Notes"

                                            //Insert Box19 Notes in transaction line notes Added by Abhisekh 0n 18 aug 2010
                                            gloDatabaseLayer.DBLayer oDBBox19Notes = new gloDatabaseLayer.DBLayer(_DatabaseConnectionString);
                                            gloDatabaseLayer.DBParameters oDBParametersBox19 = new gloDatabaseLayer.DBParameters();
                                            oDBBox19Notes.Connect(false);
                                            if (_oBox19Notes != null)
                                            {
                                                if (_oBox19Notes.Count > 0)
                                                {

                                                    for (int j = 0; j < _oBox19Notes.Count; j++)
                                                    {
                                                        //if (_oBox19Notes[j].Box19NoteDescription.Trim() != null && _oBox19Notes[j].Box19NoteDescription.Trim() != string.Empty)
                                                        //{
                                                        oDBParametersBox19.Clear();
                                                        //@nTransactionID numeric(18,0),@nLineNo numeric (18,0), @nNoteType int, @nNoteId numeric (18,0), 
                                                        //@nNoteDateTime numeric (18,0), @nUserID numeric (18,0), @nNoteDescription varchar(255),@nClinicID numeric(18,0)

                                                        oDBParametersBox19.Add("@nTransactionID", MasterTransaction.TransactionMasterID, ParameterDirection.Input, SqlDbType.BigInt);
                                                        oDBParametersBox19.Add("@nLineNo", 0, ParameterDirection.Input, SqlDbType.BigInt);
                                                        oDBParametersBox19.Add("@nTransactionDetailID", 0, ParameterDirection.Input, SqlDbType.BigInt);
                                                        oDBParametersBox19.Add("@nNoteType", _oBox19Notes[j].NoteType, ParameterDirection.Input, SqlDbType.Int);
                                                        oDBParametersBox19.Add("@nNoteId", 0, ParameterDirection.InputOutput, SqlDbType.BigInt);
                                                        oDBParametersBox19.Add("@nNoteDateTime", _oBox19Notes[j].NoteDate, ParameterDirection.Input, SqlDbType.BigInt);
                                                        oDBParametersBox19.Add("@nUserID", _oBox19Notes[j].UserID, ParameterDirection.Input, SqlDbType.BigInt);
                                                        oDBParametersBox19.Add("@sNoteDescription", _oBox19Notes[j].Box19NoteDescription, ParameterDirection.Input, SqlDbType.VarChar);
                                                        oDBParametersBox19.Add("@nClinicID", _oBox19Notes[j].ClinicID, ParameterDirection.Input, SqlDbType.BigInt);
                                                        oDBParametersBox19.Add("@MachineID", oDBBox19Notes.GetPrefixTransactionID(0), ParameterDirection.Input, SqlDbType.BigInt);
                                                        oDBParametersBox19.Add("@nBillingNoteType", _oBox19Notes[j].BillingNoteType, ParameterDirection.Input, SqlDbType.Int);
                                                        oDBParametersBox19.Add("@nCloseDate", null, ParameterDirection.Input, SqlDbType.Int);
                                                        oDBParametersBox19.Add("@nStatementNoteDate", DBNull.Value, ParameterDirection.Input, SqlDbType.Int);
                                                        oDBParametersBox19.Add("@dtCreatedDateTime", DateTime.Now, ParameterDirection.Input, SqlDbType.DateTime);
                                                        oDBBox19Notes.Execute("BL_INUP_Transaction_Lines_Notes", oDBParametersBox19);
                                                        //MasterTransaction.IsReplacementClaim = _oBox19Notes[j].IsReplacementClaim;
                                                        //}

                                                        oDBBox19Notes.Disconnect();
                                                    }
                                                }
                                                //End Lines Notes
                                                if (_oBox19Notes != null)
                                                    _oBox19Notes.Clear();
                                                if (_oBox19Note != null)
                                                    _oBox19Note = null;

                                            }
                                            oDBBox19Notes.Dispose();
                                            # endregion

                                            # region "Claim 10d Notes"

                                            //Insert "Claim 10d Notes" in transaction line notes Added
                                            gloDatabaseLayer.DBLayer oDBClaim10dNotes = new gloDatabaseLayer.DBLayer(_DatabaseConnectionString);
                                            gloDatabaseLayer.DBParameters oDBParametersClaim10dNotes = new gloDatabaseLayer.DBParameters();
                                            oDBClaim10dNotes.Connect(false);
                                            if (_sBox10dNote != null)
                                            {
                                                if (_sBox10dNote.Trim() != string.Empty)
                                                {
                                                    oDBParametersClaim10dNotes.Clear();
                                                    oDBParametersClaim10dNotes.Add("@nTransactionID", MasterTransaction.TransactionMasterID, ParameterDirection.Input, SqlDbType.BigInt);
                                                    oDBParametersClaim10dNotes.Add("@nLineNo", 0, ParameterDirection.Input, SqlDbType.BigInt);
                                                    oDBParametersClaim10dNotes.Add("@nTransactionDetailID", 0, ParameterDirection.Input, SqlDbType.BigInt);
                                                    oDBParametersClaim10dNotes.Add("@nNoteType", NoteType.Claim_Box10dNote, ParameterDirection.Input, SqlDbType.Int);
                                                    oDBParametersClaim10dNotes.Add("@nNoteId", 0, ParameterDirection.InputOutput, SqlDbType.BigInt);
                                                    oDBParametersClaim10dNotes.Add("@nNoteDateTime", gloDateMaster.gloDate.DateAsNumber(DateTime.Now.Date.ToShortDateString()), ParameterDirection.Input, SqlDbType.BigInt);
                                                    oDBParametersClaim10dNotes.Add("@nUserID", gloGlobal.gloPMGlobal.UserID, ParameterDirection.Input, SqlDbType.BigInt);
                                                    oDBParametersClaim10dNotes.Add("@sNoteDescription", _sBox10dNote, ParameterDirection.Input, SqlDbType.VarChar);
                                                    oDBParametersClaim10dNotes.Add("@nClinicID", gloGlobal.gloPMGlobal.ClinicID, ParameterDirection.Input, SqlDbType.BigInt);
                                                    oDBParametersClaim10dNotes.Add("@MachineID", oDBClaim10dNotes.GetPrefixTransactionID(0), ParameterDirection.Input, SqlDbType.BigInt);
                                                    oDBParametersClaim10dNotes.Add("@nBillingNoteType", Convert.ToInt32(EOBPaymentSubType.Claim_Box10dNote), ParameterDirection.Input, SqlDbType.Int);
                                                    oDBParametersClaim10dNotes.Add("@nCloseDate", null, ParameterDirection.Input, SqlDbType.Int);
                                                    oDBParametersClaim10dNotes.Add("@nStatementNoteDate", DBNull.Value, ParameterDirection.Input, SqlDbType.Int);
                                                    oDBParametersClaim10dNotes.Add("@dtCreatedDateTime", DateTime.Now, ParameterDirection.Input, SqlDbType.DateTime);
                                                    oDBClaim10dNotes.Execute("BL_INUP_Transaction_Lines_Notes", oDBParametersClaim10dNotes);
                                                    oDBClaim10dNotes.Disconnect();
                                                }

                                            }
                                            #endregion "Claim 10d Notes"

                                            String strClaimRemitRefNo = "";
                                            strClaimRemitRefNo = gloCharges.CheckRefNumber(MasterTransaction.TransactionMasterID, MasterTransaction.ContactID, MasterTransaction.InsuranceID, MasterTransaction.ClinicID);

                                            # region Claim Remittance Ref. No.

                                            gloDatabaseLayer.DBLayer oDBClaimRef = new gloDatabaseLayer.DBLayer(_DatabaseConnectionString);
                                            gloDatabaseLayer.DBParameters oDBClaimRefParameters = new gloDatabaseLayer.DBParameters();
                                            oDBClaimRef.Connect(false);

                                            if (_sClaimRefNo.Trim() != string.Empty)
                                            {
                                                if (MasterTransaction.ResponsibilityType == PayerMode.Insurance)
                                                {
                                                    oDBClaimRefParameters.Add("@nTransactionID", MasterTransaction.TransactionMasterID, ParameterDirection.Input, SqlDbType.Decimal);// numeric(18,2), MasterTransaction.TransactionMasterID
                                                    oDBClaimRefParameters.Add("@nContactID", MasterTransaction.ContactID, ParameterDirection.Input, SqlDbType.Decimal);// numeric(18,2),
                                                    oDBClaimRefParameters.Add("@nInsuranceID", MasterTransaction.InsuranceID, ParameterDirection.Input, SqlDbType.Decimal);// numeric(18,2),
                                                    oDBClaimRefParameters.Add("@nResponsibilityNo", MasterTransaction.ResponsibilityNo, ParameterDirection.Input, SqlDbType.Decimal);// numeric(18,2),
                                                    oDBClaimRefParameters.Add("@sClaimRemittanceRefNo", _sClaimRefNo, ParameterDirection.Input, SqlDbType.VarChar, 50);// numeric(18,2),
                                                    oDBClaimRefParameters.Add("@nClinicID", MasterTransaction.ClinicID, ParameterDirection.Input, SqlDbType.BigInt);//  numeric(18,0),

                                                    //int _retVal = oDB.Execute("BL_UP_ClaimRemittanceRefNo", oParameters);

                                                    int _retVal = 0;
                                                    _retVal = oDBClaimRef.Execute("BL_INUP_ClaimRemittanceRefNo", oDBClaimRefParameters);
                                                }
                                            }
                                            else
                                            {
                                                if (strClaimRemitRefNo != "")
                                                {
                                                    if (MasterTransaction.ResponsibilityType == PayerMode.Insurance)
                                                    {
                                                        oDBClaimRefParameters.Add("@nTransactionID", MasterTransaction.TransactionMasterID, ParameterDirection.Input, SqlDbType.Decimal);// numeric(18,2), MasterTransaction.TransactionMasterID
                                                        oDBClaimRefParameters.Add("@nContactID", MasterTransaction.ContactID, ParameterDirection.Input, SqlDbType.Decimal);// numeric(18,2),
                                                        oDBClaimRefParameters.Add("@nInsuranceID", MasterTransaction.InsuranceID, ParameterDirection.Input, SqlDbType.Decimal);// numeric(18,2),
                                                        oDBClaimRefParameters.Add("@nResponsibilityNo", MasterTransaction.ResponsibilityNo, ParameterDirection.Input, SqlDbType.Decimal);// numeric(18,2),
                                                        oDBClaimRefParameters.Add("@sClaimRemittanceRefNo", _sClaimRefNo, ParameterDirection.Input, SqlDbType.VarChar, 50);// numeric(18,2),
                                                        oDBClaimRefParameters.Add("@nClinicID", MasterTransaction.ClinicID, ParameterDirection.Input, SqlDbType.BigInt);//  numeric(18,0),

                                                        //int _retVal = oDB.Execute("BL_UP_ClaimRemittanceRefNo", oParameters);

                                                        int _retVal = 0;
                                                        _retVal = oDBClaimRef.Execute("BL_INUP_ClaimRemittanceRefNo", oDBClaimRefParameters);
                                                    }
                                                }
                                            }
                                            oDBClaimRef.Disconnect();
                                            oDBClaimRef.Dispose();
                                            # endregion


                                        }
                                        else
                                        {
                                            gloDatabaseLayer.DBLayer oDB = new gloDatabaseLayer.DBLayer(_DatabaseConnectionString);
                                            gloDatabaseLayer.DBParameters oDBParameters = new gloDatabaseLayer.DBParameters();
                                            try
                                            {
                                                #region " Insurance Plan "
                                                if (_InitialTransaction.IsClaimSplitted)
                                                {
                                                    oDB.Connect(false);
                                                    //Delete the existing Transaction Insurance Plans if save modify
                                                    oDB.Execute_Query("DELETE FROM BL_Transaction_InsPlan WHERE nTransactionID = " + _MasterTransactionID);

                                                    //Add Transaction Insurance Plans 
                                                    if (MasterTransaction.InsurancePlans != null)
                                                    {
                                                        for (int i = 0; i < MasterTransaction.InsurancePlans.Count; i++)
                                                        {
                                                            oDBParameters.Clear();
                                                            oDBParameters.Add("@nTransactionID", _MasterTransactionID, ParameterDirection.Input, SqlDbType.BigInt);
                                                            oDBParameters.Add("@nPatientID", MasterTransaction.PatientID, ParameterDirection.Input, SqlDbType.BigInt);
                                                            oDBParameters.Add("@nClaimNo", MasterTransaction.ClaimNo, ParameterDirection.Input, SqlDbType.BigInt);
                                                            oDBParameters.Add("@nInsuranceID", MasterTransaction.InsurancePlans[i].InsuranceID, ParameterDirection.Input, SqlDbType.BigInt);
                                                            oDBParameters.Add("@nContactID", MasterTransaction.InsurancePlans[i].ContactID, ParameterDirection.Input, SqlDbType.BigInt);
                                                            oDBParameters.Add("@nResponsibilityNo", MasterTransaction.InsurancePlans[i].ResponsibilityNo, ParameterDirection.Input, SqlDbType.Int);
                                                            oDBParameters.Add("@nResponsibilityType", MasterTransaction.InsurancePlans[i].ResponsibilityType, ParameterDirection.Input, SqlDbType.Int);
                                                            oDBParameters.Add("@nClinicID", MasterTransaction.InsurancePlans[i].ClinicID, ParameterDirection.Input, SqlDbType.BigInt);

                                                            oDB.Execute("BL_INUP_Transaction_InsPlan", oDBParameters);

                                                        }
                                                    }

                                                    oDB.Dispose();
                                                }
                                                #endregion

                                                SaveDxList(_MasterTransactionID, MasterTransaction.VisitID, MasterTransaction.ClaimNo, MasterTransaction.PatientID);

                                                # region Commented Box19 Notes"

                                                ////Insert Box19 Notes in transaction line notes Added by Abhisekh 0n 18 aug 2010
                                                //gloDatabaseLayer.DBLayer oDBBox19Notes = new gloDatabaseLayer.DBLayer(_DatabaseConnectionString);
                                                //gloDatabaseLayer.DBParameters oDBParametersBox19 = new gloDatabaseLayer.DBParameters();
                                                //oDBBox19Notes.Connect(false);
                                                //if (_oBox19Notes != null)
                                                //{
                                                //    for (int j = 0; j < _oBox19Notes.Count; j++)
                                                //    {

                                                //        oDBParametersBox19.Clear();
                                                //        //@nTransactionID numeric(18,0),@nLineNo numeric (18,0), @nNoteType int, @nNoteId numeric (18,0), 
                                                //        //@nNoteDateTime numeric (18,0), @nUserID numeric (18,0), @nNoteDescription varchar(255),@nClinicID numeric(18,0)

                                                //        oDBParametersBox19.Add("@nTransactionID", TransactionID, ParameterDirection.Input, SqlDbType.BigInt);
                                                //        oDBParametersBox19.Add("@nLineNo", 0, ParameterDirection.Input, SqlDbType.BigInt);
                                                //        oDBParametersBox19.Add("@nTransactionDetailID", 0, ParameterDirection.Input, SqlDbType.BigInt);
                                                //        oDBParametersBox19.Add("@nNoteType", _oBox19Notes[j].NoteType, ParameterDirection.Input, SqlDbType.Int);
                                                //        oDBParametersBox19.Add("@nNoteId", 0, ParameterDirection.InputOutput, SqlDbType.BigInt);
                                                //        oDBParametersBox19.Add("@nNoteDateTime", _oBox19Notes[j].NoteDate, ParameterDirection.Input, SqlDbType.BigInt);
                                                //        oDBParametersBox19.Add("@nUserID", _oBox19Notes[j].UserID, ParameterDirection.Input, SqlDbType.BigInt);
                                                //        oDBParametersBox19.Add("@sNoteDescription", _oBox19Notes[j].Box19NoteDescription, ParameterDirection.Input, SqlDbType.VarChar);
                                                //        oDBParametersBox19.Add("@nClinicID", _oBox19Notes[j].ClinicID, ParameterDirection.Input, SqlDbType.BigInt);
                                                //        oDBParametersBox19.Add("@MachineID", oDBBox19Notes.GetPrefixTransactionID(0), ParameterDirection.Input, SqlDbType.BigInt);
                                                //        oDBParametersBox19.Add("@nBillingNoteType", _oBox19Notes[j].BillingNoteType, ParameterDirection.Input, SqlDbType.Int);
                                                //        oDBParametersBox19.Add("@nCloseDate", null, ParameterDirection.Input, SqlDbType.Int);

                                                //        oDBBox19Notes.Execute("BL_INUP_Transaction_Lines_Notes", oDBParametersBox19);
                                                //        MasterTransaction.IsReplacementClaim = _oBox19Notes[j].IsReplacementClaim;

                                                //        oDBParametersBox19.Clear();
                                                //        if (MasterTransaction.ResponsibilityType == PayerMode.Insurance)
                                                //        {
                                                //            oDBParametersBox19.Add("@nTransactionID", TransactionID, ParameterDirection.Input, SqlDbType.Decimal);// numeric(18,2),
                                                //            oDBParametersBox19.Add("@nContactID", MasterTransaction.ContactID, ParameterDirection.Input, SqlDbType.Decimal);// numeric(18,2),
                                                //            oDBParametersBox19.Add("@nInsuranceID", MasterTransaction.InsuranceID, ParameterDirection.Input, SqlDbType.Decimal);// numeric(18,2),
                                                //            oDBParametersBox19.Add("@nResponsibilityNo", MasterTransaction.ResponsibilityNo, ParameterDirection.Input, SqlDbType.Decimal);// numeric(18,2),
                                                //            oDBParametersBox19.Add("@sClaimRemittanceRefNo", _oBox19Notes[0].sClaimRemittRefNo, ParameterDirection.Input, SqlDbType.VarChar, 50);// numeric(18,2),
                                                //            oDBParametersBox19.Add("@nClinicID", _oBox19Notes[0].ClinicID, ParameterDirection.Input, SqlDbType.BigInt);//  numeric(18,0),

                                                //            //int _retVal = oDB.Execute("BL_UP_ClaimRemittanceRefNo", oParameters);

                                                //            int _retVal = 0;
                                                //            _retVal = oDBBox19Notes.Execute("BL_INUP_ClaimRemittanceRefNo", oDBParametersBox19);
                                                //        }
                                                //    }//End Lines Notes 
                                                //}

                                                # endregion

                                                # region "Box19 Notes"

                                                //Insert Box19 Notes in transaction line notes Added by Abhisekh 0n 18 aug 2010
                                                gloDatabaseLayer.DBLayer oDBBox19Notes = new gloDatabaseLayer.DBLayer(_DatabaseConnectionString);
                                                gloDatabaseLayer.DBParameters oDBParametersBox19 = new gloDatabaseLayer.DBParameters();
                                                oDBBox19Notes.Connect(false);
                                                if (_oBox19Notes != null)
                                                {
                                                    if (_oBox19Notes.Count > 0)
                                                    {
                                                        string _sqlQuery = " delete from BL_Transaction_Lines_Notes where  nTransactionID=" + MasterTransaction.TransactionMasterID + " and nTransactionDetailID=0 AND nBillingNoteType = 20 AND nNoteType=11 ";
                                                        oDBBox19Notes.Execute_Query(_sqlQuery);


                                                        for (int j = 0; j < _oBox19Notes.Count; j++)
                                                        {
                                                            if (_oBox19Notes[j].Box19NoteDescription.Trim() != null && _oBox19Notes[j].Box19NoteDescription.Trim() != string.Empty)
                                                            {
                                                                oDBParametersBox19.Clear();
                                                                //@nTransactionID numeric(18,0),@nLineNo numeric (18,0), @nNoteType int, @nNoteId numeric (18,0), 
                                                                //@nNoteDateTime numeric (18,0), @nUserID numeric (18,0), @nNoteDescription varchar(255),@nClinicID numeric(18,0)

                                                                oDBParametersBox19.Add("@nTransactionID", MasterTransaction.TransactionMasterID, ParameterDirection.Input, SqlDbType.BigInt);
                                                                oDBParametersBox19.Add("@nLineNo", 0, ParameterDirection.Input, SqlDbType.BigInt);
                                                                oDBParametersBox19.Add("@nTransactionDetailID", 0, ParameterDirection.Input, SqlDbType.BigInt);
                                                                oDBParametersBox19.Add("@nNoteType", _oBox19Notes[j].NoteType, ParameterDirection.Input, SqlDbType.Int);
                                                                oDBParametersBox19.Add("@nNoteId", 0, ParameterDirection.InputOutput, SqlDbType.BigInt);
                                                                oDBParametersBox19.Add("@nNoteDateTime", _oBox19Notes[j].NoteDate, ParameterDirection.Input, SqlDbType.BigInt);
                                                                oDBParametersBox19.Add("@nUserID", _oBox19Notes[j].UserID, ParameterDirection.Input, SqlDbType.BigInt);
                                                                oDBParametersBox19.Add("@sNoteDescription", _oBox19Notes[j].Box19NoteDescription, ParameterDirection.Input, SqlDbType.VarChar);
                                                                oDBParametersBox19.Add("@nClinicID", _oBox19Notes[j].ClinicID, ParameterDirection.Input, SqlDbType.BigInt);
                                                                oDBParametersBox19.Add("@MachineID", oDBBox19Notes.GetPrefixTransactionID(0), ParameterDirection.Input, SqlDbType.BigInt);
                                                                oDBParametersBox19.Add("@nBillingNoteType", _oBox19Notes[j].BillingNoteType, ParameterDirection.Input, SqlDbType.Int);
                                                                oDBParametersBox19.Add("@nCloseDate", null, ParameterDirection.Input, SqlDbType.Int);
                                                                oDBParametersBox19.Add("@nStatementNoteDate", DBNull.Value, ParameterDirection.Input, SqlDbType.Int);
                                                                oDBParametersBox19.Add("@dtCreatedDateTime", DateTime.Now, ParameterDirection.Input, SqlDbType.DateTime);
                                                                oDBBox19Notes.Execute("BL_INUP_Transaction_Lines_Notes", oDBParametersBox19);
                                                                //MasterTransaction.IsReplacementClaim = _oBox19Notes[j].IsReplacementClaim;
                                                            }

                                                            oDBBox19Notes.Disconnect();
                                                            oDBBox19Notes.Dispose();
                                                        }
                                                    }
                                                    //End Lines Notes
                                                    if (_oBox19Notes != null)
                                                        _oBox19Notes.Clear();
                                                    if (_oBox19Note != null)
                                                        _oBox19Note = null;

                                                }
                                                oDBBox19Notes.Dispose();
                                                # endregion


                                                # region "Claim 10d Notes"

                                                //Insert "Claim 10d Notes" in transaction line notes Added
                                                gloDatabaseLayer.DBLayer oDBClaim10dNotes = new gloDatabaseLayer.DBLayer(_DatabaseConnectionString);
                                                gloDatabaseLayer.DBParameters oDBParametersClaim10dNotes = new gloDatabaseLayer.DBParameters();
                                                oDBClaim10dNotes.Connect(false);
                                                if (_sBox10dNote != null)
                                                {
                                                    if (_sBox10dNote.Trim() != string.Empty)
                                                    {
                                                        string _sqlQuery = " delete from BL_Transaction_Lines_Notes where  nTransactionID=" + MasterTransaction.TransactionMasterID + " and nTransactionDetailID=0 AND nNoteType = 13 ";
                                                        oDBClaim10dNotes.Execute_Query(_sqlQuery);


                                                        oDBParametersClaim10dNotes.Clear();
                                                        oDBParametersClaim10dNotes.Add("@nTransactionID", MasterTransaction.TransactionMasterID, ParameterDirection.Input, SqlDbType.BigInt);
                                                        oDBParametersClaim10dNotes.Add("@nLineNo", 0, ParameterDirection.Input, SqlDbType.BigInt);
                                                        oDBParametersClaim10dNotes.Add("@nTransactionDetailID", 0, ParameterDirection.Input, SqlDbType.BigInt);
                                                        oDBParametersClaim10dNotes.Add("@nNoteType", NoteType.Claim_Box10dNote, ParameterDirection.Input, SqlDbType.Int);
                                                        oDBParametersClaim10dNotes.Add("@nNoteId", 0, ParameterDirection.InputOutput, SqlDbType.BigInt);
                                                        oDBParametersClaim10dNotes.Add("@nNoteDateTime", gloDateMaster.gloDate.DateAsNumber(DateTime.Now.Date.ToShortDateString()), ParameterDirection.Input, SqlDbType.BigInt);
                                                        oDBParametersClaim10dNotes.Add("@nUserID", gloGlobal.gloPMGlobal.UserID, ParameterDirection.Input, SqlDbType.BigInt);
                                                        oDBParametersClaim10dNotes.Add("@sNoteDescription", _sBox10dNote, ParameterDirection.Input, SqlDbType.VarChar);
                                                        oDBParametersClaim10dNotes.Add("@nClinicID", gloGlobal.gloPMGlobal.ClinicID, ParameterDirection.Input, SqlDbType.BigInt);
                                                        oDBParametersClaim10dNotes.Add("@MachineID", oDBClaim10dNotes.GetPrefixTransactionID(0), ParameterDirection.Input, SqlDbType.BigInt);
                                                        oDBParametersClaim10dNotes.Add("@nBillingNoteType", Convert.ToInt32(EOBPaymentSubType.Claim_Box10dNote), ParameterDirection.Input, SqlDbType.Int);
                                                        oDBParametersClaim10dNotes.Add("@nCloseDate", null, ParameterDirection.Input, SqlDbType.Int);
                                                        oDBParametersClaim10dNotes.Add("@nStatementNoteDate", DBNull.Value, ParameterDirection.Input, SqlDbType.Int);
                                                        oDBParametersClaim10dNotes.Add("@dtCreatedDateTime", DateTime.Now, ParameterDirection.Input, SqlDbType.DateTime);
                                                        oDBClaim10dNotes.Execute("BL_INUP_Transaction_Lines_Notes", oDBParametersClaim10dNotes);
                                                        oDBClaim10dNotes.Disconnect();
                                                    }

                                                }
                                                #endregion "Claim 10d Notes"

                                                String strClaimRemitRefNo = "";
                                                strClaimRemitRefNo = gloCharges.CheckRefNumber(MasterTransaction.TransactionMasterID, MasterTransaction.ContactID, MasterTransaction.InsuranceID, MasterTransaction.ClinicID);

                                                # region Claim Remittance Ref. No.

                                                gloDatabaseLayer.DBLayer oDBClaimRef = new gloDatabaseLayer.DBLayer(_DatabaseConnectionString);
                                                gloDatabaseLayer.DBParameters oDBClaimRefParameters = new gloDatabaseLayer.DBParameters();
                                                oDBClaimRef.Connect(false);
                                                if (_sClaimRefNo.Trim() != string.Empty)
                                                {
                                                    if (MasterTransaction.ResponsibilityType == PayerMode.Insurance)
                                                    {
                                                        oDBClaimRefParameters.Add("@nTransactionID", MasterTransaction.TransactionMasterID, ParameterDirection.Input, SqlDbType.Decimal);// numeric(18,2), MasterTransaction.TransactionMasterID
                                                        oDBClaimRefParameters.Add("@nContactID", MasterTransaction.ContactID, ParameterDirection.Input, SqlDbType.Decimal);// numeric(18,2),
                                                        oDBClaimRefParameters.Add("@nInsuranceID", MasterTransaction.InsuranceID, ParameterDirection.Input, SqlDbType.Decimal);// numeric(18,2),
                                                        oDBClaimRefParameters.Add("@nResponsibilityNo", MasterTransaction.ResponsibilityNo, ParameterDirection.Input, SqlDbType.Decimal);// numeric(18,2),
                                                        oDBClaimRefParameters.Add("@sClaimRemittanceRefNo", _sClaimRefNo, ParameterDirection.Input, SqlDbType.VarChar, 50);// numeric(18,2),
                                                        oDBClaimRefParameters.Add("@nClinicID", MasterTransaction.ClinicID, ParameterDirection.Input, SqlDbType.BigInt);//  numeric(18,0),

                                                        //int _retVal = oDB.Execute("BL_UP_ClaimRemittanceRefNo", oParameters);

                                                        int _retVal = 0;
                                                        _retVal = oDBClaimRef.Execute("BL_INUP_ClaimRemittanceRefNo", oDBClaimRefParameters);
                                                    }
                                                }
                                                else
                                                {
                                                    if (strClaimRemitRefNo != "")
                                                    {
                                                        if (MasterTransaction.ResponsibilityType == PayerMode.Insurance)
                                                        {
                                                            oDBClaimRefParameters.Add("@nTransactionID", MasterTransaction.TransactionMasterID, ParameterDirection.Input, SqlDbType.Decimal);// numeric(18,2), MasterTransaction.TransactionMasterID
                                                            oDBClaimRefParameters.Add("@nContactID", MasterTransaction.ContactID, ParameterDirection.Input, SqlDbType.Decimal);// numeric(18,2),
                                                            oDBClaimRefParameters.Add("@nInsuranceID", MasterTransaction.InsuranceID, ParameterDirection.Input, SqlDbType.Decimal);// numeric(18,2),
                                                            oDBClaimRefParameters.Add("@nResponsibilityNo", MasterTransaction.ResponsibilityNo, ParameterDirection.Input, SqlDbType.Decimal);// numeric(18,2),
                                                            oDBClaimRefParameters.Add("@sClaimRemittanceRefNo", _sClaimRefNo, ParameterDirection.Input, SqlDbType.VarChar, 50);// numeric(18,2),
                                                            oDBClaimRefParameters.Add("@nClinicID", MasterTransaction.ClinicID, ParameterDirection.Input, SqlDbType.BigInt);//  numeric(18,0),

                                                            //int _retVal = oDB.Execute("BL_UP_ClaimRemittanceRefNo", oParameters);

                                                            int _retVal = 0;
                                                            _retVal = oDBClaimRef.Execute("BL_INUP_ClaimRemittanceRefNo", oDBClaimRefParameters);
                                                        }
                                                    }
                                                }
                                                oDBClaimRef.Disconnect();
                                                oDBClaimRef.Dispose();
                                                # endregion
                                                //Added by Subashish_b on 15/Feb /2011 (integration made on date-10/May/2011) for  saving current Transaction in the history table.

                                                MasterTransaction.Transaction_Status = 0;
                                                oDB.Dispose();

                                                #region "Update dtCreatedDateTime for Charge Note "

                                                //Notes
                                                //Transaction Lines-->Notes
                                                if (MasterTransaction.Lines != null)
                                                {
                                                    for (int i = 0; i < MasterTransaction.Lines.Count; i++)
                                                    {
                                                        if (MasterTransaction.Lines[i].LineNotes != null)
                                                        {
                                                            for (int j = 0; j < MasterTransaction.Lines[i].LineNotes.Count; j++)
                                                            {
                                                                if (MasterTransaction.Lines[i].LineNotes[j].TransactionLineId != 0)
                                                                {

                                                                    string _strQuery = "";
                                                                    _strQuery = "Update BL_Transaction_Lines_Notes SET dtCreatedDateTime =  '" + MasterTransaction.Lines[i].LineNotes[j].dtCreatedDatetime + "' WHERE nNoteId = " + MasterTransaction.Lines[i].LineNotes[j].NoteID;
                                                                    oDB.Connect(false);
                                                                    int result = oDB.Execute_Query(_strQuery);
                                                                    oDB.Dispose();
                                                                }
                                                            }//End Lines Notes 
                                                        }
                                                    }
                                                }
                                                #endregion


                                            }
                                            catch (Exception ex)
                                            {
                                                gloAuditTrail.gloAuditTrail.ExceptionLog(ex, false);
                                            }
                                            finally
                                            {
                                                oDB.Dispose();
                                                oDBParameters.Dispose();
                                            }
                                        }


                                        if (_IsOpenForModify == false)
                                        {
                                            gloSettings.GeneralSettings oSettings = new gloSettings.GeneralSettings(_DatabaseConnectionString);
                                            oSettings.AddSetting("CHARGES_LASTCLOSEDATE", mskClaimDate.Text.Trim(), _ClinicID, _UserID, gloSettings.SettingFlag.User);
                                            oSettings.AddSetting("CHARGES_LASTCLOSETRAYID", SelectedChargeTrayID.ToString(), _ClinicID, _UserID, gloSettings.SettingFlag.User);
                                            oSettings.Dispose();

                                            //ogloBilling.SaveUserWiseCloseDay(mskClaimDate.Text.Trim(), CloseDayType.Charge, _ClinicID);
                                        }

                                        _ClaimNumberForSaveAndCopay = MasterTransaction.ClaimNo;

                                    }
                                    else
                                    {
                                        MessageBox.Show("Enter the service line to save.", _messageBoxCaption, MessageBoxButtons.OK, MessageBoxIcon.Information);
                                    }

                                    if (_returnID > 0)
                                    {
                                        SaveDxList(_returnID, MasterTransaction.VisitID, MasterTransaction.ClaimNo, MasterTransaction.PatientID);
                                    }


                                    _returnID = MasterTransaction.TransactionID;


                                    #region "Send to Queue"
                                    if (_returnID > 0 && _IsOpenForModify == false)
                                    {
                                        if (_IsOpenForResend != true)
                                        {
                                            int _SelfCount = 0;
                                            for (int i = 0; i <= MasterTransaction.Lines.Count - 1; i++)
                                            {
                                                if (MasterTransaction.Lines[i].InsuranceSelfMode == PayerMode.Self)
                                                {
                                                    _SelfCount = _SelfCount + 1;
                                                }
                                            }

                                            Int64 _statusid = 0;
                                            Int64 _statusdate = 0;
                                            Int64 _statustime = 0;


                                            Int64 _BatchDate = gloDateMaster.gloDate.DateAsNumber(DateTime.Now.ToString());
                                            Int64 _Prefix = Convert.ToInt64(DateTime.Now.ToString("MMddyyyyhhmmss"));


                                            if (MasterTransaction.Lines.Count != _SelfCount)
                                            {
                                                //_ClaimNo = Convert.ToInt64(txtClaimNo.Text);
                                                _ClaimNo = Convert.ToInt64(sClaimNo);

                                                _statusdate = gloDateMaster.gloDate.DateAsNumber(DateTime.Now.ToShortDateString());
                                                _statustime = gloDateMaster.gloTime.TimeAsNumber(DateTime.Now.ToShortTimeString());

                                                _statusid = ogloBilling.UpdateTransactionStatus(_TransPatientID, 0, 0, "", 0, BatchType.Queue.GetHashCode(), 0, _returnID, _ClaimNo, 0, 0, TransactionStatus.Queue, _statusdate, _statustime, "", this.ClinicID, 0, gloPatient.TypeOfBilling.None);
                                                ogloBilling.UpdateCurrentStatus(_returnID, TransactionStatus.Queue, _statusid);
                                            }
                                        }
                                    }
                                    #endregion

                                    #region "Self Pay goes to accpeted - Vinayak - 20090722"
                                    //IF All service line are self paid then send to accepted
                                    //if its new then send to new batch and accepted
                                    //if modify then
                                    //if charges then send to new batch and accepted
                                    //if queue then send to new batch and accepted/
                                    //if batch then send to accpeted against existing batch

                                    if (_returnID > 0)
                                    {
                                        if (_IsOpenForResend != true)
                                        {
                                            int _SelfCount = 0;
                                            for (int i = 0; i <= MasterTransaction.Lines.Count - 1; i++)
                                            {
                                                if (MasterTransaction.Lines[i].InsuranceSelfMode == PayerMode.Self)
                                                {
                                                    _SelfCount = _SelfCount + 1;
                                                }
                                            }


                                            Int64 _statusid = 0;
                                            Int64 _statusdate = 0;
                                            Int64 _statustime = 0;

                                            Int64 _BatchDate = gloDateMaster.gloDate.DateAsNumber(DateTime.Now.ToString());
                                            Int64 _Prefix = Convert.ToInt64(DateTime.Now.ToString("MMddyyyyhhmmss"));


                                            if (MasterTransaction.Lines.Count == _SelfCount)
                                            {
                                                //_ClaimNo = Convert.ToInt64(txtClaimNo.Text);
                                                _ClaimNo = Convert.ToInt64(sClaimNo);

                                                #region "Send to Queue"
                                                _statusdate = gloDateMaster.gloDate.DateAsNumber(DateTime.Now.ToShortDateString());
                                                _statustime = gloDateMaster.gloTime.TimeAsNumber(DateTime.Now.ToShortTimeString());

                                                _statusid = ogloBilling.UpdateTransactionStatus(_TransPatientID, 0, 0, "", 0, BatchType.Queue.GetHashCode(), 0, _returnID, _ClaimNo, 0, 0, TransactionStatus.Queue, _statusdate, _statustime, "", this.ClinicID, 0, gloPatient.TypeOfBilling.None);
                                                ogloBilling.UpdateCurrentStatus(_returnID, TransactionStatus.Queue, _statusid);

                                                #endregion
                                                _ClaimNo = 0;
                                            }


                                        }
                                    }
                                    #endregion


                                    #region "Resend logic - send to reque with saving to history - Sagar - 20090729"
                                    if (_returnID > 0)
                                    {
                                        if (_IsOpenForResend == true)
                                        {
                                            Int64 _statusid = 0;
                                            Int64 _statusdate = 0;
                                            Int64 _statustime = 0;

                                            string _BatchName = "";
                                            Int64 _BatchId = 0;
                                            Int64 _BatchNo = 0;
                                            Int64 _BatchDate = gloDateMaster.gloDate.DateAsNumber(DateTime.Now.ToString());
                                            Int64 _Prefix = Convert.ToInt64(DateTime.Now.ToString("MMddyyyyhhmmss"));

                                            //For self no need of clearinghouse, but as per table structure we will send it blank
                                            // Int64 _ClearingHouseId = 0;
                                            // string _ClearingHouseCode = "";
                                            // string _ClearingHouseName = "";

                                            //_ClaimNo = Convert.ToInt64(txtClaimNo.Text);
                                            _ClaimNo = Convert.ToInt64(sClaimNo);
                                            #region "Send to Re-Queue"
                                            _statusdate = gloDateMaster.gloDate.DateAsNumber(DateTime.Now.ToShortDateString());
                                            _statustime = gloDateMaster.gloTime.TimeAsNumber(DateTime.Now.ToShortTimeString());

                                            _statusid = ogloBilling.UpdateTransactionStatus(_TransPatientID, 0, 0, "", 0, BatchType.Queue.GetHashCode(), 0, _returnID, _ClaimNo, 0, 0, TransactionStatus.ReQueue, _statusdate, _statustime, "", this.ClinicID, 0, gloPatient.TypeOfBilling.None);
                                            ogloBilling.UpdateCurrentStatus(_returnID, TransactionStatus.ReQueue, _statusid);

                                            #endregion


                                            #region "Send to Accepted"
                                            //In resend if user select all to self then again send to accepted

                                            int _SelfCount = 0;
                                            for (int i = 0; i <= MasterTransaction.Lines.Count - 1; i++)
                                            {
                                                if (MasterTransaction.Lines[i].InsuranceSelfMode == PayerMode.Self)
                                                {
                                                    _SelfCount = _SelfCount + 1;
                                                }
                                            }

                                            if (_SelfCount == MasterTransaction.Lines.Count)
                                            {
                                                _statusid = ogloBilling.UpdateTransactionStatus(_TransPatientID, 0, _BatchId, _BatchName, _BatchDate, BatchType.Batch.GetHashCode(), _BatchNo, _returnID, _ClaimNo, 0, 0, TransactionStatus.Accepted, _statusdate, _statustime, "", this.ClinicID, 0, gloPatient.TypeOfBilling.None);
                                                ogloBilling.UpdateCurrentStatus(_returnID, TransactionStatus.Accepted, _statusid);
                                            }
                                            #endregion

                                            _ClaimNo = 0;

                                        }
                                    }
                                    #endregion

                                    #region Patient Appointments Linking to Charges
                                    if (this.lstAppointmentIDs.Any())
                                    {
                                        DataTable dtAppointmentChargesLink = new DataTable();
                                        dtAppointmentChargesLink.Columns.Add("nTransactionMasterID");
                                        dtAppointmentChargesLink.Columns.Add("nAppointmentID");

                                        foreach (long nAppointmentID in this.lstAppointmentIDs)
                                        {
                                            DataRow row = dtAppointmentChargesLink.Rows.Add();

                                            row["nTransactionMasterID"] = _MasterTransactionID;
                                            row["nAppointmentID"] = nAppointmentID;

                                            row = null;
                                        }

                                        gloCharges.SaveAppointmentsChargesLink(_MasterTransactionID, dtAppointmentChargesLink);

                                        dtAppointmentChargesLink.Dispose();
                                        dtAppointmentChargesLink = null;

                                        this.SetPatientAppointmentsLinked();
                                    }
                                    else if (this.DeletePatientAppointments && !this.lstAppointmentIDs.Any())
                                    {
                                        gloCharges.DeleteLinking(_MasterTransactionID);
                                        this.DeletePatientAppointments = false;
                                    }
                                    #endregion

                                    if (_returnID > 0)
                                    {
                                        if (_IsOpenForModify == false)
                                        {
                                            gloAuditTrail.gloAuditTrail.CreateAuditLog(ActivityModule.Billing, ActivityCategory.SetupCharges, ActivityType.Add, "Charges added", MasterTransaction.PatientID, _returnID, MasterTransaction.ProviderID, ActivityOutCome.Success);
                                        }
                                        else
                                        {
                                            gloAuditTrail.gloAuditTrail.CreateAuditLog(ActivityModule.Billing, ActivityCategory.SetupCharges, ActivityType.Modify, "Charges Modified", MasterTransaction.PatientID, _returnID, MasterTransaction.ProviderID, ActivityOutCome.Success);
                                            //ogloBilling.UpdateRecordStatus(0,_TransactionID, 0, false);
                                            //ReleaseLockStatus();
                                            ogloBilling.Dispose();

                                            if (_IsSaveCopayStart == false) {  if( ! IsInsurancePaymentClicked) this.Close(); }
                                        }


                                        IsEMRTransactionSaved = true;
                                        _result = true;
                                    }
                                    else
                                    {
                                        if (_IsOpenForModify == false)
                                        {
                                            gloAuditTrail.gloAuditTrail.CreateAuditLog(ActivityModule.Billing, ActivityCategory.SetupCharges, ActivityType.Add, "Charges added", MasterTransaction.PatientID, _returnID, MasterTransaction.ProviderID, ActivityOutCome.Failure);
                                        }
                                        else
                                        {
                                            gloAuditTrail.gloAuditTrail.CreateAuditLog(ActivityModule.Billing, ActivityCategory.SetupCharges, ActivityType.Modify, "Charges Modified", MasterTransaction.PatientID, _returnID, MasterTransaction.ProviderID, ActivityOutCome.Failure);
                                        }
                                    }

                                    Int64 nNewTransID = 0;

                                    #region " Claim Split Code after Responsiblity Transfer "

                                    //Added By Debasish Das on 16th July 2010 (5060)
                                    if (_IsPartyChanged == true)
                                    {

                                        //Transaction oTransaction = new Transaction();
                                        _InitialTransaction.Hold = _oClaimHold;
                                        MasterTransaction.TransactionID = _InitialTransaction.TransactionID;
                                        MasterTransaction.TransactionMasterID = _InitialTransaction.TransactionMasterID;
                                        oSplitClaimDetails = new SplitClaimDetails();
                                        oSplitClaimDetails.GenerateNewClaimOnRespTransfer(this._DatabaseConnectionString, this._emrdatabaseConnectionString, MasterTransaction, _InitialTransaction, _TempParty, _InsTransferCloseDate, _NextActionCode, _NextActionDescription, _ContactID, out nNewTransID);

                                    }
                                    //** 

                                    #endregion

                                    #region " If Insurance Modified then Modify the insurance for the other claims also "


                                    //if (gloCharges.CheckForSplitClaim((nNewTransID != 0 ? nNewTransID : _InitialTransaction.TransactionID)))

                                    if (bPromptToAlterInsurance)
                                    {
                                        int iRow = 0;
                                        for (int iObjCount = 0; iObjCount <= _InitialTransaction.InsurancePlans.Count - 1; iObjCount++)
                                        {
                                            if (_InitialTransaction.InsurancePlans[iObjCount].ContactID != 0)
                                            {
                                                iRow = c1Insurance.FindRow(Convert.ToString(_InitialTransaction.InsurancePlans[iObjCount].ContactID), 1, COL_INSURANCECONTACTID, false);

                                                if (iRow == -1)
                                                {
                                                    iRow = c1Insurance.FindRow(Convert.ToInt64(_InitialTransaction.InsurancePlans[iObjCount].ContactID), 1, COL_INSURANCECONTACTID, false);
                                                }
                                            }
                                            else
                                            {
                                                iRow = c1Insurance.FindRow(Convert.ToString(_InitialTransaction.InsurancePlans[iObjCount].InsuranceID), 1, COL_INSURANCEID, false);
                                            }

                                            Int64 responsiblity = 0;
                                            Int64.TryParse(Convert.ToString(c1Insurance.GetData(iRow, COL_INSURANCERESPONSIBILITY)).Replace("\0", ""), out responsiblity);

                                            if ((_InitialTransaction.InsurancePlans[iObjCount].InsuranceID == Convert.ToInt64(c1Insurance.GetData(iRow, COL_INSURANCEID))
                                                && _InitialTransaction.InsurancePlans[iObjCount].ResponsibilityNo != responsiblity) || _IsPartyChanged)
                                            {
                                                if (MessageBox.Show("Claims insurance will be modified.  This claim is part of a split claim."
                                                   + Environment.NewLine
                                                   + "Modify the insurance for the other claims also?",
                                                   gloGlobal.gloPMGlobal.MessageBoxCaption, MessageBoxButtons.YesNo, MessageBoxIcon.Warning, MessageBoxDefaultButton.Button2) == System.Windows.Forms.DialogResult.Yes)
                                                {
                                                    if (_InitialTransaction.IsClaimSplitted)
                                                    {
                                                        bool bResult = gloCharges.UpdateSplitClaimIns((nNewTransID != 0 ? nNewTransID : _InitialTransaction.TransactionID), _IsMstPartyChanged);
                                                    }
                                                    else
                                                    {
                                                        bool bResult = gloCharges.UpdateSplitClaimIns((nNewTransID != 0 ? nNewTransID : _InitialTransaction.TransactionID), _IsPartyChanged);
                                                    }
                                                }

                                                break;
                                            }
                                        }
                                    }

                                    #endregion

                                }
                                else
                                {
                                    c1Dx.Focus();
                                    if (c1Dx.Rows.Count >= 2)
                                    {
                                        c1Dx.Select(1, COL_DX_SELECT);
                                    }
                                    _result = false;
                                }
                            }
                            else
                            {
                                MessageBox.Show("Please select diagnosis.", _messageBoxCaption, MessageBoxButtons.OK, MessageBoxIcon.Information);
                                c1Dx.Focus();
                                if (c1Dx.Rows.Count >= 2)
                                {
                                    c1Dx.Select(1, COL_DX_SELECT);
                                }
                                _result = false;
                            }

                            ///  resend and hold claim region moved here on 03-march-2014 Sameer for ressolved bug no 65901 in glosuite 8.0.1.0 

                            #region "RESEND & Hold CLAIM"

                            clsgloResend objResend = null;
                            try
                            {
                                if (_IsResnd)
                                {
                                    CL_FollowUpCode.ClearInsuranceClaimFollowUp(1, _InitialTransaction.TransactionID);
                                }

                                if (_IsResnd == true && _oClaimHold.IsHold == true)
                                {

                                    #region "Remove Claim From Batch according to Transaction Status"

                                    switch (_InitialTransaction.Transaction_Status)
                                    {
                                        case TransactionStatus.Batch:
                                            oClsBL_Hold.RemoveClaimsForHold(_InitialTransaction.TransactionID, _InitialTransaction.Transaction_Status);
                                            break;
                                        case TransactionStatus.SendToClaimManager:
                                            oclsgloResend.ResendClaim(_InitialTransaction.TransactionID, _InitialTransaction, _oClaimHold.IsHold, _sClaimRefNo);
                                            break;
                                        case TransactionStatus.SendToClearingHouse:
                                            oclsgloResend.ResendClaim(_InitialTransaction.TransactionID, _InitialTransaction, _oClaimHold.IsHold, _sClaimRefNo);
                                            break;
                                        default:

                                            break;

                                    }

                                    #endregion

                                }
                                else
                                {
                                    if (_oClaimHold.IsHold == true)
                                    {
                                        switch (_InitialTransaction.Transaction_Status)
                                        {
                                            case TransactionStatus.Batch:
                                                oClsBL_Hold.RemoveClaimsForHold(_InitialTransaction.TransactionID, _InitialTransaction.Transaction_Status);
                                                break;
                                            case TransactionStatus.SendToClaimManager:
                                                oClsBL_Hold.HoldUnholdClaim(_oClaimHold, _InitialTransaction.TransactionMasterID, _InitialTransaction.TransactionID);
                                                break;
                                            case TransactionStatus.SendToClearingHouse:
                                                oClsBL_Hold.HoldUnholdClaim(_oClaimHold, _InitialTransaction.TransactionMasterID, _InitialTransaction.TransactionID);
                                                break;
                                            default:
                                                break;

                                        }
                                    }
                                    else if (_IsResnd == true)
                                    {
                                        objResend = new clsgloResend();
                                        objResend.ResendClaim(_TransactionID, _InitialTransaction, _oClaimHold.IsHold, _sClaimRefNo);
                                    }

                                }
                            }
                            catch (Exception ex)
                            {
                                gloAuditTrail.gloAuditTrail.ExceptionLog(ex, true);
                            }
                            finally
                            {
                                if (objResend != null) { objResend.Dispose(); }

                            }

                            #endregion
                            // 
                        }

                        //  if (UC_gloBillingTransactionLines.AutoSort != null)
                        {

                            #region "Update IsTransaction Lines Sorted --- allow it to sort only once"

                            gloDatabaseLayer.DBLayer oDB = new gloDatabaseLayer.DBLayer(_DatabaseConnectionString);
                            string strQuery = "";
                            try
                            {
                                oDB.Connect(false);
                                strQuery = "Update BL_Transaction_Claim_MST  WITH(READPAST) SET bSorted = " + UC_gloBillingTransactionLines.AutoSort.GetHashCode() + " WHERE nTransactionMasterID = " + _MasterTransactionID + "";
                                oDB.Execute_Query(strQuery);
                                oDB.Disconnect();
                            }
                            catch (Exception Ex)
                            {
                                gloAuditTrail.gloAuditTrail.ExceptionLog(Ex, true);
                            }
                            finally
                            {
                                oDB.Dispose();
                            }

                            #endregion

                        }

                        if (ReplacementClaimCreationType != global::gloBilling.ReplacementClaimCreationType.Copy)
                        {
                            gloCharges.VoidAndReplaceClaim(nReplacementByTransMasterID, nReplacingTransMasterID, _InitialTransaction.TransactionMasterID, bIsCopiedClaim);
                        }
                    }

                }


                #endregion

                //MaheshB 20100424

                // RESEND & Hold CLAIM region moved from here 03-march-2014 Sameer for ressoved bug no 65901 in glosuite 8.0.1.0 
                #region " UB04 DATA  "

                if (tls_AddUBData.Visible == true && oUB != null)
                {
                    gloDatabaseLayer.DBParameters oDBUB04Parameters = new gloDatabaseLayer.DBParameters();
                    gloDatabaseLayer.DBLayer oDBUb04 = new gloDatabaseLayer.DBLayer(_DatabaseConnectionString);
                    try
                    {
                        oDBUB04Parameters.Add("@nID", 0, ParameterDirection.Input, SqlDbType.BigInt);
                        oDBUB04Parameters.Add("@nTransactionID", _InitialTransaction.TransactionID, ParameterDirection.Input, SqlDbType.BigInt);
                        oDBUB04Parameters.Add("@nTransactionMasterID", _InitialTransaction.TransactionMasterID, ParameterDirection.Input, SqlDbType.BigInt);
                        oDBUB04Parameters.Add("@nClaimNo", MasterTransaction.ClaimNo, ParameterDirection.Input, SqlDbType.BigInt);

                        #region "Value Code"

                        if (oUB.sValueCode01 != null && oUB.sValueCode01.Trim().Length > 0)
                            oDBUB04Parameters.Add("@sValueCode01", oUB.sValueCode01, ParameterDirection.Input, SqlDbType.VarChar);
                        else
                            oDBUB04Parameters.Add("@sValueCode01", DBNull.Value, ParameterDirection.Input, SqlDbType.VarChar);
                        if (oUB.nValueAmount01 != null)
                            oDBUB04Parameters.Add("@nValueAmount01", oUB.nValueAmount01, ParameterDirection.Input, SqlDbType.Decimal);
                        else
                            oDBUB04Parameters.Add("@nValueAmount01", DBNull.Value, ParameterDirection.Input, SqlDbType.Decimal);
                        if (oUB.sValueCode02 != null && oUB.sValueCode02.Trim().Length > 0)
                            oDBUB04Parameters.Add("@sValueCode02", oUB.sValueCode02, ParameterDirection.Input, SqlDbType.VarChar);
                        else
                            oDBUB04Parameters.Add("@sValueCode02", DBNull.Value, ParameterDirection.Input, SqlDbType.VarChar);
                        if (oUB.nValueAmount02 != null)
                            oDBUB04Parameters.Add("@nValueAmount02", oUB.nValueAmount02, ParameterDirection.Input, SqlDbType.Decimal);
                        else
                            oDBUB04Parameters.Add("@nValueAmount02", DBNull.Value, ParameterDirection.Input, SqlDbType.Decimal);
                        if (oUB.sValueCode03 != null && oUB.sValueCode03.Trim().Length > 0)
                            oDBUB04Parameters.Add("@sValueCode03", oUB.sValueCode03, ParameterDirection.Input, SqlDbType.VarChar);
                        else
                            oDBUB04Parameters.Add("@sValueCode03", DBNull.Value, ParameterDirection.Input, SqlDbType.VarChar);
                        if (oUB.nValueAmount03 != null)
                            oDBUB04Parameters.Add("@nValueAmount03", oUB.nValueAmount03, ParameterDirection.Input, SqlDbType.Decimal);
                        else
                            oDBUB04Parameters.Add("@nValueAmount03", DBNull.Value, ParameterDirection.Input, SqlDbType.Decimal);

                        if (oUB.sValueCode04 != null && oUB.sValueCode04.Trim().Length > 0)
                            oDBUB04Parameters.Add("@sValueCode04", oUB.sValueCode04, ParameterDirection.Input, SqlDbType.VarChar);
                        else
                            oDBUB04Parameters.Add("@sValueCode04", DBNull.Value, ParameterDirection.Input, SqlDbType.VarChar);

                        if (oUB.nValueAmount04 != null)
                            oDBUB04Parameters.Add("@nValueAmount04", oUB.nValueAmount04, ParameterDirection.Input, SqlDbType.Decimal);
                        else
                            oDBUB04Parameters.Add("@nValueAmount04", DBNull.Value, ParameterDirection.Input, SqlDbType.Decimal);

                        if (oUB.sValueCode05 != null && oUB.sValueCode05.Trim().Length > 0)
                            oDBUB04Parameters.Add("@sValueCode05", oUB.sValueCode05, ParameterDirection.Input, SqlDbType.VarChar);
                        else
                            oDBUB04Parameters.Add("@sValueCode05", DBNull.Value, ParameterDirection.Input, SqlDbType.VarChar);

                        if (oUB.nValueAmount05 != null)
                            oDBUB04Parameters.Add("@nValueAmount05", oUB.nValueAmount05, ParameterDirection.Input, SqlDbType.Decimal);
                        else
                            oDBUB04Parameters.Add("@nValueAmount05", DBNull.Value, ParameterDirection.Input, SqlDbType.Decimal);

                        if (oUB.sValueCode06 != null && oUB.sValueCode06.Trim().Length > 0)
                            oDBUB04Parameters.Add("@sValueCode06", oUB.sValueCode06, ParameterDirection.Input, SqlDbType.VarChar);
                        else
                            oDBUB04Parameters.Add("@sValueCode06", DBNull.Value, ParameterDirection.Input, SqlDbType.VarChar);

                        if (oUB.nValueAmount06 != null)
                            oDBUB04Parameters.Add("@nValueAmount06", oUB.nValueAmount06, ParameterDirection.Input, SqlDbType.Decimal);
                        else
                            oDBUB04Parameters.Add("@nValueAmount06", DBNull.Value, ParameterDirection.Input, SqlDbType.Decimal);

                        if (oUB.sValueCode07 != null && oUB.sValueCode07.Trim().Length > 0)
                            oDBUB04Parameters.Add("@sValueCode07", oUB.sValueCode07, ParameterDirection.Input, SqlDbType.VarChar);
                        else
                            oDBUB04Parameters.Add("@sValueCode07", DBNull.Value, ParameterDirection.Input, SqlDbType.VarChar);

                        if (oUB.nValueAmount07 != null)
                            oDBUB04Parameters.Add("@nValueAmount07", oUB.nValueAmount07, ParameterDirection.Input, SqlDbType.Decimal);
                        else
                            oDBUB04Parameters.Add("@nValueAmount07", DBNull.Value, ParameterDirection.Input, SqlDbType.Decimal);

                        if (oUB.sValueCode08 != null && oUB.sValueCode08.Trim().Length > 0)
                            oDBUB04Parameters.Add("@sValueCode08", oUB.sValueCode08, ParameterDirection.Input, SqlDbType.VarChar);
                        else
                            oDBUB04Parameters.Add("@sValueCode08", DBNull.Value, ParameterDirection.Input, SqlDbType.VarChar);

                        if (oUB.nValueAmount08 != null)
                            oDBUB04Parameters.Add("@nValueAmount08", oUB.nValueAmount08, ParameterDirection.Input, SqlDbType.Decimal);
                        else
                            oDBUB04Parameters.Add("@nValueAmount08", DBNull.Value, ParameterDirection.Input, SqlDbType.Decimal);

                        if (oUB.sValueCode09 != null && oUB.sValueCode09.Trim().Length > 0)
                            oDBUB04Parameters.Add("@sValueCode09", oUB.sValueCode09, ParameterDirection.Input, SqlDbType.VarChar);
                        else
                            oDBUB04Parameters.Add("@sValueCode09", DBNull.Value, ParameterDirection.Input, SqlDbType.VarChar);

                        if (oUB.nValueAmount09 != null)
                            oDBUB04Parameters.Add("@nValueAmount09", oUB.nValueAmount09, ParameterDirection.Input, SqlDbType.Decimal);
                        else
                            oDBUB04Parameters.Add("@nValueAmount09", DBNull.Value, ParameterDirection.Input, SqlDbType.Decimal);

                        if (oUB.sValueCode10 != null && oUB.sValueCode10.Trim().Length > 0)
                            oDBUB04Parameters.Add("@sValueCode10", oUB.sValueCode10, ParameterDirection.Input, SqlDbType.VarChar);
                        else
                            oDBUB04Parameters.Add("@sValueCode10", DBNull.Value, ParameterDirection.Input, SqlDbType.VarChar);

                        if (oUB.nValueAmount10 != null)
                            oDBUB04Parameters.Add("@nValueAmount10", oUB.nValueAmount10, ParameterDirection.Input, SqlDbType.Decimal);
                        else
                            oDBUB04Parameters.Add("@nValueAmount10", DBNull.Value, ParameterDirection.Input, SqlDbType.Decimal);

                        if (oUB.sValueCode11 != null && oUB.sValueCode11.Trim().Length > 0)
                            oDBUB04Parameters.Add("@sValueCode11", oUB.sValueCode11, ParameterDirection.Input, SqlDbType.VarChar);
                        else
                            oDBUB04Parameters.Add("@sValueCode11", DBNull.Value, ParameterDirection.Input, SqlDbType.VarChar);

                        if (oUB.nValueAmount11 != null)
                            oDBUB04Parameters.Add("@nValueAmount11", oUB.nValueAmount11, ParameterDirection.Input, SqlDbType.Decimal);
                        else
                            oDBUB04Parameters.Add("@nValueAmount11", DBNull.Value, ParameterDirection.Input, SqlDbType.Decimal);

                        if (oUB.sValueCode12 != null && oUB.sValueCode12.Trim().Length > 0)
                            oDBUB04Parameters.Add("@sValueCode12", oUB.sValueCode12, ParameterDirection.Input, SqlDbType.VarChar);
                        else
                            oDBUB04Parameters.Add("@sValueCode12", DBNull.Value, ParameterDirection.Input, SqlDbType.VarChar);
                        if (oUB.nValueAmount12 != null)
                            oDBUB04Parameters.Add("@nValueAmount12", oUB.nValueAmount12, ParameterDirection.Input, SqlDbType.Decimal);
                        else
                            oDBUB04Parameters.Add("@nValueAmount12", DBNull.Value, ParameterDirection.Input, SqlDbType.Decimal);

                        oDBUb04.Connect(false);
                        oDBUb04.CheckConnection();
                        oDBUb04.Execute("BL_UP_ValueCode", oDBUB04Parameters);

                        #endregion "Value Code"

                        #region "Condition Code"

                        oDBUB04Parameters.Clear();
                        oDBUB04Parameters.Add("@nID", 0, ParameterDirection.Input, SqlDbType.BigInt);
                        oDBUB04Parameters.Add("@nTransactionID", _InitialTransaction.TransactionID, ParameterDirection.Input, SqlDbType.BigInt);
                        oDBUB04Parameters.Add("@nTransactionMasterID", _InitialTransaction.TransactionMasterID, ParameterDirection.Input, SqlDbType.BigInt);
                        oDBUB04Parameters.Add("@nClaimNo", MasterTransaction.ClaimNo, ParameterDirection.Input, SqlDbType.BigInt);
                        if (oUB.sTypeofbill != null && oUB.sTypeofbill.Trim().Length > 0)
                            oDBUB04Parameters.Add("@sTypeOfbill", oUB.sTypeofbill, ParameterDirection.Input, SqlDbType.VarChar);
                        else
                            oDBUB04Parameters.Add("@sTypeOfbill", DBNull.Value, ParameterDirection.Input, SqlDbType.VarChar);

                        if (oUB.sConditionCode01 != null)
                            oDBUB04Parameters.Add("@sConditionCode01", oUB.sConditionCode01, ParameterDirection.Input, SqlDbType.VarChar);
                        else
                            oDBUB04Parameters.Add("@sConditionCode01", DBNull.Value, ParameterDirection.Input, SqlDbType.VarChar);

                        if (oUB.sConditionCode02 != null)
                            oDBUB04Parameters.Add("@sConditionCode02", oUB.sConditionCode02, ParameterDirection.Input, SqlDbType.VarChar);
                        else
                            oDBUB04Parameters.Add("@sConditionCode02", DBNull.Value, ParameterDirection.Input, SqlDbType.VarChar);

                        if (oUB.sConditionCode03 != null)
                            oDBUB04Parameters.Add("@sConditionCode03", oUB.sConditionCode03, ParameterDirection.Input, SqlDbType.VarChar);

                        if (oUB.sConditionCode04 != null)
                            oDBUB04Parameters.Add("@sConditionCode04", oUB.sConditionCode04, ParameterDirection.Input, SqlDbType.VarChar);
                        else
                            oDBUB04Parameters.Add("@sConditionCode04", DBNull.Value, ParameterDirection.Input, SqlDbType.VarChar);

                        if (oUB.sConditionCode05 != null)
                            oDBUB04Parameters.Add("@sConditionCode05", oUB.sConditionCode05, ParameterDirection.Input, SqlDbType.VarChar);
                        else
                            oDBUB04Parameters.Add("@sConditionCode05", DBNull.Value, ParameterDirection.Input, SqlDbType.VarChar);

                        if (oUB.sConditionCode06 != null)
                            oDBUB04Parameters.Add("@sConditionCode06", oUB.sConditionCode06, ParameterDirection.Input, SqlDbType.VarChar);
                        else
                            oDBUB04Parameters.Add("@sConditionCode06", DBNull.Value, ParameterDirection.Input, SqlDbType.VarChar);

                        if (oUB.sConditionCode07 != null)
                            oDBUB04Parameters.Add("@sConditionCode07", oUB.sConditionCode07, ParameterDirection.Input, SqlDbType.VarChar);
                        else
                            oDBUB04Parameters.Add("@sConditionCode07", DBNull.Value, ParameterDirection.Input, SqlDbType.VarChar);

                        if (oUB.sConditionCode08 != null)
                            oDBUB04Parameters.Add("@sConditionCode08", oUB.sConditionCode08, ParameterDirection.Input, SqlDbType.VarChar);
                        else
                            oDBUB04Parameters.Add("@sConditionCode08", DBNull.Value, ParameterDirection.Input, SqlDbType.VarChar);

                        if (oUB.sConditionCode09 != null)
                            oDBUB04Parameters.Add("@sConditionCode09", oUB.sConditionCode09, ParameterDirection.Input, SqlDbType.VarChar);
                        else
                            oDBUB04Parameters.Add("@sConditionCode09", DBNull.Value, ParameterDirection.Input, SqlDbType.VarChar);

                        if (oUB.sConditionCode10 != null)
                            oDBUB04Parameters.Add("@sConditionCode10", oUB.sConditionCode10, ParameterDirection.Input, SqlDbType.VarChar);
                        else
                            oDBUB04Parameters.Add("@sConditionCode10", DBNull.Value, ParameterDirection.Input, SqlDbType.VarChar);

                        if (oUB.sConditionCode11 != null)
                            oDBUB04Parameters.Add("@sConditionCode11", oUB.sConditionCode11, ParameterDirection.Input, SqlDbType.VarChar);
                        else
                            oDBUB04Parameters.Add("@sConditionCode11", DBNull.Value, ParameterDirection.Input, SqlDbType.VarChar);
                        oDBUb04.Execute("BL_UP_ConditionCode", oDBUB04Parameters);

                        #endregion "Condition Code"

                        #region "Occurrence Code"

                        oDBUB04Parameters.Clear();
                        oDBUB04Parameters.Add("@nID", 0, ParameterDirection.Input, SqlDbType.BigInt);
                        oDBUB04Parameters.Add("@nTransactionID", _InitialTransaction.TransactionID, ParameterDirection.Input, SqlDbType.BigInt);
                        oDBUB04Parameters.Add("@nTransactionMasterID", _InitialTransaction.TransactionMasterID, ParameterDirection.Input, SqlDbType.BigInt);
                        oDBUB04Parameters.Add("@nClaimNo", MasterTransaction.ClaimNo, ParameterDirection.Input, SqlDbType.BigInt);

                        if (oUB.sOccurrenceCode01 != null)
                            oDBUB04Parameters.Add("@sOccurrenceCode01", oUB.sOccurrenceCode01, ParameterDirection.Input, SqlDbType.VarChar);
                        else
                            oDBUB04Parameters.Add("@sOccurrenceCode01", DBNull.Value, ParameterDirection.Input, SqlDbType.VarChar);

                        if (oUB.sOccurrenceDate01 != null && Convert.ToString(oUB.sOccurrenceDate01).Trim() != "")
                            oDBUB04Parameters.Add("@dtOccurrenceDate01", oUB.sOccurrenceDate01, ParameterDirection.Input, SqlDbType.Date);
                        else
                            oDBUB04Parameters.Add("@dtOccurrenceDate01", DBNull.Value, ParameterDirection.Input, SqlDbType.Date);

                        if (oUB.sOccurrenceCode02 != null && oUB.sOccurrenceCode02.Trim().Length > 0)
                            oDBUB04Parameters.Add("@sOccurrenceCode02", oUB.sOccurrenceCode02, ParameterDirection.Input, SqlDbType.VarChar);
                        else
                            oDBUB04Parameters.Add("@sOccurrenceCode02", DBNull.Value, ParameterDirection.Input, SqlDbType.VarChar);

                        if (oUB.sOccurrenceDate02 != null && Convert.ToString(oUB.sOccurrenceDate02).Trim() != "")
                            oDBUB04Parameters.Add("@dtOccurrenceDate02", oUB.sOccurrenceDate02, ParameterDirection.Input, SqlDbType.Date);
                        else
                            oDBUB04Parameters.Add("@dtOccurrenceDate02", DBNull.Value, ParameterDirection.Input, SqlDbType.Date);

                        if (oUB.sOccurrenceCode03 != null && oUB.sOccurrenceCode03.Trim().Length > 0)
                            oDBUB04Parameters.Add("@sOccurrenceCode03", oUB.sOccurrenceCode03, ParameterDirection.Input, SqlDbType.VarChar);
                        else
                            oDBUB04Parameters.Add("@sOccurrenceCode03", DBNull.Value, ParameterDirection.Input, SqlDbType.VarChar);

                        if (oUB.sOccurrenceDate03 != null && Convert.ToString(oUB.sOccurrenceDate03).Trim() != "")
                            oDBUB04Parameters.Add("@dtOccurrenceDate03", oUB.sOccurrenceDate03, ParameterDirection.Input, SqlDbType.Date);
                        else
                            oDBUB04Parameters.Add("@dtOccurrenceDate03", DBNull.Value, ParameterDirection.Input, SqlDbType.Date);

                        if (oUB.sOccurrenceCode04 != null && oUB.sOccurrenceCode04.Trim().Length > 0)
                            oDBUB04Parameters.Add("@sOccurrenceCode04", oUB.sOccurrenceCode04, ParameterDirection.Input, SqlDbType.VarChar);
                        else
                            oDBUB04Parameters.Add("@sOccurrenceCode04", DBNull.Value, ParameterDirection.Input, SqlDbType.VarChar);

                        if (oUB.sOccurrenceDate04 != null && Convert.ToString(oUB.sOccurrenceDate04).Trim() != "")
                            oDBUB04Parameters.Add("@dtOccurrenceDate04", oUB.sOccurrenceDate04, ParameterDirection.Input, SqlDbType.Date);
                        else
                            oDBUB04Parameters.Add("@dtOccurrenceDate04", DBNull.Value, ParameterDirection.Input, SqlDbType.Date);

                        if (oUB.sOccurrenceCode05 != null && oUB.sOccurrenceCode05.Trim().Length > 0)
                            oDBUB04Parameters.Add("@sOccurrenceCode05", oUB.sOccurrenceCode05, ParameterDirection.Input, SqlDbType.VarChar);
                        else
                            oDBUB04Parameters.Add("@sOccurrenceCode05", DBNull.Value, ParameterDirection.Input, SqlDbType.VarChar);

                        if (oUB.sOccurrenceDate05 != null && Convert.ToString(oUB.sOccurrenceDate05).Trim() != "")
                            oDBUB04Parameters.Add("@dtOccurrenceDate05", oUB.sOccurrenceDate05, ParameterDirection.Input, SqlDbType.Date);
                        else
                            oDBUB04Parameters.Add("@dtOccurrenceDate05", DBNull.Value, ParameterDirection.Input, SqlDbType.Date);

                        if (oUB.sOccurrenceCode06 != null && oUB.sOccurrenceCode06.Trim().Length > 0)
                            oDBUB04Parameters.Add("@sOccurrenceCode06", oUB.sOccurrenceCode06, ParameterDirection.Input, SqlDbType.VarChar);
                        else
                            oDBUB04Parameters.Add("@sOccurrenceCode06", DBNull.Value, ParameterDirection.Input, SqlDbType.VarChar);

                        if (oUB.sOccurrenceDate06 != null && Convert.ToString(oUB.sOccurrenceDate06).Trim() != "")
                            oDBUB04Parameters.Add("@dtOccurrenceDate06", oUB.sOccurrenceDate06, ParameterDirection.Input, SqlDbType.Date);
                        else
                            oDBUB04Parameters.Add("@dtOccurrenceDate06", DBNull.Value, ParameterDirection.Input, SqlDbType.Date);

                        if (oUB.sOccurrenceCode07 != null && oUB.sOccurrenceCode07.Trim().Length > 0)
                            oDBUB04Parameters.Add("@sOccurrenceCode07", oUB.sOccurrenceCode07, ParameterDirection.Input, SqlDbType.VarChar);
                        else
                            oDBUB04Parameters.Add("@sOccurrenceCode07", DBNull.Value, ParameterDirection.Input, SqlDbType.VarChar);

                        if (oUB.sOccurrenceDate07 != null && Convert.ToString(oUB.sOccurrenceDate07).Trim() != "")
                            oDBUB04Parameters.Add("@dtOccurrenceDate07", oUB.sOccurrenceDate07, ParameterDirection.Input, SqlDbType.Date);
                        else
                            oDBUB04Parameters.Add("@dtOccurrenceDate07", DBNull.Value, ParameterDirection.Input, SqlDbType.Date);

                        if (oUB.sOccurrenceCode08 != null && oUB.sOccurrenceCode08.Trim().Length > 0)
                            oDBUB04Parameters.Add("@sOccurrenceCode08", oUB.sOccurrenceCode08, ParameterDirection.Input, SqlDbType.VarChar);
                        else
                            oDBUB04Parameters.Add("@sOccurrenceCode08", DBNull.Value, ParameterDirection.Input, SqlDbType.VarChar);

                        if (oUB.sOccurrenceDate08 != null && Convert.ToString(oUB.sOccurrenceDate08).Trim() != "")
                            oDBUB04Parameters.Add("@dtOccurrenceDate08", oUB.sOccurrenceDate08, ParameterDirection.Input, SqlDbType.Date);
                        else
                            oDBUB04Parameters.Add("@dtOccurrenceDate08", DBNull.Value, ParameterDirection.Input, SqlDbType.Date);

                        oDBUb04.Execute("BL_UP_OccurrenceCode", oDBUB04Parameters);

                        #endregion "Occurrence Code"

                        #region "Occurrence Span Code"

                        oDBUB04Parameters.Clear();
                        oDBUB04Parameters.Add("@nID", 0, ParameterDirection.Input, SqlDbType.BigInt);
                        oDBUB04Parameters.Add("@nTransactionID", _InitialTransaction.TransactionID, ParameterDirection.Input, SqlDbType.BigInt);
                        oDBUB04Parameters.Add("@nTransactionMasterID", _InitialTransaction.TransactionMasterID, ParameterDirection.Input, SqlDbType.BigInt);
                        oDBUB04Parameters.Add("@nClaimNo", MasterTransaction.ClaimNo, ParameterDirection.Input, SqlDbType.BigInt);

                        if (oUB.sOccurrenceSpanCode01 != null && oUB.sOccurrenceSpanCode01.Trim().Length > 0)
                            oDBUB04Parameters.Add("@sOccurrenceSpanCode01", oUB.sOccurrenceSpanCode01, ParameterDirection.Input, SqlDbType.VarChar);
                        else
                            oDBUB04Parameters.Add("@sOccurrenceSpanCode01", DBNull.Value, ParameterDirection.Input, SqlDbType.VarChar);

                        if (oUB.sOccurrenceFromSpanDate01 != null && Convert.ToString(oUB.sOccurrenceFromSpanDate01).Trim() != "")
                            oDBUB04Parameters.Add("@dtOccurrenceFromSpanDate01", oUB.sOccurrenceFromSpanDate01, ParameterDirection.Input, SqlDbType.Date);
                        else
                            oDBUB04Parameters.Add("@dtOccurrenceFromSpanDate01", DBNull.Value, ParameterDirection.Input, SqlDbType.Date);

                        if (oUB.sOccurrenceTOSpanDate01 != null && Convert.ToString(oUB.sOccurrenceTOSpanDate01).Trim() != "")
                            oDBUB04Parameters.Add("@dtOccurrenceToSpanDate01", oUB.sOccurrenceTOSpanDate01, ParameterDirection.Input, SqlDbType.Date);
                        else
                            oDBUB04Parameters.Add("@dtOccurrenceToSpanDate01", DBNull.Value, ParameterDirection.Input, SqlDbType.Date);

                        if (oUB.sOccurrenceSpanCode02 != null && oUB.sOccurrenceSpanCode02.Trim().Length > 0)
                            oDBUB04Parameters.Add("@sOccurrenceSpanCode02", oUB.sOccurrenceSpanCode02, ParameterDirection.Input, SqlDbType.VarChar);
                        else
                            oDBUB04Parameters.Add("@sOccurrenceSpanCode02", DBNull.Value, ParameterDirection.Input, SqlDbType.VarChar);

                        if (oUB.sOccurrenceFromSpanDate02 != null && Convert.ToString(oUB.sOccurrenceFromSpanDate02).Trim() != "")
                            oDBUB04Parameters.Add("@dtOccurrenceFromSpanDate02", oUB.sOccurrenceFromSpanDate02, ParameterDirection.Input, SqlDbType.Date);
                        else
                            oDBUB04Parameters.Add("@dtOccurrenceFromSpanDate02", DBNull.Value, ParameterDirection.Input, SqlDbType.Date);

                        if (oUB.sOccurrenceToSpanDate02 != null && Convert.ToString(oUB.sOccurrenceToSpanDate02).Trim() != "")
                            oDBUB04Parameters.Add("@dtOccurrenceTOSpanDate02", oUB.sOccurrenceToSpanDate02, ParameterDirection.Input, SqlDbType.Date);
                        else
                            oDBUB04Parameters.Add("@dtOccurrenceTOSpanDate02", DBNull.Value, ParameterDirection.Input, SqlDbType.Date);

                        if (oUB.sOccurrenceSpanCode03 != null && oUB.sOccurrenceSpanCode03.Trim().Length > 0)
                            oDBUB04Parameters.Add("@sOccurrenceSpanCode03", oUB.sOccurrenceSpanCode03, ParameterDirection.Input, SqlDbType.VarChar);
                        else
                            oDBUB04Parameters.Add("@sOccurrenceSpanCode03", DBNull.Value, ParameterDirection.Input, SqlDbType.VarChar);

                        if (oUB.sOccurrenceFromSpanDate03 != null && Convert.ToString(oUB.sOccurrenceFromSpanDate03).Trim() != "")
                            oDBUB04Parameters.Add("@dtOccurrenceFromSpanDate03", oUB.sOccurrenceFromSpanDate03, ParameterDirection.Input, SqlDbType.Date);
                        else
                            oDBUB04Parameters.Add("@dtOccurrenceFromSpanDate03", DBNull.Value, ParameterDirection.Input, SqlDbType.Date);

                        if (oUB.sOccurrenceToSpanDate03 != null && Convert.ToString(oUB.sOccurrenceToSpanDate03).Trim() != "")
                            oDBUB04Parameters.Add("@dtOccurrenceTOSpanDate03", oUB.sOccurrenceToSpanDate03, ParameterDirection.Input, SqlDbType.Date);
                        else
                            oDBUB04Parameters.Add("@dtOccurrenceTOSpanDate03", DBNull.Value, ParameterDirection.Input, SqlDbType.Date);

                        if (oUB.sOccurrenceSpanCode04 != null && oUB.sOccurrenceSpanCode04.Trim().Length > 0)
                            oDBUB04Parameters.Add("@sOccurrenceSpanCode04", oUB.sOccurrenceSpanCode04, ParameterDirection.Input, SqlDbType.VarChar);
                        else
                            oDBUB04Parameters.Add("@sOccurrenceSpanCode04", DBNull.Value, ParameterDirection.Input, SqlDbType.VarChar);

                        if (oUB.sOccurrenceFromSpanDate04 != null && Convert.ToString(oUB.sOccurrenceFromSpanDate04).Trim() != "")
                            oDBUB04Parameters.Add("@dtOccurrenceFromSpanDate04", oUB.sOccurrenceFromSpanDate04, ParameterDirection.Input, SqlDbType.Date);
                        else
                            oDBUB04Parameters.Add("@dtOccurrenceFromSpanDate04", DBNull.Value, ParameterDirection.Input, SqlDbType.Date);

                        if (oUB.sOccurrenceToSpanDate04 != null && Convert.ToString(oUB.sOccurrenceToSpanDate04).Trim() != "")
                            oDBUB04Parameters.Add("@dtOccurrenceTOSpanDate04", oUB.sOccurrenceToSpanDate04, ParameterDirection.Input, SqlDbType.Date);
                        else
                            oDBUB04Parameters.Add("@dtOccurrenceTOSpanDate04", DBNull.Value, ParameterDirection.Input, SqlDbType.Date);

                        oDBUb04.Execute("BL_UP_OccurrenceSpanCode", oDBUB04Parameters);
                        oDBUb04.Disconnect();

                        #endregion "Occurrence Span Code"
                    }
                    catch (Exception ex)
                    {
                        gloAuditTrail.gloAuditTrail.ExceptionLog(ex, true);
                        gloAuditTrail.gloAuditTrail.CreateAuditLog(ActivityModule.Billing, ActivityCategory.SetupCharges, ActivityType.Add, "Exception while Add Charges : " + ex.Message + " ", MasterTransaction.PatientID, 0, MasterTransaction.ProviderID, ActivityOutCome.Failure);
                    }
                    finally
                    {
                        if (oDBUb04 != null) { oDBUb04.Dispose(); }
                        if (oDBUB04Parameters != null) { oDBUB04Parameters.Dispose(); }

                    }
                }

                #endregion

                #region " Remove Claim From Batch if Responsible Plan is on Hold "
                if (!_oClaimHold.IsHold)
                {
                    oClsBL_Hold.RemovePlanHoldClaimsFromBatch(Convert.ToInt64(c1Insurance.GetData(Convert.ToInt16(nCurrentResponsibleParty), COL_INSURANCECONTACTID)), _InitialTransaction.TransactionID);
                }
                #endregion

                if (_result == true)
                    if (MasterTransaction.SubClaimNo == "")
                        _TransactionID = ogloBilling.GetBillingTransactionTrackingID(MasterTransaction.ClaimNo);
                    else
                        _TransactionID = ogloBilling.GetBillingTransactionTrackingID(MasterTransaction.ClaimNo, Convert.ToInt64(MasterTransaction.SubClaimNo));

                DataTable dtModified = gloCharges.GetModifiyTransaction(_MasterTransactionID);

                if (dtModified != null && dtModified.Rows.Count > 0)
                {
                    LastnTransactionId = Convert.ToInt64(dtModified.Rows[0]["TransactionID"]);
                    LastnTransactionMasterId = Convert.ToInt64(dtModified.Rows[0]["TransactionMasterID"]);
                    LastnTransactionModifiedDate = Convert.ToDateTime(dtModified.Rows[0]["ModifyDate"]);
                }
            }
            catch (Exception ex)
            {
                gloAuditTrail.gloAuditTrail.ExceptionLog(ex, true);
                gloAuditTrail.gloAuditTrail.CreateAuditLog(ActivityModule.Billing, ActivityCategory.SetupCharges, ActivityType.Add, "Exception while Add Charges : " + ex.Message + " ", MasterTransaction.PatientID, 0, MasterTransaction.ProviderID, ActivityOutCome.Failure);
            }
            finally
            {
                if (ogloBilling != null) { ogloBilling.Dispose(); }
                if (oClsBL_Hold != null) { oClsBL_Hold.Dispose(); }
                if (MasterTransaction != null) { MasterTransaction.Dispose(); }
                if (Insurance != null) { Insurance.Dispose(); }

                // if (oLineTransactions != null) { oLineTransactions.Dispose(); }

            }
            return _result;
        }

        private void UpdateOldPatientPayement_To_NewPatient(Int64 nTransactionID, Int64 nOldPatientID, Int64 nNewChangedPatientID)
        {


            gloDatabaseLayer.DBLayer oDB = new gloDatabaseLayer.DBLayer(AppSettings.ConnectionStringPM);
            gloDatabaseLayer.DBParameters oParameters = new gloDatabaseLayer.DBParameters();
            try
            {
                oParameters.Add("@nTransactionID", nTransactionID, ParameterDirection.Input, SqlDbType.BigInt);
                oParameters.Add("@nOldPatientID", nOldPatientID, ParameterDirection.Input, SqlDbType.BigInt);
                oParameters.Add("@nNewChangedPatientID", nNewChangedPatientID, ParameterDirection.Input, SqlDbType.BigInt);
                oParameters.Add("@nPAccountID", this.nPAccountID, ParameterDirection.Input, SqlDbType.BigInt);
                oParameters.Add("@nGuarantorID", this.nGuarantorID, ParameterDirection.Input, SqlDbType.BigInt);
                oParameters.Add("@nAccountPatientID", this.nAccountPatientID, ParameterDirection.Input, SqlDbType.BigInt);
                oDB.Connect(false);
                oDB.Execute("PA_INUP_Patient_Payment_Transafer", oParameters);
            }
            catch (Exception ex)
            {
                gloAuditTrail.gloAuditTrail.ExceptionLog(ex, true);
                gloAuditTrail.gloAuditTrail.CreateAuditLog(ActivityModule.Billing, ActivityCategory.SetupCharges, ActivityType.Add, "Exception while Add Charges : " + ex.Message + " ", ActivityOutCome.Failure);
            }
            finally
            {
                if (oDB != null)
                    oDB.Dispose();
                if (oParameters != null)
                    oParameters.Dispose();
            }
        }

        private void AddTransactionForValidation()
        {
            gloBilling ogloBilling = new gloBilling(_DatabaseConnectionString, _emrdatabaseConnectionString);
            Transaction MasterTransaction = new Transaction();
            TransactionInsurance Insurance = new TransactionInsurance();
            TransactionLines oLineTransactions = null;
            Int64 _returnID = 0;

            Int64 _MasterTransactionPrefixId = 0;
            Int64 _MasterTransactionAppointmentId = 0;
            Int64 _MasterTransactionVisitId = 0;

            try
            {
                //***********************************************
                //Fields not implemented yet, so hard coded

                _MasterTransactionPrefixId = 123;
                _MasterTransactionAppointmentId = 999;
                _MasterTransactionVisitId = 987;

                //***********************************************

                #region " Save Transaction "

                if (!(UC_gloBillingTransactionLines == null))
                {
                    if (ValidateMasterTransaction())
                    {
                        UC_gloBillingTransactionLines.IsPlanOrAdminEPSDTEnabled = EPSDTEnabled;
                        if (UC_gloBillingTransactionLines.ValidateTransaction(_InitialTransaction))
                        {
                            // oLineTransactions = new TransactionLines();
                            //txtClaimNo.Text = Convert.ToString(GenerateClaimNumber());

                            #region " Transaction Object "

                            //MasterTransaction.ClaimNo = Convert.ToInt64(txtClaimNo.Text);
                            MasterTransaction.ClaimNo = Convert.ToInt64(sClaimNo);
                            MasterTransaction.CaseNoPrefix = "Claim ";
                            MasterTransaction.AppointmentID = _MasterTransactionAppointmentId;
                            MasterTransaction.ClinicID = _ClinicID;
                            MasterTransaction.FacilityCode = Convert.ToString(cmbFacility.SelectedValue);
                            MasterTransaction.FacilityDescription = Convert.ToString(cmbFacility.Text);
                            oLineTransactions = UC_gloBillingTransactionLines.GetLineTransactions();
                            MasterTransaction.Lines = oLineTransactions;
                            MasterTransaction.MaritalStatus = oPatientControl.PatientsMaritalStatus; //"Single";
                            //MasterTransaction.MasterAppointmentID = 2111;
                            MasterTransaction.PatientID = _TransPatientID;
                            MasterTransaction.PrefixID = _MasterTransactionPrefixId;
                            MasterTransaction.ProviderID = Convert.ToInt64(cmbBillingProvider.SelectedValue);

                            //Code added on 20090505 By - Sagar Ghodke

                            MasterTransaction.TransactionUserID = this.UserID;
                            MasterTransaction.TransactionUserName = this.UserName;

                            //End Code add 20090505,Sagar Ghodke

                            if (CmbAccidentType.Text.Trim() == "Work")
                            {
                                //MasterTransaction.InjuryDate = gloDateMaster.gloDate.DateAsNumber(dtpInjuryDate.Value.Date.ToShortDateString());
                                if (IsValidDate(mskInjuryDate.Text))
                                {
                                    MasterTransaction.InjuryDate = gloDateMaster.gloDate.DateAsNumber(mskInjuryDate.Text.ToString());
                                }
                                if (cmbClaimNo.SelectedIndex != -1)
                                {
                                    if (cmbClaimNo.Text.Trim() != "")
                                    {
                                        MasterTransaction.WorkersCompNo = cmbClaimNo.Text;
                                    }
                                }
                                MasterTransaction.WorkersComp = true;
                            }
                            else if (CmbAccidentType.Text.Trim() == "Auto")
                            {
                                if (IsValidDate(mskAccidentDate.Text))
                                {
                                    MasterTransaction.AccidentDate = gloDateMaster.gloDate.DateAsNumber(mskAccidentDate.Text.ToString());
                                }
                                MasterTransaction.AutoClaim = true;
                            }
                            else
                            {
                                if (IsValidDate(mskOnsiteDate.Text))
                                {
                                    MasterTransaction.OnsiteDate = gloDateMaster.gloDate.DateAsNumber(mskOnsiteDate.Text.ToString());
                                }

                                MasterTransaction.AutoClaim = false;
                                MasterTransaction.WorkersComp = false;
                            }

                            //MasterTransaction.UnableToWorkFromDate = gloDateMaster.gloDate.DateAsNumber(dtpUnableFromDate.Value.Date.ToShortDateString());
                            //MasterTransaction.UnableToWorkFromDate = gloDateMaster.gloDate.DateAsNumber(mskUnableFromDate.Text.ToString());
                            MasterTransaction.UnableToWorkFromDate = _UnableToWorkFromDate_MoreClaimData;

                            //MasterTransaction.UnableToWorkTillDate = gloDateMaster.gloDate.DateAsNumber(dtpUnableTillDate.Value.Date.ToShortDateString());
                            //MasterTransaction.UnableToWorkTillDate = gloDateMaster.gloDate.DateAsNumber(mskUnableTillDate.Text.ToString());
                            MasterTransaction.UnableToWorkTillDate = _UnableToWorkTillDate_MoreClaimData;

                            //MasterTransaction.TransactionDate = gloDateMaster.gloDate.DateAsNumber(dtpClaimDate.Value.Date.ToShortDateString());
                            MasterTransaction.TransactionDate = gloDateMaster.gloDate.DateAsNumber(mskClaimDate.Text.ToString());

                            //MasterTransaction.TransactionID = oLineTransactions[0].TransactionId;
                            if (_IsOpenForModify == true)
                            { MasterTransaction.TransactionID = _TransactionID; }
                            else { MasterTransaction.TransactionID = 0; }
                            MasterTransaction.TransactionMode = TransactionType.Billed;
                            MasterTransaction.VisitID = _MasterTransactionVisitId;

                            if (cmbState != null && cmbState.Items.Count > 0 & cmbState.SelectedIndex != -1)
                            {
                                MasterTransaction.State = cmbState.Text;
                            }
                            //MasterTransaction.Transaction_Status = TransactionStatus.Transacted;

                            //Send to Queue 
                            MasterTransaction.Transaction_Status = TransactionStatus.Queue;

                            //MasterTransaction.HospitalizationDateFrom = gloDateMaster.gloDate.DateAsNumber(dtpHospitaliztionFrom.Value.Date.ToShortDateString());
                            MasterTransaction.HospitalizationDateFrom = gloDateMaster.gloDate.DateAsNumber(mskHospitaliztionFrom.Text.ToString());

                            MasterTransaction.dtInitTreatmentDate = Convert.ToDateTime(mskHospitaliztionFrom.Text);

                            //MasterTransaction.HospitalizationDateTo = gloDateMaster.gloDate.DateAsNumber(dtpHospitaliztionTo.Value.Date.ToShortDateString());
                            MasterTransaction.HospitalizationDateTo = gloDateMaster.gloDate.DateAsNumber(mskHospitaliztionTo.Text.ToString());

                            MasterTransaction.OutSideLab = chkOutSideLab.Checked;
                            if (chkOutSideLab.Checked)
                            {
                                MasterTransaction.OutSideLabCharges = Convert.ToDecimal(txtOutSideLabCharges.Text.Trim());
                            }

                            MasterTransaction.Insurances = new TransactionInsurances();
                            Insurance.ClinicID = _ClinicID;
                            Insurance.TransactionID = MasterTransaction.TransactionID;  //oLineTransactions[0].TransactionId;
                            Insurance.TransactionDetailID = 0;
                            Insurance.TransactionLineNo = 0;
                            MasterTransaction.Insurances.Add(Insurance);

                            if (txtPriorAuthorizationNo.Tag != null)
                            {
                                MasterTransaction.PriorAuthorizationID = Convert.ToInt64(txtPriorAuthorizationNo.Tag);

                                if (!MasterTransaction.PriorAuthorizationID.Equals(0))
                                { MasterTransaction.PriorAuthorizationNo = txtPriorAuthorizationNo.Text.Trim(); }
                            }

                            if (cmbReferralProvider.Items.Count > 0 && cmbReferralProvider.SelectedIndex != -1)
                            {
                                MasterTransaction.ReferralProviderID = Convert.ToInt64(cmbReferralProvider.SelectedValue);
                                MasterTransaction.ReferralProviderName = cmbReferralProvider.Text;
                            }

                            if (oLineTransactions != null && oLineTransactions.Count > 0)
                            { _TransactionID = oLineTransactions[0].TransactionId; }

                            #endregion

                            if (MasterTransaction != null && MasterTransaction.Lines != null && MasterTransaction.Lines.Count > 0)
                            {
                                _returnID = ogloBilling.AddTransaction(MasterTransaction, _ClinicID);
                                _TransactionID = _returnID;
                            }

                            //if (_returnID > 0)
                            //{
                            //    if (_IsEMRTransaction == true)
                            //    {
                            //        ogloBilling.AddEMRTransaction(_returnID, _EMRExamID, _EMRVisitID, _ClinicID);
                            //        gloAuditTrail.gloAuditTrail.CreateAuditLog(ActivityModule.Billing, ActivityCategory.SetupCharges, ActivityType.Add, "EMR Exam Charges added", MasterTransaction.PatientID, _returnID, MasterTransaction.ProviderID, ActivityOutCome.Success);
                            //        this.Close();
                            //    }
                            //}

                            if (_returnID > 0)
                            {
                                if (_IsOpenForModify == false)
                                {
                                    gloAuditTrail.gloAuditTrail.CreateAuditLog(ActivityModule.Billing, ActivityCategory.SetupCharges, ActivityType.Add, "Charges added", MasterTransaction.PatientID, _returnID, MasterTransaction.ProviderID, ActivityOutCome.Success);
                                }
                                else
                                {
                                    gloAuditTrail.gloAuditTrail.CreateAuditLog(ActivityModule.Billing, ActivityCategory.SetupCharges, ActivityType.Modify, "Charges Modified", MasterTransaction.PatientID, _returnID, MasterTransaction.ProviderID, ActivityOutCome.Success);
                                }

                                IsEMRTransactionSaved = true;
                            }
                            else
                            {
                                if (_IsOpenForModify == false)
                                {
                                    gloAuditTrail.gloAuditTrail.CreateAuditLog(ActivityModule.Billing, ActivityCategory.SetupCharges, ActivityType.Add, "Charges added", MasterTransaction.PatientID, _returnID, MasterTransaction.ProviderID, ActivityOutCome.Failure);
                                }
                                else
                                {
                                    gloAuditTrail.gloAuditTrail.CreateAuditLog(ActivityModule.Billing, ActivityCategory.SetupCharges, ActivityType.Modify, "Charges Modified", MasterTransaction.PatientID, _returnID, MasterTransaction.ProviderID, ActivityOutCome.Failure);
                                }
                            }

                        }
                    }
                }

                #endregion
            }
            catch (Exception ex)
            {
                gloAuditTrail.gloAuditTrail.ExceptionLog(ex, true);
                gloAuditTrail.gloAuditTrail.CreateAuditLog(ActivityModule.Billing, ActivityCategory.SetupCharges, ActivityType.Add, "Exception while Add Charges : " + ex.Message + " ", MasterTransaction.PatientID, 0, MasterTransaction.ProviderID, ActivityOutCome.Failure);
            }
            finally
            {
                if (ogloBilling != null) { ogloBilling.Dispose(); }
                if (MasterTransaction != null) { MasterTransaction.Dispose(); }
                if (Insurance != null) { Insurance.Dispose(); }
            }
        }

        public void SetupData(Int64 TransactionId)
        {
            gloBilling ogloBilling = new gloBilling(_DatabaseConnectionString, "");
            Int64 _recordUserId = 0;
            string _recordMachineId = "";
            Int64 _TransMasterID = 0;
            Int64 _nClaimNo = 0;
            DateTime _ModifyDate = DateTime.Now;

            try
            {

                FillFormLoadData(TransactionId);

                #region  " Check and Update Record Status (Open/Close) "

                gloCharges.GetMasterTransactionID(_TransactionID, out _TransMasterID, out _nClaimNo, out _ModifyDate);

                if (ogloBilling.IsRecordOpen(_TransMasterID, out _recordMachineId, out _recordUserId) == false)
                {
                    if (CallingContainer != "frmInsurancePaymentV2")
                    {
                        ogloBilling.UpdateRecordStatus(_TransMasterID, _nClaimNo, true);
                    }

                    _OpenViewMode = false;
                }
                else
                {
                    _OpenViewMode = true;
                    MessageBox.Show("Transaction is already opened for modify on machine " + _recordMachineId + "", _messageBoxCaption, MessageBoxButtons.OK, MessageBoxIcon.Information);
                }

                #endregion


                if (TransactionId > 0)
                {
                    for (int iCount = 1; iCount <= c1Insurance.Rows.Count - 1; iCount++)
                    {
                        if (c1Insurance.GetCellCheck(iCount, COL_SELECT_CURRENT_RESPONSIBLE_PARTY) == CheckEnum.Checked)
                        {
                            PartyNo = Convert.ToString(c1Insurance.GetData(iCount, COL_INS_INTERNAL_PARTYSTATUS));
                            _nResponsibleParty = Convert.ToInt64(c1Insurance.GetData(iCount, COL_INSURANCECONTACTID));
                            if (iCount == 1 && _nResponsibleParty == 0)
                                UC_gloBillingTransactionLines.IsPrimarySelfPay = true;

                        }
                    }
                    if (_OpenViewMode)
                    {
                        //OpenTransactionViewMode(); 
                        GetClaimDetails();
                    }
                    else
                    {
                        GetClaimDetails();
                        _IsOpenForModify = true;
                    }

                    for (int iCount = 1; iCount <= c1Insurance.Rows.Count - 1; iCount++)
                    {
                        if (iCount == 1)
                            _nPrimaryParty = Convert.ToInt64(c1Insurance.GetData(1, COL_INSURANCECONTACTID));

                        if (c1Insurance.GetCellCheck(iCount, COL_SELECT_CURRENT_RESPONSIBLE_PARTY) == CheckEnum.Checked)
                        {
                            PartyNo = Convert.ToString(c1Insurance.GetData(iCount, COL_INS_INTERNAL_PARTYSTATUS));
                            _nResponsibleParty = Convert.ToInt64(c1Insurance.GetData(iCount, COL_INSURANCECONTACTID));
                        }
                    }

                }
                try
                {
                    if (UC_gloBillingTransactionLines != null && UC_gloBillingTransactionLines.Enabled == true)
                    {
                        UC_gloBillingTransactionLines.Focus();
                    }
                }
                catch (Exception ex)
                {
                    gloAuditTrail.gloAuditTrail.ExceptionLog(ex, false);
                }
            }
            catch (Exception ex)
            {
                gloAuditTrail.gloAuditTrail.ExceptionLog(ex, true);
            }
            finally
            {
                if (ogloBilling != null) { ogloBilling.Dispose(); }
            }
        }

        public void AddDxToList(string DxCode, string DxDesc, bool IsDeleted)
        {
            bool _IsExistItem = false;
            string _dxcode = "";
            string _dxdesc = "";

            try
            {
                if (IsDeleted == false)
                {
                    if (DxCode.Trim() != "")
                    {
                        if (c1Dx != null && c1Dx.Rows.Count > 1)
                        {
                            for (int i = 1; i < c1Dx.Rows.Count; i++)
                            {
                                _dxcode = "";
                                _dxdesc = "";

                                _dxcode = Convert.ToString(c1Dx.GetData(i, COL_DX_CODE));
                                _dxdesc = Convert.ToString(c1Dx.GetData(i, COL_DX_DESC));
                                if (_dxcode.ToUpper().Trim() == DxCode.ToUpper().Trim()) // && _dxdesc.ToUpper() == DxDesc.ToUpper())
                                {
                                    _IsExistItem = true;

                                    if (c1Dx.GetCellCheck(i, COL_DX_SELECT) == CheckEnum.Unchecked)
                                    {
                                        c1Dx.SetData(i, COL_DX_SELECT, true);
                                    }

                                    break;

                                }
                            }
                        }
                        if (_IsExistItem == false && DxCode.Trim() != "")
                        {
                            c1Dx.Rows.Add();
                            int rowIndex = c1Dx.Rows.Count - 1;
                            c1Dx.SetData(rowIndex, COL_DX_CODE, DxCode);
                            c1Dx.SetData(rowIndex, COL_DX_DESC, DxDesc);

                            //if (rowIndex <= 8)
                            if (rowIndex <= _NoOfMaxDiagnosis)
                            { c1Dx.SetData(rowIndex, COL_DX_SELECT, true); }
                            else
                            {
                                int cnt = 0;
                                for (int i = c1Dx.Rows.Count - 1; i > 0; i--)
                                {
                                    if (c1Dx.GetCellCheck(i, COL_DX_SELECT) == CheckEnum.Checked)
                                    {
                                        cnt = cnt + 1;
                                    }
                                }
                                //if (cnt < 8)
                                if (cnt < _NoOfMaxDiagnosis)
                                {
                                    c1Dx.SetData(rowIndex, COL_DX_SELECT, true);
                                }
                            }

                        }


                    }
                }
                else
                {
                    for (int i = c1Dx.Rows.Count - 1; i > 0; i--)
                    {
                        _dxcode = "";
                        _dxdesc = "";

                        _dxcode = Convert.ToString(c1Dx.GetData(i, COL_DX_CODE));
                        _dxdesc = Convert.ToString(c1Dx.GetData(i, COL_DX_DESC));
                        if (_dxcode.ToUpper().Trim() == DxCode.ToUpper().Trim())
                        { c1Dx.Rows.Remove(i); break; }
                    }
                }


            }
            catch (Exception ex)
            {
                gloAuditTrail.gloAuditTrail.ExceptionLog(ex, true);
            }
        }

        public void SaveDxList(Int64 TransactionId, Int64 VisitId, Int64 ClaimNo, Int64 PatientId)
        {
            gloDatabaseLayer.DBLayer oDB = new gloDatabaseLayer.DBLayer(_DatabaseConnectionString);
            string _sqlQuery = "";
            Int64 _serialNo = 0;
            string _dxCode = "";
            string _dxDesc = "";
            bool _isPrimary = false;
            bool _isSelected = false;
            Object retVal = null;
            string _dxList = "''";
            int _nICDVersion = (int)gloGlobal.gloICD.CodeRevision.ICD9;
            try
            {
                oDB.Connect(false);

                //Get all the Dx from the arraylist to be deleted
                if (_arrValidDxCodes != null && _arrValidDxCodes.Count > 0)
                {
                    for (int i = 0; i <= _arrValidDxCodes.Count - 1; i++)
                    {
                        _dxList += ",'" + _arrValidDxCodes[i].ToString() + "'";
                    }
                }

                //**Delete the existing entry for the transaction
                //_sqlQuery = "delete from BL_Transaction_Diagnosis where nTransactionID = " + TransactionId + "";
                _sqlQuery = "delete from BL_Transaction_Diagnosis where nTransactionID = " + TransactionId + " and rtrim(rtrim(sDx1code))  in (" + _dxList + ")";

                int _val = oDB.Execute_Query(_sqlQuery);

                for (int i = 1; i < c1Dx.Rows.Count; i++)
                {
                    _sqlQuery = "";
                    _sqlQuery = "select ISNULL(MAX(nSerialNo),0) +1 from BL_Transaction_Diagnosis WITH (NOLOCK) where nClinicID = " + this.ClinicID + "";
                    retVal = oDB.ExecuteScalar_Query(_sqlQuery);
                    if (retVal != null) { _serialNo = Convert.ToInt64(retVal); }

                    int _rowIndex = i;
                    _dxCode = Convert.ToString(c1Dx.GetData(_rowIndex, COL_DX_CODE));
                    _dxDesc = Convert.ToString(c1Dx.GetData(_rowIndex, COL_DX_DESC));
                    if (c1Dx.GetCellCheck(_rowIndex, COL_DX_SELECT) == CheckEnum.Checked)
                    { _isSelected = true; }
                    else
                    { _isSelected = false; }
                    if (c1Dx.GetCellCheck(_rowIndex, COL_DX_ISPRIMARY) == CheckEnum.Checked)
                    { _isPrimary = true; }
                    else
                    { _isPrimary = false; }

                    if (rbICD10.Checked == true)
                        _nICDVersion = (int)gloGlobal.gloICD.CodeRevision.ICD10;
                    if (rbICD9.Checked == true)
                        _nICDVersion = (int)gloGlobal.gloICD.CodeRevision.ICD9;


                    string _sqlQueryIsDxExists = "select nTransactionID from  BL_Transaction_Diagnosis WITH (NOLOCK) where nTransactionID= " + TransactionId + " And sDx1Code ='" + _dxCode.Replace("'", "''") + "'";
                    Object retIsDxExists = oDB.ExecuteScalar_Query(_sqlQueryIsDxExists);
                    if (Convert.ToString(retIsDxExists) == "")
                    {
                        _sqlQuery = "";
                        _sqlQuery = "INSERT INTO BL_Transaction_Diagnosis " +
                        " (nTransactionID, nVisitID, nClaimNo, nPatientID, nSerialNo, sDx1Code, sDx1Description, nClinicID, bIsClaimDx,bIsPrimaryDx,nICDRevision) " +
                        " VALUES " +
                        " (" + TransactionId + "," + VisitId + "," + ClaimNo + "," + PatientId + "," + _serialNo + ",'" + _dxCode.Replace("'", "''") + "','" + _dxDesc.Replace("'", "''") + "'," + this.ClinicID + ",'" + _isSelected + "','" + _isPrimary + "'," + _nICDVersion + ") ";
                        oDB.ExecuteScalar_Query(_sqlQuery);
                    }
                }
            }
            catch (gloDatabaseLayer.DBException dbEx)
            {
                dbEx.ERROR_Log(dbEx.ToString());
            }
            catch (Exception ex)
            {
                gloAuditTrail.gloAuditTrail.ExceptionLog(ex, true);
            }
            finally
            {
                if (oDB != null) { oDB.Disconnect(); oDB.Dispose(); }
            }
        }


        public void OpenModify()
        {
            gloBilling ogloBilling = new gloBilling(_DatabaseConnectionString, _emrdatabaseConnectionString);
            Transaction _Transaction = null;
            Int64 _TransMasterID = 0;
            Int64 _nClaimNo = 0;
            DateTime _ModifyDate = DateTime.Now;
            try
            {
                UC_gloBillingTransactionLines = new gloBillingTransaction();
                UC_gloBillingTransactionLines.AutoSort = false;
                UC_gloBillingTransactionLines.InitialNofRows = 1;
                UC_gloBillingTransactionLines.IsOpenForModify = true;
                pnlTransactionLines.Controls.Add(UC_gloBillingTransactionLines);
                UC_gloBillingTransactionLines.Visible = true;
                UC_gloBillingTransactionLines.Dock = DockStyle.Fill;
                UC_gloBillingTransactionLines.PatientID = this.PatientID;
                UC_gloBillingTransactionLines.DefaultTOSID = _DefaultTOSID;
                UC_gloBillingTransactionLines.DefaultPOSID = _DefaultPOSID;
                UC_gloBillingTransactionLines.PatientProviderID = _PatientPoviderID;

                _Transaction = ogloBilling.GetChargesClaimDetails(_TransactionID, _ClinicID);
                if (_Transaction != null)
                {
                    ogloBilling.GetExpandedClaimSetting(_Transaction.ContactID, _ClinicID, out _NoOfMaxServiceLines, out _NoOfMaxDiagnosis);
                    //_NoOfMaxServiceLines = _Transaction.NoOfServiceLine;
                    //_NoOfMaxDiagnosis = _Transaction.NoOfDiagnosis;
                    _Transaction.NoOfServiceLine = _NoOfMaxServiceLines;
                    _Transaction.NoOfDiagnosis = _NoOfMaxDiagnosis;
                    UC_gloBillingTransactionLines._NoOfServiceLines = _NoOfMaxServiceLines;
                    UC_gloBillingTransactionLines._NoOfDiagnosis = _NoOfMaxDiagnosis;

                    ClaimEPSDT = _Transaction.ClaimEPSDT;

                    if (_Transaction.Hold != null)
                    {
                        _oClaimHold = _Transaction.Hold;
                    }
                    else
                    {
                        _oClaimHold = new ClaimHold();
                    }


                    if (_Transaction.ClaimBox19Note != null)
                    {
                        _oBox19Note = _Transaction.ClaimBox19Note;
                        _oBox19Notes.Add(_oBox19Note);
                    }
                    else
                    {
                        _oBox19Note = new ClaimBox19Note();
                    }

                    if (_Transaction.ClaimBox10dNote != null)
                    {
                        _sBox10dNote = _Transaction.ClaimBox10dNote;
                    }
                    else
                    {
                        _sBox10dNote = string.Empty;
                    }

                    _IllnessDate = _Transaction.IllnessDate;
                    _LastSeenDate = _Transaction.LastSeenDate;
                    _UnableToWorkFromDate_MoreClaimData = _Transaction.UnableToWorkFromDate;
                    _UnableToWorkTillDate_MoreClaimData = _Transaction.UnableToWorkTillDate;
                    _sDelayReasonCode = _Transaction.DelayReasonCodeID;
                    _sServiceAuthExceptionCode = _Transaction.ServiceAuthExceCode;

                    bIsRefProvAsSupervisor = _Transaction.bIsRefprovAsSupervisor;
                    bIsSupProvSavedForExClaims = _Transaction.bIsRefprovAsSupervisor;

                    //oPatientControl.FillDetails(_TransPatientID, gloPatientStripControl.FormName.Billing, _PatientPoviderID, false);
                    //Added by Subashish_b on 9/Feb /2011 (integration made on date-10/May/2011) for  working with the events of new patient banner (PAF)
                    if (!_IsFormLoading)
                        oPatientControl.FillDetails(_TransPatientID, gloStripControl.FormName.Billing, _PatientPoviderID, false);
                    _TransAccountID = _Transaction.PAccountID;

                    //End
                    this.PatientID = _Transaction.PatientID;


                }
                //To Preserve the object
                if (_InitialTransaction != null)
                {
                    _InitialTransaction.Dispose();
                    _InitialTransaction = null;
                }
                _InitialTransaction = _Transaction;

                _MasterTransactionID = Convert.ToInt64(_Transaction.TransactionMasterID);


                _dtEOBPayments = gloBilling.GetEOBPaymentsV2(_MasterTransactionID);
                _dtEOBNextAction = gloBilling.GetEOBNextAction(_MasterTransactionID);

                FillClaim(this.PatientID);

                if (_Transaction != null)
                {

                    txtClaimNo.Text = _Transaction.ClaimNumber;
                    sClaimNo = gloCharges.FormattedClaimNumberGeneration(Convert.ToString(_Transaction.ClaimNo));
                    txtClaimNo.Tag = _Transaction.SubClaimNo;
                    cmbFacility.Text = Convert.ToString(_Transaction.FacilityCode);
                    if (cmbFacility.SelectedIndex != -1)
                    {
                        UC_gloBillingTransactionLines.FacilityID = Convert.ToInt64(cmbFacility.SelectedValue);
                        SetFacility();
                    }

                    cmbBillingProvider.SelectedValue = _Transaction.ProviderID;

                    mskClaimDate.Text = gloDateMaster.gloDate.DateAsDate(_Transaction.TransactionDate).ToString("MM/dd/yyyy");

                    txtPriorAuthorizationNo.Tag = Convert.ToInt64(_Transaction.PriorAuthorizationID);
                    txtPriorAuthorizationNo.Text = Convert.ToString(_Transaction.PriorAuthorizationNo);

                    if (_Transaction.OnsiteDate > 0)
                    {
                        mskOnsiteDate.Text = gloDateMaster.gloDate.DateAsDate(_Transaction.OnsiteDate).ToString("MM/dd/yyyy");
                    }
                    else
                    {
                        mskOnsiteDate.Text = "";
                    }



                    if (_Transaction.WorkersComp == true)
                    {
                        _WorkerCompType = "WorkersComp";

                        CmbAccidentType.Text = "Work";
                        CmbAccidentType.SelectedIndex = (int)AccidentType.Work;
                        cmbClaimNo.SelectedIndex = cmbClaimNo.FindStringExact(_Transaction.WorkersCompNo);
                        _WorkerCompNo = Convert.ToString(_Transaction.WorkersCompNo);

                        if (_Transaction.InjuryDate > 0)
                        {
                            mskInjuryDate.Text = gloDateMaster.gloDate.DateAsDate(_Transaction.InjuryDate).ToString("MM/dd/yyyy");
                            _WorkerInjuryDate = gloDateMaster.gloDate.DateAsDate(_Transaction.InjuryDate).ToString("MM/dd/yyyy");
                        }
                        else
                        {
                            mskInjuryDate.Text = "";
                            _WorkerInjuryDate = "";
                        }
                    }
                    if (_Transaction.AutoClaim == true)
                    {
                        _WorkerCompType = "AutoClaim";
                        CmbAccidentType.Text = "Auto";
                        CmbAccidentType.SelectedIndex = (int)AccidentType.Auto;
                        _AutoClaimNo = Convert.ToString(_Transaction.WorkersCompNo);
                        if (_Transaction.AccidentDate > 0)
                        {
                            mskAccidentDate.Text = gloDateMaster.gloDate.DateAsDate(_Transaction.AccidentDate).ToString("MM/dd/yyyy");
                            _AccidentDate = gloDateMaster.gloDate.DateAsDate(_Transaction.AccidentDate).ToString("MM/dd/yyyy");
                        }
                        else
                        {
                            mskAccidentDate.Text = "";
                            _AccidentDate = "";
                        }
                    }
                    if (_Transaction.OtherAccident == true)
                    {
                        _WorkerCompType = "OtherAccident";
                        CmbAccidentType.Text = "Other";
                        CmbAccidentType.SelectedIndex = (int)AccidentType.Other;
                        _OtherAccidentNo = Convert.ToString(_Transaction.WorkersCompNo);
                        if (_Transaction.OtherAccidentDate > 0)
                        {
                            mskOtherDate.Text = gloDateMaster.gloDate.DateAsDate(_Transaction.OtherAccidentDate).ToString("MM/dd/yyyy");
                            _OtherDate = gloDateMaster.gloDate.DateAsDate(_Transaction.OtherAccidentDate).ToString("MM/dd/yyyy");
                        }
                        else
                        {
                            mskOtherDate.Text = "";
                            _OtherDate = "";

                        }
                    }

                    txt_WcAc.Text = Convert.ToString(_Transaction.WorkersCompNo);


                    //if (_Transaction.UnableToWorkFromDate > 0)
                    //{
                    //    mskUnableFromDate.Text = gloDateMaster.gloDate.DateAsDate(_Transaction.UnableToWorkFromDate).ToString("MM/dd/yyyy");
                    //}
                    //else
                    //{
                    //    mskUnableFromDate.Text = "";
                    //}

                    if (_Transaction.UnableToWorkFromDate > 0)
                    { _UnableToWorkFromDate_MoreClaimData = _Transaction.UnableToWorkFromDate; }
                    else
                    { mskUnableFromDate.Text = ""; _UnableToWorkFromDate_MoreClaimData = 0; }

                    //if (_Transaction.UnableToWorkTillDate > 0)
                    //{
                    //    mskUnableTillDate.Text = gloDateMaster.gloDate.DateAsDate(_Transaction.UnableToWorkTillDate).ToString("MM/dd/yyyy");
                    //}
                    //else
                    //{
                    //    mskUnableTillDate.Text = "";
                    //}

                    if (_Transaction.UnableToWorkTillDate > 0)
                    { _UnableToWorkTillDate_MoreClaimData = _Transaction.UnableToWorkTillDate; }
                    else
                    { mskUnableTillDate.Text = ""; _UnableToWorkTillDate_MoreClaimData = 0; }

                    if (_Transaction.HospitalizationDateFrom > 0)
                    {
                        mskHospitaliztionFrom.Text = gloDateMaster.gloDate.DateAsDate(_Transaction.HospitalizationDateFrom).ToString("MM/dd/yyyy");
                    }
                    else
                    {
                        mskHospitaliztionFrom.Text = "";
                    }

                    if (_Transaction.dtInitTreatmentDate != null)
                    {
                        mskInitTreatment.Text = (_Transaction.dtInitTreatmentDate.ToString());
                    }
                    else
                    {
                        mskInitTreatment.Text = "";
                    }

                    if (_Transaction.HospitalizationDateTo > 0)
                    {
                        mskHospitaliztionTo.Text = gloDateMaster.gloDate.DateAsDate(_Transaction.HospitalizationDateTo).ToString("MM/dd/yyyy");
                    }
                    else
                    {
                        mskHospitaliztionTo.Text = "";
                    }


                    chkOutSideLab.Checked = _Transaction.OutSideLab;
                    if (_Transaction.OutSideLabCharges > 0)
                    {
                        txtOutSideLabCharges.Text = _Transaction.OutSideLabCharges.ToString();
                    }

                    if (_Transaction.State != "")
                    {
                        int index = cmbState.FindStringExact(_Transaction.State);
                        if (index >= 0)
                        { cmbState.SelectedIndex = index; }
                    }

                    if (_Transaction.IsSameAsBillingProvider)
                    {
                        chk_SameasBillingProvider.Checked = true;
                    }
                    else
                    {
                        chk_SameasBillingProvider.Checked = false;
                    }

                    if (_Transaction.ReferalProviderID_New > 0)
                    {
                        cmbReferralProvider.SelectedValue = _Transaction.ReferalProviderID_New;
                        _InitialReferalProviderId = _Transaction.ReferalProviderID_New;
                    }
                    else
                    {
                        cmbReferralProvider.SelectedValue = 0;
                    }

                    if (cmbReferralProvider.SelectedIndex == -1)
                    {
                        AddCurrentSavedReferal(_Transaction.ReferalProviderID_New);
                    }
                    txtClaimLastStatus.Text = Convert.ToString(_Transaction.Transaction_Status.GetHashCode());
                    txtLastStatusId.Text = Convert.ToString(_Transaction.LastStatusId);
                    txtSendCounter.Text = Convert.ToString(_Transaction.SendCounter);
                    txtSendToRejection.Text = Convert.ToString(_Transaction.SendToRejection);

                    lblCloseDayTray.Text = Convert.ToString(_Transaction.CloseDayTrayName);
                    lblCloseDayTray.Tag = Convert.ToInt64(_Transaction.CloseDayTrayID);

                    SelectedChargeTrayID = Convert.ToInt64(_Transaction.CloseDayTrayID);
                    SelectedChargeTrayDescription = Convert.ToString(_Transaction.CloseDayTrayName);

                    if (_IsOpenForResend == false)
                    {
                        this._IsResendToInsType = _Transaction.SendToInsuranceFlag;
                    }



                    #region " Fee-Schedule "

                    if (_Transaction.FeeScheduleType == FeeScheduleType.UserSelected)
                    {
                        chkFeeSchedule.Checked = true;
                    }

                    if (_Transaction.FeeScheduleID > 0)
                    {
                        cmbFeeSchedule.SelectedValue = _Transaction.FeeScheduleID;
                        UC_gloBillingTransactionLines.FeeScheduleID = _Transaction.FeeScheduleID;
                    }

                    if (_Transaction.FacilityType == FacilityType.Facility)
                    {
                        chkFacilityFeeSchedule.Checked = true;
                        chkNonFacilityCharges.Checked = false;
                        UC_gloBillingTransactionLines.DefaultChargesType = FacilityType.Facility;
                    }
                    else if (_Transaction.FacilityType == FacilityType.NonFacility)
                    {
                        chkFacilityFeeSchedule.Checked = false;
                        chkNonFacilityCharges.Checked = true;
                        UC_gloBillingTransactionLines.DefaultChargesType = FacilityType.NonFacility;
                    }


                    #endregion " Fee-Schedule "

                    if (UC_gloBillingTransactionLines != null)
                    {
                        UC_gloBillingTransactionLines.SetFNFCharges();
                    }

                    if (UC_gloBillingTransactionLines.Fee_ScheduleID > 0)
                    {
                        _FeeScheduleID = UC_gloBillingTransactionLines.Fee_ScheduleID;
                        //cmbFeeSchedule.SelectedValue = _FeeScheduleID;
                    }


                    if (_Transaction.Lines != null)
                    {
                        if (_Transaction.Lines.Count > 0)
                        {
                            UC_gloBillingTransactionLines.SetLineTransaction(_Transaction.Lines);
                        }
                    }

                    SetDxList(_Transaction.TransactionMasterID, _Transaction.VisitID, _Transaction.ClaimNo, _Transaction.PatientID, _Transaction.ClinicID);


                    #region " Insurance Plan "
                    if (_Transaction.InsurancePlans != null)
                    {
                        c1Insurance.CellChanged -= new C1.Win.C1FlexGrid.RowColEventHandler(this.c1Insurance_CellChanged);


                        bool _IsFound = false;
                        for (int i = 0; i < _Transaction.InsurancePlans.Count; i++)
                        {
                            _IsFound = false;
                            for (int j = 1; j < c1Insurance.Rows.Count; j++)
                            {
                                if (Convert.ToInt64(c1Insurance.GetData(j, COL_INSURANCEID)) == _Transaction.InsurancePlans[i].InsuranceID)
                                {
                                    _IsFound = true;
                                    c1Insurance.SetData(j, COL_INSURANCEPARTY, Convert.ToString(_Transaction.InsurancePlans[i].ResponsibilityNo));
                                    c1Insurance.SetData(j, COL_INSURANCERESPONSIBILITY, Convert.ToString(_Transaction.InsurancePlans[i].ResponsibilityNo));
                                    break;
                                }
                            }

                            #region "Add Insurance Plan if Inactivate"

                            if (_IsFound == false)
                            {
                                c1Insurance.Rows.Add();
                                int rowIndex = c1Insurance.Rows.Count - 1;
                                c1Insurance.SetData(rowIndex, COL_SELECT, false);//Select-CheckBox
                                //Select-CheckBox

                                c1Insurance.SetData(rowIndex, COL_INSURANCEID, _Transaction.InsurancePlans[i].InsuranceID); //=                                
                                c1Insurance.SetData(rowIndex, COL_INSSELFMODE, _Transaction.InsurancePlans[i].ResponsibilityType); //
                                if (_Transaction.InsurancePlans[i].ResponsibilityType == PayerMode.Self.GetHashCode())
                                { c1Insurance.SetData(rowIndex, COL_INSURANCENAME, PayerMode.Self.ToString()); }
                                else
                                { c1Insurance.SetData(rowIndex, COL_INSURANCENAME, _Transaction.InsurancePlans[i].InsuranceName); }
                                c1Insurance.SetData(rowIndex, COL_INSURANCETYPE, "Inactive");
                                c1Insurance.SetData(rowIndex, COL_INSURANCERESPONSIBILITY, Convert.ToString(_Transaction.InsurancePlans[i].ResponsibilityNo));
                                c1Insurance.SetData(rowIndex, COL_INSURANCEPARTY, Convert.ToString(_Transaction.InsurancePlans[i].ResponsibilityNo));
                                c1Insurance.SetData(rowIndex, COL_INSURANCECOPAYAMT, _Transaction.InsurancePlans[i].CopayAmount);
                                c1Insurance.SetData(rowIndex, COL_INSURANCEWORKERCOMP, _Transaction.InsurancePlans[i].IsWorkerComp);
                                c1Insurance.SetData(rowIndex, COL_INSURANCECONTACTID, _Transaction.InsurancePlans[i].ContactID); //
                            }

                            #endregion "Add Insurance Plan if Inactivate"

                        }
                        c1Insurance.CellChanged += new C1.Win.C1FlexGrid.RowColEventHandler(this.c1Insurance_CellChanged);
                        ReorderInsurance();
                    }
                    #endregion " Insurance Plan "


                    //To Remove the Previous Flag
                    for (int i = 0; i <= c1Insurance.Rows.Count - 1; i++)
                    {
                        c1Insurance.SetCellImage(i, COL_INSURANCERESPONSIBILITY, null);
                    }

                    //DataTable _dt = GetCurrentPartyNumber();
                    DataTable _dt = gloCharges.GetCurrentPartyNumber(_TransactionID, _MasterTransactionID);
                    if (_dt != null && _dt.Rows.Count > 0)
                    {

                        Int16 _party = -1;
                        _party = Convert.ToInt16(_dt.Rows[0]["PartyNo"]);
                        InsParty = Convert.ToInt16(_dt.Rows[0]["PartyNo"]);
                        nCurrentResponsibleParty = Convert.ToInt16(_dt.Rows[0]["PartyNo"]);
                        //c1Insurance.SetCellImage(_party, COL_INSURANCERESPONSIBILITY, null);
                        System.Drawing.Image imgFlag = global::gloBilling.Properties.Resources.Normal_Priority;
                        c1Insurance.SetCellImage(_party, COL_INSURANCERESPONSIBILITY, imgFlag);
                        c1Insurance.SetCellCheck(_party, COL_SELECT_CURRENT_RESPONSIBLE_PARTY, CheckEnum.Checked);

                        Int64 nContactID = 0;
                        Int64.TryParse(Convert.ToString(c1Insurance.GetData(_party, COL_INSURANCECONTACTID)), out nContactID);

                        Int64 nInsuranceID = 0;
                        Int64.TryParse(Convert.ToString(c1Insurance.GetData(_party, COL_INSURANCEID)), out nInsuranceID);

                        //if (gloAccountsV2.gloInsurancePaymentV2.IsRebilled(_MasterTransactionID, _TransactionID, nContactID, nInsuranceID))
                        //{
                        _sClaimRefNo = _Transaction.sClaimRefNo;
                        _IsbCliamReplacement = _Transaction.IsReplacementClaim;
                        //}
                    }



                }

                #region " Set the Renderring Provider "

                //****************************************************************************
                //Set the Patient Provider as the Renderring Provider
                //If Patient Provider not present set the selected Billing Provider from combo
                //as the Renderring Provider
                //****************************************************************************

                if (this.PatientPoviderID > 0)
                {
                    UC_gloBillingTransactionLines.DefaultRenderingProviderID = this.PatientPoviderID;
                    UC_gloBillingTransactionLines.DefaultRenderringProviderName = this.PatientProviderName;
                }
                else
                {
                    if (cmbBillingProvider != null && cmbBillingProvider.Items.Count > 0)
                    {
                        if (cmbBillingProvider.SelectedIndex != -1)
                        {
                            UC_gloBillingTransactionLines.DefaultRenderingProviderID = Convert.ToInt64(cmbBillingProvider.SelectedValue);
                            UC_gloBillingTransactionLines.DefaultRenderringProviderName = Convert.ToString(cmbBillingProvider.Text);
                        }
                    }
                }

                #endregion " Set the Renderring Provider "

                UC_gloBillingTransactionLines.onGrid_CellChanged += new gloBillingTransaction.onGridCellChanged(UC_gloBillingTransactionLines_onGrid_CellChanged);
                UC_gloBillingTransactionLines.onGrid_SelChanged += new gloBillingTransaction.onGridSelChanged(UC_gloBillingTransactionLines_onGrid_SelChanged);
                UC_gloBillingTransactionLines.onInsCPTDxMod_Changed += new gloBillingTransaction.onInsCPTDxModChanged(UC_gloBillingTransactionLines_onInsCPTDxMod_Changed);
                UC_gloBillingTransactionLines.show_LineNotes += new gloBillingTransaction.showLineNote(UC_gloBillingTransactionLines_show_LineNotes);                
                //UC_gloBillingTransactionLines.onCPTCharges_Load += new gloBillingTransaction.onCPTChargesLoaded(UC_gloBillingTransactionLines_onCPTCharges_Load);

                IsEditable(_Transaction);


                #region "Check For Payment Notes "

                CheckForPaymentNotes(_Transaction.Lines);

                #endregion

                #region " Set Line Primary Dx "

                if (UC_gloBillingTransactionLines.HasPrimaryDx(UC_gloBillingTransactionLines.CurrentTransactionLine) == true)
                {
                    int rowIndex = UC_gloBillingTransactionLines.CurrentTransactionLine;
                    string _primaryDxCode = UC_gloBillingTransactionLines.GetRowPrimaryDxCode(rowIndex);

                    if (_primaryDxCode != "")
                    {
                        if (c1Dx != null && c1Dx.Rows.Count > 0)
                        {
                            for (int i = 1; i <= c1Dx.Rows.Count - 1; i++)
                            {
                                if (Convert.ToString(c1Dx.GetData(i, COL_DX_CODE)) != "")
                                {
                                    if (Convert.ToString(c1Dx.GetData(i, COL_DX_CODE)).Trim() == _primaryDxCode.Trim())
                                    {
                                        c1Dx.SetCellCheck(i, COL_DX_ISPRIMARY, CheckEnum.Checked);
                                    }
                                    else
                                    {
                                        c1Dx.SetCellCheck(i, COL_DX_ISPRIMARY, CheckEnum.Unchecked);
                                    }
                                }
                            }
                        }
                    }

                }
                else
                {
                    //Uncheck all 
                    if (c1Dx != null && c1Dx.Rows.Count > 0)
                    {
                        for (int i = 1; i <= c1Dx.Rows.Count - 1; i++)
                        {
                            c1Dx.SetCellCheck(i, COL_DX_ISPRIMARY, CheckEnum.Unchecked);
                        }
                    }

                }

                #endregion " Set Line Primary Dx "

                CheckForPA();
                gloCharges.GetMasterTransactionID(_TransactionID, out _TransMasterID, out _nClaimNo, out _ModifyDate);
                gloAuditTrail.gloAuditTrail.CreateAuditLog(ActivityModule.Billing, ActivityCategory.SetupCharges, ActivityType.Modify, "Charges opened for modify", _Transaction.PatientID, _Transaction.TransactionID, _Transaction.ProviderID, ActivityOutCome.Success);
            }
            catch (Exception ex)
            {
                //ogloBilling.UpdateRecordStatus(_TransactionID, 0, false);
                Boolean _isReleased = gloCharges.ReleaseLockStatus(_MasterTransactionID);
                gloAuditTrail.gloAuditTrail.ExceptionLog(ex, true);
            }
            finally
            {
                if (ogloBilling != null)
                {
                    ogloBilling.Dispose();
                    ogloBilling = null;
                }
            }

        }

        public bool IsPartyChanged()
        {
            DataTable dt = null;
            bool _result = false;
            Int16 _CurrentParty = 0;
            try
            {
                //  dt = new DataTable();
                for (int iCount = 1; iCount <= c1Insurance.Rows.Count - 1; iCount++)
                {
                    if (c1Insurance.GetCellCheck(iCount, COL_SELECT_CURRENT_RESPONSIBLE_PARTY) == CheckEnum.Checked)
                    {
                        _CurrentParty = Convert.ToInt16(iCount);
                    }
                }

                dt = gloCharges.IsPartyChanged(_InitialTransaction.TransactionID);

                if (dt != null && dt.Rows.Count >= 1)
                {
                    if (Convert.ToString(dt.Rows[0]["nNextActionContactID"]).Trim() == Convert.ToString(c1Insurance.GetData(_CurrentParty, COL_INSURANCECONTACTID)).Trim() && Convert.ToString(dt.Rows[0]["nNextActionPatientInsID"]).Trim() == Convert.ToString(c1Insurance.GetData(_CurrentParty, COL_INSURANCEID)).Trim())
                    {
                        _result = false;

                    }
                    else
                    {
                        _result = true;
                    }
                }

            }
            catch (Exception ex)
            {
                gloAuditTrail.gloAuditTrail.ExceptionLog(ex, false);
                ex = null;
            }
            finally
            {
                if (dt != null)
                {
                    dt.Dispose();
                    dt = null;
                }
            }
            return _result;
        }

        public bool IsPartyChanged(bool forMasterClaim)
        {
            DataTable dt = null;
            bool _result = false;
            Int16 _CurrentParty = 0;
            try
            {
                //dt = new DataTable();
                for (int iCount = 1; iCount <= c1Insurance.Rows.Count - 1; iCount++)
                {
                    if (c1Insurance.GetCellCheck(iCount, COL_SELECT_CURRENT_RESPONSIBLE_PARTY) == CheckEnum.Checked)
                    {
                        _CurrentParty = Convert.ToInt16(iCount);
                        break;
                    }
                }

                dt = gloCharges.IsMasterClaimPartyChanged(_InitialTransaction.TransactionID);

                if (dt != null && dt.Rows.Count >= 1)
                {
                    if (Convert.ToString(dt.Rows[0]["nContactID"]).Trim() == Convert.ToString(c1Insurance.GetData(_CurrentParty, COL_INSURANCECONTACTID)).Trim())
                    {
                        _result = false;

                    }
                    else
                    {
                        _result = true;
                    }
                }

            }
            catch (Exception ex)
            {
                gloAuditTrail.gloAuditTrail.ExceptionLog(ex, false);
                ex = null;
            }
            finally
            {
                if (dt != null)
                {
                    dt.Dispose();
                    dt = null;
                }

            }
            return _result;
        }

        public void SetInsuranceParty()
        {
            gloBilling ogloBilling = new gloBilling(_DatabaseConnectionString, _emrdatabaseConnectionString);
            Transaction _Transaction = null;
            try
            {
                //Need to be Modified as whole transaction object is filling
                //only Insurance is needed.
                //_Transaction = ogloBilling.GetChargesDetails(_MasterTransactionID, _ClinicID);
                _Transaction = ogloBilling.GetChargesClaimDetails(_TransactionID, _ClinicID);
                //**

                #region " Insurance Plan "
                if (_Transaction.InsurancePlans != null)
                {
                    c1Insurance.CellChanged -= new C1.Win.C1FlexGrid.RowColEventHandler(this.c1Insurance_CellChanged);


                    bool _IsFound = false;
                    for (int i = 0; i < _Transaction.InsurancePlans.Count; i++)
                    {
                        _IsFound = false;
                        for (int j = 1; j < c1Insurance.Rows.Count; j++)
                        {
                            if (Convert.ToInt64(c1Insurance.GetData(j, COL_INSURANCEID)) == _Transaction.InsurancePlans[i].InsuranceID && Convert.ToInt64(c1Insurance.GetData(j, COL_INSURANCECONTACTID)) == _Transaction.InsurancePlans[i].ContactID)
                            {
                                _IsFound = true;
                                c1Insurance.SetData(j, COL_INSURANCEPARTY, Convert.ToString(_Transaction.InsurancePlans[i].ResponsibilityNo));
                                c1Insurance.SetData(j, COL_INSURANCERESPONSIBILITY, Convert.ToString(_Transaction.InsurancePlans[i].ResponsibilityNo));
                                break;
                            }
                        }

                        #region "Add Insurance Plan if Inactivate"

                        if (_IsFound == false)
                        {
                            c1Insurance.Rows.Add();
                            int rowIndex = c1Insurance.Rows.Count - 1;
                            c1Insurance.SetData(rowIndex, COL_SELECT, false);//Select-CheckBox
                            //Select-CheckBox

                            c1Insurance.SetData(rowIndex, COL_INSURANCEID, _Transaction.InsurancePlans[i].InsuranceID); //=                                
                            c1Insurance.SetData(rowIndex, COL_INSSELFMODE, _Transaction.InsurancePlans[i].ResponsibilityType); //
                            if (_Transaction.InsurancePlans[i].ResponsibilityType == PayerMode.Self.GetHashCode())
                            { c1Insurance.SetData(rowIndex, COL_INSURANCENAME, PayerMode.Self.ToString()); }
                            else
                            { c1Insurance.SetData(rowIndex, COL_INSURANCENAME, _Transaction.InsurancePlans[i].InsuranceName); }
                            if (_Transaction.InsurancePlans[i].ResponsibilityType != PayerMode.BadDebt.GetHashCode())
                            {
                                c1Insurance.SetData(rowIndex, COL_INSURANCETYPE, "Inactive");
                            }
                            else
                            {
                                string collectionAgency = "";
                                collectionAgency = ogloBilling.GetCollectionAgencyname(_Transaction.InsurancePlans[i].ContactID);
                                c1Insurance.SetData(rowIndex, COL_INSURANCENAME, collectionAgency);
                            }
                            c1Insurance.SetData(rowIndex, COL_INSURANCERESPONSIBILITY, Convert.ToString(_Transaction.InsurancePlans[i].ResponsibilityNo));
                            c1Insurance.SetData(rowIndex, COL_INSURANCEPARTY, Convert.ToString(_Transaction.InsurancePlans[i].ResponsibilityNo));
                            c1Insurance.SetData(rowIndex, COL_INSURANCECOPAYAMT, _Transaction.InsurancePlans[i].CopayAmount);
                            c1Insurance.SetData(rowIndex, COL_INSURANCEWORKERCOMP, _Transaction.InsurancePlans[i].IsWorkerComp);
                            c1Insurance.SetData(rowIndex, COL_INSURANCECONTACTID, _Transaction.InsurancePlans[i].ContactID); //
                        }

                        #endregion "Add Insurance Plan if Inactivate"

                    }
                    c1Insurance.CellChanged += new C1.Win.C1FlexGrid.RowColEventHandler(this.c1Insurance_CellChanged);
                    ReorderInsurance();
                }
                #endregion " Insurance Plan "
            }
            catch (Exception ex)
            {
                gloAuditTrail.gloAuditTrail.ExceptionLog(ex, false);
                //ex.ToString();
                //ex = null;
            }
            finally
            {

                ogloBilling.Dispose();
            }
        }

        public void SetInsuranceParty_PAF()
        {
            gloBilling ogloBilling = new gloBilling(_DatabaseConnectionString, _emrdatabaseConnectionString);
            Transaction _Transaction = null;
            try
            {
                // _Transaction = ogloBilling.GetChargesDetails(_MasterTransactionID, _ClinicID);


                #region " Insurance Plan "
                if (_Transaction.InsurancePlans != null)
                {
                    c1Insurance.CellChanged -= new C1.Win.C1FlexGrid.RowColEventHandler(this.c1Insurance_CellChanged);


                    bool _IsFound = false;
                    for (int i = 0; i < _Transaction.InsurancePlans.Count; i++)
                    {
                        _IsFound = false;
                        for (int j = 1; j < c1Insurance.Rows.Count; j++)
                        {
                            if (Convert.ToInt64(c1Insurance.GetData(j, COL_INSURANCEID)) == _Transaction.InsurancePlans[i].InsuranceID)
                            {
                                _IsFound = true;
                                c1Insurance.SetData(j, COL_INSURANCEPARTY, Convert.ToString(_Transaction.InsurancePlans[i].ResponsibilityNo));
                                c1Insurance.SetData(j, COL_INSURANCERESPONSIBILITY, Convert.ToString(_Transaction.InsurancePlans[i].ResponsibilityNo));
                                break;
                            }
                        }

                        #region "Add Insurance Plan if Inactivate"

                        if (_IsFound == false)
                        {
                            c1Insurance.Rows.Add();
                            int rowIndex = c1Insurance.Rows.Count - 1;
                            c1Insurance.SetData(rowIndex, COL_SELECT, false);//Select-CheckBox
                            //Select-CheckBox

                            c1Insurance.SetData(rowIndex, COL_INSURANCEID, _Transaction.InsurancePlans[i].InsuranceID); //=                                
                            c1Insurance.SetData(rowIndex, COL_INSSELFMODE, _Transaction.InsurancePlans[i].ResponsibilityType); //
                            if (_Transaction.InsurancePlans[i].ResponsibilityType == PayerMode.Self.GetHashCode())
                            { c1Insurance.SetData(rowIndex, COL_INSURANCENAME, PayerMode.Self.ToString()); }
                            else
                            { c1Insurance.SetData(rowIndex, COL_INSURANCENAME, _Transaction.InsurancePlans[i].InsuranceName); }
                            c1Insurance.SetData(rowIndex, COL_INSURANCETYPE, "Inactive");
                            c1Insurance.SetData(rowIndex, COL_INSURANCERESPONSIBILITY, Convert.ToString(_Transaction.InsurancePlans[i].ResponsibilityNo));
                            c1Insurance.SetData(rowIndex, COL_INSURANCEPARTY, Convert.ToString(_Transaction.InsurancePlans[i].ResponsibilityNo));
                            c1Insurance.SetData(rowIndex, COL_INSURANCECOPAYAMT, _Transaction.InsurancePlans[i].CopayAmount);
                            c1Insurance.SetData(rowIndex, COL_INSURANCEWORKERCOMP, _Transaction.InsurancePlans[i].IsWorkerComp);
                            c1Insurance.SetData(rowIndex, COL_INSURANCECONTACTID, _Transaction.InsurancePlans[i].ContactID); //
                        }

                        #endregion "Add Insurance Plan if Inactivate"

                    }
                    c1Insurance.CellChanged += new C1.Win.C1FlexGrid.RowColEventHandler(this.c1Insurance_CellChanged);
                    ReorderInsurance();
                }
                #endregion " Insurance Plan "
            }
            catch (Exception ex)
            {
                gloAuditTrail.gloAuditTrail.ExceptionLog(ex, false);
                //ex.ToString();
                //ex = null;
            }
            finally
            {
                if (ogloBilling != null)
                    ogloBilling.Dispose();
            }
        }

        public void OpenTransactionViewMode()
        {
            gloBilling ogloBilling = new gloBilling(_DatabaseConnectionString, _emrdatabaseConnectionString);
            Transaction _Transaction = null;

            try
            {

                UC_gloBillingTransactionLines = new gloBillingTransaction();
                UC_gloBillingTransactionLines.AutoSort = false;
                UC_gloBillingTransactionLines.InitialNofRows = 1;
                UC_gloBillingTransactionLines.IsOpenForModify = true;
                pnlTransactionLines.Controls.Add(UC_gloBillingTransactionLines);
                UC_gloBillingTransactionLines.Visible = true;
                UC_gloBillingTransactionLines.Dock = DockStyle.Fill;
                UC_gloBillingTransactionLines.PatientID = this.PatientID;
                UC_gloBillingTransactionLines.DefaultTOSID = _DefaultTOSID;
                UC_gloBillingTransactionLines.DefaultPOSID = _DefaultPOSID;
                UC_gloBillingTransactionLines.PatientProviderID = _PatientPoviderID;

                _Transaction = ogloBilling.GetChargesClaimDetails(_TransactionID, _ClinicID);
                if (_Transaction.Hold != null)
                {
                    _oClaimHold = _Transaction.Hold;
                }
                else
                {
                    _oClaimHold = new ClaimHold();
                }


                if (_Transaction.ClaimBox19Note != null)
                {
                    _oBox19Note = _Transaction.ClaimBox19Note;
                    _oBox19Notes.Add(_oBox19Note);
                }
                else
                {
                    _oBox19Note = new ClaimBox19Note();
                }

                _IllnessDate = _Transaction.IllnessDate;
                _LastSeenDate = _Transaction.LastSeenDate;
                _UnableToWorkFromDate_MoreClaimData = _Transaction.UnableToWorkFromDate;
                _UnableToWorkTillDate_MoreClaimData = _Transaction.UnableToWorkTillDate;

                bIsRefProvAsSupervisor = _Transaction.bIsRefprovAsSupervisor;
                bIsSupProvSavedForExClaims = _Transaction.bIsRefprovAsSupervisor;

                //Added by Subashish_b on 10/Feb /2011 (integration made on date-10/May/2011) for  changing the contolname( gloStripControl.FormName.Billing )
                oPatientControl.FillDetails(_TransPatientID, gloStripControl.FormName.Billing, _PatientPoviderID, false);
                this.PatientID = _Transaction.PatientID;


                //To Preserve the object
                if (_InitialTransaction != null)
                {
                    _InitialTransaction.Dispose();
                    _InitialTransaction = null;
                }
                _InitialTransaction = _Transaction;

                _MasterTransactionID = Convert.ToInt64(_Transaction.TransactionMasterID);


                _dtEOBPayments = gloBilling.GetEOBPaymentsV2(_MasterTransactionID);
                _dtEOBNextAction = gloBilling.GetEOBNextAction(_MasterTransactionID);

                FillClaim(this.PatientID);

                if (_Transaction != null)
                {
                    txtClaimNo.Text = _Transaction.ClaimNumber;

                    sClaimNo = gloCharges.FormattedClaimNumberGeneration(Convert.ToString(_Transaction.ClaimNo));
                    txtClaimNo.Tag = _Transaction.SubClaimNo;
                    cmbFacility.Text = Convert.ToString(_Transaction.FacilityCode);
                    if (cmbFacility.SelectedIndex != -1)
                    {
                        UC_gloBillingTransactionLines.FacilityID = Convert.ToInt64(cmbFacility.SelectedValue);
                        SetFacility();
                    }

                    cmbBillingProvider.SelectedValue = _Transaction.ProviderID;

                    mskClaimDate.Text = gloDateMaster.gloDate.DateAsDate(_Transaction.TransactionDate).ToString("MM/dd/yyyy");

                    txtPriorAuthorizationNo.Tag = Convert.ToInt64(_Transaction.PriorAuthorizationID);
                    txtPriorAuthorizationNo.Text = Convert.ToString(_Transaction.PriorAuthorizationNo);

                    if (_Transaction.OnsiteDate > 0)
                    {
                        mskOnsiteDate.Text = gloDateMaster.gloDate.DateAsDate(_Transaction.OnsiteDate).ToString("MM/dd/yyyy");
                    }
                    else
                    {
                        mskOnsiteDate.Text = "";
                    }



                    if (_Transaction.WorkersComp == true)
                    {
                        _WorkerCompType = "WorkersComp";

                        CmbAccidentType.Text = "Work";
                        CmbAccidentType.SelectedIndex = (int)AccidentType.Work;
                        cmbClaimNo.SelectedIndex = cmbClaimNo.FindStringExact(_Transaction.WorkersCompNo);
                        _WorkerCompNo = Convert.ToString(_Transaction.WorkersCompNo);

                        if (_Transaction.InjuryDate > 0)
                        {
                            mskInjuryDate.Text = gloDateMaster.gloDate.DateAsDate(_Transaction.InjuryDate).ToString("MM/dd/yyyy");
                            _WorkerInjuryDate = gloDateMaster.gloDate.DateAsDate(_Transaction.InjuryDate).ToString("MM/dd/yyyy");
                        }
                        else
                        {
                            mskInjuryDate.Text = "";
                            _WorkerInjuryDate = "";
                        }
                    }
                    if (_Transaction.AutoClaim == true)
                    {
                        _WorkerCompType = "AutoClaim";
                        CmbAccidentType.Text = "Auto";
                        CmbAccidentType.SelectedIndex = (int)AccidentType.Auto;
                        _AutoClaimNo = Convert.ToString(_Transaction.WorkersCompNo);
                        if (_Transaction.AccidentDate > 0)
                        {
                            mskAccidentDate.Text = gloDateMaster.gloDate.DateAsDate(_Transaction.AccidentDate).ToString("MM/dd/yyyy");
                            _AccidentDate = gloDateMaster.gloDate.DateAsDate(_Transaction.AccidentDate).ToString("MM/dd/yyyy");
                        }
                        else
                        {
                            mskAccidentDate.Text = "";
                            _AccidentDate = "";
                        }
                    }
                    if (_Transaction.OtherAccident == true)
                    {
                        _WorkerCompType = "OtherAccident";
                        CmbAccidentType.Text = "Other";
                        CmbAccidentType.SelectedIndex = (int)AccidentType.Other;
                        _OtherAccidentNo = Convert.ToString(_Transaction.WorkersCompNo);
                        if (_Transaction.OtherAccidentDate > 0)
                        {
                            mskOtherDate.Text = gloDateMaster.gloDate.DateAsDate(_Transaction.OtherAccidentDate).ToString("MM/dd/yyyy");
                            _OtherDate = gloDateMaster.gloDate.DateAsDate(_Transaction.OtherAccidentDate).ToString("MM/dd/yyyy");
                        }
                        else
                        {
                            mskOtherDate.Text = "";
                            _OtherDate = "";

                        }
                    }

                    txt_WcAc.Text = Convert.ToString(_Transaction.WorkersCompNo);



                    //if (_Transaction.UnableToWorkFromDate > 0)
                    //{
                    //    mskUnableFromDate.Text = gloDateMaster.gloDate.DateAsDate(_Transaction.UnableToWorkFromDate).ToString("MM/dd/yyyy");
                    //}
                    //else
                    //{
                    //    mskUnableFromDate.Text = "";
                    //}

                    if (_Transaction.UnableToWorkFromDate > 0)
                    { _UnableToWorkFromDate_MoreClaimData = _Transaction.UnableToWorkFromDate; }
                    else
                    { mskUnableFromDate.Text = ""; _UnableToWorkFromDate_MoreClaimData = 0; }

                    //if (_Transaction.UnableToWorkTillDate > 0)
                    //{
                    //    mskUnableTillDate.Text = gloDateMaster.gloDate.DateAsDate(_Transaction.UnableToWorkTillDate).ToString("MM/dd/yyyy");
                    //}
                    //else
                    //{
                    //    mskUnableTillDate.Text = "";
                    //}

                    if (_Transaction.UnableToWorkTillDate > 0)
                    { _UnableToWorkFromDate_MoreClaimData = _Transaction.UnableToWorkTillDate; }
                    else
                    { mskUnableTillDate.Text = ""; _UnableToWorkFromDate_MoreClaimData = 0; }

                    if (_Transaction.HospitalizationDateFrom > 0)
                    {
                        mskHospitaliztionFrom.Text = gloDateMaster.gloDate.DateAsDate(_Transaction.HospitalizationDateFrom).ToString("MM/dd/yyyy");
                    }
                    else
                    {
                        mskHospitaliztionFrom.Text = "";
                    }

                    if (_Transaction.HospitalizationDateTo > 0)
                    {
                        mskHospitaliztionTo.Text = gloDateMaster.gloDate.DateAsDate(_Transaction.HospitalizationDateTo).ToString("MM/dd/yyyy");
                    }
                    else
                    {
                        mskHospitaliztionTo.Text = "";
                    }


                    chkOutSideLab.Checked = _Transaction.OutSideLab;
                    if (_Transaction.OutSideLabCharges > 0)
                    {
                        txtOutSideLabCharges.Text = _Transaction.OutSideLabCharges.ToString();
                    }

                    if (_Transaction.State != "")
                    {
                        int index = cmbState.FindStringExact(_Transaction.State);
                        if (index >= 0)
                        { cmbState.SelectedIndex = index; }
                    }



                    //Added By Debasish Das on 10th Jun 2010
                    if (_Transaction.IsSameAsBillingProvider)
                    {
                        chk_SameasBillingProvider.Checked = true;
                    }
                    else
                    {
                        chk_SameasBillingProvider.Checked = false;
                    }
                    //***

                    if (_Transaction.ReferalProviderID_New > 0)
                    {
                        cmbReferralProvider.SelectedValue = _Transaction.ReferalProviderID_New;
                    }
                    else
                    {
                        cmbReferralProvider.SelectedValue = 0;
                    }

                    if (cmbReferralProvider.SelectedIndex == -1)
                    {
                        AddCurrentSavedReferal(_Transaction.ReferalProviderID_New);
                    }
                    txtClaimLastStatus.Text = Convert.ToString(_Transaction.Transaction_Status.GetHashCode());
                    txtLastStatusId.Text = Convert.ToString(_Transaction.LastStatusId);
                    txtSendCounter.Text = Convert.ToString(_Transaction.SendCounter);
                    txtSendToRejection.Text = Convert.ToString(_Transaction.SendToRejection);

                    lblCloseDayTray.Text = Convert.ToString(_Transaction.CloseDayTrayName);
                    lblCloseDayTray.Tag = Convert.ToInt64(_Transaction.CloseDayTrayID);

                    SelectedChargeTrayID = Convert.ToInt64(_Transaction.CloseDayTrayID);
                    SelectedChargeTrayDescription = Convert.ToString(_Transaction.CloseDayTrayName);

                    if (_IsOpenForResend == false)
                    {
                        this._IsResendToInsType = _Transaction.SendToInsuranceFlag;
                    }



                    #region " Fee-Schedule "

                    if (_Transaction.FeeScheduleType == FeeScheduleType.UserSelected)
                    {
                        chkFeeSchedule.Checked = true;
                    }

                    if (_Transaction.FeeScheduleID > 0)
                    {
                        cmbFeeSchedule.SelectedValue = _Transaction.FeeScheduleID;
                        UC_gloBillingTransactionLines.FeeScheduleID = _Transaction.FeeScheduleID;
                    }

                    if (_Transaction.FacilityType == FacilityType.Facility)
                    {
                        chkFacilityFeeSchedule.Checked = true;
                        chkNonFacilityCharges.Checked = false;
                        UC_gloBillingTransactionLines.DefaultChargesType = FacilityType.Facility;
                    }
                    else if (_Transaction.FacilityType == FacilityType.NonFacility)
                    {
                        chkFacilityFeeSchedule.Checked = false;
                        chkNonFacilityCharges.Checked = true;
                        UC_gloBillingTransactionLines.DefaultChargesType = FacilityType.NonFacility;
                    }


                    #endregion " Fee-Schedule "

                    if (UC_gloBillingTransactionLines != null)
                    {
                        UC_gloBillingTransactionLines.SetFNFCharges();
                    }

                    if (UC_gloBillingTransactionLines.Fee_ScheduleID > 0)
                    {
                        _FeeScheduleID = UC_gloBillingTransactionLines.Fee_ScheduleID;
                        //cmbFeeSchedule.SelectedValue = _FeeScheduleID;
                    }


                    if (_Transaction.Lines != null)
                    {
                        if (_Transaction.Lines.Count > 0)
                        {
                            UC_gloBillingTransactionLines.SetLineTransaction(_Transaction.Lines);
                        }
                    }

                    SetDxList(_Transaction.TransactionMasterID, _Transaction.VisitID, _Transaction.ClaimNo, _Transaction.PatientID, _Transaction.ClinicID);


                    #region " Insurance Plan "
                    if (_Transaction.InsurancePlans != null)
                    {
                        c1Insurance.CellChanged -= new C1.Win.C1FlexGrid.RowColEventHandler(this.c1Insurance_CellChanged);


                        bool _IsFound = false;
                        for (int i = 0; i < _Transaction.InsurancePlans.Count; i++)
                        {
                            _IsFound = false;
                            for (int j = 1; j < c1Insurance.Rows.Count; j++)
                            {
                                if (Convert.ToInt64(c1Insurance.GetData(j, COL_INSURANCEID)) == _Transaction.InsurancePlans[i].InsuranceID)
                                {
                                    _IsFound = true;
                                    c1Insurance.SetData(j, COL_INSURANCEPARTY, Convert.ToString(_Transaction.InsurancePlans[i].ResponsibilityNo));
                                    c1Insurance.SetData(j, COL_INSURANCERESPONSIBILITY, Convert.ToString(_Transaction.InsurancePlans[i].ResponsibilityNo));
                                    break;
                                }
                            }

                            #region "Add Insurance Plan if Inactivate"

                            if (_IsFound == false)
                            {
                                c1Insurance.Rows.Add();
                                int rowIndex = c1Insurance.Rows.Count - 1;
                                c1Insurance.SetData(rowIndex, COL_SELECT, false);//Select-CheckBox
                                //Select-CheckBox

                                c1Insurance.SetData(rowIndex, COL_INSURANCEID, _Transaction.InsurancePlans[i].InsuranceID); //=                                
                                c1Insurance.SetData(rowIndex, COL_INSSELFMODE, _Transaction.InsurancePlans[i].ResponsibilityType); //
                                if (_Transaction.InsurancePlans[i].ResponsibilityType == PayerMode.Self.GetHashCode())
                                { c1Insurance.SetData(rowIndex, COL_INSURANCENAME, PayerMode.Self.ToString()); }
                                else
                                { c1Insurance.SetData(rowIndex, COL_INSURANCENAME, _Transaction.InsurancePlans[i].InsuranceName); }
                                c1Insurance.SetData(rowIndex, COL_INSURANCETYPE, "Inactive");
                                c1Insurance.SetData(rowIndex, COL_INSURANCERESPONSIBILITY, Convert.ToString(_Transaction.InsurancePlans[i].ResponsibilityNo));
                                c1Insurance.SetData(rowIndex, COL_INSURANCEPARTY, Convert.ToString(_Transaction.InsurancePlans[i].ResponsibilityNo));
                                c1Insurance.SetData(rowIndex, COL_INSURANCECOPAYAMT, _Transaction.InsurancePlans[i].CopayAmount);
                                c1Insurance.SetData(rowIndex, COL_INSURANCEWORKERCOMP, _Transaction.InsurancePlans[i].IsWorkerComp);
                                c1Insurance.SetData(rowIndex, COL_INSURANCECONTACTID, _Transaction.InsurancePlans[i].ContactID); //
                            }

                            #endregion "Add Insurance Plan if Inactivate"

                        }
                        c1Insurance.CellChanged += new C1.Win.C1FlexGrid.RowColEventHandler(this.c1Insurance_CellChanged);
                        ReorderInsurance();
                    }
                    #endregion " Insurance Plan "


                    //To Remove the Previous Flag
                    for (int i = 0; i <= c1Insurance.Rows.Count - 1; i++)
                    {
                        c1Insurance.SetCellImage(i, COL_INSURANCERESPONSIBILITY, null);
                    }

                    //DataTable _dt = GetCurrentPartyNumber();
                    DataTable _dt = gloCharges.GetCurrentPartyNumber(_TransactionID, _MasterTransactionID);
                    if (_dt != null && _dt.Rows.Count > 0)
                    {

                        Int16 _party = -1;
                        _party = Convert.ToInt16(_dt.Rows[0]["PartyNo"]);
                        InsParty = Convert.ToInt16(_dt.Rows[0]["PartyNo"]);
                        nCurrentResponsibleParty = Convert.ToInt16(_dt.Rows[0]["PartyNo"]);
                        //c1Insurance.SetCellImage(_party, COL_INSURANCERESPONSIBILITY, null);
                        System.Drawing.Image imgFlag = global::gloBilling.Properties.Resources.Normal_Priority;
                        c1Insurance.SetCellImage(_party, COL_INSURANCERESPONSIBILITY, imgFlag);
                        c1Insurance.SetCellCheck(_party, COL_SELECT_CURRENT_RESPONSIBLE_PARTY, CheckEnum.Checked);

                        Int64 nContactID = 0;
                        Int64.TryParse(Convert.ToString(c1Insurance.GetData(_party, COL_INSURANCECONTACTID)), out nContactID);

                        Int64 nInsuranceID = 0;
                        Int64.TryParse(Convert.ToString(c1Insurance.GetData(_party, COL_INSURANCEID)), out nInsuranceID);

                        //if (gloAccountsV2.gloInsurancePaymentV2.IsRebilled(_MasterTransactionID, _TransactionID, nContactID, nInsuranceID))
                        //{
                        _sClaimRefNo = _Transaction.sClaimRefNo;
                        _IsbCliamReplacement = _Transaction.IsReplacementClaim;
                        //}
                    }



                }

                #region " Set the Renderring Provider "

                //****************************************************************************
                //Set the Patient Provider as the Renderring Provider
                //If Patient Provider not present set the selected Billing Provider from combo
                //as the Renderring Provider
                //****************************************************************************

                if (this.PatientPoviderID > 0)
                {
                    UC_gloBillingTransactionLines.DefaultRenderingProviderID = this.PatientPoviderID;
                    UC_gloBillingTransactionLines.DefaultRenderringProviderName = this.PatientProviderName;
                }
                else
                {
                    if (cmbBillingProvider != null && cmbBillingProvider.Items.Count > 0)
                    {
                        if (cmbBillingProvider.SelectedIndex != -1)
                        {
                            UC_gloBillingTransactionLines.DefaultRenderingProviderID = Convert.ToInt64(cmbBillingProvider.SelectedValue);
                            UC_gloBillingTransactionLines.DefaultRenderringProviderName = Convert.ToString(cmbBillingProvider.Text);
                        }
                    }
                }

                #endregion " Set the Renderring Provider "

                UC_gloBillingTransactionLines.onGrid_CellChanged += new gloBillingTransaction.onGridCellChanged(UC_gloBillingTransactionLines_onGrid_CellChanged);
                UC_gloBillingTransactionLines.onGrid_SelChanged += new gloBillingTransaction.onGridSelChanged(UC_gloBillingTransactionLines_onGrid_SelChanged);
                UC_gloBillingTransactionLines.onInsCPTDxMod_Changed += new gloBillingTransaction.onInsCPTDxModChanged(UC_gloBillingTransactionLines_onInsCPTDxMod_Changed);
                UC_gloBillingTransactionLines.show_LineNotes += new gloBillingTransaction.showLineNote(UC_gloBillingTransactionLines_show_LineNotes);                
                //UC_gloBillingTransactionLines.onCPTCharges_Load += new gloBillingTransaction.onCPTChargesLoaded(UC_gloBillingTransactionLines_onCPTCharges_Load);

                IsEditable(_Transaction);


                #region "Check For Payment Notes "

                CheckForPaymentNotes(_Transaction.Lines);

                #endregion

                #region " Set Line Primary Dx "

                if (UC_gloBillingTransactionLines.HasPrimaryDx(UC_gloBillingTransactionLines.CurrentTransactionLine) == true)
                {
                    int rowIndex = UC_gloBillingTransactionLines.CurrentTransactionLine;
                    string _primaryDxCode = UC_gloBillingTransactionLines.GetRowPrimaryDxCode(rowIndex);

                    if (_primaryDxCode != "")
                    {
                        if (c1Dx != null && c1Dx.Rows.Count > 0)
                        {
                            for (int i = 1; i <= c1Dx.Rows.Count - 1; i++)
                            {
                                if (Convert.ToString(c1Dx.GetData(i, COL_DX_CODE)) != "")
                                {
                                    if (Convert.ToString(c1Dx.GetData(i, COL_DX_CODE)).Trim() == _primaryDxCode.Trim())
                                    {
                                        c1Dx.SetCellCheck(i, COL_DX_ISPRIMARY, CheckEnum.Checked);
                                    }
                                    else
                                    {
                                        c1Dx.SetCellCheck(i, COL_DX_ISPRIMARY, CheckEnum.Unchecked);
                                    }
                                }
                            }
                        }
                    }

                }
                else
                {
                    //Uncheck all 
                    if (c1Dx != null && c1Dx.Rows.Count > 0)
                    {
                        for (int i = 1; i <= c1Dx.Rows.Count - 1; i++)
                        {
                            c1Dx.SetCellCheck(i, COL_DX_ISPRIMARY, CheckEnum.Unchecked);
                        }
                    }

                }

                #endregion " Set Line Primary Dx "

                CheckForPA();


                #region  " Set Buttons "


                tlb_AddNotes.Visible = false;
                tls_btnValidateProcedure.Visible = false;
                tls_btnSaveNClose.Visible = false;
                DisableChargesEntry(true);
                UC_gloBillingTransactionLines.Enabled = false;
                pnlTransactionLines.Enabled = false;
                pnlTransactionOther1.Enabled = false;
                pnlTransactionOther2.Enabled = false;
                tls_btnAddLine.Enabled = false;
                tls_btnRemoveLine.Enabled = false;
                UC_gloBillingTransactionLines.LineAlteration = false;
                tls_btnVoidCharge.Enabled = false;
                tlb_AddNotes.Enabled = true;
                tsb_Resend.Enabled = false;
                tls_btnMoreChargeData.Enabled = false;
                tls_btnMoreClaimData.Enabled = false;
                tls_Anesthesia.Enabled = false;
                tlb_AddNotes.Visible = false;
                tls_btnValidateProcedure.Visible = false;
                tls_btnSaveNClose.Visible = false;
                tls_Hold.Enabled = false;
                tsbViewHistory.Enabled = false;
                cmbBillingProvider.Enabled = false;
                chk_SameasBillingProvider.Enabled = false;
                cmbReferralProvider.Enabled = false;
                cmbFacility.Enabled = false;

                btnSelectChargeTry.Enabled = false;
                //cmbClaimCategory.Enabled = false;
                btnAdd_PriorAuthorization.Enabled = false;
                btnRemove_PriorAuthorization.Enabled = false;
                mnuItem_Apply.Visible = false;
                c1Insurance.Enabled = false;
                c1Dx.Enabled = false;
                tls_SplitClaim.Enabled = false;
                tls_btnValidateProcedure.Enabled = false;

                #endregion

                gloAuditTrail.gloAuditTrail.CreateAuditLog(ActivityModule.Billing, ActivityCategory.SetupCharges, ActivityType.View, "Charges opened for View", _Transaction.PatientID, _Transaction.TransactionID, _Transaction.ProviderID, ActivityOutCome.Success);
                _TransAccountID = _Transaction.PAccountID;
            }
            catch (Exception ex)
            {
                gloAuditTrail.gloAuditTrail.ExceptionLog(ex, true);
            }
            finally
            {
                if (ogloBilling != null)
                {
                    ogloBilling.Dispose();
                    ogloBilling = null;
                }
            }

        }

        private void SetDxList(Int64 transactionId, Int64 visitId, Int64 claimno, Int64 patientId, Int64 clinicId)
        {
            DataTable dtDxList = null;
            TransactionLines oTransactionLines = null;// new TransactionLines();
            _arrDxCodes = new ArrayList();
            _arrValidDxCodes = new ArrayList();

            try
            {
                _isDxListLoading = true;

                dtDxList = gloCharges.GetTransactionDxList(transactionId, visitId, claimno, patientId, clinicId);

                if (dtDxList != null && dtDxList.Rows.Count > 0)
                {
                    //Get all the Transaction Lines in a Object 
                    oTransactionLines = UC_gloBillingTransactionLines.GetLineTransactions();

                    for (int dxListCounter = 0; dxListCounter < dtDxList.Rows.Count; dxListCounter++)
                    {
                        if (oTransactionLines != null && oTransactionLines.Count > 0)
                        {
                            for (int i = 0; i <= oTransactionLines.Count - 1; i++)
                            {
                                if (oTransactionLines[i].Dx1Code.Trim() != "" || oTransactionLines[i].Dx2Code.Trim() != "" || oTransactionLines[i].Dx3Code.Trim() != "" || oTransactionLines[i].Dx4Code.Trim() != "")
                                {
                                    //Filter the Dx from the TransactionLines According to the selected claim and bind it to the Dx Grid
                                    //If the TranasctionLines has and the Datatable has the same Dx then Bind it to the Dx Grid
                                    if (oTransactionLines[i].Dx1Code.Trim().ToString() == Convert.ToString(dtDxList.Rows[dxListCounter]["sDx1Code"]).Trim() || oTransactionLines[i].Dx2Code.Trim().ToString() == Convert.ToString(dtDxList.Rows[dxListCounter]["sDx1Code"]).Trim() || oTransactionLines[i].Dx3Code.Trim().ToString() == Convert.ToString(dtDxList.Rows[dxListCounter]["sDx1Code"]).Trim() || oTransactionLines[i].Dx4Code.Trim().ToString() == Convert.ToString(dtDxList.Rows[dxListCounter]["sDx1Code"]).Trim())
                                    {


                                        if (_arrValidDxCodes.Contains(Convert.ToString(dtDxList.Rows[dxListCounter]["sDx1Code"]).Trim()))
                                        {
                                        }
                                        else
                                        {
                                            c1Dx.Rows.Add();
                                            int rowIndex = c1Dx.Rows.Count - 1;
                                            c1Dx.SetData(rowIndex, COL_DX_CODE, Convert.ToString(dtDxList.Rows[dxListCounter]["sDx1Code"]));
                                            c1Dx.SetData(rowIndex, COL_DX_DESC, Convert.ToString(dtDxList.Rows[dxListCounter]["sDx1Description"]));
                                            if (Convert.ToBoolean(dtDxList.Rows[dxListCounter]["bIsClaimDx"]) == true)
                                            { c1Dx.SetCellCheck(rowIndex, COL_DX_SELECT, CheckEnum.Checked); }
                                            else
                                            { c1Dx.SetCellCheck(rowIndex, COL_DX_SELECT, CheckEnum.Unchecked); }

                                            c1Dx.SetCellCheck(rowIndex, COL_DX_ISPRIMARY, CheckEnum.Unchecked);

                                            _arrValidDxCodes.Add(Convert.ToString(dtDxList.Rows[dxListCounter]["sDx1Code"]).Trim());
                                        }

                                    }
                                    else
                                    {
                                        _arrDxCodes.Add(Convert.ToString(dtDxList.Rows[dxListCounter]["sDx1Code"]).Trim());
                                    }
                                }
                            }
                        }

                    }
                    if (oTransactionLines != null)
                    {
                        oTransactionLines.Clear();
                        oTransactionLines.Dispose();
                        oTransactionLines = null;
                    }
                    for (int dxListCounter = 0; dxListCounter < dtDxList.Rows.Count; dxListCounter++)
                    {
                        if (Convert.ToBoolean(dtDxList.Rows[dxListCounter]["bIsClaimDx"]) == true)
                        {
                            if (_arrValidDxCodes.Contains(Convert.ToString(dtDxList.Rows[dxListCounter]["sDx1Code"]).Trim()))
                            {
                                _arrValidDxCodes.Remove(Convert.ToString(dtDxList.Rows[dxListCounter]["sDx1Code"]).Trim());
                            }
                        }

                    }


                }

            }
            catch (Exception ex)
            {
                gloAuditTrail.gloAuditTrail.ExceptionLog(ex, false);
                //ex.ToString();
                //ex = null;
            }
            finally
            {
                _isDxListLoading = false;
            }
        }

        private Int64 GenerateClaimNumber()
        {
            gloDatabaseLayer.DBLayer oDB = new gloDatabaseLayer.DBLayer(_DatabaseConnectionString);
            string _sqlQuery = "";
            Object _Result = null;
            Int64 _GeneratedClaimNumber = 0;

            try
            {
                oDB.Connect(false);
                _sqlQuery = "SELECT ISNULL(MAX(nClaimNo),0) + 1 FROM BL_Transaction_MST WITH (NOLOCK) ";
                _Result = oDB.ExecuteScalar_Query(_sqlQuery);

                if (_Result != null)
                {
                    _GeneratedClaimNumber = Convert.ToInt64(_Result);
                }
            }
            catch (Exception ex)
            {
                gloAuditTrail.gloAuditTrail.ExceptionLog(ex, true);
                _GeneratedClaimNumber = 0;
            }
            finally
            {
                if (oDB.Connect(false))
                { oDB.Disconnect(); }

                if (oDB != null)
                { oDB.Dispose(); }

                if (_Result != null)
                { _Result = null; }
            }
            return _GeneratedClaimNumber;
        }

        private bool ValidateMasterTransaction()
        {
            bool _Result = true;
            int _addDays = 0;
            DataTable dtChargesBusCenter = null;
            DataTable dtAccBussinessCenter = null;
            DataTable dtBussinessCenterByRules = null;
            _addDays = gloAccountsV2.gloBillingCommonV2.GetFutureCloseDayDateSettings();
            try
            {
                //Added by Subashish_b on 10/Feb /2011 (integration made on date-10/May/2011) for  validating the patient id selection if PAF is TRue
                if (_IsPatientAccountFeature)
                {
                    if (oPatientControl.CmbSelectedPatientID == 0)
                    {
                        MessageBox.Show("Please select Patient name for the claim.  ", _messageBoxCaption, MessageBoxButtons.OK, MessageBoxIcon.Information);
                        _Result = false;
                    }
                }
                //End
                if (cmbFacility.SelectedIndex < 0)
                {
                    MessageBox.Show("Please select a facility.  ", _messageBoxCaption, MessageBoxButtons.OK, MessageBoxIcon.Information);
                    cmbFacility.Focus();
                    _Result = false;
                }
                else if (cmbBillingProvider.SelectedIndex < 0)
                {
                    MessageBox.Show("Please select a billing provider.  ", _messageBoxCaption, MessageBoxButtons.OK, MessageBoxIcon.Information);
                    cmbBillingProvider.Focus();
                    _Result = false;
                }
                else if (cmbState.Enabled == true)
                {
                    if (cmbState.SelectedIndex < 0 && CmbAccidentType.Text.Trim() == "Auto")
                    {
                        MessageBox.Show("Please select a state.  ", _messageBoxCaption, MessageBoxButtons.OK, MessageBoxIcon.Information);
                        cmbState.Focus();
                        _Result = false;
                    }
                }
                else if (chkOutSideLab.Checked == true)
                {
                    if (chkOutSideLab.Checked == true && (txtOutSideLabCharges.Text.Trim() == "" && Convert.ToDecimal(txtOutSideLabCharges.Text.Trim()) <= 0))
                    {
                        MessageBox.Show("Please enter the OutSide lab charges.  ", _messageBoxCaption, MessageBoxButtons.OK, MessageBoxIcon.Information);
                        txtOutSideLabCharges.Focus();
                        txtOutSideLabCharges.SelectAll();
                        _Result = false;
                    }
                }
                else if (mskClaimDate.MaskCompleted == false)
                {
                    MessageBox.Show("Please enter the close date.", _messageBoxCaption, MessageBoxButtons.OK, MessageBoxIcon.Information);
                    mskClaimDate.Focus();
                    mskClaimDate.Select();
                    _Result = false;
                }

                gloBilling ogloBilling = new gloBilling(_DatabaseConnectionString, "");
                if (_IsDayClosed == false)
                {
                    if (ogloBilling.IsDayClosed(Convert.ToDateTime(mskClaimDate.Text)) == true)
                    {
                        //MessageBox.Show("Selected closed date is being closed.Please select open date.", _messageBoxCaption, MessageBoxButtons.OK, MessageBoxIcon.Information);
                        //mskClaimDate.Select(); mskClaimDate.Focus();
                        //_Result = false;
                    }
                }
                ogloBilling.Dispose();

                if (_InitialTransaction.TransactionDate != gloDateMaster.gloDate.DateAsNumber(mskClaimDate.Text.Trim()))
                {

                    if (Convert.ToDateTime(mskClaimDate.Text.Trim()).Date > DateTime.Now.Date.AddDays(_addDays))
                    {
                        MessageBox.Show("Close date " + mskClaimDate.Text.Trim() + " is too far in the future.", _messageBoxCaption, MessageBoxButtons.OK, MessageBoxIcon.Warning);
                        mskClaimDate.Focus();
                        mskClaimDate.Select();
                        _Result = false;
                    }
                    else
                    {
                        if (Convert.ToDateTime(mskClaimDate.Text.Trim()).Date > DateTime.Now.Date)
                        {
                            DialogResult _dlgCloseDate = DialogResult.None;
                            _dlgCloseDate = MessageBox.Show("Close date " + mskClaimDate.Text.Trim() + " is in future. Are you sure you want to continue with save?", _messageBoxCaption, MessageBoxButtons.OKCancel, MessageBoxIcon.Warning);
                            if (_dlgCloseDate == DialogResult.Cancel)
                            {
                                if (!_IsDayClosed)
                                {
                                    mskClaimDate.Focus();
                                    mskClaimDate.Select();

                                }
                                _Result = false;
                            }
                        }
                    }
                }

                //if (cmbCloseDayTray == null || cmbCloseDayTray.Items.Count <= 0 || cmbCloseDayTray.SelectedIndex == -1 || cmbCloseDayTray.Text.Trim() == "")
                //{
                if (SelectedChargeTrayID == 0)
                {
                    MessageBox.Show("Please select charge tray. ", _messageBoxCaption, MessageBoxButtons.OK, MessageBoxIcon.Information);
                    btnSelectChargeTry.Focus();
                    _Result = false;
                }

                //5061
                String sMessageReferral = String.Empty;
                DialogResult _dlgReferral = DialogResult.None;

                if (cmbReferralProvider.Items.Count > 1 && chk_SameasBillingProvider.Checked == false && _Result)
                {

                    if (cmbReferralProvider.SelectedIndex == 0 && cmbReferralProvider.Text.Trim() == "")
                    {
                        if (bIsRefProvAsSupervisor)
                        {
                            sMessageReferral = "Supervising provider information may not be reported since no referring provider is selected on claim. Continue?";
                        }
                        else if (cmbReferralProvider.Items.Count > 2)
                        {
                            sMessageReferral = "Patient has multiple Referring Providers but none were selected." + Environment.NewLine + "Continue?";
                        }
                        else
                        {
                            sMessageReferral = "No Referring provider selected. Continue?";
                        }

                        _dlgReferral = MessageBox.Show(sMessageReferral, _messageBoxCaption, MessageBoxButtons.YesNo, MessageBoxIcon.Warning, MessageBoxDefaultButton.Button2);
                        if (_dlgReferral == DialogResult.No)
                        {
                            cmbReferralProvider.Focus();
                            _Result = false;
                            return _Result;
                        }


                    }
                }
                else
                {
                    if (bIsRefProvAsSupervisor && chk_SameasBillingProvider.Checked == false && _Result)
                    {
                        sMessageReferral = "Supervising provider information may not be reported since no referring provider is selected on claim. Continue?";
                        _dlgReferral = MessageBox.Show(sMessageReferral, _messageBoxCaption, MessageBoxButtons.YesNo, MessageBoxIcon.Warning, MessageBoxDefaultButton.Button2);
                        if (_dlgReferral == DialogResult.No)
                        {
                            cmbReferralProvider.Focus();
                            _Result = false;
                            return _Result;
                        }
                    }

                }

                //5061

                //Validate For Insurance -- Should not have more than 3 insurances
                if (c1Insurance.Rows.Count > 0)
                {
                    Int64 _PartyCount = 0;

                    for (int i = 1; i < c1Insurance.Rows.Count; i++)
                    {
                        if (c1Insurance.GetData(i, COL_INSURANCERESPONSIBILITY) != null && c1Insurance.GetData(i, COL_INSURANCERESPONSIBILITY).ToString().Trim().Length > 0)
                        {

                            Int16 _Party = 0;

                            if (Int16.TryParse(c1Insurance.GetData(i, COL_INSURANCERESPONSIBILITY).ToString(), out  _Party) == true)
                            {
                                if (Convert.ToString(c1Insurance.GetData(i, COL_INSURANCETYPE)) == InsuranceTypeFlag.Primary.ToString() || Convert.ToString(c1Insurance.GetData(i, COL_INSURANCETYPE)) == InsuranceTypeFlag.Secondary.ToString() || Convert.ToString(c1Insurance.GetData(i, COL_INSURANCETYPE)) == InsuranceTypeFlag.Tertiary.ToString() || Convert.ToString(c1Insurance.GetData(i, COL_INSURANCETYPE)) == "Inactive")
                                {
                                    if (_Party > 0)
                                    {
                                        _PartyCount++;
                                    }
                                }



                            }
                        }
                    }

                    if (_PartyCount > 3)
                    {


                        DialogResult _dlgInsurance = DialogResult.None;
                        _dlgInsurance = MessageBox.Show("Claim has " + _PartyCount + " Insurances. Claims may only have up to three Insurances.Claims with more Insurances will not bill.Continue? ", _messageBoxCaption, MessageBoxButtons.YesNo, MessageBoxIcon.Warning, MessageBoxDefaultButton.Button2);
                        if (_dlgInsurance == DialogResult.No)
                        {
                            _Result = false;
                        }
                    }
                }
                if (_nResponsibleParty != 0)
                {
                    if (!ValidateInsuranceCoverage())
                        return false;
                }
                if (_Result && !SavePAValidation())
                {
                    _Result = false;
                }

                dtChargesBusCenter = gloCharges.GetChargeBusinessCenterSettings();
                if (dtChargesBusCenter != null && dtChargesBusCenter.Rows.Count > 0)
                {
                    if (Convert.ToBoolean(dtChargesBusCenter.Rows[0]["businesscenter_feature"]) == true && Convert.ToBoolean(dtChargesBusCenter.Rows[0]["BusinessCenter_PatientAccount"]) == true)
                    {
                        dtAccBussinessCenter = gloCharges.GetPatientAccountBusinessCenter(nPAccountID);
                        Int64 nAccBusinessCenterID = 0;
                        string nAccBusinessCenterCode = "";
                        if (dtAccBussinessCenter != null && dtAccBussinessCenter.Rows.Count > 0)
                        {
                            nAccBusinessCenterID = Convert.ToInt64(dtAccBussinessCenter.Rows[0]["nBusinessCenterID"]);
                            nAccBusinessCenterCode = Convert.ToString(dtAccBussinessCenter.Rows[0]["sBusinessCenterCode"]);
                        }
                        if (nAccBusinessCenterID == 0)
                        {
                            if (Convert.ToBoolean(dtChargesBusCenter.Rows[0]["BusinessCenter_PatientAccount"]) == true)
                            {
                                MessageBox.Show("Patient Account has not been assigned to a Business Center.\nPlease assign a Business Center in Patient Demographics before saving charges.", _messageBoxCaption, MessageBoxButtons.OK, MessageBoxIcon.Information);
                                return false;
                            }
                        }

                        if (_InitialTransaction.ProviderID != Convert.ToInt64(cmbBillingProvider.SelectedValue) || _InitialTransaction.FacilityCode != Convert.ToString(cmbFacility.SelectedValue) || _InitialTransaction.PAccountID != nPAccountID)
                        {
                            dtBussinessCenterByRules = gloCharges.GetBusinessCenterByRules(Convert.ToInt64(cmbBillingProvider.SelectedValue), Convert.ToInt64(cmbFacility.SelectedValue));
                            if (dtBussinessCenterByRules != null & dtBussinessCenterByRules.Rows.Count > 0)
                            {
                                if (nAccBusinessCenterID != Convert.ToInt64(dtBussinessCenterByRules.Rows[0]["nBusinessCenterID"]))
                                {
                                    if (Convert.ToString(dtChargesBusCenter.Rows[0]["chargeEntryMismatch"]).ToLower() == "warn")
                                    {
                                        DialogResult _dlgBusinessCenter = DialogResult.None;
                                        _dlgBusinessCenter = MessageBox.Show("Warning : Charge Business Center is " + dtBussinessCenterByRules.Rows[0]["sBusinessCenterCode"] + " but Account Business Center is " + nAccBusinessCenterCode + ".  \nContinue Save?", _messageBoxCaption, MessageBoxButtons.YesNo, MessageBoxIcon.Warning, MessageBoxDefaultButton.Button2);
                                        if (_dlgBusinessCenter == DialogResult.No)
                                        {
                                            return false;
                                        }
                                    }
                                }
                            }
                            else
                            {
                                DialogResult _dlgChargeBusinessCenter = DialogResult.None;
                                _dlgChargeBusinessCenter = MessageBox.Show("The system could not verify this claim has been posted to the correct business center.   Administration Business Center rules do not mention this claims provider or facility.", _messageBoxCaption, MessageBoxButtons.OKCancel, MessageBoxIcon.Warning, MessageBoxDefaultButton.Button2);
                                if (_dlgChargeBusinessCenter == DialogResult.Cancel)
                                {
                                    return false;
                                }
                            }
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                gloAuditTrail.gloAuditTrail.ExceptionLog(ex, true);
                _Result = false;
            }
            finally
            {
                if (dtBussinessCenterByRules != null)
                {
                    dtBussinessCenterByRules.Dispose();
                }
                if (dtAccBussinessCenter != null)
                {
                    dtAccBussinessCenter.Dispose();
                }
                if (dtChargesBusCenter != null)
                {
                    dtChargesBusCenter.Dispose();
                }
            }
            return _Result;
        }

        private bool SavePAValidation()
        {

            Int64 _visitsAllowed = 0;
            //   Int64 _visitsRequired = 0;
            Int64 _visitsUsed = 0;
            //  Int64 _visitsRemaining = 0;
            Int64 _visitsUsedTotal = 0;
            Int64 _expDate = 0;
            Int64 _startDate = 0;
            Int64 _endDate = 0;
            bool _trackLimit = false;

            DataTable _dtDates = new DataTable();
            Int64 _VisitsCount = 0;
            Int64 _visitsUsedTotalForExceed = 0;

            try
            {
                if (_isRemoved && txtPriorAuthorizationNo.Tag == null)
                {
                    TransactionLines oTransactionLines = UC_gloBillingTransactionLines.GetLineTransactions();
                    Int64 _paID = Convert.ToInt64(_InitialTransaction.PriorAuthorizationID);
                    DataTable _dtLines = new DataTable();
                    _dtLines.Columns.Add("DateUsed");
                    DataTable _dtUniqueDates = new DataTable();
                    _dtUniqueDates = null;
                    if (oTransactionLines != null)
                    {
                        //DataTable _dtUniqueDates = new DataTable();
                        _dtUniqueDates = gloPMGeneral.gloPriorAuthorization.clsgloPriorAuthorization.GetUniqueDatesVoidClaim(_paID, (gloDateMaster.gloDate.DateAsNumber(Convert.ToString(DateTime.Now.Date))), _InitialTransaction.TransactionMasterID);
                    }
                    if (_dtUniqueDates != null && _dtUniqueDates.Rows.Count > 0)
                    { //Entry in Database.
                        if (MessageBox.Show("Prior authorization " + PriorAuthNo + " will use -" + _dtUniqueDates.Rows.Count + " visits.\nContinue?", _messageBoxCaption, MessageBoxButtons.YesNo, MessageBoxIcon.Warning, MessageBoxDefaultButton.Button2) == DialogResult.No)
                        { return false; }
                    }
                }

                if (txtPriorAuthorizationNo.Tag != null && Convert.ToString(txtPriorAuthorizationNo.Tag) != "")
                {

                    Int64 _paID = Convert.ToInt64(txtPriorAuthorizationNo.Tag);
                    DataRow _drPAInfo = gloPMGeneral.gloPriorAuthorization.clsgloPriorAuthorization.GetPriorAuthorizationInfo(_paID);

                    if (_drPAInfo != null)
                    {
                        if (Convert.ToString(_drPAInfo["nAuthorizationType"]).Trim() != "2")
                        {
                            #region "Grid Unique Dates"

                            TransactionLines oTransactionLines = UC_gloBillingTransactionLines.GetLineTransactions();
                            _dtDates = gloPMGeneral.gloPriorAuthorization.clsgloPriorAuthorization.GetUniqueDates(_paID, UC_gloBillingTransactionLines.GetLastMaxDOS());
                            if (_dtDates != null && _dtDates.Rows.Count > 0 && oTransactionLines != null)
                            {

                                for (int _GridRow = 0; _GridRow < oTransactionLines.Count; _GridRow++)
                                {
                                    _dtDates.DefaultView.RowFilter = "DateUsed=" + gloDateMaster.gloDate.DateAsNumber(oTransactionLines[_GridRow].DateServiceFrom.ToShortDateString());
                                    if (_dtDates.DefaultView.Count.Equals(0))
                                    {
                                        DataRow rw = _dtDates.NewRow();
                                        if (Convert.ToString(oTransactionLines[_GridRow].DateServiceFrom).Trim() != "")
                                        {
                                            rw["DateUsed"] = gloDateMaster.gloDate.DateAsNumber(oTransactionLines[_GridRow].DateServiceFrom.ToShortDateString());
                                            _dtDates.Rows.Add(rw);
                                            _dtDates.AcceptChanges();
                                            _VisitsCount++;
                                        }
                                        rw = null;
                                    }
                                    _dtDates.DefaultView.RowFilter = "";

                                }

                            }
                            if (_dtDates != null && _dtDates.Rows.Count > 0)
                            { //Entry in Database.
                                _visitsUsedTotalForExceed = _dtDates.Rows.Count;
                                _visitsUsedTotal = _VisitsCount;
                            }
                            else if (oTransactionLines != null && (oTransactionLines.Count > 0))
                            { //If no entry in Database.
                                DataTable _dtLines = new DataTable();
                                _dtLines.Columns.Add("DateUsed");
                                for (int _GridRow = 0; _GridRow < oTransactionLines.Count; _GridRow++)
                                {
                                    _dtLines.DefaultView.RowFilter = "DateUsed=" + gloDateMaster.gloDate.DateAsNumber(oTransactionLines[_GridRow].DateServiceFrom.ToShortDateString());
                                    if (_dtLines.DefaultView.Count.Equals(0))
                                    {
                                        DataRow rw = _dtLines.NewRow();
                                        if (Convert.ToString(oTransactionLines[_GridRow].DateServiceFrom).Trim() != "")
                                        {
                                            rw["DateUsed"] = gloDateMaster.gloDate.DateAsNumber(oTransactionLines[_GridRow].DateServiceFrom.ToShortDateString());
                                            _dtLines.Rows.Add(rw);
                                            _dtLines.AcceptChanges();
                                        }
                                        rw = null;
                                    }
                                    _dtLines.DefaultView.RowFilter = "";

                                }
                                if (_dtLines != null && _dtLines.Rows.Count > 0)
                                {
                                    _visitsUsedTotal = _dtLines.Rows.Count;
                                    _visitsUsedTotalForExceed = _dtLines.Rows.Count;
                                }
                            }
                            #endregion
                            if (_drPAInfo != null)
                            {
                                _trackLimit = Convert.ToBoolean(_drPAInfo["bIsTrackAuthLimit"]);
                                if (_trackLimit)
                                {
                                    if (c1Insurance.Rows.Count > 1)
                                    {
                                        //If Claim has no insurances but has Prior Auth Show Message
                                        if (c1Insurance.GetData(1, COL_INSURANCENAME).ToString() == PayerMode.Self.ToString())
                                        {
                                            if (MessageBox.Show("Mismatch  Claim has no insurance but has a prior authorization.\nContinue? ", _messageBoxCaption, MessageBoxButtons.YesNo, MessageBoxIcon.Warning, MessageBoxDefaultButton.Button2) == DialogResult.No)
                                            { return false; }

                                        }

                                        //if (_HasInsurance)
                                        //{
                                        //    if (MessageBox.Show("Mismatch  Claim has no insurance but has a prior authorization.\nContinue? ", _messageBoxCaption, MessageBoxButtons.YesNo, MessageBoxIcon.Warning, MessageBoxDefaultButton.Button2) == DialogResult.No)
                                        //    { return false; }
                                        //    else
                                        //    { _isMismatch = true; }
                                        //}
                                    }
                                }
                                if (_trackLimit)
                                {
                                    //If Prior Auth is Limit tracking and Prior Authorization does not have a selected Patient Insurance 
                                    //Claim has a primary insurance then do not allow the save
                                    if (Convert.ToInt64(_drPAInfo["InsuranceID"].ToString()) == 0)
                                    {
                                        if (c1Insurance.Rows.Count > 1)
                                        {
                                            if (c1Insurance.GetData(1, COL_INSURANCENAME).ToString() != PayerMode.Self.ToString())
                                            {
                                                MessageBox.Show("Prior authorization " + _drPAInfo["sPriorAuthorizationNo"] + " requires a patients insurance.\nPlease review the prior authorization before saving charges.", _messageBoxCaption, MessageBoxButtons.OK, MessageBoxIcon.Information);
                                                return false;
                                            }
                                        }
                                    }

                                    //If the Prior Authorization has a selected Patient insurance 
                                    //but that insurance does not match any of the claim insurances (by internal ID) 
                                    //then restrict the save:
                                    if (c1Insurance.Rows.Count > 1)
                                    {
                                        bool _isAuthInMatching = false;

                                        //Check if Prior Auth Insurance is present on the claim
                                        for (int i = 1; i <= c1Insurance.Rows.Count - 1; i++)
                                        {
                                            if (c1Insurance.GetData(i, COL_INSURANCENAME).ToString() != PayerMode.Self.ToString())
                                            {
                                                if (c1Insurance.GetData(i, COL_INSURANCEID).ToString() == _drPAInfo["InsuranceID"].ToString())
                                                {
                                                    if (Convert.ToInt64(_drPAInfo["InsuranceID"].ToString()) != 0)
                                                    {
                                                        _isAuthInMatching = true;
                                                        break;
                                                    }
                                                }
                                            }
                                            else
                                            {
                                                break;
                                            }

                                        }

                                        if (_isAuthInMatching == false)
                                        {
                                            MessageBox.Show("Mismatch  Claims insurance and prior authorizations insurance do not match.\nPlease review.", _messageBoxCaption, MessageBoxButtons.OK, MessageBoxIcon.Information);
                                            return false;
                                        }

                                    }
                                }
                            }

                            if (_drPAInfo != null)
                            {
                                _visitsAllowed = Convert.ToInt64(_drPAInfo["nVisitsAllowed"]);
                                _trackLimit = Convert.ToBoolean(_drPAInfo["bIsTrackAuthLimit"]);
                                if (_drPAInfo["nExpDate"] == DBNull.Value)
                                    _expDate = 0;
                                else
                                    _expDate = Convert.ToInt64(_drPAInfo["nExpDate"]);
                                //_visitsUsedTotal = Convert.ToInt64(_drPAInfo["nExpDate"]);
                            }
                            _startDate = (UC_gloBillingTransactionLines.GetLastMaxDOS());
                            _endDate = (UC_gloBillingTransactionLines.GetLastMaxDOS());

                            //if (gloPMGeneral.gloPriorAuthorization.clsgloPriorAuthorization.GetVisitsUsed(_paID, _startDate, _endDate) <= 0)
                            //{ _visitsRequired += 1; }
                            _visitsUsed = gloPMGeneral.gloPriorAuthorization.clsgloPriorAuthorization.GetVisitsUsed(_paID);
                            //_visitsRemaining = gloPMGeneral.gloPriorAuthorization.clsgloPriorAuthorization.GetVisitsRemaining(_paID, _endDate, false) - _visitsRequired;
                            //_visitsUsedTotal = _visitsUsed + 1;
                            if (_expDate != 0 && _expDate < _endDate)
                            {
                                if (MessageBox.Show("Prior Authorization " + Convert.ToString(txtPriorAuthorizationNo.Text) + " has expired.\nPrior authorization is valid only until " + gloDateMaster.gloDate.DateAsDateString(Convert.ToInt64(_drPAInfo["nExpDate"])) + ".\nContinue? ", _messageBoxCaption, MessageBoxButtons.YesNo, MessageBoxIcon.Warning, MessageBoxDefaultButton.Button2) == DialogResult.No)
                                { return false; }
                            }
                            if (_trackLimit)
                            {
                                if (_visitsAllowed != 0)
                                {
                                    if ((_visitsAllowed - _visitsUsedTotalForExceed) < 0)
                                    {
                                        if (MessageBox.Show("Prior authorization " + Convert.ToString(txtPriorAuthorizationNo.Text) + " has exceeded its # visits allowed.\nContinue? ", _messageBoxCaption, MessageBoxButtons.YesNo, MessageBoxIcon.Warning, MessageBoxDefaultButton.Button2) == DialogResult.No)
                                        { return false; }
                                    }
                                    else
                                    {
                                        string _visit = "visit";
                                        if (_visitsUsedTotal > 1) { _visit = _visit + "s"; }

                                        if (!_visitsAllowed.Equals(0) && _visitsUsedTotal != 0)
                                        {
                                            if (MessageBox.Show("Prior authorization " + Convert.ToString(txtPriorAuthorizationNo.Text) + " will use "
                                                + _visitsUsedTotal + " " + _visit + ".\nContinue? ", _messageBoxCaption, MessageBoxButtons.YesNo, MessageBoxIcon.Warning, MessageBoxDefaultButton.Button2) == DialogResult.No)
                                            { return false; }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            }
            catch (Exception ex)
            { gloAuditTrail.gloAuditTrail.ExceptionLog(ex, false); }
            return true;
        }

        private void SetCloseDate()
        {
            try
            {
                #region " Set last selected close date "

                //....Load last selected close date
                //...If the last selected close date is being closed then make the close date empty.

                gloSettings.GeneralSettings oSettings = new gloSettings.GeneralSettings(_DatabaseConnectionString);
                Object _retValue = null;
                string _clsDate = "";
                oSettings.GetSetting("CHARGES_LASTCLOSEDATE", _UserID, _ClinicID, out _retValue);
                oSettings.Dispose();

                if (_retValue != null && Convert.ToString(_retValue).Trim() != "")
                {
                    try
                    { _clsDate = Convert.ToDateTime(Convert.ToString(_retValue).Trim()).ToString("MM/dd/yyyy"); }
                    catch (Exception)// ex)
                    {
                        _clsDate = DateTime.Now.Date.ToString("MM/dd/yyyy");
                        //ex.ToString();
                        //ex = null;
                    }
                }
                else
                { _clsDate = DateTime.Now.Date.ToString("MM/dd/yyyy"); }

                if (_clsDate.Trim() != "")
                {
                    gloBilling ogloBilling = new gloBilling(_DatabaseConnectionString, "");
                    if (ogloBilling.IsDayClosed(Convert.ToDateTime(_clsDate.Trim())) == true)
                    { _clsDate = ""; }
                    ogloBilling.Dispose();
                }

                mskClaimDate.Text = _clsDate;

                #endregion " Set last selected close date "
            }
            catch (Exception ex)
            {
                MessageBox.Show("ERROR : " + ex.Message, _messageBoxCaption, MessageBoxButtons.OK, MessageBoxIcon.Information);
            }
        }

        private bool IsPrimaryDxSelected()
        {
            bool _isPrimaryDxSelected = false;
            try
            {
                if (c1Dx != null && c1Dx.Rows.Count > 0)
                {
                    for (int rowIndex = 1; rowIndex < c1Dx.Rows.Count; rowIndex++)
                    {
                        if (c1Dx.GetCellCheck(rowIndex, COL_DX_ISPRIMARY) == CheckEnum.Checked)
                        { _isPrimaryDxSelected = true; break; }
                    }
                }
            }
            catch (Exception ex)
            {
                gloAuditTrail.gloAuditTrail.ExceptionLog(ex, false);
            }

            return _isPrimaryDxSelected;
        }

        //Added by Subashish_b on 25/Jan /2011 (integration made on date-10/May/2011) for  to validate select the Account is active as well as PatientID against Account before charge Entry
        public static bool IsValidatePatientAccount(Int64 nPAccountID, Int64 nAccountPatientID, String sClaimNo, String sPatientType)
        {

            string result = "";
            bool blnReturn = true;
            gloDatabaseLayer.DBLayer oDB = new gloDatabaseLayer.DBLayer(AppSettings.ConnectionStringPM);
            gloDatabaseLayer.DBParameters oParameters = new gloDatabaseLayer.DBParameters();
            object oReturnValue;
            try
            {
                oParameters.Add("@nPAccountID", nPAccountID, ParameterDirection.Input, SqlDbType.BigInt);
                oParameters.Add("@nAccountPatientID", nAccountPatientID, ParameterDirection.Input, SqlDbType.BigInt);
                oParameters.Add("@sClaimNo", sClaimNo, ParameterDirection.Input, SqlDbType.VarChar, 255);
                oParameters.Add("@sPatientType", sPatientType, ParameterDirection.Input, SqlDbType.VarChar, 255);
                oParameters.Add("@nClinicID", AppSettings.ClinicID, ParameterDirection.Input, SqlDbType.BigInt);
                oParameters.Add("@sResult", result, ParameterDirection.Output, SqlDbType.VarChar, 255);//	numeric(18, 0)	Unchecked
                oDB.Connect(false);
                oDB.Execute("PA_Validate_ModifyCharge_AccountPatient", oParameters, out oReturnValue);

                result = oReturnValue.ToString();
                // MessageBox.Show(result.ToString());

                if (result.Trim().Length > 0)
                {
                    // Display Error Message and return 
                    MessageBox.Show(result, AppSettings.MessageBoxCaption, MessageBoxButtons.OK, MessageBoxIcon.Information);
                    blnReturn = false;
                }
            }
            catch (Exception ex)
            {
                blnReturn = false;
                gloAuditTrail.gloAuditTrail.ExceptionLog(ex, true);
                gloAuditTrail.gloAuditTrail.CreateAuditLog(ActivityModule.Billing, ActivityCategory.SetupCharges, ActivityType.Add, "Exception while Add Charges : " + ex.Message + " ", ActivityOutCome.Failure);
            }
            finally
            {
                if (oDB != null)
                    oDB.Dispose();
                if (oParameters != null)
                    oParameters.Dispose();
            }
            return blnReturn;
        }
        //End

        private bool ValidateInsurance()
        {
            //int _insrowindex = 0;
            bool _insresult = true;
            Int64 nPaymentCloseDate = 0;
            //    Int16 _selfParty = 0;
            gloBilling ogloBilling = new gloBilling(_DatabaseConnectionString, "");
            try
            {
                this.mskClaimDate.Validating -= new CancelEventHandler(mskDate_Validating);
                this.mskAccidentDate.Validating -= new CancelEventHandler(mskDate_Validating);
                this.mskHospitaliztionFrom.Validating -= new CancelEventHandler(mskDate_Validating);
                this.mskHospitaliztionTo.Validating -= new CancelEventHandler(mskDate_Validating);
                this.mskInjuryDate.Validating -= new CancelEventHandler(mskDate_Validating);
                this.mskOnsiteDate.Validating -= new CancelEventHandler(mskDate_Validating);
                this.mskOtherDate.Validating -= new CancelEventHandler(mskDate_Validating);
                this.mskUnableFromDate.Validating -= new CancelEventHandler(mskDate_Validating);
                this.mskUnableTillDate.Validating -= new CancelEventHandler(mskDate_Validating);
                this.mskInitTreatment.Validating -= new CancelEventHandler(mskDate_Validating);

                if (_IsPatientAccountFeature)
                {
                    // Assign Ids from patient strip control to local variables.
                    this.PatientID = oPatientControl.CmbSelectedPatientID;
                    this.nAccountPatientID = oPatientControl.AccountPatientID;
                    this.nPAccountID = oPatientControl.PAccountID;
                    this.nGuarantorID = oPatientControl.GuarantorID;

                    // validate to check patient has being changed
                    if (nInitialStripPatientID != oPatientControl.CmbSelectedPatientID)
                    {
                        _isPatientChanged = true;
                    }
                    // validate to check Account has being changed
                    if (nInitialStripAccountID != oPatientControl.PAccountID)
                    {
                        _isAccountChanged = true;
                    }
                    else
                    {
                        _isAccountChanged = false;
                    }


                    if (this._TransPatientID <= 0)
                    {
                        MessageBox.Show("Please select Patient for the claim. ", _messageBoxCaption, MessageBoxButtons.OK, MessageBoxIcon.Information);
                        _insresult = false;
                        return _insresult;
                    }
                    if (oPatientControl != null && oPatientControl.PatientCode.Trim() == "")
                    {
                        MessageBox.Show("Please select Patient for the claim. ", _messageBoxCaption, MessageBoxButtons.OK, MessageBoxIcon.Information);
                        _insresult = false;
                        return _insresult;
                    }


                    //To validate the code if PatientId or AccountId Changed

                    ///************************************************************************************************************
                    //We cannot change claim Patient (PatientID in any case for modify charges if at all it happens it is a bug in system)
                    //Now, if selected claim account is changed, check if the newly selected account is active
                    //Also, check if the claim patient is activated on the new account that is selected

                    if (_isPatientChanged == false)
                    {
                        if(_isAccountChanged == true)
                        {
                             if (IsValidatePatientAccount(this.nPAccountID, this.nAccountPatientID, this.sClaimNo, "SamePatient") == false) 
                             { return false; }

                             //else if (nInitialStripGuarantorName != oPatientControl.Guarantor)
                             //{ MessageBox.Show("Patient Account Guarantor is changed. ", gloGlobal.gloPMGlobal.MessageBoxCaption, MessageBoxButtons.OK, MessageBoxIcon.Information); }
                        }
                    }
                    else
                    {
                        MessageBox.Show("Claim patient cannot be changed.", gloGlobal.gloPMGlobal.MessageBoxCaption, MessageBoxButtons.OK, MessageBoxIcon.Information);
                        return false;
                    }

                    //if (_isPatientChanged || _isAccountChanged)
                    //{
                    //    if ((nInitialStripPatientID == oPatientControl.PatientID) && (nInitialStripAccountID != oPatientControl.PAccountID))
                    //    {
                    //        if (nInitialStripGuarantorName != oPatientControl.Guarantor)
                    //        {
                    //            MessageBox.Show("Patient Account Guarantor is changed. ", _messageBoxCaption, MessageBoxButtons.OK, MessageBoxIcon.Information);
                    //        }
                    //        else
                    //        {
                    //            //if Keeping same Patient Id but changed AccountID we have To Allow Modification if The claim has been paid  or on the process of the payment.
                    //            if (!IsValidatePatientAccount(this.nPAccountID, this.nAccountPatientID, this.sClaimNo, "SamePatient")) { return true; }
                    //        }
                    //    }
                    //    else
                    //    {
                    //        //To allow the Modify charge if patient is changed but account/patient is deactivate and restrict if charge is processed/paid for insurance payment
                    //        IsValidatePatientAccount(this.nPAccountID, this.nAccountPatientID, this.sClaimNo, "SamePatient");
                    //        if (!IsValidatePatientAccount(this.nPAccountID, this.nAccountPatientID, this.sClaimNo, "OtherPatient")) { return false; }
                    //    }
                    //}
                    //else
                    //{
                    //    if (!IsValidatePatientAccount(this.nPAccountID, this.nAccountPatientID, this.sClaimNo, "SamePatient")) { return true; }
                    //}
                    
                    ///************************************************************************************************************
                    
                    if (this.nPAccountID <= 0)
                    {
                        MessageBox.Show("Please select an Account ", _messageBoxCaption, MessageBoxButtons.OK, MessageBoxIcon.Information);
                        //To Set the focus to take input for the AccuntID
                        //oPatientControl.SelectSearchBox();
                        // _insresult = false;
                        return _insresult;
                    }
                }

                //End 

                if (this._TransPatientID <= 0)
                {
                    MessageBox.Show("Please select Patient for the claim. ", _messageBoxCaption, MessageBoxButtons.OK, MessageBoxIcon.Information);
                    _insresult = false;
                    return _insresult;
                }
                if (oPatientControl != null && oPatientControl.PatientCode.Trim() == "")
                {
                    MessageBox.Show("Please select Patient for the claim. ", _messageBoxCaption, MessageBoxButtons.OK, MessageBoxIcon.Information);
                    _insresult = false;
                    return _insresult;
                }


                if (IsValidDate(mskClaimDate.Text) == false)
                {
                    MessageBox.Show("Please enter close date. ", _messageBoxCaption, MessageBoxButtons.OK, MessageBoxIcon.Information);
                    mskClaimDate.Focus();
                    mskClaimDate.Select();
                    _insresult = false;
                    return _insresult;
                }
                else if (!ChkCloseDateWithPaymentDate(_InitialTransaction.TransactionMasterID, Convert.ToInt32(gloDateMaster.gloDate.DateAsNumber(mskClaimDate.Text.ToString())), ref nPaymentCloseDate))
                {

                    if (!ogloBilling.IsDayClosed(Convert.ToDateTime(mskClaimDate.Text)))
                    {
                        // MessageBox.Show("Close Date cannot be greater than Payment Close Date  [" + gloDateMaster.gloDate.DateAsDateString(nPaymentCloseDate) + "]", _messageBoxCaption, MessageBoxButtons.OK, MessageBoxIcon.Warning);
                        MessageBox.Show("Charge Close Date [" + mskClaimDate.Text + "] is not allowed. Charge Close Date cannot come after Payment Close Date [" + gloDateMaster.gloDate.DateAsDateString(nPaymentCloseDate) + "].", _messageBoxCaption, MessageBoxButtons.OK, MessageBoxIcon.Warning);
                        mskClaimDate.Focus();
                        return false;
                    }
                    ogloBilling.Dispose();
                }
                else
                {

                    if (_IsDayClosed == false)
                    {
                        if (ogloBilling.IsDayClosed(Convert.ToDateTime(mskClaimDate.Text)))
                        {
                            //MessageBox.Show("Day is already closed. You cannot perform any transaction for this close date.  ", _messageBoxCaption, MessageBoxButtons.OK, MessageBoxIcon.Information);
                            //mskClaimDate.Focus();
                            //mskClaimDate.Select();
                            //_insresult = false;
                            //return _insresult;
                        }
                    }


                }


                DateTime _OldestServiceDate;
                string[] masterClaim = null;
                char[] splitchar = { '-' };
                masterClaim = txtClaimNo.Text.Split(splitchar);

                //If Splitted then it was checking only for the loaded service lines refer the Bug 20810
                if (masterClaim.Length > 1)
                {
                    _OldestServiceDate = gloCharges.GetMinDOS(_InitialTransaction.TransactionMasterID);
                }
                else
                {
                    _OldestServiceDate = UC_gloBillingTransactionLines.GetOldestSeriveDate();
                }

                if (_OldestServiceDate != null && _OldestServiceDate != DateTime.MinValue)
                {
                    if (CmbAccidentType.Text.Trim() != "Work" && CmbAccidentType.Text.Trim() != "Auto")
                    {
                        mskOnsiteDate.TextMaskFormat = MaskFormat.ExcludePromptAndLiterals;
                        if (mskOnsiteDate.Text != "")
                        {
                            mskOnsiteDate.TextMaskFormat = MaskFormat.IncludeLiterals;
                            if (IsValidDate(mskOnsiteDate.Text))
                            {
                                if (Convert.ToDateTime(mskOnsiteDate.Text).Date > _OldestServiceDate.Date)
                                {
                                    MessageBox.Show("Claim date cannot be greater than service date.  ", _messageBoxCaption, MessageBoxButtons.OK, MessageBoxIcon.Information);
                                    mskOnsiteDate.Focus();
                                    mskOnsiteDate.Select();
                                    _insresult = false;
                                    return _insresult;
                                }
                            }
                            else
                            {
                                MessageBox.Show("Please enter a valid date.  ", _messageBoxCaption, MessageBoxButtons.OK, MessageBoxIcon.Information);
                                mskOnsiteDate.Focus();
                                mskOnsiteDate.Select();
                                _insresult = false;
                                return _insresult;
                            }
                        }
                    }
                    if (CmbAccidentType.Text.Trim() == "Auto" && CmbAccidentType.Text.Trim() != "Work")
                    {
                        mskAccidentDate.TextMaskFormat = MaskFormat.ExcludePromptAndLiterals;
                        if (mskAccidentDate.Text != "")
                        {
                            mskAccidentDate.TextMaskFormat = MaskFormat.IncludeLiterals;

                            if (IsValidDate(mskAccidentDate.Text))
                            {
                                if (Convert.ToDateTime(mskAccidentDate.Text).Date > _OldestServiceDate.Date)
                                {
                                    MessageBox.Show("Accident date cannot be greater than service date.  ", _messageBoxCaption, MessageBoxButtons.OK, MessageBoxIcon.Information);
                                    mskAccidentDate.Focus();
                                    mskAccidentDate.Select();
                                    _insresult = false;
                                    return _insresult;
                                }
                            }
                            else
                            {
                                MessageBox.Show("Please enter a valid date.  ", _messageBoxCaption, MessageBoxButtons.OK, MessageBoxIcon.Information);
                                mskAccidentDate.Focus();
                                mskAccidentDate.Select();
                                _insresult = false;
                                return _insresult;
                            }
                        }
                        else
                        {
                            MessageBox.Show("Please enter Accident date. ", _messageBoxCaption, MessageBoxButtons.OK, MessageBoxIcon.Information);
                            mskInjuryDate.Focus();
                            mskInjuryDate.Select();
                            _insresult = false;
                            return _insresult;

                        }
                    }
                    if (CmbAccidentType.Text.Trim() == "Work" && CmbAccidentType.Text.Trim() != "Auto")
                    {
                        mskInjuryDate.TextMaskFormat = MaskFormat.ExcludePromptAndLiterals;
                        if (mskInjuryDate.Text != "")
                        {
                            mskInjuryDate.TextMaskFormat = MaskFormat.IncludeLiterals;
                            if (IsValidDate(mskInjuryDate.Text))
                            {
                                if (Convert.ToDateTime(mskInjuryDate.Text).Date > _OldestServiceDate.Date)
                                {
                                    MessageBox.Show("Injury date cannot be greater than service date.  ", _messageBoxCaption, MessageBoxButtons.OK, MessageBoxIcon.Information);
                                    mskInjuryDate.Focus();
                                    mskInjuryDate.Select();
                                    _insresult = false;
                                    return _insresult;
                                }
                            }
                            else
                            {
                                MessageBox.Show("Please enter a valid date.  ", _messageBoxCaption, MessageBoxButtons.OK, MessageBoxIcon.Information);
                                mskInjuryDate.Focus();
                                mskInjuryDate.Select();
                                _insresult = false;
                                return _insresult;
                            }
                        }
                        else
                        {
                            MessageBox.Show("Please enter Injury date. ", _messageBoxCaption, MessageBoxButtons.OK, MessageBoxIcon.Information);
                            mskInjuryDate.Focus();
                            mskInjuryDate.Select();
                            _insresult = false;
                            return _insresult;

                        }

                    }
                    if (CmbAccidentType.Text.Trim() == "Other")
                    {
                        mskOtherDate.TextMaskFormat = MaskFormat.ExcludePromptAndLiterals;
                        if (mskOtherDate.Text != "")
                        {
                            mskOtherDate.TextMaskFormat = MaskFormat.IncludeLiterals;
                            if (IsValidDate(mskOtherDate.Text))
                            {
                                if (Convert.ToDateTime(mskOtherDate.Text).Date > _OldestServiceDate.Date)
                                {
                                    MessageBox.Show("Other Accident date cannot be greater than service date.  ", _messageBoxCaption, MessageBoxButtons.OK, MessageBoxIcon.Information);
                                    mskOtherDate.Focus();
                                    mskOtherDate.Select();
                                    _insresult = false;
                                    return _insresult;
                                }
                            }
                            else
                            {
                                MessageBox.Show("Please enter a valid date.  ", _messageBoxCaption, MessageBoxButtons.OK, MessageBoxIcon.Information);
                                mskOtherDate.Focus();
                                mskOtherDate.Select();
                                _insresult = false;
                                return _insresult;
                            }
                        }
                        else
                        {
                            MessageBox.Show("Please enter Other Accident date. ", _messageBoxCaption, MessageBoxButtons.OK, MessageBoxIcon.Information);
                            mskOtherDate.Focus();
                            mskOtherDate.Select();
                            _insresult = false;
                            return _insresult;

                        }
                    }

                    mskHospitaliztionFrom.TextMaskFormat = MaskFormat.ExcludePromptAndLiterals;
                    if (mskHospitaliztionFrom.Text != "")
                    {
                        mskHospitaliztionFrom.TextMaskFormat = MaskFormat.IncludeLiterals;
                        if (IsValidDate(mskHospitaliztionFrom.Text))
                        {
                            // Problem# 406 - Even if Hospitalization(from) date is greater then DOS, we are removing the restriction
                            //if (Convert.ToDateTime(mskHospitaliztionFrom.Text).Date > _OldestServiceDate.Date)
                            //{
                            //    MessageBox.Show("Hospitalization(from) date cannot be greater than service date.  ", _messageBoxCaption, MessageBoxButtons.OK, MessageBoxIcon.Information);
                            //    mskHospitaliztionFrom.Focus();
                            //    mskHospitaliztionFrom.Select();
                            //    _insresult = false;
                            //    return _insresult;
                            //}
                        }
                        else
                        {
                            MessageBox.Show("Please enter a valid date.  ", _messageBoxCaption, MessageBoxButtons.OK, MessageBoxIcon.Information);
                            mskHospitaliztionFrom.Focus();
                            mskHospitaliztionFrom.Select();
                            _insresult = false;
                            return _insresult;
                        }
                    }


                    mskHospitaliztionTo.TextMaskFormat = MaskFormat.ExcludePromptAndLiterals;
                    if (mskHospitaliztionTo.Text != "")
                    {
                        mskHospitaliztionTo.TextMaskFormat = MaskFormat.IncludeLiterals;
                        if (IsValidDate(mskHospitaliztionTo.Text))
                        {
                            if (Convert.ToDateTime(mskHospitaliztionTo.Text).Date > _OldestServiceDate.Date)
                            {
                                //MessageBox.Show("Hospitalization(To) Date cannot be greater than Service Date", _messageBoxCaption, MessageBoxButtons.OK, MessageBoxIcon.Information);
                                //dtpHospitaliztionTo.Focus();
                                //dtpHospitaliztionTo.Select();
                                //_insresult = false;
                                //return _insresult;
                            }
                        }
                        else
                        {
                            MessageBox.Show("Please enter a valid date.  ", _messageBoxCaption, MessageBoxButtons.OK, MessageBoxIcon.Information);
                            mskHospitaliztionTo.Focus();
                            mskHospitaliztionTo.Select();
                            _insresult = false;
                            return _insresult;
                        }
                    }

                    //mskUnableFromDate.TextMaskFormat = MaskFormat.ExcludePromptAndLiterals;
                    //if (mskUnableFromDate.Text != "")
                    //{
                    //    mskUnableFromDate.TextMaskFormat = MaskFormat.IncludeLiterals;
                    //    if (IsValidDate(mskUnableFromDate.Text))
                    //    {
                    //        if (Convert.ToDateTime(mskUnableFromDate.Text).Date > _OldestServiceDate.Date)
                    //        {
                    //            MessageBox.Show("Unable to work from date cannot be greater than service date.  ", _messageBoxCaption, MessageBoxButtons.OK, MessageBoxIcon.Information);
                    //            mskUnableFromDate.Focus();
                    //            mskUnableFromDate.Select();
                    //            _insresult = false;
                    //            return _insresult;
                    //        }
                    //    }
                    //    else
                    //    {
                    //        MessageBox.Show("Please enter a valid date.  ", _messageBoxCaption, MessageBoxButtons.OK, MessageBoxIcon.Information);
                    //        mskUnableFromDate.Focus();
                    //        mskUnableFromDate.Select();
                    //        _insresult = false;
                    //        return _insresult;
                    //    }
                    //}

                    if (_UnableToWorkFromDate_MoreClaimData > 0 && gloDateMaster.gloDate.DateAsDate(_UnableToWorkFromDate_MoreClaimData) > _OldestServiceDate.Date)
                    {
                        MessageBox.Show("Unable to work from date cannot be greater than service date. Please review More Claim Data.", _messageBoxCaption, MessageBoxButtons.OK, MessageBoxIcon.Information);
                        //mskUnableFromDate.Focus();
                        //mskUnableFromDate.Select();
                        _insresult = false;
                        return _insresult;
                    }

                    mskBox15Date.TextMaskFormat = MaskFormat.ExcludePromptAndLiterals;
                    if (mskBox15Date.Text != "")
                    {
                        mskBox15Date.TextMaskFormat = MaskFormat.IncludeLiterals;
                        if (Convert.ToString(cmbBox15DateQualifier.SelectedValue) == "")
                        {
                            MessageBox.Show("Please select the Other Claim Date Qualifier.  ", _messageBoxCaption, MessageBoxButtons.OK, MessageBoxIcon.Information);
                            cmbBox15DateQualifier.Focus();
                            cmbBox15DateQualifier.Select();
                            _insresult = false;
                            return _insresult;

                        }

                        if (IsValidDate(mskBox15Date.Text))
                        {


                            if (Convert.ToDateTime(mskBox15Date.Text).Date > _OldestServiceDate.Date)
                            {
                                switch (Convert.ToString(cmbBox15DateQualifier.SelectedValue))
                                {
                                    case "454":
                                        MessageBox.Show("Initial Treatment date cannot be greater than service date.  ", _messageBoxCaption, MessageBoxButtons.OK, MessageBoxIcon.Information);
                                        break;
                                    case "304":
                                        MessageBox.Show("Latest Visit or Consultation date cannot be greater than service date.  ", _messageBoxCaption, MessageBoxButtons.OK, MessageBoxIcon.Information);
                                        break;
                                    case "453":
                                        MessageBox.Show("Acute Manifestation of a Chronic Condition date cannot be greater than service date.  ", _messageBoxCaption, MessageBoxButtons.OK, MessageBoxIcon.Information);
                                        break;
                                    case "439":
                                        MessageBox.Show("Accident date cannot be greater than service date.  ", _messageBoxCaption, MessageBoxButtons.OK, MessageBoxIcon.Information);
                                        break;
                                    case "455":
                                        MessageBox.Show("Last X-ray date cannot be greater than service date.  ", _messageBoxCaption, MessageBoxButtons.OK, MessageBoxIcon.Information);
                                        break;
                                    case "471":
                                        MessageBox.Show("Prescription date cannot be greater than service date.  ", _messageBoxCaption, MessageBoxButtons.OK, MessageBoxIcon.Information);
                                        break;
                                    case "090":
                                        MessageBox.Show("Report Start (Assumed Care Date) date cannot be greater than service date.  ", _messageBoxCaption, MessageBoxButtons.OK, MessageBoxIcon.Information);
                                        break;
                                    case "091":
                                        MessageBox.Show("Report End (Relinquished Care Date) date cannot be greater than service date.  ", _messageBoxCaption, MessageBoxButtons.OK, MessageBoxIcon.Information);
                                        break;
                                    case "438":
                                        MessageBox.Show("Onset Same/Similar Illness Date date cannot be greater than service date.  ", _messageBoxCaption, MessageBoxButtons.OK, MessageBoxIcon.Information);
                                        break;
                                    default:
                                        break;


                                }

                                mskOtherDate.Focus();
                                mskOtherDate.Select();
                                _insresult = false;
                                return _insresult;
                            }
                        }
                        else
                        {
                            MessageBox.Show("Please enter a valid date.  ", _messageBoxCaption, MessageBoxButtons.OK, MessageBoxIcon.Information);
                            mskOtherDate.Focus();
                            mskOtherDate.Select();
                            _insresult = false;
                            return _insresult;
                        }


                    }


                    //mskUnableTillDate.TextMaskFormat = MaskFormat.ExcludePromptAndLiterals;
                    //if (mskUnableTillDate.Text != "")
                    //{
                    //    mskUnableTillDate.TextMaskFormat = MaskFormat.IncludeLiterals;
                    //    if (IsValidDate(mskUnableTillDate.Text))
                    //    {
                    //        if (Convert.ToDateTime(mskUnableTillDate.Text).Date > _OldestServiceDate.Date)
                    //        {
                    //            //MessageBox.Show("Unable to Work Till Date cannot be greater than Service Date", _messageBoxCaption, MessageBoxButtons.OK, MessageBoxIcon.Information);
                    //            //dtpUnableTillDate.Focus(); 
                    //            //dtpUnableTillDate.Select();
                    //            //_insresult = false;
                    //            //return _insresult;
                    //        }
                    //    }
                    //    else
                    //    {
                    //        MessageBox.Show("Please enter a valid date.  ", _messageBoxCaption, MessageBoxButtons.OK, MessageBoxIcon.Information);
                    //        mskUnableTillDate.Focus();
                    //        mskUnableTillDate.Select();
                    //        _insresult = false;
                    //        return _insresult;
                    //    }
                    //}

                    if (chkOutSideLab.Checked == true)
                    {
                        if (txtOutSideLabCharges.Text.Trim() == ".")
                        {
                            MessageBox.Show("Please enter the outside Lab charges.  ", _messageBoxCaption, MessageBoxButtons.OK, MessageBoxIcon.Information);
                            txtOutSideLabCharges.Focus();
                            txtOutSideLabCharges.Select();
                            _insresult = false;
                            return _insresult;
                        }

                        if (txtOutSideLabCharges.Text.Trim() == "" || Convert.ToDecimal(txtOutSideLabCharges.Text.Trim()) <= 0)
                        {
                            MessageBox.Show("Please enter the outside Lab charges.  ", _messageBoxCaption, MessageBoxButtons.OK, MessageBoxIcon.Information);
                            txtOutSideLabCharges.Focus();
                            txtOutSideLabCharges.Select();
                            _insresult = false;
                            return _insresult;
                        }
                    }

                }


                //if (IsValidDate(mskUnableFromDate.Text) && IsValidDate(mskUnableTillDate.Text))
                //{
                //    if (Convert.ToDateTime(mskUnableFromDate.Text).Date > Convert.ToDateTime(mskUnableTillDate.Text).Date)
                //    {
                //        MessageBox.Show("Unable to Work From Date cannot be greater than Unable to Work Till Date.", _messageBoxCaption, MessageBoxButtons.OK, MessageBoxIcon.Information);
                //        mskUnableFromDate.Focus();
                //        mskUnableFromDate.Select();
                //        _insresult = false;
                //        return _insresult;

                //    }
                //}

                if (_UnableToWorkFromDate_MoreClaimData > 0 && _UnableToWorkTillDate_MoreClaimData > 0)
                {
                    if (gloDateMaster.gloDate.DateAsDate(_UnableToWorkFromDate_MoreClaimData) > gloDateMaster.gloDate.DateAsDate(_UnableToWorkTillDate_MoreClaimData))
                    {
                        MessageBox.Show("Unable to Work From Date cannot be greater than Unable to Work Till Date. Please review More Claim Data", _messageBoxCaption, MessageBoxButtons.OK, MessageBoxIcon.Information);
                        //mskUnableFromDate.Focus();
                        //mskUnableFromDate.Select();
                        _insresult = false;
                        return _insresult;

                    }
                }


                if (IsValidDate(mskHospitaliztionFrom.Text) && IsValidDate(mskHospitaliztionTo.Text))
                {
                    if (Convert.ToDateTime(mskHospitaliztionFrom.Text).Date > Convert.ToDateTime(mskHospitaliztionTo.Text).Date)
                    {
                        MessageBox.Show("Hospitalization from Date cannot be greater than Hospitalization to Date.", _messageBoxCaption, MessageBoxButtons.OK, MessageBoxIcon.Information);
                        mskHospitaliztionFrom.Focus();
                        mskHospitaliztionFrom.Select();
                        _insresult = false;
                        return _insresult;

                    }
                }

                if (!UC_gloBillingTransactionLines.ValidateDx())
                {
                    _insresult = false;
                    return _insresult;
                }

                string _dxcode = "";
                string _dxdesc = "";

                if (c1Dx != null && c1Dx.Rows.Count > 1)
                {
                    int nICDRevision = (int)gloGlobal.gloICD.CodeRevision.ICD9;
                    if (rbICD10.Checked == true)
                        nICDRevision = (int)gloGlobal.gloICD.CodeRevision.ICD10;
                    else if (rbICD9.Checked == true)
                        nICDRevision = (int)gloGlobal.gloICD.CodeRevision.ICD9;

                    for (int i = 1; i < c1Dx.Rows.Count; i++)
                    {
                        _dxcode = "";
                        _dxdesc = "";

                        _dxcode = Convert.ToString(c1Dx.GetData(i, COL_DX_CODE));
                        _dxdesc = Convert.ToString(c1Dx.GetData(i, COL_DX_DESC));


                        if (_dxcode != "")
                        {
                            if (ogloBilling.CheckDxStatus(_dxcode.Trim(), nICDRevision) == 0)
                            {
                                //if (rbICD10.Checked)
                                //{
                                MessageBox.Show("ICD Type Mismatch", _messageBoxCaption, MessageBoxButtons.OK, MessageBoxIcon.Information);
                                //}
                                //else
                                //{
                                //    MessageBox.Show("ICD 9 codes cannot be mixed with ICD 10 codes.\nPlease remove ICD 10 codes before saving.", _messageBoxCaption, MessageBoxButtons.OK, MessageBoxIcon.Information);
                                //}
                                _insresult = false;
                                return _insresult;

                            }

                        }


                    }
                }
                //mskInitTreatment.TextMaskFormat = MaskFormat.ExcludePromptAndLiterals;
                //if (mskInitTreatment.Text != "")
                //{
                //    mskInitTreatment.TextMaskFormat = MaskFormat.IncludeLiterals;
                //    if (IsValidDate(mskInitTreatment.Text))
                //    {
                //        if (Convert.ToDateTime(mskInitTreatment.Text).Date > _OldestServiceDate.Date)
                //        {
                //            MessageBox.Show("Initial Date of Treatment cannot be greater than service date.  ", _messageBoxCaption, MessageBoxButtons.OK, MessageBoxIcon.Information);
                //            mskInitTreatment.Focus();
                //            mskInitTreatment.Select();
                //            _insresult = false;
                //            return _insresult;
                //        }
                //    }
                //    else
                //    {
                //        MessageBox.Show("Please enter a valid date.  ", _messageBoxCaption, MessageBoxButtons.OK, MessageBoxIcon.Information);
                //        mskInitTreatment.Focus();
                //        mskInitTreatment.Select();
                //        _insresult = false;
                //        return _insresult;
                //    }
                //}


                #region " Insurance responsibility validation "

                if (c1Insurance.Rows.Count > 1)
                {

                    Boolean _IsFirstPartySelected = false;
                    Int32 _CntInsurance = 0;
                    Int32 _CntBadDebt = 0;


                    #region " Check for multiple responsibility "

                    for (int i = 1; i <= c1Insurance.Rows.Count - 1; i++)
                    {
                        Int16 _Party = 0;
                        if (Int16.TryParse(c1Insurance.GetData(i, COL_INSURANCERESPONSIBILITY).ToString(), out _Party) == true)
                        {
                            if (_Party > 0)
                            {

                                if (c1Insurance.GetData(i, COL_INSSELFMODE) != null && c1Insurance.GetData(i, COL_INSSELFMODE).ToString() != "")
                                {
                                    if (PayerMode.Self == (PayerMode)Convert.ToInt16(c1Insurance.GetData(i, COL_INSSELFMODE)))
                                    { _CntInsurance = i; }
                                }
                                if (c1Insurance.GetData(i, COL_INSSELFMODE) != null && c1Insurance.GetData(i, COL_INSSELFMODE).ToString() != "")
                                {
                                    if (PayerMode.BadDebt == (PayerMode)Convert.ToInt16(c1Insurance.GetData(i, COL_INSSELFMODE)))
                                    { _CntBadDebt = i; }
                                }

                                if (_Party == 1)
                                { _IsFirstPartySelected = true; }

                                for (int j = i + 1; j <= c1Insurance.Rows.Count - 1; j++)
                                {
                                    Int16 _NextParty = 0;
                                    if (Int16.TryParse(c1Insurance.GetData(j, COL_INSURANCERESPONSIBILITY).ToString(), out _NextParty) == true)
                                    {
                                        if (_Party == _NextParty)
                                        {
                                            MessageBox.Show("Same responsibility is found for multiple Insurances. Please assign unique responsibility.", _messageBoxCaption, MessageBoxButtons.OK, MessageBoxIcon.Information);
                                            c1Insurance.Select(i, COL_INSURANCERESPONSIBILITY);
                                            c1Insurance.Focus();
                                            _insresult = false;
                                            return _insresult;
                                        }
                                    }
                                }
                            }
                        }
                    }

                    #endregion " Check for multiple responsibility"

                    #region " Check is first party selected "

                    if (_IsFirstPartySelected == false)
                    {
                        MessageBox.Show("Please specify first responsibility. ", _messageBoxCaption, MessageBoxButtons.OK, MessageBoxIcon.Information);
                        c1Insurance.Select(1, COL_INSURANCERESPONSIBILITY);
                        c1Insurance.Focus();
                        _insresult = false;
                        return _insresult;
                    }

                    #endregion " Check is first party selected "

                    #region " Check is responsibility in order "

                    for (int i = 1; i <= c1Insurance.Rows.Count - 1; i++)
                    {
                        Int16 _Party = 0;
                        if (c1Insurance.GetData(i, COL_INSURANCERESPONSIBILITY) != null && c1Insurance.GetData(i, COL_INSURANCERESPONSIBILITY).ToString().Length > 0)
                        {
                            if (Int16.TryParse(c1Insurance.GetData(i, COL_INSURANCERESPONSIBILITY).ToString(), out _Party) == true)
                            {
                                if (_Party != i)
                                {
                                    MessageBox.Show("Responsibility is out of order.  Please specify responsibility in sequence. ", _messageBoxCaption, MessageBoxButtons.OK, MessageBoxIcon.Information);
                                    c1Insurance.Select(i, COL_INSURANCERESPONSIBILITY);
                                    c1Insurance.Focus();
                                    _insresult = false;
                                    return _insresult;
                                }
                            }

                        }
                        else
                        {
                            break;
                        }
                    }

                    #endregion " Check is responsibility in order "

                    #region " Check Self is Last responsibility "

                    if (_CntInsurance > 0)
                    {
                        if (c1Insurance.Rows.Count > _CntInsurance + 1)
                        {
                            Int16 _Party = 0;
                            if (c1Insurance.GetData(_CntInsurance + 1, COL_INSURANCERESPONSIBILITY) != null && c1Insurance.GetData(_CntInsurance + 1, COL_INSURANCERESPONSIBILITY).ToString().Length > 0)
                            {
                                if (Int16.TryParse(c1Insurance.GetData(_CntInsurance + 1, COL_INSURANCERESPONSIBILITY).ToString(), out _Party) == true)
                                {
                                    if (_Party > _CntInsurance && _Party != _CntBadDebt)
                                    {
                                        MessageBox.Show("You cannot specify responsibility after self. ", _messageBoxCaption, MessageBoxButtons.OK, MessageBoxIcon.Information);
                                        c1Insurance.Select(_CntInsurance + 1, COL_INSURANCERESPONSIBILITY);
                                        c1Insurance.Focus();
                                        _insresult = false;
                                        return _insresult;
                                    }

                                }
                                if (c1Insurance.Rows.Count > _CntBadDebt + 1)
                                {
                                    if (Int16.TryParse(c1Insurance.GetData(_CntBadDebt + 1, COL_INSURANCERESPONSIBILITY).ToString(), out _Party) == true)
                                    {
                                        if (_Party > _CntBadDebt && _CntBadDebt != 0)
                                        {
                                            MessageBox.Show("You cannot specify responsibility after BadDebt. ", _messageBoxCaption, MessageBoxButtons.OK, MessageBoxIcon.Information);
                                            c1Insurance.Select(_CntInsurance + 1, COL_INSURANCERESPONSIBILITY);
                                            c1Insurance.Focus();
                                            _insresult = false;
                                            return _insresult;
                                        }

                                    }
                                }
                            }
                        }
                        if (c1Insurance.Rows.Count > _CntBadDebt + 1)
                        {
                            if (_CntBadDebt > 0 && _CntInsurance > _CntBadDebt && _CntBadDebt != 0)
                            {
                                MessageBox.Show("You cannot specify BadDebt responsibility before self. ", _messageBoxCaption, MessageBoxButtons.OK, MessageBoxIcon.Information);
                                c1Insurance.Select(_CntBadDebt + 1, COL_INSURANCERESPONSIBILITY);
                                c1Insurance.Focus();
                                _insresult = false;
                                return _insresult;
                            }
                        }
                    }
                    #endregion " Check Self is Last responsibility "

                    #region " Check Responsible Party is blank on not "


                    if (c1Insurance.Rows.Count > 1)
                    {
                        string _Party = "";
                        c1Insurance_BeforeEdit(null, null);

                        for (int iCount = 1; iCount <= c1Insurance.Rows.Count - 1; iCount++)
                        {
                            if (c1Insurance.GetCellCheck(iCount, COL_SELECT_CURRENT_RESPONSIBLE_PARTY) == CheckEnum.Checked)
                            {
                                _iCurrentResponsiblePosition = iCount;
                                break;
                            }
                        }

                        _Party = c1Insurance.GetData(Convert.ToInt16(_iCurrentResponsiblePosition), COL_INSURANCERESPONSIBILITY).ToString().Replace("\0", "").Trim();
                        if (_Party.ToString() == "" || _Party.ToString() == null)
                        {
                            MessageBox.Show("Responsible party cannot be blank. ", _messageBoxCaption, MessageBoxButtons.OK, MessageBoxIcon.Information);
                            c1Insurance.Select(Convert.ToInt16(_iCurrentResponsiblePosition), COL_INSURANCERESPONSIBILITY);
                            c1Insurance.Focus();
                            return false;
                        }
                    }

                    #endregion " Check Self is Last responsibility "


                    for (int i = 1; i <= c1Insurance.Rows.Count - 1; i++)
                    {
                        if (PayerMode.Self == (PayerMode)Convert.ToInt16(c1Insurance.GetData(i, COL_INSSELFMODE)))
                        {
                            if (Convert.ToString(c1Insurance.GetData(i, COL_INSURANCERESPONSIBILITY)).Replace("\0", "") == "")
                            {
                                MessageBox.Show("Self responsibility cannot be blank. ", _messageBoxCaption, MessageBoxButtons.OK, MessageBoxIcon.Information);
                                c1Insurance.Select(i, COL_INSURANCERESPONSIBILITY);
                                c1Insurance.Focus();
                                return false;
                            }
                        }

                    }
                }

                #endregion " Insurance responsibility validation "

                if (!ValidateAppointmentsLinkingToCharges())
                {
                    this.btnPatientAppointments_Click(this, new EventArgs());
                    _insresult = false;
                    return _insresult;
                }
            }
            catch (Exception ex)
            {
                gloAuditTrail.gloAuditTrail.ExceptionLog(ex, true);

                _insresult = false;
            }
            finally
            {
                this.mskClaimDate.Validating += new CancelEventHandler(mskDate_Validating);
                this.mskAccidentDate.Validating += new CancelEventHandler(mskDate_Validating);
                this.mskHospitaliztionFrom.Validating += new CancelEventHandler(mskDate_Validating);
                this.mskHospitaliztionTo.Validating += new CancelEventHandler(mskDate_Validating);
                this.mskInjuryDate.Validating += new CancelEventHandler(mskDate_Validating);
                this.mskOnsiteDate.Validating += new CancelEventHandler(mskDate_Validating);
                this.mskOtherDate.Validating += new CancelEventHandler(mskDate_Validating);
                this.mskUnableFromDate.Validating += new CancelEventHandler(mskDate_Validating);
                this.mskUnableTillDate.Validating += new CancelEventHandler(mskDate_Validating);
                this.mskInitTreatment.Validating += new CancelEventHandler(mskDate_Validating);
                if (ogloBilling != null) { ogloBilling.Dispose(); }
            }
            return _insresult;
        }

        private void ClearData()
        {
            try
            {
                if (Convert.ToString(txtPriorAuthorizationNo.Tag) != "" || Convert.ToInt64(txtPriorAuthorizationNo.Tag) != 0)
                { btnRemove_PriorAuthorization_Click(null, null); }
                txtOutSideLabCharges.Text = "0.00";
                txtClaimNo.Text = "";
                txtBatchNo.Text = "";

                mskClaimDate.Text = gloBilling.GetUserWiseCloseDay(_UserID, CloseDayType.Charge);

                mskHospitaliztionFrom.Text = ""; // DateTime.Now.ToString("MM/dd/yyyy");
                mskHospitaliztionTo.Text = ""; // DateTime.Now.ToString("MM/dd/yyyy");
                mskUnableFromDate.Text = ""; // DateTime.Now.ToString("MM/dd/yyyy");
                mskUnableTillDate.Text = ""; // DateTime.Now.ToString("MM/dd/yyyy");
                _UnableToWorkFromDate_MoreClaimData = 0;
                _UnableToWorkTillDate_MoreClaimData = 0;
                mskAccidentDate.Text = ""; // DateTime.Now.ToString("MM/dd/yyyy");
                mskInitTreatment.Text = "";




                //chkAutoClaim.Checked = false;
                //chkWorkersComp.Checked = false;
                CmbAccidentType.SelectedIndex = (int)AccidentType.None;
                chkOutSideLab.Checked = false;
                if (cmbState != null) { cmbState.SelectedIndex = -1; }
                if (cmbFacility != null) { cmbFacility.SelectedIndex = -1; }
                if (cmbBillingProvider != null) { cmbBillingProvider.SelectedIndex = -1; }
                if (cmbReferralProvider != null) { cmbReferralProvider.DataSource = null; cmbReferralProvider.Items.Clear(); cmbReferralProvider.SelectedIndex = -1; }
                if (cmbClaimNo != null) { cmbClaimNo.SelectedIndex = -1; }
                DesignDxGrid();
                DesignInsuranceGrid();
                //DesignInsurancePaymentGrid();


            }
            catch (Exception ex)
            {
                gloAuditTrail.gloAuditTrail.ExceptionLog(ex, false);
            }
        }

        private void ClearFormData()
        {
            try
            {

                if (Convert.ToString(txtPriorAuthorizationNo.Tag) != "" || Convert.ToInt64(txtPriorAuthorizationNo.Tag) != 0)
                { btnRemove_PriorAuthorization_Click(null, null); }
                txtOutSideLabCharges.Text = "0.00";
                txtClaimNo.Text = "";
                txtBatchNo.Text = "";


                mskClaimDate.Text = gloBilling.GetUserWiseCloseDay(_UserID, CloseDayType.Charge);
                mskHospitaliztionFrom.Text = "";
                mskHospitaliztionTo.Text = "";
                mskUnableFromDate.Text = "";
                mskUnableTillDate.Text = "";
                _UnableToWorkFromDate_MoreClaimData = 0;
                _UnableToWorkTillDate_MoreClaimData = 0;
                mskAccidentDate.Text = "";
                mskInitTreatment.Text = "";

                //chkAutoClaim.Checked = false;
                //chkWorkersComp.Checked = false;
                CmbAccidentType.SelectedIndex = (int)AccidentType.None;
                chkOutSideLab.Checked = false;
                if (cmbState != null) { cmbState.SelectedIndex = -1; }
                if (cmbFacility != null) { cmbFacility.SelectedIndex = -1; }
                if (cmbBillingProvider != null && cmbBillingProvider.Items.Count > 0)
                {
                    GetProviderSettings(PatientPoviderID);
                }
                if (cmbReferralProvider != null) { cmbReferralProvider.SelectedIndex = -1; }
                if (cmbClaimNo != null) { cmbClaimNo.SelectedIndex = -1; }
            }
            catch (Exception ex)
            {
                gloAuditTrail.gloAuditTrail.ExceptionLog(ex, false);
            }
        }

        private void SetNonFacilityFee()
        {
            FacilityFee = true;
        }

        private void SetFacilityFee()
        {
            FacilityFee = false;
        }

        private bool IsAdmin(Int64 UserId)
        {
            gloDatabaseLayer.DBLayer oDB = new gloDatabaseLayer.DBLayer(_DatabaseConnectionString);
            DataTable oDataTable = null;
            bool result = false;
            try
            {
                oDB.Connect(false);
                oDB.Retrive_Query("Select nAdministrator from User_MST WITH (NOLOCK) where nUserID='" + UserId + "' and nAdministrator = 1", out oDataTable);
                if (oDataTable != null)
                {
                    if (oDataTable.Rows.Count > 0)
                    {
                        result = true;
                    }
                }
                oDataTable.Dispose();
                oDB.Dispose();
                return result;
            }
            catch (Exception ex)
            {
                gloAuditTrail.gloAuditTrail.ExceptionLog(ex, false);
                return false;
            }
        }

        private void IsDefaultFeeScheduleExpired()
        {
            gloDatabaseLayer.DBLayer oDB = new gloDatabaseLayer.DBLayer(_DatabaseConnectionString);
            string _sqlquery = "";
            object _sqlresult = null;
            Int64 _clinicFeeSettingValue = 0;

            try
            {
                oDB.Connect(false);
                _sqlquery = "SELECT ISNULL(sSettingsValue,0) FROM Settings WITH (NOLOCK) WHERE UPPER(sSettingsName) = 'CLINICFEESCHEDULE' AND nClinicID = " + _ClinicID + "";
                _sqlresult = new object();
                _sqlresult = oDB.ExecuteScalar_Query(_sqlquery);
                if (_sqlresult != null)
                {
                    if (Convert.ToString(_sqlresult).Trim() != "")
                    {
                        try
                        {
                            _clinicFeeSettingValue = Convert.ToInt64(_sqlresult.ToString());
                        }
                        catch (Exception ex)
                        {
                            gloAuditTrail.gloAuditTrail.ExceptionLog(ex, false);
                            //ex.ToString();
                            //ex = null;
                        }
                    }
                }

                #region " Check if Fee Schedule is not expired "

                if (_clinicFeeSettingValue > 0)
                {
                    _sqlquery = "select ISNULL(nFeeScheduleID,'') AS nFeeScheduleID from BL_FeeSchedule_Allocation WITH (NOLOCK) where " +
                    " nFeeScheduleID = " + _clinicFeeSettingValue + " " +
                    " and nToDate >= " + gloDateMaster.gloDate.DateAsNumber(DateTime.Now.ToString()) + " and nClinicID = " + _ClinicID + "";

                    _sqlresult = new object();
                    _sqlresult = oDB.ExecuteScalar_Query(_sqlquery);
                    if (_sqlresult == null || Convert.ToString(_sqlresult).Trim() == "" || Convert.ToInt64(_sqlresult.ToString()) <= 0)
                    {
                        MessageBox.Show("Default fee schedule is expired please extend the time period.", _messageBoxCaption, MessageBoxButtons.OK, MessageBoxIcon.Warning);
                    }
                }
                else
                {
                    MessageBox.Show("Default fee schedule is not set.", _messageBoxCaption, MessageBoxButtons.OK, MessageBoxIcon.Warning);
                }
                #endregion " Check if Fee Schedule is not expired "

                oDB.Disconnect();
            }
            catch (Exception ex)
            {
                MessageBox.Show("ERROR : " + ex.Message, _messageBoxCaption, MessageBoxButtons.OK, MessageBoxIcon.Information);
                //ex.ToString();
                //ex = null;
            }
            finally
            {
                if (oDB != null)
                { oDB.Dispose(); }
            }
        }

        private bool Ok_Click()
        {
            bool _retValue = false;
            try
            {
                if (ValidateInsurance())
                {
                    if (!IsClaimRulesEnabled() || ValidateRules())
                    {
                        _retValue = AddTransaction(false);
                        if (_retValue)
                        {

                            mskAccidentDate.Text = "";
                            mskHospitaliztionFrom.Text = "";
                            mskHospitaliztionTo.Text = "";
                            mskInjuryDate.Text = "";
                            mskOnsiteDate.Text = "";
                            mskOtherDate.Text = "";
                            mskUnableFromDate.Text = "";
                            mskUnableTillDate.Text = "";
                            _UnableToWorkFromDate_MoreClaimData = 0;
                            _UnableToWorkTillDate_MoreClaimData = 0;
                            mskInitTreatment.Text = "";

                            //chkWorkersComp.Checked = false;
                            //chkAutoClaim.Checked = false;
                            //chkOther.Checked = false;
                            CmbAccidentType.SelectedIndex = (int)AccidentType.None;
                            Int64 _InsuranceId = 0;
                            Int64 _ContactId = 0;

                            if (c1Insurance != null && c1Insurance.Rows.Count > 0)
                            {

                                for (int i = 1; i <= c1Insurance.Rows.Count - 1; i++)
                                {
                                    if (c1Insurance.GetCellCheck(i, COL_SELECT_CURRENT_RESPONSIBLE_PARTY) == CheckEnum.Checked)
                                    {
                                        _InsuranceId = Convert.ToInt64(c1Insurance.GetData(i, COL_INSURANCEID));
                                        _ContactId = Convert.ToInt64(c1Insurance.GetData(i, COL_INSURANCECONTACTID));
                                        break;
                                    }
                                }

                            }
                            if (triggeredRuleInfoGlobal != null && triggeredRuleInfoGlobal.Count > 0)
                            {
                                DataTable dtRule = new DataTable();

                                dtRule.Columns.Add("nRuleID");
                                dtRule.Columns.Add("nTransactionMasterID");
                                dtRule.Columns.Add("nTransactionID");
                                dtRule.Columns.Add("nInsuranceID");
                                dtRule.Columns.Add("nContactID");
                                dtRule.Columns.Add("nUserID");
                                dtRule.Columns.Add("nRuleType");

                                foreach (gloUIControlLibrary.Classes.ClaimRules.TriggeredRuleInfo oRule in triggeredRuleInfoGlobal)
                                {

                                    dtRule.Rows.Add();
                                    dtRule.Rows[dtRule.Rows.Count - 1]["nRuleID"] = oRule.RuleId;
                                    dtRule.Rows[dtRule.Rows.Count - 1]["nTransactionMasterID"] = _MasterTransactionID;
                                    dtRule.Rows[dtRule.Rows.Count - 1]["nTransactionID"] = _TransactionID;
                                    dtRule.Rows[dtRule.Rows.Count - 1]["nInsuranceID"] = _InsuranceId;
                                    dtRule.Rows[dtRule.Rows.Count - 1]["nContactID"] = _ContactId;
                                    dtRule.Rows[dtRule.Rows.Count - 1]["nUserID"] = gloGlobal.gloPMGlobal.UserID;
                                    dtRule.Rows[dtRule.Rows.Count - 1]["nRuleType"] = oRule.RuleTypeInfo.GetHashCode();

                                }
                                gloCharges.SaveTriggeredRules(dtRule, false);
                                gloAuditTrail.gloAuditTrail.CreateAuditLog(gloAuditTrail.ActivityModule.ChargeRule, gloAuditTrail.ActivityCategory.ChargeRuleEvaluation, gloAuditTrail.ActivityType.SaveWithErrors, "Claim modified with errors", 0, _InitialTransaction.TransactionID, 0, gloAuditTrail.ActivityOutCome.Success, gloAuditTrail.SoftwareComponent.gloPM, true);

                            }
                        }


                    }

                }
            }
            catch (Exception ex)
            {
                gloAuditTrail.gloAuditTrail.ExceptionLog(ex, false);
            }
            return _retValue;
        }

        private void GetProviderSettings(Int64 ProviderID)
        {

            DataTable dtProviderSettings = null;
            _RenderingProviderID = 0;
            _RenderingProviderName = "";
            gloAppointmentBook.Books.Resource oResource = new gloAppointmentBook.Books.Resource(_DatabaseConnectionString);

            try
            {
                dtProviderSettings = gloCharges.GetProviderSettings(ProviderID);

                if (dtProviderSettings != null)
                {
                    foreach (DataRow dr in dtProviderSettings.Rows)
                    {

                        switch (Convert.ToString(dr["sName"]).Trim())
                        {
                            case "TypeOfService":
                                _DefaultTOSID = Convert.ToInt64(dr["sValue"]);
                                break;
                            case "PlaceOfService":
                                _DefaultPOSID = Convert.ToInt64(dr["sValue"]);
                                break;
                            case "BillingProvider":
                                if (Convert.ToInt64(dr["sValue"]) > 0)
                                {
                                    cmbBillingProvider.SelectedValue = Convert.ToInt64(dr["sValue"]);
                                }
                                else
                                {
                                    cmbBillingProvider.SelectedValue = PatientPoviderID;
                                }
                                break;
                            case "RenderingProvider":
                                if (Convert.ToInt64(dr["sValue"]) > 0)
                                {
                                    _RenderingProviderID = Convert.ToInt64(dr["sValue"]);
                                    _RenderingProviderName = oResource.GetProviderName(Convert.ToInt64(dr["sValue"]));
                                }
                                break;
                            case "Facility":
                                if (Convert.ToString(dr["sValue"]).Trim() != "")
                                {
                                    cmbFacility.SelectedValue = Convert.ToString(dr["sValue"]);
                                }
                                break;

                        }

                    }
                }
            }
            catch (gloDatabaseLayer.DBException dbEx)
            {
                dbEx.ERROR_Log(dbEx.ToString());
            }
            catch (Exception ex)
            {
                gloAuditTrail.gloAuditTrail.ExceptionLog(ex, true);
            }
            finally
            {
                if (dtProviderSettings != null) { dtProviderSettings.Dispose(); }
                if (oResource != null) { oResource.Dispose(); }
            }
        }

        private void SetModifiedInsurance()
        {
            try
            {
                string _fillInsuranceName = "";
                Int64 _fillInsuranceID = 0;
                Int32 _fillInsSelfMode = 0;

                CheckEnum _Selected = CheckEnum.None;
                int _CurRowIndex = c1Insurance.Row;

                if (c1Insurance.Rows.Count > 0)
                {
                    _Selected = c1Insurance.GetCellCheck(_CurRowIndex, COL_SELECT);

                    if (_Selected == CheckEnum.Checked)
                    {
                        for (int i = 1; i <= c1Insurance.Rows.Count - 1; i++)
                        {
                            if (i != _CurRowIndex)
                            {
                                if (c1Insurance.GetCellCheck(i, COL_SELECT) == CheckEnum.Checked)
                                {

                                    c1Insurance.SetCellCheck(i, COL_SELECT, CheckEnum.Unchecked);

                                }
                            }
                        }

                        _fillInsuranceID = Convert.ToInt64(c1Insurance.GetData(_CurRowIndex, COL_INSURANCEID));
                        _fillInsuranceName = Convert.ToString(c1Insurance.GetData(_CurRowIndex, COL_INSURANCENAME));
                        _fillInsSelfMode = Convert.ToInt32(c1Insurance.GetData(_CurRowIndex, COL_INSSELFMODE));
                        if (UC_gloBillingTransactionLines != null && UC_gloBillingTransactionLines.GetLinesCount() > 1)
                        {
                            for (int lineIndex = 1; lineIndex < UC_gloBillingTransactionLines.GetLinesCount(); lineIndex++)
                            {
                                UC_gloBillingTransactionLines.AddInsurance(lineIndex, _fillInsuranceID, _fillInsuranceName, _fillInsSelfMode);
                            }
                        }
                    }
                    else
                    {
                        _fillInsuranceID = 0;
                        _fillInsuranceName = "";
                        _fillInsSelfMode = PayerMode.None.GetHashCode();
                        if (UC_gloBillingTransactionLines != null && UC_gloBillingTransactionLines.GetLinesCount() > 1)
                        {
                            for (int lineIndex = 1; lineIndex < UC_gloBillingTransactionLines.GetLinesCount(); lineIndex++)
                            {
                                UC_gloBillingTransactionLines.AddInsurance(lineIndex, _fillInsuranceID, _fillInsuranceName, _fillInsSelfMode);
                            }
                            //UC_gloBillingTransactionLines.AddInsurance(UC_gloBillingTransactionLines.CurrentTransactionLine, _fillInsuranceID, _fillInsuranceName, _fillInsSelfMode);
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                gloAuditTrail.gloAuditTrail.ExceptionLog(ex, true);
            }
        }

        private void CheckForPA()
        {
            try
            {
                if (clsgloPriorAuthorization.HasPriorAuthorization(PatientID))
                {
                    if ((Convert.ToString(txtPriorAuthorizationNo.Tag) == "") || (txtPriorAuthorizationNo.Tag == null) || (Convert.ToInt64(txtPriorAuthorizationNo.Tag) == 0))
                    {
                        txtPriorAuthorizationNo.Text = "<available>";
                        txtPriorAuthorizationNo.TextAlign = HorizontalAlignment.Center;
                        txtPriorAuthorizationNo.ForeColor = Color.Maroon;
                        //lblAuthorizationAvailable.Visible = true; 
                    }
                    else
                    {
                        txtPriorAuthorizationNo.TextAlign = HorizontalAlignment.Left;
                        txtPriorAuthorizationNo.ForeColor = Color.Black;
                        //lblAuthorizationAvailable.Visible = false; 
                    }
                }
                //abhisekh 08 sept 2010
                else
                {
                    if (txtPriorAuthorizationNo.Tag == null || Convert.ToString(txtPriorAuthorizationNo.Tag) == "" || Convert.ToInt64(txtPriorAuthorizationNo.Tag) == 0)
                    {
                        txtPriorAuthorizationNo.Text = "";
                    }
                }
                //end
            }
            catch (Exception ex)
            {
                gloAuditTrail.gloAuditTrail.ExceptionLog(ex, true);
            }
        }

        private void CopyClaim(ReplacementClaimCreationType _ReplacementClaimCreationType)
        {
            frmBillingTransaction ofrmBillingTransaction = null;
            try
            {
                ofrmBillingTransaction = frmBillingTransaction.GetInstance_CopyClaim(this.PatientID);
                ofrmBillingTransaction.bIsCopiedClaim = true;
                ofrmBillingTransaction._MasterTransactionID = _MasterTransactionID;
                ofrmBillingTransaction._TransactionID = _TransactionID;
                if (_ReplacementClaimCreationType == ReplacementClaimCreationType.Replacement)
                {
                    ofrmBillingTransaction.nReplacingTransMasterID = _MasterTransactionID;
                    ofrmBillingTransaction.sReplaingClaimNo = gloCharges.FormattedClaimNumberGeneration(Convert.ToString(_InitialTransaction.ClaimNo));
                }
                else
                {
                    ofrmBillingTransaction.nReplacingTransMasterID = 0;
                    ofrmBillingTransaction.sReplaingClaimNo = "";
                }

                ofrmBillingTransaction.ReplacementClaimCreationType = _ReplacementClaimCreationType;
                ofrmBillingTransaction.WindowState = FormWindowState.Maximized;
                ofrmBillingTransaction.Visible = false;
                ofrmBillingTransaction.ShowDialog(this);
                ofrmBillingTransaction.BringToFront();
                if (_ReplacementClaimCreationType != ReplacementClaimCreationType.Copy)
                {
                    GetReplacementClaimIndication();
                }


            }
            catch (Exception ex)
            {
                gloAuditTrail.gloAuditTrail.ExceptionLog(ex, true);
            }
            finally
            {
                if (ofrmBillingTransaction != null) { ofrmBillingTransaction.Dispose(); ofrmBillingTransaction = null; }

            }
        }

        #endregion " Public & Private Methods "

        #region "Fill data"


        private void FillClaim(Int64 PatientId)
        {
            gloDatabaseLayer.DBLayer oDB = new gloDatabaseLayer.DBLayer(_DatabaseConnectionString);
            DataTable dt = null;
         
            cmbClaimNo.DataSource = null;
            cmbClaimNo.Items.Clear();
            string _sqlQuery = "";

            try
            {

                oDB.Connect(false);
                _sqlQuery = "SELECT  sClaimno FROM Patient_WorkersComp WITH (NOLOCK) WHERE  nPatientId = " + PatientId + " AND nType = 1";

                oDB.Retrive_Query(_sqlQuery, out dt);

                if (dt != null)
                {
                    cmbClaimNo.DataSource = dt;
                    cmbClaimNo.ValueMember = dt.Columns["sClaimno"].ColumnName;
                    cmbClaimNo.DisplayMember = dt.Columns["sClaimno"].ColumnName;
                    cmbClaimNo.Refresh();
                    cmbClaimNo.SelectedIndex = -1;
                }

            }
            catch (Exception ex)
            {
                gloAuditTrail.gloAuditTrail.ExceptionLog(ex, true);
            }
            finally
            {
                oDB.Disconnect();
                if (oDB != null) { oDB.Dispose(); }
            }
        }

        private void FillFeeSchedule()
        {
            DataTable dt;
            // Fill Providers in the Combo Box
            frmSetupStdFeeSchedule OfrmstdFeeSchedule = new frmSetupStdFeeSchedule(_DatabaseConnectionString);
            try
            {
                dt = OfrmstdFeeSchedule.GetAllStdFeeSchedules();
                cmbFeeSchedule.SelectedIndexChanged -= cmbFeeSchedule_SelectedIndexChanged;
                if (dt != null)
                {
                    if (dt.Rows.Count > 0)
                    {
                        cmbFeeSchedule.DataSource = dt.Copy();
                        cmbFeeSchedule.ValueMember = dt.Columns["nFeeScheduleID"].ColumnName;
                        cmbFeeSchedule.DisplayMember = dt.Columns["sFeeScheduleName"].ColumnName;
                        cmbFeeSchedule.Refresh();
                        cmbFeeSchedule.SelectedIndex = 0;
                    }
                    dt.Dispose();
                }

                dt = null;
                cmbFeeSchedule.SelectedIndexChanged += cmbFeeSchedule_SelectedIndexChanged;
                OfrmstdFeeSchedule.Dispose();
                OfrmstdFeeSchedule = null;
            }
            catch (Exception ex)
            {
                gloAuditTrail.gloAuditTrail.ExceptionLog(ex, true);
            }
            finally
            {
                if (OfrmstdFeeSchedule != null) { OfrmstdFeeSchedule.Dispose(); }
            }

        }

        private void FillReferralProviders(Int64 PatientId)
        {
            DataTable dt;
            try
            {
                dt = GetPatientReferral(PatientId);
                string _selectedRefProvName = "";
                if (cmbReferralProvider.SelectedValue != null)
                {
                    _selectedRefProvName = Convert.ToString(cmbReferralProvider.Text);
                }
                if (dt != null)
                {
                    DataRow dr = dt.NewRow();
                    dr["nReferralID"] = 0;
                    dr["sReferralName"] = "";
                    dt.Rows.InsertAt(dr, 0);

                    if (dt.Rows.Count > 0)
                    {
                        // _Transaction.ReferalProviderID_New
                        cmbReferralProvider.DataSource = dt.Copy();
                        cmbReferralProvider.ValueMember = dt.Columns["nReferralID"].ColumnName;
                        cmbReferralProvider.DisplayMember = dt.Columns["sReferralName"].ColumnName;
                        cmbReferralProvider.Refresh();

                        if (_selectedRefProvName != "")
                        {
                            cmbReferralProvider.Text = _selectedRefProvName;
                        }
                        else if (_selectedRefProvName == "")
                        {
                            cmbReferralProvider.Text = _selectedRefProvName;
                        }
                        //added
                        if (_InitialReferalProviderId > 0)
                        {
                            cmbReferralProvider.SelectedValue = _InitialReferalProviderId;

                        }
                        else
                        {
                            cmbReferralProvider.SelectedValue = 0;

                        }


                    }
                    dt.Dispose();

                }
                dt = null;
            }
            catch (Exception ex)
            {
                gloAuditTrail.gloAuditTrail.ExceptionLog(ex, true);
            }

        }

        #region "Move billing provider"

        private Int64 RegisterProviderAsPhysician(Int64 nProviderId)
        {
            try
            {
                //Added By MaheshB
                // gloPMContacts.gloContacts oglocontact = new gloPMContacts.gloContacts(_DatabaseConnectionString);
                //Boolean isExists;
                _ContactID = IsExistInContacts(nProviderId);
                if (_ContactID == 0)
                {
                    _ContactID = SaveData_RefferalProvider(nProviderId);
                    return _ContactID;
                }
                else
                {
                    bool isRefferalAgainstPatientExist = false;
                    try
                    {

                        DataTable dtReferral = GetPatientReferral(_TransPatientID);
                        if (dtReferral != null)
                        {
                            DataRow[] dr = dtReferral.Select("sReferralName='" + cmbBillingProvider.Text.Replace("'", "''") + "'");
                            if (dr.Length > 0)
                            {
                                isRefferalAgainstPatientExist = true;
                            }
                            dtReferral.Dispose();
                            dtReferral = null;
                        }

                        //for (int i = 0; i < cmbReferralProvider.Items.Count; i++)
                        //{
                        //    cmbReferralProvider.SelectedIndex = i;

                        //    if (cmbReferralProvider.Text == cmbBillingProvider.Text)
                        //    {
                        //        isRefferalAgainstPatientExist = true;
                        //        break;
                        //    }
                        //}


                        if (isRefferalAgainstPatientExist == false)
                        {
                            ///code


                            //for (int i = 0; i = cmbReferralProvider.Items.Count - 1; i++)
                            // {
                            DataTable dt = null;
                            dt = GetDetails(_ContactID);
                            //
                            if (dt != null && dt.Rows.Count > 0)
                            {
                                gloPatient.gloPatient ogloPatient = new gloPatient.gloPatient(_DatabaseConnectionString);
                                gloPatient.PatientDetails PatientReferrals = new gloPatient.PatientDetails();
                                gloPatient.PatientDetail _Referral = new gloPatient.PatientDetail();
                                _Referral.PatientID = _TransPatientID;
                                _Referral.ContactId = _ContactID;
                                _Referral.Name = Convert.ToString(dt.Rows[0]["sName"]);
                                _Referral.Contact = Convert.ToString(dt.Rows[0]["sContact"]);
                                _Referral.AddressLine1 = Convert.ToString(dt.Rows[0]["sAddressLine1"]);
                                _Referral.AddressLine2 = Convert.ToString(dt.Rows[0]["sAddressLine2"]);
                                _Referral.City = Convert.ToString(dt.Rows[0]["sCity"]);
                                _Referral.State = Convert.ToString(dt.Rows[0]["sState"]);
                                _Referral.ZIP = Convert.ToString(dt.Rows[0]["sZIP"]);
                                _Referral.Phone = Convert.ToString(dt.Rows[0]["sPhone"]);
                                _Referral.Fax = Convert.ToString(dt.Rows[0]["sFax"]);
                                _Referral.Email = Convert.ToString(dt.Rows[0]["sEmail"]);
                                _Referral.URL = Convert.ToString(dt.Rows[0]["sURL"]);
                                _Referral.Mobile = Convert.ToString(dt.Rows[0]["sMobile"]);
                                _Referral.Pager = Convert.ToString(dt.Rows[0]["sPager"]);
                                _Referral.Notes = Convert.ToString(dt.Rows[0]["sNotes"]);
                                _Referral.FirstName = Convert.ToString(dt.Rows[0]["sFirstName"]);
                                _Referral.MiddleName = Convert.ToString(dt.Rows[0]["sMiddleName"]);
                                _Referral.LastName = Convert.ToString(dt.Rows[0]["sLastName"]);
                                _Referral.Gender = Convert.ToString(dt.Rows[0]["sGender"]);
                                _Referral.Taxonomy = Convert.ToString(dt.Rows[0]["sTaxonomy"]);
                                _Referral.TaxonomyDesc = Convert.ToString(dt.Rows[0]["sTaxonomyDesc"]);
                                _Referral.TaxID = Convert.ToString(dt.Rows[0]["sTaxID"]);
                                _Referral.UPIN = Convert.ToString(dt.Rows[0]["sUPIN"]);
                                _Referral.NPI = Convert.ToString(dt.Rows[0]["sNPI"]);
                                _Referral.HospitalAffiliation = Convert.ToString(dt.Rows[0]["sHospitalAffiliation"]);
                                _Referral.ExternalCode = Convert.ToString(dt.Rows[0]["sExternalCode"]);
                                _Referral.Degree = Convert.ToString(dt.Rows[0]["sDegree"]);
                                _Referral.ContactFlag = gloPatient.PatientContactType.Referral;
                                _Referral.ClinicID = _ClinicID;
                                //_Referral.PatientDetailID=
                                PatientReferrals.Add(_Referral);
                                ogloPatient.Add_ReferraltoPatient(PatientReferrals);
                                _Referral.Dispose();
                                _Referral = null;
                                PatientReferrals.Dispose();
                                PatientReferrals = null;
                                ogloPatient.Dispose();
                                ogloPatient = null;

                            }
                            if (dt != null)
                            {
                                dt.Dispose();
                                dt = null;
                            }
                        }
                    }

                        //}
                    catch (Exception ex)
                    {
                        gloAuditTrail.gloAuditTrail.ExceptionLog(ex, false);
                        //ex.ToString();
                        //ex = null;
                    }
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show(ex.ToString(), _messageBoxCaption, MessageBoxButtons.OK, MessageBoxIcon.Information);
            }
            return _ContactID;
        }

        private DataTable GetDetails(Int64 contactID)
        {
            gloDatabaseLayer.DBLayer oDB = new gloDatabaseLayer.DBLayer(_DatabaseConnectionString);
            DataTable dt = null;
            try
            {
                oDB.Connect(false);

                string SqlQuery = "SELECT Contacts_MST.sName,ISNULL(Contacts_MST.sContact,'') AS sContact,  ISNULL(Contacts_MST.sAddressLine1,'') AS sAddressLine1, ISNULL(Contacts_MST.sAddressLine2,'') AS sAddressLine2, "
                + " ISNULL(Contacts_MST.sCity,'') AS sCity, ISNULL(Contacts_MST.sState,'') AS sState, ISNULL(Contacts_MST.sZIP,'') AS sZIP, ISNULL(Contacts_MST.sPhone,'') AS sPhone, "
                + " ISNULL(Contacts_MST.sFax,'') AS sFax, ISNULL(Contacts_MST.sEmail,'') AS sEmail, ISNULL(Contacts_MST.sURL, '') AS sURL, ISNULL(Contacts_MST.sMobile,'') AS sMobile, ISNULL(Contacts_MST.sPager,'') AS sPager, "
                + " ISNULL(Contacts_MST.sNotes,'') AS sNotes, ISNULL(Contacts_MST.sFirstName,'') AS sFirstName, ISNULL(Contacts_MST.sMiddleName,'') AS sMiddleName, ISNULL(Contacts_MST.sLastName,'') AS sLastName, "
                + " ISNULL(Contacts_MST.sGender,'') AS sGender, ISNULL(Contacts_Physician_DTL.sTaxonomy,'') AS sTaxonomy, ISNULL(Contacts_Physician_DTL.sTaxonomyDesc,'') AS sTaxonomyDesc, "
                + " ISNULL(Contacts_Physician_DTL.sTaxID,'') AS sTaxID, ISNULL(Contacts_Physician_DTL.sUPIN,'') AS sUPIN, ISNULL(Contacts_Physician_DTL.sNPI,'') AS sNPI, "
                + " ISNULL(Contacts_Physician_DTL.sHospitalAffiliation,'') AS sHospitalAffiliation, ISNULL(Contacts_Physician_DTL.sExternalCode,'') AS sExternalCode, ISNULL(Contacts_Physician_DTL.sDegree,'') AS sDegree"
                + " FROM Contacts_MST LEFT WITH (NOLOCK) OUTER JOIN Contacts_Physician_DTL WITH (NOLOCK) ON Contacts_MST.nContactID = Contacts_Physician_DTL.nContactID "
                + " WHERE (Contacts_MST.nContactID = " + contactID + ") ";


                SqlQuery += " AND (Contacts_MST.sContactType = 'Physician')";




                oDB.Retrive_Query(SqlQuery, out  dt);
            }
            catch (gloDatabaseLayer.DBException DBErr)
            {
                DBErr.ERROR_Log(DBErr.ToString());
            }
            catch (Exception ex)
            {
                MessageBox.Show(ex.ToString(), _messageBoxCaption, System.Windows.Forms.MessageBoxButtons.OK, System.Windows.Forms.MessageBoxIcon.Error);
            }
            finally
            {
                oDB.Disconnect();
                oDB.Dispose();
            }
            return dt;
        }

        private Int64 SaveData_RefferalProvider(Int64 ProviderID)
        {
            gloPMContacts.Physician oPhysician = new gloPMContacts.Physician();
            gloPMContacts.ContactDetails oCDetail = new gloPMContacts.ContactDetails();
            gloPMContacts.gloContacts ogloContacts = new gloPMContacts.gloContacts(_DatabaseConnectionString);
            // bool _Result = false;
            DataTable dtBillingProvider = null;
            dtBillingProvider = GetBillingProvider(ProviderID);
            try
            {
                if (dtBillingProvider != null && dtBillingProvider.Rows.Count > 0)
                {
                    oPhysician.LastName = dtBillingProvider.Rows[0]["sLastName"].ToString();
                    oPhysician.MiddleName = dtBillingProvider.Rows[0]["sMiddleName"].ToString();
                    oPhysician.FirstName = dtBillingProvider.Rows[0]["sFirstName"].ToString();
                    oPhysician.Gender = dtBillingProvider.Rows[0]["sGender"].ToString();
                    oPhysician.TaxID = "";
                    oPhysician.Taxonomy = dtBillingProvider.Rows[0]["sTaxonomy"].ToString();
                    oPhysician.TaxonomyDesc = dtBillingProvider.Rows[0]["sTaxonomyDesc"].ToString();
                    oPhysician.NPI = dtBillingProvider.Rows[0]["sNPI"].ToString();
                    oPhysician.UPIN = dtBillingProvider.Rows[0]["sUPIN"].ToString();
                    oPhysician.Mobile = dtBillingProvider.Rows[0]["sMobileNo"].ToString();
                    oPhysician.Pager = "";
                    oPhysician.CompanyAddress.AddrressLine1 = dtBillingProvider.Rows[0]["sCompanyAddressline1"].ToString();
                    oPhysician.CompanyAddress.AddrressLine2 = dtBillingProvider.Rows[0]["sCompanyAddressline2"].ToString();
                    oPhysician.CompanyAddress.City = dtBillingProvider.Rows[0]["sCompanyCity"].ToString();
                    oPhysician.CompanyAddress.State = dtBillingProvider.Rows[0]["sCompanyState"].ToString();
                    //oPhysician.CompanyAddress.ZIP = dtBillingProvider.Rows[0]["sCompanyAddressline1"].ToString();

                    //oPhysician.CompanyAddress.Phone = dtBillingProvider.Rows[0]["sCompanyAddressline1"].ToString();
                    oPhysician.CompanyAddress.ZIP = dtBillingProvider.Rows[0]["sCompanyZIP"].ToString();
                    oPhysician.CompanyAddress.Phone = dtBillingProvider.Rows[0]["sCompanyPhone"].ToString();
                    oPhysician.CompanyAddress.Fax = dtBillingProvider.Rows[0]["sCompanyFax"].ToString();

                    oPhysician.CompanyAddress.Email = dtBillingProvider.Rows[0]["sCompanyEmail"].ToString();
                    //oPhysician.CompanyAddress.URL = dtBillingProvider.Rows[0]["sCompanyAddressline1"].ToString();
                    oPhysician.BusinessMailingAddress.AddrressLine1 = dtBillingProvider.Rows[0]["sBusinessAddressline1"].ToString();
                    oPhysician.BusinessMailingAddress.AddrressLine2 = dtBillingProvider.Rows[0]["sBusinessAddressline2"].ToString(); ;
                    oPhysician.BusinessMailingAddress.City = dtBillingProvider.Rows[0]["sBusinessCity"].ToString(); ;
                    oPhysician.BusinessMailingAddress.State = dtBillingProvider.Rows[0]["sBusinessState"].ToString(); ;
                    oPhysician.BusinessMailingAddress.ZIP = dtBillingProvider.Rows[0]["sBusinessZIP"].ToString(); ;

                    oPhysician.BusinessMailingAddress.Phone = dtBillingProvider.Rows[0]["sBusPhoneNo"].ToString(); ;
                    oPhysician.BusinessMailingAddress.Fax = dtBillingProvider.Rows[0]["sBusFAX"].ToString(); ;
                    oPhysician.BusinessMailingAddress.Email = dtBillingProvider.Rows[0]["sBusEmail"].ToString(); ;
                    oPhysician.BusinessMailingAddress.URL = dtBillingProvider.Rows[0]["sBusURL"].ToString(); ;

                    oPhysician.PracticeLocationAddress.AddrressLine1 = dtBillingProvider.Rows[0]["sPracticeAddressline1"].ToString(); ;
                    oPhysician.PracticeLocationAddress.AddrressLine2 = dtBillingProvider.Rows[0]["sPracticeAddressline2"].ToString(); ;
                    oPhysician.PracticeLocationAddress.City = dtBillingProvider.Rows[0]["sPracticeCity"].ToString(); ;
                    oPhysician.PracticeLocationAddress.State = dtBillingProvider.Rows[0]["sPracticeState"].ToString(); ;
                    oPhysician.PracticeLocationAddress.ZIP = dtBillingProvider.Rows[0]["sPracticeZIP"].ToString(); ;

                    oPhysician.PracticeLocationAddress.Phone = dtBillingProvider.Rows[0]["sPracPhoneNo"].ToString(); ;
                    oPhysician.PracticeLocationAddress.Fax = dtBillingProvider.Rows[0]["sPracFAX"].ToString(); ;
                    oPhysician.PracticeLocationAddress.Email = dtBillingProvider.Rows[0]["sPracEmail"].ToString(); ;
                    oPhysician.PracticeLocationAddress.URL = dtBillingProvider.Rows[0]["sPracURL"].ToString(); ;

                    oPhysician.ContactType = Convert.ToString(gloPMContacts.ContactType.Physician);
                    //oPhysician.SpecialtyID = "";
                    oPhysician.Notes = "";
                }
                //New Contact
                if (_ContactID == 0)
                {
                    _ContactID = ogloContacts.Add(oPhysician);
                    //write code for add data into Contacts_Physician_DTL
                    Update_Patient_DTL(oPhysician);
                    //oCDetail = AddDetails();
                    //_ContactDetailID = ogloContacts.AddDetails(oCDetail);

                    return _ContactID;

                }
                //contact to modify 
            }
            catch (Exception ex)
            {
                gloAuditTrail.gloAuditTrail.ExceptionLog(ex, true);
            }
            //return _Result;
            return _ContactID;
        }

        private Int64 IsExistInContacts(Int64 ProviderID)
        {
            gloDatabaseLayer.DBLayer oDB = new gloDatabaseLayer.DBLayer(_DatabaseConnectionString);
            DataTable dt = null;
            string _sqlQuery = "";

            try
            {
                String sFirstName = "";
                String sLastName = "";
                String sNPI = "";
                oDB.Connect(false);
                _sqlQuery = "select sFirstName,sLastName,sNPI from dbo.Provider_MST WITH (NOLOCK) where nProviderID=" + ProviderID + "";
                oDB.Retrive_Query(_sqlQuery, out dt);
                if (dt != null)
                {
                    sFirstName = dt.Rows[0][0].ToString();
                    sLastName = dt.Rows[0][1].ToString();
                    sNPI = dt.Rows[0][2].ToString();

                    _sqlQuery = "SELECT Contacts_MST.nContactID FROM Contacts_MST WITH (NOLOCK) INNER JOIN Contacts_Physician_DTL WITH (NOLOCK) ON Contacts_MST.nContactID = Contacts_Physician_DTL.nContactID WHERE (Contacts_MST.sFirstName = '" + sFirstName.Replace("'", "''") + "') AND (Contacts_MST.sLastName = '" + sLastName.Replace("'", "''") + "') AND (Contacts_Physician_DTL.sNPI = '" + sNPI.Replace("'", "''") + "')";
                    oDB.Retrive_Query(_sqlQuery, out dt);
                    if (dt != null && dt.Rows.Count > 0)
                    {
                        return Convert.ToInt64(dt.Rows[0][0]);
                    }
                    else
                    {
                        return 0;
                    }
                }
                else
                {
                    return 0;
                }

            }
            catch (gloDatabaseLayer.DBException dbEx)
            {
                dbEx.ERROR_Log(dbEx.ToString());
            }
            catch (Exception ex)
            {
                gloAuditTrail.gloAuditTrail.ExceptionLog(ex, true);
            }
            finally
            {
                if (oDB != null) { oDB.Disconnect(); oDB.Dispose(); }
                if (dt != null) { dt.Dispose(); }
            }
            return 0;
        }

        private DataTable GetBillingProvider(Int64 ProviderID)
        {
            gloDatabaseLayer.DBLayer oDB = new gloDatabaseLayer.DBLayer(_DatabaseConnectionString);
            DataTable dt = null;
            string _sqlQuery = "";

            try
            {

                oDB.Connect(false);
                _sqlQuery = "select sFirstName,sMiddleName,sLastName,sGender,sTaxonomy,sTaxonomyDesc,sNPI,sUPIN,sMobileNo, "
                           + " sCompanyAddressline1,sCompanyAddressline2,sCompanyCity,sCompanyState,sCompanyZIP,sCompanyPhone,sCompanyFax,sCompanyEmail, "
                           + " sBusinessAddressline1,sBusinessAddressline2,sBusinessCity,sBusinessState,sBusinessZIP,sBusPhoneNo,sBusFAX,sBusEmail,sBusURL, "
                           + " sPracticeAddressline1,sPracticeAddressline2,sPracticeCity,sPracticeState,sPracticeZIP,sPracPhoneNo,sPracFAX,sPracEmail,sPracURL "
                           + " from dbo.Provider_MST WITH (NOLOCK) where nProviderID=" + ProviderID + "";
                oDB.Retrive_Query(_sqlQuery, out dt);

                //if (dt != null)
                //{
                return dt;
                // }
                // return null; 
            }
            catch (gloDatabaseLayer.DBException dbEx)
            {
                dbEx.ERROR_Log(dbEx.ToString());
            }
            catch (Exception ex)
            {
                gloAuditTrail.gloAuditTrail.ExceptionLog(ex, true);
            }
            finally
            {
                if (oDB != null) { oDB.Disconnect(); oDB.Dispose(); }
                //        if (dt != null) { dt.Dispose(); }
            }
            return dt;
        }

        private void Update_Patient_DTL(gloPMContacts.Physician oPhysician)
        {
            gloPatient.gloPatient oPatient = new gloPatient.gloPatient(_DatabaseConnectionString);
            gloPatient.PatientDetails oReffreals = new gloPatient.PatientDetails();
            gloPatient.PatientDetail oReffreal = new gloPatient.PatientDetail();
            oReffreal.ContactId = oPhysician.ContactID;
            oReffreal.PatientID = PatientID;
            oReffreal.FirstName = oPhysician.FirstName;
            oReffreal.MiddleName = oPhysician.MiddleName;
            oReffreal.LastName = oPhysician.LastName;
            oReffreal.NPI = oPhysician.NPI;
            oReffreals.Add(oReffreal);
            oPatient.Add_ReferraltoPatient(oReffreals);
            oReffreal.Dispose();
            oReffreal = null;
            oReffreals.Dispose();
            oReffreals = null;
            oPatient.Dispose();
            oPatient = null;
        }

        #endregion

        private void GetPatientProvider(Int64 PatientId)
        {
            gloPatient.gloPatient ogloPatient = new gloPatient.gloPatient(_DatabaseConnectionString);
            DataTable dtPatientProvider = null;

            try
            {

                dtPatientProvider = ogloPatient.GetPatientProvider(PatientId, this.ClinicID);
                if (dtPatientProvider != null && dtPatientProvider.Rows.Count > 0)
                {
                    //nProviderID,ProviderName
                    _PatientPoviderID = Convert.ToInt64(dtPatientProvider.Rows[0]["nProviderID"]);
                    _PatientProviderName = Convert.ToString(dtPatientProvider.Rows[0]["ProviderName"]);
                }
            }
            catch (Exception ex)
            {
                gloAuditTrail.gloAuditTrail.ExceptionLog(ex, true);

            }
            finally
            {
                if (ogloPatient != null) { ogloPatient.Dispose(); ogloPatient = null; }
                if (dtPatientProvider != null) { dtPatientProvider.Dispose(); dtPatientProvider = null; }
            }
        }

        private DataTable GetPatientReferral(Int64 PatientId)
        {
            gloDatabaseLayer.DBLayer oDB = new gloDatabaseLayer.DBLayer(_DatabaseConnectionString);
            DataTable dtReferrals = null;
            string _sqlQuery = "";

            try
            {
                oDB.Connect(false);
                //20100622 gloPM5050 Debasish
                _sqlQuery = "SELECT  ISNULL(Contacts_MST.nContactID,0) as nReferralID, " +
                            " ISNULL(Contacts_MST.sFirstName,'') + SPACE(1) + ISNULL(Contacts_MST.sMiddleName,'') +SPACE(1)+ISNULL(Contacts_MST.sLastName,'') AS sReferralName  " +
                            " FROM Contacts_MST WITH (NOLOCK) LEFT OUTER JOIN Contacts_Physician_DTL WITH (NOLOCK) ON Contacts_MST.nContactID = Contacts_Physician_DTL.nContactID " +
                            " WHERE(ISNULL(Contacts_MST.bIsBlocked,0) = 0) AND (Contacts_MST.sContactType = 'Physician')  and Contacts_MST.nContactID IN " +
                            " (Select nContactID from Patient_DTL WITH (NOLOCK) where nPatientID=" + PatientId + " and ISNULL(nContactFlag,0)=3) ";

                oDB.Retrive_Query(_sqlQuery, out dtReferrals);
            }
            catch (gloDatabaseLayer.DBException dbEx)
            {
                dbEx.ERROR_Log(dbEx.ToString());
            }
            catch (Exception ex)
            {
                gloAuditTrail.gloAuditTrail.ExceptionLog(ex, true);
            }
            finally
            {
                oDB.Disconnect();
                if (oDB != null) { oDB.Dispose(); }
                if (dtReferrals != null) { dtReferrals.Dispose(); }
            }

            return dtReferrals;
        }

        private void LoadDefaultSettings()
        {
            gloAppointmentBook.Books.Resource oResource = new gloAppointmentBook.Books.Resource(_DatabaseConnectionString);

            try
            {

                #region " Commented Code "

                //gloBilling ogloBill = new gloBilling(_DatabaseConnectionString, "");
                //DataTable dt = new DataTable();
                //if (cmbBillingProvider.SelectedIndex != -1)
                //{
                //    dt = ogloBill.GetProviderSettings(Convert.ToInt64(cmbBillingProvider.SelectedValue));
                //    if (dt != null)
                //    {
                //        if (dt.Rows.Count > 0)
                //        {

                //            for (int i = 0; i < dt.Rows.Count; i++)
                //            {
                //                switch (Convert.ToString(dt.Rows[i][0]))
                //                {
                //                    case "TypeOfService":
                //                        UC_gloBillingTransactionLines.DefaultTOSID = Convert.ToInt64(dt.Rows[i]["sValue"]);
                //                        break;
                //                    case "PlaceOfService":
                //                        UC_gloBillingTransactionLines.DefaultPOSID = Convert.ToInt64(dt.Rows[i]["sValue"]);
                //                        break;
                //                    case "BillingProvider":
                //                        break;
                //                    case "RenderingProvider":
                //                        {
                //                            //gloBilling ogloBilling = new gloBilling(_DatabaseConnectionString, "");

                //                            //if (Convert.ToInt64(dt.Rows[i]["sValue"]) != null && Convert.ToInt64(dt.Rows[i]["sValue"]) > 0)
                //                            //{
                //                            //    UC_gloBillingTransactionLines.DefaultRenderingProviderID = Convert.ToInt64(dt.Rows[i]["sValue"]);
                //                            //    UC_gloBillingTransactionLines.DefaultRenderringProviderName = ogloBill.GetProvider(Convert.ToInt64(dt.Rows[i]["sValue"]));

                //                            //}
                //                            //else
                //                            //{
                //                            //    UC_gloBillingTransactionLines.DefaultRenderingProviderID = 0;
                //                            //    UC_gloBillingTransactionLines.DefaultRenderringProviderName = "";
                //                            //}

                //                        }
                //                        break;
                //                    case "Facility":
                //                        cmbFacility.SelectedValue = Convert.ToString(dt.Rows[i]["sValue"]);
                //                        break;

                //                }
                //            }

                //        }
                //    }
                //}

                #endregion " Commented Code "

                if (UC_gloBillingTransactionLines != null)
                {

                    #region " Set the Renderring Provider "

                    //****************************************************************************
                    //Set the Patient Provider as the Renderring Provider
                    //If Patient Provider not present set the selected Billing Provider from combo
                    //as the Renderring Provider
                    //****************************************************************************

                    //20100503 - Hot Fix Referral Provider Issue - Laod the Referral Provider From Admin settings and apply to service lines
                    if (this.RenderingProviderID > 0)
                    {
                        UC_gloBillingTransactionLines.DefaultRenderingProviderID = this.RenderingProviderID;
                        UC_gloBillingTransactionLines.DefaultRenderringProviderName = oResource.GetProviderName(this.RenderingProviderID);
                        UC_gloBillingTransactionLines.BillingProviderID = Convert.ToInt64(cmbBillingProvider.SelectedValue);
                    }
                    else if (this.PatientPoviderID > 0)
                    {
                        UC_gloBillingTransactionLines.DefaultRenderingProviderID = this.PatientPoviderID;
                        UC_gloBillingTransactionLines.DefaultRenderringProviderName = this.PatientProviderName;
                        UC_gloBillingTransactionLines.BillingProviderID = Convert.ToInt64(cmbBillingProvider.SelectedValue);
                    }
                    else
                    {
                        if (cmbBillingProvider != null && cmbBillingProvider.Items.Count > 0)
                        {
                            if (cmbBillingProvider.SelectedIndex != -1)
                            {
                                UC_gloBillingTransactionLines.DefaultRenderingProviderID = Convert.ToInt64(cmbBillingProvider.SelectedValue);
                                UC_gloBillingTransactionLines.DefaultRenderringProviderName = Convert.ToString(cmbBillingProvider.Text);
                                UC_gloBillingTransactionLines.BillingProviderID = Convert.ToInt64(cmbBillingProvider.SelectedValue);
                            }
                        }
                    }

                    #endregion " Set the Renderring Provider "

                    //if (oResource != null)
                    //{
                    //    oResource.Dispose();

                    //}
                }

                #region " Set the Facility "

                if (cmbFacility != null && cmbFacility.Items.Count > 0)
                {
                    if (cmbFacility.SelectedIndex == -1)
                    {
                        cmbFacility.SelectedIndex = 0;
                    }

                    if (UC_gloBillingTransactionLines != null && cmbFacility.SelectedIndex != -1)
                    {
                        UC_gloBillingTransactionLines.FacilityID = Convert.ToInt64(cmbFacility.SelectedValue);
                        SetFacility();
                    }
                }

                #endregion " Set the Facility "
            }
            catch (Exception ex)
            {
                gloAuditTrail.gloAuditTrail.ExceptionLog(ex, true);
            }
            finally
            {
                if (oResource != null) { oResource.Dispose(); }
            }
        }

        private void FillPatientInsurances_Old(Int64 PatientID)
        {
            DataTable dtPatientInsurances = null;
            gloBilling ogloBilling = new gloBilling(_DatabaseConnectionString, _emrdatabaseConnectionString);
            gloPatient.gloPatient ogloPatient = new gloPatient.gloPatient(_DatabaseConnectionString);

            bool _IsPrimaryPresent = false;
            bool _HasInsurance = true;


            try
            {

                dtPatientInsurances = ogloPatient.getPatientInsurances(_TransPatientID);
                c1Insurance.Rows.Count = 1;

                if (dtPatientInsurances != null && dtPatientInsurances.Rows.Count > 0)
                {
                    //nInsuranceID,InsuranceName ,sSubscriberID,sSubscriberName,sSubscriberPolicy#,sGroup,
                    //sPhone ,bPrimaryFlag,dtDOB,dtEffectiveDate,dtExpiryDate,sSubscriberID
                    for (int i = 0; i < dtPatientInsurances.Rows.Count; i++)
                    {
                        if (dtPatientInsurances.Rows[i]["sInsuranceFlag"] != null &&
                            dtPatientInsurances.Rows[i]["sInsuranceFlag"] != DBNull.Value &&
                            Convert.ToString(dtPatientInsurances.Rows[i]["sInsuranceFlag"]) != "" &&
                            Convert.ToInt32(dtPatientInsurances.Rows[i]["nInsuranceFlag"]) != InsuranceTypeFlag.None.GetHashCode())
                        {

                            c1Insurance.Rows.Add();
                            int rowIndex = c1Insurance.Rows.Count - 1;
                            c1Insurance.SetData(rowIndex, COL_SELECT, false);//Select-CheckBox
                            //Select-CheckBox
                            c1Insurance.SetData(rowIndex, COL_INSURANCENAME, Convert.ToString(dtPatientInsurances.Rows[i]["InsuranceName"])); //
                            c1Insurance.SetData(rowIndex, COL_INSURANCEID, Convert.ToString(dtPatientInsurances.Rows[i]["nInsuranceID"])); //
                            c1Insurance.SetData(rowIndex, COL_INSSELFMODE, PayerMode.Insurance.GetHashCode()); //
                            c1Insurance.SetData(rowIndex, COL_INSURANCETYPE, Convert.ToString(dtPatientInsurances.Rows[i]["sInsuranceFlag"]));

                            //c1Insurance.SetData(rowIndex, COL_INSURANCERESPONSIBILITY, (InsuranceTypeFlag)Convert.ToInt32(dtPatientInsurances.Rows[i]["nInsuranceFlag"]));

                            c1Insurance.SetData(rowIndex, COL_INSURANCERESPONSIBILITY, rowIndex);

                            if (Convert.ToInt32(dtPatientInsurances.Rows[i]["nInsuranceFlag"]) == InsuranceTypeFlag.Primary.GetHashCode())
                            {
                                c1Insurance.SetData(rowIndex, COL_SELECT, true);
                                _IsPrimaryPresent = true;
                            }
                            c1Insurance.SetData(rowIndex, COL_INSURANCECOPAYAMT, Convert.ToDecimal(dtPatientInsurances.Rows[i]["CoPay"]));

                            if (Convert.ToBoolean(dtPatientInsurances.Rows[i]["bWorkersComp"]) == true)
                                c1Insurance.SetData(rowIndex, COL_INSURANCEWORKERCOMP, true);

                            if (Convert.ToBoolean(dtPatientInsurances.Rows[i]["bAutoClaim"]) == true)
                                c1Insurance.SetData(rowIndex, COL_INSURANCEAUTOCLAIM, "Auto Claim");

                            c1Insurance.SetData(rowIndex, COL_INSURANCECONTACTID, Convert.ToString(dtPatientInsurances.Rows[i]["nContactID"])); //

                        }

                    }

                }
                else
                {
                    _HasInsurance = false;
                }

                c1Insurance.Rows.Add();
                c1Insurance.SetData(c1Insurance.Rows.Count - 1, COL_SELECT, false);//Select-CheckBox
                c1Insurance.SetData(c1Insurance.Rows.Count - 1, COL_INSURANCERESPONSIBILITY, c1Insurance.Rows.Count - 1);
                c1Insurance.SetData(c1Insurance.Rows.Count - 1, COL_INSURANCENAME, "Self"); //
                c1Insurance.SetData(c1Insurance.Rows.Count - 1, COL_INSURANCEID, 0); //
                c1Insurance.SetData(c1Insurance.Rows.Count - 1, COL_INSSELFMODE, PayerMode.Self.GetHashCode()); //
                c1Insurance.SetData(c1Insurance.Rows.Count - 1, COL_INSURANCECONTACTID, 0);
                //Check if Insurance/Insurances Present for Patient & has primary insurance is
                //not set then select the 1st Insurance in grid
                if (_HasInsurance == true && _IsPrimaryPresent == false)
                {
                    c1Insurance.SetCellCheck(1, COL_SELECT, CheckEnum.Checked);
                }
                else if (_HasInsurance == false)
                {
                    c1Insurance.SetCellCheck((c1Insurance.Rows.Count - 1), COL_SELECT, CheckEnum.Checked);
                }
                //
                c1Insurance.Cols[COL_SELECT].AllowEditing = true;
                c1Insurance.Cols[COL_INSURANCERESPONSIBILITY].AllowEditing = true;
                c1Insurance.Cols[COL_INSURANCETYPE].AllowEditing = false;
                c1Insurance.Cols[COL_INSURANCENAME].AllowEditing = false;
                c1Insurance.Cols[COL_INSURANCEID].AllowEditing = false;
                c1Insurance.Cols[COL_INSSELFMODE].AllowEditing = false;
                c1Insurance.Cols[COL_INSURANCECOPAYAMT].AllowEditing = false;
                c1Insurance.Cols[COL_INSURANCECONTACTID].AllowEditing = false;
            }
            catch (Exception ex)
            {
                gloAuditTrail.gloAuditTrail.ExceptionLog(ex, true);

            }
            finally
            {
                if (ogloBilling != null) { ogloBilling.Dispose(); }
                if (ogloPatient != null) { ogloPatient.Dispose(); }
            }
        }

        private void FillPatientInsurances(Int64 PatientID)
        {
            c1Insurance.CellChanged -= new C1.Win.C1FlexGrid.RowColEventHandler(this.c1Insurance_CellChanged);

            DataTable dtPatientInsurances = null;
            gloBilling ogloBilling = new gloBilling(_DatabaseConnectionString, _emrdatabaseConnectionString);
            gloPatient.gloPatient ogloPatient = new gloPatient.gloPatient(_DatabaseConnectionString);

            bool _IsPrimaryPresent = false;
            bool _HasInsurance = true;

            int _CntPrimary = 0;
            //DataTable dtPartyStatus;

            try
            {


                dtPatientInsurances = ogloPatient.getPatientInsurances(_TransPatientID);

                c1Insurance.Rows.Count = 1;

                this.c1Insurance.Rows.RemoveRange(1, (this.c1Insurance.Rows.Count - 1));
                //Added by Subashish_b on 16/Feb /2011 (integration made on date-10/May/2011) for declaring variable to count responsibility no
                CountResponsibilityNo = 0;
                //End

                if (dtPatientInsurances != null && dtPatientInsurances.Rows.Count > 0)
                {
                    //nInsuranceID,InsuranceName ,sSubscriberID,sSubscriberName,sSubscriberPolicy#,sGroup,
                    //sPhone ,bPrimaryFlag,dtDOB,dtEffectiveDate,dtExpiryDate,sSubscriberID
                    for (int i = 0; i < dtPatientInsurances.Rows.Count; i++)
                    {
                        if (dtPatientInsurances.Rows[i]["sInsuranceFlag"] != null &&
                            dtPatientInsurances.Rows[i]["sInsuranceFlag"] != DBNull.Value &&
                            Convert.ToString(dtPatientInsurances.Rows[i]["sInsuranceFlag"]) != "" &&
                            Convert.ToInt32(dtPatientInsurances.Rows[i]["nInsuranceFlag"]) != InsuranceTypeFlag.None.GetHashCode())
                        {

                            c1Insurance.Rows.Add();
                            int rowIndex = c1Insurance.Rows.Count - 1;
                            c1Insurance.SetData(rowIndex, COL_SELECT, false);//Select-CheckBox
                            //Select-CheckBox
                            c1Insurance.SetData(rowIndex, COL_INSURANCENAME, Convert.ToString(dtPatientInsurances.Rows[i]["InsuranceName"])); //
                            c1Insurance.SetData(rowIndex, COL_INSURANCEID, Convert.ToString(dtPatientInsurances.Rows[i]["nInsuranceID"])); //
                            c1Insurance.SetData(rowIndex, COL_INSSELFMODE, PayerMode.Insurance.GetHashCode()); //
                            c1Insurance.SetData(rowIndex, COL_INSURANCETYPE, Convert.ToString(dtPatientInsurances.Rows[i]["sInsuranceFlag"]));

                            //c1Insurance.SetData(rowIndex, COL_INSURANCERESPONSIBILITY, (InsuranceTypeFlag)Convert.ToInt32(dtPatientInsurances.Rows[i]["nInsuranceFlag"]));
                            //c1Insurance.SetData(rowIndex, COL_INSURANCERESPONSIBILITY, Convert.ToString(""));
                            c1Insurance.SetData(rowIndex, COL_INSURANCERESPONSIBILITY, dtPatientInsurances.Rows[i]["nInsuranceFlag"].ToString());
                            c1Insurance.SetData(rowIndex, COL_INSURANCEPARTY, Convert.ToString("X"));
                            //Added by Subashish_b on 16/Feb /2011 (integration made on date-10/May/2011) for  storing the responsibility no
                            CountResponsibilityNo = Convert.ToInt64(dtPatientInsurances.Rows[i]["nInsuranceFlag"].ToString());
                            //End 

                            if (Convert.ToInt32(dtPatientInsurances.Rows[i]["nInsuranceFlag"]) == InsuranceTypeFlag.Primary.GetHashCode())
                            {
                                c1Insurance.SetData(rowIndex, COL_SELECT, true);
                                _CntPrimary = _CntPrimary + 1;
                                _IsPrimaryPresent = true;
                            }
                            c1Insurance.SetData(rowIndex, COL_INSURANCECOPAYAMT, Convert.ToDecimal(dtPatientInsurances.Rows[i]["CoPay"]));

                            if (Convert.ToBoolean(dtPatientInsurances.Rows[i]["bWorkersComp"]) == true)
                                c1Insurance.SetData(rowIndex, COL_INSURANCEWORKERCOMP, true);

                            if (Convert.ToBoolean(dtPatientInsurances.Rows[i]["bAutoClaim"]) == true)
                                c1Insurance.SetData(rowIndex, COL_INSURANCEAUTOCLAIM, "Auto Claim");

                            c1Insurance.SetData(rowIndex, COL_INSURANCECONTACTID, Convert.ToString(dtPatientInsurances.Rows[i]["nContactID"])); //

                            ////if (dtPartyStatus.Rows.Count > 0 && dtPartyStatus != null)
                            ////{
                            ////    for (int iCount = 0; iCount <= dtPartyStatus.Rows.Count - 1; iCount++)
                            ////    {
                            ////        if (Convert.ToString(dtPatientInsurances.Rows[i]["nContactID"]) == Convert.ToString(dtPartyStatus.Rows[iCount]["nContactID"]))
                            ////        {
                            ////            c1Insurance.SetData(rowIndex, COL_INSVIEW_PARTYSTATUS, Convert.ToString(dtPartyStatus.Rows[iCount]["PartyStatus"])); //
                            ////        }
                            ////    }
                            ////}
                        }

                        //if (Convert.ToBoolean(dtPatientInsurances.Rows[i]["bPrimaryFlag"]))
                        //{
                        //    c1Insurance.SetData(rowIndex, COL_INSURANCETYPE, "Primary"); //
                        //    c1Insurance.SetData(rowIndex, COL_SELECT, true);
                        //    _IsPrimaryPresent = true;
                        //}

                    }

                }
                else
                {
                    _HasInsurance = false;
                }

                c1Insurance.Rows.Add();
                c1Insurance.SetData(c1Insurance.Rows.Count - 1, COL_SELECT, false);//Select-CheckBox
                //c1Insurance.SetData(c1Insurance.Rows.Count - 1, COL_INSURANCERESPONSIBILITY, Convert.ToString(""));
                //Added by Subashish_b on 16/Feb /2011 (integration made on date-10/May/2011) for  assigning the (responsibility no +1) to the C1 grid
                c1Insurance.SetData(c1Insurance.Rows.Count - 1, COL_INSURANCERESPONSIBILITY, (CountResponsibilityNo + 1).ToString());
                //End 
                c1Insurance.SetData(c1Insurance.Rows.Count - 1, COL_INSURANCEPARTY, Convert.ToString("X"));
                c1Insurance.SetData(c1Insurance.Rows.Count - 1, COL_INSURANCENAME, "Self"); //
                c1Insurance.SetData(c1Insurance.Rows.Count - 1, COL_INSURANCEID, 0); //
                c1Insurance.SetData(c1Insurance.Rows.Count - 1, COL_INSSELFMODE, PayerMode.Self.GetHashCode()); //
                c1Insurance.SetData(c1Insurance.Rows.Count - 1, COL_INSURANCECONTACTID, 0);
                //Check if Insurance/Insurances Present for Patient & has primary insurance is
                //not set then select the 1st Insurance in grid
                if (_HasInsurance == true && _IsPrimaryPresent == false)
                {
                    c1Insurance.SetCellCheck(1, COL_SELECT, CheckEnum.Checked);
                }
                else if (_HasInsurance == false)
                {
                    c1Insurance.SetCellCheck((c1Insurance.Rows.Count - 1), COL_SELECT, CheckEnum.Checked);
                }
                //
                c1Insurance.Cols[COL_SELECT].AllowEditing = true;
                c1Insurance.Cols[COL_INSURANCERESPONSIBILITY].AllowEditing = true;
                c1Insurance.Cols[COL_INSURANCETYPE].AllowEditing = false;
                c1Insurance.Cols[COL_INSURANCENAME].AllowEditing = false;
                c1Insurance.Cols[COL_INSURANCEID].AllowEditing = false;
                c1Insurance.Cols[COL_INSSELFMODE].AllowEditing = false;
                c1Insurance.Cols[COL_INSURANCECOPAYAMT].AllowEditing = false;
                c1Insurance.Cols[COL_INSURANCECONTACTID].AllowEditing = false;

                //c1Insurance.SetCellImage(1, COL_INSURANCERESPONSIBILITY, null);
                //System.Drawing.Image imgFlag = global::gloBilling.Properties.Resources.Normal_Priority;
                //c1Insurance.SetCellImage(1, COL_INSURANCERESPONSIBILITY, imgFlag);

                c1Insurance.CellChanged += new C1.Win.C1FlexGrid.RowColEventHandler(this.c1Insurance_CellChanged);

            }
            catch (Exception ex)
            {
                gloAuditTrail.gloAuditTrail.ExceptionLog(ex, true);

            }
            finally
            {
                if (IsBatchModify == false)
                {
                    SetInsuranceResponsibility(_CntPrimary);
                }
                ChangeInsuranceGridColor();

                if (ogloPatient != null) { ogloPatient.Dispose(); }
                if (ogloBilling != null) { ogloBilling.Dispose(); }
            }
            c1Insurance.Select(1, 1);
        }

        private void SetInsuranceResponsibility(int CntPrimary)
        {
            try
            {
                c1Insurance.CellChanged -= new C1.Win.C1FlexGrid.RowColEventHandler(this.c1Insurance_CellChanged);

                for (int i = 1; i < c1Insurance.Rows.Count; i++)
                {
                    if (CntPrimary > 1)
                    {
                        c1Insurance.SetData(i, COL_INSURANCEPARTY, Convert.ToChar("X"));
                        c1Insurance.SetData(i, COL_INSURANCERESPONSIBILITY, Convert.ToString(""));

                    }
                    else
                    {
                        c1Insurance.SetData(i, COL_INSURANCEPARTY, Convert.ToChar(i.ToString()));
                        c1Insurance.SetData(i, COL_INSURANCERESPONSIBILITY, Convert.ToChar(i.ToString()));

                    }
                }
                c1Insurance.CellChanged += new C1.Win.C1FlexGrid.RowColEventHandler(this.c1Insurance_CellChanged);
            }
            catch (Exception ex)
            {
                gloAuditTrail.gloAuditTrail.ExceptionLog(ex, false);
            }
        }

        private void SelectPrimaryInsurance()
        {
            bool _IsSelected = false;
            try
            {
                if (c1Insurance != null && c1Insurance.Rows.Count > 1)
                {
                    for (int i = 1; i <= c1Insurance.Rows.Count - 1; i++)
                    {
                        if (Convert.ToString(c1Insurance.GetData(i, COL_INSURANCETYPE)) == "Primary")
                        {
                            c1Insurance.SetCellCheck(i, COL_SELECT, CheckEnum.Checked);
                            _IsSelected = true;
                        }
                    }

                    //If no Insurance is present the select the Self mode
                    if (_IsSelected == false) { c1Insurance.SetCellCheck(c1Insurance.Rows.Count - 1, COL_SELECT, CheckEnum.Checked); }
                }
            }
            catch (Exception ex)
            {
                gloAuditTrail.gloAuditTrail.ExceptionLog(ex, true);

            }
        }

        private void ShowVoidMessage()
        {
            if (IsClaimVoided == true)
            {
                if (lblmsgVoid.Text != "")
                {
                    lblmsgVoid.Text = "";
                }
                else
                {
                    //lblmsgVoid.Text = "Voided";
                    lblmsgVoid.Text = VoidMessage;

                }
            }
            else
            {
                lblmsgVoid.Text = "";
            }
        }

        private void FetchVoidedInformation()
        {
            #region "Fetch Voided Information"

            DataTable _dt = null;
            try
            {
                _dt = gloCharges.GetVoidedInformation(_MasterTransactionID);
                if (_dt != null && _dt.Rows.Count > 0)
                {
                    lblmsgVoid.Text = "Voided  [" + Convert.ToString(_dt.Rows[0]["VoidUserName"]) + "]  on " + Convert.ToString(_dt.Rows[0]["nVoidCloseDate"]).ToLower() + "";
                    VoidMessage = "Voided [" + Convert.ToString(_dt.Rows[0]["VoidUserName"]) + "] on " + Convert.ToString(_dt.Rows[0]["nVoidCloseDate"]).ToLower() + "";
                }

                GetReplacementClaimIndication();
            }
            catch (Exception Ex)
            {
                gloAuditTrail.gloAuditTrail.ExceptionLog(Ex, true);
            }
            finally
            {
            }

            #endregion
        }

        #region "Retreive Claim Ref. No."

        private string getClaimRefNo(Int64 MasterTransactionID, Int64 InsuranceID, Int64 ContactID, Int64 ClinicID)
        {

            gloDatabaseLayer.DBLayer oDB = new gloDatabaseLayer.DBLayer(_DatabaseConnectionString);
            oDB.Connect(false);
            try
            {
                DataTable dtClaimRefNo = null;
                string _strClaimRefNoQuery = "";
                string _strClaimRefNo = "";
                _strClaimRefNoQuery = "SELECT  isnull(sClaimRemittanceRefNo,'') as sClaimRemittanceRefNo " +
            " FROM BL_Transaction_ClaimRemittanceRef WITH (NOLOCK) " +
            " WHERE (nTransactionID = " + MasterTransactionID + " and nContactID = " + ContactID + " and nInsuranceID = " + InsuranceID + " and nclinicid= " + ClinicID + ")";
                oDB.Retrive_Query(_strClaimRefNoQuery, out dtClaimRefNo);
                if (dtClaimRefNo != null)
                {
                    if (dtClaimRefNo.Rows.Count > 0)
                    {
                        _strClaimRefNo = Convert.ToString(dtClaimRefNo.Rows[0]["sClaimRemittanceRefNo"]); ;

                    }
                }
                dtClaimRefNo.Dispose();
                return _strClaimRefNo;
            }
            catch (Exception Ex)
            {
                gloAuditTrail.gloAuditTrail.ExceptionLog(Ex, false);
                return "";
            }
            finally
            {

                oDB.Disconnect();
                oDB.Dispose();
            }

        }
        #endregion

        #endregion

        #region "Patient List Control Methods & Events"

        private void LoadPatientList(bool IsEMRPatientList)
        {
            try
            {
                if (oListControl != null)
                {
                    for (int i = pnlListContainer.Controls.Count - 1; i >= 0; i--)
                    {
                        if (pnlListContainer.Controls[i].Name == oListControl.Name)
                        {
                            pnlListContainer.Controls.Remove(pnlListContainer.Controls[i]);
                            break;
                        }
                    }
                    try
                    {
                        try
                        {
                            oListControl.ItemSelectedClick -= new gloListControl.gloListControl.ItemSelected(oListControl_ItemSelectedClick);
                        }
                        catch
                        {

                        }
                        try
                        {
                            oListControl.ItemClosedClick -= new gloListControl.gloListControl.ItemClosed(oListControl_ItemClosedClick);
                        }
                        catch
                        {

                        }


                    }
                    catch
                    {
                    }
                    oListControl.Dispose();
                    oListControl = null;
                }

                if (IsEMRPatientList)
                {
                    oListControl = new gloListControl.gloListControl(_emrdatabaseConnectionString, gloListControl.gloListControlType.EMRPatient, false, this.Width);
                    oListControl.ControlHeader = " EMR Patient";
                    oListControl.ClinicID = _ClinicID;
                    _CurrentControlType = gloListControl.gloListControlType.EMRPatient;
                }
                else
                {
                    oListControl = new gloListControl.gloListControl(_DatabaseConnectionString, gloListControl.gloListControlType.Patient, false, this.Width);
                    oListControl.ClinicID = _ClinicID;
                    oListControl.ControlHeader = " Patient";
                    _CurrentControlType = gloListControl.gloListControlType.Patient;
                }

                oListControl.ItemSelectedClick += new gloListControl.gloListControl.ItemSelected(oListControl_ItemSelectedClick);
                oListControl.ItemClosedClick += new gloListControl.gloListControl.ItemClosed(oListControl_ItemClosedClick);

                tls_btnCancel.Enabled = false;

                pnlTransactionMaster.Visible = false;
                pnlTransactionLines.Visible = false;
                pnlTransactionOther1.Visible = false;
                pnlToolStrip.Visible = false;

                pnlListContainer.Visible = true;
                pnlListContainer.BringToFront();

                pnlListContainer.Controls.Add(oListControl);

                oListControl.OpenControl();
                oListControl.Dock = DockStyle.Fill;
                oListControl.BringToFront();

            }
            catch (Exception ex)
            {
                gloAuditTrail.gloAuditTrail.ExceptionLog(ex, true);
            }

        }

        void oListControl_ItemClosedClick(object sender, EventArgs e)
        {
            try
            {

                if (oListControl != null)
                {
                    for (int i = pnlListContainer.Controls.Count - 1; i >= 0; i--)
                    {
                        if (pnlListContainer.Controls[i].Name == oListControl.Name)
                        {
                            pnlListContainer.Controls.Remove(pnlListContainer.Controls[i]);
                            break;
                        }
                    }
                    try
                    {
                        try
                        {
                            oListControl.ItemSelectedClick -= new gloListControl.gloListControl.ItemSelected(oListControl_ItemSelectedClick);
                        }
                        catch
                        {
                        }
                        try
                        {
                            oListControl.ItemClosedClick -= new gloListControl.gloListControl.ItemClosed(oListControl_ItemClosedClick);
                        }
                        catch
                        {
                        }


                    }
                    catch
                    {
                    }

                }

                tls_btnCancel.Enabled = true;
                pnlTransactionMaster.Visible = true;
                pnlTransactionLines.Visible = true;
                pnlTransactionOther1.Visible = false;
                pnlToolStrip.Visible = true;

                pnlListContainer.Visible = false;
                pnlListContainer.SendToBack();

            }
            catch (Exception ex)
            {
                gloAuditTrail.gloAuditTrail.ExceptionLog(ex, true);

            }
        }

        void oListControl_ItemSelectedClick(object sender, EventArgs e)
        {
            try
            {
                switch (_CurrentControlType)
                {
                    case gloListControl.gloListControlType.Other:
                        break;
                    case gloListControl.gloListControlType.Patient:
                        {
                            if (oListControl.SelectedItems.Count > 0)
                            {
                                //oPatientControl.FillDetails(oListControl.SelectedItems[0].ID, gloPatientStripControl.FormName.Billing, 1, false);
                                //Added by Subashish_b on 9/Feb /2011 (integration made on date-10/May/2011) for  calling the filldetails event to get the _TransPatientID
                                oPatientControl.FillDetails(oListControl.SelectedItems[0].ID, gloStripControl.FormName.Billing, 1, false);
                                //End 
                                _TransPatientID = Convert.ToInt64(oListControl.SelectedItems[0].ID);
                                FillPatientInsurances(_TransPatientID);
                            }
                        }
                        break;
                    case gloListControl.gloListControlType.Insurance:
                        break;
                    case gloListControl.gloListControlType.PatientInsurence:
                        break;
                    default:
                        break;
                }
            }
            catch (Exception ex)
            {
                gloAuditTrail.gloAuditTrail.ExceptionLog(ex, true);
            }
            finally
            {
                tls_btnCancel.Enabled = true;
                pnlTransactionMaster.Visible = true;
                pnlTransactionLines.Visible = true;
                pnlTransactionOther1.Visible = false;
                pnlToolStrip.Visible = true;
                pnlListContainer.Visible = false;
                pnlListContainer.SendToBack();

            }
        }

        #endregion

        #region " Patient Strip Control Events "

        void oPatientControl_OnPatientSearchKeyPress(object sender, KeyPressEventArgs e)
        {

            string _sCloseDate = "";
            try
            {
                mskClaimDate.TextMaskFormat = MaskFormat.ExcludePromptAndLiterals;
                if (mskClaimDate.Text != null && Convert.ToString(mskClaimDate.Text) != "")
                {
                    _sCloseDate = mskClaimDate.Text;
                }
                mskClaimDate.TextMaskFormat = MaskFormat.IncludeLiterals;
                ClearData();
                ClearFormData();
                if (_sCloseDate != "")
                {
                    mskClaimDate.Text = _sCloseDate;
                }


                if (oPatientControl.CmbSelectedPatientID > 0)
                {

                    //_TransPatientID = oPatientControl.PatientID;
                    //oPatientControl.FillDetails(_TransPatientID, gloPatientStripControl.FormName.Billing, 1, false);


                    //Added by Subashish_b on 10/Feb /2011 (integration made on date-10/May/2011) for  calling the fildetails method with new patient banner object(gloStripControl.FormName.Billing)
                    oPatientControl.FillDetails(_TransPatientID, gloStripControl.FormName.Billing, 1, false);
                    _TransPatientID = oPatientControl.CmbSelectedPatientID;
                    //End 
                    FillPatientInsurances(_TransPatientID);
                    SelectPrimaryInsurance();

                    //DesignInsurancePaymentGrid();
                    //FillPaymentInsurances(_TransPatientID);
                    FillReferralProviders(_TransPatientID);

                    GetPatientProvider(_TransPatientID);

                    FillClaim(_TransPatientID);

                    if (cmbBillingProvider != null && cmbBillingProvider.Items.Count > 0 && PatientPoviderID != 0)
                    {
                        GetProviderSettings(PatientPoviderID);
                    }


                    if (UC_gloBillingTransactionLines != null)
                    {
                        UC_gloBillingTransactionLines.ReinitilizeControl();
                        UC_gloBillingTransactionLines.PatientID = this.PatientID;
                    }

                    #region "Get Selected Insurance"

                    string _fillInsuranceName = "";
                    Int64 _fillInsuranceID = 0;
                    Int32 _fillInsSelfMode = 0;

                    if (c1Insurance.Rows.Count > 0)
                    {
                        for (int i = 1; i <= c1Insurance.Rows.Count - 1; i++)
                        {
                            if (c1Insurance.GetCellCheck(i, COL_SELECT) == CheckEnum.Checked)
                            {
                                _fillInsuranceID = Convert.ToInt64(c1Insurance.GetData(i, COL_INSURANCEID));
                                _fillInsuranceName = Convert.ToString(c1Insurance.GetData(i, COL_INSURANCENAME));
                                _fillInsSelfMode = Convert.ToInt32(c1Insurance.GetData(i, COL_INSSELFMODE));
                                break;
                            }
                        }
                    }

                    if (UC_gloBillingTransactionLines != null)
                    {
                        if (_fillInsuranceID > 0)
                        {
                            UC_gloBillingTransactionLines.AddInsurance(UC_gloBillingTransactionLines.CurrentTransactionLine, _fillInsuranceID, _fillInsuranceName, _fillInsSelfMode);
                        }
                    }

                    #endregion

                    #region " Commanted Code "

                    // Saket 20090725 working but need to be tested
                    #region  "Load Providers default billing settings"

                    //gloSettings.GeneralSettings oSettings = new gloSettings.GeneralSettings(_DatabaseConnectionString);
                    //gloAppointmentBook.Books.Resource oResource = new gloAppointmentBook.Books.Resource(_DatabaseConnectionString);

                    //DataTable dtBillingSettings = new DataTable();
                    //dtBillingSettings = oSettings.GetProviderSettings(oPatientControl.ProviderID);

                    //for (int i = 0; i < dtBillingSettings.Rows.Count; i++)
                    //{

                    //    switch (Convert.ToString(dtBillingSettings.Rows[i]["sName"]).Trim())
                    //    {
                    //        case "TypeOfService":
                    //            if (Convert.ToString(dtBillingSettings.Rows[i]["sValue"]) != "")
                    //            {
                    //                UC_gloBillingTransactionLines.DefaultTOSID = Convert.ToInt64(dtBillingSettings.Rows[i]["sValue"]);
                    //            }
                    //            break;
                    //        case "PlaceOfService":
                    //            if (Convert.ToString(dtBillingSettings.Rows[i]["sValue"]) != "")
                    //            {
                    //                UC_gloBillingTransactionLines.DefaultPOSID = Convert.ToInt64(dtBillingSettings.Rows[i]["sValue"]);
                    //            }
                    //            break;
                    //        case "BillingProvider":
                    //            if (Convert.ToString(dtBillingSettings.Rows[i]["sValue"]) != "")
                    //            {
                    //                cmbBillingProvider.SelectedValue = Convert.ToInt64(dtBillingSettings.Rows[i]["sValue"]);
                    //            }
                    //            break;
                    //        case "RenderingProvider":
                    //            if (Convert.ToString(dtBillingSettings.Rows[i]["sValue"]) != "")
                    //            {
                    //                UC_gloBillingTransactionLines.DefaultRenderingProviderID = Convert.ToInt64(dtBillingSettings.Rows[i]["sValue"]);
                    //                UC_gloBillingTransactionLines.DefaultRenderringProviderName = oResource.GetProviderName(Convert.ToInt64(dtBillingSettings.Rows[i]["sValue"]));
                    //            }
                    //            break;
                    //        case "Facility":
                    //            if (Convert.ToString(dtBillingSettings.Rows[i]["sValue"]) != "")
                    //            {
                    //                cmbFacility.SelectedValue = Convert.ToString(dtBillingSettings.Rows[i]["sValue"]);
                    //            }
                    //            break;
                    //        case "ClinicFeeSchedule":
                    //            cmb_Feeschedules.SelectedValue = Convert.ToInt64(dtBillingSettings.Rows[i]["sValue"]);
                    //            if (Convert.ToString(dtBillingSettings.Rows[i]["sValue"]) != "")
                    //            {
                    //                FacilityType oFacilityType = (FacilityType)Convert.ToInt32(dtBillingSettings.Rows[i]["sValue"]);
                    //            }
                    //            break;
                    //        default:
                    //            break;
                    //    }
                    //}

                    //if (oSettings != null) { oSettings.Dispose(); }
                    //if (oResource != null) { oResource.Dispose(); } 

                    #endregion

                    #endregion

                    #region " Set Close Date to addedd Line "
                    if (IsValidDate(mskClaimDate.Text) == true)
                    {
                        if (UC_gloBillingTransactionLines != null)
                        {
                            if (UC_gloBillingTransactionLines.GetLinesCount() == 2)
                            {
                                if (Convert.ToString(UC_gloBillingTransactionLines.GetItem(UC_gloBillingTransactionLines.CurrentTransactionLine, COL_CPT_CODE)) == "")
                                {
                                    UC_gloBillingTransactionLines.SetServiceLineDate(UC_gloBillingTransactionLines.CurrentTransactionLine, Convert.ToDateTime(mskClaimDate.Text));
                                }
                            }
                        }
                    }
                    #endregion " Set Close Date to addedd Line "

                }
                else
                {
                    _TransPatientID = 0;
                    if (UC_gloBillingTransactionLines != null)
                    {
                        UC_gloBillingTransactionLines.ReinitilizeControl();
                        UC_gloBillingTransactionLines.PatientID = _TransPatientID;
                    }

                }
                txtClaimNo.Text = gloCharges.FormattedClaimNumberGeneration(Convert.ToString(GenerateClaimNumber()));
            }
            catch (Exception ex)
            {
                gloAuditTrail.gloAuditTrail.ExceptionLog(ex, false);
            }
        }

        //void oPatientControl_OnAccountPatientChanged(object sender, EventArgs e)
        //{
        //}

        private void oPatientControl_OnCmbAccountChanged(object sender, EventArgs e)
        {
            _TransPatientID = oPatientControl.CmbSelectedPatientID;
            nPAccountID = oPatientControl.PAccountID;
            nAccountPatientID = oPatientControl.AccountPatientID;
            nGuarantorID = oPatientControl.GuarantorID;
            //SetLastGlobalPeriods();
            oPatientControl.FillDetails(_TransPatientID, nPAccountID, gloStripControl.FormName.ModifyCharges, true);
            //_isAccountChanged = true;

            if (nInitialStripAccountID != oPatientControl.PAccountID)
            {
                _isAccountChanged = true;
            }
            else
            {
                _isAccountChanged = false;
            }

            //SetPatientBannerAccountPatientChangeData();
        }

        void oPatientControl_OnAccountChanged(object sender, EventArgs e)
        {
            try
            {
                _TransPatientID = oPatientControl.CmbSelectedPatientID;
                nPAccountID = oPatientControl.PAccountID;
                nAccountPatientID = oPatientControl.AccountPatientID;
                nGuarantorID = oPatientControl.GuarantorID;

                SetLastGlobalPeriods();
            }
            catch (Exception ex)
            {
                gloAuditTrail.gloAuditTrail.ExceptionLog(ex, false);
            }
        }

        void oPatientControl_PatientChanged(object sender, EventArgs e)
        {
            try
            {
                this.c1Insurance.EnterCell -= new System.EventHandler(this.c1Insurance_EnterCell);

                if (oPatientControl.CmbSelectedPatientID > 0)
                {


                    c1Insurance_BeforeEdit(null, null);

                    this.c1Insurance.BeforeEdit -= new C1.Win.C1FlexGrid.RowColEventHandler(this.c1Insurance_BeforeEdit);
                    _TransPatientID = oPatientControl.CmbSelectedPatientID;
                    this.nPAccountID = oPatientControl.PAccountID;
                    this.nGuarantorID = oPatientControl.GuarantorID;
                    this.nAccountPatientID = oPatientControl.AccountPatientID;


                    this.c1Insurance.Rows.RemoveRange(1, (this.c1Insurance.Rows.Count - 1));
                    FillPatientInsurances(_TransPatientID);
                    SelectPrimaryInsurance();
                    if (_IsPatientAccountFeature)
                    {
                        gloAuditTrail.gloAuditTrail.CreateAuditLog(ActivityModule.Billing, ActivityCategory.SetupCharges, ActivityType.View, "Charges Opened for Modify", 0, _TransactionID, _PatientPoviderID, ActivityOutCome.Success);

                    }
                    else
                    {
                        SetInsuranceParty();
                    }

                    GetPatientProvider(_TransPatientID);
                    FillClaim(_TransPatientID);

                    if (cmbBillingProvider != null && cmbBillingProvider.Items.Count > 0 && PatientPoviderID != 0)
                    {
                        GetProviderSettings(PatientPoviderID);
                    }

                    CheckForPA();

                    cmbFacility.SelectedValue = UC_gloBillingTransactionLines.FacilityID;

                    if (UC_gloBillingTransactionLines != null)
                    {
                        UC_gloBillingTransactionLines.PatientID = this.PatientID;
                        UC_gloBillingTransactionLines.DefaultPOSID = _DefaultPOSID;
                        UC_gloBillingTransactionLines.DefaultTOSID = _DefaultTOSID;
                        UC_gloBillingTransactionLines.PatientProviderID = _PatientPoviderID;

                    }
                    FillReferralProviders(_TransPatientID);
                    chk_SameasBillingProvider_CheckedChanged(null, null);

                    #region "Get Selected Insurance"

                    string _fillInsuranceName = "";
                    Int64 _fillInsuranceID = 0;
                    Int32 _fillInsSelfMode = 0;

                    if (c1Insurance.Rows.Count > 0)
                    {
                        for (int i = 1; i <= c1Insurance.Rows.Count - 1; i++)
                        {
                            if (c1Insurance.GetCellCheck(i, COL_SELECT) == CheckEnum.Checked)
                            {
                                _fillInsuranceID = Convert.ToInt64(c1Insurance.GetData(i, COL_INSURANCEID));
                                _fillInsuranceName = Convert.ToString(c1Insurance.GetData(i, COL_INSURANCENAME));
                                _fillInsSelfMode = Convert.ToInt32(c1Insurance.GetData(i, COL_INSSELFMODE));
                                break;
                            }
                        }
                    }

                    if (UC_gloBillingTransactionLines != null)
                    {
                        if (_fillInsuranceID > 0)
                        {
                            UC_gloBillingTransactionLines.AddInsurance(UC_gloBillingTransactionLines.CurrentTransactionLine, _fillInsuranceID, _fillInsuranceName, _fillInsSelfMode);
                        }
                    }

                    ChangeInsuranceGridColor();

                    #endregion

                    #region "Mark the Current party "


                    for (int i = 0; i <= c1Insurance.Rows.Count - 1; i++)
                    {
                        c1Insurance.SetCellImage(i, COL_INSURANCERESPONSIBILITY, null);
                    }


                    if (_IsPatientAccountFeature)
                    {
                        if (this.nInitialStripPatientID != oPatientControl.CmbSelectedPatientID && this.nInitialStripPatientID != 0)
                        {
                            Int16 _party = 1;
                            nCurrentResponsibleParty = _party;
                            c1Insurance.SetCellCheck(_party, COL_SELECT_CURRENT_RESPONSIBLE_PARTY, CheckEnum.Checked);
                            System.Drawing.Image imgFlag = global::gloBilling.Properties.Resources.Normal_Priority;
                            c1Insurance.SetCellImage(_party, COL_INSURANCERESPONSIBILITY, imgFlag);
                        }
                        else
                        {
                            DataTable _dt = gloCharges.GetCurrentPartyNumber(_TransactionID, _MasterTransactionID);

                            if (_dt != null && _dt.Rows.Count > 0)
                            {

                                Int16 _party = -1;
                                _party = Convert.ToInt16(_dt.Rows[0]["PartyNo"]);

                                c1Insurance.SetCellCheck(_party, COL_SELECT_CURRENT_RESPONSIBLE_PARTY, CheckEnum.Checked);
                                System.Drawing.Image imgFlag = global::gloBilling.Properties.Resources.Normal_Priority;
                                c1Insurance.SetCellImage(_party, COL_INSURANCERESPONSIBILITY, imgFlag);
                            }

                        }
                    }
                    else
                    {
                        DataTable _dt = gloCharges.GetCurrentPartyNumber(_TransactionID, _MasterTransactionID);

                        if (_dt != null && _dt.Rows.Count > 0)
                        {

                            Int16 _party = -1;
                            _party = Convert.ToInt16(_dt.Rows[0]["PartyNo"]);

                            c1Insurance.SetCellCheck(_party, COL_SELECT_CURRENT_RESPONSIBLE_PARTY, CheckEnum.Checked);
                            System.Drawing.Image imgFlag = global::gloBilling.Properties.Resources.Normal_Priority;
                            c1Insurance.SetCellImage(_party, COL_INSURANCERESPONSIBILITY, imgFlag);
                        }

                    }


                    if (!_InitialTransaction.IsVoid) // --- If Voided then dont Relaod the Insurance Grid and tool bars buse in void no changes are allowed
                    {
                        IsEditable(_InitialTransaction);
                    }

                    SetHoldnMoreClaimDataMesseges();
                    SetLastGlobalPeriods();
                    CheckForEPSDTEnabled();
                    IsAnesthesiaEnabled();

                    for (int iCount = 1; iCount <= c1Insurance.Rows.Count - 1; iCount++)
                    {
                        c1Insurance.SetData(iCount, COL_INSVIEW_PARTYSTATUS, "");
                        c1Insurance.SetData(iCount, COL_INS_INTERNAL_PARTYSTATUS, "");
                    }
                    c1Insurance.SetData(Convert.ToInt16(nCurrentResponsibleParty), COL_INS_INTERNAL_PARTYSTATUS, PartyNo);
                    if (c1Insurance.GetData(Convert.ToInt16(nCurrentResponsibleParty), COL_INSURANCENAME).ToString().ToLower() != "self")
                    {
                        c1Insurance.SetData(Convert.ToInt16(nCurrentResponsibleParty), COL_INSVIEW_PARTYSTATUS, PartyNo);
                    }


                    this.c1Insurance.BeforeEdit += new C1.Win.C1FlexGrid.RowColEventHandler(this.c1Insurance_BeforeEdit);

                    #endregion

                    if (IsClaimVoided)
                    {
                        SetVoidViewMode();
                    }

                }
            }
            catch (Exception ex)
            {
                gloAuditTrail.gloAuditTrail.ExceptionLog(ex, true);
            }
            finally
            {
                this.c1Insurance.EnterCell += new System.EventHandler(this.c1Insurance_EnterCell);
            }
        }

        void oPatientControl_PatientModified(object sender, EventArgs e)
        {
            LoadPatientModifiedData();
        }

        void oPatientControl_ControlSize_Changed(object sender, EventArgs e)
        {

        }

        #endregion " Patient Strip Control Events "

        #region "gloBillingTransaction - Delegated Events"

        void UC_gloBillingTransactionLines_CLIA_Enter()
        {
            #region "CLIANo. of FirstCharge in CLIANo. TextBox"
                txtClaimCLIAno.Text = UC_gloBillingTransactionLines.FirstCLIANo;            
            #endregion
        }
        void UC_gloBillingTransactionLines_onGrid_CellChanged(object sender, RowColEventArgs e)
        {
            try
            {
                if (UC_gloBillingTransactionLines._bISCptBlank)
                {
                    tls_btnMoreChargeData.Enabled = false;
                    tls_Anesthesia.Enabled = false;
                    UC_gloBillingTransactionLines._bISCptBlank = false;
                    return;
                }
                if (_dtEOBPayments != null && _dtEOBPayments.Rows.Count > 0)
                {
                    string dr = Convert.ToString(_dtEOBPayments.Compute("MIN(dtCloseDate)", String.Empty));

                    if (dr != "")
                    {
                        UC_gloBillingTransactionLines.MaxPaymentDate = dr;
                    }
                    else
                    {
                        UC_gloBillingTransactionLines.MaxPaymentDate = "";
                    }
                }

                UC_gloBillingTransactionLines.PerformValidation = true;
                //UpdateInsurancePayment();
            }
            catch (Exception ex)
            {
                gloAuditTrail.gloAuditTrail.ExceptionLog(ex, false);
            }
        }

        //void UC_gloBillingTransactionLines_onCPTCharges_Load(object sender, FacilityType ChargesType)
        //{
        //    try
        //    {
        //        this.chkFacilityFeeSchedule.CheckedChanged -= new System.EventHandler(this.chkFacilityFeeSchedule_CheckedChanged);
        //        this.chkNonFacilityCharges.CheckedChanged -= new System.EventHandler(this.chkNonFacilityCharges_CheckedChanged);
        //        chkFacilityFeeSchedule.Checked = false;
        //        chkNonFacilityCharges.Checked = false;

        //        if (ChargesType == FacilityType.Facility)
        //        { chkFacilityFeeSchedule.Checked = true; }
        //        else if (ChargesType == FacilityType.NonFacility)
        //        { chkNonFacilityCharges.Checked = true; }

        //    }
        //    catch (Exception ex)
        //    {
        //        gloAuditTrail.gloAuditTrail.ExceptionLog(ex.ToString(), false);
        //    }
        //    finally
        //    {
        //        this.chkFacilityFeeSchedule.CheckedChanged += new System.EventHandler(this.chkFacilityFeeSchedule_CheckedChanged);
        //        this.chkNonFacilityCharges.CheckedChanged += new System.EventHandler(this.chkNonFacilityCharges_CheckedChanged);
        //    }
        //}

        void UC_gloBillingTransactionLines_show_LineNotes(object sender, RowColEventArgs e, GeneralNotes Notes)
        {
            try
            {


                #region " Add Notes "

                GeneralNotes oNotes = null;
                Int64 _nMyTransactionlineno = 0;

                if (UC_gloBillingTransactionLines.CurrentTransactionLine > 0)
                {
                    //oNotes = UC_gloBillingTransactionLines.GetNotes(UC_gloBillingTransactionLines.CurrentTransactionLine);
                    //added on 02/03/10 - transaction line no should not be 0" 
                    if (UC_gloBillingTransactionLines.TransactionLineNo == 0)
                    {
                        oNotes = UC_gloBillingTransactionLines.GetNotes(UC_gloBillingTransactionLines.CurrentTransactionLine);
                        _nMyTransactionlineno = UC_gloBillingTransactionLines.CurrentTransactionLine;

                    }
                    else
                    {
                        oNotes = UC_gloBillingTransactionLines.GetNotes(UC_gloBillingTransactionLines.TransactionLineNo);
                        _nMyTransactionlineno = UC_gloBillingTransactionLines.TransactionLineNo;
                    }


                    frmNotes ofrmNotes = new frmNotes(_DatabaseConnectionString, _ClinicID, _TransactionID, UC_gloBillingTransactionLines.TransactionDetailID, _nMyTransactionlineno, oNotes);
                    ofrmNotes.nChildTransactionID = _MasterTransactionID;

                    gloDatabaseLayer.DBLayer oDB = new gloDatabaseLayer.DBLayer(_DatabaseConnectionString);
                    oDB.Connect(false);

                    #region " Fetch The MasterDetailID "

                    string strQuery = " select nTransactionMasterDetailID from  BL_Transaction_Claim_Lines WITH (NOLOCK)  " +
                                    " where nTransactionMasterID=" + _MasterTransactionID + " " +
                                    " and nTransactionID = " + _TransactionID;
                    if (Convert.ToInt64(UC_gloBillingTransactionLines.TransactionDetailID) != 0)
                    {
                        strQuery = strQuery + " and nTransactionDetailID = " + UC_gloBillingTransactionLines.TransactionDetailID;
                    }
                    //Bug #87335: 00000965 : Claim line shows payment note of other claim line
                    strQuery = strQuery + " order by nTransactionLineNo";
                    object _Result = null;
                    _Result = oDB.ExecuteScalar_Query(strQuery);


                    if (_Result != null && Convert.ToString(_Result) != "")
                    {
                        ofrmNotes.nTransactionMasterDetailID = Convert.ToInt64(_Result);
                    }

                    #endregion

                    if (IsClaimVoided)
                    {
                        //IsVoidShowNote specifies that we are opening the notes Form for showing the  void notes
                        ofrmNotes.IsVoidShowNote = true;
                        //ofrmNotes.nChildTransactionID = _MasterTransactionID;
                    }

                    ofrmNotes.ShowDialog(this);
                    if (ofrmNotes.oDialogResult)
                    {
                        //UC_gloBillingTransactionLines.SetNotes(UC_gloBillingTransactionLines.CurrentTransactionLine, ofrmNotes.oNote);
                        UC_gloBillingTransactionLines.SetNotes(ofrmNotes.oNotes);

                        gloAuditTrail.gloAuditTrail.CreateAuditLog(ActivityModule.Billing, ActivityCategory.SetupCharges, ActivityType.Add, "Note added to trasanction line, Line No : " + UC_gloBillingTransactionLines.CurrentTransactionLine.ToString() + " of Claim # : " + txtClaimNo.Text + ".", PatientID, _TransactionID, _PatientPoviderID, ActivityOutCome.Success);

                    }
                    ofrmNotes.Dispose();



                }
                else
                {
                    MessageBox.Show("No transaction line is selected.  ", _messageBoxCaption, MessageBoxButtons.OK, MessageBoxIcon.Information);
                }

                #endregion
            }
            catch (Exception ex)
            {
                gloAuditTrail.gloAuditTrail.ExceptionLog(ex, false);
                //ex.ToString();
                //ex = null;
            }
        }

        void UC_gloBillingTransactionLines_onInsCPTDxMod_Changed(object sender, RowColEventArgs e, TrnCtrlColValChangeEventArg e2)
        {
            frmSetupEPSDTFamilyPlanning ofrmEPSDTFamilyPlanning = null;
            gloBilling ogloBilling = null;
            TransactionLine oLineTransaction = null;
            TransactionLines oLineTransactions = null;
            string sNDCCode = "";
            try
            {

                if (e2.oType == TransactionLineColumnType.Diagnosis)
                {
                    _bDxFlag = UC_gloBillingTransactionLines.bIsDxMsgShown;
                    AddDxToList(e2.code, e2.description, e2.isdeleted);
                    _bDxFlag = true;
                    UC_gloBillingTransactionLines.bIsDxMsgShown = false;
                }
                else if (e2.oType == TransactionLineColumnType.CPT)
                {

                    oLineTransactions = UC_gloBillingTransactionLines.GetLineTransactions();

                    if (UC_gloBillingTransactionLines.CurrentTransactionLine > 0)
                    {
                        if ((Convert.ToString(UC_gloBillingTransactionLines.GetItem(UC_gloBillingTransactionLines.CurrentTransactionLine, COL_CPT_CODE)).Trim() != "") && (UC_gloBillingTransactionLines.GetItem(UC_gloBillingTransactionLines.CurrentTransactionLine, COL_CPT_CODE) != null))
                        {
                            oLineTransactions[UC_gloBillingTransactionLines.CurrentTransactionLine - 1].NDCCode = "";
                            oLineTransactions[UC_gloBillingTransactionLines.CurrentTransactionLine - 1].NDCUnit = null;
                            oLineTransactions[UC_gloBillingTransactionLines.CurrentTransactionLine - 1].NDCUnitCode = null;
                            oLineTransactions[UC_gloBillingTransactionLines.CurrentTransactionLine - 1].NDCUnitDescription = null;
                            UC_gloBillingTransactionLines.SetNDCFields(oLineTransactions[UC_gloBillingTransactionLines.CurrentTransactionLine - 1]);

                            if (gloCharges.GetDefaultNDCForCPT(e2.code, ref sNDCCode))
                            {
                                oLineTransactions[UC_gloBillingTransactionLines.CurrentTransactionLine - 1].NDCCode = sNDCCode;
                                frmDrugBilling ofrmDrugBilling = new frmDrugBilling(_DatabaseConnectionString, oLineTransactions[UC_gloBillingTransactionLines.CurrentTransactionLine - 1]);
                                ofrmDrugBilling.bIsOpenforModify = true;
                                if (IsClaimVoided)
                                {
                                    ofrmDrugBilling.bIsVoid = true;
                                }
                                ofrmDrugBilling.ShowDialog(this);

                                if (ofrmDrugBilling.oDialogResult)
                                {
                                    oLineTransaction = ofrmDrugBilling._oTransLine;
                                    UC_gloBillingTransactionLines.SetNDCFields(oLineTransaction);
                                    oLineTransaction.Dispose();
                                    oLineTransactions.Dispose();
                                }
                                ofrmDrugBilling._oTransLine.Dispose();
                                ofrmDrugBilling.Dispose();
                            }

                            if (EPSDTEnabled && gloCharges.GetPromptForEPSDT(e2.code))
                            {
                                #region " Add Charge Fields "

                                if (UC_gloBillingTransactionLines.CurrentTransactionLine > 0)
                                {
                                    oLineTransaction = oLineTransactions[UC_gloBillingTransactionLines.CurrentTransactionLine - 1];
                                }
                                else
                                {
                                    MessageBox.Show("No transaction line is selected.", gloGlobal.gloPMGlobal.MessageBoxCaption, MessageBoxButtons.OK, MessageBoxIcon.Information);
                                }

                                #endregion

                                ofrmEPSDTFamilyPlanning = new frmSetupEPSDTFamilyPlanning(oLineTransaction, ClaimEPSDT);
                                if (ogloBilling == null)
                                {
                                    ogloBilling = new gloBilling(gloGlobal.gloPMGlobal.DatabaseConnectionString, _emrdatabaseConnectionString);
                                }
                                ofrmEPSDTFamilyPlanning.bIsVoid = (IsClaimVoided || _InitialTransaction.IsClaimSplitted ? true : ogloBilling.IsDayClosed(Convert.ToDateTime(mskClaimDate.Text)));
                                ofrmEPSDTFamilyPlanning.ShowDialog(this);

                                oLineTransactions.Dispose();
                                oLineTransaction.Dispose();

                                if (ofrmEPSDTFamilyPlanning.DialogResults)
                                {
                                    oLineTransaction = ofrmEPSDTFamilyPlanning.LineObject;
                                    ClaimEPSDT = ofrmEPSDTFamilyPlanning.ClaimEPSDT;
                                    UC_gloBillingTransactionLines.SetEPSDTFields(oLineTransaction);
                                }
                                ofrmEPSDTFamilyPlanning.Dispose();
                                ofrmEPSDTFamilyPlanning = null;
                            }

                            if (bIsAnesthesiaEnabled && gloCharges.GetPromptForAnesthesia(e2.code))
                            {
                                frmAnesthesiaBilling ofrmAnesthesiaBilling = new frmAnesthesiaBilling(oLineTransactions[UC_gloBillingTransactionLines.CurrentTransactionLine - 1]);
                                Int64 _currentContactID = 0;
                                for (int iCount = 1; iCount <= c1Insurance.Rows.Count - 1; iCount++)
                                {
                                    if (c1Insurance.GetCellCheck(iCount, COL_SELECT_CURRENT_RESPONSIBLE_PARTY) == CheckEnum.Checked)
                                    {
                                        _currentContactID = Convert.ToInt64(c1Insurance.GetData(iCount, COL_INSURANCECONTACTID));

                                    }
                                }
                                ofrmAnesthesiaBilling.nContactID = _currentContactID;
                                ofrmAnesthesiaBilling.bIsVoid = (IsClaimVoided || _InitialTransaction.IsClaimSplitted ? true : ogloBilling.IsDayClosed(Convert.ToDateTime(mskClaimDate.Text)));
                                ofrmAnesthesiaBilling.ShowDialog(this);

                                if (ofrmAnesthesiaBilling.oDialogResult)
                                {
                                    oLineTransaction = ofrmAnesthesiaBilling.oTransLine;
                                    UC_gloBillingTransactionLines.SetAnesthesiaFields(oLineTransaction);
                                    if (oLineTransaction != null) { oLineTransaction.Dispose(); }
                                    if (oLineTransactions != null) { oLineTransactions.Dispose(); }
                                }
                                ofrmAnesthesiaBilling.oTransLine.Dispose();
                                ofrmAnesthesiaBilling.Dispose();

                            }
                        }

                        #region "To Remove the Dx that are not used in Service Lines "

                        StringBuilder sbDx = new StringBuilder();
                        gloCharges.RemoveUnusedDx(oLineTransactions, ref sbDx);
                        if (sbDx.Length > 0)
                        {
                            for (int k = c1Dx.Rows.Count - 1; k >= 1; k--)
                            {
                                if (!sbDx.ToString().Contains(Convert.ToString(c1Dx.GetData(k, COL_DX_CODE))))
                                    c1Dx.Rows.Remove(k);
                            }
                            sbDx.Clear();
                        }

                        #endregion

                    }

                }
                if (UC_gloBillingTransactionLines.CurrentTransactionLine > 0)
                {
                    TransactionLines oLineTransacts = null;
                    oLineTransacts = UC_gloBillingTransactionLines.GetLineTransactions();
                    if ((UC_gloBillingTransactionLines.GetItem(UC_gloBillingTransactionLines.CurrentTransactionLine, COL_CPT_CODE) != null) && (UC_gloBillingTransactionLines.GetItem(UC_gloBillingTransactionLines.CurrentTransactionLine, COL_CPT_CODE).ToString().Trim() != ""))
                    {
                        tls_btnMoreChargeData.Enabled = true;
                        tls_Anesthesia.Enabled = true;
                        if (oLineTransacts[UC_gloBillingTransactionLines.CurrentTransactionLine - 1].NDCCode != "" && oLineTransacts[UC_gloBillingTransactionLines.CurrentTransactionLine - 1].NDCCode != null)
                        {
                            UC_gloBillingTransactionLines.SetEPSDTNotesNDCCodeFlag(UC_gloBillingTransactionLines.CurrentTransactionLine);
                        }
                    }
                    else
                    {
                        tls_btnMoreChargeData.Enabled = false;
                        tls_Anesthesia.Enabled = false;
                        oLineTransacts[UC_gloBillingTransactionLines.CurrentTransactionLine - 1].NDCCode = "";
                        oLineTransacts[UC_gloBillingTransactionLines.CurrentTransactionLine - 1].NDCUnit = null;
                        oLineTransacts[UC_gloBillingTransactionLines.CurrentTransactionLine - 1].NDCUnitCode = null;
                        oLineTransacts[UC_gloBillingTransactionLines.CurrentTransactionLine - 1].NDCUnitDescription = null;
                        UC_gloBillingTransactionLines.SetNDCFields(oLineTransacts[UC_gloBillingTransactionLines.CurrentTransactionLine - 1]);

                        Boolean bIsUnits = false;
                        if (oLineTransacts[UC_gloBillingTransactionLines.CurrentTransactionLine - 1].bIsAneshtesia)
                        {
                            bIsUnits = true;
                        }

                        oLineTransacts[UC_gloBillingTransactionLines.CurrentTransactionLine - 1].bIsAneshtesia = false;
                        oLineTransacts[UC_gloBillingTransactionLines.CurrentTransactionLine - 1].AnesthesiaStartTime = null;
                        oLineTransacts[UC_gloBillingTransactionLines.CurrentTransactionLine - 1].AnesthesiaEndTime = null;
                        oLineTransacts[UC_gloBillingTransactionLines.CurrentTransactionLine - 1].AnesthesiaID = 0;
                        oLineTransacts[UC_gloBillingTransactionLines.CurrentTransactionLine - 1].bIsAutoCalculateAnesthesia = true;
                        oLineTransacts[UC_gloBillingTransactionLines.CurrentTransactionLine - 1].AnesthesiaTotalMinutes = 0;
                        oLineTransacts[UC_gloBillingTransactionLines.CurrentTransactionLine - 1].AnesthesiaMinPerUnit = 0;
                        oLineTransacts[UC_gloBillingTransactionLines.CurrentTransactionLine - 1].AnesthesiaTimeUnits = 0;
                        oLineTransacts[UC_gloBillingTransactionLines.CurrentTransactionLine - 1].AnesthesiaBaseUnits = 0;
                        oLineTransacts[UC_gloBillingTransactionLines.CurrentTransactionLine - 1].AnesthesiaOtherUnits = 0;
                        oLineTransacts[UC_gloBillingTransactionLines.CurrentTransactionLine - 1].AnesthesiaTotalUnits = 0;

                        if (bIsUnits)
                        {
                            UC_gloBillingTransactionLines.SetAnesthesiaFields(oLineTransacts[UC_gloBillingTransactionLines.CurrentTransactionLine - 1], bIsUnits);
                        }
                        else
                        {
                            UC_gloBillingTransactionLines.SetAnesthesiaFields(oLineTransacts[UC_gloBillingTransactionLines.CurrentTransactionLine - 1], bIsUnits);
                        }
                        //UC_gloBillingTransactionLines.SetAnesthesiaFields(oLineTransacts[UC_gloBillingTransactionLines.CurrentTransactionLine - 1]);
                        //UC_gloBillingTransactionLines.SetNDCCodeFlag(UC_gloBillingTransactionLines.CurrentTransactionLine, false);
                        //UC_gloBillingTransactionLines.SetNDCFields(oLineTransaction);
                    }
                    oLineTransacts.Dispose();
                }
                else
                {
                    tls_btnMoreChargeData.Enabled = false;
                    tls_Anesthesia.Enabled = false;
                }

                #region " Set Line Primary Dx "
                this.c1Dx.CellChanged -= new C1.Win.C1FlexGrid.RowColEventHandler(this.c1Dx_CellChanged);
                if (UC_gloBillingTransactionLines.HasPrimaryDx(UC_gloBillingTransactionLines.CurrentTransactionLine) == true)
                {
                    int rowIndex = UC_gloBillingTransactionLines.CurrentTransactionLine;
                    string _primaryDxCode = UC_gloBillingTransactionLines.GetRowPrimaryDxCode(rowIndex);

                    if (_primaryDxCode != "")
                    {
                        if (c1Dx != null && c1Dx.Rows.Count > 0)
                        {
                            for (int i = 1; i <= c1Dx.Rows.Count - 1; i++)
                            {
                                if (Convert.ToString(c1Dx.GetData(i, COL_DX_CODE)) != "")
                                {
                                    if (Convert.ToString(c1Dx.GetData(i, COL_DX_CODE)).Trim() == _primaryDxCode.Trim())
                                    {
                                        c1Dx.SetCellCheck(i, COL_DX_ISPRIMARY, CheckEnum.Checked);
                                    }
                                    else
                                    {
                                        c1Dx.SetCellCheck(i, COL_DX_ISPRIMARY, CheckEnum.Unchecked);
                                    }
                                }
                            }
                        }
                    }

                }
                else
                {
                    //Uncheck all 
                    if (c1Dx != null && c1Dx.Rows.Count > 0)
                    {
                        for (int i = 1; i <= c1Dx.Rows.Count - 1; i++)
                        {
                            c1Dx.SetCellCheck(i, COL_DX_ISPRIMARY, CheckEnum.Unchecked);
                        }
                    }

                }

                this.c1Dx.CellChanged += new C1.Win.C1FlexGrid.RowColEventHandler(this.c1Dx_CellChanged);

                #endregion " Set Line Primary Dx "

            }
            catch (Exception ex)
            {
                gloAuditTrail.gloAuditTrail.ExceptionLog(ex, false);
                //ex.ToString();
                //ex = null;
            }
            finally
            {
                if (ofrmEPSDTFamilyPlanning != null) { ofrmEPSDTFamilyPlanning.Dispose(); ofrmEPSDTFamilyPlanning = null; }
                if (ogloBilling != null) { ogloBilling.Dispose(); ogloBilling = null; }
                if (oLineTransactions != null) { oLineTransactions.Dispose(); oLineTransactions = null; }
                if (oLineTransaction != null) { oLineTransaction.Dispose(); oLineTransaction = null; }
            }
        }

        void UC_gloBillingTransactionLines_onGrid_SelChanged(object sender, RangeEventArgs e)
        {
            try
            {
                if (UC_gloBillingTransactionLines.CurrentTransactionLine > 0)
                {

                    if ((Convert.ToString(UC_gloBillingTransactionLines.GetItem(UC_gloBillingTransactionLines.CurrentTransactionLine, COL_CPT_CODE)).Trim() != "") && (UC_gloBillingTransactionLines.GetItem(UC_gloBillingTransactionLines.CurrentTransactionLine, COL_CPT_CODE) != null))
                    {
                        tls_btnMoreChargeData.Enabled = true;
                        tls_Anesthesia.Enabled = true;

                    }
                    else
                    {
                        //if ((Convert.ToString(UC_gloBillingTransactionLines.GetItem(UC_gloBillingTransactionLines.CurrentTransactionLine, COL_NDCCODE)).Trim() != "") && (UC_gloBillingTransactionLines.GetItem(UC_gloBillingTransactionLines.CurrentTransactionLine, COL_NDCCODE) != null))
                        //{
                        //    TransactionLines oLineTransacts = null;
                        //    oLineTransacts = UC_gloBillingTransactionLines.GetLineTransactions();
                        //    oLineTransacts[UC_gloBillingTransactionLines.CurrentTransactionLine - 1].NDCCode = "";
                        //    oLineTransacts[UC_gloBillingTransactionLines.CurrentTransactionLine - 1].NDCUnit = null;
                        //    oLineTransacts[UC_gloBillingTransactionLines.CurrentTransactionLine - 1].NDCUnitCode = null;
                        //    oLineTransacts[UC_gloBillingTransactionLines.CurrentTransactionLine - 1].NDCUnitDescription = null;
                        //    UC_gloBillingTransactionLines.SetNDCFields(oLineTransacts[UC_gloBillingTransactionLines.CurrentTransactionLine - 1]);
                        //} 
                        tls_btnMoreChargeData.Enabled = false;
                        tls_Anesthesia.Enabled = false;

                    }
                }
                //select the patient insurance as per the insurance in the transaction line

                this.c1Insurance.CellChanged -= new C1.Win.C1FlexGrid.RowColEventHandler(this.c1Insurance_CellChanged);
                this.c1Dx.CellChanged -= new C1.Win.C1FlexGrid.RowColEventHandler(this.c1Dx_CellChanged);

                if (UC_gloBillingTransactionLines != null && UC_gloBillingTransactionLines.GetLinesCount() > 0)
                {
                    #region " Set Line Insurance to Insurance Grid "

                    if (UC_gloBillingTransactionLines.HasInsurance(UC_gloBillingTransactionLines.CurrentTransactionLine) == true)
                    {
                        int rowIndex = UC_gloBillingTransactionLines.CurrentTransactionLine;
                        Int64 _TempInsuranceid = UC_gloBillingTransactionLines.GetRowInsuranceId(rowIndex);
                        if (_TempInsuranceid >= 0)
                        {
                            //select the corresponding insurance in the Patient Insurance Grid Above
                            if (c1Insurance != null && c1Insurance.Rows.Count > 0)
                            {
                                for (int i = 1; i <= c1Insurance.Rows.Count - 1; i++)
                                {
                                    if (Convert.ToString(c1Insurance.GetData(i, COL_INSURANCEID)) != "")
                                    {
                                        if (Convert.ToInt64(c1Insurance.GetData(i, COL_INSURANCEID)) == _TempInsuranceid)
                                        {
                                            c1Insurance.SetCellCheck(i, COL_SELECT, CheckEnum.Checked);
                                        }
                                        else
                                        {
                                            c1Insurance.SetCellCheck(i, COL_SELECT, CheckEnum.Unchecked);
                                        }
                                    }
                                }
                            }
                        }

                    }
                    else
                    {
                        //Uncheck all 
                        if (c1Insurance != null && c1Insurance.Rows.Count > 0)
                        {
                            for (int i = 1; i <= c1Insurance.Rows.Count - 1; i++)
                            {
                                c1Insurance.SetCellCheck(i, COL_SELECT, CheckEnum.Unchecked);
                            }
                        }

                    }

                    #endregion " Set Line Insurance to Insurance Grid "

                    #region " Set Line Primary Dx "

                    if (UC_gloBillingTransactionLines.HasPrimaryDx(UC_gloBillingTransactionLines.CurrentTransactionLine) == true)
                    {
                        int rowIndex = UC_gloBillingTransactionLines.CurrentTransactionLine;
                        string _primaryDxCode = UC_gloBillingTransactionLines.GetRowPrimaryDxCode(rowIndex);

                        if (_primaryDxCode != "")
                        {
                            if (c1Dx != null && c1Dx.Rows.Count > 0)
                            {
                                for (int i = 1; i <= c1Dx.Rows.Count - 1; i++)
                                {
                                    if (Convert.ToString(c1Dx.GetData(i, COL_DX_CODE)) != "")
                                    {
                                        if (Convert.ToString(c1Dx.GetData(i, COL_DX_CODE)).Trim() == _primaryDxCode.Trim())
                                        {
                                            c1Dx.SetCellCheck(i, COL_DX_ISPRIMARY, CheckEnum.Checked);
                                        }
                                        else
                                        {
                                            c1Dx.SetCellCheck(i, COL_DX_ISPRIMARY, CheckEnum.Unchecked);
                                        }
                                    }
                                }
                            }
                        }

                    }
                    else
                    {
                        //Uncheck all 
                        if (c1Dx != null && c1Dx.Rows.Count > 0)
                        {
                            for (int i = 1; i <= c1Dx.Rows.Count - 1; i++)
                            {
                                c1Dx.SetCellCheck(i, COL_DX_ISPRIMARY, CheckEnum.Unchecked);
                            }
                        }

                    }
                    if (UC_gloBillingTransactionLines.sMammogramCertNo != "")
                    {
                        this._sMammogramCertNumber = UC_gloBillingTransactionLines.sMammogramCertNo;
                    }

                    #endregion " Set Line Primary Dx "

                  
                }
            }
            catch (Exception ex)
            {
                gloAuditTrail.gloAuditTrail.ExceptionLog(ex, true);
                this.c1Insurance.CellChanged += new C1.Win.C1FlexGrid.RowColEventHandler(this.c1Insurance_CellChanged);
                this.c1Dx.CellChanged += new C1.Win.C1FlexGrid.RowColEventHandler(this.c1Dx_CellChanged);
            }
            finally
            {
                this.c1Insurance.CellChanged += new C1.Win.C1FlexGrid.RowColEventHandler(this.c1Insurance_CellChanged);
                this.c1Dx.CellChanged += new C1.Win.C1FlexGrid.RowColEventHandler(this.c1Dx_CellChanged);
            }

        }

        #endregion

        #region " Design C1 Grid Methods "

        private void DesignInsuranceGrid()
        {
            c1Insurance.ScrollBars = ScrollBars.None;
            c1Insurance.BeginUpdate();
            c1Insurance.Cols.Count = COL_INSVIEW_COUNT;
            c1Insurance.Rows.Count = 1;
            c1Insurance.SetData(0, COL_SELECT, "Select");
            c1Insurance.SetData(0, COL_SELECT_CURRENT_RESPONSIBLE_PARTY, "Current Responsiblity");
            c1Insurance.SetData(0, COL_INSURANCERESPONSIBILITY, "Party");
            c1Insurance.SetData(0, COL_INSURANCEID, "InsuranceID");
            c1Insurance.SetData(0, COL_INSURANCENAME, "Insurance");
            c1Insurance.SetData(0, COL_INSURANCETYPE, "Type");
            c1Insurance.SetData(0, COL_INSSELFMODE, "Mode");
            c1Insurance.SetData(0, COL_INSURANCECOPAYAMT, "CopayAmt");

            c1Insurance.SetData(0, COL_INSURANCEWORKERCOMP, "Workers Comp");
            c1Insurance.SetData(0, COL_INSURANCEAUTOCLAIM, "Auto Claim");
            c1Insurance.SetData(0, COL_INSVIEW_PARTYSTATUS, "Party Status");
            c1Insurance.SetData(0, COL_INS_INTERNAL_PARTYSTATUS, "Internal Party Status#");
            c1Insurance.SetData(0, COL_INSURANCEPLANONHOLD, "IsPlanHold");
            c1Insurance.SetData(0, COL_ISINSTITUTIONALBILLING, "IsInstitutionalBilling");

            c1Insurance.SetData(0, COL_INSSTARTENDDATE, "Start-End");
            c1Insurance.SetData(0, COL_INSCOMMENT, "Note");

            c1Insurance.Cols[COL_INSURANCEWORKERCOMP].DataType = typeof(System.Boolean);
            c1Insurance.Cols[COL_INSURANCERESPONSIBILITY].DataType = typeof(System.Char);
            c1Insurance.Cols[COL_INSURANCEPARTY].DataType = typeof(System.Char);
            c1Insurance.Cols[COL_INSURANCEPLANONHOLD].DataType = typeof(System.Boolean);
            c1Insurance.Cols[COL_ISINSTITUTIONALBILLING].DataType = typeof(System.Boolean);

            int nWidth;
            nWidth = pnlPatientInsurence.Width;

            c1Insurance.Cols[COL_SELECT].DataType = System.Type.GetType("System.Boolean");//Select Column
            c1Insurance.Cols[COL_SELECT_CURRENT_RESPONSIBLE_PARTY].DataType = System.Type.GetType("System.Boolean");//Select Current Responsible Party

            c1Insurance.Cols[COL_SELECT].AllowEditing = true;
            c1Insurance.Cols[COL_SELECT_CURRENT_RESPONSIBLE_PARTY].AllowEditing = false;

            c1Insurance.Cols[COL_INSURANCERESPONSIBILITY].AllowEditing = true;
            //c1Insurance.Cols[COL_INSURANCEWORKERCOMP].AllowEditing = true;
            c1Insurance.Cols[COL_INSURANCEWORKERCOMP].AllowEditing = false;
            c1Insurance.Cols[COL_INSVIEW_PARTYSTATUS].AllowEditing = false;
            c1Insurance.Cols[COL_INSURANCEPLANONHOLD].AllowEditing = false;
            c1Insurance.Cols[COL_ISINSTITUTIONALBILLING].AllowEditing = false;
            c1Insurance.Cols[COL_INSSTARTENDDATE].AllowEditing = false;
            c1Insurance.Cols[COL_INSCOMMENT].AllowEditing = false;


            bool _designWidth = false;
            try
            {
                gloSettings.GeneralSettings oSetting = new gloSettings.GeneralSettings(_DatabaseConnectionString);
                _designWidth = oSetting.LoadGridColumnWidth(c1Insurance, gloSettings.ModuleOfGridColumn.Billing, _UserID);
                oSetting.Dispose();
            }
            catch (Exception ex)
            {
                gloAuditTrail.gloAuditTrail.ExceptionLog(ex, false);
                //ex.ToString();
                //ex = null;
            }

            if (_designWidth == false)
            {
                c1Insurance.Cols[COL_SELECT].Width = Convert.ToInt32(nWidth * 0.07);
                c1Insurance.Cols[COL_INSURANCERESPONSIBILITY].Width = Convert.ToInt32(nWidth * 0.07);
                c1Insurance.Cols[COL_INSURANCENAME].Width = Convert.ToInt32(nWidth * 0.40);
                c1Insurance.Cols[COL_INSURANCEID].Width = 0;
                c1Insurance.Cols[COL_INSURANCETYPE].Width = Convert.ToInt32(nWidth * 0.12);
                c1Insurance.Cols[COL_INSSELFMODE].Width = 0;
                c1Insurance.Cols[COL_INSURANCEWORKERCOMP].Width = 0;
                c1Insurance.Cols[COL_INSURANCEAUTOCLAIM].Width = Convert.ToInt32(nWidth * 0.14);
                c1Insurance.Cols[COL_INSURANCEPARTY].Width = 20;
                c1Insurance.Cols[COL_INSVIEW_PARTYSTATUS].Width = Convert.ToInt32(nWidth * 0.12);
                c1Insurance.Cols[COL_INSURANCEPLANONHOLD].Width = 0;
                c1Insurance.Cols[COL_INSSTARTENDDATE].Width = Convert.ToInt32(nWidth * 0.2);
                c1Insurance.Cols[COL_INSCOMMENT].Width = Convert.ToInt32(nWidth * 0.3);
            }
            else
            {
                c1Insurance.Cols[COL_INSURANCERESPONSIBILITY].Width = 50;
                c1Insurance.Cols[COL_INSURANCENAME].Width = 225;
                c1Insurance.Cols[COL_INSURANCETYPE].Width = 70;
                c1Insurance.Cols[COL_INSURANCEWORKERCOMP].Width = 0;
                c1Insurance.Cols[COL_INSVIEW_PARTYSTATUS].Width = 90;
                c1Insurance.Cols[COL_INSURANCEPLANONHOLD].Width = 0;
                c1Insurance.Cols[COL_INSSTARTENDDATE].Width = 115;
                c1Insurance.Cols[COL_INSCOMMENT].Width = 200;
            }

            c1Insurance.Cols[COL_INSURANCERESPONSIBILITY].TextAlign = TextAlignEnum.RightCenter;
            c1Insurance.Cols[COL_INSCOMMENT].TextAlign = TextAlignEnum.LeftCenter;
            c1Insurance.Cols[COL_SELECT].Visible = false;
            c1Insurance.Cols[COL_SELECT_CURRENT_RESPONSIBLE_PARTY].Visible = false;
            c1Insurance.Cols[COL_INSURANCEID].Visible = false;
            c1Insurance.Cols[COL_INSSELFMODE].Visible = false;
            c1Insurance.Cols[COL_INSURANCECOPAYAMT].Visible = false;
            c1Insurance.Cols[COL_INSURANCEAUTOCLAIM].Visible = false;
            c1Insurance.Cols[COL_INSURANCECONTACTID].Visible = false;
            c1Insurance.Cols[COL_INSURANCEPARTY].Visible = false;
            c1Insurance.Cols[COL_INS_INTERNAL_PARTYSTATUS].Visible = false;
            c1Insurance.Cols[COL_ISINSTITUTIONALBILLING].Visible = false;

            c1Insurance.Cols[COL_INSURANCENAME].TextAlign = TextAlignEnum.LeftCenter;
            c1Insurance.EndUpdate();
            c1Insurance.ScrollBars = ScrollBars.Both;
        }

        private void ChangeInsuranceGridColor()
        {
            if (c1Insurance != null && c1Insurance.Rows.Count > 1)
            {
                for (int i = 1; i < c1Insurance.Rows.Count; i++)
                {
                    C1.Win.C1FlexGrid.CellStyle cStyle;// = c1Insurance.Styles.Add("BubbleValues");
                    try
                    {
                        if (c1Insurance.Styles.Contains("BubbleValues"))
                        {
                            cStyle = c1Insurance.Styles["BubbleValues"];
                        }
                        else
                        {
                            cStyle = c1Insurance.Styles.Add("BubbleValues");

                        }

                    }
                    catch
                    {
                        cStyle = c1Insurance.Styles.Add("BubbleValues");

                    }
                    cStyle.BackColor = Color.White;

                    C1.Win.C1FlexGrid.CellRange rgBubbleValues = c1Insurance.GetCellRange(i, COL_INSURANCERESPONSIBILITY);
                    rgBubbleValues.Style = cStyle;
                }
            }
        }

        private void ReorderInsurance()
        {
            c1Insurance.Sort(SortFlags.Ascending, COL_INSURANCENAME);
            c1Insurance.Sort(SortFlags.Ascending, COL_INSURANCETYPE);
            c1Insurance.Sort(SortFlags.Descending, COL_INSSELFMODE);
            c1Insurance.Sort(SortFlags.Ascending, COL_INSURANCEPARTY);


        }

        private void DesignDxGrid()
        {
            //c1Dx.Clear(ClearFlags.All);

            try
            {
                _isDxListLoading = true;
                c1Dx.ScrollBars = ScrollBars.None;
                c1Dx.BeginUpdate();
                c1Dx.Clear(ClearFlags.All);

                c1Dx.Cols.Count = COL_DX_COUNT;
                c1Dx.Rows.Count = 1;

                c1Dx.SetData(0, COL_SELECT, "Select");
                c1Dx.SetData(0, COL_DX_CODE, "Code");
                c1Dx.SetData(0, COL_DX_DESC, "Description");
                c1Dx.SetData(0, COL_DX_ISPRIMARY, "Primary");

                int nWidht = 0;
                nWidht = pnlPatientInsurence.Width;
                if (nWidht < 616)
                    nWidht = 616;
                c1Dx.Cols[COL_DX_SELECT].DataType = typeof(System.Boolean);
                c1Dx.Cols[COL_DX_ISPRIMARY].DataType = typeof(System.Boolean);

                c1Dx.Cols[COL_DX_SELECT].AllowEditing = true;
                c1Dx.Cols[COL_DX_CODE].AllowEditing = false;
                c1Dx.Cols[COL_DX_DESC].AllowEditing = false;
                c1Dx.Cols[COL_DX_ISPRIMARY].AllowEditing = true;

                c1Dx.Cols[COL_DX_CODE].TextAlign = TextAlignEnum.LeftCenter;
                c1Dx.Cols[COL_DX_DESC].TextAlign = TextAlignEnum.LeftCenter;

                c1Dx.Cols[COL_SELECT].Width = Convert.ToInt32(nWidht * 0.09);
                c1Dx.Cols[COL_DX_CODE].Width = Convert.ToInt32(nWidht * 0.11);
                c1Dx.Cols[COL_DX_DESC].Width = Convert.ToInt32(nWidht * 0.70);
                c1Dx.Cols[COL_DX_ISPRIMARY].Width = Convert.ToInt32(nWidht * 0.09);

                c1Dx.SelectionMode = SelectionModeEnum.Row;
            }
            catch (Exception ex)
            {
                MessageBox.Show("ERROR : " + ex.ToString(), _messageBoxCaption, MessageBoxButtons.OK, MessageBoxIcon.Information);
            }
            finally
            {
                _isDxListLoading = false;
                c1Dx.EndUpdate();
                c1Dx.ScrollBars = ScrollBars.Both;
            }


        }

        #endregion " Design C1 Grid Methods "

        #region " C1 Grid Events "

        private void c1Insurance_CellChanged(object sender, RowColEventArgs e)
        {

            Boolean isValid = true;
            int iCurrRow = 0;
            try
            {
                if (_IsFormLoading == false)
                {

                    string _fillInsuranceName = "";
                    Int64 _fillInsuranceID = 0;
                    Int32 _fillInsSelfMode = 0;

                    CheckEnum _Selected = CheckEnum.None;
                    int _CurRowIndex = e.Row;

                    if (c1Insurance.Rows.Count > 0)
                    {
                        _Selected = c1Insurance.GetCellCheck(_CurRowIndex, COL_SELECT);

                        if (_Selected == CheckEnum.Checked)
                        {
                            for (int i = 1; i <= c1Insurance.Rows.Count - 1; i++)
                            {
                                if (i != _CurRowIndex)
                                {
                                    if (c1Insurance.GetCellCheck(i, COL_SELECT) == CheckEnum.Checked)
                                    {

                                        c1Insurance.SetCellCheck(i, COL_SELECT, CheckEnum.Unchecked);

                                    }
                                }
                            }

                            _fillInsuranceID = Convert.ToInt64(c1Insurance.GetData(_CurRowIndex, COL_INSURANCEID));
                            _fillInsuranceName = Convert.ToString(c1Insurance.GetData(_CurRowIndex, COL_INSURANCENAME));
                            _fillInsSelfMode = Convert.ToInt32(c1Insurance.GetData(_CurRowIndex, COL_INSSELFMODE));
                            if (UC_gloBillingTransactionLines != null && UC_gloBillingTransactionLines.GetLinesCount() > 1)
                            {
                                UC_gloBillingTransactionLines.AddInsurance(UC_gloBillingTransactionLines.CurrentTransactionLine, _fillInsuranceID, _fillInsuranceName, _fillInsSelfMode);
                            }
                        }
                        else
                        {
                            _fillInsuranceID = 0;
                            _fillInsuranceName = "";
                            _fillInsSelfMode = PayerMode.None.GetHashCode();
                            if (UC_gloBillingTransactionLines != null && UC_gloBillingTransactionLines.GetLinesCount() > 1)
                            {
                                UC_gloBillingTransactionLines.AddInsurance(UC_gloBillingTransactionLines.CurrentTransactionLine, _fillInsuranceID, _fillInsuranceName, _fillInsSelfMode);
                            }
                        }

                        c1Insurance.CellChanged -= new C1.Win.C1FlexGrid.RowColEventHandler(this.c1Insurance_CellChanged);

                        if (e.Col == COL_INSURANCERESPONSIBILITY && e.Row > 0)
                        {
                            string _regEx = "123456789";
                            string _excluderegEx = "";
                            Int16 _party = -1;
                            DataTable _dt = gloCharges.GetCurrentPartyNumber(_MasterTransactionID);
                            //DataTable _dt = GetCurrentPartyNumber(_TransactionID);
                            if (_dt != null && _dt.Rows.Count > 0)
                            {


                                Int16 _currParty = 0;
                                if (Int16.TryParse(c1Insurance.GetData(e.Row, COL_INSURANCERESPONSIBILITY).ToString(), out _currParty) == true)
                                {
                                }

                                _party = Convert.ToInt16(_dt.Rows[0]["PartyNo"]);
                                _TransStatus = Convert.ToString(_dt.Rows[0]["sNextActionCode"]);

                                if (_InitialTransaction.Transaction_Status == TransactionStatus.SendToClearingHouse || _InitialTransaction.Transaction_Status == TransactionStatus.SendToClaimManager)
                                {
                                    for (int j = 1; j <= _party; j++)
                                    {
                                        if (j != _party)
                                        {
                                            if (gloBilling.ChkPaymentAgainstInsV3(_dtEOBPayments, Convert.ToInt64(c1Insurance.GetData(j, COL_INSURANCECONTACTID)), Convert.ToInt64(c1Insurance.GetData(j, COL_INSURANCEID))))
                                            {
                                                _excluderegEx += Convert.ToString(j);
                                            }
                                        }


                                        if (_excluderegEx.Contains(Convert.ToString(_currParty)))
                                        {
                                            isValid = false;
                                        }

                                    }
                                }
                                else if (_TransStatus == "T")
                                {
                                    for (int i = 1; i < _party; i++)
                                    {
                                        if (i != _party)
                                        {
                                            if (gloBilling.ChkPaymentAgainstInsV3(_dtEOBPayments, Convert.ToInt64(c1Insurance.GetData(i, COL_INSURANCECONTACTID)), Convert.ToInt64(c1Insurance.GetData(i, COL_INSURANCEID))))
                                            {
                                                _excluderegEx += Convert.ToString(i);
                                            }
                                        }

                                        if (_excluderegEx.Contains(Convert.ToString(_currParty)))
                                        {
                                            isValid = false;
                                        }
                                    }



                                }
                                else
                                {
                                    //Modified by Pramod Nair For Split Claims -- Block the Isurance Party to the max of the Party no
                                    for (int i = 1; i <= _party; i++)
                                    {
                                        if (i != _party)
                                        {
                                            if (gloBilling.ChkPaymentAgainstInsV3(_dtEOBPayments, Convert.ToInt64(c1Insurance.GetData(i, COL_INSURANCECONTACTID)), Convert.ToInt64(c1Insurance.GetData(i, COL_INSURANCEID))))
                                            {
                                                //_excluderegEx += Convert.ToString(i);
                                                _excluderegEx += Convert.ToString(c1Insurance.GetData(i, COL_INSURANCERESPONSIBILITY));
                                            }
                                        }
                                        if (_excluderegEx.Contains(Convert.ToString(_currParty)))
                                        {
                                            isValid = false;
                                        }
                                    }
                                }

                                if (_excluderegEx.TrimEnd() != "" && _excluderegEx.Trim().Length > 0)
                                { _regEx = _regEx.Replace(_excluderegEx, "").TrimStart().TrimEnd(); }
                            }

                            //Char _result = Convert.ToChar(c1Insurance.GetData(e.Row, e.Col));
                            string _result = Convert.ToString(c1Insurance.GetData(e.Row, e.Col));

                            if (System.Text.RegularExpressions.Regex.IsMatch(_result.ToString().Trim(), @"^([" + _regEx + "]*)$") == false)
                            {
                                c1Insurance.SetData(e.Row, COL_INSURANCEPARTY, Convert.ToChar("X"));
                                c1Insurance.SetData(e.Row, e.Col, Convert.ToString(""));
                            }
                            else
                            {
                                c1Insurance.SetData(e.Row, COL_INSURANCEPARTY, _result);

                            }

                            if (!isValid)
                            {
                                MessageBox.Show("You cannot assign party no which is already processed.", _messageBoxCaption, MessageBoxButtons.OK, MessageBoxIcon.Information);
                                //isPaidInsurance = false;

                                for (int icount = 1; icount <= c1Insurance.Rows.Count - 1; icount++)
                                {
                                    if (c1Insurance.GetCellCheck(icount, COL_SELECT_CURRENT_RESPONSIBLE_PARTY) == CheckEnum.Checked)
                                    {
                                        iCurrRow = icount;

                                    }
                                }


                                c1Insurance.SetData(e.Row, COL_INSURANCEPARTY, Convert.ToChar("X"));
                                c1Insurance.SetData(e.Row, e.Col, Convert.ToString(""));

                                for (int iCount = 1; iCount <= c1Insurance.Rows.Count - 1; iCount++)
                                {
                                    c1Insurance.SetData(iCount, COL_INSVIEW_PARTYSTATUS, "");
                                    c1Insurance.SetData(iCount, COL_INS_INTERNAL_PARTYSTATUS, "");
                                }

                                ReorderInsurance();

                                for (int _icount = 1; _icount <= c1Insurance.Rows.Count - 1; _icount++)
                                {
                                    c1Insurance.SetCellCheck(_icount, COL_SELECT_CURRENT_RESPONSIBLE_PARTY, CheckEnum.Unchecked);
                                }

                                c1Insurance.SetCellCheck(iCurrRow, COL_SELECT_CURRENT_RESPONSIBLE_PARTY, CheckEnum.Checked);



                                c1Insurance.SetData(iCurrRow, COL_INS_INTERNAL_PARTYSTATUS, PartyNo);

                                if (c1Insurance.GetData(iCurrRow, COL_INSURANCENAME).ToString().ToLower() != "self")
                                {
                                    c1Insurance.SetData(iCurrRow, COL_INSVIEW_PARTYSTATUS, PartyNo);
                                }

                                for (int _iRespcount = 1; _iRespcount <= c1Insurance.Rows.Count - 1; _iRespcount++)
                                {
                                    if (c1Insurance.GetCellCheck(_iRespcount, COL_SELECT_CURRENT_RESPONSIBLE_PARTY) == CheckEnum.Checked)
                                    {
                                        System.Drawing.Image imgFlagResp = global::gloBilling.Properties.Resources.Normal_Priority;
                                        c1Insurance.SetCellImage(_iRespcount, COL_INSURANCERESPONSIBILITY, imgFlagResp);

                                    }
                                    else
                                    {
                                        c1Insurance.SetCellImage(_iRespcount, COL_INSURANCERESPONSIBILITY, null);
                                    }
                                }
                                ReorderInsurance();
                                c1Insurance.CellChanged += new C1.Win.C1FlexGrid.RowColEventHandler(this.c1Insurance_CellChanged);

                                return;

                            }
                            else
                            {

                                Int64 nExistingInsuranceID = 0;
                                Int64 nCurrentInsuranceID = Convert.ToInt64(c1Insurance.GetData(e.Row, COL_INSURANCEID));


                                for (int iCount = 1; iCount <= c1Insurance.Rows.Count - 1; iCount++)
                                {
                                    if (iCount != e.Row)
                                    {
                                        if (Convert.ToInt64(c1Insurance.GetData(e.Row, COL_INSURANCECONTACTID)) == Convert.ToInt64(c1Insurance.GetData(iCount, COL_INSURANCECONTACTID)))
                                        {
                                            nExistingInsuranceID = Convert.ToInt64(c1Insurance.GetData(iCount, COL_INSURANCEID));
                                        }
                                    }
                                }
                                if (nExistingInsuranceID != 0)
                                {
                                    if (gloCharges.IsSamePlan(nCurrentInsuranceID, nExistingInsuranceID))
                                    {
                                        if (_bIsResult)
                                        {
                                            MessageBox.Show("There are two insurances for the same plan and subscriber.  Please review and deactivate old insurances.", _messageBoxCaption, MessageBoxButtons.OK, MessageBoxIcon.Warning);

                                            c1Insurance.SetData(e.Row, COL_INSURANCEPARTY, Convert.ToChar("X"));
                                            c1Insurance.SetData(e.Row, e.Col, Convert.ToString(""));
                                        }
                                        bisDuplicatePlan = true;
                                        c1Insurance.CellChanged += new C1.Win.C1FlexGrid.RowColEventHandler(this.c1Insurance_CellChanged);
                                        _bIsResult = true;
                                        return;
                                    }
                                    else
                                    {
                                        bisDuplicatePlan = false;
                                    }
                                }
                                else
                                {
                                    bisDuplicatePlan = false;
                                }

                            }



                            if (_TransStatus == "T")
                            {
                                //To Remove the Previous Flag
                                for (int i = 0; i <= c1Insurance.Rows.Count - 1; i++)
                                {
                                    c1Insurance.SetCellImage(i, COL_INSURANCERESPONSIBILITY, null);
                                }

                                Char _first = Convert.ToChar(c1Insurance.GetData(1, 1));
                                if (_first.ToString() == "1")
                                {
                                    //To mark the current flag
                                    System.Drawing.Image imgFlag = global::gloBilling.Properties.Resources.Normal_Priority;
                                    c1Insurance.SetCellImage(1, COL_INSURANCERESPONSIBILITY, imgFlag);
                                }

                            }

                        }

                        c1Insurance.CellChanged += new C1.Win.C1FlexGrid.RowColEventHandler(this.c1Insurance_CellChanged);
                    }
                    if (CL_FollowUpCode.IsFollowUpFeatureON())
                    {
                        setActionTemplateVisibility();
                    }

                }                
            }
            catch (Exception ex)
            {
                gloAuditTrail.gloAuditTrail.ExceptionLog(ex, false);
            }

        }

        private void c1Insurance_KeyUp(object sender, KeyEventArgs e)
        {
            int iRowSel = 0;
            int iResponsible = 0;
            gloBilling ogloBilling = new gloBilling(_DatabaseConnectionString, _emrdatabaseConnectionString);
            Transaction _Transaction = new Transaction();

            Int64 _Party = 0;
            Int16 _CurrentParty = 0;
            DataTable _dtParty;

            try
            {
                #region "Code for Finding Max Responsibility No of child Claims(only for Parent Claim)"

                _dtParty = gloCharges.GetCurrentPartyNumber(_MasterTransactionID);
                if (_dtParty != null && _dtParty.Rows.Count > 0)
                {
                    _Party = Convert.ToInt64(_dtParty.Compute("MAX(PartyNo)", ""));
                }

                if (c1Insurance.RowSel > 0)
                    Int16.TryParse(c1Insurance.GetData(c1Insurance.RowSel, COL_INSURANCERESPONSIBILITY).ToString(), out _CurrentParty);

                #endregion

                //if ((!_InitialTransaction.IsClaimSplitted) || ((_InitialTransaction.IsClaimSplitted) && _CurrentParty > _Party))
                //{
                c1Insurance_BeforeEdit(null, null);

                if (e.KeyCode == Keys.Delete && c1Insurance.ColSel == COL_INSURANCERESPONSIBILITY && c1Insurance.RowSel > 0)
                {

                    if (!gloBilling.ChkPaymentAgainstInsV3(_dtEOBPayments, Convert.ToInt64(c1Insurance.GetData(c1Insurance.RowSel, COL_INSURANCECONTACTID)), Convert.ToInt64(c1Insurance.GetData(c1Insurance.RowSel, COL_INSURANCEID))))
                    {
                        //if (!gloBilling.IsExistInNextaction(_dtEOBNextAction, Convert.ToInt64(c1Insurance.GetData(c1Insurance.RowSel, COL_INSURANCECONTACTID)), Convert.ToInt64(c1Insurance.GetData(c1Insurance.RowSel, COL_INSURANCEID)), _InitialTransaction.TransactionID))
                        //{
                        if (c1Insurance.GetCellCheck(c1Insurance.RowSel, COL_SELECT_CURRENT_RESPONSIBLE_PARTY) == CheckEnum.Checked)
                        {
                            _bIsResult = true;
                            iRowSel = c1Insurance.RowSel;
                            //_iDeletedParty = Convert.ToInt16(c1Insurance.GetData(c1Insurance.RowSel, COL_INSURANCEPARTY).ToString().Replace("/0", ""));

                            c1Insurance.SetData(c1Insurance.RowSel, COL_INSURANCEPARTY, Convert.ToChar("X"));
                            c1Insurance.SetData(c1Insurance.RowSel, c1Insurance.ColSel, Convert.ToString(""));

                            for (int iCount = 1; iCount <= c1Insurance.Rows.Count - 1; iCount++)
                            {
                                c1Insurance.SetData(iCount, COL_INSVIEW_PARTYSTATUS, "");
                                c1Insurance.SetData(iCount, COL_INS_INTERNAL_PARTYSTATUS, "");
                            }



                            ReorderInsurance();

                            for (int icount = 1; icount <= c1Insurance.Rows.Count - 1; icount++)
                            {
                                c1Insurance.SetCellCheck(icount, COL_SELECT_CURRENT_RESPONSIBLE_PARTY, CheckEnum.Unchecked);
                            }

                            c1Insurance.SetCellCheck(iRowSel, COL_SELECT_CURRENT_RESPONSIBLE_PARTY, CheckEnum.Checked);

                            c1Insurance.SetData(iRowSel, COL_INS_INTERNAL_PARTYSTATUS, PartyNo);

                            if (c1Insurance.GetData(iRowSel, COL_INSURANCENAME).ToString().ToLower() != "self")
                            {
                                c1Insurance.SetData(iRowSel, COL_INSVIEW_PARTYSTATUS, PartyNo);
                            }

                            for (int icount = 1; icount <= c1Insurance.Rows.Count - 1; icount++)
                            {
                                if (c1Insurance.GetCellCheck(icount, COL_SELECT_CURRENT_RESPONSIBLE_PARTY) == CheckEnum.Checked)
                                {
                                    System.Drawing.Image imgFlagResp = global::gloBilling.Properties.Resources.Normal_Priority;
                                    c1Insurance.SetCellImage(icount, COL_INSURANCERESPONSIBILITY, imgFlagResp);
                                }
                                else
                                {
                                    c1Insurance.SetCellImage(icount, COL_INSURANCERESPONSIBILITY, null);
                                }
                            }

                        }
                        else
                        {
                            #region " Other Then Responsible Party "

                            for (int iCount = 1; iCount <= c1Insurance.Rows.Count - 1; iCount++)
                            {
                                if (c1Insurance.GetCellCheck(iCount, COL_SELECT_CURRENT_RESPONSIBLE_PARTY) == CheckEnum.Checked)
                                {
                                    if (!c1Insurance.GetData(iCount, COL_INSURANCEPARTY).ToString().Replace("/0", "").Contains("X"))
                                    {
                                        iResponsible = Convert.ToUInt16(c1Insurance.GetData(iCount, COL_INSURANCEPARTY).ToString().Replace("/0", ""));
                                    }

                                }
                            }

                            Int64 _currentInsuranceID = 0;
                            Int64 _currentContactID = 0;

                            for (int iCount = 1; iCount <= c1Insurance.Rows.Count - 1; iCount++)
                            {
                                if (c1Insurance.GetCellCheck(iCount, COL_SELECT_CURRENT_RESPONSIBLE_PARTY) == CheckEnum.Checked)
                                {
                                    _currentContactID = Convert.ToInt64(c1Insurance.GetData(iCount, COL_INSURANCECONTACTID));
                                    _currentInsuranceID = Convert.ToInt64(c1Insurance.GetData(iCount, COL_INSURANCEID));

                                }
                            }


                            c1Insurance.SetData(c1Insurance.RowSel, COL_INSURANCEPARTY, Convert.ToChar("X"));
                            c1Insurance.SetData(c1Insurance.RowSel, c1Insurance.ColSel, Convert.ToString(""));

                            for (int iCount = 1; iCount <= c1Insurance.Rows.Count - 1; iCount++)
                            {
                                c1Insurance.SetData(iCount, COL_INSVIEW_PARTYSTATUS, "");
                                c1Insurance.SetData(iCount, COL_INS_INTERNAL_PARTYSTATUS, "");
                            }

                            ReorderInsurance();

                            for (int icount = 1; icount <= c1Insurance.Rows.Count - 1; icount++)
                            {
                                c1Insurance.SetCellCheck(icount, COL_SELECT_CURRENT_RESPONSIBLE_PARTY, CheckEnum.Unchecked);
                            }

                            //21st Sep 2010
                            for (int iCount = 1; iCount <= c1Insurance.Rows.Count - 1; iCount++)
                            {
                                if (c1Insurance.GetData(iCount, COL_INSURANCECONTACTID).ToString().Trim() == Convert.ToString(_currentContactID).Trim() && c1Insurance.GetData(iCount, COL_INSURANCEID).ToString().Trim() == Convert.ToString(_currentInsuranceID).Trim())
                                {
                                    iResponsible = iCount;
                                }

                            }
                            //***


                            if (iResponsible == 0)
                            {
                                c1Insurance.SetCellCheck(_iDeletedParty, COL_SELECT_CURRENT_RESPONSIBLE_PARTY, CheckEnum.Checked);

                                c1Insurance.SetData(Convert.ToInt16(_iDeletedParty), COL_INS_INTERNAL_PARTYSTATUS, PartyNo);
                                if (c1Insurance.GetData(Convert.ToInt16(_iDeletedParty), COL_INSURANCENAME).ToString().ToLower() != "self")
                                {
                                    c1Insurance.SetData(Convert.ToInt16(_iDeletedParty), COL_INSVIEW_PARTYSTATUS, PartyNo);
                                }

                            }
                            else
                            {
                                //for (int icount = 1; icount <= c1Insurance.Rows.Count - 1; icount++)
                                //{
                                //    if (!c1Insurance.GetData(icount, COL_INSURANCEPARTY).ToString().Replace("/0", "").Contains("X"))
                                //    {
                                //        iFindRow = Convert.ToInt16(c1Insurance.GetData(icount, COL_INSURANCEPARTY).ToString().Replace("/0", ""));
                                //        if (iFindRow == iResponsible)
                                //        {
                                //            c1Insurance.SetCellCheck(icount, COL_SELECT_CURRENT_RESPONSIBLE_PARTY, CheckEnum.Checked);

                                //            c1Insurance.SetData(Convert.ToInt16(icount), COL_INS_INTERNAL_PARTYSTATUS, PartyNo);
                                //            if (c1Insurance.GetData(Convert.ToInt16(icount), COL_INSURANCENAME).ToString().ToLower() != "self")
                                //            {
                                //                c1Insurance.SetData(Convert.ToInt16(icount), COL_INSVIEW_PARTYSTATUS, PartyNo);
                                //            }
                                //            break;
                                //        }
                                //    }

                                //}
                                //for (int icount = 1; icount <= c1Insurance.Rows.Count - 1; icount++)
                                //{
                                //if (!c1Insurance.GetData(icount, COL_INSURANCEPARTY).ToString().Replace("/0", "").Contains("X"))
                                //{
                                //    iFindRow = Convert.ToInt16(c1Insurance.GetData(icount, COL_INSURANCEPARTY).ToString().Replace("/0", ""));
                                //    if (iFindRow == iResponsible)
                                //    {
                                c1Insurance.SetCellCheck(iResponsible, COL_SELECT_CURRENT_RESPONSIBLE_PARTY, CheckEnum.Checked);

                                c1Insurance.SetData(Convert.ToInt16(iResponsible), COL_INS_INTERNAL_PARTYSTATUS, PartyNo);
                                if (c1Insurance.GetData(Convert.ToInt16(iResponsible), COL_INSURANCENAME).ToString().ToLower() != "self")
                                {
                                    c1Insurance.SetData(Convert.ToInt16(iResponsible), COL_INSVIEW_PARTYSTATUS, PartyNo);
                                }
                                //break;
                                //        }
                                //    }

                                //}
                            }

                            for (int icount = 1; icount <= c1Insurance.Rows.Count - 1; icount++)
                            {
                                if (c1Insurance.GetCellCheck(icount, COL_SELECT_CURRENT_RESPONSIBLE_PARTY) == CheckEnum.Checked)
                                {
                                    System.Drawing.Image imgFlagResp = global::gloBilling.Properties.Resources.Normal_Priority;
                                    c1Insurance.SetCellImage(icount, COL_INSURANCERESPONSIBILITY, imgFlagResp);
                                }
                                else
                                {
                                    c1Insurance.SetCellImage(icount, COL_INSURANCERESPONSIBILITY, null);
                                }
                            }

                            #endregion
                        }

                        ResponsibilityTransfer();

                        #region "Checking for Responsiblity Changed or not for Expanded Claim Settings."

                        int _nResponsibleRow = 0;
                        for (int i = 1; i <= c1Insurance.Rows.Count - 1; i++)
                        {
                            if (c1Insurance.GetCellCheck(i, COL_SELECT_CURRENT_RESPONSIBLE_PARTY) == CheckEnum.Checked)
                            {
                                _nResponsibleRow = i;
                                break;
                            }
                        }

                        if (_nResponsibleParty != Convert.ToInt64(c1Insurance.GetData(_nResponsibleRow, COL_INSURANCECONTACTID)))
                        {
                            #region " Expanded Claim Settings "

                            Int32 _NoOfMaxServiceLines_old = 0;
                            Int64 _ContactId = 0;
                            int _currentResponsibleRow = 0;

                            for (int i = 1; i <= c1Insurance.Rows.Count - 1; i++)
                            {
                                if (c1Insurance.GetCellCheck(i, COL_SELECT_CURRENT_RESPONSIBLE_PARTY) == CheckEnum.Checked)
                                {
                                    _ContactId = Convert.ToInt64(c1Insurance.GetData(i, COL_INSURANCECONTACTID));
                                    _currentResponsibleRow = i;
                                    break;
                                }
                            }

                            _NoOfMaxServiceLines_old = _NoOfMaxServiceLines;
                            ogloBilling.GetExpandedClaimSetting(_ContactId, _ClinicID, out _NoOfMaxServiceLines, out _NoOfMaxDiagnosis);

                            int _cntr = 0;
                            //for (int i = 1; i < c1Dx.Rows.Count; i++)
                            //{
                            //    if (c1Dx.GetCellCheck(i, COL_DX_SELECT) == CheckEnum.Checked)
                            //    { _cntr++; }
                            //}
                            ArrayList arrDX = UC_gloBillingTransactionLines.GetUniqueDx();
                            if (arrDX != null)
                            {
                                _cntr = arrDX.Count;
                            }

                            if (UC_gloBillingTransactionLines.GetLinesCount() - 1 > _NoOfMaxServiceLines && _cntr > _NoOfMaxDiagnosis)
                            {
                                MessageBox.Show(" Claim has a max limit of " + _NoOfMaxServiceLines + " service lines and " + _NoOfMaxDiagnosis + " diagnosis. ", _messageBoxCaption, MessageBoxButtons.OK, MessageBoxIcon.Warning);
                            }
                            else if (UC_gloBillingTransactionLines.GetLinesCount() - 1 > _NoOfMaxServiceLines)
                            {
                                MessageBox.Show(" Claim has a max limit of " + _NoOfMaxServiceLines + " service lines. ", _messageBoxCaption, MessageBoxButtons.OK, MessageBoxIcon.Warning);
                            }
                            else if (_cntr > _NoOfMaxDiagnosis)
                            {
                                MessageBox.Show(" Claim has a max limit of " + _NoOfMaxDiagnosis + " diagnosis. ", _messageBoxCaption, MessageBoxButtons.OK, MessageBoxIcon.Information);
                            }
                            _Transaction.NoOfServiceLine = _NoOfMaxServiceLines;
                            _Transaction.NoOfDiagnosis = _NoOfMaxDiagnosis;
                            UC_gloBillingTransactionLines._NoOfDiagnosis = _NoOfMaxDiagnosis;
                            UC_gloBillingTransactionLines._NoOfServiceLines = _NoOfMaxServiceLines;

                            #endregion
                        }

                        if (c1Insurance.Rows.Count > 0)
                        {
                            if (_nPrimaryParty != Convert.ToInt64(c1Insurance.GetData(1, COL_INSURANCECONTACTID)))
                            {
                                UC_gloBillingTransactionLines._nContactID = Convert.ToInt64(c1Insurance.GetData(1, COL_INSURANCECONTACTID));
                                UC_gloBillingTransactionLines.setnewAllowedAmount();
                            }
                        }
                        #endregion

                        //}
                        //else
                        //{
                        //    MessageBox.Show("Insurance may not be removed from claim as it is responsible for other claim.", _messageBoxCaption, MessageBoxButtons.OK, MessageBoxIcon.Information);
                        //}
                    }
                    else
                    {
                        if (Convert.ToInt64(c1Insurance.GetData(c1Insurance.RowSel, COL_INSSELFMODE)) == PayerMode.Insurance.GetHashCode())
                        {
                            MessageBox.Show("Insurance may not be removed from a claim after a payment from insurance has been made.", _messageBoxCaption, MessageBoxButtons.OK, MessageBoxIcon.Information);
                        }

                    }


                }
                //}

                for (int icount = 1; icount <= c1Insurance.Rows.Count - 1; icount++)
                {
                    if (c1Insurance.GetCellCheck(icount, COL_SELECT_CURRENT_RESPONSIBLE_PARTY) == CheckEnum.Checked)
                    {
                        _iDeletedParty = icount;
                    }
                }

            }
            catch (Exception ex)
            {
                gloAuditTrail.gloAuditTrail.ExceptionLog(ex, true);
            }
            finally
            {
                SetHoldnMoreClaimDataMesseges();
                //CheckForEPSDTEnabled();      
                if (_Transaction != null) { _Transaction.Dispose(); }
                if (ogloBilling != null) { ogloBilling.Dispose(); }
            }
        }

        private void c1Insurance_Click(object sender, EventArgs e)
        {
            try
            {
                if (c1Insurance.RowSel > 0)
                {
                    if (!c1Insurance.GetData(c1Insurance.RowSel, COL_INSURANCEPARTY).ToString().Replace("/0", "").Contains("X") && c1Insurance.GetData(c1Insurance.RowSel, COL_INSURANCEPARTY).ToString().Replace("/0", "").Replace("\0", "") != string.Empty)
                    {
                        _iBeforeEditValue = Convert.ToInt16(c1Insurance.GetData(c1Insurance.RowSel, COL_INSURANCEPARTY).ToString().Replace("/0", "").Replace("\0", ""));
                    }
                    else
                    {
                        _iBeforeEditValue = 0;
                    }
                }
            }
            catch (Exception ex)
            {
                gloAuditTrail.gloAuditTrail.ExceptionLog(ex, false);
            }
        }

        private void c1Insurance_EnterCell(object sender, EventArgs e)
        {
            try
            {
                if (c1Insurance.RowSel > 0)
                {
                    if (c1Insurance.GetData(c1Insurance.RowSel, COL_INSURANCEPARTY) != null)
                    {
                        if (!c1Insurance.GetData(c1Insurance.RowSel, COL_INSURANCEPARTY).ToString().Replace("/0", "").Contains("X"))
                        {
                            _iBeforeEditValue = Convert.ToInt16(c1Insurance.GetData(c1Insurance.RowSel, COL_INSURANCEPARTY).ToString().Replace("/0", ""));
                        }
                        else
                        {
                            _iBeforeEditValue = 0;
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                gloAuditTrail.gloAuditTrail.ExceptionLog(ex, false);
            }
        }

        private void c1Insurance_KeyPress(object sender, KeyPressEventArgs e)
        {
            try
            {
                if (dtC1Insurance.Rows.Count > 0)
                {
                    try
                    {
                        dtC1Insurance.Rows.Clear();
                    }
                    catch
                    {
                    }
                    try
                    {
                        dtC1Insurance.Columns.Clear();
                    }
                    catch
                    {
                    }
                    for (int i = 0; i <= c1Insurance.Cols.Count - 1; i++)
                    {
                        dtC1Insurance.Columns.Add(c1Insurance.Cols[i].Caption);
                    }
                    for (int i = 1; i <= c1Insurance.Rows.Count - 1; i++)
                    {
                        dtC1Insurance.Rows.Add();
                        for (int j = 0; j <= c1Insurance.Cols.Count - 1; j++)
                        {

                            dtC1Insurance.Rows[i - 1][j] = c1Insurance.GetData(i, j);
                        }
                    }
                }
                else
                {
                    try
                    {
                        dtC1Insurance.Rows.Clear();
                    }
                    catch
                    {
                    }
                    try
                    {
                        dtC1Insurance.Columns.Clear();
                    }
                    catch
                    {
                    }

                    for (int i = 0; i <= c1Insurance.Cols.Count - 1; i++)
                    {
                        dtC1Insurance.Columns.Add(c1Insurance.Cols[i].Caption);
                    }
                    for (int i = 1; i <= c1Insurance.Rows.Count - 1; i++)
                    {
                        dtC1Insurance.Rows.Add();
                        for (int j = 0; j <= c1Insurance.Cols.Count - 1; j++)
                        {

                            dtC1Insurance.Rows[i - 1][j] = c1Insurance.GetData(i, j);
                        }
                    }
                }

            }
            catch (Exception ex)
            {
                gloAuditTrail.gloAuditTrail.ExceptionLog(ex, false);
            }
        }

        private void c1Insurance_BeforeEdit(object sender, RowColEventArgs e)
        {

            try
            {
                for (int iCount = 1; iCount <= c1Insurance.Rows.Count - 1; iCount++)
                {
                    if (iCount == 1)
                        _nPrimaryParty = Convert.ToInt64(c1Insurance.GetData(1, COL_INSURANCECONTACTID));

                    if (c1Insurance.GetCellCheck(iCount, COL_SELECT_CURRENT_RESPONSIBLE_PARTY) == CheckEnum.Checked)
                    {
                        PartyNo = Convert.ToString(c1Insurance.GetData(iCount, COL_INS_INTERNAL_PARTYSTATUS));
                        _nResponsibleParty = Convert.ToInt64(c1Insurance.GetData(iCount, COL_INSURANCECONTACTID));
                        if (iCount == 1 && _nResponsibleParty == 0)
                            UC_gloBillingTransactionLines.IsPrimarySelfPay = true;
                    }
                }
            }
            catch (Exception ex)
            {
                gloAuditTrail.gloAuditTrail.ExceptionLog(ex, false);
            }

        }

        private void c1Insurance_AfterResizeColumn(object sender, RowColEventArgs e)
        {
            try
            {
                gloSettings.GeneralSettings oSetting = new gloSettings.GeneralSettings(_DatabaseConnectionString);
                oSetting.SaveGridColumnWidth(c1Insurance, gloSettings.ModuleOfGridColumn.Billing, _UserID);
                oSetting.Dispose();
            }
            catch (Exception ex)
            {
                gloAuditTrail.gloAuditTrail.ExceptionLog(ex, false);
            }
        }

        private void c1Insurance_MouseDoubleClick(object sender, MouseEventArgs e)
        {

        }

        private void c1Insurance_AfterEdit(object sender, RowColEventArgs e)
        {

            int _party = -1;
            int iResponsible = 0;
            int iFindRow = 0;
            int iCurrentResponsible = 0;
            Int64 iCurrentResContactID = 0;
            Int64 iCurrentResInsID = 0;

            gloBilling ogloBilling = new gloBilling(_DatabaseConnectionString, _emrdatabaseConnectionString);
            Transaction _Transaction = new Transaction();

            try
            {

                if (!c1Insurance.GetData(c1Insurance.RowSel, COL_INSURANCEPARTY).ToString().Replace("/0", "").Contains("X") && bisDuplicatePlan == false)
                {
                    if (c1Insurance.GetData(c1Insurance.RowSel, COL_INSURANCEPARTY).ToString().Trim() != string.Empty)
                    {
                        if (Convert.ToInt16(c1Insurance.GetData(c1Insurance.RowSel, COL_INSURANCEPARTY).ToString().Replace("/0", "")) != _iBeforeEditValue)
                        {

                            if (!c1Insurance.GetData(c1Insurance.RowSel, COL_INSURANCEPARTY).ToString().Replace("/0", "").Contains("X"))
                            {
                                if (Convert.ToInt16(c1Insurance.GetData(c1Insurance.RowSel, COL_INSURANCEPARTY).ToString().Replace("/0", "")) != _iBeforeEditValue)
                                {
                                    //1 oct 2010 abhisekh
                                    iCurrentResContactID = Convert.ToInt64(c1Insurance.GetData(c1Insurance.RowSel, COL_INSURANCECONTACTID));
                                    iCurrentResInsID = Convert.ToInt64(c1Insurance.GetData(c1Insurance.RowSel, COL_INSURANCEID));

                                    for (int icount = 1; icount <= c1Insurance.Rows.Count - 1; icount++)
                                    {
                                        if (c1Insurance.GetCellCheck(icount, COL_SELECT_CURRENT_RESPONSIBLE_PARTY) == CheckEnum.Checked)
                                        {
                                            //iCurrentResponsible = icount;
                                            if (!c1Insurance.GetData(icount, COL_INSURANCEPARTY).ToString().Replace("/0", "").Contains("X"))
                                                iCurrentResponsible = Convert.ToInt16(c1Insurance.GetData(icount, COL_INSURANCEPARTY).ToString().Replace("/0", ""));
                                            else
                                                iCurrentResponsible = icount;
                                        }
                                    }

                                    if (!c1Insurance.GetData(c1Insurance.RowSel, COL_INSURANCEPARTY).ToString().Replace("/0", "").Contains("X"))
                                    {

                                        if (Convert.ToInt16(c1Insurance.GetData(c1Insurance.RowSel, COL_INSURANCEPARTY).ToString().Replace("/0", "")) != _iBeforeEditValue)
                                        {
                                            if (Convert.ToInt16(c1Insurance.GetData(c1Insurance.RowSel, COL_INSURANCEPARTY).ToString().Replace("/0", "")) < iCurrentResponsible)
                                            {
                                                for (int iCount = 1; iCount <= c1Insurance.Rows.Count - 1; iCount++)
                                                {
                                                    c1Insurance.SetData(iCount, COL_INSVIEW_PARTYSTATUS, "");
                                                    c1Insurance.SetData(iCount, COL_INS_INTERNAL_PARTYSTATUS, "");
                                                }

                                                ReorderInsurance();

                                                for (int _icount = 1; _icount <= c1Insurance.Rows.Count - 1; _icount++)
                                                {
                                                    c1Insurance.SetCellCheck(_icount, COL_SELECT_CURRENT_RESPONSIBLE_PARTY, CheckEnum.Unchecked);
                                                }

                                                for (int iCount = 1; iCount <= c1Insurance.Rows.Count - 1; iCount++)
                                                {
                                                    if (Convert.ToInt64(c1Insurance.GetData(iCount, COL_INSURANCECONTACTID)) == iCurrentResContactID && Convert.ToInt64(c1Insurance.GetData(iCount, COL_INSURANCEID)) == iCurrentResInsID)
                                                    {
                                                        c1Insurance.SetCellCheck(iCount, COL_SELECT_CURRENT_RESPONSIBLE_PARTY, CheckEnum.Checked);

                                                        c1Insurance.SetData(iCount, COL_INS_INTERNAL_PARTYSTATUS, PartyNo);

                                                        if (c1Insurance.GetData(iCount, COL_INSURANCENAME).ToString().ToLower() != "self")
                                                        {
                                                            c1Insurance.SetData(iCount, COL_INSVIEW_PARTYSTATUS, PartyNo);
                                                        }

                                                        for (int _iRespcount = 1; _iRespcount <= c1Insurance.Rows.Count - 1; _iRespcount++)
                                                        {
                                                            if (c1Insurance.GetCellCheck(_iRespcount, COL_SELECT_CURRENT_RESPONSIBLE_PARTY) == CheckEnum.Checked)
                                                            {
                                                                System.Drawing.Image imgFlagResp = global::gloBilling.Properties.Resources.Normal_Priority;
                                                                c1Insurance.SetCellImage(_iRespcount, COL_INSURANCERESPONSIBILITY, imgFlagResp);

                                                            }
                                                            else
                                                            {
                                                                c1Insurance.SetCellImage(_iRespcount, COL_INSURANCERESPONSIBILITY, null);
                                                            }
                                                        }
                                                        _iDeletedParty = c1Insurance.RowSel;
                                                        return;
                                                    }
                                                }

                                            }
                                            else if (Convert.ToInt16(c1Insurance.GetData(c1Insurance.RowSel, COL_INSURANCEPARTY).ToString().Replace("/0", "")) > iCurrentResponsible)
                                            {
                                                for (int icount = 1; icount <= c1Insurance.Rows.Count - 1; icount++)
                                                {
                                                    if (c1Insurance.GetCellCheck(icount, COL_SELECT_CURRENT_RESPONSIBLE_PARTY) == CheckEnum.Checked)
                                                    {
                                                        iCurrentResContactID = Convert.ToInt64(c1Insurance.GetData(icount, COL_INSURANCECONTACTID));
                                                        iCurrentResInsID = Convert.ToInt64(c1Insurance.GetData(icount, COL_INSURANCEID));
                                                    }
                                                }
                                                for (int iCount = 1; iCount <= c1Insurance.Rows.Count - 1; iCount++)
                                                {
                                                    c1Insurance.SetData(iCount, COL_INSVIEW_PARTYSTATUS, "");
                                                    c1Insurance.SetData(iCount, COL_INS_INTERNAL_PARTYSTATUS, "");
                                                }

                                                ReorderInsurance();

                                                for (int _icount = 1; _icount <= c1Insurance.Rows.Count - 1; _icount++)
                                                {
                                                    c1Insurance.SetCellCheck(_icount, COL_SELECT_CURRENT_RESPONSIBLE_PARTY, CheckEnum.Unchecked);
                                                }

                                                for (int iCount = 1; iCount <= c1Insurance.Rows.Count - 1; iCount++)
                                                {
                                                    if (Convert.ToInt64(c1Insurance.GetData(iCount, COL_INSURANCECONTACTID)) == iCurrentResContactID && Convert.ToInt64(c1Insurance.GetData(iCount, COL_INSURANCEID)) == iCurrentResInsID)
                                                    {
                                                        c1Insurance.SetCellCheck(iCount, COL_SELECT_CURRENT_RESPONSIBLE_PARTY, CheckEnum.Checked);

                                                        c1Insurance.SetData(iCount, COL_INS_INTERNAL_PARTYSTATUS, PartyNo);

                                                        if (c1Insurance.GetData(iCount, COL_INSURANCENAME).ToString().ToLower() != "self")
                                                        {
                                                            c1Insurance.SetData(iCount, COL_INSVIEW_PARTYSTATUS, PartyNo);
                                                        }

                                                        for (int _iRespcount = 1; _iRespcount <= c1Insurance.Rows.Count - 1; _iRespcount++)
                                                        {
                                                            if (c1Insurance.GetCellCheck(_iRespcount, COL_SELECT_CURRENT_RESPONSIBLE_PARTY) == CheckEnum.Checked)
                                                            {
                                                                System.Drawing.Image imgFlagResp = global::gloBilling.Properties.Resources.Normal_Priority;
                                                                c1Insurance.SetCellImage(_iRespcount, COL_INSURANCERESPONSIBILITY, imgFlagResp);

                                                            }
                                                            else
                                                            {
                                                                c1Insurance.SetCellImage(_iRespcount, COL_INSURANCERESPONSIBILITY, null);
                                                            }
                                                        }
                                                        _iDeletedParty = c1Insurance.RowSel;
                                                        return;
                                                    }
                                                }
                                            }
                                        }

                                    }


                                    for (int icount = 1; icount <= c1Insurance.Rows.Count - 1; icount++)
                                    {
                                        if (c1Insurance.GetCellCheck(icount, COL_SELECT_CURRENT_RESPONSIBLE_PARTY) == CheckEnum.Checked)
                                        {
                                            if (icount == 1)
                                            {
                                                #region " For Same Party "


                                                for (int iCount = 1; iCount <= c1Insurance.Rows.Count - 1; iCount++)
                                                {
                                                    c1Insurance.SetData(iCount, COL_INSVIEW_PARTYSTATUS, "");
                                                    c1Insurance.SetData(iCount, COL_INS_INTERNAL_PARTYSTATUS, "");
                                                }

                                                ReorderInsurance();

                                                for (int _icount = 1; _icount <= c1Insurance.Rows.Count - 1; _icount++)
                                                {
                                                    c1Insurance.SetCellCheck(_icount, COL_SELECT_CURRENT_RESPONSIBLE_PARTY, CheckEnum.Unchecked);
                                                }

                                                c1Insurance.SetCellCheck(1, COL_SELECT_CURRENT_RESPONSIBLE_PARTY, CheckEnum.Checked);

                                                c1Insurance.SetData(1, COL_INS_INTERNAL_PARTYSTATUS, PartyNo);

                                                if (c1Insurance.GetData(1, COL_INSURANCENAME).ToString().ToLower() != "self")
                                                {
                                                    c1Insurance.SetData(1, COL_INSVIEW_PARTYSTATUS, PartyNo);
                                                }

                                                for (int _iRespcount = 1; _iRespcount <= c1Insurance.Rows.Count - 1; _iRespcount++)
                                                {
                                                    if (c1Insurance.GetCellCheck(_iRespcount, COL_SELECT_CURRENT_RESPONSIBLE_PARTY) == CheckEnum.Checked)
                                                    {
                                                        System.Drawing.Image imgFlagResp = global::gloBilling.Properties.Resources.Normal_Priority;
                                                        c1Insurance.SetCellImage(_iRespcount, COL_INSURANCERESPONSIBILITY, imgFlagResp);
                                                    }
                                                    else
                                                    {
                                                        c1Insurance.SetCellImage(_iRespcount, COL_INSURANCERESPONSIBILITY, null);
                                                    }
                                                }

                                                #endregion

                                                return;
                                            }
                                            //}
                                        }
                                    }

                                    if (c1Insurance.GetCellCheck(c1Insurance.RowSel, COL_SELECT_CURRENT_RESPONSIBLE_PARTY) == CheckEnum.Checked)
                                    {
                                        #region " For Same Party "
                                        //1 oct 2010
                                        for (int icount = 1; icount <= c1Insurance.Rows.Count - 1; icount++)
                                        {
                                            if (c1Insurance.GetCellCheck(icount, COL_SELECT_CURRENT_RESPONSIBLE_PARTY) == CheckEnum.Checked)
                                            {
                                                iCurrentResContactID = Convert.ToInt64(c1Insurance.GetData(icount, COL_INSURANCECONTACTID));
                                                iCurrentResInsID = Convert.ToInt64(c1Insurance.GetData(icount, COL_INSURANCEID));
                                                _party = icount;
                                            }
                                        }
                                        //_party = c1Insurance.RowSel;

                                        for (int iCount = 1; iCount <= c1Insurance.Rows.Count - 1; iCount++)
                                        {
                                            c1Insurance.SetData(iCount, COL_INSVIEW_PARTYSTATUS, "");
                                            c1Insurance.SetData(iCount, COL_INS_INTERNAL_PARTYSTATUS, "");
                                        }

                                        ReorderInsurance();

                                        for (int icount = 1; icount <= c1Insurance.Rows.Count - 1; icount++)
                                        {
                                            c1Insurance.SetCellCheck(icount, COL_SELECT_CURRENT_RESPONSIBLE_PARTY, CheckEnum.Unchecked);
                                        }
                                        for (int iCount = 1; iCount <= c1Insurance.Rows.Count - 1; iCount++)
                                        {

                                            if (Convert.ToInt64(c1Insurance.GetData(iCount, COL_INSURANCECONTACTID)) == iCurrentResContactID && Convert.ToInt64(c1Insurance.GetData(iCount, COL_INSURANCEID)) == iCurrentResInsID)
                                            {
                                                if (iCount <= _party)
                                                {
                                                    //c1Insurance.SetCellCheck(_party, COL_SELECT_CURRENT_RESPONSIBLE_PARTY, CheckEnum.Checked);
                                                    c1Insurance.SetCellCheck(iCount, COL_SELECT_CURRENT_RESPONSIBLE_PARTY, CheckEnum.Checked);
                                                    c1Insurance.SetData(iCount, COL_INS_INTERNAL_PARTYSTATUS, PartyNo);
                                                    if (c1Insurance.GetData(iCount, COL_INSURANCENAME).ToString().ToLower() != "self")
                                                    {
                                                        c1Insurance.SetData(iCount, COL_INSVIEW_PARTYSTATUS, PartyNo);
                                                    }
                                                }
                                                else
                                                {
                                                    c1Insurance.SetCellCheck(_party, COL_SELECT_CURRENT_RESPONSIBLE_PARTY, CheckEnum.Checked);
                                                    c1Insurance.SetData(_party, COL_INS_INTERNAL_PARTYSTATUS, PartyNo);
                                                    if (c1Insurance.GetData(_party, COL_INSURANCENAME).ToString().ToLower() != "self")
                                                    {
                                                        c1Insurance.SetData(_party, COL_INSVIEW_PARTYSTATUS, PartyNo);
                                                    }
                                                }
                                            }
                                        }



                                        for (int icount = 1; icount <= c1Insurance.Rows.Count - 1; icount++)
                                        {
                                            if (c1Insurance.GetCellCheck(icount, COL_SELECT_CURRENT_RESPONSIBLE_PARTY) == CheckEnum.Checked)
                                            {
                                                System.Drawing.Image imgFlagResp = global::gloBilling.Properties.Resources.Normal_Priority;
                                                c1Insurance.SetCellImage(icount, COL_INSURANCERESPONSIBILITY, imgFlagResp);
                                            }
                                            else
                                            {
                                                c1Insurance.SetCellImage(icount, COL_INSURANCERESPONSIBILITY, null);
                                            }
                                        }

                                        #endregion

                                    }
                                    else
                                    {
                                        #region " Other Then Responsible Party "
                                        //30 sept 2010 Abhisekh 
                                        Int64 _iCurrentInsContactID = 0;
                                        Int64 _iCurrentInsID = 0;
                                        //

                                        Int64 iSelected = 0;
                                        Int64 iSelectedContactID = 0;
                                        Int64 iSelectedInsID = 0;

                                        Int32 iSelectedPartyRow = 0;
                                        Int32 iResPartyRow = 0;

                                        for (int iCount = 1; iCount <= c1Insurance.Rows.Count - 1; iCount++)
                                        {
                                            if (c1Insurance.GetCellCheck(iCount, COL_SELECT_CURRENT_RESPONSIBLE_PARTY) == CheckEnum.Checked)
                                            {

                                                if (!c1Insurance.GetData(iCount, COL_INSURANCEPARTY).ToString().Replace("/0", "").Contains("X"))
                                                {
                                                    iResponsible = Convert.ToInt16(c1Insurance.GetData(iCount, COL_INSURANCEPARTY).ToString().Replace("/0", ""));
                                                    //30 sept 2010 Abhisekh 
                                                    _iCurrentInsContactID = Convert.ToInt64(c1Insurance.GetData(iCount, COL_INSURANCECONTACTID));
                                                    _iCurrentInsID = Convert.ToInt64(c1Insurance.GetData(iCount, COL_INSURANCEID));
                                                    //

                                                    iSelected = Convert.ToInt16(c1Insurance.GetData(c1Insurance.RowSel, COL_INSURANCEPARTY).ToString().Replace("/0", ""));

                                                    iSelectedContactID = Convert.ToInt64(c1Insurance.GetData(c1Insurance.RowSel, COL_INSURANCECONTACTID));
                                                    iSelectedInsID = Convert.ToInt64(c1Insurance.GetData(c1Insurance.RowSel, COL_INSURANCEID));

                                                    break;
                                                }
                                                else
                                                {
                                                    _party = iCount;
                                                    break;
                                                }

                                            }
                                        }



                                        for (int iCount = 1; iCount <= c1Insurance.Rows.Count - 1; iCount++)
                                        {
                                            c1Insurance.SetData(iCount, COL_INSVIEW_PARTYSTATUS, "");
                                            c1Insurance.SetData(iCount, COL_INS_INTERNAL_PARTYSTATUS, "");
                                        }

                                        ReorderInsurance();

                                        for (int icount = 1; icount <= c1Insurance.Rows.Count - 1; icount++)
                                        {
                                            c1Insurance.SetCellCheck(icount, COL_SELECT_CURRENT_RESPONSIBLE_PARTY, CheckEnum.Unchecked);
                                        }

                                        if (iResponsible == 0)
                                        {
                                            c1Insurance.SetCellCheck(_party, COL_SELECT_CURRENT_RESPONSIBLE_PARTY, CheckEnum.Checked);

                                            c1Insurance.SetData(Convert.ToInt16(_party), COL_INS_INTERNAL_PARTYSTATUS, PartyNo);
                                            if (c1Insurance.GetData(Convert.ToInt16(_party), COL_INSURANCENAME).ToString().ToLower() != "self")
                                            {
                                                c1Insurance.SetData(Convert.ToInt16(_party), COL_INSVIEW_PARTYSTATUS, PartyNo);
                                            }

                                        }
                                        else if (!c1Insurance.GetData(c1Insurance.RowSel, COL_INSURANCEPARTY).ToString().Replace("/0", "").Contains("X"))
                                        {
                                            if (Convert.ToInt16(c1Insurance.GetData(c1Insurance.RowSel, COL_INSURANCEPARTY).ToString().Replace("/0", "")) == _iDeletedParty) //if Current added party is equels to deleated party.
                                            {
                                                c1Insurance.SetCellCheck(_iDeletedParty, COL_SELECT_CURRENT_RESPONSIBLE_PARTY, CheckEnum.Checked);

                                                c1Insurance.SetData(Convert.ToInt16(_iDeletedParty), COL_INS_INTERNAL_PARTYSTATUS, PartyNo);
                                                if (c1Insurance.GetData(Convert.ToInt16(_iDeletedParty), COL_INSURANCENAME).ToString().ToLower() != "self")
                                                {
                                                    c1Insurance.SetData(Convert.ToInt16(_iDeletedParty), COL_INSVIEW_PARTYSTATUS, PartyNo);
                                                }
                                            }
                                            else
                                            {
                                                if (iResponsible == iSelected)
                                                {
                                                    for (int iCount = 1; iCount <= c1Insurance.Rows.Count - 1; iCount++)
                                                    {
                                                        if (Convert.ToInt64(c1Insurance.GetData(iCount, COL_INSURANCECONTACTID)) == _iCurrentInsContactID && Convert.ToInt64(c1Insurance.GetData(iCount, COL_INSURANCEID)) == _iCurrentInsID)
                                                        {
                                                            iResPartyRow = iCount;
                                                        }
                                                    }

                                                    for (int iCount = 1; iCount <= c1Insurance.Rows.Count - 1; iCount++)
                                                    {
                                                        if (Convert.ToInt64(c1Insurance.GetData(iCount, COL_INSURANCECONTACTID)) == iSelectedContactID && Convert.ToInt64(c1Insurance.GetData(iCount, COL_INSURANCEID)) == iSelectedInsID)
                                                        {
                                                            iSelectedPartyRow = iCount;
                                                        }
                                                    }

                                                    if (iSelectedPartyRow < iResPartyRow)
                                                    {
                                                        c1Insurance.SetCellCheck(iSelectedPartyRow, COL_SELECT_CURRENT_RESPONSIBLE_PARTY, CheckEnum.Checked);
                                                        c1Insurance.SetData(iSelectedPartyRow, COL_INS_INTERNAL_PARTYSTATUS, PartyNo);
                                                        if (c1Insurance.GetData(iSelectedPartyRow, COL_INSURANCENAME).ToString().ToLower() != "self")
                                                        {
                                                            c1Insurance.SetData(iSelectedPartyRow, COL_INSVIEW_PARTYSTATUS, PartyNo);
                                                        }

                                                    }
                                                    else
                                                    {
                                                        c1Insurance.SetCellCheck(iResPartyRow, COL_SELECT_CURRENT_RESPONSIBLE_PARTY, CheckEnum.Checked);
                                                        c1Insurance.SetData(iResPartyRow, COL_INS_INTERNAL_PARTYSTATUS, PartyNo);
                                                        if (c1Insurance.GetData(iResPartyRow, COL_INSURANCENAME).ToString().ToLower() != "self")
                                                        {
                                                            c1Insurance.SetData(iResPartyRow, COL_INSVIEW_PARTYSTATUS, PartyNo);
                                                        }
                                                    }

                                                    for (int icount = 1; icount <= c1Insurance.Rows.Count - 1; icount++)
                                                    {
                                                        if (c1Insurance.GetCellCheck(icount, COL_SELECT_CURRENT_RESPONSIBLE_PARTY) == CheckEnum.Checked)
                                                        {
                                                            System.Drawing.Image imgFlagResp = global::gloBilling.Properties.Resources.Normal_Priority;
                                                            c1Insurance.SetCellImage(icount, COL_INSURANCERESPONSIBILITY, imgFlagResp);
                                                        }
                                                        else
                                                        {
                                                            c1Insurance.SetCellImage(icount, COL_INSURANCERESPONSIBILITY, null);
                                                        }
                                                    }

                                                }
                                                else
                                                {
                                                    for (int icount = 1; icount <= c1Insurance.Rows.Count - 1; icount++)
                                                    {
                                                        if (!c1Insurance.GetData(icount, COL_INSURANCEPARTY).ToString().Replace("/0", "").Contains("X"))
                                                        {
                                                            iFindRow = Convert.ToInt16(c1Insurance.GetData(icount, COL_INSURANCEPARTY).ToString().Replace("/0", ""));
                                                            if (iFindRow == iResponsible)
                                                            {
                                                                //1 oct 2010 removed condition 
                                                                //30 sept 2010 abhisekh apply condition
                                                                //if (Convert.ToInt64(c1Insurance.GetData(icount, COL_INSURANCECONTACTID)) == _iCurrentInsContactID && Convert.ToInt64(c1Insurance.GetData(icount, COL_INSURANCEID)) == _iCurrentInsID)
                                                                //{
                                                                //
                                                                c1Insurance.SetCellCheck(icount, COL_SELECT_CURRENT_RESPONSIBLE_PARTY, CheckEnum.Checked);

                                                                c1Insurance.SetData(Convert.ToInt16(icount), COL_INS_INTERNAL_PARTYSTATUS, PartyNo);
                                                                if (c1Insurance.GetData(Convert.ToInt16(icount), COL_INSURANCENAME).ToString().ToLower() != "self")
                                                                {
                                                                    c1Insurance.SetData(Convert.ToInt16(icount), COL_INSVIEW_PARTYSTATUS, PartyNo);
                                                                }
                                                                break;
                                                            }
                                                            //}
                                                        }

                                                    }
                                                }
                                            }
                                        }
                                        else
                                        {
                                            for (int icount = 1; icount <= c1Insurance.Rows.Count - 1; icount++)
                                            {
                                                if (!c1Insurance.GetData(icount, COL_INSURANCEPARTY).ToString().Replace("/0", "").Contains("X"))
                                                {
                                                    iFindRow = Convert.ToInt16(c1Insurance.GetData(icount, COL_INSURANCEPARTY).ToString().Replace("/0", ""));
                                                    if (iFindRow == iResponsible)
                                                    {
                                                        c1Insurance.SetCellCheck(icount, COL_SELECT_CURRENT_RESPONSIBLE_PARTY, CheckEnum.Checked);

                                                        c1Insurance.SetData(Convert.ToInt16(icount), COL_INS_INTERNAL_PARTYSTATUS, PartyNo);
                                                        if (c1Insurance.GetData(Convert.ToInt16(icount), COL_INSURANCENAME).ToString().ToLower() != "self")
                                                        {
                                                            c1Insurance.SetData(Convert.ToInt16(icount), COL_INSVIEW_PARTYSTATUS, PartyNo);
                                                        }
                                                        break;
                                                    }
                                                }

                                            }
                                        }
                                        ReorderInsurance();
                                        for (int icount = 1; icount <= c1Insurance.Rows.Count - 1; icount++)
                                        {
                                            if (c1Insurance.GetCellCheck(icount, COL_SELECT_CURRENT_RESPONSIBLE_PARTY) == CheckEnum.Checked)
                                            {
                                                System.Drawing.Image imgFlagResp = global::gloBilling.Properties.Resources.Normal_Priority;
                                                c1Insurance.SetCellImage(icount, COL_INSURANCERESPONSIBILITY, imgFlagResp);
                                            }
                                            else
                                            {
                                                c1Insurance.SetCellImage(icount, COL_INSURANCERESPONSIBILITY, null);
                                            }
                                        }

                                        #endregion
                                    }

                                }
                            }
                        }
                    }
                }
                else
                {
                    //30 sept 2010 Abhisekh 
                    Int64 _iCurrentInsContactID = 0;
                    Int64 _iCurrentInsID = 0;
                    //
                    for (int icount = 1; icount <= c1Insurance.Rows.Count - 1; icount++)
                    {
                        if (c1Insurance.GetCellCheck(icount, COL_SELECT_CURRENT_RESPONSIBLE_PARTY) == CheckEnum.Checked)
                        {
                            iCurrentResponsible = icount;
                            //30 sept 2010 Abhisekh 
                            _iCurrentInsContactID = Convert.ToInt64(c1Insurance.GetData(icount, COL_INSURANCECONTACTID));
                            _iCurrentInsID = Convert.ToInt64(c1Insurance.GetData(icount, COL_INSURANCEID));
                            //
                        }
                    }
                    //iCurrentResponsible = c1Insurance.RowSel;
                    for (int iCount = 1; iCount <= c1Insurance.Rows.Count - 1; iCount++)
                    {
                        c1Insurance.SetData(iCount, COL_INSVIEW_PARTYSTATUS, "");
                        c1Insurance.SetData(iCount, COL_INS_INTERNAL_PARTYSTATUS, "");
                    }

                    ReorderInsurance();

                    for (int _icount = 1; _icount <= c1Insurance.Rows.Count - 1; _icount++)
                    {
                        c1Insurance.SetCellCheck(_icount, COL_SELECT_CURRENT_RESPONSIBLE_PARTY, CheckEnum.Unchecked);
                    }
                    //30 sept 2010 Abhisekh 
                    //c1Insurance.SetCellCheck(iCurrentResponsible, COL_SELECT_CURRENT_RESPONSIBLE_PARTY, CheckEnum.Checked);   //Commented this line and add remaining
                    Boolean setResponsibilityFlag = false;
                    for (int iCount = 1; iCount <= c1Insurance.Rows.Count - 1; iCount++)
                    {

                        if (Convert.ToInt64(c1Insurance.GetData(iCount, COL_INSURANCECONTACTID)) == _iCurrentInsContactID && Convert.ToInt64(c1Insurance.GetData(iCount, COL_INSURANCEID)) == _iCurrentInsID && Convert.ToString(c1Insurance.GetData(iCount, COL_INSURANCERESPONSIBILITY)).Replace("\0", "") != "")
                        {
                            c1Insurance.SetCellCheck(iCount, COL_SELECT_CURRENT_RESPONSIBLE_PARTY, CheckEnum.Checked);
                            setResponsibilityFlag = true;
                        }
                    }
                    if (!setResponsibilityFlag)
                        c1Insurance.SetCellCheck(iCurrentResponsible, COL_SELECT_CURRENT_RESPONSIBLE_PARTY, CheckEnum.Checked);
                    //30 sept 2010 Abhisekh 
                    for (int iCount = 1; iCount <= c1Insurance.Rows.Count - 1; iCount++)
                    {
                        if (c1Insurance.GetCellCheck(iCount, COL_SELECT_CURRENT_RESPONSIBLE_PARTY) == CheckEnum.Checked)
                        {
                            c1Insurance.SetData(iCount, COL_INS_INTERNAL_PARTYSTATUS, PartyNo);

                            if (c1Insurance.GetData(iCount, COL_INSURANCENAME).ToString().ToLower() != "self")
                            {
                                c1Insurance.SetData(iCount, COL_INSVIEW_PARTYSTATUS, PartyNo);
                            }
                        }
                    }

                    for (int _iRespcount = 1; _iRespcount <= c1Insurance.Rows.Count - 1; _iRespcount++)
                    {
                        if (c1Insurance.GetCellCheck(_iRespcount, COL_SELECT_CURRENT_RESPONSIBLE_PARTY) == CheckEnum.Checked)
                        {
                            System.Drawing.Image imgFlagResp = global::gloBilling.Properties.Resources.Normal_Priority;
                            c1Insurance.SetCellImage(_iRespcount, COL_INSURANCERESPONSIBILITY, imgFlagResp);
                        }
                        else
                        {
                            c1Insurance.SetCellImage(_iRespcount, COL_INSURANCERESPONSIBILITY, null);
                        }
                    }

                    return;

                }



            }
            catch (Exception ex)
            {
                gloAuditTrail.gloAuditTrail.ExceptionLog(ex, true);
            }

            finally
            {
                ResponsibilityTransfer();

                #region "Checking for Responsiblity Changed or not for Expanded Claim Settings."

                int _nResponsibleRow = 0;
                for (int i = 1; i <= c1Insurance.Rows.Count - 1; i++)
                {
                    if (c1Insurance.GetCellCheck(i, COL_SELECT_CURRENT_RESPONSIBLE_PARTY) == CheckEnum.Checked)
                    {
                        _nResponsibleRow = i;
                        break;
                    }
                }

                if (_nResponsibleParty != Convert.ToInt64(c1Insurance.GetData(_nResponsibleRow, COL_INSURANCECONTACTID)))
                {
                    #region " Expanded Claim Settings "

                    Int32 _NoOfMaxServiceLines_old = 0;
                    Int64 _ContactId = 0;
                    int _currentResponsibleRow = 0;
                    Int64 _nInsuranceId = 0;
                    for (int i = 1; i <= c1Insurance.Rows.Count - 1; i++)
                    {
                        if (c1Insurance.GetCellCheck(i, COL_SELECT_CURRENT_RESPONSIBLE_PARTY) == CheckEnum.Checked)
                        {
                            _ContactId = Convert.ToInt64(c1Insurance.GetData(i, COL_INSURANCECONTACTID));
                            _currentResponsibleRow = i;
                            _nInsuranceId = Convert.ToInt64(c1Insurance.GetData(i, COL_INSURANCEID));
                            break;
                        }
                    }

                    _NoOfMaxServiceLines_old = _NoOfMaxServiceLines;
                    ogloBilling.GetExpandedClaimSetting(_ContactId, _ClinicID, out _NoOfMaxServiceLines, out _NoOfMaxDiagnosis);

                    int _cntr = 0;

                    ArrayList arrDX = UC_gloBillingTransactionLines.GetUniqueDx();
                    if (arrDX != null)
                    {
                        _cntr = arrDX.Count;
                    }

                    if (UC_gloBillingTransactionLines.GetLinesCount() - 1 > _NoOfMaxServiceLines && _cntr > _NoOfMaxDiagnosis)
                    {
                        MessageBox.Show(" Claim has a max limit of " + _NoOfMaxServiceLines + " service lines and " + _NoOfMaxDiagnosis + " diagnosis. ", _messageBoxCaption, MessageBoxButtons.OK, MessageBoxIcon.Warning);
                    }
                    else if (UC_gloBillingTransactionLines.GetLinesCount() - 1 > _NoOfMaxServiceLines)
                    {
                        MessageBox.Show(" Claim has a max limit of " + _NoOfMaxServiceLines + " service lines. ", _messageBoxCaption, MessageBoxButtons.OK, MessageBoxIcon.Warning);
                    }
                    else if (_cntr > _NoOfMaxDiagnosis)
                    {
                        MessageBox.Show(" Claim has a max limit of " + _NoOfMaxDiagnosis + " diagnosis. ", _messageBoxCaption, MessageBoxButtons.OK, MessageBoxIcon.Information);
                    }
                    _Transaction.NoOfServiceLine = _NoOfMaxServiceLines;
                    _Transaction.NoOfDiagnosis = _NoOfMaxDiagnosis;
                    UC_gloBillingTransactionLines._NoOfDiagnosis = _NoOfMaxDiagnosis;
                    UC_gloBillingTransactionLines._NoOfServiceLines = _NoOfMaxServiceLines;


                    #endregion

                    ShowHideUB();
                }
                // Seting Allowed  amount from fee schedule --look for primary insurance party
                if (c1Insurance.Rows.Count > 0)
                {
                    if (_nPrimaryParty != Convert.ToInt64(c1Insurance.GetData(1, COL_INSURANCECONTACTID)))
                    {
                        UC_gloBillingTransactionLines._nContactID = Convert.ToInt64(c1Insurance.GetData(1, COL_INSURANCECONTACTID));
                        UC_gloBillingTransactionLines.setnewAllowedAmount();
                    }
                }
                #endregion

                SetHoldnMoreClaimDataMesseges();
                //CheckForEPSDTEnabled();      
                if (_Transaction != null) { _Transaction.Dispose(); }
                if (ogloBilling != null) { ogloBilling.Dispose(); }
            }

        }

        private void c1Insurance_MouseDown(object sender, MouseEventArgs e)
        {
            try
            {
                CellStyle csSelect;

                for (int i = cmnu_ChangeInsResponsiblity.Items.Count - 1; i >= 0; i--)
                {
                    cmnu_ChangeInsResponsiblity.Items.RemoveAt(i);
                }
                Int64 nCurrentInsuranceID = 0;
                if (c1Insurance.HitTest(e.X, e.Y).Row > 0)
                {
                    nCurrentInsuranceID = Convert.ToInt64(c1Insurance.GetData(c1Insurance.HitTest(e.X, e.Y).Row, COL_INSURANCEID));
                    if (nCurrentInsuranceID > 0)
                        cmnu_ChangeInsResponsiblity.Items.Add(mnuViewBenefit);
                }

                c1Insurance.ContextMenuStrip = cmnu_ChangeInsResponsiblity;
                c1Insurance_BeforeEdit(null, null);               

                // csSelect = c1Insurance.Styles.Add("cs_Orange");
                try
                {
                    if (c1Insurance.Styles.Contains("cs_Orange"))
                    {
                        csSelect = c1Insurance.Styles["cs_Orange"];
                    }
                    else
                    {
                        csSelect = c1Insurance.Styles.Add("cs_Orange");

                    }

                }
                catch
                {
                    csSelect = c1Insurance.Styles.Add("cs_Orange");

                }
                csSelect.BackColor = System.Drawing.Color.FromArgb(254, 207, 102);

                // csSelect = c1Insurance.Styles.Add("cs_white");
                try
                {
                    if (c1Insurance.Styles.Contains("cs_white"))
                    {
                        csSelect = c1Insurance.Styles["cs_white"];
                    }
                    else
                    {
                        csSelect = c1Insurance.Styles.Add("cs_white");

                    }

                }
                catch
                {
                    csSelect = c1Insurance.Styles.Add("cs_white");

                }
                csSelect.BackColor = Color.White;

                c1Insurance.Row = c1Insurance.HitTest(e.X, e.Y).Row;

                if (c1Insurance.HitTest(e.X, e.Y).Row > 0)
                {
                    if (c1Insurance.HitTest(e.X, e.Y).Column == COL_INSURANCERESPONSIBILITY)
                    {
                        String sSelected = Convert.ToString(c1Insurance.GetData(c1Insurance.HitTest(e.X, e.Y).Row, COL_INSURANCERESPONSIBILITY)).Replace("\0", "");                        
                        if (c1Insurance.GetCellCheck(c1Insurance.HitTest(e.X, e.Y).Row, COL_SELECT_CURRENT_RESPONSIBLE_PARTY) == CheckEnum.Unchecked && sSelected != "" && sSelected != null)
                        {

                            if (c1Insurance.HitTest(e.X, e.Y).Row == -1)
                            {
                                c1Insurance.ContextMenuStrip = null;
                                return;
                            }

                            if (e.Button == MouseButtons.Right)
                            {
                                cmnu_ChangeInsResponsiblity.Items.Add(mnuItem_Apply);
                            }

                        }                        
                    }

                }
            }
            catch (Exception ex)
            {
                gloAuditTrail.gloAuditTrail.ExceptionLog(ex, false);
            }
        }

        private void getInsurancePlanCorrectRplmnt(Int64 nContactID)
        {
            // **Start Code to determine whether current Insurance plan is corrected/ Replacement plan or not.**
            gloDatabaseLayer.DBLayer oDB = new gloDatabaseLayer.DBLayer(_DatabaseConnectionString);
            string strQuery = "";
            DataTable dtPartyNo = null;
            try
            {
                oDB.Connect(false);
                strQuery = "SELECT ISNULL(bIsCorrectRplmnt,0) AS bIsCorrectRplmnt from BL_CorrectedReplacement_Plan WITH (NOLOCK) where nContactID=" + nContactID;
                oDB.Retrive_Query(strQuery, out dtPartyNo);
                if (dtPartyNo.Rows.Count > 0)
                    _bIsPlanCorrectRplmnt = Convert.ToBoolean(dtPartyNo.Rows[0]["bIsCorrectRplmnt"]);
                else
                    _bIsPlanCorrectRplmnt = false;
            }
            catch (Exception Ex)
            {
                gloAuditTrail.gloAuditTrail.ExceptionLog(Ex, true);
            }
            finally
            {
                oDB.Disconnect();
                oDB.Dispose();
            }
        }

        private void c1Dx_CellChanged(object sender, RowColEventArgs e)
        {
            if (_isDxListLoading == true)
            { return; }

            try
            {
                this.c1Dx.CellChanged -= new C1.Win.C1FlexGrid.RowColEventHandler(this.c1Dx_CellChanged);
                int _cntr = 0;
                if (e.Col == COL_DX_SELECT)
                {
                    for (int i = 1; i < c1Dx.Rows.Count; i++)
                    {
                        if (c1Dx.GetCellCheck(i, COL_DX_SELECT) == CheckEnum.Checked)
                        { _cntr++; }
                    }
                }
                else if (e.Col == COL_DX_ISPRIMARY)
                {
                    for (int i = 1; i < c1Dx.Rows.Count; i++)
                    {
                        if (i != e.Row)
                        {
                            if (c1Dx.GetCellCheck(i, COL_DX_ISPRIMARY) == CheckEnum.Checked)
                            { c1Dx.SetCellCheck(i, COL_DX_ISPRIMARY, CheckEnum.Unchecked); }
                        }
                    }
                    string _dxCode = "";
                    string _dxDesc = "";
                    int _CurRowIndex = e.Row;
                    CheckEnum _Selected = CheckEnum.None;
                    bool _retVal = false;

                    if (c1Dx.Rows.Count > 0)
                    {
                        _Selected = c1Dx.GetCellCheck(_CurRowIndex, COL_DX_ISPRIMARY);
                        if (_Selected == CheckEnum.Checked)
                        {
                            _dxCode = Convert.ToString(c1Dx.GetData(_CurRowIndex, COL_DX_CODE)).Trim();
                            _dxDesc = Convert.ToString(c1Dx.GetData(_CurRowIndex, COL_DX_DESC)).Trim();

                            if (UC_gloBillingTransactionLines != null && UC_gloBillingTransactionLines.GetLinesCount() > 1)
                            {
                                _retVal = UC_gloBillingTransactionLines.AddLinePrimaryDx(UC_gloBillingTransactionLines.CurrentTransactionLine, _dxCode, _dxDesc);
                            }
                            else
                            {
                                _dxCode = "";
                                _dxDesc = "";
                                _retVal = UC_gloBillingTransactionLines.AddLinePrimaryDx(UC_gloBillingTransactionLines.CurrentTransactionLine, _dxCode, _dxDesc);
                            }
                        }
                        else
                        {
                            UC_gloBillingTransactionLines.RemoveLinePrimaryDx(UC_gloBillingTransactionLines.CurrentTransactionLine);
                        }

                        if (_retVal == false)
                        { c1Dx.SetCellCheck(_CurRowIndex, COL_DX_ISPRIMARY, CheckEnum.Unchecked); }
                    }

                }

            }
            catch (Exception ex)
            {
                gloAuditTrail.gloAuditTrail.ExceptionLog(ex, false);
            }
            finally
            {
                this.c1Dx.CellChanged += new C1.Win.C1FlexGrid.RowColEventHandler(this.c1Dx_CellChanged);
            }
        }
        private void c1Insurance_MouseMove(object sender, MouseEventArgs e)
        {
            gloC1FlexStyle.ShowToolTipForLineBreak(C1SuperTooltip1, ((C1.Win.C1FlexGrid.C1FlexGrid)sender), e.Location);
        }
        #endregion " C1 Grid Events "

        #region "Validate Claim using SDK"

        private void ValidateClaim()
        {
            TransactionLines oTransactionLines = null;
            ClsTransaction oClaimTransaction = new ClsTransaction();
            ClsServiceInfo oServiceInfo = null;

            try
            {
                oTransactionLines = UC_gloBillingTransactionLines.GetLineTransactions();
                if (oTransactionLines != null && oTransactionLines.Count > 0)
                {
                    for (int i = 0; i <= oTransactionLines.Count - 1; i++)
                    {
                        oServiceInfo = new ClsServiceInfo();
                        oClaimTransaction.ActionCode = "V";
                        oClaimTransaction.CodeSet = "";
                        oClaimTransaction.SearchTerms = "";
                        oClaimTransaction.TransactionID = i.ToString();
                        if (oPatientControl.PatientGender == "Male")
                        {
                            oClaimTransaction.Patient.Gender = "M";
                        }
                        else if (oPatientControl.PatientGender == "Female")
                        {
                            oClaimTransaction.Patient.Gender = "F";
                        }


                        oClaimTransaction.Patient.Day = oPatientControl.PatientDateOfBirth.Day.ToString();
                        oClaimTransaction.Patient.Month = oPatientControl.PatientDateOfBirth.Month.ToString();
                        oClaimTransaction.Patient.Year = oPatientControl.PatientDateOfBirth.Year.ToString();

                        oServiceInfo.FromDay = oTransactionLines[i].DateServiceFrom.Day.ToString();
                        oServiceInfo.FromMonth = oTransactionLines[i].DateServiceFrom.Month.ToString();
                        oServiceInfo.FromYear = oTransactionLines[i].DateServiceFrom.Year.ToString();

                        oServiceInfo.ToDay = oTransactionLines[i].DateServiceTill.Day.ToString();
                        oServiceInfo.ToMonth = oTransactionLines[i].DateServiceTill.Month.ToString();
                        oServiceInfo.ToYear = oTransactionLines[i].DateServiceTill.Year.ToString();

                        oServiceInfo.POS = oTransactionLines[i].POSCode;
                        oServiceInfo.ProcCode = oTransactionLines[i].CPTCode;


                        if (oTransactionLines[i].Dx1Ptr == true)
                        {
                            if (oTransactionLines[i].Dx1Code.Trim() != "")
                            {
                                oServiceInfo.DiagnosisList.Add(oTransactionLines[i].Dx1Code.Trim());
                            }
                            else
                            {
                                MessageBox.Show("Diagnosis has not been entered, cannot validate.  ", _messageBoxCaption, MessageBoxButtons.OK, MessageBoxIcon.Information);
                                return;
                            }
                        }
                        else
                        {
                            MessageBox.Show("Diagnosis has not been entered, cannot validate.  ", _messageBoxCaption, MessageBoxButtons.OK, MessageBoxIcon.Information);
                            return;
                        }

                        if (oTransactionLines[i].Dx2Ptr == true)
                        {
                            if (oTransactionLines[i].Dx2Code.Trim() != "")
                            {
                                oServiceInfo.DiagnosisList.Add(oTransactionLines[i].Dx2Code.Trim());
                            }
                        }

                        if (oTransactionLines[i].Dx3Ptr == true)
                        {
                            if (oTransactionLines[i].Dx3Code.Trim() != "")
                            {
                                oServiceInfo.DiagnosisList.Add(oTransactionLines[i].Dx3Code.Trim());
                            }
                        }

                        if (oTransactionLines[i].Dx4Ptr == true)
                        {
                            if (oTransactionLines[i].Dx4Code.Trim() != "")
                            {
                                oServiceInfo.DiagnosisList.Add(oTransactionLines[i].Dx4Code.Trim());
                            }
                        }

                        if (oTransactionLines[i].Mod1Code.Trim() != "") { oServiceInfo.ModifierList.Add(oTransactionLines[i].Mod1Code.Trim()); }
                        if (oTransactionLines[i].Mod2Code.Trim() != "") { oServiceInfo.ModifierList.Add(oTransactionLines[i].Mod2Code.Trim()); }


                        oClaimTransaction.Services.Add(oServiceInfo);

                        oServiceInfo = null;
                    }
                    SendClaimtoValidate(oClaimTransaction);
                }

            }
            catch (Exception ex)
            {
                gloAuditTrail.gloAuditTrail.ExceptionLog(ex, true);
            }
            finally
            {
                if (oTransactionLines != null) { oTransactionLines.Dispose(); }
                if (oClaimTransaction != null) { oClaimTransaction = null; }
                if (oServiceInfo != null) { oServiceInfo = null; }

            }
        }

        private void SendClaimtoValidate(ClsTransaction oClaimTransaction)
        {
            ClsClaimSubMittal oClaimSubMittal = default(ClsClaimSubMittal);
            //string _FilePath = AppDomain.CurrentDomain.BaseDirectory;
            string _FilePath = appSettings["StartupPath"].ToString() + "\\";
            try
            {

                if (oClaimTransaction != null)
                {
                    oClaimSubMittal = new ClsClaimSubMittal();
                    oClaimSubMittal.ChargesTransaction = oClaimTransaction;
                    oClaimSubMittal.ApplicationPath = appSettings["StartupPath"].ToString();
                    oClaimSubMittal.PostXML();
                    System.Text.StringBuilder strSearchResponse = default(System.Text.StringBuilder);
                    strSearchResponse = new System.Text.StringBuilder();

                    System.Text.StringBuilder strValidationResponse = default(System.Text.StringBuilder);
                    strValidationResponse = new System.Text.StringBuilder();

                    if (oClaimSubMittal.oSearchResponseList.Count > 0)
                    {
                        foreach (ClsSearchResponse oSearchResponse in oClaimSubMittal.oSearchResponseList)
                        {
                            strSearchResponse.Append("Code: " + oSearchResponse.Code);
                            strSearchResponse.Append("Description: " + oSearchResponse.Description);
                            strSearchResponse.Append(Environment.NewLine);
                        }
                    }
                    if (oClaimSubMittal.oValidationResponseList.Count > 0)
                    {
                        int icnt = 1;
                        foreach (ClsValidationResponse oValidationResponse in oClaimSubMittal.oValidationResponseList)
                        {
                            strValidationResponse.Append(Environment.NewLine);
                            strValidationResponse.Append("Result " + icnt.ToString());
                            //strValidationResponse.Append("Code: " + oValidationResponse.Code);
                            strValidationResponse.Append(Environment.NewLine);
                            strValidationResponse.Append("MedicalNecessity: " + FormatString(oValidationResponse.MedicalNecessity));
                            //strValidationResponse.Append(Environment.NewLine);
                            strValidationResponse.Append(Environment.NewLine);
                            //strValidationResponse.Append("Modifiers: " + oValidationResponse.Modifiers);
                            strValidationResponse.Append(Environment.NewLine);
                            strValidationResponse.Append("CCI: " + FormatString(oValidationResponse.CCI));
                            strValidationResponse.Append(Environment.NewLine);
                            strValidationResponse.Append(Environment.NewLine);
                            strValidationResponse.Append("Usage: " + FormatString(oValidationResponse.Usage));
                            strValidationResponse.Append(Environment.NewLine);
                            strValidationResponse.Append("----------------------------------------------------------------------");
                            strValidationResponse.Append(Environment.NewLine);
                            icnt++;
                        }
                    }

                    //MessageBox.Show(strSearchResponse.ToString() + Environment.NewLine + strValidationResponse.ToString(), "gloPM", MessageBoxButtons.OK, MessageBoxIcon.Information,MessageBoxDefaultButton.Button1,MessageBoxOptions.DefaultDesktopOnly);

                    if (strValidationResponse.ToString().Trim() != "")
                    {
                        gloAuditTrail.gloAuditTrail.CreateAuditLog(ActivityModule.Billing, ActivityCategory.SetupCharges, ActivityType.ValidateClaim, "Claim Validated", 0, Convert.ToInt64(oClaimTransaction.TransactionID), 0, ActivityOutCome.Success);

                        _FilePath = _FilePath + "ClaimValidation.txt";
                        System.IO.StreamWriter oStreamWriter = new System.IO.StreamWriter(_FilePath, false);
                        oStreamWriter.WriteLine(strValidationResponse.ToString());
                        oStreamWriter.Close();
                        oStreamWriter.Dispose();
                        System.Diagnostics.Process.Start(_FilePath);

                    }

                }
            }
            catch (ClsClaimSubmittalException) // claimEx)
            {
                //MessageBox.Show("ERROR : " + claimEx.Message, _messageBoxCaption, MessageBoxButtons.OK, MessageBoxIcon.Information); 
                MessageBox.Show("Connection to server failed. ", _messageBoxCaption, MessageBoxButtons.OK, MessageBoxIcon.Information);

                //claimEx.ToString();
                //claimEx = null;
            }
            catch (Exception ex)
            {
                gloAuditTrail.gloAuditTrail.ExceptionLog(ex, true);
            }
        }

        private string FormatString(string strResponse)
        {
            try
            {
                System.Text.RegularExpressions.Regex rxChar = new System.Text.RegularExpressions.Regex("[a-zA-Z]");
                System.Text.RegularExpressions.Regex rxNum = new System.Text.RegularExpressions.Regex("[0-9]");
                for (int i = strResponse.Length - 1; i > 0; i--)
                {
                    if (rxChar.Match(strResponse[i].ToString()).Success == true && rxNum.Match(strResponse[i - 1].ToString()).Success == true)
                    {
                        strResponse = strResponse.Insert(i, " ");
                    }
                    if (rxNum.Match(strResponse[i].ToString()).Success == true && rxChar.Match(strResponse[i - 1].ToString()).Success == true)
                    {
                        strResponse = strResponse.Insert(i, " ");
                    }
                }
                strResponse = strResponse.Replace("CPT ", "CPT");
                strResponse = strResponse.Replace("ICD ", Environment.NewLine + "ICD");
                strResponse = strResponse.Replace("MN ", "MN");
                strResponse = strResponse.Replace("CCI ", "CCI");
            }
            catch (Exception ex)
            {
                gloAuditTrail.gloAuditTrail.ExceptionLog(ex, false);
            }
            return strResponse;
        }

        #endregion

        #region "Menu Events"

        private void mnuBilling_AddNote_Click(object sender, EventArgs e)
        {
            tlb_AddNotes.PerformClick();
        }

        private void mnuBilling_ValidateClaim_Click(object sender, EventArgs e)
        {
            tls_btnValidateProcedure.PerformClick();
        }

        private void mnuBilling_AddLine_Click(object sender, EventArgs e)
        {
            if (_isClaimVoided == false)
            { tls_btnAddLine.PerformClick(); }
        }

        private void mnuBilling_RemoveLine_Click(object sender, EventArgs e)
        {
            if (_isClaimVoided == false)
            { tls_btnRemoveLine.PerformClick(); }
        }

        private void mnuBilling_AddNote_Click_1(object sender, EventArgs e)
        {
            if (_isClaimVoided == false)
            { tlb_AddNotes.PerformClick(); }
        }

        private void mnuBilling_Save_Click(object sender, EventArgs e)
        {
            if (_isClaimVoided == false)
            { tls_btnSaveNClose.PerformClick(); }
        }

        private void tls_btnAddLine_Click(object sender, EventArgs e)
        {
            try
            {

                #region " Add Line "
                if (!(UC_gloBillingTransactionLines == null))
                {
                    //Commented by Pramod Nair to remove the service line restriction
                    if (UC_gloBillingTransactionLines.GetLinesCount() <= _NoOfMaxServiceLines)
                    {

                        #region "Get Selected Insurance"

                        string _fillInsuranceName = "";
                        Int64 _fillInsuranceID = 0;
                        Int32 _fillInsSelfMode = 0;

                        if (c1Insurance.Rows.Count > 0)
                        {
                            for (int i = 1; i <= c1Insurance.Rows.Count - 1; i++)
                            {
                                if (c1Insurance.GetCellCheck(i, COL_SELECT) == CheckEnum.Checked)
                                {
                                    _fillInsuranceID = Convert.ToInt64(c1Insurance.GetData(i, COL_INSURANCEID));
                                    _fillInsuranceName = Convert.ToString(c1Insurance.GetData(i, COL_INSURANCENAME));
                                    _fillInsSelfMode = Convert.ToInt32(c1Insurance.GetData(i, COL_INSSELFMODE));
                                    break;
                                }
                            }
                        }

                        #endregion

                        #region " Add new Line to Billing Control "

                        //20100503 - Hot Fix Rendering Provider Issue - Laod the Referral Provider From Admin settings and apply to service lines

                        #region "Setting the Rendering Provider"

                        if (this.RenderingProviderID > 0)
                        {
                            UC_gloBillingTransactionLines.DefaultRenderingProviderID = RenderingProviderID;
                            UC_gloBillingTransactionLines.DefaultRenderringProviderName = RenderingProviderName;
                        }
                        else if (this.PatientPoviderID > 0)
                        {
                            UC_gloBillingTransactionLines.DefaultRenderingProviderID = this.PatientPoviderID;
                            UC_gloBillingTransactionLines.DefaultRenderringProviderName = this.PatientProviderName;
                        }
                        else
                        {
                            if (cmbBillingProvider != null && cmbBillingProvider.Items.Count > 0)
                            {
                                if (cmbBillingProvider.SelectedIndex != -1)
                                {
                                    UC_gloBillingTransactionLines.DefaultRenderingProviderID = Convert.ToInt64(cmbBillingProvider.SelectedValue);
                                    UC_gloBillingTransactionLines.DefaultRenderringProviderName = Convert.ToString(cmbBillingProvider.Text);
                                    UC_gloBillingTransactionLines.BillingProviderID = Convert.ToInt64(cmbBillingProvider.SelectedValue);
                                }
                            }
                        }

                        #endregion

                        UC_gloBillingTransactionLines.AddTransactionLine();

                        #endregion " Add new Line to Billing Control "

                        #region " Set the Insurance to added Line "

                        if (UC_gloBillingTransactionLines != null)
                        {
                            if ((_fillInsuranceID > 0 || _fillInsSelfMode == 3))
                            {
                                UC_gloBillingTransactionLines.AddInsurance(UC_gloBillingTransactionLines.CurrentTransactionLine, _fillInsuranceID, _fillInsuranceName, _fillInsSelfMode);
                            }
                            else if (_fillInsSelfMode == 1) //if no insurance present set SELF
                            {
                                UC_gloBillingTransactionLines.AddInsurance(UC_gloBillingTransactionLines.CurrentTransactionLine, _fillInsuranceID, _fillInsuranceName, _fillInsSelfMode);
                            }
                        }

                        #endregion " Set the Insurance to added Line "


                        #region " Set Close Date to addedd Line "
                        if (UC_gloBillingTransactionLines != null)
                        {
                            //Previously the close date was getting applied to all the service line .But as per Phil requirement on 20100410 [ The next charge defaults to the Close Date  not so good.  It is supposed to default to the previous charges DOS.]
                            if (IsValidDate(mskClaimDate.Text) == true && UC_gloBillingTransactionLines.GetLinesCount() == 2)
                            {
                                UC_gloBillingTransactionLines.SetServiceLineDate(UC_gloBillingTransactionLines.CurrentTransactionLine, Convert.ToDateTime(mskClaimDate.Text));
                            }
                        }
                        #endregion " Set Close Date to addedd Line "


                        #region " Select the added Line "

                        UC_gloBillingTransactionLines.SelectTransactionLine(UC_gloBillingTransactionLines.CurrentTransactionLine);
                        UC_gloBillingTransactionLines_onGrid_SelChanged(null, null);

                        #endregion " Select the added Line "

                        if (chkFacilityFeeSchedule.Checked == false && chkNonFacilityCharges.Checked == false)
                        {
                            SetFacility(); // if due to some reason above line dont have any facility or non facility charge then select default once.
                        }

                        if (UC_gloBillingTransactionLines.GetLinesCount() == 2)
                        {
                            //Set default POS To the Trasaction Lines
                            if (UC_gloBillingTransactionLines.FacilityPOS > 0)
                            {
                                if (UC_gloBillingTransactionLines != null)
                                {
                                    UC_gloBillingTransactionLines.SetFacilityPOS();
                                }
                            }
                        }


                        UC_gloBillingTransactionLines.SortControl();

                        gloAuditTrail.gloAuditTrail.CreateAuditLog(ActivityModule.Billing, ActivityCategory.SetupCharges, ActivityType.AddTransactionLine, "Transaction Line added to Billing Control,Line Number : " + UC_gloBillingTransactionLines.CurrentTransactionLine + " ", this.PatientID, _TransactionID, _PatientPoviderID, ActivityOutCome.Success);
                    }
                    else
                    {
                        MessageBox.Show(" Claim has a max limit of " + _NoOfMaxServiceLines + " service lines. ", _messageBoxCaption, MessageBoxButtons.OK, MessageBoxIcon.Warning);
                    }

                }

                #endregion
            }
            catch (Exception ex)
            {
                gloAuditTrail.gloAuditTrail.ExceptionLog(ex, false);
            }
        }

        private void tls_btnRemoveLine_Click(object sender, EventArgs e)
        {
            try
            {
                if (UC_gloBillingTransactionLines != null && UC_gloBillingTransactionLines.GetLinesCount() > 1)
                {
                    if (MessageBox.Show("Are you sure you want  to remove  selected service line?", _messageBoxCaption, MessageBoxButtons.YesNo, MessageBoxIcon.Question, MessageBoxDefaultButton.Button2) == DialogResult.Yes)
                    {
                        if (!(UC_gloBillingTransactionLines == null))
                        {
                            UC_gloBillingTransactionLines.DeleteTransactionLine(UC_gloBillingTransactionLines.CurrentTransactionLine);
                            gloAuditTrail.gloAuditTrail.CreateAuditLog(ActivityModule.Billing, ActivityCategory.SetupCharges, ActivityType.RemoveTransactionLine, "Transaction Line removed from Billing Control,Line Number : " + UC_gloBillingTransactionLines.CurrentTransactionLine + " ", this.PatientID, _TransactionID, _PatientPoviderID, ActivityOutCome.Success);
                            UC_gloBillingTransactionLines.SortControl();

                            if (UC_gloBillingTransactionLines.GetLinesCount() == 1)
                            {
                                DesignDxGrid();
                            }
                        }
                        //UpdateInsurancePayment();
                        if (UC_gloBillingTransactionLines != null && UC_gloBillingTransactionLines.GetLinesCount() > 1)
                        {
                            if ((UC_gloBillingTransactionLines.GetItem(UC_gloBillingTransactionLines.CurrentTransactionLine, COL_CPT_CODE) != null) && (UC_gloBillingTransactionLines.GetItem(UC_gloBillingTransactionLines.CurrentTransactionLine, COL_CPT_CODE).ToString().Trim() != ""))
                            {
                                tls_btnMoreChargeData.Enabled = true;
                                tls_Anesthesia.Enabled = true;
                            }
                            else
                            {
                                tls_btnMoreChargeData.Enabled = false;
                                tls_Anesthesia.Enabled = false;
                            }

                            using (DataTable dtAppointments = this.GetPatientAppointments())
                            {
                                if (!this.lstAppointmentIDs.Any())
                                {

                                    if (dtAppointments != null && dtAppointments.Rows.Count > 0)
                                    {
                                        this.SetPatientAppointmentsAvailable();
                                        this.PatientHasAppointments = true;
                                    }
                                    else
                                    {
                                        this.ResetPatientAppointments();
                                        this.PatientHasAppointments = false;
                                    }

                                }

                                this.LoadAppointmentsInList(dtAppointments);
                                this.CheckMorePatientAppointments(dtAppointments);
                            }
                        }
                        else
                        {
                            tls_btnMoreChargeData.Enabled = false;
                            tls_Anesthesia.Enabled = false;
                        }
                        UC_gloBillingTransactionLines.getfirstservicelineCLIA();
                    }

                    SelectPrimaryInsurance();
                    SyncronizeDxGridWithServiceline();
                }
            }
            catch (Exception ex)
            {
                gloAuditTrail.gloAuditTrail.ExceptionLog(ex, false);
            }
        }

        private void tlb_AddNotes_Click(object sender, EventArgs e)
        {

            #region " Add Notes "

            GeneralNotes oNotes = null;
            Int64 _nMyTransactionlineno = 0;
            gloDatabaseLayer.DBLayer oDB = null;
            try
            {
                if (UC_gloBillingTransactionLines.CurrentTransactionLine > 0)
                {
                    if (UC_gloBillingTransactionLines.TransactionLineNo == 0)
                    {
                        oNotes = UC_gloBillingTransactionLines.GetNotes(UC_gloBillingTransactionLines.CurrentTransactionLine);
                        _nMyTransactionlineno = UC_gloBillingTransactionLines.CurrentTransactionLine;

                    }
                    else
                    {
                        oNotes = UC_gloBillingTransactionLines.GetNotes(UC_gloBillingTransactionLines.TransactionLineNo);
                        _nMyTransactionlineno = UC_gloBillingTransactionLines.TransactionLineNo;
                    }


                    frmNotes ofrmNotes = new frmNotes(_DatabaseConnectionString, _ClinicID, _TransactionID, UC_gloBillingTransactionLines.TransactionDetailID, _nMyTransactionlineno, oNotes);
                    ofrmNotes.nChildTransactionID = _MasterTransactionID;
                    oDB = new gloDatabaseLayer.DBLayer(_DatabaseConnectionString);

                    #region " Fetch The MasterDetailID "

                    string strQuery = " SELECT nTransactionMasterDetailID FROM  BL_Transaction_Claim_Lines WITH (NOLOCK)  " +
                                      " WHERE nTransactionMasterID=" + _MasterTransactionID + " " +
                                      " AND nTransactionID = " + _TransactionID;
                    if (Convert.ToInt64(UC_gloBillingTransactionLines.TransactionDetailID) != 0)
                    {
                        strQuery = strQuery + " and nTransactionDetailID = " + UC_gloBillingTransactionLines.TransactionDetailID;
                    }
                    //Bug #87335: 00000965 : Claim line shows payment note of other claim line
                    strQuery = strQuery + " order by nTransactionLineNo";
                    object _Result = null;
                    oDB.Connect(false);

                    _Result = oDB.ExecuteScalar_Query(strQuery);

                    if (_Result != null && Convert.ToString(_Result) != "")
                    {
                        ofrmNotes.nTransactionMasterDetailID = Convert.ToInt64(_Result);
                    }
                    oDB.Disconnect();


                    #endregion


                    if (IsClaimVoided)
                    {
                        ofrmNotes.IsVoidShowNote = true;
                    }

                    ofrmNotes.ShowDialog(this);
                    if (ofrmNotes.DeletedNoteHistoryID!=null)
                    {
                        sDeletedNoteHistoryID = ofrmNotes.DeletedNoteHistoryID.Remove(0, 1);
                    }

                    if (ofrmNotes.oDialogResult)
                    {
                        UC_gloBillingTransactionLines.SetNotes(ofrmNotes.oNotes);
                        if (ofrmNotes.oNotes != null)
                        {
                            gloAuditTrail.gloAuditTrail.CreateAuditLog(ActivityModule.Billing, ActivityCategory.SetupCharges, ActivityType.Add, "Note added to trasanction line, Line No : " + UC_gloBillingTransactionLines.CurrentTransactionLine.ToString() + " of Claim # : " + txtClaimNo.Text + ".", PatientID, _TransactionID, _PatientPoviderID, ActivityOutCome.Success);
                        }
                    }
                    ofrmNotes.Dispose();
                }
                else
                {
                    MessageBox.Show("No transaction line is selected.  ", _messageBoxCaption, MessageBoxButtons.OK, MessageBoxIcon.Information);
                }
            }
            catch (Exception ex)
            {
                gloAuditTrail.gloAuditTrail.ExceptionLog(ex, true);
            }
            finally
            {
                if (oDB != null)
                {
                    oDB.Dispose();
                }
            }

            #endregion

        }

        private void tls_btnValidateProcedure_Click(object sender, EventArgs e)
        {
            switch (ClaimValidationServiceType)
            {
                case ClaimValidationService.YOST:
                    ValidateClaim();
                    break;
                case ClaimValidationService.Alpha2:
                    GetAlphaIISettings();
                    if (_AlphaIIValidation == "Alpha2")
                    {
                        if (ValidateConnectionString())
                        {
                            AlphaIIDiagnosisValidation();
                        }
                        else
                        {
                            MessageBox.Show("Connection for Alpha II cannot be establish, please do the setting from gloPM Admin.  ", _messageBoxCaption, MessageBoxButtons.OK, MessageBoxIcon.Information);
                            return;
                        }
                    }
                    break;
                case ClaimValidationService.None:
                    break;
                default:
                    break;
            }
        }

        private void tls_Top_Click(object sender, EventArgs e)
        {
            tls_Top.Select();
        }

        private void tls_btnVoidCharge_Click(object sender, EventArgs e)
        {
            gloBilling ogloBilling = new gloBilling(_DatabaseConnectionString, "");
            ClsBL_Hold oClsBL_Hold = new ClsBL_Hold(_DatabaseConnectionString, _emrdatabaseConnectionString);
            gloDatabaseLayer.DBLayer oDB = null;

            Int64 _retVal = 0;

            try
            {

                if (IsValidDate(mskClaimDate.Text) == false)
                {
                    MessageBox.Show("Please enter close date. ", _messageBoxCaption, MessageBoxButtons.OK, MessageBoxIcon.Information);
                    mskClaimDate.Focus();
                    mskClaimDate.Select();
                }
                else
                {
                    if (_MasterTransactionID > 0 && oPatientControl != null && oPatientControl.PatientID > 0)
                    {
                        string _voidReserveNotes = "";
                        Int64 _voidCloseDate = 0;
                        string _voidTrayName = "";
                        Int64 _voidTrayId = 0;
                        Int64 _priorAuthId = 0;
                        string _voidTrayCode = "";
                        string[] masterClaim = null;
                        char[] splitchar = { '-' };
                        Int64 _nProviderID = 0;
                        Int64 _nTrackTrnID = 0;
                        Int64 _nAccBusinessCenterID = 0;
                        bIsReplacementClaimRequired = false;
                        if (txtPriorAuthorizationNo.Tag != null && Convert.ToString(txtPriorAuthorizationNo.Tag) != "")
                        {
                            _priorAuthId = Convert.ToInt64(txtPriorAuthorizationNo.Tag.ToString());
                        }
                        else
                        {
                            _priorAuthId = 0;
                        }

                        #region "Check Whether the Transaction has child notes "

                        oDB = new gloDatabaseLayer.DBLayer(_DatabaseConnectionString);
                        oDB.Connect(false);
                        string strQuery = "";
                        DataTable _dtIsSplitted = null;

                        strQuery = " SELECT nTransactionID FROM dbo.BL_Transaction_Claim_MST WITH (NOLOCK) "
                                     + " WHERE nClaimNo = " + _InitialTransaction.ClaimNo + " and nTransactionID = " + _TransactionID
                                     + " AND ((SUBSTRING(nSubClaimNo,1,1) = '-' AND ISNULL(sMainClaimno,'') = '') "
                                     + " OR (SUBSTRING(nSubClaimNo,1,1) <> '-' AND ISNULL(nSubClaimNo,'') = '')) ";

                        oDB.Retrive_Query(strQuery, out _dtIsSplitted);

                        #endregion

                        DialogResult _dlgRst = DialogResult.Yes;

                        if (_dtIsSplitted == null || _dtIsSplitted.Rows.Count <= 0)
                        {
                            masterClaim = txtClaimNo.Text.Split(splitchar);
                            if (masterClaim.Length > 0)
                            {
                                _dlgRst = MessageBox.Show(txtClaimNo.Text + " is a split claim.  To void this split claim you must void its master claim " + masterClaim[0] + "."
                                            + Environment.NewLine
                                            + "Void claim " + masterClaim[0] + "?", gloGlobal.gloPMGlobal.MessageBoxCaption, MessageBoxButtons.YesNo, MessageBoxIcon.Question, MessageBoxDefaultButton.Button2);
                            }
                        }

                        if (_dlgRst == System.Windows.Forms.DialogResult.Yes)
                        {
                            //if (_dtIsSplitted != null && _dtIsSplitted.Rows.Count > 0)
                            //{
                            //    if (Convert.ToInt64(_dtIsSplitted.Rows[0]["nTransactionID"]) > 0)
                            //    {

                            _dlgRst = DialogResult.None;
                            String _strMessage = "Voiding the claim will:" + Environment.NewLine
                               + Environment.NewLine + "1) Mark the claim and any claim charges as Voided."
                               + Environment.NewLine + "2) Negate any adjustments."
                               + Environment.NewLine + "3) Move any patient payments to reserves."
                               + Environment.NewLine + "4) Move any insurance payments to reserves."
                               + Environment.NewLine + "5) Move the claim into the Batch Void tab."
                               + Environment.NewLine + "6) Subtract charge amounts from reports."
                               + Environment.NewLine + "7) Leave a record of this voided claim on the patients account."
                               + Environment.NewLine + Environment.NewLine + "Do you want to continue?";
                            _dlgRst = MessageBox.Show(_strMessage, _messageBoxCaption, MessageBoxButtons.YesNo, MessageBoxIcon.Question, MessageBoxDefaultButton.Button2);
                            if (_dlgRst == DialogResult.Yes)
                            {
                                GeneralNotes oNotes = new GeneralNotes();
                                frmSetupTransactionNotes ofrmNotes = new frmSetupTransactionNotes(_DatabaseConnectionString, _ClinicID, _MasterTransactionID, 0, 0, oNotes, _InitialTransaction, _priorAuthId, txtPriorAuthorizationNo.Text);
                                ofrmNotes.nChildTransactionID = _TransactionID;
                                ofrmNotes._IsVoidNote = true;
                                this.DialogResult = DialogResult.None;
                                ofrmNotes.ShowDialog(this);
                                if (ofrmNotes.oDialogResult)
                                {
                                    if (ofrmNotes.oNote != null)
                                    {
                                        _voidReserveNotes = ofrmNotes.oNote.NoteDescription.Trim();

                                        _voidCloseDate = ofrmNotes.VoidCloseDate;
                                        _voidTrayName = ofrmNotes.VoidTrayName;
                                        _voidTrayId = ofrmNotes.VoidTrayID;
                                        _voidTrayCode = ofrmNotes.VoidTrayCode;
                                        bIsReplacementClaimRequired = ofrmNotes.bIsReplacementClaimRequired;
                                    }
                                }
                                ofrmNotes.Dispose();


                                if (_voidReserveNotes != "")
                                {
                                    this.Cursor = Cursors.WaitCursor;

                                    ogloBilling.VoidClaim(_MasterTransactionID, true, _UserID, _UserName);

                                    oClsBL_Hold.ReleaseHoldIfVoided(_TransactionID, _UserID);

                                    if (_nProviderID == 0)
                                    {
                                        DataTable _dtDefaultPatientProvider = null;
                                        _dtDefaultPatientProvider = gloAccountsV2.gloBillingCommonV2.GetBillingProvider(_MasterTransactionID);
                                        if (_dtDefaultPatientProvider != null && _dtDefaultPatientProvider.Rows.Count > 0)
                                        {
                                            _nProviderID = Convert.ToInt64(_dtDefaultPatientProvider.Rows[0]["nProviderID"]);
                                            _nTrackTrnID = Convert.ToInt64(_dtDefaultPatientProvider.Rows[0]["nTransactionID"]);
                                        }
                                    }

                                    DataTable dtChargesBusCenter = gloCharges.GetChargeBusinessCenterSettings();
                                    if (dtChargesBusCenter != null && dtChargesBusCenter.Rows.Count > 0)
                                    {
                                        if (Convert.ToBoolean(dtChargesBusCenter.Rows[0]["businesscenter_feature"]) == true)
                                        {
                                            DataTable dtAccBussinessCenter = gloCharges.GetPatientAccountBusinessCenter(nPAccountID);
                                            if (dtAccBussinessCenter != null && dtAccBussinessCenter.Rows.Count > 0)
                                            {
                                                _nAccBusinessCenterID = Convert.ToInt64(dtAccBussinessCenter.Rows[0]["nBusinessCenterID"]);
                                            }
                                        }
                                    }

                                    gloAccountsV2.gloInsurancePaymentV2 ogloInsurancePaymentV2 = new gloAccountsV2.gloInsurancePaymentV2();
                                    _retVal = ogloInsurancePaymentV2.UpdatePatientPaymentForVoid(_voidReserveNotes, Convert.ToDateTime(gloDateMaster.gloDate.DateAsDate(_voidCloseDate)), _voidTrayId, _voidTrayName, _MasterTransactionID, _ClinicID, _nProviderID, _nTrackTrnID, _UserID, _UserName, Environment.MachineName);
                                    ogloInsurancePaymentV2.UpdateInsurancePaymentForClaimVoid(_voidReserveNotes, Convert.ToDateTime(gloDateMaster.gloDate.DateAsDate(_voidCloseDate)), _voidTrayId, _voidTrayName, _MasterTransactionID, _ClinicID, _nProviderID, _nTrackTrnID, _UserID, _UserName, Environment.MachineName, _nAccBusinessCenterID);
                                    ogloInsurancePaymentV2.Dispose();

                                    #region "Claim Insurance Follow Up Operations"
                                    CL_FollowUpCode.ClearInsuranceClaimFollowUp(_TransactionID);
                                    #endregion "Claim Insurance Follow Up Operations"

                                    SetVoidViewMode();
                                    IsClaimVoided = true;

                                    // Changes for Bug ID 67132 - 8020
                                    //CL_FollowUpCode.SetAutoAccountFollowUp(oPatientControl.PAccountID, oPatientControl.PatientID, Convert.ToDateTime(gloDateMaster.gloDate.DateAsDate(_voidCloseDate)));
                                    CL_FollowUpCode.SetAutoAccountFollowUp(_InitialTransaction.PAccountID, _InitialTransaction.PatientID, gloDateMaster.gloDate.DateAsDate(_voidCloseDate));
                                    // End Changes for Bug ID 67132 - 8020                                    

                                    FetchVoidedInformation();
                                    ShowVoidMessage();
                                    IsModified = true;

                                    if (_retVal > 0)
                                    {
                                        SetVoidViewMode();
                                        IsClaimVoided = true;
                                        FetchVoidedInformation();
                                        ShowVoidMessage();
                                        IsModified = true;
                                        tls_FollowUpActionDate.Enabled = false;
                                        tsbClaimGenerateTemp.Enabled = false;
                                        //..Set the patient balances
                                        oPatientControl.RefreshBalances();
                                    }

                                    if (bIsReplacementClaimRequired)
                                    {
                                        CopyClaim(ReplacementClaimCreationType.Replacement);
                                    }
                                    this.Cursor = Cursors.Default;
                                }

                            }

                        }
                    }

                }
            }
            catch (Exception ex)
            {
                MessageBox.Show("ERROR : " + ex.Message, _messageBoxCaption, MessageBoxButtons.OK, MessageBoxIcon.Information);
                //ex.ToString();
                //ex = null;
            }
            finally
            {
                oDB.Disconnect();
                if (oDB != null) { oDB.Dispose(); }
                if (ogloBilling != null) { ogloBilling.Dispose(); }
                if (oClsBL_Hold != null) { oClsBL_Hold.Dispose(); }
                this.Cursor = Cursors.Default;
            }
        }

        private void tls_Hold_Click(object sender, EventArgs e)
        {
            ClsBL_Hold oClsBL_Hold = new ClsBL_Hold(_DatabaseConnectionString, _emrdatabaseConnectionString);
            string sBatchName = "";
            try
            {
                #region " Checking For Parent Claim "

                if (oClsBL_Hold.IsParentClaim(_TransactionID))
                {
                    MessageBox.Show("Split claims cannot be placed on Hold. Review the new claims that have been created.", _messageBoxCaption, MessageBoxButtons.OK, MessageBoxIcon.Information);
                }
                else
                {
                    #region " Checking Transaction Status "

                    switch (_InitialTransaction.Transaction_Status)
                    {
                        case TransactionStatus.InsurancePaid:

                            MessageBox.Show("Split claims cannot be placed on Hold. Review the new claims that have been created.", _messageBoxCaption, MessageBoxButtons.OK, MessageBoxIcon.Information);

                            break;
                        case TransactionStatus.Batch:

                            if (!_oClaimHold.IsHold)
                            {
                                sBatchName = GetBatchName(_InitialTransaction.TransactionID, _InitialTransaction.TransactionMasterID);
                                if (sBatchName != "")
                                {
                                    if (MessageBox.Show("Claim has been included in batch [" + sBatchName + "]. It will be put on hold and removed from batch?" + Environment.NewLine + "Continue?", _messageBoxCaption, MessageBoxButtons.YesNo, MessageBoxIcon.Information) == DialogResult.Yes)
                                    {
                                        PerformHoldInformation();
                                    }
                                }
                                else
                                {
                                    PerformHoldInformation();
                                }
                            }
                            else
                            {
                                PerformHoldInformation();
                            }

                            break;
                        case TransactionStatus.SendToClaimManager:

                            PerformHoldInformation();

                            break;
                        default:

                            PerformHoldInformation();

                            break;

                    }

                    #endregion
                }

                #endregion

            }
            catch (Exception ex)
            {
                gloAuditTrail.gloAuditTrail.ExceptionLog(ex, true);
            }
            finally
            {
                if (oClsBL_Hold != null) { oClsBL_Hold.Dispose(); }
            }
        }

        private void tls_btnMoreChargeData_Click(object sender, EventArgs e)
        {
            string sNDCCode = "";
            TransactionLine oLineTransaction = null;
            TransactionLines oLineTransactions = null;

            #region " Add Charge Fields "

            try
            {
                oLineTransactions = UC_gloBillingTransactionLines.GetLineTransactions();

                if (UC_gloBillingTransactionLines.CurrentTransactionLine > 0)
                {
                    if ((Convert.ToString(UC_gloBillingTransactionLines.GetItem(UC_gloBillingTransactionLines.CurrentTransactionLine, COL_CPT_CODE)).Trim() != "") || (UC_gloBillingTransactionLines.GetItem(UC_gloBillingTransactionLines.CurrentTransactionLine, COL_CPT_CODE) != null))
                    {
                        if (oLineTransactions[UC_gloBillingTransactionLines.CurrentTransactionLine - 1].NDCCode != "" && oLineTransactions[UC_gloBillingTransactionLines.CurrentTransactionLine - 1].NDCCode != null)
                        {
                            frmDrugBilling ofrmDrugBilling = new frmDrugBilling(_DatabaseConnectionString, oLineTransactions[UC_gloBillingTransactionLines.CurrentTransactionLine - 1]);
                            ofrmDrugBilling.bIsOpenforModify = true;
                            if (IsClaimVoided)
                            {
                                ofrmDrugBilling.bIsVoid = true;
                            }
                            ofrmDrugBilling.ShowDialog(this);

                            if (ofrmDrugBilling.oDialogResult)
                            {
                                oLineTransaction = ofrmDrugBilling._oTransLine;
                                UC_gloBillingTransactionLines.SetNDCFields(oLineTransaction);

                            }
                            ofrmDrugBilling._oTransLine.Dispose();
                            ofrmDrugBilling.Dispose();
                        }
                        else if (gloCharges.GetDefaultNDCForCPT(Convert.ToString(UC_gloBillingTransactionLines.GetItem(UC_gloBillingTransactionLines.CurrentTransactionLine, COL_CPT_CODE)).Trim(), ref sNDCCode))
                        {
                            oLineTransactions[UC_gloBillingTransactionLines.CurrentTransactionLine - 1].NDCCode = sNDCCode;
                            frmDrugBilling ofrmDrugBilling = new frmDrugBilling(_DatabaseConnectionString, oLineTransactions[UC_gloBillingTransactionLines.CurrentTransactionLine - 1]);

                            if (IsClaimVoided)
                            {
                                ofrmDrugBilling.bIsVoid = true;
                            }

                            ofrmDrugBilling.ShowDialog(this);

                            if (ofrmDrugBilling.oDialogResult)
                            {
                                oLineTransaction = ofrmDrugBilling._oTransLine;
                                UC_gloBillingTransactionLines.SetNDCFields(oLineTransaction);
                                oLineTransaction.Dispose();
                                oLineTransactions.Dispose();
                            }
                            ofrmDrugBilling._oTransLine.Dispose();
                            ofrmDrugBilling.Dispose();
                        }
                        else if (sNDCCode.Trim() != "")
                        {
                            oLineTransactions[UC_gloBillingTransactionLines.CurrentTransactionLine - 1].NDCCode = sNDCCode;
                            frmDrugBilling ofrmDrugBilling = new frmDrugBilling(_DatabaseConnectionString, oLineTransactions[UC_gloBillingTransactionLines.CurrentTransactionLine - 1]);

                            if (IsClaimVoided)
                            {
                                ofrmDrugBilling.bIsVoid = true;
                            }

                            ofrmDrugBilling.ShowDialog(this);

                            if (ofrmDrugBilling.oDialogResult)
                            {
                                oLineTransaction = ofrmDrugBilling._oTransLine;
                                UC_gloBillingTransactionLines.SetNDCFields(oLineTransaction);
                                oLineTransaction.Dispose();
                                oLineTransactions.Dispose();
                            }
                            ofrmDrugBilling._oTransLine.Dispose();
                            ofrmDrugBilling.Dispose();
                        }
                        else
                        {
                            frmDrugBilling ofrmDrugBilling = new frmDrugBilling(_DatabaseConnectionString, oLineTransactions[UC_gloBillingTransactionLines.CurrentTransactionLine - 1]);

                            if (IsClaimVoided)
                            {
                                ofrmDrugBilling.bIsVoid = true;
                            }

                            ofrmDrugBilling.ShowDialog(this);

                            if (ofrmDrugBilling.oDialogResult)
                            {
                                oLineTransaction = ofrmDrugBilling._oTransLine;
                                UC_gloBillingTransactionLines.SetNDCFields(oLineTransaction);
                                oLineTransaction.Dispose();
                                oLineTransactions.Dispose();
                            }
                            ofrmDrugBilling._oTransLine.Dispose();
                            ofrmDrugBilling.Dispose();
                        }
                    }

                }
                else
                {
                    MessageBox.Show("No transaction line is selected.  ", _messageBoxCaption, MessageBoxButtons.OK, MessageBoxIcon.Information);
                }
            }
            catch (Exception ex)
            {
                gloAuditTrail.gloAuditTrail.ExceptionLog(ex, false);
            }
            finally
            {
                //oLineTransaction.Dispose();
                //oLineTransactions.Dispose();
            }

            #endregion
        }

        private void tls_btnMoreClaimData_Click(object sender, EventArgs e)
        {
            try
            {
                #region " Add Claim Box19 Notes "

                frmReplacementClaimIndication ofrmReplacementClaimIndication = new frmReplacementClaimIndication(_DatabaseConnectionString, _ClinicID, _TransactionID, _oBox19Notes, _sClaimRefNo, _IsbCliamReplacement, _IllnessDate);
                ofrmReplacementClaimIndication.ClaimBox10dNote = _sBox10dNote;
                ofrmReplacementClaimIndication.sDelayReasonCode = _sDelayReasonCode;
                ofrmReplacementClaimIndication.sServiceAuthExceptionCode = _sServiceAuthExceptionCode;
                ofrmReplacementClaimIndication.sMedicaidRebumissionCode = _sMedicaidResubmissionCode;
                ofrmReplacementClaimIndication.bIsRefProAsSupervisor = bIsRefProvAsSupervisor;
                ofrmReplacementClaimIndication.bEnableSupervisorOption = bEnableSupervisorOption;


                ofrmReplacementClaimIndication.PAccountID = oPatientControl.PAccountID;
                ofrmReplacementClaimIndication.AccountPatientID = oPatientControl.AccountPatientID;
                ofrmReplacementClaimIndication.PatientID = oPatientControl.CmbSelectedPatientID;

                ofrmReplacementClaimIndication.nReplacementByTransMasterID = nReplacementByTransMasterID;
                ofrmReplacementClaimIndication.nReplacingTransMasterID = nReplacingTransMasterID;
                ofrmReplacementClaimIndication.bShowReplacementClaim = true;
                ofrmReplacementClaimIndication.LastSeenDate = _LastSeenDate;
                ofrmReplacementClaimIndication.bIsSupProvSavedForExClaims = bIsSupProvSavedForExClaims;

                if (_InitialTransaction.IsRebill == true)
                {
                    ofrmReplacementClaimIndication.bIsRebilled = true;
                }
                if (IsClaimVoided)
                {
                    ofrmReplacementClaimIndication.bIsVoid = true;
                }
                ofrmReplacementClaimIndication.bIsUB = tls_AddUBData.Visible;

                ofrmReplacementClaimIndication.MoreClaimData_UnableToWorkFrom = _UnableToWorkFromDate_MoreClaimData;
                ofrmReplacementClaimIndication.MoreClaimData_UnableToWorkTill = _UnableToWorkTillDate_MoreClaimData;
                
                ofrmReplacementClaimIndication.sPWKReportTypeCode = _sPWKReportTypeCode;
                ofrmReplacementClaimIndication.sPWKReportTransmissionCode = _sPWKReportTransmissionCode;
                ofrmReplacementClaimIndication.sPWKAttachmentControlNumber = _sPWKAttachmentControlNumber;
                ofrmReplacementClaimIndication.sMammogramCertNumber =_sMammogramCertNumber;
                ofrmReplacementClaimIndication.sIDENo = _sIDENo;
                ofrmReplacementClaimIndication.ShowDialog(this);
                _oBox19Note = ofrmReplacementClaimIndication._oBox19Note;
                _sBox10dNote = ofrmReplacementClaimIndication.ClaimBox10dNote;
                if (ofrmReplacementClaimIndication.oDialogResult)
                {


                    if (_oBox19Notes.Count > 0)
                        _oBox19Notes.Clear();
                    _oBox19Notes.Add(_oBox19Note);

                    _IsbCliamReplacement = ofrmReplacementClaimIndication.IsbCliamReplacement;
                    _sClaimRefNo = ofrmReplacementClaimIndication.sClaimRefNo;
                    _IllnessDate = ofrmReplacementClaimIndication.IllnessDate;
                    _LastSeenDate = ofrmReplacementClaimIndication.LastSeenDate;
                    _UnableToWorkFromDate_MoreClaimData = ofrmReplacementClaimIndication.MoreClaimData_UnableToWorkFrom;
                    _UnableToWorkTillDate_MoreClaimData = ofrmReplacementClaimIndication.MoreClaimData_UnableToWorkTill;
                    _sDelayReasonCode = ofrmReplacementClaimIndication.sDelayReasonCode;
                    _sServiceAuthExceptionCode = ofrmReplacementClaimIndication.sServiceAuthExceptionCode;
                    bIsRefProvAsSupervisor = ofrmReplacementClaimIndication.bIsRefProAsSupervisor;
                    _sMedicaidResubmissionCode = ofrmReplacementClaimIndication.sMedicaidRebumissionCode;

                    nReplacementByTransMasterID = ofrmReplacementClaimIndication.nReplacementByTransMasterID;
                    nReplacingTransMasterID = ofrmReplacementClaimIndication.nReplacingTransMasterID;

                    _sPWKReportTypeCode = ofrmReplacementClaimIndication.sPWKReportTypeCode;
                    _sPWKReportTransmissionCode = ofrmReplacementClaimIndication.sPWKReportTransmissionCode;
                    _sPWKAttachmentControlNumber = ofrmReplacementClaimIndication.sPWKAttachmentControlNumber;
                    _sMammogramCertNumber = ofrmReplacementClaimIndication.sMammogramCertNumber;
                    _sIDENo = ofrmReplacementClaimIndication.sIDENo;
                    pnlReplacedByClaim.Visible = false;
                    pnlReplacesClaim.Visible = false;
                    lblReplacedByClaim.Text = "";
                    lblReplacesClaim.Text = "";
                    lblReplacesClaim.Tag = "";
                    lblReplacedByClaim.Tag = "";

                    if (nReplacementByTransMasterID > 0)
                    {
                        lblReplacedByClaim.Text = "Replaced By Claim : " + ofrmReplacementClaimIndication.sReplacementByClaimNo;
                        lblReplacedByClaim.Tag = nReplacementByTransMasterID;
                        pnlReplacedByClaim.Visible = true;
                        pnlAlerts.Visible = true;
                    }
                    if (nReplacingTransMasterID > 0)
                    {
                        lblReplacesClaim.Text = "Replaces Claim :  " + ofrmReplacementClaimIndication.sReplacingClaimNo;
                        lblReplacesClaim.Tag = nReplacingTransMasterID;
                        pnlReplacesClaim.Visible = true;
                        pnlAlerts.Visible = true;

                    }

                }
                else
                {
                    if (_oBox19Notes.Count > 0)
                        _oBox19Notes.Clear();
                    _oBox19Notes.Add(_oBox19Note);
                }
                ofrmReplacementClaimIndication._oBox19Note.Dispose();
                ofrmReplacementClaimIndication.Dispose();
                SetHoldnMoreClaimDataMesseges();
                //if (lblHoldMessage.Text.Trim() != string.Empty)
                //{
                //    if (_IsbCliamReplacement || (bIsRefProvAsSupervisor && bEnableSupervisorOption) || _sClaimRefNo != "" || (_oBox19Notes != null && _oBox19Notes.Count >= 0 && _oBox19Notes[0].Box19NoteDescription.Trim() != "") || (_sBox10dNote.Trim() != "") || _IllnessDate > 0 || _LastSeenDate > 0 || _sDelayReasonCode.Trim() != "" || _sServiceAuthExceptionCode.Trim() != "" || _sMedicaidResubmissionCode.Trim() != "" || _UnableToWorkFromDate_MoreClaimData > 0 || _UnableToWorkTillDate_MoreClaimData > 0)
                //    {
                //        if (!lblHoldMessage.Text.Contains("More Claim Data is present"))
                //            lblHoldMessage.Text = lblHoldMessage.Text + "; " + "More Claim Data is present";
                //    }
                //    else
                //    {
                //        if (lblHoldMessage.Text.Contains(";"))
                //        {
                //            if (lblHoldMessage.Text.Contains("; More Claim Data is present"))
                //                lblHoldMessage.Text = lblHoldMessage.Text.Trim().Remove(lblHoldMessage.Text.Trim().IndexOf("; More Claim Data is present"));
                //        }
                //        else
                //        {
                //            if (lblHoldMessage.Text.Contains("More Claim Data is present"))
                //                lblHoldMessage.Text = lblHoldMessage.Text.Trim().Remove(lblHoldMessage.Text.Trim().IndexOf("More Claim Data is present"));
                //        }
                //    }
                //}
                //else
                //{
                //    if (_IsbCliamReplacement || (bIsRefProvAsSupervisor && bEnableSupervisorOption) || _sClaimRefNo != "" || (_oBox19Notes != null && _oBox19Notes.Count >= 0 && _oBox19Notes[0].Box19NoteDescription.Trim() != "") || (_sBox10dNote.Trim() != "") || _IllnessDate > 0 || _LastSeenDate > 0 || _sDelayReasonCode.Trim() != "" || _sServiceAuthExceptionCode.Trim() != "" || _sMedicaidResubmissionCode.Trim() != "" || _UnableToWorkFromDate_MoreClaimData > 0 || _UnableToWorkTillDate_MoreClaimData > 0)
                //    {
                //        if (!lblHoldMessage.Text.Contains("More Claim Data is present"))
                //            lblHoldMessage.Text = "More Claim Data is present";
                //    }
                //    else
                //    {
                //        lblHoldMessage.Text = "";
                //    }
                //}

                #endregion
            }
            catch (Exception ex)
            {
                gloAuditTrail.gloAuditTrail.ExceptionLog(ex, false);
            }
        }

        private void tls_Anesthesia_Click(object sender, EventArgs e)
        {
            TransactionLines oLineTransactions = null;
            TransactionLine oLineTransaction = null;
            frmAnesthesiaBilling ofrmAnesthesiaBilling = null;
            gloBilling ogloBilling = null;
            try
            {
                #region " Add Anesthesia "

                oLineTransactions = UC_gloBillingTransactionLines.GetLineTransactions();

                if (UC_gloBillingTransactionLines.CurrentTransactionLine > 0)
                {
                    oLineTransaction = oLineTransactions[UC_gloBillingTransactionLines.CurrentTransactionLine - 1];
                    ofrmAnesthesiaBilling = new frmAnesthesiaBilling(oLineTransaction);
                    Int64 _currentContactID = 0;
                    for (int iCount = 1; iCount <= c1Insurance.Rows.Count - 1; iCount++)
                    {
                        if (c1Insurance.GetCellCheck(iCount, COL_SELECT_CURRENT_RESPONSIBLE_PARTY) == CheckEnum.Checked)
                        {
                            _currentContactID = Convert.ToInt64(c1Insurance.GetData(iCount, COL_INSURANCECONTACTID));
                        }
                    }
                    ofrmAnesthesiaBilling.nContactID = _currentContactID;
                    if (ogloBilling == null)
                    {
                        ogloBilling = new gloBilling(gloGlobal.gloPMGlobal.DatabaseConnectionString, _emrdatabaseConnectionString);
                    }
                    ofrmAnesthesiaBilling.bIsVoid = (IsClaimVoided || _InitialTransaction.IsClaimSplitted ? true : ogloBilling.IsDayClosed(Convert.ToDateTime(mskClaimDate.Text)));
                    ofrmAnesthesiaBilling.ShowDialog(this);

                    if (ofrmAnesthesiaBilling.oDialogResult)
                    {
                        oLineTransaction = ofrmAnesthesiaBilling.oTransLine;
                        UC_gloBillingTransactionLines.SetAnesthesiaFields(oLineTransaction);
                        if (oLineTransaction != null) { oLineTransaction.Dispose(); }
                        if (oLineTransactions != null) { oLineTransactions.Dispose(); }
                    }
                    ofrmAnesthesiaBilling.Dispose();
                    ofrmAnesthesiaBilling = null;
                    ogloBilling.Dispose();
                    ogloBilling = null;
                }
                else
                {
                    MessageBox.Show("No service line is selected.", gloGlobal.gloPMGlobal.MessageBoxCaption, MessageBoxButtons.OK, MessageBoxIcon.Information);
                }

                #endregion



            }
            catch (Exception ex)
            {
                gloAuditTrail.gloAuditTrail.ExceptionLog(ex, true);
            }
            finally
            {
                if (ofrmAnesthesiaBilling != null) { ofrmAnesthesiaBilling.Dispose(); ofrmAnesthesiaBilling = null; }
                if (oLineTransaction != null) { oLineTransaction.Dispose(); oLineTransaction = null; }
                if (ogloBilling != null) { ogloBilling.Dispose(); ogloBilling = null; }
                if (oLineTransactions != null) { oLineTransactions.Dispose(); oLineTransactions = null; }
            }


        }

        private void tsbViewHistory_Click(object sender, EventArgs e)
        {
            gloBilling ogloBilling = null;
            Int16 _party = -1;
            try
            {
                if (_TransactionID > 0)
                {
                    frmClaimChargeHistoryV2 ofrmClaimChargeHistory = new frmClaimChargeHistoryV2(_DatabaseConnectionString, _InitialTransaction.PatientID, _InitialTransaction.ClinicID, _InitialTransaction.TransactionID,false,true);
                    ofrmClaimChargeHistory.StartPosition = FormStartPosition.CenterScreen;
                    ofrmClaimChargeHistory.CallingContainer = this.Name;
                    ofrmClaimChargeHistory.ShowDialog(this);
                    ofrmClaimChargeHistory.Dispose();

                    _dtEOBPayments = gloBilling.GetEOBPaymentsV2(_MasterTransactionID);
                    _dtEOBNextAction = gloBilling.GetEOBNextAction(_MasterTransactionID);

                    if (Cls_GlobalSettings.IsPaymentVoided)
                    {
                        ogloBilling = new gloBilling(_DatabaseConnectionString, _emrdatabaseConnectionString);
                        _TransactionID = ogloBilling.GetLastTransactionID(_TransactionID);
                        if (_InitialTransaction != null)
                        {
                            _InitialTransaction.Dispose();
                            _InitialTransaction = null;
                        }
                        _InitialTransaction = ogloBilling.GetChargesClaimDetails(_TransactionID, _ClinicID);

                        if (_InitialTransaction.Lines != null)
                        {
                            if (_InitialTransaction.Lines.Count > 0)
                            {
                                pnlTransactionLines.SendToBack();
                                if (UC_gloBillingTransactionLines != null)
                                {

                                    pnlTransactionLines.Controls.Remove(UC_gloBillingTransactionLines);
                                    try
                                    {
                                        UC_gloBillingTransactionLines.onGrid_CellChanged -= new gloBillingTransaction.onGridCellChanged(UC_gloBillingTransactionLines_onGrid_CellChanged);
                                        UC_gloBillingTransactionLines.onGrid_SelChanged -= new gloBillingTransaction.onGridSelChanged(UC_gloBillingTransactionLines_onGrid_SelChanged);
                                        UC_gloBillingTransactionLines.onInsCPTDxMod_Changed -= new gloBillingTransaction.onInsCPTDxModChanged(UC_gloBillingTransactionLines_onInsCPTDxMod_Changed);
                                        UC_gloBillingTransactionLines.show_LineNotes -= new gloBillingTransaction.showLineNote(UC_gloBillingTransactionLines_show_LineNotes);                                        
                                    }
                                    catch
                                    {
                                    }
                                    UC_gloBillingTransactionLines.Dispose();
                                    UC_gloBillingTransactionLines = null;
                                }
                                UC_gloBillingTransactionLines = new gloBillingTransaction();
                                UC_gloBillingTransactionLines.AutoSort = false;
                                UC_gloBillingTransactionLines.InitialNofRows = 1;
                                UC_gloBillingTransactionLines.IsOpenForModify = true;
                                pnlTransactionLines.Controls.Add(UC_gloBillingTransactionLines);
                                UC_gloBillingTransactionLines.Visible = true;
                                UC_gloBillingTransactionLines.Dock = DockStyle.Fill;
                                UC_gloBillingTransactionLines.PatientID = this.PatientID;
                                UC_gloBillingTransactionLines.DefaultTOSID = _DefaultTOSID;
                                UC_gloBillingTransactionLines.DefaultPOSID = _DefaultPOSID;
                                UC_gloBillingTransactionLines.PatientProviderID = _PatientPoviderID;

                            }
                        }
                        //Bug #96638: gloPM>>Modify charges showing unwanted ICD9 code warning message
                        #region " ICD Revision"
                        if (_InitialTransaction.nICDRevision == 9)
                            UC_gloBillingTransactionLines.IcdCodeType = gloGlobal.gloICD.CodeRevision.ICD9.GetHashCode();
                        else if (_InitialTransaction.nICDRevision == 10)
                            UC_gloBillingTransactionLines.IcdCodeType = gloGlobal.gloICD.CodeRevision.ICD10.GetHashCode();
                        #endregion

                        if (cmbFacility.SelectedIndex != -1)
                        {
                            UC_gloBillingTransactionLines.FacilityID = Convert.ToInt64(cmbFacility.SelectedValue);
                            SetFacility();
                        }

                        if (_InitialTransaction.FeeScheduleID > 0)
                        {
                            UC_gloBillingTransactionLines.FeeScheduleID = _InitialTransaction.FeeScheduleID;
                        }

                        if (_InitialTransaction.FacilityType == FacilityType.Facility)
                        {
                            chkFacilityFeeSchedule.Checked = true;
                            chkNonFacilityCharges.Checked = false;
                            UC_gloBillingTransactionLines.DefaultChargesType = FacilityType.Facility;
                        }
                        else if (_InitialTransaction.FacilityType == FacilityType.NonFacility)
                        {
                            chkFacilityFeeSchedule.Checked = false;
                            chkNonFacilityCharges.Checked = true;
                            UC_gloBillingTransactionLines.DefaultChargesType = FacilityType.NonFacility;
                        }

                        if (UC_gloBillingTransactionLines != null && _IsFormLoading == false)
                        {
                            UC_gloBillingTransactionLines.SetFNFCharges();
                        }

                        if (UC_gloBillingTransactionLines.Fee_ScheduleID > 0)
                        {
                            _FeeScheduleID = UC_gloBillingTransactionLines.Fee_ScheduleID;

                        }

                        if (c1Insurance.Rows.Count > 1)
                        {
                            if (c1Insurance.GetData(1, COL_INSURANCECONTACTID) != null)
                            {
                                UC_gloBillingTransactionLines._nContactID = Convert.ToInt64(c1Insurance.GetData(1, COL_INSURANCECONTACTID));
                            }
                        }

                        if (_InitialTransaction.Lines != null)
                        {
                            if (_InitialTransaction.Lines.Count > 0)
                            {
                                UC_gloBillingTransactionLines.SetLineTransaction(_InitialTransaction.Lines);
                            }
                        }

                        #region " Set the Renderring Provider "

                        //****************************************************************************
                        //Set the Patient Provider as the Renderring Provider
                        //If Patient Provider not present set the selected Billing Provider from combo
                        //as the Renderring Provider
                        //****************************************************************************

                        if (this.PatientPoviderID > 0)
                        {
                            UC_gloBillingTransactionLines.DefaultRenderingProviderID = this.PatientPoviderID;
                            UC_gloBillingTransactionLines.DefaultRenderringProviderName = this.PatientProviderName;
                        }
                        else
                        {
                            if (cmbBillingProvider != null && cmbBillingProvider.Items.Count > 0)
                            {
                                if (cmbBillingProvider.SelectedIndex != -1)
                                {
                                    UC_gloBillingTransactionLines.DefaultRenderingProviderID = Convert.ToInt64(cmbBillingProvider.SelectedValue);
                                    UC_gloBillingTransactionLines.DefaultRenderringProviderName = Convert.ToString(cmbBillingProvider.Text);
                                }
                            }
                        }

                        #endregion " Set the Renderring Provider "

                        UC_gloBillingTransactionLines.onGrid_CellChanged += new gloBillingTransaction.onGridCellChanged(UC_gloBillingTransactionLines_onGrid_CellChanged);
                        UC_gloBillingTransactionLines.onGrid_SelChanged += new gloBillingTransaction.onGridSelChanged(UC_gloBillingTransactionLines_onGrid_SelChanged);
                        UC_gloBillingTransactionLines.onInsCPTDxMod_Changed += new gloBillingTransaction.onInsCPTDxModChanged(UC_gloBillingTransactionLines_onInsCPTDxMod_Changed);
                        UC_gloBillingTransactionLines.show_LineNotes += new gloBillingTransaction.showLineNote(UC_gloBillingTransactionLines_show_LineNotes);                        
                        //UC_gloBillingTransactionLines.onCPTCharges_Load += new gloBillingTransaction.onCPTChargesLoaded(UC_gloBillingTransactionLines_onCPTCharges_Load);

                        #region "Check For Payment Notes "

                        CheckForPaymentNotes(_InitialTransaction.Lines);

                        #endregion

                        #region " Set Line Primary Dx "

                        if (UC_gloBillingTransactionLines.HasPrimaryDx(UC_gloBillingTransactionLines.CurrentTransactionLine) == true)
                        {
                            int rowIndex = UC_gloBillingTransactionLines.CurrentTransactionLine;
                            string _primaryDxCode = UC_gloBillingTransactionLines.GetRowPrimaryDxCode(rowIndex);

                            if (_primaryDxCode != "")
                            {
                                if (c1Dx != null && c1Dx.Rows.Count > 0)
                                {
                                    for (int i = 1; i <= c1Dx.Rows.Count - 1; i++)
                                    {
                                        if (Convert.ToString(c1Dx.GetData(i, COL_DX_CODE)) != "")
                                        {
                                            if (Convert.ToString(c1Dx.GetData(i, COL_DX_CODE)).Trim() == _primaryDxCode.Trim())
                                            {
                                                c1Dx.SetCellCheck(i, COL_DX_ISPRIMARY, CheckEnum.Checked);
                                            }
                                            else
                                            {
                                                c1Dx.SetCellCheck(i, COL_DX_ISPRIMARY, CheckEnum.Unchecked);
                                            }
                                        }
                                    }
                                }
                            }

                        }
                        else
                        {
                            //Uncheck all 
                            if (c1Dx != null && c1Dx.Rows.Count > 0)
                            {
                                for (int i = 1; i <= c1Dx.Rows.Count - 1; i++)
                                {
                                    c1Dx.SetCellCheck(i, COL_DX_ISPRIMARY, CheckEnum.Unchecked);
                                }
                            }

                        }

                        #endregion " Set Line Primary Dx "

                        //DataTable _dt = GetCurrentPartyNumber();
                        DataTable _dt = gloCharges.GetCurrentPartyNumber(_TransactionID, _MasterTransactionID);
                        if (_dt != null && _dt.Rows.Count > 0)
                        {
                            _party = Convert.ToInt16(_dt.Rows[0]["PartyNo"]);
                            InsParty = Convert.ToInt16(_dt.Rows[0]["PartyNo"]);
                            nCurrentResponsibleParty = Convert.ToInt16(_dt.Rows[0]["PartyNo"]);

                        }

                        #region " Re Allocate Responsible Party in Insurance Grid"


                        for (int iCount = 1; iCount <= c1Insurance.Rows.Count - 1; iCount++)
                        {
                            c1Insurance.SetData(iCount, COL_INSVIEW_PARTYSTATUS, "");
                            c1Insurance.SetData(iCount, COL_INS_INTERNAL_PARTYSTATUS, "");
                        }

                        ReorderInsurance();

                        for (int _icount = 1; _icount <= c1Insurance.Rows.Count - 1; _icount++)
                        {
                            c1Insurance.SetCellCheck(_icount, COL_SELECT_CURRENT_RESPONSIBLE_PARTY, CheckEnum.Unchecked);
                        }

                        c1Insurance.SetCellCheck(_party, COL_SELECT_CURRENT_RESPONSIBLE_PARTY, CheckEnum.Checked);

                        c1Insurance.SetData(_party, COL_INS_INTERNAL_PARTYSTATUS, PartyNo);

                        if (c1Insurance.GetData(_party, COL_INSURANCENAME).ToString().ToLower() != "self")
                        {
                            c1Insurance.SetData(_party, COL_INSVIEW_PARTYSTATUS, PartyNo);
                        }

                        for (int _iRespcount = 1; _iRespcount <= c1Insurance.Rows.Count - 1; _iRespcount++)
                        {
                            if (c1Insurance.GetCellCheck(_iRespcount, COL_SELECT_CURRENT_RESPONSIBLE_PARTY) == CheckEnum.Checked)
                            {
                                System.Drawing.Image imgFlagResp = global::gloBilling.Properties.Resources.Normal_Priority;
                                c1Insurance.SetCellImage(_iRespcount, COL_INSURANCERESPONSIBILITY, imgFlagResp);
                            }
                            else
                            {
                                c1Insurance.SetCellImage(_iRespcount, COL_INSURANCERESPONSIBILITY, null);
                            }
                        }

                        #endregion

                        pnlTransactionLines.BringToFront();

                    }

                    IsEditable(_InitialTransaction);

                    if (IsClaimVoided)
                    {
                        SetVoidViewMode();
                    }

                }

            }
            catch (Exception ex)
            {
                gloAuditTrail.gloAuditTrail.ExceptionLog(ex, false);
                ex = null;

            }
            finally
            {
                if (ogloBilling != null)
                {
                    ogloBilling.Dispose();
                    ogloBilling = null;
                }
            }

        }

        private void tsb_Resend_Click(object sender, EventArgs e)
        {
            //frmBillingResend objResend = null;
            try
            {
                if (_InitialTransaction != null)
                {
                    //Check for two status as these are valid for Resend option.
                    if (_InitialTransaction.Transaction_Status == TransactionStatus.SendToClaimManager ||
                        _InitialTransaction.Transaction_Status == TransactionStatus.SendToClearingHouse)
                    {

                        //20100511 Mahesh Nawal Put the Message box for resend.
                        //Condition added By Debasish (Mantis Issue: 0001847) 
                        if (!_IsResnd)
                        {
                            DialogResult _dlgRst = DialogResult.None;
                            _dlgRst = MessageBox.Show("Claim will be resent. \nContinue?", _messageBoxCaption, MessageBoxButtons.YesNo, MessageBoxIcon.Question, MessageBoxDefaultButton.Button2);
                            if (_dlgRst == DialogResult.Yes)
                            {
                                _IsResnd = true;
                                c1Insurance_BeforeEdit(null, null);
                                for (int iCount = 1; iCount <= c1Insurance.Rows.Count - 1; iCount++)
                                {
                                    if (c1Insurance.GetCellCheck(iCount, COL_SELECT_CURRENT_RESPONSIBLE_PARTY) == CheckEnum.Checked)
                                    {
                                        c1Insurance.SetData(Convert.ToInt16(iCount), COL_INSVIEW_PARTYSTATUS, "Resending");
                                        c1Insurance.SetData(Convert.ToInt16(iCount), COL_INS_INTERNAL_PARTYSTATUS, "Resending");
                                    }
                                }
                                //AddResendinggnote(_MasterTransactionID);
                            }
                            else
                            {
                                _IsResnd = false;
                            }
                        }
                        else
                        {
                            MessageBox.Show("Claim is already marked for Resend.", _messageBoxCaption, MessageBoxButtons.OK, MessageBoxIcon.Information);
                        }

                    }
                    else if (_InitialTransaction.Transaction_Status == TransactionStatus.Queue || _InitialTransaction.Transaction_Status == TransactionStatus.Transacted || _InitialTransaction.Transaction_Status == TransactionStatus.Batch)
                    {
                        MessageBox.Show("Claim is ready for billing.  No need to Resend.", _messageBoxCaption, MessageBoxButtons.OK, MessageBoxIcon.Exclamation);
                    }
                    else
                    {
                        MessageBox.Show("The claim cannot be resent. ", _messageBoxCaption, MessageBoxButtons.OK, MessageBoxIcon.Exclamation);
                    }

                }
            }
            catch (Exception ex)
            {
                gloAuditTrail.gloAuditTrail.ExceptionLog(ex, true);
            }
            finally
            {
                //if (objResend != null)
                //{
                //    objResend.Dispose();
                //}
            }

        }


        private void tls_btnSaveNClose_Click(object sender, EventArgs e)
        {
            _IsModifyed = true;
            bool bIsChargeRulesEnabled = false;
            try
            {
                if (ValidateInsurance())
                {
                    if (!(UC_gloBillingTransactionLines == null))
                    {
                        if (UC_gloBillingTransactionLines.GetLinesCount() > 1)
                        {

                            ValidationMessageExpClaim();

                            bIsChargeRulesEnabled = IsClaimRulesEnabled();

                            if (bIsChargeRulesEnabled)
                            {
                                if (ValidateRules())
                                {
                                    if (AddTransaction(false) == true)
                                    {
                                        gloBilling ogloBilling = new gloBilling(_DatabaseConnectionString, "");
                                        // Changes for Bug ID 67132 - 8020
                                        if (_InitialTransaction.PAccountID != 0 && oPatientControl.PAccountID != _InitialTransaction.PAccountID)
                                        {
                                            if (isReponsibilityTransfer == true)
                                            { CL_FollowUpCode.SetAutoAccountFollowUp(_InitialTransaction.PAccountID, _InitialTransaction.PatientID, Convert.ToDateTime(responsiblitytransferdate)); }
                                            else
                                            { CL_FollowUpCode.SetAutoAccountFollowUp(_InitialTransaction.PAccountID, _InitialTransaction.PatientID, Convert.ToDateTime(mskClaimDate.Text)); }

                                        }
                                        // End Changes for Bug ID 67132 - 8020

                                        if (isReponsibilityTransfer == true)
                                        { CL_FollowUpCode.SetAutoAccountFollowUp(oPatientControl.PAccountID, oPatientControl.PatientID, Convert.ToDateTime(responsiblitytransferdate)); }
                                        else
                                        { CL_FollowUpCode.SetAutoAccountFollowUp(oPatientControl.PAccountID, oPatientControl.PatientID, Convert.ToDateTime(mskClaimDate.Text)); }

                                        IsModified = true;
                                        ogloBilling.Dispose();
                                        if (sDeletedNoteHistoryID != null && sDeletedNoteHistoryID != "")
                                        {
                                            string[] sHistoryID = sDeletedNoteHistoryID.Split(',');
                                            foreach (var nHistoryID in sHistoryID)
                                            {
                                                gloAuditTrail.gloAuditTrail.CreateAuditLog(ActivityModule.Billing, ActivityCategory.Notes, ActivityType.Delete, "Charge Note Deleted for Line no. " + Convert.ToString(UC_gloBillingTransactionLines.CurrentTransactionLine) + " of Claim # : " + txtClaimNo.Text + ".", PatientID, Convert.ToInt64(nHistoryID), 0, ActivityOutCome.Success);
                                            }
                                        }

                                        Int64 _InsuranceId = 0;
                                        Int64 _ContactId = 0;

                                        if (c1Insurance != null && c1Insurance.Rows.Count > 0)
                                        {

                                            for (int i = 1; i <= c1Insurance.Rows.Count - 1; i++)
                                            {
                                                if (c1Insurance.GetCellCheck(i, COL_SELECT_CURRENT_RESPONSIBLE_PARTY) == CheckEnum.Checked)
                                                {
                                                    _InsuranceId = Convert.ToInt64(c1Insurance.GetData(i, COL_INSURANCEID));
                                                    _ContactId = Convert.ToInt64(c1Insurance.GetData(i, COL_INSURANCECONTACTID));
                                                    break;
                                                }
                                            }


                                        }

                                        if (triggeredRuleInfoGlobal != null && triggeredRuleInfoGlobal.Count > 0)
                                        {
                                            DataTable dtRule = new DataTable();

                                            dtRule.Columns.Add("nRuleID");
                                            dtRule.Columns.Add("nTransactionMasterID");
                                            dtRule.Columns.Add("nTransactionID");
                                            dtRule.Columns.Add("nInsuranceID");
                                            dtRule.Columns.Add("nContactID");
                                            dtRule.Columns.Add("nUserID");
                                            dtRule.Columns.Add("nRuleType");

                                            foreach (gloUIControlLibrary.Classes.ClaimRules.TriggeredRuleInfo oRule in triggeredRuleInfoGlobal)
                                            {

                                                dtRule.Rows.Add();
                                                dtRule.Rows[dtRule.Rows.Count - 1]["nRuleID"] = oRule.RuleId;
                                                dtRule.Rows[dtRule.Rows.Count - 1]["nTransactionMasterID"] = _MasterTransactionID;
                                                dtRule.Rows[dtRule.Rows.Count - 1]["nTransactionID"] = _TransactionID;
                                                dtRule.Rows[dtRule.Rows.Count - 1]["nInsuranceID"] = _InsuranceId;
                                                dtRule.Rows[dtRule.Rows.Count - 1]["nContactID"] = _ContactId;
                                                dtRule.Rows[dtRule.Rows.Count - 1]["nUserID"] = gloGlobal.gloPMGlobal.UserID;
                                                dtRule.Rows[dtRule.Rows.Count - 1]["nRuleType"] = oRule.RuleTypeInfo.GetHashCode();

                                            }
                                            gloCharges.SaveTriggeredRules(dtRule, false);
                                            gloAuditTrail.gloAuditTrail.CreateAuditLog(gloAuditTrail.ActivityModule.ChargeRule, gloAuditTrail.ActivityCategory.ChargeRuleEvaluation, gloAuditTrail.ActivityType.SaveWithErrors, "Claim modified with errors", 0, _InitialTransaction.TransactionID, 0, gloAuditTrail.ActivityOutCome.Success, gloAuditTrail.SoftwareComponent.gloPM, true);

                                        }
                                        else
                                        {
                                            DataTable dtRule = new DataTable();
                                            dtRule.Columns.Add("nRuleID");
                                            dtRule.Columns.Add("nTransactionMasterID");
                                            dtRule.Columns.Add("nTransactionID");
                                            dtRule.Columns.Add("nInsuranceID");
                                            dtRule.Columns.Add("nContactID");
                                            dtRule.Columns.Add("nUserID");
                                            dtRule.Columns.Add("nRuleType");

                                            dtRule.Rows.Add();
                                            dtRule.Rows[dtRule.Rows.Count - 1]["nRuleID"] = 0;
                                            dtRule.Rows[dtRule.Rows.Count - 1]["nTransactionMasterID"] = _MasterTransactionID;
                                            dtRule.Rows[dtRule.Rows.Count - 1]["nTransactionID"] = _TransactionID;
                                            dtRule.Rows[dtRule.Rows.Count - 1]["nInsuranceID"] = _InsuranceId;
                                            dtRule.Rows[dtRule.Rows.Count - 1]["nContactID"] = _ContactId;
                                            dtRule.Rows[dtRule.Rows.Count - 1]["nUserID"] = gloGlobal.gloPMGlobal.UserID;
                                            dtRule.Rows[dtRule.Rows.Count - 1]["nRuleType"] = 0;

                                            gloCharges.SaveTriggeredRules(dtRule, true);

                                        }
                                        if (IsInsurancePaymentClicked)
                                        {
                                            if (txtClaimNo.Text.Trim() != "")
                                            {
                                                gloAccountsV2.frmInsurancePaymentV2 oPaymentInsurace = new gloAccountsV2.frmInsurancePaymentV2(gloGlobal.gloPMGlobal.DatabaseConnectionString);
                                                oPaymentInsurace.StartPosition = FormStartPosition.CenterScreen;
                                                oPaymentInsurace.WindowState = FormWindowState.Maximized;
                                                oPaymentInsurace.ModifyChargesClaimNo = Convert.ToString(txtClaimNo.Text.Trim());

                                                oPaymentInsurace.IsOpenfromModifyCharges = true;
                                                //oPaymentInsurace.PatientControl_OnClaimNumberEntered(Convert.ToString(PatientControl.ClaimNumber));
                                                oPaymentInsurace.ShowInTaskbar = false;
                                                oPaymentInsurace.ShowDialog(this);
                                                oPaymentInsurace.Dispose();
                                                oPaymentInsurace = null;
                                                IsInsurancePaymentClicked = false;
                                            }
                                        }
                                        else
                                        {
                                            this.Close();
                                        }
                                    }
                                }
                            }
                            else
                            {
                                if (AddTransaction(false) == true)
                                {
                                    gloBilling ogloBilling = new gloBilling(_DatabaseConnectionString, "");

                                    // Changes for Bug ID 67132 - 8020
                                    if (_InitialTransaction.PAccountID != 0 && oPatientControl.PAccountID != _InitialTransaction.PAccountID)
                                    {
                                        // if Responsibility is get transfferred use "_InsTransferCloseDate" date as CloseDate else use "mskClaimDate"
                                        if (isReponsibilityTransfer)
                                        {
                                            CL_FollowUpCode.SetAutoAccountFollowUp(_InitialTransaction.PAccountID, _InitialTransaction.PatientID, Convert.ToDateTime(responsiblitytransferdate));
                                        }
                                        else
                                        { CL_FollowUpCode.SetAutoAccountFollowUp(_InitialTransaction.PAccountID, _InitialTransaction.PatientID, Convert.ToDateTime(mskClaimDate.Text)); }

                                    }
                                    // End Changes for Bug ID 67132 - 8020

                                    // if Responsibility is get transfferred use "_InsTransferCloseDate" date as CloseDate else use "mskClaimDate"
                                    if (isReponsibilityTransfer)
                                    { CL_FollowUpCode.SetAutoAccountFollowUp(oPatientControl.PAccountID, oPatientControl.PatientID, Convert.ToDateTime(responsiblitytransferdate)); }
                                    else
                                    { CL_FollowUpCode.SetAutoAccountFollowUp(oPatientControl.PAccountID, oPatientControl.PatientID, Convert.ToDateTime(mskClaimDate.Text)); }

                                    IsModified = true;
                                    ogloBilling.Dispose();
                                    if (sDeletedNoteHistoryID != null && sDeletedNoteHistoryID != "")
                                    {
                                        string[] sHistoryID = sDeletedNoteHistoryID.Split(',');
                                        foreach (var nHistoryID in sHistoryID)
                                        {
                                            gloAuditTrail.gloAuditTrail.CreateAuditLog(ActivityModule.Billing, ActivityCategory.Notes, ActivityType.Delete, "Charge Note Deleted for Line no. " + Convert.ToString(UC_gloBillingTransactionLines.CurrentTransactionLine) + " of Claim # : " + txtClaimNo.Text + ".", PatientID, Convert.ToInt64(nHistoryID), 0, ActivityOutCome.Success);
                                        }
                                    }
                                    if (IsInsurancePaymentClicked)
                                    {
                                        if (txtClaimNo.Text.Trim() != "")
                                        {
                                            gloAccountsV2.frmInsurancePaymentV2 oPaymentInsurace = new gloAccountsV2.frmInsurancePaymentV2(gloGlobal.gloPMGlobal.DatabaseConnectionString);
                                            oPaymentInsurace.StartPosition = FormStartPosition.CenterScreen;
                                            oPaymentInsurace.WindowState = FormWindowState.Maximized;
                                            oPaymentInsurace.ModifyChargesClaimNo = Convert.ToString(txtClaimNo.Text.Trim());

                                            oPaymentInsurace.IsOpenfromModifyCharges = true;
                                            //oPaymentInsurace.PatientControl_OnClaimNumberEntered(Convert.ToString(PatientControl.ClaimNumber));
                                            oPaymentInsurace.ShowInTaskbar = false;
                                            oPaymentInsurace.ShowDialog(this);
                                            oPaymentInsurace.Dispose();
                                            oPaymentInsurace = null;
                                            IsInsurancePaymentClicked = false;

                                        }
                                    }
                                    else
                                    {
                                        this.Close();
                                    }
                                }
                            }


                        }
                        else
                        {
                            MessageBox.Show("Enter at least one service line to save claim.", _messageBoxCaption, MessageBoxButtons.OK, MessageBoxIcon.Information);
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                gloAuditTrail.gloAuditTrail.ExceptionLog(ex, false);
            }
        }
        private void ReloadTransaction()
        {

            pnlTransactionLines.SendToBack();
            if (UC_gloBillingTransactionLines != null)
            {

                pnlTransactionLines.Controls.Remove(UC_gloBillingTransactionLines);
                try
                {
                    UC_gloBillingTransactionLines.onGrid_CellChanged -= new gloBillingTransaction.onGridCellChanged(UC_gloBillingTransactionLines_onGrid_CellChanged);
                    UC_gloBillingTransactionLines.onGrid_SelChanged -= new gloBillingTransaction.onGridSelChanged(UC_gloBillingTransactionLines_onGrid_SelChanged);
                    UC_gloBillingTransactionLines.onInsCPTDxMod_Changed -= new gloBillingTransaction.onInsCPTDxModChanged(UC_gloBillingTransactionLines_onInsCPTDxMod_Changed);
                    UC_gloBillingTransactionLines.show_LineNotes -= new gloBillingTransaction.showLineNote(UC_gloBillingTransactionLines_show_LineNotes);
                }
                catch
                {
                }
                UC_gloBillingTransactionLines.Dispose();
                UC_gloBillingTransactionLines = null;
            }

            UC_gloBillingTransactionLines = new gloBillingTransaction();

            pnlTransactionLines.BringToFront();

        }

        private void ValidationMessageExpClaim()
        {
            Int64 _ContactId = 0;
            gloBilling ogloBilling = new gloBilling(_DatabaseConnectionString, _emrdatabaseConnectionString);
            try
            {


                for (int i = 1; i <= c1Insurance.Rows.Count - 1; i++)
                {
                    if (c1Insurance.GetCellCheck(i, COL_SELECT_CURRENT_RESPONSIBLE_PARTY) == CheckEnum.Checked)
                    {
                        _ContactId = Convert.ToInt64(c1Insurance.GetData(i, COL_INSURANCECONTACTID));
                        break;
                    }
                }

                ogloBilling.GetExpandedClaimSetting(_ContactId, _ClinicID, out _NoOfMaxServiceLines, out _NoOfMaxDiagnosis);

                int _cntr = 0;

                ArrayList arrDX = UC_gloBillingTransactionLines.GetUniqueDx();
                if (arrDX != null)
                {
                    _cntr = arrDX.Count;
                }

                if (UC_gloBillingTransactionLines.GetLinesCount() - 1 > _NoOfMaxServiceLines && _cntr > _NoOfMaxDiagnosis)
                {
                    MessageBox.Show(" Claim has a max limit of " + _NoOfMaxServiceLines + " service lines and " + _NoOfMaxDiagnosis + " diagnosis. ", _messageBoxCaption, MessageBoxButtons.OK, MessageBoxIcon.Warning);
                }
                else if (UC_gloBillingTransactionLines.GetLinesCount() - 1 > _NoOfMaxServiceLines)
                {
                    MessageBox.Show(" Claim has a max limit of " + _NoOfMaxServiceLines + " service lines. ", _messageBoxCaption, MessageBoxButtons.OK, MessageBoxIcon.Warning);
                }
                else if (_cntr > _NoOfMaxDiagnosis)
                {
                    MessageBox.Show(" Claim has a max limit of " + _NoOfMaxDiagnosis + " diagnosis. ", _messageBoxCaption, MessageBoxButtons.OK, MessageBoxIcon.Information);
                }
                //  _Transaction.NoOfServiceLine = _NoOfMaxServiceLines;
                //  _Transaction.NoOfDiagnosis = _NoOfMaxDiagnosis;
                UC_gloBillingTransactionLines._NoOfDiagnosis = _NoOfMaxDiagnosis;
                UC_gloBillingTransactionLines._NoOfServiceLines = _NoOfMaxServiceLines;


            }
            catch (Exception ex)
            {
                gloAuditTrail.gloAuditTrail.ExceptionLog(ex, true);
            }
            finally
            {
                if (ogloBilling != null)
                { ogloBilling.Dispose(); }
            }
        }

        private void tls_btnCancel_Click(object sender, EventArgs e)
        {
            _IsModifyed = true;
            try
            {
                if (tls_btnSaveNClose.Enabled == false)
                {
                    { this.Close(); }
                }
                else
                {
                    if (UC_gloBillingTransactionLines != null && UC_gloBillingTransactionLines.IsTransactionDataPresent() == true)
                    {
                        DialogResult res = MessageBox.Show("Do you want to save changes to this record? ", _messageBoxCaption, MessageBoxButtons.YesNoCancel, MessageBoxIcon.Information);
                        if (res == DialogResult.Yes)
                        {
                            bool _tempFlag = false;
                            _tempFlag = _IsSaveCopayStart;

                            if (_IsSaveCopayStart == true)
                            {
                                _IsSaveCopayStart = false;
                                _IsSaveCopayStop = true;
                            }

                            //if (ValidateICD10DOS() == true)
                            //{
                            if (Ok_Click() == true)
                            {

                                if (OpenViewMode == false)
                                {
                                    gloBilling ogloBilling = new gloBilling(_DatabaseConnectionString, "");
                                    //ogloBilling.UpdateRecordStatus(_TransactionID, 0, false);
                                    IsModified = true;
                                    ogloBilling.Dispose();
                                }
                                if (sDeletedNoteHistoryID != "")
                                {
                                    string[] sHistoryID = sDeletedNoteHistoryID.Split(',');
                                    foreach (var nHistoryID in sHistoryID)
                                    {
                                        gloAuditTrail.gloAuditTrail.CreateAuditLog(ActivityModule.Billing, ActivityCategory.Notes, ActivityType.Delete, "Charge Note Deleted for Line no. " + Convert.ToString(UC_gloBillingTransactionLines.CurrentTransactionLine) + " of Claim # : " + txtClaimNo.Text + ".", PatientID, Convert.ToInt64(nHistoryID), 0, ActivityOutCome.Success);
                                    }
                                }
                                this.Close();
                                gloAuditTrail.gloAuditTrail.CreateAuditLog(ActivityModule.Billing, ActivityCategory.SetupCharges, ActivityType.View, "View Setup Charges", 0, _TransactionID, _PatientPoviderID, ActivityOutCome.Success);


                            }
                            else
                            {
                                _IsSaveCopayStart = _tempFlag;
                                _IsSaveCopayStop = false;
                            }
                            //}
                            //else
                            //{
                            //    _IsSaveCopayStart = _tempFlag;
                            //    _IsSaveCopayStop = false;
                            //}
                        }
                        else if (res == DialogResult.No)
                        {


                            if (OpenViewMode == false)
                            {
                                gloBilling ogloBilling = new gloBilling(_DatabaseConnectionString, "");
                                //ogloBilling.UpdateRecordStatus(_TransactionID, 0, false);


                                //Delete Transaction if SaveNCopay Started and Transaction Canceled
                                if (_IsSaveCopayStart == true && _IsSaveCopayStop == false)
                                {
                                    if (ogloBilling.DeleteTransaction(_TransactionID, _ClinicID) == true)
                                    {
                                        ogloBilling.DeleteTransactionPayment(_TransactionID, _ClinicID);
                                    }
                                }

                                if (sDeletedNoteHistoryID != "")
                                {
                                    gloCharges.DeleteNoteInHistory(sDeletedNoteHistoryID);
                                }
                                ogloBilling.Dispose();
                            }
                            gloAuditTrail.gloAuditTrail.CreateAuditLog(ActivityModule.Billing, ActivityCategory.SetupCharges, ActivityType.View, "View Setup Charges", 0, _TransactionID, _PatientPoviderID, ActivityOutCome.Success);
                            this.Close();
                        }
                        else if (res == DialogResult.Cancel)
                        {
                            return;
                        }
                    }
                    else
                    { this.Close(); }
                }
                ////By Debasish Das BUG ID 3360.
                if (!IsModified && Cls_GlobalSettings.IsPaymentVoided)
                {
                    IsModified = true;
                }
                //**
            }
            catch (Exception ex)
            {
                gloAuditTrail.gloAuditTrail.ExceptionLog(ex, false);
            }
        }

        private void tls_SplitClaim_Click(object sender, EventArgs e)
        {
            //frmExpClaim objExpclaim = new frmExpClaim(_TransactionID ,Convert.ToString(_nClaimNo  ),_DatabaseConnectionString );
            //objExpclaim.Show();  
            Int16 _party = -1;
            string _sQuery = "";
            try
            {
                if (UC_gloBillingTransactionLines.GetLinesCount() > 2)
                {
                    if (_InitialTransaction.PWKReportTypeCode != "" || _InitialTransaction.PWKReportTransmissionCode != "" || _InitialTransaction.PWKAttachmentControlNumber != ""|| _InitialTransaction.MammogramCertNumber!="")
                    {
                        _sQuery = "Claims PWK data will be removed from splited claim's" + Environment.NewLine + "Do you want to save and proceed? ";
                    }
                    else
                    {
                        _sQuery = "Do you want to save and proceed?";
                    }
                    DialogResult res = MessageBox.Show(_sQuery, _messageBoxCaption, MessageBoxButtons.YesNo, MessageBoxIcon.Information);
                    if (res == DialogResult.Yes)
                    {
                        // _IsModifyed = true;
                      
                        if (ValidateInsurance())
                        {
                            if (!IsClaimRulesEnabled() || ValidateRules())
                            {
                                if (!(UC_gloBillingTransactionLines == null))
                                {
                                    _IsSaveCopayStart = true;
                                    if (AddTransaction(true) == true)
                                    {
                                        frmClaimExp objExpclaim = new frmClaimExp(_InitialTransaction, _TransactionID, _DatabaseConnectionString);
                                        gloBilling ogloBilling = new gloBilling(_DatabaseConnectionString, "");

                                        Boolean _isReleased = gloCharges.ReleaseLockStatus(_MasterTransactionID);

                                        objExpclaim.ShowInTaskbar = false;

                                        objExpclaim.ShowDialog(this);
                                        _ClaimStructure = objExpclaim._ClaimStructure;
                                        IsModified = objExpclaim._isModified;

                                        if (_ClaimStructure != null)
                                        {
                                            if (_ClaimStructure.CSClaims.Count > 0)
                                            {
                                                if (_InitialTransaction != null)
                                                {
                                                    _InitialTransaction.Dispose();
                                                    _InitialTransaction = null;
                                                }
                                                _InitialTransaction = ogloBilling.GetChargesClaimDetails(_TransactionID, _ClinicID);
                                                _ClaimStructure.Transaction = _InitialTransaction;
                                                _ClaimStructure.SplitClaim(false);
                                            }
                                            this.Close();
                                        }
                                        else
                                        {
                                            if (ogloBilling == null)
                                            {

                                                ogloBilling = new gloBilling(_DatabaseConnectionString, _emrdatabaseConnectionString);
                                            }
                                            _TransactionID = ogloBilling.GetLastTransactionID(_TransactionID);
                                            if (_InitialTransaction != null)
                                            {
                                                _InitialTransaction.Dispose();
                                                _InitialTransaction = null;
                                            }
                                            _InitialTransaction = ogloBilling.GetChargesClaimDetails(_TransactionID, _ClinicID);

                                            if (_InitialTransaction.Lines != null)
                                            {
                                                if (_InitialTransaction.Lines.Count > 0)
                                                {
                                                    pnlTransactionLines.SendToBack();
                                                    if (UC_gloBillingTransactionLines != null)
                                                    {

                                                        pnlTransactionLines.Controls.Remove(UC_gloBillingTransactionLines);
                                                        try
                                                        {
                                                            UC_gloBillingTransactionLines.onGrid_CellChanged -= new gloBillingTransaction.onGridCellChanged(UC_gloBillingTransactionLines_onGrid_CellChanged);
                                                            UC_gloBillingTransactionLines.onGrid_SelChanged -= new gloBillingTransaction.onGridSelChanged(UC_gloBillingTransactionLines_onGrid_SelChanged);
                                                            UC_gloBillingTransactionLines.onInsCPTDxMod_Changed -= new gloBillingTransaction.onInsCPTDxModChanged(UC_gloBillingTransactionLines_onInsCPTDxMod_Changed);
                                                            UC_gloBillingTransactionLines.show_LineNotes -= new gloBillingTransaction.showLineNote(UC_gloBillingTransactionLines_show_LineNotes);                                                            
                                                        }
                                                        catch
                                                        {
                                                        }
                                                        UC_gloBillingTransactionLines.Dispose();
                                                        UC_gloBillingTransactionLines = null;
                                                    }
                                                    UC_gloBillingTransactionLines = new gloBillingTransaction();
                                                    UC_gloBillingTransactionLines.AutoSort = false;
                                                    UC_gloBillingTransactionLines.InitialNofRows = 1;
                                                    UC_gloBillingTransactionLines.IsOpenForModify = true;
                                                    pnlTransactionLines.Controls.Add(UC_gloBillingTransactionLines);
                                                    UC_gloBillingTransactionLines.Visible = true;
                                                    UC_gloBillingTransactionLines.Dock = DockStyle.Fill;
                                                    UC_gloBillingTransactionLines.PatientID = this.PatientID;
                                                    UC_gloBillingTransactionLines.DefaultTOSID = _DefaultTOSID;
                                                    UC_gloBillingTransactionLines.DefaultPOSID = _DefaultPOSID;
                                                    UC_gloBillingTransactionLines.PatientProviderID = _PatientPoviderID;

                                                }
                                            }

                                            //Bug #96638: gloPM>>Modify charges showing unwanted ICD9 code warning message
                                            #region " ICD Revision"
                                            if (_InitialTransaction.nICDRevision == 9)
                                                UC_gloBillingTransactionLines.IcdCodeType = gloGlobal.gloICD.CodeRevision.ICD9.GetHashCode();
                                            else if (_InitialTransaction.nICDRevision == 10)
                                                UC_gloBillingTransactionLines.IcdCodeType = gloGlobal.gloICD.CodeRevision.ICD10.GetHashCode();
                                            #endregion

                                            if (cmbFacility.SelectedIndex != -1)
                                            {
                                                UC_gloBillingTransactionLines.FacilityID = Convert.ToInt64(cmbFacility.SelectedValue);
                                                SetFacility();
                                            }

                                            if (_InitialTransaction.FeeScheduleID > 0)
                                            {
                                                UC_gloBillingTransactionLines.FeeScheduleID = _InitialTransaction.FeeScheduleID;
                                            }

                                            if (_InitialTransaction.FacilityType == FacilityType.Facility)
                                            {
                                                chkFacilityFeeSchedule.Checked = true;
                                                chkNonFacilityCharges.Checked = false;
                                                UC_gloBillingTransactionLines.DefaultChargesType = FacilityType.Facility;
                                            }
                                            else if (_InitialTransaction.FacilityType == FacilityType.NonFacility)
                                            {
                                                chkFacilityFeeSchedule.Checked = false;
                                                chkNonFacilityCharges.Checked = true;
                                                UC_gloBillingTransactionLines.DefaultChargesType = FacilityType.NonFacility;
                                            }

                                            if (UC_gloBillingTransactionLines != null)
                                            {
                                                UC_gloBillingTransactionLines.SetFNFCharges();
                                            }

                                            if (UC_gloBillingTransactionLines.Fee_ScheduleID > 0)
                                            {
                                                _FeeScheduleID = UC_gloBillingTransactionLines.Fee_ScheduleID;

                                            }


                                            if (_InitialTransaction.Lines != null)
                                            {
                                                if (_InitialTransaction.Lines.Count > 0)
                                                {
                                                    UC_gloBillingTransactionLines.SetLineTransaction(_InitialTransaction.Lines);
                                                }
                                            }

                                            #region " Set the Renderring Provider "

                                            //****************************************************************************
                                            //Set the Patient Provider as the Renderring Provider
                                            //If Patient Provider not present set the selected Billing Provider from combo
                                            //as the Renderring Provider
                                            //****************************************************************************

                                            if (this.PatientPoviderID > 0)
                                            {
                                                UC_gloBillingTransactionLines.DefaultRenderingProviderID = this.PatientPoviderID;
                                                UC_gloBillingTransactionLines.DefaultRenderringProviderName = this.PatientProviderName;
                                            }
                                            else
                                            {
                                                if (cmbBillingProvider != null && cmbBillingProvider.Items.Count > 0)
                                                {
                                                    if (cmbBillingProvider.SelectedIndex != -1)
                                                    {
                                                        UC_gloBillingTransactionLines.DefaultRenderingProviderID = Convert.ToInt64(cmbBillingProvider.SelectedValue);
                                                        UC_gloBillingTransactionLines.DefaultRenderringProviderName = Convert.ToString(cmbBillingProvider.Text);
                                                    }
                                                }
                                            }

                                            #endregion " Set the Renderring Provider "

                                            UC_gloBillingTransactionLines.onGrid_CellChanged += new gloBillingTransaction.onGridCellChanged(UC_gloBillingTransactionLines_onGrid_CellChanged);
                                            UC_gloBillingTransactionLines.onGrid_SelChanged += new gloBillingTransaction.onGridSelChanged(UC_gloBillingTransactionLines_onGrid_SelChanged);
                                            UC_gloBillingTransactionLines.onInsCPTDxMod_Changed += new gloBillingTransaction.onInsCPTDxModChanged(UC_gloBillingTransactionLines_onInsCPTDxMod_Changed);
                                            UC_gloBillingTransactionLines.show_LineNotes += new gloBillingTransaction.showLineNote(UC_gloBillingTransactionLines_show_LineNotes);                                            
                                            //UC_gloBillingTransactionLines.onCPTCharges_Load += new gloBillingTransaction.onCPTChargesLoaded(UC_gloBillingTransactionLines_onCPTCharges_Load);

                                            #region "Check For Payment Notes "

                                            CheckForPaymentNotes(_InitialTransaction.Lines);

                                            #endregion

                                            #region " Set Line Primary Dx "

                                            if (UC_gloBillingTransactionLines.HasPrimaryDx(UC_gloBillingTransactionLines.CurrentTransactionLine) == true)
                                            {
                                                int rowIndex = UC_gloBillingTransactionLines.CurrentTransactionLine;
                                                string _primaryDxCode = UC_gloBillingTransactionLines.GetRowPrimaryDxCode(rowIndex);

                                                if (_primaryDxCode != "")
                                                {
                                                    if (c1Dx != null && c1Dx.Rows.Count > 0)
                                                    {
                                                        for (int i = 1; i <= c1Dx.Rows.Count - 1; i++)
                                                        {
                                                            if (Convert.ToString(c1Dx.GetData(i, COL_DX_CODE)) != "")
                                                            {
                                                                if (Convert.ToString(c1Dx.GetData(i, COL_DX_CODE)).Trim() == _primaryDxCode.Trim())
                                                                {
                                                                    c1Dx.SetCellCheck(i, COL_DX_ISPRIMARY, CheckEnum.Checked);
                                                                }
                                                                else
                                                                {
                                                                    c1Dx.SetCellCheck(i, COL_DX_ISPRIMARY, CheckEnum.Unchecked);
                                                                }
                                                            }
                                                        }
                                                    }
                                                }

                                            }
                                            else
                                            {
                                                //Uncheck all 
                                                if (c1Dx != null && c1Dx.Rows.Count > 0)
                                                {
                                                    for (int i = 1; i <= c1Dx.Rows.Count - 1; i++)
                                                    {
                                                        c1Dx.SetCellCheck(i, COL_DX_ISPRIMARY, CheckEnum.Unchecked);
                                                    }
                                                }

                                            }

                                            #endregion " Set Line Primary Dx "

                                            //DataTable _dt = GetCurrentPartyNumber();
                                            DataTable _dt = gloCharges.GetCurrentPartyNumber(_TransactionID, _MasterTransactionID);
                                            if (_dt != null && _dt.Rows.Count > 0)
                                            {
                                                _party = Convert.ToInt16(_dt.Rows[0]["PartyNo"]);
                                                InsParty = Convert.ToInt16(_dt.Rows[0]["PartyNo"]);
                                                nCurrentResponsibleParty = Convert.ToInt16(_dt.Rows[0]["PartyNo"]);

                                            }

                                            #region " Re Allocate Responsible Party in Insurance Grid"


                                            for (int iCount = 1; iCount <= c1Insurance.Rows.Count - 1; iCount++)
                                            {
                                                c1Insurance.SetData(iCount, COL_INSVIEW_PARTYSTATUS, "");
                                                c1Insurance.SetData(iCount, COL_INS_INTERNAL_PARTYSTATUS, "");
                                            }

                                            ReorderInsurance();

                                            for (int _icount = 1; _icount <= c1Insurance.Rows.Count - 1; _icount++)
                                            {
                                                c1Insurance.SetCellCheck(_icount, COL_SELECT_CURRENT_RESPONSIBLE_PARTY, CheckEnum.Unchecked);
                                            }

                                            c1Insurance.SetCellCheck(_party, COL_SELECT_CURRENT_RESPONSIBLE_PARTY, CheckEnum.Checked);

                                            c1Insurance.SetData(_party, COL_INS_INTERNAL_PARTYSTATUS, PartyNo);

                                            if (c1Insurance.GetData(_party, COL_INSURANCENAME).ToString().ToLower() != "self")
                                            {
                                                c1Insurance.SetData(_party, COL_INSVIEW_PARTYSTATUS, PartyNo);
                                            }

                                            for (int _iRespcount = 1; _iRespcount <= c1Insurance.Rows.Count - 1; _iRespcount++)
                                            {
                                                if (c1Insurance.GetCellCheck(_iRespcount, COL_SELECT_CURRENT_RESPONSIBLE_PARTY) == CheckEnum.Checked)
                                                {
                                                    System.Drawing.Image imgFlagResp = global::gloBilling.Properties.Resources.Normal_Priority;
                                                    c1Insurance.SetCellImage(_iRespcount, COL_INSURANCERESPONSIBILITY, imgFlagResp);
                                                }
                                                else
                                                {
                                                    c1Insurance.SetCellImage(_iRespcount, COL_INSURANCERESPONSIBILITY, null);
                                                }
                                            }

                                            #endregion

                                            pnlTransactionLines.BringToFront();

                                            //}

                                            IsEditable(_InitialTransaction);
                                        }

                                        Int64 _ContactId = 0;
                                        int _currentResponsibleRow = 0;
                                        //Transaction _Transaction = new Transaction();
                                        for (int i = 1; i <= c1Insurance.Rows.Count - 1; i++)
                                        {
                                            if (c1Insurance.GetCellCheck(i, COL_SELECT_CURRENT_RESPONSIBLE_PARTY) == CheckEnum.Checked)
                                            {
                                                _ContactId = Convert.ToInt64(c1Insurance.GetData(i, COL_INSURANCECONTACTID));
                                                _currentResponsibleRow = i;
                                                break;
                                            }
                                        }

                                        ogloBilling.GetExpandedClaimSetting(_ContactId, _ClinicID, out _NoOfMaxServiceLines, out _NoOfMaxDiagnosis);
                                        //_NoOfMaxServiceLines = _Transaction.NoOfServiceLine;
                                        //_NoOfMaxDiagnosis = _Transaction.NoOfDiagnosis;
                                        //_Transaction.NoOfServiceLine = _NoOfMaxServiceLines;
                                        //_Transaction.NoOfDiagnosis = _NoOfMaxDiagnosis;
                                        UC_gloBillingTransactionLines._NoOfServiceLines = _NoOfMaxServiceLines;
                                        UC_gloBillingTransactionLines._NoOfDiagnosis = _NoOfMaxDiagnosis;

                                        objExpclaim.Dispose();
                                        ogloBilling.Dispose();
                                    }
                                    _IsSaveCopayStart = false;
                                    UC_gloBillingTransactionLines.Refresh();

                                }
                            }
                        }

                    }
                    //  _IsModifyed = false;
                }
                else
                {
                    MessageBox.Show("Split claim require more than one service line. ", _messageBoxCaption, MessageBoxButtons.OK, MessageBoxIcon.Information);
                }
            }
            catch (Exception ex)
            {
                gloAuditTrail.gloAuditTrail.ExceptionLog(ex, false);
            }
        }

        private void tls_CMS1500_Click(object sender, EventArgs e)
        {
            try
            {
                OpenCMS1500();
            }
            catch (Exception ex)
            {
                gloAuditTrail.gloAuditTrail.ExceptionLog(ex, true);
            }
            finally
            { }
        }

        private void tls_UB04_Click(object sender, EventArgs e)
        {
            try
            {
                OpenUB04Form();
            }
            catch (Exception ex)
            {
                gloAuditTrail.gloAuditTrail.ExceptionLog(ex, true);
            }

        }

        private void tlb_AddEPSDT_Click(object sender, EventArgs e)
        {
            TransactionLines oLineTransactions = null;
            TransactionLine oLineTransaction = null;
            frmSetupEPSDTFamilyPlanning ofrmEPSDTFamilyPlanning = null;
            gloBilling ogloBilling = null;

            try
            {
                #region " Add Charge Fields "

                oLineTransactions = UC_gloBillingTransactionLines.GetLineTransactions();

                if (UC_gloBillingTransactionLines.CurrentTransactionLine > 0)
                {
                    oLineTransaction = oLineTransactions[UC_gloBillingTransactionLines.CurrentTransactionLine - 1];
                }
                else
                {
                    MessageBox.Show("No service line is selected.", gloGlobal.gloPMGlobal.MessageBoxCaption, MessageBoxButtons.OK, MessageBoxIcon.Information);
                }

                #endregion

                ofrmEPSDTFamilyPlanning = new frmSetupEPSDTFamilyPlanning(oLineTransaction, ClaimEPSDT);
                ogloBilling = new gloBilling(gloGlobal.gloPMGlobal.DatabaseConnectionString, _emrdatabaseConnectionString);
                //00000149 - when day is closed then not able to save EPSDT information in modify charges screen.
                // removed the condition which checks whethere is day is closed or not
                ofrmEPSDTFamilyPlanning.bIsVoid = (IsClaimVoided || _InitialTransaction.IsClaimSplitted); // ||_OpenViewMode ? true : ogloBilling.IsDayClosed(Convert.ToDateTime(mskClaimDate.Text))
                ofrmEPSDTFamilyPlanning.ShowDialog(this);

                if (ofrmEPSDTFamilyPlanning.DialogResults)
                {
                    oLineTransaction = ofrmEPSDTFamilyPlanning.LineObject;
                    ClaimEPSDT = ofrmEPSDTFamilyPlanning.ClaimEPSDT;
                    UC_gloBillingTransactionLines.SetEPSDTFields(oLineTransaction);
                }
                CheckForEPSDTEnabled();
            }
            catch (Exception ex)
            {
                gloAuditTrail.gloAuditTrail.ExceptionLog(ex, true);
            }
            finally
            {
                if (ofrmEPSDTFamilyPlanning != null) { ofrmEPSDTFamilyPlanning.Dispose(); ofrmEPSDTFamilyPlanning = null; }
                if (ogloBilling != null) { ogloBilling.Dispose(); ogloBilling = null; }
                if (oLineTransaction != null) { oLineTransaction.Dispose(); oLineTransaction = null; }
                if (oLineTransactions != null) { oLineTransactions.Dispose(); oLineTransactions = null; }
            }
        }

        private void tls_btnCopyClaim_Click(object sender, EventArgs e)
        {
            CopyClaim(ReplacementClaimCreationType.Copy);
        }

        private void tls_btnReplacementClaim_Click(object sender, EventArgs e)
        {
            CopyClaim(ReplacementClaimCreationType.Replacement);
        }

        private void tls_FollowUpActionDate_Click(object sender, EventArgs e)
        {
            try
            {
                frmSetupFollowupDateAction objFollowup = new frmSetupFollowupDateAction(CollectionEnums.FollowUpType.Claim, oPatientControl.PatientID, oPatientControl.PAccountID, _InitialTransaction.TransactionID, _InitialTransaction.TransactionMasterID);
                objFollowup.CallingContainer = this;
                objFollowup.ShowDialog(this);
                SetLastGlobalPeriods();
                objFollowup.Dispose();
                objFollowup = null;
            }
            catch (Exception exFollowUpActionDate)
            {
                gloAuditTrail.gloAuditTrail.ExceptionLog(exFollowUpActionDate, false);
            }

        }

        private void tsbClaimGenerateTemp_Click(object sender, EventArgs e)
        {

            try
            {
                if (_InitialTransaction.TransactionID > 0 && _InitialTransaction.TransactionMasterID > 0)
                {
                    DataTable _dtSchedule = gloCharges.GetFollowUpSchedule(_InitialTransaction.TransactionID, _InitialTransaction.TransactionMasterID);
                    if (_dtSchedule != null && _dtSchedule.Rows.Count > 0)
                    {

                        frmSetupFollowupDateActionTemplate objfrm = new frmSetupFollowupDateActionTemplate(CollectionEnums.FollowUpType.Claim, Convert.ToInt64(_dtSchedule.Rows[0]["nPatientID"]), Convert.ToInt64(_dtSchedule.Rows[0]["nAccountID"]), _InitialTransaction.TransactionID, _InitialTransaction.TransactionMasterID);
                        objfrm.ScheduleID = Convert.ToInt64(_dtSchedule.Rows[0]["nScheduleId"]);
                        objfrm.ShowDialog(this);
                        SetLastGlobalPeriods();
                        objfrm.Dispose();
                        objfrm = null;

                    }
                    else
                    {
                        frmSetupFollowupDateActionTemplate objfrm = new frmSetupFollowupDateActionTemplate(CollectionEnums.FollowUpType.Claim, _InitialTransaction.PatientID, _InitialTransaction.PAccountID, _InitialTransaction.TransactionID, _InitialTransaction.TransactionMasterID);
                        objfrm.ScheduleID = 0;
                        objfrm.ShowDialog(this);
                        SetLastGlobalPeriods();
                        objfrm.Dispose();
                        objfrm = null;
                    }
                }
            }
            catch (Exception exClaimGenerateTemp)
            {
                gloAuditTrail.gloAuditTrail.ExceptionLog(exClaimGenerateTemp, false);
            }
        }

        #endregion

        #region " Form Button Click Events "

        private void btnAdd_Cases_Click(object sender, EventArgs e)
        {
            PerformCaseAdd();
        }

        private void btnRemove_Cases_Click(object sender, EventArgs e)
        {
            PerformRemoveAction();
        }

        private void btnAdd_PriorAuthorization_Click(object sender, EventArgs e)
        {
            if (gloCharges.CheckPriorAuthorization(PatientID) == true)
            {
                if (txtPriorAuthorizationNo.Tag != null && (mskClaimDate.Text).Replace("/", "").Trim() != "")
                {
                    Int64 nPriorAutID = 0;
                    Int64.TryParse(Convert.ToString(txtPriorAuthorizationNo.Tag), out nPriorAutID);

                    gloPMGeneral.frmShowPriorAuthorization oPriorAuthorization = new gloPMGeneral.frmShowPriorAuthorization(_DatabaseConnectionString, gloDateMaster.gloDate.DateAsNumber(mskClaimDate.Text), nPriorAutID, PatientID);
                    try
                    {
                        oPriorAuthorization.ShowDialog(this);
                        if (oPriorAuthorization.CurrentPriorAuthorization.ToString().Trim() != "0")
                        {
                            Int64 nSelectedRefferals = Convert.ToInt64(cmbReferralProvider.SelectedValue);
                            ReloadPatientRefferals(_TransPatientID);
                            chk_SameasBillingProvider.Checked = false;

                            txtPriorAuthorizationNo.Tag = oPriorAuthorization.CurrentPriorAuthorization;
                            txtPriorAuthorizationNo.Text = oPriorAuthorization.CurrentPriorAuthorizationNo;
                            if (oPriorAuthorization.CurrentReferralProviderID != 0)
                            {
                                bool bExists = false;

                                if (cmbReferralProvider.DataSource != null)
                                {
                                    foreach (DataRowView drv in cmbReferralProvider.Items)
                                    {
                                        if (Convert.ToInt64(drv.Row.ItemArray[0]) == oPriorAuthorization.CurrentReferralProviderID) { bExists = true; break; }
                                    }
                                }

                                if (bExists)
                                {
                                    cmbReferralProvider.SelectedValue = oPriorAuthorization.CurrentReferralProviderID;
                                }
                                else
                                {
                                    cmbReferralProvider.SelectedValue = nSelectedRefferals;
                                }
                            }
                            else
                            {
                                cmbReferralProvider.SelectedValue = nSelectedRefferals;
                            }
                        }

                    }
                    catch (Exception ex)
                    {
                        gloAuditTrail.gloAuditTrail.ExceptionLog(ex, true);

                    }
                    finally
                    {
                        oPriorAuthorization.Dispose();
                    }
                }
                else if ((mskClaimDate.Text).Replace("/", "").Trim() != "")
                {
                    gloPMGeneral.frmShowPriorAuthorization oPriorAuthorization = new gloPMGeneral.frmShowPriorAuthorization(_DatabaseConnectionString, gloDateMaster.gloDate.DateAsNumber(mskClaimDate.Text), 0, PatientID);
                    try
                    {
                        oPriorAuthorization.ShowDialog(this);
                        if (oPriorAuthorization.CurrentPriorAuthorization.ToString().Trim() != "0")
                        {
                            Int64 nSelectedRefferals = Convert.ToInt64(cmbReferralProvider.SelectedValue);
                            ReloadPatientRefferals(_TransPatientID);
                            chk_SameasBillingProvider.Checked = false;

                            txtPriorAuthorizationNo.Tag = oPriorAuthorization.CurrentPriorAuthorization;
                            txtPriorAuthorizationNo.Text = oPriorAuthorization.CurrentPriorAuthorizationNo;
                            if (oPriorAuthorization.CurrentReferralProviderID != 0)
                            {
                                bool bExists = false;
                                if (cmbReferralProvider.DataSource != null)
                                {
                                    foreach (DataRowView drv in cmbReferralProvider.Items)
                                    {
                                        if (Convert.ToInt64(drv.Row.ItemArray[0]) == oPriorAuthorization.CurrentReferralProviderID) { bExists = true; break; }
                                    }
                                }
                                if (bExists)
                                {
                                    cmbReferralProvider.SelectedValue = oPriorAuthorization.CurrentReferralProviderID;
                                }
                                else
                                {
                                    cmbReferralProvider.SelectedValue = nSelectedRefferals;
                                }
                            }
                            else
                            {
                                cmbReferralProvider.SelectedValue = nSelectedRefferals;
                            }
                        }
                    }
                    catch (Exception ex)
                    {
                        gloAuditTrail.gloAuditTrail.ExceptionLog(ex, true);

                    }
                    finally
                    {
                        oPriorAuthorization.Dispose();
                    }
                }
                else
                {
                    gloPMGeneral.frmShowPriorAuthorization oPriorAuthorization = new gloPMGeneral.frmShowPriorAuthorization(_DatabaseConnectionString, gloDateMaster.gloDate.DateAsNumber(System.DateTime.Today.ToShortDateString()), 0, PatientID);
                    try
                    {
                        oPriorAuthorization.ShowDialog(this);
                        if (oPriorAuthorization.CurrentPriorAuthorization.ToString().Trim() != "0")
                        {
                            Int64 nSelectedRefferals = Convert.ToInt64(cmbReferralProvider.SelectedValue);
                            ReloadPatientRefferals(_TransPatientID);
                            chk_SameasBillingProvider.Checked = false;

                            txtPriorAuthorizationNo.Tag = oPriorAuthorization.CurrentPriorAuthorization;
                            txtPriorAuthorizationNo.Text = oPriorAuthorization.CurrentPriorAuthorizationNo;
                            if (oPriorAuthorization.CurrentReferralProviderID != 0)
                            {
                                bool bExists = false;
                                if (cmbReferralProvider.DataSource != null)
                                {
                                    foreach (DataRowView drv in cmbReferralProvider.Items)
                                    {
                                        if (Convert.ToInt64(drv.Row.ItemArray[0]) == oPriorAuthorization.CurrentReferralProviderID) { bExists = true; break; }
                                    }
                                }
                                if (bExists)
                                {
                                    cmbReferralProvider.SelectedValue = oPriorAuthorization.CurrentReferralProviderID;
                                }
                                else
                                {
                                    cmbReferralProvider.SelectedValue = nSelectedRefferals;
                                }
                            }
                            else
                            {
                                cmbReferralProvider.SelectedValue = nSelectedRefferals;
                            }
                        }
                    }
                    catch (Exception ex)
                    {
                        gloAuditTrail.gloAuditTrail.ExceptionLog(ex, true);

                    }
                    finally
                    {
                        oPriorAuthorization.Dispose();
                    }

                }
            }
            else
            {
                gloPMGeneral.frmSetupAuthorization objsetupauth = new gloPMGeneral.frmSetupAuthorization(PatientID);
                try
                {
                    objsetupauth.ShowDialog(this);
                    Int64 priorAuthID = objsetupauth._PriorAuthorizationID;
                    if (priorAuthID.ToString().Trim() != "" && priorAuthID != 0)
                    {
                        Int64 nSelectedRefferals = Convert.ToInt64(cmbReferralProvider.SelectedValue);
                        ReloadPatientRefferals(_TransPatientID);
                        chk_SameasBillingProvider.Checked = false;

                        txtPriorAuthorizationNo.Tag = priorAuthID;
                        txtPriorAuthorizationNo.Text = objsetupauth._PriorAuthorizationNo.ToString().Trim();

                        if (objsetupauth._ReferralID != 0)
                        {
                            bool bExists = false;
                            if (cmbReferralProvider.DataSource != null)
                            {
                                foreach (DataRowView drv in cmbReferralProvider.Items)
                                {
                                    if (Convert.ToInt64(drv.Row.ItemArray[0]) == objsetupauth._ReferralID) { bExists = true; break; }
                                }
                            }
                            if (bExists)
                            {
                                cmbReferralProvider.SelectedValue = objsetupauth._ReferralID;
                            }
                            else
                            {
                                cmbReferralProvider.SelectedValue = nSelectedRefferals;
                            }
                        }
                        else
                        {
                            cmbReferralProvider.SelectedValue = nSelectedRefferals;
                        }
                    }
                }
                catch (Exception ex)
                {
                    gloAuditTrail.gloAuditTrail.ExceptionLog(ex, true);

                }
                finally
                {
                    objsetupauth.Dispose();
                }
            }

            Int64 nPriorAuthNo = 0;
            Int64.TryParse(Convert.ToString(txtPriorAuthorizationNo.Tag), out nPriorAuthNo);
            if (Convert.ToInt64(nPriorAuthNo) > 0)
            {
                if (!gloCharges.getPriorAuthorizationStatus(Convert.ToInt64(txtPriorAuthorizationNo.Tag)))
                {
                    if (txtPriorAuthorizationNo.Tag == null || Convert.ToString(txtPriorAuthorizationNo.Tag) == "")
                    {
                        txtPriorAuthorizationNo.Tag = null;
                        txtPriorAuthorizationNo.Text = "";
                        CheckForPA();
                    }
                }
            }

            CheckForPA();

        }

        private void btnRemove_PriorAuthorization_Click(object sender, EventArgs e)
        {
            _isRemoved = true;
            try
            {
                if (Convert.ToString(txtPriorAuthorizationNo.Tag) != "")
                {
                    PriorAuthID = Convert.ToInt64(txtPriorAuthorizationNo.Tag);
                }
                PriorAuthNo = Convert.ToString(txtPriorAuthorizationNo.Text.ToString());
                if (txtPriorAuthorizationNo.Tag != null && txtPriorAuthorizationNo.Tag.ToString() != "")
                {
                    gloAuditTrail.gloAuditTrail.CreateAuditLog(ActivityModule.Billing, ActivityCategory.SetupCharges, ActivityType.Remove, "Prior Authorization removed from the Transaction", _TransPatientID, Convert.ToInt64(txtPriorAuthorizationNo.Tag), 0, ActivityOutCome.Success);
                    txtPriorAuthorizationNo.Text = "";
                    txtPriorAuthorizationNo.Tag = null;
                }

                CheckForPA();
                if (_InitialTransaction.PriorAuthorizationID != 0)
                {
                    _isRemoved = true;
                }
                else
                {
                    _isRemoved = false;
                }
            }
            catch (Exception ex)
            {
                gloAuditTrail.gloAuditTrail.ExceptionLog(ex, false);
            }
        }

        private void btnHideInsurance_Click(object sender, EventArgs e)
        {
            pnlPatientInsurence.Visible = true;
            btnShowInsurance.Visible = true;
            btnHideInsurance.Visible = false;
        }

        private void btnShowInsurance_Click(object sender, EventArgs e)
        {
            pnlPatientInsurence.Visible = false;
            btnHideInsurance.Visible = true;
            btnShowInsurance.Visible = false;
        }

        private void btnHideDiagnosis_Click(object sender, EventArgs e)
        {
            pnllstBoxDiagnosis.Visible = false;
            btnHideDiagnosis.Visible = false;
            btnShowDiagnosis.Visible = true;
        }

        private void btnShowDiagnosis_Click(object sender, EventArgs e)
        {
            pnllstBoxDiagnosis.Visible = true;
            btnHideDiagnosis.Visible = true;
            btnShowDiagnosis.Visible = false;
        }

        private void btnReplacedByModifyCharges_Click(object sender, EventArgs e)
        {
            try
            {
                if (Convert.ToString(lblReplacedByClaim.Tag) != "")
                {
                    Int64 nTransactionID = gloCharges.GetParentClaimTransactionID(Convert.ToInt64(lblReplacedByClaim.Tag));
                    frmBillingModifyCharges ofrmBillingModifyCharges = new frmBillingModifyCharges(this.PatientID, nTransactionID, false, _DatabaseConnectionString, _DatabaseConnectionString);
                    ofrmBillingModifyCharges.WindowState = FormWindowState.Maximized;
                    ofrmBillingModifyCharges.IsClaimVoided = false;
                    ofrmBillingModifyCharges.ShowDialog(this);
                    ofrmBillingModifyCharges.Dispose();
                }
            }
            catch (Exception exReplacedByModifyCharge)
            {
                gloAuditTrail.gloAuditTrail.ExceptionLog(exReplacedByModifyCharge, false);
            }
        }

        private void btnReplacesModifyCharges_Click(object sender, EventArgs e)
        {
            try
            {
                if (Convert.ToString(lblReplacesClaim.Tag) != "")
                {
                    Int64 nTransactionID = gloCharges.GetParentClaimTransactionID(Convert.ToInt64(lblReplacesClaim.Tag));
                    frmBillingModifyCharges ofrmBillingModifyCharges = new frmBillingModifyCharges(this.PatientID, nTransactionID, false, _DatabaseConnectionString, _DatabaseConnectionString);
                    ofrmBillingModifyCharges.WindowState = FormWindowState.Maximized;
                    ofrmBillingModifyCharges.IsClaimVoided = false;
                    ofrmBillingModifyCharges.ShowDialog(this);
                    ofrmBillingModifyCharges.Dispose();
                }
            }
            catch (Exception exReplacesModifyCharge)
            {
                gloAuditTrail.gloAuditTrail.ExceptionLog(exReplacesModifyCharge, false);
            }
        }

        #endregion " Form Button Click Events "

        #region " Form Events"

        private void frmBillingModifyCharges_FormClosed(object sender, FormClosedEventArgs e)
        {
            //gloSettings.DatabaseSetting.DataBaseSetting oSettings = new gloSettings.DatabaseSetting.DataBaseSetting();
            try
            {
                if (_IsModifyed)
                {
                    //oSettings.WriteSettings_XML("Charges", "IsClaimModified", Boolean.TrueString);
                    gloGlobal.gloPMGlobal.ChargesIsClaimModified = true;
                }
                else
                {
                    //oSettings.WriteSettings_XML("Charges", "IsClaimModified", Boolean.FalseString);
                    gloGlobal.gloPMGlobal.ChargesIsClaimModified = false;
                }


                if (_oClaimHold != null)
                {
                    _oClaimHold.Dispose();
                }
                if (oListControl != null)
                {
                    oListControl.Dispose();
                }


            }
            catch (Exception ex)
            {
                gloAuditTrail.gloAuditTrail.ExceptionLog(ex, false);
            }
            finally
            {
                //if (oSettings != null) { oSettings.Dispose(); }
            }
        }

        private void frmBillingModifyCharges_FormClosing(object sender, FormClosingEventArgs e)
        {


            try
            {
                //By Debasish Das BUG ID 3360.
                if (!IsModified && Cls_GlobalSettings.IsPaymentVoided)
                {
                    IsModified = true;
                }

                //To Not to release the claim from Lock When it is called From Insurance Payment .Buse we are locking the Claims in Load 
                if (CallingContainer != "frmInsurancePaymentV2")
                {
                    Boolean _isReleased = gloCharges.ReleaseLockStatus(_MasterTransactionID);
                }

                if (this.lstAppointmentIDs != null)
                {
                    this.lstAppointmentIDs.Clear();
                    this.lstAppointmentIDs = null;
                }

                if (this.ListOfPatientAppointments != null)
                {
                    this.ListOfPatientAppointments.Clear();
                    this.ListOfPatientAppointments = null;
                }

                _OpenViewMode = false;
            }
            catch (Exception ex)
            {
                gloAuditTrail.gloAuditTrail.ExceptionLog(ex, false);
            }
            finally
            {
            }
        }

        #endregion " Form Events"

        #region " Form Controls Events "

        private void CmbAccidentType_SelectedIndexChanged(object sender, EventArgs e)
        {
            lblInitDate.Visible = false;
            mskInitTreatment.Visible = false;

            switch (CmbAccidentType.Text.Trim())
            {
                case "Work":

                    _isTextBoxLoading = true;
                    _isTextBoxLoading = false;

                    lblInjuryDate.Visible = true;
                    lblOnsiteDate.Visible = false;
                    lblClaimDateHyphen.Visible = false;
                    lblOtherDate.Visible = false;
                    lblAccidentDate.Visible = false;

                    mskInjuryDate.Text = "";
                    mskOnsiteDate.Text = "";
                    mskOtherDate.Text = "";
                    mskAccidentDate.Text = "";
                    mskInitTreatment.Text = "";

                    if (_WorkerCompType == "WorkersComp")
                    {
                        txt_WcAc.Text = _WorkerCompNo;
                        mskInjuryDate.Text = _WorkerInjuryDate;
                    }
                    else
                    {
                        txt_WcAc.Text = _WorkerCompNo;
                        mskAccidentDate.Text = "";
                        txt_WcAc.Tag = "";
                    }


                    mskInjuryDate.Visible = true;
                    mskOnsiteDate.Visible = false;
                    cmbBox14DateQualifier.Visible = false;
                    mskOtherDate.Visible = false;
                    mskAccidentDate.Visible = false;

                    lbl_State.Visible = false;
                    cmbState.Visible = false;
                    cmbState.Enabled = false;
                    txt_WcAc.Visible = true;
                    lblClaim.Visible = true;

                    lblClaim.Text = " Workers Comp# :";

                    break;
                case "Auto":
                    //SLR: Changed on 2/4/2014
                    for (int i = pnlInternalControl.Controls.Count - 1; i >= 0; i--)
                    {
                        pnlInternalControl.Controls.RemoveAt(i);
                    }

                    _isTextBoxLoading = true;
                    _isTextBoxLoading = false;

                    lblInjuryDate.Visible = false;
                    lblOnsiteDate.Visible = false;
                    lblClaimDateHyphen.Visible = false;
                    lblOtherDate.Visible = false;
                    lblAccidentDate.Visible = true;


                    mskInjuryDate.Visible = false;
                    mskOnsiteDate.Visible = false;
                    cmbBox14DateQualifier.Visible = false;
                    mskOtherDate.Visible = false;
                    mskAccidentDate.Visible = true;

                    mskInjuryDate.Text = "";
                    mskOnsiteDate.Text = "";
                    mskOtherDate.Text = "";
                    mskAccidentDate.Text = "";
                    mskInitTreatment.Text = "";

                    if (_WorkerCompType == "AutoClaim")
                    {
                        txt_WcAc.Text = _AutoClaimNo;
                        mskAccidentDate.Text = _AccidentDate;
                    }
                    else
                    {
                        txt_WcAc.Text = _AutoClaimNo;
                        mskInjuryDate.Text = "";
                        txt_WcAc.Tag = "";
                    }


                    cmbState.Visible = true;
                    lbl_State.Visible = true;

                    cmbState.Enabled = true;
                    cmbState.Focus();

                    txt_WcAc.Visible = true;
                    lblClaim.Visible = true;
                    lblClaim.Text = " Workers Comp# :";
                    cmbClaimNo.Visible = false;
                    lblClaim.Text = "Auto Claim # :";

                    break;
                case "Other":


                    _isTextBoxLoading = true;
                    _isTextBoxLoading = false;

                    lblInjuryDate.Visible = false;
                    lblOnsiteDate.Visible = false;
                    lblClaimDateHyphen.Visible = false;
                    lblOtherDate.Visible = true;
                    lblAccidentDate.Visible = false;

                    mskInjuryDate.Visible = false;
                    mskOnsiteDate.Visible = false;
                    cmbBox14DateQualifier.Visible = false;
                    mskOtherDate.Visible = true;
                    mskAccidentDate.Visible = false;

                    mskInjuryDate.Text = "";
                    mskOnsiteDate.Text = "";
                    mskOtherDate.Text = "";
                    mskAccidentDate.Text = "";
                    mskInitTreatment.Text = "";

                    if (_WorkerCompType == "OtherAccident")
                    {
                        //txt_WcAc.Text = _OtherAccidentNo;
                        mskOtherDate.Text = _OtherDate;
                    }
                    else
                    {
                        //txt_WcAc.Text = _OtherAccidentNo;
                        mskOtherDate.Text = "";
                    }


                    txt_WcAc.Visible = false;
                    lbl_State.Visible = false;
                    cmbState.Visible = false;
                    cmbState.Enabled = false;
                    cmbClaimNo.Visible = false;
                    lblClaim.Visible = false;

                    break;
                default:

                    lblInjuryDate.Visible = false;
                    lblOnsiteDate.Visible = true;
                    lblClaimDateHyphen.Visible = true;
                    lblOtherDate.Visible = false;
                    lblAccidentDate.Visible = false;

                    mskInjuryDate.Visible = false;
                    mskOnsiteDate.Visible = true;
                    mskOnsiteDate.BringToFront();
                    cmbBox14DateQualifier.Visible = true;
                    mskOtherDate.Visible = false;
                    mskAccidentDate.Visible = false;

                    mskInjuryDate.Text = "";
                    mskOnsiteDate.Text = "";
                    mskOtherDate.Text = "";
                    mskAccidentDate.Text = "";

                    lbl_State.Visible = false;
                    cmbState.Visible = false;
                    cmbState.Enabled = false;
                    cmbClaimNo.Visible = false;
                    txt_WcAc.Visible = false;
                    lblClaim.Visible = false;

                    if (bShowInitialTreatmentDate)
                    {
                        lblInitDate.Visible = false;
                        mskInitTreatment.Visible = false;
                        if (_InitialTransaction.dtInitTreatmentDate != null)
                        {
                            mskInitTreatment.Text = Convert.ToDateTime(_InitialTransaction.dtInitTreatmentDate).ToString("MM/dd/yyyy");
                        }
                        else
                        {
                            mskInitTreatment.Text = "";
                        }
                    }
                    break;
            }

        }

        private void tls_btnFNFCharges_Click(object sender, EventArgs e)
        {
            //if (tls_btnFNFCharges.Tag.ToString() == "Facility")
            //{
            //    SetNonFacilityFee();
            //}
            //else if (tls_btnFNFCharges.Tag.ToString() == "NonFacility")
            //{
            //    SetFacilityFee();
            //}
        }

        private void chkFacilityFeeSchedule_CheckedChanged(object sender, EventArgs e)
        {
            //if (_IsFormLoading == false)
            //{
            //    if (chkFacilityFeeSchedule.Checked == true)
            //    {
            //        chkNonFacilityCharges.Checked = false;
            //        if (UC_gloBillingTransactionLines != null)
            //        {
            //            //UC_gloBillingTransactionLines.IsFaclityFee = true;
            //            UC_gloBillingTransactionLines.DefaultChargesType = FacilityType.Facility;
            //            UC_gloBillingTransactionLines.SetFNFCharges();
            //        }
            //    }
            //}
            if (_IsFormLoading == false)
            {
                //bool _autosort = false;
                if (chkFacilityFeeSchedule.Checked == true)
                {
                    if (UC_gloBillingTransactionLines.AutoSort == true)
                    {
                        // _autosort = true;
                        UC_gloBillingTransactionLines.AutoSort = false;
                    }
                    chkNonFacilityCharges.Checked = false;
                    if (UC_gloBillingTransactionLines != null)
                    {
                        //UC_gloBillingTransactionLines.IsFaclityFee = true;                        
                        UC_gloBillingTransactionLines.DefaultChargesType = FacilityType.Facility;
                        UC_gloBillingTransactionLines.ShowFeeScheduleWarning = false;
                        chkFacilityFeeSchedule.Refresh();
                        // when open a charge from modify charges screen,sorting will not require so passing "false" value.
                        UC_gloBillingTransactionLines.SetFNFLineCharges(false);
                    }
                    //UC_gloBillingTransactionLines.AutoSort = _autosort;
                    //if (_autosort == true)
                    //{
                    //    UC_gloBillingTransactionLines.SortControl();
                    //}
                }
                else
                {
                    chkNonFacilityCharges.Checked = true;
                }
            }
        }

        private void chkNonFacilityCharges_CheckedChanged(object sender, EventArgs e)
        {
            //if (_IsFormLoading == false)
            //{
            //    if (chkNonFacilityCharges.Checked == true)
            //    {
            //        chkFacilityFeeSchedule.Checked = false;
            //        if (UC_gloBillingTransactionLines != null)
            //        {
            //            //UC_gloBillingTransactionLines.IsFaclityFee = false;
            //            UC_gloBillingTransactionLines.DefaultChargesType = FacilityType.NonFacility;
            //            UC_gloBillingTransactionLines.SetFNFCharges();
            //        }
            //    }
            //}

            if (_IsFormLoading == false)
            {
                //bool _autosort = false;
                if (chkNonFacilityCharges.Checked == true)
                {
                    if (UC_gloBillingTransactionLines.AutoSort == true)
                    {
                        //_autosort = true;
                        UC_gloBillingTransactionLines.AutoSort = false;
                    }



                    chkFacilityFeeSchedule.Checked = false;
                    if (UC_gloBillingTransactionLines != null)
                    {
                        //UC_gloBillingTransactionLines.IsFaclityFee = false;
                        UC_gloBillingTransactionLines.DefaultChargesType = FacilityType.NonFacility;
                        chkNonFacilityCharges.Refresh();
                        UC_gloBillingTransactionLines.ShowFeeScheduleWarning = false;
                        // when open a charge from modify charges screen,sorting will not require so passing "false" value.
                        UC_gloBillingTransactionLines.SetFNFLineCharges(false);
                    }
                    //UC_gloBillingTransactionLines.AutoSort = _autosort;
                    //if (_autosort == true)
                    //{
                    //    UC_gloBillingTransactionLines.SortControl();
                    //}
                }
                else
                {
                    chkFacilityFeeSchedule.Checked = true;
                }

            }

        }

        private void btnAdd_Referral_Click(object sender, EventArgs e)
        {
            Int64 _currentPatientId = 0;
            gloUserRights.ClsgloUserRights ObjUserRights = new gloUserRights.ClsgloUserRights(_DatabaseConnectionString);
            try
            {


                ObjUserRights.CheckForUserRights(_UserName);
                if (ObjUserRights.ModifyPatient == true)
                {
                    if (this.PatientID > 0)
                    {
                        gloPatient.gloPatient ogloPatient = new gloPatient.gloPatient(_DatabaseConnectionString);
                        ogloPatient.ShowPatientRegistration(this.PatientID, gloPatient.ModifyPatientDetailType.Referral, out _currentPatientId, this);
                        FillReferralProviders(_currentPatientId);
                        ogloPatient.Dispose();
                        ogloPatient = null;
                        //20100503 - Hot Fix Rendering Provider Issue 
                        chk_SameasBillingProvider_CheckedChanged(null, null);
                    }
                }
            }
            catch (Exception ex)
            {
                gloAuditTrail.gloAuditTrail.ExceptionLog(ex, true);
            }
            finally
            {
                try
                {
                    if (ObjUserRights != null)
                    {
                        ObjUserRights.Dispose();
                        ObjUserRights = null;
                    }
                }
                catch
                {
                }
            }
        }

        private void chkOutSideLab_CheckedChanged(object sender, EventArgs e)
        {
            if (chkOutSideLab.Checked == true)
            {
                txtOutSideLabCharges.Enabled = true;
                txtOutSideLabCharges.Focus();
                txtOutSideLabCharges.Text = "0.00";
                txtOutSideLabCharges.Select();
            }
            else if (chkOutSideLab.Checked == false)
            {
                txtOutSideLabCharges.Enabled = false;
                txtOutSideLabCharges.Text = "0.00";

            }
        }

        private void dtpClaimDate_ValueChanged(object sender, EventArgs e)
        {
            //SetBatchNumber();
        }

        private void cmbBillingProvider_SelectedIndexChanged(object sender, EventArgs e)
        {
            Int64 nRefProvider = Convert.ToInt64(cmbReferralProvider.SelectedValue);

            //Added By Debasish Das on 8th June 2010.
            chk_SameasBillingProvider.Checked = false;
            //cmbReferralProvider.Items.Clear();
            FillReferralProviders(_TransPatientID);
            //**
            if (_InitialTransaction != null)
            {
                if (cmbReferralProvider.SelectedIndex == -1)
                {
                    AddCurrentSavedReferal(_InitialTransaction.ReferalProviderID_New);
                }
            }

            LoadDefaultSettings();
        }

        private void cmbFacility_SelectedIndexChanged(object sender, EventArgs e)
        {
            try
            {
                this.cmbFacility.SelectedIndexChanged -= new System.EventHandler(this.cmbFacility_SelectedIndexChanged);
                if (_IsFormLoading == false)
                {
                    if (UC_gloBillingTransactionLines != null)
                    {
                        if (cmbFacility.SelectedIndex >= 0)
                        {
                            UC_gloBillingTransactionLines.FacilityID = Convert.ToInt64(cmbFacility.SelectedValue);
                            SetFacility(true);
                        }
                        //gloFacility ogloFacility = new gloFacility(_DatabaseConnectionString);
                        //UC_gloBillingTransactionLines.FacilityCLIANo = ogloFacility.GetFacilityCLIA(Convert.ToString(UC_gloBillingTransactionLines.FacilityID),this.ClinicID);
                        //UC_gloBillingTransactionLines.SetFacilityCLIA();
                        //if (ogloFacility != null) { ogloFacility.Dispose(); }
                        UC_gloBillingTransactionLines.SetFacilityMammogramNo();
                        this._sMammogramCertNumber= UC_gloBillingTransactionLines.sMammogramCertNo;
                    }
                }
            }
            catch (Exception ex)
            {
                gloAuditTrail.gloAuditTrail.ExceptionLog(ex, false);
            }
            finally
            {
                this.cmbFacility.SelectedIndexChanged += new System.EventHandler(this.cmbFacility_SelectedIndexChanged);
            }
        }

        private void cmbBillingProvider_MouseHover(object sender, EventArgs e)
        {

        }

        private void cmbClaimCategory_MouseEnter(object sender, EventArgs e)
        {
            combo = (ComboBox)sender;
            if (cmbClaimCategory.SelectedItem != null)
            {
                if (getWidthofListItems(Convert.ToString(((DataRowView)cmbClaimCategory.Items[cmbClaimCategory.SelectedIndex])["sDescription"]), cmbClaimCategory) >= cmbClaimCategory.DropDownWidth - 20)
                {
                    string txt = Convert.ToString(((DataRowView)cmbClaimCategory.Items[cmbClaimCategory.SelectedIndex])["sDescription"]);
                    if (tooltip_Billing.GetToolTip(cmbClaimCategory) != txt)
                    {
                        tooltip_Billing.SetToolTip(cmbClaimCategory, txt);
                    }
                }
                else
                {
                    this.tooltip_Billing.SetToolTip(cmbClaimCategory, "");
                }

            }
        }

        private void cmbClaimCategory_SelectedIndexChanged(object sender, EventArgs e)
        {
            if (_IsFormLoading == false)
            {

                #region " Tool tip "

                combo = (ComboBox)sender;
                if (cmbClaimCategory.SelectedItem != null)
                {
                    if (getWidthofListItems(Convert.ToString(((DataRowView)cmbClaimCategory.Items[cmbClaimCategory.SelectedIndex])["sDescription"]), cmbClaimCategory) >= cmbClaimCategory.DropDownWidth - 20)
                    {
                        string txt = Convert.ToString(((DataRowView)cmbClaimCategory.Items[cmbClaimCategory.SelectedIndex])["sDescription"]);
                        if (tooltip_Billing.GetToolTip(cmbClaimCategory) != txt)
                        {
                            tooltip_Billing.SetToolTip(cmbClaimCategory, txt);
                        }
                    }
                    else
                    {
                        this.tooltip_Billing.SetToolTip(cmbClaimCategory, "");
                    }

                }

                #endregion " Tool tip "
            }
        }

        private void txtOutSideLabCharges_KeyPress(object sender, KeyPressEventArgs e)
        {
            if (!((e.KeyChar >= Convert.ToChar(48) && e.KeyChar <= Convert.ToChar(57)) || e.KeyChar == Convert.ToChar(8) || e.KeyChar == Convert.ToChar(46)))
            {
                e.Handled = true;
            }
            else
            {
                if (txtOutSideLabCharges.SelectionStart > txtOutSideLabCharges.Text.IndexOf("."))
                {
                    if (txtOutSideLabCharges.Text.Contains(".") == true)
                    {
                        if (txtOutSideLabCharges.Text.Substring(txtOutSideLabCharges.Text.IndexOf(".") + 1, txtOutSideLabCharges.Text.Length - (txtOutSideLabCharges.Text.IndexOf(".") + 1)).Length == 2)
                        {
                            e.Handled = true;
                        }
                    }
                }
            }
            if (e.KeyChar == Convert.ToChar(46) && txtOutSideLabCharges.Text.Contains("."))
            {
                e.Handled = true;
            }
        }

        private void chkFeeSchedule_CheckedChanged(object sender, EventArgs e)
        {
            //if (chkFeeSchedule.Checked == true)
            //{
            //    cmbFeeSchedule.SelectedIndex = -1;
            //    cmbFeeSchedule.Enabled = true;
            //    cmbFeeSchedule.Focus();
            //    UC_gloBillingTransactionLines.IsFeeSchedule = true;
            //    UC_gloBillingTransactionLines.FeeScheduleID = 0;
            //}
            //else
            //{
            //    cmbFeeSchedule.SelectedIndex = -1;
            //    cmbFeeSchedule.Enabled = false;
            //    UC_gloBillingTransactionLines.IsFeeSchedule = false;
            //    UC_gloBillingTransactionLines.FeeScheduleID = 0;
            //}

            if (chkFeeSchedule.Checked == true)
            {
                //cmbFeeSchedule.SelectedIndex = -1;
                cmbFeeSchedule.Enabled = true;
                cmbFeeSchedule.Focus();
                UC_gloBillingTransactionLines.IsFeeSchedule = true;
                UC_gloBillingTransactionLines.FeeScheduleID = Convert.ToInt64(cmbFeeSchedule.SelectedValue.ToString());
                UC_gloBillingTransactionLines.ShowFeeScheduleWarning = true;
                // when open a charge from modify charges screen,sorting will not require so passing "false" value.
                UC_gloBillingTransactionLines.SetFNFLineCharges(false);
                //
            }
            else
            {
                //cmbFeeSchedule.SelectedIndex = -1;
                cmbFeeSchedule.Enabled = false;
                UC_gloBillingTransactionLines.IsFeeSchedule = false;
                UC_gloBillingTransactionLines.FeeScheduleID = 0;
                UC_gloBillingTransactionLines.ShowFeeScheduleWarning = true;
                if (_FeeScheduleID > 0)
                {
                    UC_gloBillingTransactionLines.FeeScheduleID = _FeeScheduleID;
                    cmbFeeSchedule.SelectedValue = _FeeScheduleID;
                }
                else
                {
                    //Bug #67038: 00000386 : Fee Schedules      
                    //Set Provider default fee schedule if it is not available then set clinic default fee schedule
                    if (cmbFeeSchedule.Items.Count > 0)
                    {
                        Int64 _DefaultFeeScheduleID = gloCharges.GetProviderFeeScheduleID(_PatientPoviderID);
                        if (_DefaultFeeScheduleID == 0)
                        {
                            _DefaultFeeScheduleID = gloCharges.GetClinicFeeScheduleID();
                        }
                        if (_DefaultFeeScheduleID > 0)
                            cmbFeeSchedule.SelectedValue = _DefaultFeeScheduleID;
                        else
                            cmbFeeSchedule.SelectedIndex = 0;
                        _FeeScheduleID = Convert.ToInt64(cmbFeeSchedule.SelectedValue);
                    }
                }
                // when open a charge from modify charges screen,sorting will not require so passing "false" value.
                UC_gloBillingTransactionLines.SetFNFLineCharges(false);
                //
            }

        }

        private void cmbFeeSchedule_SelectedIndexChanged(object sender, EventArgs e)
        {
            //if (cmbFeeSchedule.SelectedIndex >= 0 && cmbFeeSchedule.SelectedValue != null)

            //if (chkNonFacilityCharges.Checked == true)
            //{                                
            //        UC_gloBillingTransactionLines.DefaultChargesType = FacilityType.NonFacility;                                   
            //}
            //if (chkFacilityFeeSchedule.Checked == true)
            //{
            //    UC_gloBillingTransactionLines.DefaultChargesType = FacilityType.Facility;
            //}


            //if (cmbFeeSchedule != null && cmbFeeSchedule.Items != null && cmbFeeSchedule.Items.Count > 0 && cmbFeeSchedule.SelectedIndex >= 0)
            //{
            //    UC_gloBillingTransactionLines.FeeScheduleID = Convert.ToInt64(cmbFeeSchedule.SelectedValue);
            //    UC_gloBillingTransactionLines.SetFNFCharges();
            //}
            //else
            //{
            //    UC_gloBillingTransactionLines.FeeScheduleID = 0;
            //}


            if (_IsFormLoading == false)
            {

                if (chkNonFacilityCharges.Checked == true)
                {
                    UC_gloBillingTransactionLines.DefaultChargesType = FacilityType.NonFacility;
                }
                if (chkFacilityFeeSchedule.Checked == true)
                {
                    UC_gloBillingTransactionLines.DefaultChargesType = FacilityType.Facility;
                }


                if (cmbFeeSchedule != null && cmbFeeSchedule.Items != null && cmbFeeSchedule.Items.Count > 0 && cmbFeeSchedule.SelectedIndex >= 0)
                {
                    UC_gloBillingTransactionLines.FeeScheduleID = Convert.ToInt64(cmbFeeSchedule.SelectedValue);
                    //UC_gloBillingTransactionLines.SetFNFCharges();
                    UC_gloBillingTransactionLines.ShowFeeScheduleWarning = true;

                    //  bool _autosort = false;
                    if (UC_gloBillingTransactionLines.AutoSort == true)
                    {
                        // _autosort = true;
                        UC_gloBillingTransactionLines.AutoSort = false;
                    }
                    if (UC_gloBillingTransactionLines != null)
                    {
                        // when open a charge from modify charges screen,sorting will not require so passing "false" value.
                        UC_gloBillingTransactionLines.SetFNFLineCharges(false);
                    }
                    //UC_gloBillingTransactionLines.AutoSort = _autosort;

                    //if (_autosort == true)
                    //{
                    //    UC_gloBillingTransactionLines.SortControl();
                    //}


                }
                else
                {
                    UC_gloBillingTransactionLines.FeeScheduleID = 0;
                }

            }

        }

        private void btnSelectChargeTry_Click(object sender, EventArgs e)
        {
            frmBillingTraySelection ofrmBillingTraySelection = new frmBillingTraySelection(_DatabaseConnectionString);
            ofrmBillingTraySelection.WindowState = FormWindowState.Normal;
            ofrmBillingTraySelection.StartPosition = FormStartPosition.CenterParent;
            ofrmBillingTraySelection.IsChargeTray = true;
            ofrmBillingTraySelection.ShowDialog(this);
            if (ofrmBillingTraySelection.FormResult == DialogResult.OK)
            {
                //if (ofrmBillingTraySelection.SelectedTrayID > 0)
                //{
                //    FillCloseDayTray();
                //    cmbCloseDayTray.SelectedValue = ofrmBillingTraySelection.SelectedTrayID;
                //}
                //else
                //{ cmbCloseDayTray.SelectedValue = -1; }

                if (ofrmBillingTraySelection.SelectedTrayID > 0)
                {
                    SelectedChargeTrayID = ofrmBillingTraySelection.SelectedTrayID;
                    SelectedChargeTrayDescription = ofrmBillingTraySelection.SelectedTrayName;
                }
                else
                {
                    SelectedChargeTrayID = 0;
                    SelectedChargeTrayDescription = "";
                }
            }
            //else
            //{ cmbCloseDayTray.SelectedValue = -1; }
            ofrmBillingTraySelection.Dispose();
        }

        private void chk_SameasBillingProvider_CheckedChanged(object sender, EventArgs e)
        {
            //if (chk_SameasBillingProvider.Checked == true)
            //{
            //    if (cmbBillingProvider.SelectedIndex >= 0)
            //    {
            //        cmbReferralProvider.DataSource = null;
            //        cmbReferralProvider.Items.Add(cmbBillingProvider.Text);

            //        if (cmbReferralProvider.Items.Count > 0)
            //        { cmbReferralProvider.SelectedIndex = 0; }
            //        else
            //        { cmbReferralProvider.SelectedIndex = -1; }



            //    }
            //}
            //else
            //{
            //    FillReferralProviders(_TransPatientID);

            //    cmbReferralProvider.SelectedValue = _InitialTransaction.ReferalProviderID_New;
            //    if (cmbReferralProvider.SelectedIndex == -1)
            //    {
            //        AddCurrentSavedReferal(_InitialTransaction.ReferalProviderID_New);
            //    }
            //    if (_InitialTransaction.IsSameAsBillingProvider)
            //    {
            //        //Added By Debasish Das (5061)
            //        if (cmbReferralProvider.Items.Count == 2)
            //        {
            //            cmbReferralProvider.SelectedIndex = 1;
            //        }
            //        //***
            //    }

            //}
            if (chk_SameasBillingProvider.Checked == true)
            {
                if (cmbBillingProvider.SelectedIndex >= 0)
                {
                  
                    cmbReferralProvider.DataSource = null;
                    cmbReferralProvider.Items.Clear();
                    cmbReferralProvider.Items.Add(cmbBillingProvider.Text);

                    if (cmbReferralProvider.Items.Count > 0)
                    { cmbReferralProvider.SelectedIndex = 0; }
                    else
                    { cmbReferralProvider.SelectedIndex = -1; }



                }
            }
            else
            {
                FillReferralProviders(this.PatientID);
            }
            //Added By Debasish Das (5061)
            if (cmbReferralProvider.Items.Count == 2)
            {
                cmbReferralProvider.SelectedIndex = 1;











            }
            //***
        }

        private void AddCurrentSavedReferal(Int64 nRefProviderID)
        {
            try
            {
                DataTable dtReferral = null;
                gloDatabaseLayer.DBLayer oDB = new gloDatabaseLayer.DBLayer(_DatabaseConnectionString);
                oDB.Connect(false);
                string _sqlquery = " SELECT ISNULL(Contacts_MST.sFirstName,'')+' '+ISNULL(Contacts_MST.sMiddleName,'') +' '+ ISNULL(Contacts_MST.sLastName,'')AS sName, " +
                                  " nContactID from Contacts_Mst WITH (NOLOCK) where nContactID=" + nRefProviderID + " ";
                oDB.Retrive_Query(_sqlquery, out dtReferral);
                if (dtReferral != null && dtReferral.Rows.Count > 0)
                {
                    DataTable dtRow = (DataTable)cmbReferralProvider.DataSource;
                    DataRow rw = dtRow.NewRow();
                    rw["nReferralID"] = dtReferral.Rows[0]["nContactID"];
                    rw["sReferralName"] = dtReferral.Rows[0]["sName"];
                    dtRow.Rows.Add(rw);
                    cmbReferralProvider.SelectedValue = nRefProviderID;
                }

            }
            catch (Exception ex)
            {
                gloAuditTrail.gloAuditTrail.ExceptionLog(ex, false);
            }

            finally
            {
            }
        }

        private void TimerIsVoid_Tick(object sender, EventArgs e)
        {
            ShowVoidMessage();

        }

        private void lblCloseDayTray_MouseMove(object sender, MouseEventArgs e)
        {
            //try
            //{

            //    label = (Label)sender;

            //    if (lblCloseDayTray.Text != null && lblCloseDayTray.Text != "")
            //    {
            //        if (getWidthofListItems(Convert.ToString(lblCloseDayTray.Text), lblCloseDayTray) >= lblCloseDayTray.Width - 20)
            //        {
            //            //tooltip_Billing.Show(Convert.ToString(((DataRowView)cmbInsuranceCompany.Items[cmbInsuranceCompany.SelectedIndex])["sDescription"]), cmbInsuranceCompany,0, System.Windows.Forms.Control.MousePosition.Y - 230);
            //            tooltip_Billing.SetToolTip(lblCloseDayTray, lblCloseDayTray.Text);
            //        }
            //        else
            //        {
            //            this.tooltip_Billing.Hide(lblCloseDayTray);
            //        }
            //    }
            //    else
            //    {
            //        this.tooltip_Billing.Hide(lblCloseDayTray);
            //    }
            //}
            //catch (Exception Ex)
            //{
            //    gloAuditTrail.gloAuditTrail.ExceptionLog(Ex.ToString(), false);
            //    Ex = null;
            //}
        }

        private void lblCloseDayTray_MouseLeave(object sender, EventArgs e)
        {
            //this.tooltip_Billing.Hide(lblCloseDayTray);
        }

        private void lblCloseDayTray_MouseEnter(object sender, EventArgs e)
        {
            //try
            //{

            //    label = (Label)sender;

            //    if (lblCloseDayTray.Text != null && lblCloseDayTray.Text != "")
            //    {
            //        if (getWidthofListItems(Convert.ToString(lblCloseDayTray.Text), lblCloseDayTray) >= lblCloseDayTray.Width - 20)
            //        {
            //            //tooltip_Billing.Show(Convert.ToString(((DataRowView)cmbInsuranceCompany.Items[cmbInsuranceCompany.SelectedIndex])["sDescription"]), cmbInsuranceCompany,0, System.Windows.Forms.Control.MousePosition.Y - 230);
            //            tooltip_Billing.SetToolTip(lblCloseDayTray, lblCloseDayTray.Text);
            //        }
            //        else
            //        {
            //            this.tooltip_Billing.Hide(lblCloseDayTray);
            //        }
            //    }
            //    else
            //    {
            //        this.tooltip_Billing.Hide(lblCloseDayTray);
            //    }
            //}
            //catch (Exception Ex)
            //{
            //    gloAuditTrail.gloAuditTrail.ExceptionLog(Ex.ToString(), false);
            //    Ex = null;
            //}
        }

        //20100216 Mahesh Nawal For Implementing Tool tip on combo Box 
        private void cmbFacility_MouseMove(object sender, MouseEventArgs e)
        {
            combo = (ComboBox)sender;
            if (cmbFacility.SelectedItem != null)
            {
                if (getWidthofListItems(Convert.ToString(((DataRowView)cmbFacility.Items[cmbFacility.SelectedIndex])["sFacilityName"]), cmbFacility) >= cmbFacility.DropDownWidth - 20)
                {
                    this.tooltip_Billing.Show(Convert.ToString(((DataRowView)cmbFacility.Items[cmbFacility.SelectedIndex])["sFacilityName"]), cmbFacility, cmbFacility.Right - 350, cmbFacility.Bottom - 75);
                }
            }
        }

        # region ToolTip

        //Event for showing the ToolTip on DropList 
        void ShowTooltipOnComboBox(object sender, DrawItemEventArgs e)
        {

            combo = (ComboBox)sender;
            if (combo.Items.Count > 0 && e.Index >= 0)
            {

                e.DrawBackground();
                using (SolidBrush br = new SolidBrush(e.ForeColor))
                {
                    e.Graphics.DrawString(combo.GetItemText(combo.Items[e.Index]).ToString(), e.Font, br, e.Bounds);
                }

                if ((e.State & DrawItemState.Selected) == DrawItemState.Selected)
                {
                    if (combo.DroppedDown)
                    {
                        if (getWidthofListItems(combo.GetItemText(combo.Items[e.Index]).ToString(), combo) >= combo.DropDownWidth - 20)
                            this.tooltip_Billing.Show(combo.GetItemText(combo.Items[e.Index]), combo, e.Bounds.Right - 180, e.Bounds.Bottom);
                    }
                    else
                    {
                        this.tooltip_Billing.Hide(combo);
                    }
                }
                else
                {
                    this.tooltip_Billing.Hide(combo);
                }
                e.DrawFocusRectangle();
            }
        }

        //Function For Calculating the Lenghth of the Items in the combo box
        private int getWidthofListItems(string _text, ComboBox combo)
        {
            //Code Review Changes: Dispose Graphics object
            int width = 0;
            Graphics g = this.CreateGraphics();
            if (g != null)
            {
                SizeF s = g.MeasureString(_text, combo.Font);
                width = Convert.ToInt32(s.Width);
                //Dispose graphics object
                g.Dispose();
            }

            return width;
        }

        private int getWidthofListItems(string _text, Label label)
        {
            //Code Review Changes: Dispose Graphics object
            int width = 0;
            Graphics g = this.CreateGraphics();
            if (g != null)
            {
                SizeF s = g.MeasureString(_text, label.Font);
                width = Convert.ToInt32(s.Width);
                //Dispose graphics object
                g.Dispose();
            }

            return width;
        }

        #endregion

        #endregion " Form Controls Events "

        #region " Designer Events "

        private void btn_MouseHover(object sender, EventArgs e)
        {
            ((Button)sender).BackgroundImage = global::gloBilling.Properties.Resources.Img_LongYellow;
            ((Button)sender).BackgroundImageLayout = ImageLayout.Stretch;
        }

        private void btn_MouseLeave(object sender, EventArgs e)
        {
            ((Button)sender).BackgroundImage = global::gloBilling.Properties.Resources.Img_LongButton;
            ((Button)sender).BackgroundImageLayout = ImageLayout.Stretch;
        }

        private void btnShowInsurance_MouseHover(object sender, EventArgs e)
        {
            btnShowInsurance.BackgroundImage = global::gloBilling.Properties.Resources.UPHover;
            btnShowInsurance.BackgroundImageLayout = ImageLayout.Center;
        }

        private void btnHideInsurance_MouseHover(object sender, EventArgs e)
        {
            btnShowInsurance.BackgroundImage = global::gloBilling.Properties.Resources.UP;
            btnShowInsurance.BackgroundImageLayout = ImageLayout.Center;
        }

        private void btnHideInsurance_MouseLeave(object sender, EventArgs e)
        {
            btnShowInsurance.BackgroundImage = global::gloBilling.Properties.Resources.DownHover;
            btnShowInsurance.BackgroundImageLayout = ImageLayout.Center;
        }

        private void btnShowInsurance_MouseLeave(object sender, EventArgs e)
        {
            btnShowInsurance.BackgroundImage = global::gloBilling.Properties.Resources.Down;
            btnShowInsurance.BackgroundImageLayout = ImageLayout.Center;
        }

        private void btnShowDiagnosis_MouseHover(object sender, EventArgs e)
        {
            btnShowDiagnosis.BackgroundImage = global::gloBilling.Properties.Resources.UPHover;
            btnShowDiagnosis.BackgroundImageLayout = ImageLayout.Center;
        }

        private void btnShowDiagnosis_MouseLeave(object sender, EventArgs e)
        {
            btnShowDiagnosis.BackgroundImage = global::gloBilling.Properties.Resources.UP;
            btnShowDiagnosis.BackgroundImageLayout = ImageLayout.Center;

        }

        private void btnHideDiagnosis_MouseHover(object sender, EventArgs e)
        {
            btnHideDiagnosis.BackgroundImage = global::gloBilling.Properties.Resources.DownHover;
            btnHideDiagnosis.BackgroundImageLayout = ImageLayout.Center;
        }

        private void btnHideDiagnosis_MouseLeave(object sender, EventArgs e)
        {
            btnHideDiagnosis.BackgroundImage = global::gloBilling.Properties.Resources.Down;
            btnHideDiagnosis.BackgroundImageLayout = ImageLayout.Center;
        }

        #endregion

        #region " AlphaII Validation "

        private bool ValidateUsingAlphaII(string DxCode, DateTime DateOfService)
        {
            try
            {
                string ConnectionString = "";

                ConnectionString = GetAlphaIIConnectionString();
                if (ConnectionString != "")
                {
                    //AlphaII.CodeWizard.DataAccess.Common.ConnectionString = ConnectionString;
                    AlphaII.CodeWizard.Configuration.DatabaseConfiguration oDatabaseConfiguration = new AlphaII.CodeWizard.Configuration.DatabaseConfiguration();
                    oDatabaseConfiguration.MsSqlServer = _AlphaIIServerName;
                    oDatabaseConfiguration.MsSqlDatabase = _AlphaIIDatabase;
                    oDatabaseConfiguration.MsSqlUserId = _AlphaIIUserName;
                    oDatabaseConfiguration.MsSqlPassword = _AlphaIIPassword;
                    oDatabaseConfiguration.MsSqlPersistSecurity = false;
                    if (_AlphaIIAuthentication.ToUpper() == "WINDOWS")
                    {
                        oDatabaseConfiguration.MsSqlIntegratedSecurity = true;
                    }
                    else if (_AlphaIIAuthentication.ToUpper() == "SQL")
                    {
                        oDatabaseConfiguration.MsSqlIntegratedSecurity = false;
                    }
                    oDatabaseConfiguration.Save();
                    AlphaII.CodeWizard.Coding oCoding = new AlphaII.CodeWizard.Coding();
                    _IsAplhaIIValidated = oCoding.ValidateDiagnosisCode(DxCode.Trim(), DateOfService);
                    //_IsAplhaIIValidated = GetValidCode(DxCode.Trim(), DateOfService, out  _IsAplhaIIValidated);
                    string strDxDesc = oCoding.GetDiagnosisDescription(DxCode.Trim(), DateOfService, AlphaII.CodeWizard.Objects.DescriptionType.Long);

                }

            }
            catch (Exception ex)
            {
                gloAuditTrail.gloAuditTrail.ExceptionLog(ex, true);
                return true;
            }
            return _IsAplhaIIValidated;
        }

        private void AlphaIIDiagnosisValidation()
        {
            TransactionLines oTransactionLines = null;
            string _strMessage = "";
            string _strMessageFiller = "is";
            ArrayList arrDxCodes = new ArrayList();
            try
            {
                oTransactionLines = UC_gloBillingTransactionLines.GetLineTransactions();
                if (oTransactionLines != null && oTransactionLines.Count > 0)
                {
                    for (int i = 0; i <= oTransactionLines.Count - 1; i++)
                    {
                        if (oTransactionLines[i].Dx1Code.Trim() != "" || oTransactionLines[i].Dx2Code.Trim() != "" || oTransactionLines[i].Dx3Code.Trim() != "" || oTransactionLines[i].Dx4Code.Trim() != "")
                        {

                            if (oTransactionLines[i].Dx1Code.Trim() != "")
                            {
                                if (ValidateUsingAlphaII(oTransactionLines[i].Dx1Code, oTransactionLines[i].DateServiceFrom) == false)
                                {
                                    if (IsDiagnosisExist(_strMessage, oTransactionLines[i].Dx1Code.Trim()) == false)
                                    {
                                        _strMessage += " " + oTransactionLines[i].Dx1Code.Trim() + ",";
                                    }
                                }
                                arrDxCodes.Add(oTransactionLines[i].Dx1Code);
                            }
                            if (oTransactionLines[i].Dx2Code.Trim() != "")
                            {
                                if (ValidateUsingAlphaII(oTransactionLines[i].Dx2Code, oTransactionLines[i].DateServiceFrom) == false)
                                {
                                    if (IsDiagnosisExist(_strMessage, oTransactionLines[i].Dx2Code.Trim()) == false)
                                    {
                                        _strMessage += " " + oTransactionLines[i].Dx2Code.Trim() + ",";
                                    }
                                }
                                arrDxCodes.Add(oTransactionLines[i].Dx2Code);
                            }
                            if (oTransactionLines[i].Dx3Code.Trim() != "")
                            {
                                if (ValidateUsingAlphaII(oTransactionLines[i].Dx3Code, oTransactionLines[i].DateServiceFrom) == false)
                                {
                                    if (IsDiagnosisExist(_strMessage, oTransactionLines[i].Dx3Code.Trim()) == false)
                                    {
                                        _strMessage += " " + oTransactionLines[i].Dx3Code.Trim() + ",";
                                    }
                                }
                                arrDxCodes.Add(oTransactionLines[i].Dx3Code);
                            }
                            if (oTransactionLines[i].Dx4Code.Trim() != "")
                            {
                                if (ValidateUsingAlphaII(oTransactionLines[i].Dx4Code, oTransactionLines[i].DateServiceFrom) == false)
                                {
                                    if (IsDiagnosisExist(_strMessage, oTransactionLines[i].Dx4Code.Trim()) == false)
                                    {
                                        _strMessage += " " + oTransactionLines[i].Dx4Code.Trim() + ",";
                                    }
                                }
                                arrDxCodes.Add(oTransactionLines[i].Dx4Code);
                            }
                        }
                        else
                        {
                            MessageBox.Show("Please select atleast one diagnosis for line " + (i + 1).ToString() + ".  ", _messageBoxCaption, MessageBoxButtons.OK, MessageBoxIcon.Information);
                            return;
                        }

                        CheckValid_ICD_CPTAssociation(oTransactionLines[i].CPTCode, arrDxCodes, oTransactionLines[i].DateServiceFrom);
                    }
                    if (_strMessage.Trim() != "")
                    {
                        if (_strMessage.Trim().Length > 8)
                        {
                            _strMessageFiller = "";
                            _strMessageFiller = "are";
                        }
                        _strMessage = _strMessage.Substring(0, _strMessage.Length - 1);
                        MessageBox.Show("The Diagnosis code(s) " + _strMessage.Trim() + " " + _strMessageFiller + " not valid.  ", _messageBoxCaption, MessageBoxButtons.OK, MessageBoxIcon.Information);
                    }
                    else
                    {
                        MessageBox.Show("All diagnosis are valid.  ", _messageBoxCaption, MessageBoxButtons.OK, MessageBoxIcon.Information);
                    }

                }
            }
            catch (Exception ex)
            {
                gloAuditTrail.gloAuditTrail.ExceptionLog(ex, true);
            }
            finally
            {
                if (oTransactionLines != null)
                {
                    oTransactionLines.Clear();
                    oTransactionLines.Dispose();
                    oTransactionLines = null;
                }
            }
        }

        public static bool GetValidCode(string diagnosisCode, DateTime serviceDate, out bool notSpecific)
        {
            bool flag = false;
            notSpecific = false;
            if ((diagnosisCode != null) && (diagnosisCode.Length > 0))
            {
                SqlConnection connection = new SqlConnection(AlphaII.CodeWizard.DataAccess.Common.ConnectionString);
                SqlCommand command = new SqlCommand("GetDiagnosisValid", connection);
                command.CommandType = CommandType.StoredProcedure;
                command.Parameters.Add("@DiagCode", SqlDbType.VarChar, 9);
                command.Parameters.Add("@DateOfSvc", SqlDbType.SmallDateTime);
                command.Parameters.Add("@ReturnValue", SqlDbType.SmallInt);
                command.Parameters["@ReturnValue"].Direction = ParameterDirection.ReturnValue;
                try
                {
                    command.Parameters["@DiagCode"].Value = diagnosisCode;
                    command.Parameters["@DateOfSvc"].Value = serviceDate;
                    connection.Open();
                    command.ExecuteNonQuery();
                    int num = Convert.ToInt32(command.Parameters["@ReturnValue"].Value);
                    if (num == 0)
                    {
                        return true;
                    }
                    if (num != 0xbba)
                    {
                        return flag;
                    }
                    if ((diagnosisCode[0] == 'E') && (diagnosisCode.Length >= 4))
                    {
                        notSpecific = true;
                        return flag;
                    }
                    if (diagnosisCode.Length >= 3)
                    {
                        notSpecific = true;
                    }
                }
                catch (Exception ex)
                {
                    gloAuditTrail.gloAuditTrail.ExceptionLog(ex, false);
                }
                finally
                {
                    connection.Close();
                    if (command != null)
                    {
                        if (command.Parameters != null) { command.Parameters.Clear(); }
                        command.Dispose();
                        command = null;
                    }

                    connection.Dispose();
                }
            }
            return flag;
        }

        private void GetAlphaIISettings()
        {
            gloSettings.GeneralSettings ogloSettings = new gloSettings.GeneralSettings(_DatabaseConnectionString);
            object value = new object();
            try
            {
                ogloSettings.GetSetting("AlphaII SQL Server Name", out value);
                if (value != null && Convert.ToString(value).Trim() != "")
                {
                    _AlphaIIServerName = Convert.ToString(value.ToString());
                    value = null;
                }

                ogloSettings.GetSetting("AlphaII Database Name", out value);
                if (value != null && Convert.ToString(value).Trim() != "")
                {
                    _AlphaIIDatabase = Convert.ToString(value.ToString());
                    value = null;
                }

                ogloSettings.GetSetting("AlphaII Authentication", out value);
                if (value != null && Convert.ToString(value).Trim() != "")
                {
                    _AlphaIIAuthentication = Convert.ToString(value.ToString());
                    value = null;
                }
                ogloSettings.GetSetting("AlphaII User Name", out value);
                if (value != null && Convert.ToString(value).Trim() != "")
                {
                    _AlphaIIUserName = Convert.ToString(value.ToString());
                    value = null;
                }
                ogloSettings.GetSetting("AlphaII Password", out value);
                if (value != null && Convert.ToString(value).Trim() != "")
                {
                    _AlphaIIPassword = Convert.ToString(value.ToString());
                    value = null;
                }
                ogloSettings.GetSetting("ClaimValidationSetting", out value);
                if (value != null && Convert.ToString(value).Trim() != "")
                {
                    _AlphaIIValidation = Convert.ToString(value.ToString());
                    value = null;
                }
                ogloSettings.GetSetting("IsCheckInvalidICD9", out value);
                if (value != null && Convert.ToString(value) != "")
                {
                    _IsCheckInvalidICD9 = Convert.ToBoolean(value);
                    value = null;
                }
                ogloSettings.GetSetting("IsUseScrubber", out value);
                if (value != null && Convert.ToString(value) != "")
                {
                    _IsScrubber = Convert.ToBoolean(value);
                    value = null;
                }
                ogloSettings.GetSetting("ClaimValidationSetting", out value);
                if (value != null && Convert.ToString(value) != "")
                {
                    if (Convert.ToString(value) == "Alpha2")
                    {
                        _claimValidationService = ClaimValidationService.Alpha2;
                    }
                    else if (Convert.ToString(value) == "YOST")
                    {
                        _claimValidationService = ClaimValidationService.YOST;
                    }
                    else if (Convert.ToString(value) == "None")
                    {
                        _claimValidationService = ClaimValidationService.None;
                    }
                    value = null;
                }
            }
            catch (Exception ex)
            {
                gloAuditTrail.gloAuditTrail.ExceptionLog(ex, true);
            }
            finally
            {
                if (ogloSettings != null) { ogloSettings.Dispose(); }
                value = null;
            }
        }

        private string GetBatchName(Int64 nTransID, Int64 nTransMasterID)
        {
            gloDatabaseLayer.DBLayer oDB = new gloDatabaseLayer.DBLayer(_DatabaseConnectionString);
            DataTable _dtBatch = null;
            string sBatchName = "";
            try
            {

                oDB.Connect(false);
                string strQuery = "";
                _dtBatch = null;
                strQuery = "SELECT TB.sBatchName sBatchName FROM  BL_Transaction_Batch TB WITH (NOLOCK),BL_Transaction_Batch_DTL TBD WITH (NOLOCK) "
                            + " WHERE TB.nBatchID  = TBD.nBatchID"
                            + " AND TBD.nTransactionID = " + nTransID
                            + " AND TBD.nTransactionMasterID = " + nTransMasterID;

                oDB.Retrive_Query(strQuery, out _dtBatch);

                if (_dtBatch != null && _dtBatch.Rows.Count > 0)
                {
                    sBatchName = Convert.ToString(_dtBatch.Rows[0]["sBatchName"]);
                }

            }
            catch (Exception ex)
            {
                gloAuditTrail.gloAuditTrail.ExceptionLog(ex, true);

            }
            finally
            {
                oDB.Disconnect();
                oDB.Dispose();
            }
            return sBatchName;
        }

        private void PerformHoldInformation()
        {
            frmBillingHold ofrmBillingHold = null;
            string sResPartyStatus = "";

            try
            {
                sResPartyStatus = Convert.ToString(c1Insurance.GetData(Convert.ToInt16(nCurrentResponsibleParty), COL_INSVIEW_PARTYSTATUS));

                #region " Hold "

                ofrmBillingHold = new frmBillingHold(_DatabaseConnectionString, Convert.ToString(txtClaimNo.Text), _ClinicID, _UserID, _TransactionID, 0, _oClaimHold, sResPartyStatus);
                ofrmBillingHold.ShowDialog(this);

                if (ofrmBillingHold.oDialogResult)
                {
                    _oClaimHold = ofrmBillingHold._oClaimHold;
                    //**GetHoldMessage();
                    SetHoldnMoreClaimDataMesseges();
                    //gloAuditTrail.gloAuditTrail.CreateAuditLog(ActivityModule.Billing, ActivityCategory.SetupCharges, ActivityType.Add, "Hold ", ActivityOutCome.Success);
                }
                ofrmBillingHold.Dispose();

                #endregion
            }
            catch (Exception ex)
            {
                gloAuditTrail.gloAuditTrail.ExceptionLog(ex, true);
            }
        }

        private bool ValidateConnectionString()
        {
            Boolean _Result = false;
            try
            {
                string _connstring = "";

                if (_AlphaIIAuthentication.ToUpper() == "WINDOWS")
                {
                    //_connstring = "Server=" + _AlphaIIServerName + ";Database=" + _AlphaIIDatabase + ";Integrated Security=SSPI; Connection Timeout = 0";
                    _connstring = "Integrated Security=SSPI; Persist Security Info=False; Data Source=" + _AlphaIIServerName + "; Initial Catalog=" + _AlphaIIDatabase + "; Connection Timeout = 0";
                    //Integrated Security=SSPI;Persist Security Info=False;Initial Catalog=CodeWizard;Data Source=GLOINT
                }
                else
                {
                    //_connstring = "Server=" + _AlphaIIServerName + ";Database=" + _AlphaIIDatabase + ";Uid=" + _AlphaIIUserName + ";Pwd=" + _AlphaIIPassword + ";";
                    _connstring = "Persist Security Info=False;Data Source=" + _AlphaIIServerName + ";Initial Catalog=" + _AlphaIIDatabase + ";User ID=" + _AlphaIIUserName + ";Pwd=" + _AlphaIIPassword + ";";
                    // Persist Security Info=False;User ID=sa;Initial Catalog=CodeWizard;Data Source=GLOINT
                }

                SqlConnection _connection = new SqlConnection();
                _connection.ConnectionString = _connstring;
                _connection.Open();
                _connection.Close();
                _Result = true;
            }
            catch (Exception ex)
            {
                gloAuditTrail.gloAuditTrail.ExceptionLog(ex, false);
                _Result = false;
                if (_Result == false)
                {
                    MessageBox.Show("Connection can not established with given parameter, please verify AlphaII setting.  ", _messageBoxCaption, MessageBoxButtons.OK, MessageBoxIcon.Information);
                }
                //ex.ToString();
                //ex = null;
            }



            return _Result;
        }

        private string GetAlphaIIConnectionString()
        {
            string _connstring = "";
            try
            {
                if (_AlphaIIAuthentication.ToUpper() == "WINDOWS")
                {
                    if (_AlphaIIServerName != "" && _AlphaIIDatabase != "")
                    {
                        _connstring = "Integrated Security=SSPI; Persist Security Info=False; Data Source=" + _AlphaIIServerName + "; Initial Catalog=" + _AlphaIIDatabase + "; Connection Timeout = 0";
                        //Integrated Security=SSPI;Persist Security Info=False;Initial Catalog=CodeWizard;Data Source=GLOINT

                    }
                    else
                    {
                        return "";
                    }
                }
                else
                {
                    if (_AlphaIIServerName != "" && _AlphaIIDatabase != "" && _AlphaIIUserName != "")//&& _AlphaIIPassword != "")
                    {
                        _connstring = "Persist Security Info=False;Data Source=" + _AlphaIIServerName + ";Initial Catalog=" + _AlphaIIDatabase + ";User ID=" + _AlphaIIUserName + ";Pwd=" + _AlphaIIPassword + ";";
                        // Persist Security Info=False;User ID=sa;Initial Catalog=CodeWizard;Data Source=GLOINT
                    }
                    else
                    {
                        return "";
                    }
                }

            }
            catch (Exception ex)
            {
                MessageBox.Show(ex.ToString(), _messageBoxCaption, MessageBoxButtons.OK, MessageBoxIcon.Exclamation);
            }
            return _connstring;
        }

        private bool IsDiagnosisExist(string strMessage, string DxCode)
        {
            string[] strDxList = null;
            bool _IsExist = false;
            try
            {
                if (strMessage.Trim() != "")
                {
                    strDxList = strMessage.Trim().Split(',');
                    if (strDxList != null && strDxList.Length > 0)
                    {
                        for (int i = 0; i < strDxList.Length; i++)
                        {
                            if (strDxList[i].Trim().ToUpper() == DxCode.Trim().ToUpper())
                            {
                                _IsExist = true;
                                break;
                            }
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                gloAuditTrail.gloAuditTrail.ExceptionLog(ex, true);
            }
            return _IsExist;
        }

        private void CheckValid_ICD_CPTAssociation(string CPTCode, ArrayList DxCode, DateTime DOS)
        {
            try
            {
                AlphaII.CodeWizard.Coding oCoding = new AlphaII.CodeWizard.Coding();
                AlphaII.CodeWizard.Collections.EditCollection oEditCollection = new AlphaII.CodeWizard.Collections.EditCollection();
                AlphaII.CodeWizard.Objects.Edit oEdit = new AlphaII.CodeWizard.Objects.Edit();
                AlphaII.CodeWizard.Objects.Diagnosis oDiagnosis = new AlphaII.CodeWizard.Objects.Diagnosis();
                AlphaII.CodeWizard.Collections.DiagnosisCollection oDiagnosisCollection = new AlphaII.CodeWizard.Collections.DiagnosisCollection();
                if (DxCode != null && DxCode.Count > 0 && CPTCode.Trim() != "")
                {
                    for (int _Index = 0; _Index < DxCode.Count; _Index++)
                    {
                        oDiagnosis = new AlphaII.CodeWizard.Objects.Diagnosis(Convert.ToString(DxCode[_Index]).Trim());
                        oDiagnosisCollection.Add(oDiagnosis);
                    }
                    AlphaII.CodeWizard.Objects.Procedure _cpt = new AlphaII.CodeWizard.Objects.Procedure(DOS, CPTCode, null);
                    oEditCollection = oCoding.GetAllEdits();
                    if (oEditCollection != null && oEditCollection.Count > 0)
                    {
                        //oEdit = oCoding.GetCodingEdit();
                        StringBuilder _details = new StringBuilder();
                        for (int i = 0; i < oEditCollection.Count; i++)
                        {
                            _details = new StringBuilder();
                            // Build a details messgae.
                            _details.Append("Description = " + oEditCollection[i].Description + "\r\n");
                        }
                        txtMessages.Text += _details.ToString();
                    }
                }
                else
                {
                    return;
                }

            }
            catch (Exception ex)
            {
                gloAuditTrail.gloAuditTrail.ExceptionLog(ex, true);
            }
        }

        #endregion " AlphaII Validation "

        #region " Date Validation "

        private bool IsValidDate(object strDate)
        {
            bool Success;
            try
            {
                DateTime validatedDate;
                Success = DateTime.TryParseExact(strDate.ToString(), "MM/dd/yyyy", System.Globalization.DateTimeFormatInfo.InvariantInfo, System.Globalization.DateTimeStyles.None, out validatedDate);
                if (validatedDate != null && Success == true)
                {
                    if (validatedDate < DateTime.MaxValue && validatedDate >= Convert.ToDateTime("01/01/1900"))
                    {
                        Success = true;
                    }
                    else
                    {
                        Success = false;
                    }

                }
            }
            catch (FormatException e)
            {

                gloAuditTrail.gloAuditTrail.ExceptionLog(e, false);

                Success = false; // If this line is reached, an exception was thrown
                e.ToString();
                e = null;
            }
            return Success;
        }

        private void mskDate_Validating(object sender, CancelEventArgs e)
        {
            try
            {
                MaskedTextBox mskDate = (MaskedTextBox)sender;
                mskDate.TextMaskFormat = MaskFormat.ExcludePromptAndLiterals;
                string strDate = mskDate.Text;
                mskDate.TextMaskFormat = MaskFormat.IncludeLiterals;
                Int64 nPaymentCloseDate = 0;
                if (mskDate != null)
                {
                    if (strDate.Length > 0)
                    {
                        if (IsValidDate(mskDate.Text.Trim()) == false)
                        {
                            MessageBox.Show("Please enter a valid date.  ", _messageBoxCaption, MessageBoxButtons.OK, MessageBoxIcon.Information);
                            e.Cancel = true;
                        }
                        else if (mskClaimDate.MaskCompleted == true && ((MaskedTextBox)sender).Name == mskClaimDate.Name)
                        {
                            gloBilling ogloBilling = new gloBilling(_DatabaseConnectionString, "");

                            if (ogloBilling.IsDayClosed(Convert.ToDateTime(mskDate.Text)))
                            {
                                MessageBox.Show("Day is already closed. You cannot perform any transaction for this close date.  ", _messageBoxCaption, MessageBoxButtons.OK, MessageBoxIcon.Information);
                                e.Cancel = true;
                            }
                            else
                            {
                                if (ChkCloseDateWithPaymentDate(_InitialTransaction.TransactionMasterID, Convert.ToInt32(gloDateMaster.gloDate.DateAsNumber(mskDate.Text)), ref nPaymentCloseDate))
                                {

                                    if (IsValidDate(mskClaimDate.Text) == true)
                                    {
                                        #region " Set Close Date to addedd Line "
                                        if (UC_gloBillingTransactionLines != null)
                                        {
                                            if (UC_gloBillingTransactionLines.GetLinesCount() == 2)
                                            {
                                                if (Convert.ToString(UC_gloBillingTransactionLines.GetItem(UC_gloBillingTransactionLines.CurrentTransactionLine, COL_CPT_CODE)) == "")
                                                {
                                                    UC_gloBillingTransactionLines.SetServiceLineDate(UC_gloBillingTransactionLines.CurrentTransactionLine, Convert.ToDateTime(mskClaimDate.Text));
                                                }
                                            }
                                        }
                                        #endregion " Set Close Date to addedd Line "

                                        DataTable dtCases = null;
                                        DataTable dtCaseDiag = null;
                                        DataTable dtCasesIns = null;

                                        DateTime _dtCloseDate;
                                        if (mskClaimDate.Text != string.Empty)
                                        {
                                            mskClaimDate.TextMaskFormat = MaskFormat.IncludePromptAndLiterals;
                                            _dtCloseDate = Convert.ToDateTime(mskClaimDate.Text);
                                        }
                                        else
                                        {
                                            _dtCloseDate = DateTime.Now;
                                        }

                                        gloCharges.getSingleValidCase(_dtCloseDate, PatientID, out dtCases, out dtCaseDiag, out dtCasesIns);
                                        if (dtCases != null && dtCases.Rows.Count > 0)
                                        {
                                            this.PatientHasCases = true;
                                        }
                                        else
                                        {
                                            this.PatientHasCases = false;
                                        }

                                        CheckForPatientCases();

                                    }

                                }
                                else
                                {
                                    MessageBox.Show("Charge Close Date [" + mskClaimDate.Text + "] is not allowed. Charge Close Date cannot come after Payment Close Date [" + gloDateMaster.gloDate.DateAsDateString(nPaymentCloseDate) + "]", _messageBoxCaption, MessageBoxButtons.OK, MessageBoxIcon.Warning);
                                    e.Cancel = true;
                                    return;
                                }

                            }
                            ogloBilling.Dispose();
                        }
                    }
                    else if (((MaskedTextBox)sender).Name == mskClaimDate.Name)
                    {
                        #region " Set Close Date to addedd Line "
                        if (UC_gloBillingTransactionLines != null)
                        {
                            if (UC_gloBillingTransactionLines.GetLinesCount() == 2)
                            {
                                if (Convert.ToString(UC_gloBillingTransactionLines.GetItem(UC_gloBillingTransactionLines.CurrentTransactionLine, COL_CPT_CODE)) == "")
                                {
                                    UC_gloBillingTransactionLines.SetServiceLineDate(UC_gloBillingTransactionLines.CurrentTransactionLine, DateTime.Today);
                                }
                            }
                        }
                        #endregion " Set Close Date to addedd Line "

                        DataTable dtCases = null;
                        DataTable dtCaseDiag = null;
                        DataTable dtCasesIns = null;

                        DateTime _dtCloseDate;
                        if (mskClaimDate.Text != string.Empty)
                        {
                            mskClaimDate.TextMaskFormat = MaskFormat.IncludePromptAndLiterals;
                            _dtCloseDate = Convert.ToDateTime(mskClaimDate.Text);
                        }
                        else
                        {
                            _dtCloseDate = DateTime.Now;
                        }

                        gloCharges.getSingleValidCase(_dtCloseDate, PatientID, out dtCases, out dtCaseDiag, out dtCasesIns);
                        if (dtCases != null && dtCases.Rows.Count > 0)
                        {
                            this.PatientHasCases = true;
                        }
                        else
                        {
                            this.PatientHasCases = false;
                        }

                        CheckForPatientCases();
                    }


                }

            }
            catch (Exception)// ex)
            {
                MessageBox.Show("Please enter a valid date.  ", _messageBoxCaption, MessageBoxButtons.OK, MessageBoxIcon.Information);
                e.Cancel = true;
                //ex.ToString();
                //ex = null;
            }
        }

        private Boolean ChkCloseDateWithPaymentDate(Int64 nMasterTransID, Int32 strDate, ref Int64 nPaymentCloseDate)
        {
            gloDatabaseLayer.DBLayer oDB = new gloDatabaseLayer.DBLayer(_DatabaseConnectionString);
            string strQuery = "";
            DataTable dtCloseDate = null;
            Boolean bReturn = false;
            try
            {
                oDB.Connect(false);
                //strQuery = "SELECT ISNULL(MIN(nclosedate),0) as nCloseDate FROM BL_EOBPayment_dtl WITH (NOLOCK) WHERE nBillingTransactionID = " + nMasterTransID + " and ISNULL(bIsPaymentVoid,0) = 0 ";
                strQuery = "SELECT MIN(dtCloseDate) AS dtCloseDate FROM Debits WITH(NOLOCK) " +
                           "WHERE nBillingTransactionID = " + nMasterTransID + " AND (bIsPaymentVoid IS NULL OR bIsPaymentVoid = 0) ";

                oDB.Retrive_Query(strQuery, out dtCloseDate);

                if (dtCloseDate.Rows.Count > 0 && dtCloseDate != null)
                {
                    Int32 _nChargePaymentDate = 0;

                    if (dtCloseDate.Rows[0]["dtCloseDate"] != DBNull.Value && Convert.ToString(dtCloseDate.Rows[0]["dtCloseDate"]).Trim() != "")
                    { _nChargePaymentDate = gloDateMaster.gloDate.DateAsNumber(Convert.ToString(dtCloseDate.Rows[0]["dtCloseDate"])); }

                    if (strDate > _nChargePaymentDate && _nChargePaymentDate > 0)
                    {
                        nPaymentCloseDate = _nChargePaymentDate;
                        bReturn = false;
                    }
                    else
                    {
                        bReturn = true;
                    }
                }
            }
            catch (Exception Ex)
            {
                gloAuditTrail.gloAuditTrail.ExceptionLog(Ex, true);
            }
            finally
            {
                oDB.Disconnect();
                oDB.Dispose();
            }
            return bReturn;
        }

        private void mskDate_MouseClick(object sender, MouseEventArgs e)
        {

            ((MaskedTextBox)sender).TextMaskFormat = MaskFormat.ExcludePromptAndLiterals;
            if (((MaskedTextBox)sender).Text.Trim() == "")
            {
                ((MaskedTextBox)sender).SelectionStart = 0;
                ((MaskedTextBox)sender).SelectionLength = 0;
            }
        }

        #endregion " Date Validation "

        #region "WorkerComp Events"

        private void txt_WcAc_MouseHover(object sender, EventArgs e)
        {
            //System.Windows.Forms.ToolTip ToolTip1 = new System.Windows.Forms.ToolTip();
            //ToolTip1.SetToolTip(this.txt_WcAc, Convert.ToString(txt_WcAc.Tag));
            //System.Windows.Forms.ToolTip ToolTip1 = new System.Windows.Forms.ToolTip();
            if (!this.Focused)
            {
                if (CmbAccidentType.Text.Trim() == "Work")
                {
                    ToolTip1.SetToolTip(this.txt_WcAc, Convert.ToString(txt_WcAc.Tag));
                }
                else if (CmbAccidentType.Text.Trim() == "Auto")
                {
                    ToolTip1.SetToolTip(this.txt_WcAc, Convert.ToString(txt_WcAc.Tag));
                }
            }
        }


        private void btnModifyGlobalPeriod_Click(object sender, EventArgs e)
        {
            try
            {
                frmSetupModifyGlobalPeriod ofrmSetupGlobalPeriod = new frmSetupModifyGlobalPeriod(Convert.ToInt64(lblGlobalPeriodAlert.Tag));
                ofrmSetupGlobalPeriod.ShowDialog(this);
                ofrmSetupGlobalPeriod.Dispose();
                SetLastGlobalPeriods();
                CheckForEPSDTEnabled();
                IsAnesthesiaEnabled();
            }
            catch (Exception ex)
            {
                gloAuditTrail.gloAuditTrail.ExceptionLog(ex, true);
            }
        }

        #endregion

        #region "Check Whether the Claim Can be Edited Or Not"

        //To check whether the Claim is in Edit Mode or not  
        private void IsEditable(Transaction oTransaction)
        {

            gloBilling ogloBilling = new gloBilling(_DatabaseConnectionString, _emrdatabaseConnectionString);
            gloDatabaseLayer.DBLayer oDB = new gloDatabaseLayer.DBLayer(_DatabaseConnectionString);
            try
            {

                btnSelectChargeTry.Enabled = false;
                //cmbClaimCategory.Enabled = false;
                tls_btnAddLine.Enabled = false;
                tls_btnRemoveLine.Enabled = false;
                UC_gloBillingTransactionLines.LineAlteration = false;
                mnuItem_Apply.Visible = true;


                string _sNextAction = "";

                //Setting Current Responsible Party-- For 5060 To Set the Responsibilty to the current party after delete and add
                //Variable Used when we delete Ins party and again Add New Ins.
                Int64 _Party = 0;
                DataTable _dtParty = gloCharges.GetCurrentPartyNumber(_MasterTransactionID);

                if (_dtParty != null && _dtParty.Rows.Count > 0)
                {

                    _Party = Convert.ToInt64(_dtParty.Rows[0]["PartyNo"]);
                    _iDeletedParty = Convert.ToInt16(_Party);
                }




                //***********************Added and Commented by Debasish (From 5060)***************************************
                //if (oTransaction.Transaction_Status == TransactionStatus.InsurancePaid || oTransaction.IsResend == true)
                //*********************************************************************************************************
                if (oTransaction.Transaction_Status == TransactionStatus.InsurancePaid || oTransaction.Transaction_Status == TransactionStatus.None || oTransaction.Transaction_Status == TransactionStatus.Pending)
                {
                    #region " Insurance Paid "

                    if (IsValidDate(mskClaimDate.Text))
                    {
                        if (ogloBilling.IsDayClosed(Convert.ToDateTime(mskClaimDate.Text)))
                        {
                            DisableChargesEntry(true);
                            DisableControlsOnCloseDate();
                            _IsDayClosed = true;

                            BlockInsurancePartyNew(_sNextAction);
                            c1Insurance.AllowEditing = true;
                        }
                        else
                        {

                            DisableChargesEntry(false);
                            BlockInsurancePartyNew(_sNextAction);
                            UC_gloBillingTransactionLines.bAllowDragDrop = false;
                            UC_gloBillingTransactionLines.AutoSort = false;
                            cmbFacility.Enabled = false;
                            chkNonFacilityCharges.Enabled = false;
                            chkFacilityFeeSchedule.Enabled = false;

                            if (oTransaction.Transaction_Status == TransactionStatus.Pending || oTransaction.Transaction_Status == TransactionStatus.None)
                            {
                                mnuItem_Apply.Visible = true;
                            }
                            else
                            {
                                mnuItem_Apply.Visible = false;
                            }
                        }
                    }
                    #endregion

                }
                else
                {

                    #region "GetNextAction"

                    DataTable dtNextAction = gloCharges.GetNextAction(_MasterTransactionID);
                    if (dtNextAction != null && dtNextAction.Rows.Count > 0)
                    {
                        _sNextAction = Convert.ToString(dtNextAction.Rows[0]["sNextActionCode"]);
                    }

                    #endregion

                    //if ((oTransaction.ResponsibilityNo <= 1) && (oTransaction.Transaction_Status == TransactionStatus.Queue || oTransaction.Transaction_Status == TransactionStatus.Batch) && _sNextAction == "T")
                    if ((oTransaction.Transaction_Status == TransactionStatus.Queue || oTransaction.Transaction_Status == TransactionStatus.Batch || oTransaction.Transaction_Status == TransactionStatus.None) && _sNextAction == "T")
                    {
                        #region " Queue/Batch/Transacted "

                        #region " Check Day is Closed "

                        if (IsValidDate(mskClaimDate.Text))
                        {
                            if (ogloBilling.IsDayClosed(Convert.ToDateTime(mskClaimDate.Text)))
                            {
                                if (Convert.ToInt64(dtNextAction.Rows[0]["nNextPartyType"]) == PayerMode.Self.GetHashCode())
                                {
                                    DisableChargesEntry(false);
                                    mskClaimDate.Enabled = false;

                                    UC_gloBillingTransactionLines.bAllowDragDrop = false;
                                    UC_gloBillingTransactionLines.AutoSort = false;
                                    cmbFacility.Enabled = false;
                                    chkNonFacilityCharges.Enabled = false;
                                    chkFacilityFeeSchedule.Enabled = false;
                                    btnSelectChargeTry.Enabled = false;
                                    //cmbClaimCategory.Enabled = false;
                                    tls_btnAddLine.Enabled = false;
                                    tls_btnRemoveLine.Enabled = false;
                                    UC_gloBillingTransactionLines.LineAlteration = false;

                                }
                                else
                                {
                                    DisableChargesEntry(true);
                                    DisableControlsOnCloseDate();
                                    _IsDayClosed = true;

                                    BlockInsurancePartyNew(_sNextAction);
                                    c1Insurance.AllowEditing = true;
                                }
                            }
                            else
                            {
                                _IsDayClosed = false;

                                btnSelectChargeTry.Enabled = true;
                                //cmbClaimCategory.Enabled = true;
                                tls_btnAddLine.Enabled = true;
                                tls_btnRemoveLine.Enabled = true;
                                UC_gloBillingTransactionLines.LineAlteration = true;



                                #region "Check whether the Grid can be sorted or not"

                                string strQuery = "";
                                DataTable _dtsort;
                                oDB.Connect(false);
                                strQuery = "select isnull(bSorted,1) as bSorted FROM BL_Transaction_Claim_MST WITH (NOLOCK) WHERE nTransactionID= " + _TransactionID + "";
                                oDB.Retrive_Query(strQuery, out _dtsort);

                                if (_dtsort != null && _dtsort.Rows.Count > 0)
                                {
                                    if (_dtsort.Rows[0]["bSorted"] != null)
                                    {
                                        if (Convert.ToBoolean(_dtsort.Rows[0]["bSorted"]) == true)
                                        {
                                            UC_gloBillingTransactionLines.AutoSort = true;
                                        }
                                        else
                                        {
                                            UC_gloBillingTransactionLines.bAllowDragDrop = false;
                                            UC_gloBillingTransactionLines.AutoSort = false;
                                        }
                                    }
                                }

                                #endregion

                                #region "Commented Self Section "

                                #region " Self Claim "

                                #region "Check Whether a Payment is done for Self Claim"

                                oDB.Connect(false);
                                string _strQuery = "SELECT COUNT(nDebitID) FROM Debits WITH(NOLOCK) WHERE nBillingTransactionID = " + _MasterTransactionID + " AND nEntryType IN (6,9)";
                                //"select count(nEOBPaymentID) as nEOBPaymentID from  dbo.BL_EOBPayment_DTL WITH (NOLOCK) where nBillingTransactionID= " + _MasterTransactionID + " and nPaymentType IN (" + EOBPaymentType.PatientReserved.GetHashCode() + "," + EOBPaymentType.PatientPayment.GetHashCode() + "," + EOBPaymentType.PatientRefund.GetHashCode() + ")";
                                object _Result = oDB.ExecuteScalar_Query(_strQuery);
                                if (_Result.ToString() != "")
                                {
                                    // Specifies the Payment is done for that claim
                                    if (Convert.ToInt64(_Result) > 0)
                                    {
                                        tls_btnAddLine.Enabled = false;
                                        tls_btnRemoveLine.Enabled = false;
                                        UC_gloBillingTransactionLines.LineAlteration = false;

                                    }
                                    else if (_isClaimVoided)
                                    {
                                        pnlPatientInsurence.Enabled = false;
                                    }
                                    else
                                    {
                                        pnlPatientInsurence.Enabled = true;
                                    }
                                }
                                oDB.Disconnect();

                                #endregion


                                #endregion " Self Claim "

                                #endregion

                            }
                        }
                        #endregion " Check Day is Closed "


                        #endregion

                    }
                    else if (_sNextAction == "R" || _sNextAction == "B" || _sNextAction == "N")
                    {
                        //if (!ogloBilling.IsClaimSplitted(oTransaction))
                        if (!oTransaction.IsClaimSplitted)
                        {
                            #region "Rebill/Bill Next"

                            if (IsValidDate(mskClaimDate.Text))
                            {
                                if (ogloBilling.IsDayClosed(Convert.ToDateTime(mskClaimDate.Text)))
                                {
                                    DisableChargesEntry(true);
                                    DisableControlsOnCloseDate();
                                    _IsDayClosed = true;
                                    BlockInsurancePartyNew(_sNextAction);
                                    c1Insurance.AllowEditing = true;
                                }
                                else
                                {
                                    if (!_isClaimVoided) { DisableChargesEntry(false); }
                                    BlockInsurancePartyNew(_sNextAction);
                                    UC_gloBillingTransactionLines.bAllowDragDrop = false;
                                    UC_gloBillingTransactionLines.AutoSort = false;
                                    cmbFacility.Enabled = false;
                                    chkNonFacilityCharges.Enabled = false;
                                    chkFacilityFeeSchedule.Enabled = false;
                                }
                            }

                            #endregion
                        }
                        else
                        {
                            #region " Like Insurance Paid View"

                            if (IsValidDate(mskClaimDate.Text))
                            {
                                if (ogloBilling.IsDayClosed(Convert.ToDateTime(mskClaimDate.Text)))
                                {
                                    DisableChargesEntry(true);
                                    DisableControlsOnCloseDate();
                                    _IsDayClosed = true;

                                    BlockInsurancePartyNew(_sNextAction);
                                    c1Insurance.AllowEditing = true;
                                }
                                else
                                {

                                    DisableChargesEntry(false);
                                    BlockInsurancePartyNew(_sNextAction);
                                    //BlockMaxInsurancePartyNew(_sNextAction);
                                    UC_gloBillingTransactionLines.bAllowDragDrop = false;
                                    UC_gloBillingTransactionLines.AutoSort = false;
                                    cmbFacility.Enabled = false;
                                    chkNonFacilityCharges.Enabled = false;
                                    chkFacilityFeeSchedule.Enabled = false;

                                    if (oTransaction.Transaction_Status == TransactionStatus.Pending || oTransaction.Transaction_Status == TransactionStatus.None)
                                    {
                                        mnuItem_Apply.Visible = true;
                                    }
                                    else
                                    {
                                        mnuItem_Apply.Visible = false;
                                    }
                                }
                            }
                            #endregion
                        }
                    }
                    else if (_sNextAction == "T" && oTransaction.Transaction_Status == TransactionStatus.SendToClaimManager)
                    {
                        #region "SendToClaimManager"

                        #region " New Restriction Logic (From 5060) "

                        #region " Check Day is Closed "

                        if (IsValidDate(mskClaimDate.Text))
                        {
                            if (ogloBilling.IsDayClosed(Convert.ToDateTime(mskClaimDate.Text)))
                            {
                                if (Convert.ToInt64(dtNextAction.Rows[0]["nNextPartyType"]) == PayerMode.Self.GetHashCode())
                                {
                                    DisableChargesEntry(false);
                                    UC_gloBillingTransactionLines.bAllowDragDrop = false;
                                    UC_gloBillingTransactionLines.AutoSort = false;
                                    cmbFacility.Enabled = false;
                                    chkNonFacilityCharges.Enabled = false;
                                    chkFacilityFeeSchedule.Enabled = false;
                                    btnSelectChargeTry.Enabled = false;
                                    //cmbClaimCategory.Enabled = false;
                                    tls_btnAddLine.Enabled = false;
                                    tls_btnRemoveLine.Enabled = false;
                                    UC_gloBillingTransactionLines.LineAlteration = false;

                                }
                                else
                                {
                                    DisableChargesEntry(true);
                                    DisableControlsOnCloseDate();
                                    _IsDayClosed = true;

                                    BlockInsurancePartyNew(_sNextAction);
                                    c1Insurance.AllowEditing = true;
                                }
                            }
                            else
                            {
                                _IsDayClosed = false;

                                btnSelectChargeTry.Enabled = true;
                                //cmbClaimCategory.Enabled = true;
                                tls_btnAddLine.Enabled = true;
                                tls_btnRemoveLine.Enabled = true;
                                UC_gloBillingTransactionLines.LineAlteration = true;


                                if (_sNextAction == "T")
                                {
                                    //Code added on 20100302
                                    string strQuery = "";
                                    DataTable _dtsort;
                                    oDB.Connect(false);
                                    strQuery = "select isnull(bSorted,1) as bSorted FROM BL_Transaction_Claim_MST WITH (NOLOCK) WHERE nTransactionID= " + _TransactionID + "";
                                    oDB.Retrive_Query(strQuery, out _dtsort);



                                    if (_dtsort != null && _dtsort.Rows.Count > 0)
                                    {
                                        if (_dtsort.Rows[0]["bSorted"] != null)
                                        {
                                            if (Convert.ToBoolean(_dtsort.Rows[0]["bSorted"]) == true)
                                            {
                                                UC_gloBillingTransactionLines.AutoSort = true;
                                            }
                                            else
                                            {
                                                UC_gloBillingTransactionLines.bAllowDragDrop = false;
                                                UC_gloBillingTransactionLines.AutoSort = false;
                                            }
                                        }
                                    }
                                }
                                else
                                {
                                    #region "Check whether the Grid can be sorted or not"

                                    string strQuery = "";
                                    DataTable _dtsort;
                                    oDB.Connect(false);
                                    strQuery = "select isnull(bSorted,1) as bSorted FROM BL_Transaction_Claim_MST WITH (NOLOCK) WHERE nTransactionID= " + _TransactionID + "";
                                    oDB.Retrive_Query(strQuery, out _dtsort);

                                    #endregion

                                    if (_dtsort != null && _dtsort.Rows.Count > 0)
                                    {
                                        if (_dtsort.Rows[0]["bSorted"] != null)
                                        {
                                            if (Convert.ToBoolean(_dtsort.Rows[0]["bSorted"]) == true)
                                            {
                                                UC_gloBillingTransactionLines.AutoSort = true;
                                            }
                                            else
                                            {
                                                UC_gloBillingTransactionLines.bAllowDragDrop = false;
                                                UC_gloBillingTransactionLines.AutoSort = false;
                                            }
                                        }
                                    }
                                }

                                #region " Self Claim "

                                #region "Check Whether a Payment is done for Self Claim"

                                oDB.Connect(false);
                                //string _strQuery = "select count(nEOBPaymentID) as nEOBPaymentID from  dbo.BL_EOBPayment_DTL WITH (NOLOCK) where nBillingTransactionID= " + _MasterTransactionID + " and nPaymentType IN (" + EOBPaymentType.PatientReserved.GetHashCode() + "," + EOBPaymentType.PatientPayment.GetHashCode() + "," + EOBPaymentType.PatientRefund.GetHashCode() + ")";
                                string _strQuery = "SELECT COUNT(nDebitID) FROM Debits WITH(NOLOCK) WHERE nBillingTransactionID = " + _MasterTransactionID + " AND nEntryType IN (6,9)";
                                object _Result = oDB.ExecuteScalar_Query(_strQuery);
                                if (_Result.ToString() != "")
                                {
                                    // Specifies the Payment is done for that claim
                                    if (Convert.ToInt64(_Result) > 0)
                                    {
                                        tls_btnAddLine.Enabled = false;
                                        tls_btnRemoveLine.Enabled = false;
                                        UC_gloBillingTransactionLines.LineAlteration = false;
                                    }
                                    else if (_isClaimVoided)
                                    {
                                        pnlPatientInsurence.Enabled = false;
                                    }
                                    else
                                    {
                                        pnlPatientInsurence.Enabled = true;
                                    }
                                }
                                oDB.Disconnect();

                                #endregion

                                #endregion " Self Claim "

                            }
                        }
                        #endregion " Check Day is Closed "

                        #endregion

                        #endregion
                    }
                    else if (oTransaction.Transaction_Status == TransactionStatus.SendToClearingHouse)
                    {
                        #region "SendToClearingHouse"


                        #region " New Restriction Logic (From 5060) "

                        #region " Check Day is Closed "

                        if (IsValidDate(mskClaimDate.Text))
                        {
                            if (ogloBilling.IsDayClosed(Convert.ToDateTime(mskClaimDate.Text)))
                            {
                                if (Convert.ToInt64(dtNextAction.Rows[0]["nNextPartyType"]) == PayerMode.Self.GetHashCode())
                                {
                                    DisableChargesEntry(false);
                                    UC_gloBillingTransactionLines.bAllowDragDrop = false;
                                    UC_gloBillingTransactionLines.AutoSort = false;
                                    cmbFacility.Enabled = false;
                                    chkNonFacilityCharges.Enabled = false;
                                    chkFacilityFeeSchedule.Enabled = false;
                                    btnSelectChargeTry.Enabled = false;
                                    //cmbClaimCategory.Enabled = false;
                                    tls_btnAddLine.Enabled = false;
                                    tls_btnRemoveLine.Enabled = false;
                                    UC_gloBillingTransactionLines.LineAlteration = false;



                                }
                                else
                                {
                                    DisableChargesEntry(true);
                                    DisableControlsOnCloseDate();
                                    _IsDayClosed = true;

                                    BlockInsurancePartyNew(_sNextAction);
                                    c1Insurance.AllowEditing = true;
                                }
                            }
                            else
                            {
                                _IsDayClosed = false;

                                btnSelectChargeTry.Enabled = true;
                                //cmbClaimCategory.Enabled = true;
                                tls_btnAddLine.Enabled = true;
                                tls_btnRemoveLine.Enabled = true;
                                UC_gloBillingTransactionLines.LineAlteration = true;

                                if (_sNextAction == "T")
                                {
                                    //Code added on 20100302
                                    string strQuery = "";
                                    DataTable _dtsort;
                                    oDB.Connect(false);
                                    strQuery = "select isnull(bSorted,1) as bSorted FROM BL_Transaction_Claim_MST WITH (NOLOCK) WHERE nTransactionID= " + _TransactionID + "";
                                    oDB.Retrive_Query(strQuery, out _dtsort);



                                    if (_dtsort != null && _dtsort.Rows.Count > 0)
                                    {
                                        if (_dtsort.Rows[0]["bSorted"] != null)
                                        {
                                            if (Convert.ToBoolean(_dtsort.Rows[0]["bSorted"]) == true)
                                            {
                                                UC_gloBillingTransactionLines.AutoSort = true;
                                            }
                                            else
                                            {
                                                UC_gloBillingTransactionLines.bAllowDragDrop = false;
                                                UC_gloBillingTransactionLines.AutoSort = false;
                                            }
                                        }
                                    }
                                }
                                else
                                {
                                    #region "Check whether the Grid can be sorted or not"

                                    string strQuery = "";
                                    DataTable _dtsort;
                                    oDB.Connect(false);
                                    strQuery = "select isnull(bSorted,1) as bSorted FROM BL_Transaction_Claim_MST WITH (NOLOCK) WHERE nTransactionID= " + _TransactionID + "";
                                    oDB.Retrive_Query(strQuery, out _dtsort);

                                    #endregion

                                    if (_dtsort != null && _dtsort.Rows.Count > 0)
                                    {
                                        if (_dtsort.Rows[0]["bSorted"] != null)
                                        {
                                            if (Convert.ToBoolean(_dtsort.Rows[0]["bSorted"]) == true)
                                            {
                                                UC_gloBillingTransactionLines.AutoSort = true;
                                            }
                                            else
                                            {
                                                UC_gloBillingTransactionLines.bAllowDragDrop = false;
                                                UC_gloBillingTransactionLines.AutoSort = false;
                                            }
                                        }
                                    }
                                }

                                #region " Self Claim "


                                #region "Check Whether a Payment is done for Self Claim"

                                oDB.Connect(false);
                                //string _strQuery = "select count(nEOBPaymentID) as nEOBPaymentID from  dbo.BL_EOBPayment_DTL WITH (NOLOCK) where nBillingTransactionID= " + _MasterTransactionID + " and nPaymentType IN (" + EOBPaymentType.PatientReserved.GetHashCode() + "," + EOBPaymentType.PatientPayment.GetHashCode() + "," + EOBPaymentType.PatientRefund.GetHashCode() + ")";
                                string _strQuery = "SELECT COUNT(nDebitID) FROM Debits WITH(NOLOCK) WHERE nBillingTransactionID = " + _MasterTransactionID + " AND nEntryType IN (6,9)";
                                object _Result = oDB.ExecuteScalar_Query(_strQuery);
                                if (_Result.ToString() != "")
                                {
                                    // Specifies the Payment is done for that claim
                                    if (Convert.ToInt64(_Result) > 0)
                                    {
                                        tls_btnAddLine.Enabled = false;
                                        tls_btnRemoveLine.Enabled = false;
                                        UC_gloBillingTransactionLines.LineAlteration = false;
                                    }
                                    else if (_isClaimVoided)
                                    {
                                        pnlPatientInsurence.Enabled = false;
                                    }
                                    else
                                    {
                                        pnlPatientInsurence.Enabled = true;
                                    }
                                }
                                oDB.Disconnect();

                                #endregion

                                #endregion " Self Claim "

                            }
                        }
                        #endregion " Check Day is Closed "

                        #endregion

                        #endregion
                    }

                    if (oTransaction.IsVoid)
                    {
                        pnlPatientInsurence.Enabled = false;
                        tls_btnAddLine.Enabled = false;
                        tls_btnRemoveLine.Enabled = false;
                        if (bIsFollowUpEnabled)
                        {
                            tls_FollowUpActionDate.Enabled = false;
                            tsbClaimGenerateTemp.Enabled = false;
                        }
                        UC_gloBillingTransactionLines.LineAlteration = false;
                        if (!_IsFormLoading)
                        {
                            SetVoidViewMode();
                        }
                    }
                    else
                    {
                        pnlPatientInsurence.Enabled = true;
                    }

                }


                if (_OpenViewMode)
                {
                    DisableControlsonLockClaims();
                }
            }
            catch (Exception ex)
            {
                gloAuditTrail.gloAuditTrail.ExceptionLog(ex, true);
            }
            finally
            {
                if (ogloBilling != null)
                {
                    ogloBilling.Dispose();
                    ogloBilling = null;
                }
                if (oDB != null)
                {
                    oDB.Dispose();
                    oDB = null;
                }
            }
        }

        private void SetVoidViewMode()
        {
            try
            {
                DisableChargesEntry(true);
                UC_gloBillingTransactionLines.Enabled = false;
                InsParty = c1Insurance.Rows.Count;
                tls_btnAddLine.Enabled = false;
                tls_btnRemoveLine.Enabled = false;
                UC_gloBillingTransactionLines.LineAlteration = false;
                tls_btnVoidCharge.Enabled = false;
                btnSelectChargeTry.Enabled = false;
                cmbClaimCategory.Enabled = false;
                tlb_AddNotes.Enabled = true;
                tsb_Resend.Enabled = false;
                tls_SplitClaim.Enabled = false;
                cmbBillingProvider.Enabled = false;
                chk_SameasBillingProvider.Enabled = false;
                cmbReferralProvider.Enabled = false;
                cmbFacility.Enabled = false;
                tls_btnReplacementClaim.Visible = true;
                if (cmbReferralProvider.Enabled)
                {
                    cmbReferralProvider.DrawMode = DrawMode.OwnerDrawFixed;
                }
                else
                {
                    cmbReferralProvider.DrawMode = DrawMode.Normal;
                }

                lblHoldMessage.Visible = false;
                tls_Hold.Enabled = false;

                //Added by Debasish (5061)
                btnAdd_PriorAuthorization.Enabled = false;
                btnRemove_PriorAuthorization.Enabled = false;
                mnuItem_Apply.Visible = false;
                //**
                tls_ViewClaim.Enabled = false;

                btnPatientAppointments.Enabled = false;
                btnClearPatientAppointments.Enabled = false;
                tls_btnInsurancePayment.Enabled = false;
            }
            catch (Exception ex)
            {
                gloAuditTrail.gloAuditTrail.ExceptionLog(ex, false);
            }
        }
        private void SetViewModeForBadDebt()
        {
            try
            {
                // DisableChargesEntry(true);
                //  UC_gloBillingTransactionLines.Enabled = false;
                // InsParty = c1Insurance.Rows.Count;
                // tls_btnAddLine.Enabled = false;
                // tls_btnRemoveLine.Enabled = false;
                // UC_gloBillingTransactionLines.LineAlteration = false;
                tls_btnVoidCharge.Enabled = false;
                //  btnSelectChargeTry.Enabled = false;
                // cmbClaimCategory.Enabled = false;
                // tlb_AddNotes.Enabled = true;
                // tsb_Resend.Enabled = false;
                //tls_SplitClaim.Enabled = false;
                // cmbBillingProvider.Enabled = false;
                // chk_SameasBillingProvider.Enabled = false;
                //cmbReferralProvider.Enabled = false;
                // cmbFacility.Enabled = false;
                //tls_btnReplacementClaim.Visible = true;
                //if (cmbReferralProvider.Enabled)
                //{
                //    cmbReferralProvider.DrawMode = DrawMode.OwnerDrawFixed;
                //}
                //else
                //{
                //    cmbReferralProvider.DrawMode = DrawMode.Normal;
                //}

                // lblHoldMessage.Visible = false;
                // tls_Hold.Enabled = false;

                //Added by Debasish (5061)
                // btnAdd_PriorAuthorization.Enabled = false;
                // btnRemove_PriorAuthorization.Enabled = false;
                // mnuItem_Apply.Visible = false;
                //**
                tls_ViewClaim.Visible = false;
                tls_btnCopyClaim.Enabled = false;
                // tls_btnReplacementClaim.Enabled = false;
                // tls_Hold.Enabled = false;
                //tls_btnSaveNClose.Enabled = false;
                //tls_FollowUpActionDate.Enabled = false;
                //tsbClaimGenerateTemp.Enabled = false;
                //tls_Anesthesia.Enabled = false;
                //tls_btnMoreClaimData.Enabled = false;
                //tlb_AddNotes.Enabled = false;
                //tls_btnMoreChargeData.Enabled = false;
                //tlb_LoadExam.Enabled = false;

            }
            catch (Exception ex)
            {
                gloAuditTrail.gloAuditTrail.ExceptionLog(ex, false);
            }
        }
        private void DisableControlsOnCloseDate()
        {
            #region "Disable If Day is Closed"

            //if (bIsFollowUpEnabled)
            //{
            //    tls_FollowUpActionDate.Enabled = false;
            //    tsbClaimGenerateTemp.Enabled = false;
            //}

            //txtCases.Enabled = false;

            btnAdd_Cases.Enabled = false;
            btnRemove_Cases.Enabled = false;

            tlb_AddNotes.Enabled = true;
            tls_btnValidateProcedure.Visible = false;
            tls_btnSaveNClose.Visible = true;
            pnlTransactionLines.Enabled = true;
            //pnlInsurancePaymentGrid.Enabled = false;
            pnlTransactionMaster.Enabled = true;
            pnlTransactionOther1.Enabled = true;
            pnlTransactionOther2.Enabled = true;
            mskClaimDate.Enabled = false;

            cmbFacility.Enabled = false;
            //cmbFacility.BackColor = System.Drawing.Color.FromArgb(236, 233, 216);
            //cmbFacility.ForeColor = System.Drawing.Color.DarkGray;
            //cmbBillingProvider.Enabled = true;
            cmbBillingProvider.Enabled = false;
            btnSelectChargeTry.Enabled = false;
            cmbClaimCategory.Enabled = true;

            chkNonFacilityCharges.Enabled = false;
            chkFacilityFeeSchedule.Enabled = false;
            groupBox2.Enabled = false;

            chk_SameasBillingProvider.Enabled = true;
            cmbReferralProvider.Enabled = true;
            //btnAdd_Referral.Enabled = false;
            btnAdd_Referral.Enabled = true;


            //chkWorkersComp.Enabled = true;
            //chkAutoClaim.Enabled = true;
            //chkOther.Enabled = true;
            CmbAccidentType.Enabled = true;
            txt_WcAc.Enabled = true;
            cmbState.Enabled = true;
            cmbClaimNo.Enabled = true;
            chkOutSideLab.Enabled = true;
            txtOutSideLabCharges.Enabled = true;

            //tls_btnVoidCharge.Enabled = false;
            tls_btnVoidCharge.Enabled = true;

            mskOtherDate.Enabled = true;
            mskUnableFromDate.Enabled = true;
            mskUnableTillDate.Enabled = true;
            //_mskUnableFromDateEnabled_MoreClaimData = true;
            // _mskUnableTillDateEnabled_MoreClaimData = true;
            mskHospitaliztionFrom.Enabled = true;
            mskHospitaliztionTo.Enabled = true;
            mskInitTreatment.Enabled = true;
            mskAccidentDate.Enabled = true;
            mskInjuryDate.Enabled = true;
            mskOnsiteDate.Enabled = true;
            cmbBox14DateQualifier.Enabled = true;

            //Commented by Debasish (5061)
            //btnAdd_PriorAuthorization.Enabled = false;
            //btnRemove_PriorAuthorization.Enabled = false;
            //**
            tls_btnSaveNClose.Enabled = true;
            c1Insurance.AllowEditing = false;
            c1Dx.AllowEditing = false;
            UC_gloBillingTransactionLines.Enabled = true;
            UC_gloBillingTransactionLines.DisableChargeModification();
            pnlTransactionMasterInfo.Enabled = true;

            //Code added on 01032014 Sameer
            cmbProviderType.Enabled = true;
            cmbBox15DateQualifier.Enabled = true;
            mskBox15Date.Enabled = true;

            //this.c1Insurance.KeyUp -= new System.Windows.Forms.KeyEventHandler(this.c1Insurance_KeyUp);
            #endregion
        }

        private void DisableControlsonLockClaims()
        {

            #region  " Set Buttons "
            //txtCases.Enabled = false;
            btnAdd_Cases.Enabled = false;
            btnRemove_Cases.Enabled = false;
            tls_FollowUpActionDate.Visible = false;
            tsbClaimGenerateTemp.Visible = false;
            tlb_AddNotes.Visible = false;
            tls_btnValidateProcedure.Visible = false;
            tls_btnSaveNClose.Visible = false;

            DisableChargesEntry(true);

            UC_gloBillingTransactionLines.Enabled = false;
            pnlTransactionLines.Enabled = false;
            pnlTransactionOther1.Enabled = false;
            pnlTransactionOther2.Enabled = false;
            tls_btnAddLine.Enabled = false;
            tls_btnRemoveLine.Enabled = false;
            UC_gloBillingTransactionLines.LineAlteration = false;
            tls_btnVoidCharge.Enabled = false;
            tlb_AddNotes.Enabled = true;
            tsb_Resend.Enabled = false;
            tls_btnMoreChargeData.Enabled = false;
            tls_btnMoreClaimData.Enabled = false;
            tls_Anesthesia.Enabled = false;
            tlb_AddNotes.Visible = false;
            tls_btnValidateProcedure.Visible = false;
            tls_btnSaveNClose.Visible = false;
            tls_Hold.Enabled = false;
            tsbViewHistory.Enabled = false;
            cmbBillingProvider.Enabled = false;
            chk_SameasBillingProvider.Enabled = false;
            cmbReferralProvider.Enabled = false;
            cmbFacility.Enabled = false;

            btnSelectChargeTry.Enabled = false;
            cmbClaimCategory.Enabled = false;
            btnAdd_PriorAuthorization.Enabled = false;
            btnRemove_PriorAuthorization.Enabled = false;
            mnuItem_Apply.Visible = false;
            c1Insurance.Enabled = false;
            c1Dx.Enabled = false;
            tls_SplitClaim.Enabled = false;
            tls_btnValidateProcedure.Enabled = false;

            if (bIsFollowUpEnabled)
            {
                tls_FollowUpActionDate.Enabled = false;
                tsbClaimGenerateTemp.Enabled = false;
            }

            #endregion
        }

        #region " Disable the Controls when The claim is Closed"

        private void DisableChargesEntry(Boolean _isViewMode)
        {
            #region  " Set Buttons "
            if (_isViewMode == true)
            {
                tls_btnValidateProcedure.Visible = false;
                tlb_AddNotes.Enabled = false;
                tls_btnSaveNClose.Visible = true;
                tls_btnVoidCharge.Enabled = true;
                tls_btnSaveNClose.Enabled = false;

                pnlTransactionLines.Enabled = true;
                pnlTransactionMaster.Enabled = true;
                pnlTransactionOther1.Enabled = true;
                pnlTransactionOther2.Enabled = true;

                cmbFacility.Enabled = false;
                cmbBillingProvider.Enabled = false;
                cmbFacility.Enabled = false;
                cmbState.Enabled = false;
                cmbClaimNo.Enabled = false;
                cmbReferralProvider.Enabled = true;


                groupBox2.Enabled = false;

                btnSelectChargeTry.Enabled = false;
                cmbClaimCategory.Enabled = false;
                btnAdd_Referral.Enabled = false;


                chkNonFacilityCharges.Enabled = false;
                chkFacilityFeeSchedule.Enabled = false;
                chk_SameasBillingProvider.Enabled = true;
                //chkWorkersComp.Enabled = false;
                //chkAutoClaim.Enabled = false;
                //chkOther.Enabled = false;
                CmbAccidentType.Enabled = false;
                chkOutSideLab.Enabled = false;

                txtOutSideLabCharges.Enabled = false;
                txt_WcAc.Enabled = false;

                mskOtherDate.Enabled = false;
                mskUnableFromDate.Enabled = false;
                mskUnableTillDate.Enabled = false;
                //_mskUnableFromDateEnabled_MoreClaimData = false;
                //_mskUnableTillDateEnabled_MoreClaimData = false;
                mskHospitaliztionFrom.Enabled = false;
                mskInitTreatment.Enabled = false;
                mskHospitaliztionTo.Enabled = false;
                mskClaimDate.Enabled = false;
                mskAccidentDate.Enabled = false;
                mskInjuryDate.Enabled = false;
                mskOnsiteDate.Enabled = false;
                cmbBox14DateQualifier.Enabled = false;

                //txtCases.Enabled = false;
                btnAdd_Cases.Enabled = false;
                btnRemove_Cases.Enabled = false;

                c1Insurance.AllowEditing = false;
                c1Dx.AllowEditing = false;

                UC_gloBillingTransactionLines.DisableChargeModification();

                //Code added on 12242013 Sameer
                cmbProviderType.Enabled = false;
                cmbBox15DateQualifier.Enabled = false;
                mskBox15Date.Enabled = false;
            }
            else
            {
                if (!EPSDTEnabled)
                {
                    tlb_AddEPSDT.Visible = false;
                }
                else
                {
                    tlb_AddEPSDT.Visible = true;
                    tlb_AddEPSDT.Enabled = true;
                }
                tlb_AddNotes.Visible = true;
                tls_btnValidateProcedure.Visible = false;
                tls_btnSaveNClose.Visible = true;
                tls_btnSaveNClose.Enabled = true;

                pnlTransactionLines.Enabled = true;
                pnlTransactionMaster.Enabled = true;
                pnlTransactionOther1.Enabled = true;
                pnlTransactionOther2.Enabled = true;

                btnSelectChargeTry.Enabled = true;
                cmbClaimCategory.Enabled = true;

                cmbBillingProvider.Enabled = false;
                cmbFacility.Enabled = true;
                chkFacilityFeeSchedule.Enabled = true;
                chkNonFacilityCharges.Enabled = true;

                //txtCases.Enabled = false;
                //btnAdd_Cases.Enabled = false;
                //btnRemove_Cases.Enabled = false;

                groupBox2.Enabled = false;

                c1Insurance.AllowEditing = true;
                c1Dx.AllowEditing = false;
                UC_gloBillingTransactionLines.DisableChargeModification();
            }


            #endregion
        }

        #endregion

        #endregion

        #region "Block The Insurance Party Grid"

        private void BlockInsuranceParty(string _NextAction)
        {
            int _Party = 0;
            Int16 _CurrentParty = 0;
            DataTable _dtParty = gloCharges.GetCurrentPartyNumber(_MasterTransactionID);
            try
            {
                if (_dtParty != null && _dtParty.Rows.Count > 0)
                {
                    if (c1Insurance != null && c1Insurance.Rows.Count > 1)
                    {
                        for (int rIndex = 1; rIndex < c1Insurance.Rows.Count; rIndex++)
                        {
                            if (c1Insurance.GetData(rIndex, COL_INSURANCEPARTY) != null && Convert.ToString(c1Insurance.GetData(rIndex, COL_INSURANCEPARTY)).Trim() != "")
                            {

                                if (Int16.TryParse(c1Insurance.GetData(rIndex, COL_INSURANCERESPONSIBILITY).ToString(), out _CurrentParty) == true)
                                {
                                    _Party = Convert.ToInt32(_dtParty.Rows[0]["PartyNo"]);
                                    if (_NextAction == "R")
                                    {

                                    }
                                    if (_NextAction == "T" && _TransStatus == "SendToClaimManager")
                                    {

                                    }
                                    else
                                    {
                                        _Party = _Party - 1;
                                    }
                                    if (_CurrentParty <= Convert.ToInt32(_Party))
                                    {

                                        CellStyle csNonEdit;// = c1Insurance.Styles.Add("cs_NonEdit");
                                        try
                                        {
                                            if (c1Insurance.Styles.Contains("cs_NonEdit"))
                                            {
                                                csNonEdit = c1Insurance.Styles["cs_NonEdit"];
                                            }
                                            else
                                            {
                                                csNonEdit = c1Insurance.Styles.Add("cs_NonEdit");

                                            }

                                        }
                                        catch
                                        {
                                            csNonEdit = c1Insurance.Styles.Add("cs_NonEdit");

                                        }
                                        csNonEdit.BackColor = Color.White;
                                        c1Insurance.SetCellStyle(rIndex, COL_INSURANCEPARTY, csNonEdit);
                                        c1Insurance.Rows[rIndex].AllowEditing = false;
                                        InsParty = _Party;
                                        nCurrentResponsibleParty = _Party;
                                        ChangeInsuranceGridColor();
                                        break;

                                    }
                                }
                            }
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                gloAuditTrail.gloAuditTrail.ExceptionLog(ex, false);
            }
        }

        //Modified by Pramod Nair For Split Claims -- Block the Isurance Party to the max of the Party no
        private void BlockInsurancePartyNew(string _NextAction)
        {
            Int32 _Party = 0;
            Int16 _CurrentParty = 0;
            DataTable _dtParty = gloCharges.GetCurrentPartyNumber(_MasterTransactionID);

            try
            {
                //DataTable _dtParty = GetCurrentPartyNumber(_TransactionID);
                if (_dtParty != null && _dtParty.Rows.Count > 0)
                {
                    if (c1Insurance != null && c1Insurance.Rows.Count > 1)
                    {
                        for (int rIndex = 1; rIndex < c1Insurance.Rows.Count; rIndex++)
                        {
                            if (c1Insurance.GetData(rIndex, COL_INSURANCEPARTY) != null && Convert.ToString(c1Insurance.GetData(rIndex, COL_INSURANCEPARTY)).Trim() != "")
                            {

                                if (Int16.TryParse(c1Insurance.GetData(rIndex, COL_INSURANCERESPONSIBILITY).ToString(), out _CurrentParty) == true)
                                {
                                    c1Insurance.Rows[rIndex].AllowEditing = true;
                                    _Party = Convert.ToInt32(_dtParty.Rows[0]["PartyNo"]);
                                    InsParty = _Party;


                                    if (gloBilling.ChkPaymentAgainstInsV3(_dtEOBPayments, Convert.ToInt64(c1Insurance.GetData(rIndex, COL_INSURANCECONTACTID)), Convert.ToInt64(c1Insurance.GetData(rIndex, COL_INSURANCEID))))
                                    {
                                        CellStyle csNonEdit;// = c1Insurance.Styles.Add("cs_NonEdit");
                                        try
                                        {
                                            if (c1Insurance.Styles.Contains("cs_NonEdit"))
                                            {
                                                csNonEdit = c1Insurance.Styles["cs_NonEdit"];
                                            }
                                            else
                                            {
                                                csNonEdit = c1Insurance.Styles.Add("cs_NonEdit");

                                            }

                                        }
                                        catch
                                        {
                                            csNonEdit = c1Insurance.Styles.Add("cs_NonEdit");

                                        }
                                        csNonEdit.BackColor = Color.White;
                                        c1Insurance.SetCellStyle(rIndex, COL_INSURANCEPARTY, csNonEdit);
                                        c1Insurance.Rows[rIndex].AllowEditing = false;
                                        ChangeInsuranceGridColor();
                                        //break; 
                                    }
                                    //// if selected Insurance is Responsible for other split claims.
                                    //else if (gloBilling.IsExistInNextaction(_dtEOBNextAction, Convert.ToInt64(c1Insurance.GetData(rIndex, COL_INSURANCECONTACTID)), Convert.ToInt64(c1Insurance.GetData(rIndex, COL_INSURANCEID)),_TransactionID))
                                    //{
                                    //    CellStyle csNonEdit = c1Insurance.Styles.Add("cs_NonEdit");
                                    //    csNonEdit.BackColor = Color.White;
                                    //    c1Insurance.SetCellStyle(rIndex, COL_INSURANCEPARTY, csNonEdit);
                                    //    c1Insurance.Rows[rIndex].AllowEditing = false;
                                    //    ChangeInsuranceGridColor();
                                    //}

                                    //}
                                }
                            }
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                gloAuditTrail.gloAuditTrail.ExceptionLog(ex, false);
            }
        }

        //Modified by Pramod Nair For Split Claims -- Block the Isurance Party to the max of the Party no
        private void BlockMaxInsurancePartyNew(string _NextAction)
        {
            Int32 _Party = 0;
            Int16 _CurrentParty = 0;
            DataTable _dtParty = gloCharges.GetCurrentPartyNumber(_MasterTransactionID);

            try
            {
                //DataTable _dtParty = GetCurrentPartyNumber(_TransactionID);
                if (_dtParty != null && _dtParty.Rows.Count > 0)
                {
                    if (c1Insurance != null && c1Insurance.Rows.Count > 1)
                    {
                        for (int rIndex = 1; rIndex < c1Insurance.Rows.Count; rIndex++)
                        {
                            if (c1Insurance.GetData(rIndex, COL_INSURANCEPARTY) != null && Convert.ToString(c1Insurance.GetData(rIndex, COL_INSURANCEPARTY)).Trim() != "")
                            {

                                if (Int16.TryParse(c1Insurance.GetData(rIndex, COL_INSURANCERESPONSIBILITY).ToString(), out _CurrentParty) == true)
                                {
                                    c1Insurance.Rows[rIndex].AllowEditing = true;
                                    _Party = Convert.ToInt32(_dtParty.Compute("MAX(PartyNo)", ""));

                                    InsParty = _Party;


                                    nCurrentResponsibleParty = _Party;
                                    if (_CurrentParty <= Convert.ToInt32(_Party))
                                    {
                                        CellStyle csNonEdit;// = c1Insurance.Styles.Add("cs_NonEdit");
                                        try
                                        {
                                            if (c1Insurance.Styles.Contains("cs_NonEdit"))
                                            {
                                                csNonEdit = c1Insurance.Styles["cs_NonEdit"];
                                            }
                                            else
                                            {
                                                csNonEdit = c1Insurance.Styles.Add("cs_NonEdit");

                                            }

                                        }
                                        catch
                                        {
                                            csNonEdit = c1Insurance.Styles.Add("cs_NonEdit");

                                        }
                                        csNonEdit.BackColor = Color.White;
                                        c1Insurance.SetCellStyle(rIndex, COL_INSURANCEPARTY, csNonEdit);
                                        c1Insurance.Rows[rIndex].AllowEditing = false;
                                        ChangeInsuranceGridColor();


                                    }
                                }
                            }
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                gloAuditTrail.gloAuditTrail.ExceptionLog(ex, false);
            }
        }

        #endregion

        #region "Responsibility Transfer "

        private void mnuItem_Apply_Click(object sender, EventArgs e)
        {
            gloBilling ogloBilling = new gloBilling(_DatabaseConnectionString, _emrdatabaseConnectionString);
            Transaction _Transaction = new Transaction();

            try
            {
                for (int icount = 1; icount <= c1Insurance.Rows.Count - 1; icount++)
                {
                    if (c1Insurance.GetCellCheck(icount, COL_SELECT_CURRENT_RESPONSIBLE_PARTY) == CheckEnum.Checked)
                    {
                        getInsurancePlanCorrectRplmnt(Convert.ToInt64(c1Insurance.GetData(icount, COL_INSURANCECONTACTID)));
                    }
                    if (icount == 1 && _nResponsibleParty == 0)
                        UC_gloBillingTransactionLines.IsPrimarySelfPay = true;

                }
                Boolean _Result = true;
                if ((_IsbCliamReplacement || _InitialTransaction.IsRebill) && (_bIsPlanCorrectRplmnt))
                {
                    DialogResult oDialogueRespTrans = DialogResult.None;
                    oDialogueRespTrans = MessageBox.Show("Transferring to new party while claim is marked as Corrected/Replacement. Do you want to Continue? ", _messageBoxCaption, MessageBoxButtons.YesNo, MessageBoxIcon.Warning, MessageBoxDefaultButton.Button2);
                    if (oDialogueRespTrans == DialogResult.No)
                    {
                        _Result = false;
                    }

                }
                if (_Result)
                {
                    c1Insurance_BeforeEdit(null, null);
                    //_bIsRightClicked = true;
                    _iCurrentResponsiblePosition = c1Insurance.RowSel;
                    _iDeletedParty = c1Insurance.RowSel;
                    for (int icount = 1; icount <= c1Insurance.Rows.Count - 1; icount++)
                    {
                        c1Insurance.SetCellCheck(icount, COL_SELECT_CURRENT_RESPONSIBLE_PARTY, CheckEnum.Unchecked);
                    }
                    for (int iCount = 1; iCount <= c1Insurance.Rows.Count - 1; iCount++)
                    {
                        c1Insurance.SetData(iCount, COL_INSVIEW_PARTYSTATUS, "");
                        c1Insurance.SetData(iCount, COL_INS_INTERNAL_PARTYSTATUS, "");
                    }

                    c1Insurance.SetCellCheck(c1Insurance.RowSel, COL_SELECT_CURRENT_RESPONSIBLE_PARTY, CheckEnum.Checked);

                    c1Insurance.SetData(c1Insurance.RowSel, COL_INS_INTERNAL_PARTYSTATUS, PartyNo);

                    if (c1Insurance.GetData(c1Insurance.RowSel, COL_INSURANCENAME).ToString().ToLower() != "self")
                    {
                        c1Insurance.SetData(c1Insurance.RowSel, COL_INSVIEW_PARTYSTATUS, PartyNo);
                    }

                    for (int icount = 1; icount <= c1Insurance.Rows.Count - 1; icount++)
                    {
                        if (c1Insurance.GetCellCheck(icount, COL_SELECT_CURRENT_RESPONSIBLE_PARTY) == CheckEnum.Checked)
                        {
                            System.Drawing.Image imgFlagResp = global::gloBilling.Properties.Resources.Normal_Priority;
                            c1Insurance.SetCellImage(icount, COL_INSURANCERESPONSIBILITY, imgFlagResp);
                            string StrClaimRefNum = "";
                            //if (gloInsurancePaymentV2.IsRebilled(_MasterTransactionID, _TransactionID, Convert.ToInt64(c1Insurance.GetData(icount, COL_INSURANCEID)), Convert.ToInt64(c1Insurance.GetData(icount, COL_INSURANCECONTACTID))))
                            //{
                            StrClaimRefNum = Convert.ToString(getClaimRefNo(_MasterTransactionID, Convert.ToInt64(c1Insurance.GetData(icount, COL_INSURANCEID)), Convert.ToInt64(c1Insurance.GetData(icount, COL_INSURANCECONTACTID)), _ClinicID));
                            _sClaimRefNo = StrClaimRefNum;
                            //    _IsbCliamReplacement = true;
                            //}
                            //else
                            //{
                            //    _sClaimRefNo = string.Empty;
                            //    _IsbCliamReplacement = false;
                            //}
                        }
                        else
                        {
                            c1Insurance.SetCellImage(icount, COL_INSURANCERESPONSIBILITY, null);
                        }
                    }

                    #region "Checking for Responsibility Changed or not for Expanded Claim Settings."

                    int _nResponsibleRow = 0;
                    for (int i = 1; i <= c1Insurance.Rows.Count - 1; i++)
                    {
                        if (c1Insurance.GetCellCheck(i, COL_SELECT_CURRENT_RESPONSIBLE_PARTY) == CheckEnum.Checked)
                        {
                            _nResponsibleRow = i;
                            break;
                        }
                    }

                    if (_nResponsibleParty != Convert.ToInt64(c1Insurance.GetData(_nResponsibleRow, COL_INSURANCECONTACTID)))
                    {
                        #region " Expanded Claim Settings "

                        Int32 _NoOfMaxServiceLines_old = 0;
                        Int64 _ContactId = 0;
                        int _currentResponsibleRow = 0;

                        for (int i = 1; i <= c1Insurance.Rows.Count - 1; i++)
                        {
                            if (c1Insurance.GetCellCheck(i, COL_SELECT_CURRENT_RESPONSIBLE_PARTY) == CheckEnum.Checked)
                            {
                                _ContactId = Convert.ToInt64(c1Insurance.GetData(i, COL_INSURANCECONTACTID));
                                _currentResponsibleRow = i;
                                break;
                            }
                        }

                        _NoOfMaxServiceLines_old = _NoOfMaxServiceLines;
                        ogloBilling.GetExpandedClaimSetting(_ContactId, _ClinicID, out _NoOfMaxServiceLines, out _NoOfMaxDiagnosis);

                        int _cntr = 0;

                        ArrayList arrDX = UC_gloBillingTransactionLines.GetUniqueDx();
                        if (arrDX != null)
                        {
                            _cntr = arrDX.Count;
                        }

                        if (UC_gloBillingTransactionLines.GetLinesCount() - 1 > _NoOfMaxServiceLines && _cntr > _NoOfMaxDiagnosis)
                        {
                            MessageBox.Show(" Claim has a max limit of " + _NoOfMaxServiceLines + " service lines and " + _NoOfMaxDiagnosis + " diagnosis. ", _messageBoxCaption, MessageBoxButtons.OK, MessageBoxIcon.Warning);
                        }
                        else if (UC_gloBillingTransactionLines.GetLinesCount() - 1 > _NoOfMaxServiceLines)
                        {
                            MessageBox.Show(" Claim has a max limit of " + _NoOfMaxServiceLines + " service lines. ", _messageBoxCaption, MessageBoxButtons.OK, MessageBoxIcon.Warning);
                        }
                        else if (_cntr > _NoOfMaxDiagnosis)
                        {
                            MessageBox.Show(" Claim has a max limit of " + _NoOfMaxDiagnosis + " diagnosis. ", _messageBoxCaption, MessageBoxButtons.OK, MessageBoxIcon.Information);
                        }
                        _Transaction.NoOfServiceLine = _NoOfMaxServiceLines;
                        _Transaction.NoOfDiagnosis = _NoOfMaxDiagnosis;
                        UC_gloBillingTransactionLines._NoOfDiagnosis = _NoOfMaxDiagnosis;
                        UC_gloBillingTransactionLines._NoOfServiceLines = _NoOfMaxServiceLines;

                        #endregion

                        ShowHideUB();
                    }

                    #endregion

                }
                c1Insurance_KeyPress(null, null);                               
            }
            catch (Exception ex)
            {

                gloAuditTrail.gloAuditTrail.ExceptionLog(ex, true);
            }
            finally
            {
                //**GetHoldMessage();
                SetHoldnMoreClaimDataMesseges();
                //CheckForEPSDTEnabled();      
                if (_Transaction != null) { _Transaction.Dispose(); }
                if (ogloBilling != null) { ogloBilling.Dispose(); }
            }

        }

        private void ResponsibilityTransfer()
        {
            try
            {
                Boolean isChanged = false;
                Int32 _currRow = 0;
                Int64 iCurrentResContactID = 0;
                Int64 iCurrentResInsID = 0;
                for (int i = 0; i <= dtC1Insurance.Rows.Count - 1; i++)
                {

                    if (dtC1Insurance.Rows[i][COL_SELECT_CURRENT_RESPONSIBLE_PARTY] != null && dtC1Insurance.Rows[i][COL_SELECT_CURRENT_RESPONSIBLE_PARTY].ToString() != "")
                    {
                        if (Convert.ToBoolean(dtC1Insurance.Rows[i][COL_SELECT_CURRENT_RESPONSIBLE_PARTY]) != false)
                        {
                            if (Convert.ToString(dtC1Insurance.Rows[i][COL_INSURANCERESPONSIBILITY]).Replace("\0", "") != "")
                            {
                                iCurrentResContactID = Convert.ToInt64(dtC1Insurance.Rows[i][COL_INSURANCECONTACTID]);
                                iCurrentResInsID = Convert.ToInt64(dtC1Insurance.Rows[i][COL_INSURANCEID]);
                            }
                        }
                    }
                }
                for (int _iRespcount = 1; _iRespcount <= c1Insurance.Rows.Count - 1; _iRespcount++)
                {
                    if (c1Insurance.GetCellCheck(_iRespcount, COL_SELECT_CURRENT_RESPONSIBLE_PARTY) == CheckEnum.Checked)
                    {
                        _currRow = _iRespcount;

                        if (iCurrentResContactID != 0 && iCurrentResInsID != 0)
                        {
                            if (iCurrentResContactID == Convert.ToInt64(c1Insurance.GetData(_currRow, COL_INSURANCECONTACTID)) && iCurrentResInsID == Convert.ToInt64(c1Insurance.GetData(_currRow, COL_INSURANCEID)))
                            {

                                isChanged = false;
                            }
                            else
                            {
                                isChanged = true;
                            }
                        }
                    }

                }

                getInsurancePlanCorrectRplmnt(iCurrentResContactID);                               
                
                if (isChanged)
                {
                    Boolean _Result = true;

                    if ((_IsbCliamReplacement || _InitialTransaction.IsRebill) && (_bIsPlanCorrectRplmnt))
                    {
                        DialogResult oDialogueRespTrans = DialogResult.None;
                        oDialogueRespTrans = MessageBox.Show("Transferring to new party while claim is marked as Corrected/Replacement. Do you want to Continue? ", _messageBoxCaption, MessageBoxButtons.YesNo, MessageBoxIcon.Warning, MessageBoxDefaultButton.Button2);
                        if (oDialogueRespTrans == DialogResult.No)
                        {
                            //_bIsResult = false;
                            _Result = false;
                        }
                    }

                    if (!_Result)
                    {
                        if (dtC1Insurance != null)
                        {

                            for (int iCount = 1; iCount <= c1Insurance.Rows.Count - 1; iCount++)
                            {
                                c1Insurance.SetData(iCount, COL_INSVIEW_PARTYSTATUS, "");
                                c1Insurance.SetData(iCount, COL_INS_INTERNAL_PARTYSTATUS, "");
                                c1Insurance.SetCellCheck(iCount, COL_SELECT_CURRENT_RESPONSIBLE_PARTY, CheckEnum.Unchecked);
                            }

                            //c1Insurance.CellChanged -= new C1.Win.C1FlexGrid.RowColEventHandler(this.c1Insurance_CellChanged);

                            for (int iCount1 = 1; iCount1 <= c1Insurance.Rows.Count - 1; iCount1++)
                            {
                                for (int iCount = 0; iCount <= dtC1Insurance.Rows.Count - 1; iCount++)
                                {
                                    if ((c1Insurance.GetData(iCount1, COL_INSURANCEID).ToString() == Convert.ToString(dtC1Insurance.Rows[iCount]["InsuranceID"])) && (c1Insurance.GetData(iCount1, COL_INSURANCECONTACTID).ToString() == Convert.ToString(dtC1Insurance.Rows[iCount][COL_INSURANCECONTACTID])))
                                    {
                                        if (Convert.ToString(dtC1Insurance.Rows[iCount][COL_INSURANCERESPONSIBILITY]).Replace("\0", "") != "")
                                        {

                                            _bIsResult = false;
                                            c1Insurance.SetData(iCount1, COL_INSURANCERESPONSIBILITY, dtC1Insurance.Rows[iCount]["Party"]);
                                        }
                                        else
                                        {
                                            c1Insurance.SetData(iCount1, COL_INSURANCERESPONSIBILITY, 0);
                                        }
                                        if (dtC1Insurance.Rows[iCount][COL_SELECT_CURRENT_RESPONSIBLE_PARTY] != null && dtC1Insurance.Rows[iCount][COL_SELECT_CURRENT_RESPONSIBLE_PARTY].ToString() != "")
                                        {
                                            if (Convert.ToBoolean(dtC1Insurance.Rows[iCount][COL_SELECT_CURRENT_RESPONSIBLE_PARTY]))
                                            {
                                                c1Insurance.SetCellCheck(iCount1, COL_SELECT_CURRENT_RESPONSIBLE_PARTY, CheckEnum.Checked);

                                                c1Insurance.SetData(iCount1, COL_INS_INTERNAL_PARTYSTATUS, PartyNo);
                                                if (c1Insurance.GetData(iCount1, COL_INSURANCENAME).ToString().ToLower() != "self")
                                                {
                                                    c1Insurance.SetData(iCount1, COL_INSVIEW_PARTYSTATUS, PartyNo);
                                                }
                                            }
                                        }
                                        else
                                        {
                                            c1Insurance.SetCellCheck(iCount1, COL_SELECT_CURRENT_RESPONSIBLE_PARTY, CheckEnum.Unchecked);
                                        }


                                    }
                                }
                            }

                            //c1Insurance.CellChanged += new C1.Win.C1FlexGrid.RowColEventHandler(this.c1Insurance_CellChanged);
                            ReorderInsurance();
                            int iCurrentRow = 0;
                            for (int _iRespcount = 1; _iRespcount <= c1Insurance.Rows.Count - 1; _iRespcount++)
                            {
                                if (c1Insurance.GetCellCheck(_iRespcount, COL_SELECT_CURRENT_RESPONSIBLE_PARTY) == CheckEnum.Checked)
                                {
                                    System.Drawing.Image imgFlagResp = global::gloBilling.Properties.Resources.Normal_Priority;
                                    c1Insurance.SetCellImage(_iRespcount, COL_INSURANCERESPONSIBILITY, imgFlagResp);
                                    iCurrentRow = _iRespcount;
                                }
                                else
                                {
                                    c1Insurance.SetCellImage(_iRespcount, COL_INSURANCERESPONSIBILITY, null);
                                }
                            }
                            getInsurancePlanCorrectRplmnt(Convert.ToInt64(c1Insurance.GetData(iCurrentRow, COL_INSURANCECONTACTID)));
                        }

                    }
                }
                //_iDelCount = 0;
                // Check whether the current responsible party has claim Ref. No. or not
                for (int _iRespcount = 1; _iRespcount <= c1Insurance.Rows.Count - 1; _iRespcount++)
                {
                    if (c1Insurance.GetCellCheck(_iRespcount, COL_SELECT_CURRENT_RESPONSIBLE_PARTY) == CheckEnum.Checked)
                    {
                        string StrClaimRefNum = "";
                        //if (gloInsurancePaymentV2.IsRebilled(_MasterTransactionID, _TransactionID, Convert.ToInt64(c1Insurance.GetData(_iRespcount, COL_INSURANCEID)), Convert.ToInt64(c1Insurance.GetData(_iRespcount, COL_INSURANCECONTACTID))))
                        //{
                        StrClaimRefNum = Convert.ToString(getClaimRefNo(_MasterTransactionID, Convert.ToInt64(c1Insurance.GetData(_iRespcount, COL_INSURANCEID)), Convert.ToInt64(c1Insurance.GetData(_iRespcount, COL_INSURANCECONTACTID)), _ClinicID));
                        _sClaimRefNo = StrClaimRefNum;
                        //_IsbCliamReplacement = true;
                        //}
                        //else
                        //{
                        //    _sClaimRefNo = string.Empty;
                        //    //_IsbCliamReplacement = false;
                        //}
                    }
                }
                c1Insurance_KeyPress(null, null);
            }
            catch (Exception ex)
            {
                gloAuditTrail.gloAuditTrail.ExceptionLog(ex, false);
            }
        }

        private void ShiftResponsiblity(int iRow)
        {
            int _RowCount = iRow;
            try
            {
                if (gloBilling.ChkPaymentAgainstInsV3(_dtEOBPayments, Convert.ToInt64(c1Insurance.GetData(iRow, COL_INSURANCECONTACTID)), Convert.ToInt64(c1Insurance.GetData(iRow, COL_INSURANCEID))))
                {
                    _RowCount += 1;
                    ShiftResponsiblity(_RowCount);
                }
                else
                {
                    for (int icount = 1; icount <= c1Insurance.Rows.Count - 1; icount++)
                    {
                        c1Insurance.SetCellCheck(icount, COL_SELECT_CURRENT_RESPONSIBLE_PARTY, CheckEnum.Unchecked);
                    }

                    c1Insurance.SetCellCheck(_RowCount, COL_SELECT_CURRENT_RESPONSIBLE_PARTY, CheckEnum.Checked);

                    c1Insurance.SetData(_RowCount, COL_INS_INTERNAL_PARTYSTATUS, PartyNo);

                    if (c1Insurance.GetData(_RowCount, COL_INSURANCENAME).ToString().ToLower() != "self")
                    {
                        c1Insurance.SetData(_RowCount, COL_INSVIEW_PARTYSTATUS, PartyNo);
                    }

                    for (int icount = 1; icount <= c1Insurance.Rows.Count - 1; icount++)
                    {
                        if (c1Insurance.GetCellCheck(icount, COL_SELECT_CURRENT_RESPONSIBLE_PARTY) == CheckEnum.Checked)
                        {
                            System.Drawing.Image imgFlagResp = global::gloBilling.Properties.Resources.Normal_Priority;
                            c1Insurance.SetCellImage(icount, COL_INSURANCERESPONSIBILITY, imgFlagResp);
                        }
                        else
                        {
                            c1Insurance.SetCellImage(icount, COL_INSURANCERESPONSIBILITY, null);
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                gloAuditTrail.gloAuditTrail.ExceptionLog(ex, false);
            }
        }

        private void ShowHideUB()
        {
            try
            {
                if (c1Insurance.Cols != null)
                {
                    bool _IsInstitutionalPlan = false;

                    for (int i = 1; i <= c1Insurance.Rows.Count - 1; i++)
                    {
                        if (c1Insurance.GetCellCheck(i, COL_SELECT_CURRENT_RESPONSIBLE_PARTY) == CheckEnum.Checked)
                        {
                            _IsInstitutionalPlan = Convert.ToBoolean(c1Insurance.GetData(i, COL_ISINSTITUTIONALBILLING));
                            break;
                        }
                    }

                    if (IsUBEnabled == true && _IsInstitutionalPlan == true)
                    {
                        tls_AddUBData.Visible = true;
                    }
                    else
                    {
                        tls_AddUBData.Visible = false;
                    }
                }
                else
                {
                    gloAuditTrail.gloAuditTrail.ExceptionLog("Insurance grid has no institutional column. ", false);
                }
            }
            catch (Exception ex)
            {
                gloAuditTrail.gloAuditTrail.ExceptionLog(ex, false);
            }
        }
        #endregion

        #region "CMS1500"

        private void OpenCMS1500()
        {
            ArrayList _CurTrnIDs = new ArrayList();
            ArrayList _MasTrnIDs = new ArrayList();

            try
            {

                #region " Get selected transaction id's "

                Int64 _transactionId = 0;
                Int64 _MastertrnId = 0;//MaheshB 02152010
                Int64 _patientId = 0;


                _transactionId = _InitialTransaction.TransactionID;
                _MastertrnId = _InitialTransaction.TransactionMasterID;
                _patientId = _InitialTransaction.PatientID;
                if (_transactionId > 0) { _CurTrnIDs.Add(_transactionId); }
                if (_MastertrnId > 0) { _MasTrnIDs.Add(_MastertrnId); }


                if (gloCharges.GetBillingType(_transactionId, _MastertrnId) != Convert.ToInt16(BillingType.Institutional))
                {
                    MessageBox.Show("Select professional claim(s). ", _messageBoxCaption, MessageBoxButtons.OK, MessageBoxIcon.Information);
                    return;
                }



                #endregion

                if (_CurTrnIDs.Count > 0)
                {

                    frmHCFA1500 ofrmHCFA1500 = new frmHCFA1500(_DatabaseConnectionString, _CurTrnIDs, _MasTrnIDs, true);
                    ofrmHCFA1500.frmModifyChr = this;
                    ofrmHCFA1500.CallingTab = Convert.ToString("Queue");
                    ofrmHCFA1500.bIsModify = true;
                    ofrmHCFA1500.ShowDialog(this);
                    ofrmHCFA1500.Dispose();
                }
                else
                {
                    MessageBox.Show("Select transaction. ", _messageBoxCaption, MessageBoxButtons.OK, MessageBoxIcon.Information);
                }



            }
            catch (Exception ex)
            {
                gloAuditTrail.gloAuditTrail.ExceptionLog(ex, true);
            }
        }


        #endregion

        #region "UB 04"

        private void OpenUB04Form()
        {

            try
            {
                ArrayList _CurTrnIDs = new ArrayList();
                ArrayList _MasTrnIDs = new ArrayList();


                #region " Get selected transaction id's "


                Int64 _transactionId = 0;
                Int64 _MastertrnId = 0;//MaheshB 02152010
                Int64 _patientId = 0;

                _transactionId = _InitialTransaction.TransactionID;
                _MastertrnId = _InitialTransaction.TransactionMasterID;
                _patientId = _InitialTransaction.PatientID;
                if (_transactionId > 0) { _CurTrnIDs.Add(_transactionId); }
                if (_MastertrnId > 0) { _MasTrnIDs.Add(_MastertrnId); }

                if (gloCharges.GetBillingType(_transactionId, _MastertrnId) != Convert.ToInt16(BillingType.Institutional))
                {
                    MessageBox.Show("Select institutional claim(s). ", _messageBoxCaption, MessageBoxButtons.OK, MessageBoxIcon.Information);
                    return;
                }

                #endregion

                if (_CurTrnIDs.Count > 0)
                {
                    frmUB04 ofrmUB04 = new frmUB04(_DatabaseConnectionString, _CurTrnIDs, _MasTrnIDs, true);
                    ofrmUB04.frmModifyChr = this;
                    ofrmUB04.CallingTab = Convert.ToString("Queue");
                    ofrmUB04.ShowDialog(this);
                    ofrmUB04.Dispose();
                }
                else
                {
                    MessageBox.Show("Select transaction.", _messageBoxCaption, MessageBoxButtons.OK, MessageBoxIcon.Information);
                }
            }

            catch (Exception ex)
            {
                gloAuditTrail.gloAuditTrail.ExceptionLog(ex, true);
            }
        }

        private DataSet FillUB04Data(Int64 TransactionMasterID, Int64 TransactionID)
        {
            gloDatabaseLayer.DBLayer oDB = new gloDatabaseLayer.DBLayer(_DatabaseConnectionString);
            gloDatabaseLayer.DBParameters oDBParameters = new gloDatabaseLayer.DBParameters();
            DataSet dsUB04Data = null;
            try
            {
                oDBParameters.Add("@nTransactionMasterID", TransactionMasterID, System.Data.ParameterDirection.Input, System.Data.SqlDbType.BigInt);
                oDBParameters.Add("@nTransactionID", TransactionID, System.Data.ParameterDirection.Input, System.Data.SqlDbType.BigInt);
                oDB.Connect(false);
                oDB.Retrive("BL_SELECT_ADDITIONAL_UB_CLAIM_DATA", oDBParameters, out dsUB04Data);
                oDB.Disconnect();
                dsUB04Data.Tables[0].TableName = "ChargeUBData";
                dsUB04Data.Tables[1].TableName = "ConditionCode";
                dsUB04Data.Tables[2].TableName = "ValueCode";
                dsUB04Data.Tables[3].TableName = "OccurrenceCode";
                dsUB04Data.Tables[4].TableName = "OccurrenceSpanCode";
                if (dsUB04Data.Tables["ChargeUBData"] != null)
                {
                    if (dsUB04Data.Tables["ChargeUBData"].Rows.Count > 0)
                    {
                        oUB.sTypeofbill = Convert.ToString(dsUB04Data.Tables["ChargeUBData"].Rows[0]["sTypeOfBill"]);
                        if (oUB != null && Convert.ToString(oUB.sTypeofbill) != "")
                        {
                            oUB.IsModify = true;
                        }
                        oUB.sAdmissionType = Convert.ToString(dsUB04Data.Tables["ChargeUBData"].Rows[0]["sAdmissionTypeCode"]);
                        if (oUB != null && Convert.ToString(oUB.sAdmissionType) != "")
                        {
                            oUB.IsModify = true;
                        }

                        oUB.sAdmitDate = Convert.ToString(dsUB04Data.Tables["ChargeUBData"].Rows[0]["AdmitDate"]);
                        if (oUB != null && Convert.ToString(oUB.sAdmitDate) != "")
                        {
                            oUB.IsModify = true;
                            oUB.HasOtherData = true;
                        }
                        oUB.sAdmitHour = Convert.ToString(dsUB04Data.Tables["ChargeUBData"].Rows[0]["Admithour"]);
                        if (oUB != null && Convert.ToString(oUB.sAdmitHour) != "")
                        {
                            oUB.IsModify = true;
                            oUB.HasOtherData = true;
                        }
                        oUB.sDischargeHour = Convert.ToString(dsUB04Data.Tables["ChargeUBData"].Rows[0]["Dischargehour"]);
                        if (oUB != null && Convert.ToString(oUB.sDischargeHour) != "")
                        {
                            oUB.IsModify = true;
                            oUB.HasOtherData = true;
                        }
                        oUB.sDischargeStatus = Convert.ToString(dsUB04Data.Tables["ChargeUBData"].Rows[0]["sDischargeStatusCode"]);
                        if (oUB != null && Convert.ToString(oUB.sDischargeStatus) != "")
                        {
                            oUB.IsModify = true;
                        }
                    }
                }


                if (dsUB04Data.Tables["ConditionCode"] != null)
                {
                    if (dsUB04Data.Tables["ConditionCode"].Rows.Count > 0)
                    {
                        if (Convert.ToString(dsUB04Data.Tables["ConditionCode"].Rows[0]["sConditionCode01"]) != "")
                        {
                            oUB.sConditionCode01 = Convert.ToString(dsUB04Data.Tables["ConditionCode"].Rows[0]["sConditionCode01"]);
                            oUB.IsModify = true;
                            oUB.HasOtherData = true;
                        }
                        if (Convert.ToString(dsUB04Data.Tables["ConditionCode"].Rows[0]["sConditionCode02"]) != "")
                        {
                            oUB.sConditionCode02 = Convert.ToString(dsUB04Data.Tables["ConditionCode"].Rows[0]["sConditionCode02"]);
                            oUB.IsModify = true;
                            oUB.HasOtherData = true;
                        }
                        if (Convert.ToString(dsUB04Data.Tables["ConditionCode"].Rows[0]["sConditionCode03"]) != "")
                        {
                            oUB.sConditionCode03 = Convert.ToString(dsUB04Data.Tables["ConditionCode"].Rows[0]["sConditionCode03"]);
                            oUB.IsModify = true;
                            oUB.HasOtherData = true;
                        }
                        if (Convert.ToString(dsUB04Data.Tables["ConditionCode"].Rows[0]["sConditionCode04"]) != "")
                        {
                            oUB.sConditionCode04 = Convert.ToString(dsUB04Data.Tables["ConditionCode"].Rows[0]["sConditionCode04"]);
                            oUB.IsModify = true;
                            oUB.HasOtherData = true;
                        }
                        if (Convert.ToString(dsUB04Data.Tables["ConditionCode"].Rows[0]["sConditionCode05"]) != "")
                        {
                            oUB.sConditionCode05 = Convert.ToString(dsUB04Data.Tables["ConditionCode"].Rows[0]["sConditionCode05"]);
                            oUB.IsModify = true;
                            oUB.HasOtherData = true;
                        }
                        if (Convert.ToString(dsUB04Data.Tables["ConditionCode"].Rows[0]["sConditionCode06"]) != "")
                        {
                            oUB.sConditionCode06 = Convert.ToString(dsUB04Data.Tables["ConditionCode"].Rows[0]["sConditionCode06"]);
                            oUB.IsModify = true;
                            oUB.HasOtherData = true;
                        }
                        if (Convert.ToString(dsUB04Data.Tables["ConditionCode"].Rows[0]["sConditionCode07"]) != "")
                        {
                            oUB.sConditionCode07 = Convert.ToString(dsUB04Data.Tables["ConditionCode"].Rows[0]["sConditionCode07"]);
                            oUB.IsModify = true;
                            oUB.HasOtherData = true;
                        }
                        if (Convert.ToString(dsUB04Data.Tables["ConditionCode"].Rows[0]["sConditionCode08"]) != "")
                        {
                            oUB.sConditionCode08 = Convert.ToString(dsUB04Data.Tables["ConditionCode"].Rows[0]["sConditionCode08"]);
                            oUB.IsModify = true;
                            oUB.HasOtherData = true;
                        }
                        if (Convert.ToString(dsUB04Data.Tables["ConditionCode"].Rows[0]["sConditionCode09"]) != "")
                        {
                            oUB.sConditionCode09 = Convert.ToString(dsUB04Data.Tables["ConditionCode"].Rows[0]["sConditionCode09"]);
                            oUB.IsModify = true;
                            oUB.HasOtherData = true;
                        }
                        if (Convert.ToString(dsUB04Data.Tables["ConditionCode"].Rows[0]["sConditionCode10"]) != "")
                        {
                            oUB.sConditionCode10 = Convert.ToString(dsUB04Data.Tables["ConditionCode"].Rows[0]["sConditionCode10"]);
                            oUB.IsModify = true;
                            oUB.HasOtherData = true;
                        }
                        if (Convert.ToString(dsUB04Data.Tables["ConditionCode"].Rows[0]["sConditionCode11"]) != "")
                        {
                            oUB.sConditionCode11 = Convert.ToString(dsUB04Data.Tables["ConditionCode"].Rows[0]["sConditionCode11"]);
                            oUB.IsModify = true;
                            oUB.HasOtherData = true;
                        }
                        //if (Convert.ToString(dsUB04Data.Tables["ConditionCode"].Rows[0]["sConditionCode12"]) != "")
                        //{
                        //    oUB.sConditionCode12 = Convert.ToString(dsUB04Data.Tables["ConditionCode"].Rows[0]["sConditionCode12"]);
                        //}

                    }
                }


                if (dsUB04Data.Tables["ValueCode"] != null)
                {
                    if (dsUB04Data.Tables["ValueCode"].Rows.Count > 0)
                    {
                        if (Convert.ToString(dsUB04Data.Tables["ValueCode"].Rows[0]["sValueCode01"]) != "")
                        {
                            oUB.sValueCode01 = dsUB04Data.Tables["ValueCode"].Rows[0]["sValueCode01"].ToString();
                            oUB.IsModify = true;
                            oUB.HasOtherData = true;
                        }
                        if (Convert.ToString(dsUB04Data.Tables["ValueCode"].Rows[0]["nValueAmount01"]) != "")
                        {
                            oUB.nValueAmount01 = Convert.ToDecimal(dsUB04Data.Tables["ValueCode"].Rows[0]["nValueAmount01"]);
                            oUB.IsModify = true;
                            oUB.HasOtherData = true;
                        }

                        if (Convert.ToString(dsUB04Data.Tables["ValueCode"].Rows[0]["sValueCode02"]) != "")
                        {
                            oUB.sValueCode02 = dsUB04Data.Tables["ValueCode"].Rows[0]["sValueCode02"].ToString();
                            oUB.IsModify = true;
                            oUB.HasOtherData = true;
                        }
                        if (Convert.ToString(dsUB04Data.Tables["ValueCode"].Rows[0]["nValueAmount02"]) != "")
                        {
                            oUB.nValueAmount02 = Convert.ToDecimal(dsUB04Data.Tables["ValueCode"].Rows[0]["nValueAmount02"]);
                            oUB.IsModify = true;
                            oUB.HasOtherData = true;
                        }

                        if (Convert.ToString(dsUB04Data.Tables["ValueCode"].Rows[0]["sValueCode03"]) != "")
                        {
                            oUB.sValueCode03 = dsUB04Data.Tables["ValueCode"].Rows[0]["sValueCode03"].ToString();
                            oUB.IsModify = true;
                            oUB.HasOtherData = true;
                        }
                        if (Convert.ToString(dsUB04Data.Tables["ValueCode"].Rows[0]["nValueAmount03"]) != "")
                        {
                            oUB.nValueAmount03 = Convert.ToDecimal(dsUB04Data.Tables["ValueCode"].Rows[0]["nValueAmount03"]);
                            oUB.IsModify = true;
                            oUB.HasOtherData = true;
                        }

                        if (Convert.ToString(dsUB04Data.Tables["ValueCode"].Rows[0]["sValueCode04"]) != "")
                        {
                            oUB.sValueCode04 = dsUB04Data.Tables["ValueCode"].Rows[0]["sValueCode04"].ToString();
                            oUB.IsModify = true;
                            oUB.HasOtherData = true;
                        }
                        if (Convert.ToString(dsUB04Data.Tables["ValueCode"].Rows[0]["nValueAmount04"]) != "")
                        {
                            oUB.nValueAmount04 = Convert.ToDecimal(dsUB04Data.Tables["ValueCode"].Rows[0]["nValueAmount04"]);
                            oUB.IsModify = true;
                            oUB.HasOtherData = true;
                        }

                        if (Convert.ToString(dsUB04Data.Tables["ValueCode"].Rows[0]["sValueCode05"]) != "")
                        {
                            oUB.sValueCode05 = dsUB04Data.Tables["ValueCode"].Rows[0]["sValueCode05"].ToString();
                            oUB.IsModify = true;
                            oUB.HasOtherData = true;
                        }
                        if (Convert.ToString(dsUB04Data.Tables["ValueCode"].Rows[0]["nValueAmount05"]) != "")
                        {
                            oUB.nValueAmount05 = Convert.ToDecimal(dsUB04Data.Tables["ValueCode"].Rows[0]["nValueAmount05"]);
                            oUB.IsModify = true;
                            oUB.HasOtherData = true;
                        }

                        if (Convert.ToString(dsUB04Data.Tables["ValueCode"].Rows[0]["sValueCode06"]) != "")
                        {
                            oUB.sValueCode06 = dsUB04Data.Tables["ValueCode"].Rows[0]["sValueCode06"].ToString();
                            oUB.IsModify = true;
                            oUB.HasOtherData = true;
                        }
                        if (Convert.ToString(dsUB04Data.Tables["ValueCode"].Rows[0]["nValueAmount06"]) != "")
                        {
                            oUB.nValueAmount06 = Convert.ToDecimal(dsUB04Data.Tables["ValueCode"].Rows[0]["nValueAmount06"]);
                            oUB.IsModify = true;
                            oUB.HasOtherData = true;
                        }

                        if (Convert.ToString(dsUB04Data.Tables["ValueCode"].Rows[0]["sValueCode07"]) != "")
                        {
                            oUB.sValueCode07 = dsUB04Data.Tables["ValueCode"].Rows[0]["sValueCode07"].ToString();
                            oUB.IsModify = true;
                            oUB.HasOtherData = true;
                        }
                        if (Convert.ToString(dsUB04Data.Tables["ValueCode"].Rows[0]["nValueAmount07"]) != "")
                        {
                            oUB.nValueAmount07 = Convert.ToDecimal(dsUB04Data.Tables["ValueCode"].Rows[0]["nValueAmount07"]);
                            oUB.IsModify = true;
                            oUB.HasOtherData = true;
                        }


                        if (Convert.ToString(dsUB04Data.Tables["ValueCode"].Rows[0]["sValueCode08"]) != "")
                        {
                            oUB.sValueCode08 = dsUB04Data.Tables["ValueCode"].Rows[0]["sValueCode08"].ToString();
                            oUB.IsModify = true;
                            oUB.HasOtherData = true;
                        }
                        if (Convert.ToString(dsUB04Data.Tables["ValueCode"].Rows[0]["nValueAmount08"]) != "")
                        {
                            oUB.nValueAmount08 = Convert.ToDecimal(dsUB04Data.Tables["ValueCode"].Rows[0]["nValueAmount08"]);
                            oUB.IsModify = true;
                            oUB.HasOtherData = true;
                        }

                        if (Convert.ToString(dsUB04Data.Tables["ValueCode"].Rows[0]["sValueCode09"]) != "")
                        {
                            oUB.sValueCode09 = dsUB04Data.Tables["ValueCode"].Rows[0]["sValueCode09"].ToString();
                            oUB.IsModify = true;
                            oUB.HasOtherData = true;
                        }
                        if (Convert.ToString(dsUB04Data.Tables["ValueCode"].Rows[0]["nValueAmount09"]) != "")
                        {
                            oUB.nValueAmount09 = Convert.ToDecimal(dsUB04Data.Tables["ValueCode"].Rows[0]["nValueAmount09"]);
                            oUB.IsModify = true;
                            oUB.HasOtherData = true;
                        }

                        if (Convert.ToString(dsUB04Data.Tables["ValueCode"].Rows[0]["sValueCode10"]) != "")
                        {
                            oUB.sValueCode10 = dsUB04Data.Tables["ValueCode"].Rows[0]["sValueCode10"].ToString();
                            oUB.IsModify = true;
                            oUB.HasOtherData = true;
                        }
                        if (Convert.ToString(dsUB04Data.Tables["ValueCode"].Rows[0]["nValueAmount10"]) != "")
                        {
                            oUB.nValueAmount10 = Convert.ToDecimal(dsUB04Data.Tables["ValueCode"].Rows[0]["nValueAmount10"]);
                            oUB.IsModify = true;
                            oUB.HasOtherData = true;
                        }

                        if (Convert.ToString(dsUB04Data.Tables["ValueCode"].Rows[0]["sValueCode11"]) != "")
                        {
                            oUB.sValueCode11 = dsUB04Data.Tables["ValueCode"].Rows[0]["sValueCode11"].ToString();
                            oUB.IsModify = true;
                            oUB.HasOtherData = true;
                        }
                        if (Convert.ToString(dsUB04Data.Tables["ValueCode"].Rows[0]["nValueAmount11"]) != "")
                        {
                            oUB.nValueAmount11 = Convert.ToDecimal(dsUB04Data.Tables["ValueCode"].Rows[0]["nValueAmount11"]);
                            oUB.IsModify = true;
                            oUB.HasOtherData = true;
                        }

                        if (Convert.ToString(dsUB04Data.Tables["ValueCode"].Rows[0]["sValueCode12"]) != "")
                        {
                            oUB.sValueCode12 = dsUB04Data.Tables["ValueCode"].Rows[0]["sValueCode12"].ToString();
                            oUB.IsModify = true;
                            oUB.HasOtherData = true;
                        }
                        if (Convert.ToString(dsUB04Data.Tables["ValueCode"].Rows[0]["nValueAmount12"]) != "")
                        {
                            oUB.nValueAmount12 = Convert.ToDecimal(dsUB04Data.Tables["ValueCode"].Rows[0]["nValueAmount12"]);
                            oUB.IsModify = true;
                            oUB.HasOtherData = true;
                        }

                    }
                }


                if (dsUB04Data.Tables["OccurrenceCode"] != null)
                {
                    if (dsUB04Data.Tables["OccurrenceCode"].Rows.Count > 0)
                    {
                        if (Convert.ToString(dsUB04Data.Tables["OccurrenceCode"].Rows[0]["sOccurrenceCode01"]) != "")
                        {
                            oUB.sOccurrenceCode01 = dsUB04Data.Tables["OccurrenceCode"].Rows[0]["sOccurrenceCode01"].ToString();
                            oUB.IsModify = true;
                            oUB.HasOtherData = true;
                        }
                        if (Convert.ToString(dsUB04Data.Tables["OccurrenceCode"].Rows[0]["dtOccurrenceDate01"]) != "")
                        {
                            oUB.sOccurrenceDate01 = dsUB04Data.Tables["OccurrenceCode"].Rows[0]["dtOccurrenceDate01"].ToString();
                            oUB.IsModify = true;
                        }

                        if (Convert.ToString(dsUB04Data.Tables["OccurrenceCode"].Rows[0]["sOccurrenceCode02"]) != "")
                        {
                            oUB.sOccurrenceCode02 = dsUB04Data.Tables["OccurrenceCode"].Rows[0]["sOccurrenceCode02"].ToString();
                            oUB.IsModify = true;
                            oUB.HasOtherData = true;
                        }
                        if (Convert.ToString(dsUB04Data.Tables["OccurrenceCode"].Rows[0]["dtOccurrenceDate02"]) != "")
                        {
                            oUB.sOccurrenceDate02 = dsUB04Data.Tables["OccurrenceCode"].Rows[0]["dtOccurrenceDate02"].ToString();
                            oUB.IsModify = true;
                            oUB.HasOtherData = true;
                        }

                        if (Convert.ToString(dsUB04Data.Tables["OccurrenceCode"].Rows[0]["sOccurrenceCode03"]) != "")
                        {
                            oUB.sOccurrenceCode03 = dsUB04Data.Tables["OccurrenceCode"].Rows[0]["sOccurrenceCode03"].ToString();
                            oUB.IsModify = true;
                            oUB.HasOtherData = true;
                        }
                        if (Convert.ToString(dsUB04Data.Tables["OccurrenceCode"].Rows[0]["dtOccurrenceDate03"]) != "")
                        {
                            oUB.sOccurrenceDate03 = dsUB04Data.Tables["OccurrenceCode"].Rows[0]["dtOccurrenceDate03"].ToString();
                            oUB.IsModify = true;
                            oUB.HasOtherData = true;
                        }

                        if (Convert.ToString(dsUB04Data.Tables["OccurrenceCode"].Rows[0]["sOccurrenceCode04"]) != "")
                        {
                            oUB.sOccurrenceCode04 = dsUB04Data.Tables["OccurrenceCode"].Rows[0]["sOccurrenceCode04"].ToString();
                            oUB.IsModify = true;
                            oUB.HasOtherData = true;
                        }
                        if (Convert.ToString(dsUB04Data.Tables["OccurrenceCode"].Rows[0]["dtOccurrenceDate04"]) != "")
                        {
                            oUB.sOccurrenceDate04 = dsUB04Data.Tables["OccurrenceCode"].Rows[0]["dtOccurrenceDate04"].ToString();
                            oUB.IsModify = true;
                            oUB.HasOtherData = true;
                        }

                        if (Convert.ToString(dsUB04Data.Tables["OccurrenceCode"].Rows[0]["sOccurrenceCode05"]) != "")
                        {
                            oUB.sOccurrenceCode05 = dsUB04Data.Tables["OccurrenceCode"].Rows[0]["sOccurrenceCode05"].ToString();
                            oUB.IsModify = true;
                            oUB.HasOtherData = true;
                        }
                        if (Convert.ToString(dsUB04Data.Tables["OccurrenceCode"].Rows[0]["dtOccurrenceDate05"]) != "")
                        {
                            oUB.sOccurrenceDate05 = dsUB04Data.Tables["OccurrenceCode"].Rows[0]["dtOccurrenceDate05"].ToString();
                            oUB.IsModify = true;
                            oUB.HasOtherData = true;
                        }

                        if (Convert.ToString(dsUB04Data.Tables["OccurrenceCode"].Rows[0]["sOccurrenceCode06"]) != "")
                        {
                            oUB.sOccurrenceCode06 = dsUB04Data.Tables["OccurrenceCode"].Rows[0]["sOccurrenceCode06"].ToString();
                            oUB.IsModify = true;
                            oUB.HasOtherData = true;
                        }
                        if (Convert.ToString(dsUB04Data.Tables["OccurrenceCode"].Rows[0]["dtOccurrenceDate06"]) != "")
                        {
                            oUB.sOccurrenceDate06 = dsUB04Data.Tables["OccurrenceCode"].Rows[0]["dtOccurrenceDate06"].ToString();
                            oUB.IsModify = true;
                            oUB.HasOtherData = true;
                        }

                        if (Convert.ToString(dsUB04Data.Tables["OccurrenceCode"].Rows[0]["sOccurrenceCode07"]) != "")
                        {
                            oUB.sOccurrenceCode07 = dsUB04Data.Tables["OccurrenceCode"].Rows[0]["sOccurrenceCode07"].ToString();
                            oUB.IsModify = true;
                            oUB.HasOtherData = true;
                        }
                        if (Convert.ToString(dsUB04Data.Tables["OccurrenceCode"].Rows[0]["dtOccurrenceDate07"]) != "")
                        {
                            oUB.sOccurrenceDate07 = dsUB04Data.Tables["OccurrenceCode"].Rows[0]["dtOccurrenceDate07"].ToString();
                            oUB.IsModify = true;
                            oUB.HasOtherData = true;
                        }

                        if (Convert.ToString(dsUB04Data.Tables["OccurrenceCode"].Rows[0]["sOccurrenceCode08"]) != "")
                        {
                            oUB.sOccurrenceCode08 = dsUB04Data.Tables["OccurrenceCode"].Rows[0]["sOccurrenceCode08"].ToString();
                            oUB.IsModify = true;
                            oUB.HasOtherData = true;
                        }
                        if (Convert.ToString(dsUB04Data.Tables["OccurrenceCode"].Rows[0]["dtOccurrenceDate08"]) != "")
                        {
                            oUB.sOccurrenceDate08 = dsUB04Data.Tables["OccurrenceCode"].Rows[0]["dtOccurrenceDate08"].ToString();
                            oUB.IsModify = true;
                            oUB.HasOtherData = true;
                        }

                    }
                }


                if (dsUB04Data.Tables["OccurrenceSpanCode"] != null)
                {
                    if (dsUB04Data.Tables["OccurrenceSpanCode"].Rows.Count > 0)
                    {
                        if (Convert.ToString(dsUB04Data.Tables["OccurrenceSpanCode"].Rows[0]["sOccurrenceSpanCode01"]) != "")
                        {
                            oUB.sOccurrenceSpanCode01 = dsUB04Data.Tables["OccurrenceSpanCode"].Rows[0]["sOccurrenceSpanCode01"].ToString();
                            oUB.IsModify = true;
                            oUB.HasOtherData = true;
                        }
                        if (Convert.ToString(dsUB04Data.Tables["OccurrenceSpanCode"].Rows[0]["dtOccurrenceFromspanDate01"]) != "")
                        {
                            oUB.sOccurrenceFromSpanDate01 = dsUB04Data.Tables["OccurrenceSpanCode"].Rows[0]["dtOccurrenceFromspanDate01"].ToString();
                            oUB.IsModify = true;
                            oUB.HasOtherData = true;
                        }
                        if (Convert.ToString(dsUB04Data.Tables["OccurrenceSpanCode"].Rows[0]["dtOccurrenceTospanDate01"]) != "")
                        {
                            oUB.sOccurrenceTOSpanDate01 = dsUB04Data.Tables["OccurrenceSpanCode"].Rows[0]["dtOccurrenceTospanDate01"].ToString();
                            oUB.IsModify = true;
                            oUB.HasOtherData = true;
                        }


                        if (Convert.ToString(dsUB04Data.Tables["OccurrenceSpanCode"].Rows[0]["sOccurrenceSpanCode02"]) != "")
                        {
                            oUB.sOccurrenceSpanCode02 = dsUB04Data.Tables["OccurrenceSpanCode"].Rows[0]["sOccurrenceSpanCode02"].ToString();
                            oUB.IsModify = true;
                            oUB.HasOtherData = true;
                        }
                        if (Convert.ToString(dsUB04Data.Tables["OccurrenceSpanCode"].Rows[0]["dtOccurrenceFromspanDate02"]) != "")
                        {
                            oUB.sOccurrenceFromSpanDate02 = dsUB04Data.Tables["OccurrenceSpanCode"].Rows[0]["dtOccurrenceFromspanDate02"].ToString();
                            oUB.IsModify = true;
                            oUB.HasOtherData = true;
                        }
                        if (Convert.ToString(dsUB04Data.Tables["OccurrenceSpanCode"].Rows[0]["dtOccurrenceTospanDate02"]) != "")
                        {
                            oUB.sOccurrenceToSpanDate02 = dsUB04Data.Tables["OccurrenceSpanCode"].Rows[0]["dtOccurrenceTospanDate02"].ToString();
                            oUB.IsModify = true;
                            oUB.HasOtherData = true;
                        }

                        if (Convert.ToString(dsUB04Data.Tables["OccurrenceSpanCode"].Rows[0]["sOccurrenceSpanCode03"]) != "")
                        {
                            oUB.sOccurrenceSpanCode03 = dsUB04Data.Tables["OccurrenceSpanCode"].Rows[0]["sOccurrenceSpanCode03"].ToString();
                            oUB.IsModify = true;
                            oUB.HasOtherData = true;
                        }
                        if (Convert.ToString(dsUB04Data.Tables["OccurrenceSpanCode"].Rows[0]["dtOccurrenceFromspanDate03"]) != "")
                        {
                            oUB.sOccurrenceFromSpanDate03 = dsUB04Data.Tables["OccurrenceSpanCode"].Rows[0]["dtOccurrenceFromspanDate03"].ToString();
                            oUB.IsModify = true;
                            oUB.HasOtherData = true;
                        }
                        if (Convert.ToString(dsUB04Data.Tables["OccurrenceSpanCode"].Rows[0]["dtOccurrenceTospanDate03"]) != "")
                        {
                            oUB.sOccurrenceToSpanDate03 = dsUB04Data.Tables["OccurrenceSpanCode"].Rows[0]["dtOccurrenceTospanDate03"].ToString();
                            oUB.IsModify = true;
                            oUB.HasOtherData = true;
                        }

                        if (Convert.ToString(dsUB04Data.Tables["OccurrenceSpanCode"].Rows[0]["sOccurrenceSpanCode04"]) != "")
                        {
                            oUB.sOccurrenceSpanCode04 = dsUB04Data.Tables["OccurrenceSpanCode"].Rows[0]["sOccurrenceSpanCode04"].ToString();
                            oUB.IsModify = true;
                            oUB.HasOtherData = true;
                        }
                        if (Convert.ToString(dsUB04Data.Tables["OccurrenceSpanCode"].Rows[0]["dtOccurrenceFromspanDate04"]) != "")
                        {
                            oUB.sOccurrenceFromSpanDate04 = dsUB04Data.Tables["OccurrenceSpanCode"].Rows[0]["dtOccurrenceFromspanDate04"].ToString();
                            oUB.IsModify = true;
                            oUB.HasOtherData = true;
                        }
                        if (Convert.ToString(dsUB04Data.Tables["OccurrenceSpanCode"].Rows[0]["dtOccurrenceTospanDate04"]) != "")
                        {
                            oUB.sOccurrenceToSpanDate04 = dsUB04Data.Tables["OccurrenceSpanCode"].Rows[0]["dtOccurrenceTospanDate04"].ToString();
                            oUB.IsModify = true;
                            oUB.HasOtherData = true;
                        }
                    }
                }





            }
            catch (gloDatabaseLayer.DBException ex)
            {
                //ex.ERROR_Log(ex.ToString());
                gloAuditTrail.gloAuditTrail.ExceptionLog(ex, true);
            }
            catch (Exception ex)
            {
                // MessageBox.Show(ex.ToString(), _messageBoxCaption, MessageBoxButtons.OK, MessageBoxIcon.Error);
                gloAuditTrail.gloAuditTrail.ExceptionLog(ex, true);
            }
            finally
            {
                //dsHeaderEDI.Dispose();
                oDBParameters.Dispose();
                if (oDB != null)
                {
                    oDB.Disconnect();
                    oDB.Dispose();
                }
            }

            return dsUB04Data;
        }

        private void ts_UBData_Click(object sender, EventArgs e)
        {
            try
            {
                //if(oUB!=null && oUB.IsModify==false)
                //FillUB04Data();

                //string MinDos = Convert.ToString(gloDateMaster.gloDate.DateAsDate((UC_gloBillingTransactionLines.GetMinDOS())));
                //if (UC_gloBillingTransactionLines.GetLinesCount() <= 1 || oUB.MinDOSDeleted == true) MinDos = null;


                frmUB04Data ofrm = new frmUB04Data(_DatabaseConnectionString, _TransactionID, oUB, null);
                if (IsClaimVoided)
                {
                    ofrm._bIsVoid = true;
                }
                ofrm.ShowDialog(this);
                oUB = ofrm._oUB;
                ofrm.Dispose();
                SetHoldnMoreClaimDataMesseges();
            }
            catch (Exception ex)
            {
                gloAuditTrail.gloAuditTrail.ExceptionLog(ex, true);
            }

        }

        #endregion

        #region "Get Billing Method"
        //public Int16 GetBilling_value(Int64 TransactionId)
        //{

        //    gloDatabaseLayer.DBLayer oDB = new gloDatabaseLayer.DBLayer(_DatabaseConnectionString);
        //    gloDatabaseLayer.DBParameters oParameters = new gloDatabaseLayer.DBParameters();
        //    try
        //    {                

        //        object BillingType;
        //        oParameters.Add("@nTransactionId", TransactionId, ParameterDirection.Input, SqlDbType.BigInt);               
        //        oDB.Connect(false);
        //        BillingType = oDB.ExecuteScalar("BL_Get_PlanTypeValue", oParameters);
        //        oDB.Disconnect();
        //        return Convert.ToInt16(BillingType);
        //    }
        //    catch (Exception ex)
        //    {
        //        gloAuditTrail.gloAuditTrail.ExceptionLog(ex.Message, true);
        //        return 0;
        //    }
        //    finally
        //    {
        //        if (oParameters != null)
        //        {
        //            oParameters.Dispose();
        //            oParameters = null;

        //        }
        //        if (oDB != null)
        //        {
        //            oDB.Dispose();
        //            oDB=null;                  

        //        }

        //    }

        //}
        #endregion ""

        #region "View Claim Visibility"
        //private void SetViewClaim(Int64 MstTransactionId)
        // {
        //    try
        //    {
        //        Int16 BillingMethod = GetBilling_value(MstTransactionId);

        //        if (BillingMethod == 2)
        //        {
        //            tls_UB04.Visible = false;
        //            tls_CMS1500.Visible = true; 
        //        }
        //        else if (BillingMethod == 3)
        //        {
        //            tls_UB04.Visible = true;
        //            tls_CMS1500.Visible = false;
        //        }
        //        else if (BillingMethod == 1)
        //        {
        //            tls_UB04.Visible = true;
        //            tls_CMS1500.Visible = true;
        //        }
        //        else
        //        {
        //            tls_UB04.Visible = false;
        //            tls_CMS1500.Visible = false;
        //        }
        //    }
        //    catch (Exception ex)
        //    {
        //        gloAuditTrail.gloAuditTrail.ExceptionLog(ex.Message, true);                
        //    }

        //}

        #endregion""

        #region "view Claim"

        private void tls_ViewClaim_Click(object sender, EventArgs e)
        {
            ArrayList _CurTrnIDs = new ArrayList();
            ArrayList _MasTrnIDs = new ArrayList();

            try
            {

                #region " Get selected transaction id's "

                Int64 _transactionId = 0;
                Int64 _MastertrnId = 0;//MaheshB 02152010
                Int64 _patientId = 0;


                _transactionId = _InitialTransaction.TransactionID;
                _MastertrnId = _InitialTransaction.TransactionMasterID;
                _patientId = _InitialTransaction.PatientID;
                if (_transactionId > 0) { _CurTrnIDs.Add(_transactionId); }
                if (_MastertrnId > 0) { _MasTrnIDs.Add(_MastertrnId); }


                if (gloCharges.GetBillingType(_transactionId, _MastertrnId) == Convert.ToInt16(BillingType.Professional))
                {
                    //MessageBox.Show("Select professional claim(s). ", _messageBoxCaption, MessageBoxButtons.OK, MessageBoxIcon.Information);
                    //return;
                    if (_CurTrnIDs.Count > 0)
                    {
                        // Code added for selection of paper version 12272013 Sameer
                        gloDatabaseLayer.DBLayer oDB = new gloDatabaseLayer.DBLayer(_DatabaseConnectionString);
                        gloDatabaseLayer.DBParameters oDBPara = new gloDatabaseLayer.DBParameters();

                        oDBPara.Add("@nContactID", _nPrimaryParty, ParameterDirection.Input, SqlDbType.BigInt);
                        oDB.Connect(false);
                        Int16 nResult = Convert.ToInt16(oDB.ExecuteScalar("gsp_CheckPaperVersion", oDBPara));
                        oDB.Disconnect();
                        oDB.Dispose();
                        oDBPara.Clear();
                        oDBPara.Dispose();
                        oDB = null;
                        oDBPara = null;
                        switch ((PaperFormVersion)nResult)
                        {
                            case PaperFormVersion.CMS1500:
                                {
                                    if (_InitialTransaction.nICDRevision == gloGlobal.gloICD.CodeRevision.ICD10.GetHashCode())
                                    {
                                        if (MessageBox.Show("Selected claim(s) contains ICD-10 codes, billing ICD-10 on CMS1500 08/05 may cause billing rejection." + Environment.NewLine + Environment.NewLine + "Continue?", _messageBoxCaption, MessageBoxButtons.OKCancel, MessageBoxIcon.Question) == DialogResult.OK)
                                        {
                                            frmHCFA1500 ofrmHCFA1500 = new frmHCFA1500(_DatabaseConnectionString, _CurTrnIDs, _MasTrnIDs, true);
                                            ofrmHCFA1500.frmModifyChr = this;
                                            ofrmHCFA1500.CallingTab = Convert.ToString("Queue");
                                            ofrmHCFA1500.bIsModify = true;
                                            ofrmHCFA1500.bIsClaimHold = _oClaimHold.IsHold;
                                            ofrmHCFA1500.ShowDialog(this);
                                            ofrmHCFA1500.Dispose();

                                        }
                                    }
                                    else
                                    {
                                        frmHCFA1500 ofrmHCFA1500 = new frmHCFA1500(_DatabaseConnectionString, _CurTrnIDs, _MasTrnIDs, true);
                                        ofrmHCFA1500.frmModifyChr = this;
                                        ofrmHCFA1500.CallingTab = Convert.ToString("Queue");
                                        ofrmHCFA1500.bIsModify = true;
                                        ofrmHCFA1500.ShowDialog(this);
                                        ofrmHCFA1500.Dispose();

                                    }
                                    break;
                                };

                            case PaperFormVersion.CMS1500New:
                                {
                                    frmHCFA1500New ofrmHCFA1500New = new frmHCFA1500New(_DatabaseConnectionString, _CurTrnIDs, _MasTrnIDs, true);
                                    ofrmHCFA1500New.CallingTab = Convert.ToString("Queue");
                                    ofrmHCFA1500New.bIsModify = true;
                                    ofrmHCFA1500New.bIsClaimHold = _oClaimHold.IsHold;
                                    ofrmHCFA1500New.ShowDialog(this);
                                    ofrmHCFA1500New.Dispose();
                                    break;

                                };
                        }


                    }
                    else
                    {
                        MessageBox.Show("Select transaction. ", _messageBoxCaption, MessageBoxButtons.OK, MessageBoxIcon.Information);
                    }
                }
                else  //(GetBillingType(_transactionId, _MastertrnId) == Convert.ToInt16(BillingType.Professional))
                {
                    if (_CurTrnIDs.Count > 0)
                    {
                        frmUB04 ofrmUB04 = new frmUB04(_DatabaseConnectionString, _CurTrnIDs, _MasTrnIDs, true);
                        ofrmUB04.frmModifyChr = this;
                        ofrmUB04.bIsClaimHold = _oClaimHold.IsHold;
                        ofrmUB04.CallingTab = Convert.ToString("Queue");
                        ofrmUB04.ShowDialog(this);
                        ofrmUB04.Dispose();
                    }
                    else
                    {
                        MessageBox.Show("Select transaction.", _messageBoxCaption, MessageBoxButtons.OK, MessageBoxIcon.Information);
                    }
                }

                #endregion

            }
            catch (Exception ex)
            {
                gloAuditTrail.gloAuditTrail.ExceptionLog(ex, true);
            }

        }

        #endregion""

        #region "Eligibility Insurance  Covrage"
        private void mnuViewBenefit_Click(object sender, EventArgs e)
        {
            c1Insurance.ContextMenuStrip = null;
            Int64 nCurrentInsuranceID = Convert.ToInt64(c1Insurance.GetData(c1Insurance.RowSel, COL_INSURANCEID));
            gloPMGeneral.frmViewBenefit ofrm = new gloPMGeneral.frmViewBenefit(this.PatientID, nCurrentInsuranceID, _DatabaseConnectionString);
            ofrm.StartPosition = FormStartPosition.CenterParent;
            ofrm.ShowDialog(this);
            ofrm.Dispose();
            ofrm = null;
            LoadPatientModifiedData();
        }
        private Boolean ValidateInsuranceCoverage()
        {
            DataTable _dtInsuranceCoverageDates = null;
            for (int iCount = 1; iCount <= c1Insurance.Rows.Count - 1; iCount++)
            {
                if (c1Insurance.GetCellCheck(iCount, COL_SELECT_CURRENT_RESPONSIBLE_PARTY) == CheckEnum.Checked)
                {
                    _iCurrentResponsiblePosition = iCount;
                    break;
                }
            }

            Int64 nCurrentInsuranceID = Convert.ToInt64(c1Insurance.GetData(Convert.ToInt16(_iCurrentResponsiblePosition), COL_INSURANCEID));
            string sCurrentInsuranceName = Convert.ToString(c1Insurance.GetData(Convert.ToInt16(_iCurrentResponsiblePosition), COL_INSURANCENAME));
            gloCharges.GetInsuranceCovrageDates(this.PatientID, _nResponsibleParty, nCurrentInsuranceID, out _dtInsuranceCoverageDates);
            if (_dtInsuranceCoverageDates.Rows.Count > 0)
            {
                return UC_gloBillingTransactionLines.ValidateInsuranceCovrageDates(_dtInsuranceCoverageDates, sCurrentInsuranceName);
            }
            return true;
        }
        #endregion

        private void AddResendinggnote(Int64 _MasterTransactionID)
        {

            Common.GeneralNotes oNotes = null;
            Common.GeneralNote oNote = new global::gloBilling.Common.GeneralNote();
            //validation for text box

            try
            {
                oNote = new global::gloBilling.Common.GeneralNote();
                oNote.TransactionID = _MasterTransactionID;
                oNote.TransactionLineId = 0;
                oNote.TransactionDetailID = 0;
                oNote.NoteType = NoteType.Claim_Note;
                oNote.NoteID = 0;
                oNote.NoteDate = gloDateMaster.gloDate.DateAsNumber(DateTime.Now.ToShortDateString());
                oNote.UserID = _UserID;
                oNote.StatementNoteDate = gloDateMaster.gloDate.DateAsNumber(DateTime.Now.ToShortDateString());
                oNote.NoteDescription = @"Claim resend by """ + this.UserName + @""" on """ + DateTime.Now.ToString("MM/dd/yyyy hh:mm:tt") + @""".";
                oNote.ClinicID = _ClinicID;

                oNote.dtCreatedDatetime = DateTime.Now;

                oNotes = new global::gloBilling.Common.GeneralNotes();
                oNotes.Add(oNote);

                gloCharges.SaveClaimNotes(oNotes);

            }
            catch (Exception ex)
            {
                gloAuditTrail.gloAuditTrail.ExceptionLog(ex, true);
                ex = null;

            }
            finally
            {
                oNotes.Clear();
                oNotes.Dispose();
            }


        }

        private void rbICD9_CheckedChanged(object sender, EventArgs e)
        {
            if (rbICD9.Checked == true)
            {
                rbICD9.Font = gloGlobal.clsgloFont.gFont_BOLD; //new Font("Tahoma", 9, FontStyle.Bold);
                tlsICD10CoddingRules.Visible = false;
            }
            else
            {

                rbICD9.Font = gloGlobal.clsgloFont.gFont; //new Font("Tahoma", 9, FontStyle.Regular);
                tlsICD10CoddingRules.Visible = true;
            }

            UC_gloBillingTransactionLines.IcdCodeType = (int)gloGlobal.gloICD.CodeRevision.ICD9;
        }

        private void rbICD10_CheckedChanged(object sender, EventArgs e)
        {
            if (rbICD10.Checked == true)
            {
                rbICD10.Font = gloGlobal.clsgloFont.gFont_BOLD; //new Font("Tahoma", 9, FontStyle.Bold);
                tlsICD10CoddingRules.Visible = true;
            }
            else
            {

                rbICD10.Font = gloGlobal.clsgloFont.gFont; //new Font("Tahoma", 9, FontStyle.Regular);
                tlsICD10CoddingRules.Visible = false;
            }

            UC_gloBillingTransactionLines.IcdCodeType = (int)gloGlobal.gloICD.CodeRevision.ICD10;
        }

        private void tlb_LoadExam_Click(object sender, EventArgs e)
        {
            string sMinDos = Convert.ToString(gloDateMaster.gloDate.DateAsDate((UC_gloBillingTransactionLines.GetMinDOS())));
            frmBillingPatientviewExam oPatientExam = new frmBillingPatientviewExam(_DatabaseConnectionString, this.PatientID, sMinDos, cmbBillingProvider.Text);
            oPatientExam.ShowDialog(this);
            oPatientExam.Dispose();

        }

        #region Coding Rules functionality
        private void tlsICD10CoddingRules_Click(object sender, EventArgs e)
        {
            if (rbICD10.Checked)
            {
                if (UC_gloBillingTransactionLines != null && UC_gloBillingTransactionLines.CurrentTransactionLine > 0)
                {
                    if (UC_gloBillingTransactionLines.CurrentColumn == UC_gloBillingTransactionLines.Col_DxCode1 ||
                        UC_gloBillingTransactionLines.CurrentColumn == UC_gloBillingTransactionLines.Col_DxCode2 ||
                        UC_gloBillingTransactionLines.CurrentColumn == UC_gloBillingTransactionLines.Col_DxCode3 ||
                        UC_gloBillingTransactionLines.CurrentColumn == UC_gloBillingTransactionLines.Col_DxCode4)
                    {
                        object DxCode, DxDescripton = null;
                        DxCode = UC_gloBillingTransactionLines.GetItem(UC_gloBillingTransactionLines.CurrentTransactionLine, UC_gloBillingTransactionLines.CurrentColumn);

                        switch (UC_gloBillingTransactionLines.CurrentColumn)
                        {
                            case 14:
                                DxDescripton = UC_gloBillingTransactionLines.GetItem(UC_gloBillingTransactionLines.CurrentTransactionLine, UC_gloBillingTransactionLines.Col_DxDescription1);
                                break;
                            case 17:
                                DxDescripton = UC_gloBillingTransactionLines.GetItem(UC_gloBillingTransactionLines.CurrentTransactionLine, UC_gloBillingTransactionLines.Col_DxDescription2);
                                break;
                            case 20:
                                DxDescripton = UC_gloBillingTransactionLines.GetItem(UC_gloBillingTransactionLines.CurrentTransactionLine, UC_gloBillingTransactionLines.Col_DxDescription3);
                                break;
                            case 23:
                                DxDescripton = UC_gloBillingTransactionLines.GetItem(UC_gloBillingTransactionLines.CurrentTransactionLine, UC_gloBillingTransactionLines.Col_DxDescription4);
                                break;

                        }
                        string ICDcode = "";
                        string ICDDescripton = "";
                        if (DxCode != null)
                        {
                            ICDcode = Convert.ToString(DxCode);
                        }
                        if (DxDescripton != null)
                        {
                            ICDDescripton = Convert.ToString(DxDescripton);

                        }
                        if (ICDcode != "" && ICDDescripton != "")
                        {
                            if (gloCharges.GetICDRevision(ICDcode.Trim()) == gloGlobal.gloICD.CodeRevision.ICD10.GetHashCode())
                            {
                                gloUIControlLibrary.WPFForms.frmShowCodingRules objCodingRules = new gloUIControlLibrary.WPFForms.frmShowCodingRules(ICDcode, ICDDescripton, _DatabaseConnectionString);
                                System.Windows.Interop.WindowInteropHelper interopHelper = new System.Windows.Interop.WindowInteropHelper(objCodingRules);
                                interopHelper.Owner = this.Handle;

                                objCodingRules.LoadNotes();

                                if (objCodingRules.NoData)
                                {
                                    MessageBox.Show("No notes available for code " + ICDcode, "gloEMR", MessageBoxButtons.OK, MessageBoxIcon.Information);
                                }
                                else
                                { objCodingRules.ShowDialog(); }

                                if (objCodingRules != null)
                                { objCodingRules = null; }

                                if (interopHelper != null)
                                {
                                    interopHelper = null;
                                }
                            }
                            else
                            {
                                MessageBox.Show("Please select ICD10 code or category to view coding rules.", _messageBoxCaption, MessageBoxButtons.OK, MessageBoxIcon.Information);
                            }
                        }
                        else
                        {
                            MessageBox.Show("Please select ICD10 code or category to view coding rules.", _messageBoxCaption, MessageBoxButtons.OK, MessageBoxIcon.Information);
                        }
                    }
                }
            }
        }
        #endregion

        #region Charge Rules
        private string GetInsuranceIDs()
        {
            string sReturned = string.Empty;
            StringBuilder sb = new StringBuilder();

            try
            {
                for (Int32 counter = 1; counter <= c1Insurance.Rows.Count - 1; counter++)
                {
                    if (Convert.ToString(c1Insurance.GetData(counter, COL_INSURANCERESPONSIBILITY)).Replace("\0", "") != "")
                    {
                        sb.Append(Convert.ToString(c1Insurance.GetData(counter, COL_INSURANCEID)));
                        if (counter <= c1Insurance.Rows.Count - 2)
                        { sb.Append(","); }
                    }
                }
                return sb.ToString();
            }
            catch (Exception ex)
            {
                MessageBox.Show("ERROR : " + ex.Message, _messageBoxCaption, MessageBoxButtons.OK, MessageBoxIcon.Information);
                return sb.ToString();
            }
        }

        private List<ChargeRules.Claim> GenerateClaimRuleObject()
        {
            List<ChargeRules.Claim> claims = new List<ChargeRules.Claim>();            

            string sInsuranceCompanyName = string.Empty;
            string sReferringProviderNPI = string.Empty;
            string sOrderingProviderNPI = string.Empty;
            string sSupervisingProviderNPI = string.Empty;
            string sBillingProviderNPI = string.Empty;
            string sPatientRelationshipToSubscriber = string.Empty;
            string sInsurancePlanName = string.Empty;
            string sPlanType = string.Empty;
            string sReportingCategory = string.Empty;
            string sInsCompanyReportingCategory = string.Empty;
            string sPayerID = string.Empty;
            string sInsuranceIDs = string.Empty;
            string sPriorAuthorization = string.Empty;

            TransactionInsurancePlan ResponsibleInsuranceDetails = null;
            ResponsibleInsuranceDetails = getResponsibleInsurance();

            List<ChargeRules.Insurance> lstInsurance = null;

            DataSet ds = null;
            try
            {
                lstInsurance = new List<ChargeRules.Insurance>();
                gloFacility ogloFacility = new gloFacility(_DatabaseConnectionString);
                Facility oFacility = ogloFacility.GetFacility(Convert.ToInt64(cmbFacility.SelectedValue));
                ogloFacility.Dispose();
                ogloFacility = null;

                if (ResponsibleInsuranceDetails != null)
                {
                    if (UC_gloBillingTransactionLines != null && ResponsibleInsuranceDetails.ContactID > 0)
                    {
                        TransactionLines tranLines = UC_gloBillingTransactionLines.GetLineTransactions();

                        if (tranLines != null && tranLines.Count > 0)
                        {
                            sInsuranceIDs = this.GetInsuranceIDs();

                            ds = gloCharges.ClaimRulesGetRequiredInformation(sInsuranceIDs,
                           Convert.ToInt64(cmbBillingProvider.SelectedValue),
                           Convert.ToInt64(cmbReferralProvider.SelectedValue),
                           this.PatientID);

                            DataRow dRow = ds.Tables[0].AsEnumerable()
                                       .FirstOrDefault(p => Convert.ToInt64(p["nInsuranceID"]) == ResponsibleInsuranceDetails.InsuranceID);

                            if (dRow != null)
                            {
                                sInsuranceCompanyName = Convert.ToString(dRow["InsuranceCompanyName"]);
                                sPlanType = Convert.ToString(dRow["InsurancePlanTypeDesc"]);
                                sReportingCategory = Convert.ToString(dRow["InsurancePlanReportingCategory"]);
                                sPayerID = Convert.ToString(dRow["InsurancePlanPayerID"]);

                                sPatientRelationshipToSubscriber = Convert.ToString(dRow["PatientSubscriberRelationShip"]);
                                sInsurancePlanName = Convert.ToString(dRow["InsurancePlanName"]);
                                sInsCompanyReportingCategory = Convert.ToString(dRow["InsuranceCompanyReportingCategory"]);

                            }

                            if (txtPriorAuthorizationNo.Text == "<available>")
                                sPriorAuthorization = "";
                            else
                                sPriorAuthorization = txtPriorAuthorizationNo.Text;

                            if (ds.Tables[1].Rows.Count > 0)
                            {
                                if (Convert.ToString(cmbProviderType.SelectedValue) == "DN")
                                { sReferringProviderNPI = Convert.ToString(ds.Tables[1].Rows[0]["sNPI"]); }

                                else if (Convert.ToString(cmbProviderType.SelectedValue) == "DK")
                                { sOrderingProviderNPI = Convert.ToString(ds.Tables[1].Rows[0]["sNPI"]); }

                                else
                                { sSupervisingProviderNPI = Convert.ToString(ds.Tables[1].Rows[0]["sNPI"]); }
                            }

                            if (ds.Tables[2].Rows.Count > 0) { sBillingProviderNPI = Convert.ToString(ds.Tables[2].Rows[0]["sNPI"]); }

                            foreach (DataRow elementRow in ds.Tables[0].Rows)
                            {
                                ChargeRules.Insurance insurance = new ChargeRules.Insurance();

                                insurance.InsurancePayerID = Convert.ToString(elementRow["InsurancePlanPayerID"]);
                                insurance.InsurancePlanName = Convert.ToString(elementRow["InsurancePlanName"]);
                                insurance.InsurancePlanType = Convert.ToString(elementRow["InsurancePlanTypeDesc"]);
                                insurance.InsuranceReportingCategory = Convert.ToString(elementRow["InsurancePlanReportingCategory"]);
                                insurance.InsuranceCompanyName = Convert.ToString(elementRow["InsuranceCompanyName"]); ;
                                insurance.InsuranceCompanyReportingCategory = Convert.ToString(elementRow["InsuranceCompanyReportingCategory"]);

                                insurance.ContactID = Convert.ToInt64(elementRow["nContactID"]);
                                insurance.InsuranceID = Convert.ToInt64(elementRow["nInsuranceID"]);

                                lstInsurance.Add(insurance);
                                insurance = null;
                            }
                            Claim_Facility oClaimFacility = new Claim_Facility();
                            oClaimFacility.ClaimFacility = oFacility.FacilityName;
                            oClaimFacility.FacilityState = oFacility.State;
                            oClaimFacility.FacilityTaxonomy = oFacility.TaxonomyCode;
                            oClaimFacility.AUSID = gloGlobal.gloPMGlobal.AusID;

                            oFacility.Dispose();
                            oFacility = null;


                            for (Int32 i = 0; i <= tranLines.Count - 1; i++)
                            {
                                TransactionLine tran = tranLines[i];

                                ChargeRules.Claim claim = new ChargeRules.Claim();                                
                                claim.InsuranceList.AddRange(lstInsurance);


                                for (Int32 c = 0; c <= tranLines.Count - 1; c++)
                                { 
                                    claim.CPTCodes.Add(new CPT_Code() { CPTCode = tranLines[c].CPTCode });

                                    if (!claim.ClaimDiagnosis.Any(t => t.ClaimDiagnosis == Convert.ToString(tranLines[c].Dx1Code).Trim()))
                                    {
                                        claim.ClaimDiagnosis.Add(new Claim_Diagnosis()
                                        {
                                            ClaimDiagnosis = Convert.ToString(tranLines[c].Dx1Code).Trim()
                                        });
                                    }

                                    if (!claim.ClaimDiagnosis.Any(t => t.ClaimDiagnosis == Convert.ToString(tranLines[c].Dx2Code).Trim()))
                                    {
                                        claim.ClaimDiagnosis.Add(new Claim_Diagnosis()
                                        {
                                            ClaimDiagnosis = Convert.ToString(tranLines[c].Dx2Code).Trim()
                                        });
                                    }

                                    if (!claim.ClaimDiagnosis.Any(t => t.ClaimDiagnosis == Convert.ToString(tranLines[c].Dx3Code).Trim()))
                                    {
                                        claim.ClaimDiagnosis.Add(new Claim_Diagnosis()
                                        {
                                            ClaimDiagnosis = Convert.ToString(tranLines[c].Dx3Code).Trim()
                                        });
                                    }

                                    if (!claim.ClaimDiagnosis.Any(t => t.ClaimDiagnosis == Convert.ToString(tranLines[c].Dx4Code).Trim()))
                                    {
                                        claim.ClaimDiagnosis.Add(new Claim_Diagnosis()
                                        {
                                            ClaimDiagnosis = Convert.ToString(tranLines[c].Dx4Code).Trim()
                                        });
                                    }

                                    if (!claim.ClaimModfiers.Any(t => t.ClaimModifier == Convert.ToString(tranLines[c].Mod1Code).Trim()))
                                    {
                                        claim.ClaimModfiers.Add(new Claim_Modfier()
                                        {
                                            ClaimModifier = Convert.ToString(tranLines[c].Mod1Code).Trim()
                                        });

                                    }

                                    if (!claim.ClaimModfiers.Any(t => t.ClaimModifier == Convert.ToString(tranLines[c].Mod2Code).Trim()))
                                    {
                                        claim.ClaimModfiers.Add(new Claim_Modfier()
                                        {
                                            ClaimModifier = Convert.ToString(tranLines[c].Mod2Code).Trim()
                                        });

                                    }

                                    if (!claim.ClaimModfiers.Any(t => t.ClaimModifier == Convert.ToString(tranLines[c].Mod3Code).Trim()))
                                    {
                                        claim.ClaimModfiers.Add(new Claim_Modfier()
                                        {
                                            ClaimModifier = Convert.ToString(tranLines[c].Mod3Code).Trim()
                                        });

                                    }

                                    // bool a = claim.oPropertyValueWithExistsOperator.Any(t => t.PropertyCode == "");

                                    //PropertyValueWithExistsOperator otest = new PropertyValueWithExistsOperator();
                                    //otest.PropertyCode="";
                                    //IEnumerable<PropertyValueWithExistsOperator> oPpertyValueWithExistsOperator = from PropertyValue in claim.oPropertyValueWithExistsOperator.AsEnumerable() where PropertyValue.PropertyCode == Convert.ToString("") select PropertyValue;

                                    //var test = claim.oPropertyValueWithExistsOperator.Select(t => t.PropertyCode == otest.PropertyCode);

                                    if (!claim.ClaimModfiers.Any(t => t.ClaimModifier == Convert.ToString(tranLines[c].Mod4Code).Trim()))
                                    {
                                        claim.ClaimModfiers.Add(new Claim_Modfier()
                                        {
                                            ClaimModifier = Convert.ToString(tranLines[c].Mod4Code).Trim()
                                        });

                                    }

                                    if (!claim.RenderringProviderNames.Any(t => t.RenderingProviderName == Convert.ToString(tranLines[c].RefferingProvider).Trim()))
                                    {
                                        claim.RenderringProviderNames.Add(new RenderringProvider_Name()
                                        {
                                            RenderingProviderName = Convert.ToString(tranLines[c].RefferingProvider).Trim()
                                        });

                                    }

                                    if (!claim.RenderringProviderNPIs.Any(t => t.RenderingProviderNPI == Convert.ToString(ClsRuleEngine.GetBillingProviderNPI(Convert.ToInt64(tranLines[c].RefferingProviderId))).Trim()))
                                    {
                                        claim.RenderringProviderNPIs.Add(new RenderringProvider_NPI()
                                        {
                                            RenderingProviderNPI = Convert.ToString((ClsRuleEngine.GetBillingProviderNPI(Convert.ToInt64(tranLines[c].RefferingProviderId)))).Trim()
                                        });

                                    }  
                                }

                                claim.POS = tran.POSCode;
                                claim.InsurancePayerID = sPayerID;
                                claim.InsuranceReportingCategory = sReportingCategory;
                                claim.InsuranceCompanyReportingCategory = sInsCompanyReportingCategory;
                                claim.InsurancePlanType = sPlanType;
                                claim.ClaimNumber = txtClaimNo.Text;
                                claim.PatientId = this.PatientID;

                                claim.BillingProviderName = cmbBillingProvider.Text.Trim();
                                claim.BillingProviderNPI = sBillingProviderNPI;

                                claim.InsuranceCompanyName = sInsuranceCompanyName.Trim();
                                claim.InsurancePlanName = sInsurancePlanName;

                                claim.PatientRelationshipToSubscriber = sPatientRelationshipToSubscriber;

                                if (Convert.ToString(cmbProviderType.SelectedValue) == "DN")
                                {
                                    claim.ReferringProviderName = cmbReferralProvider.Text.Trim();
                                    claim.ReferringProviderID = Convert.ToInt64(cmbReferralProvider.SelectedValue);
                                    claim.ReferringProviderNPI = sReferringProviderNPI.Trim();
                                }
                                else if (Convert.ToString(cmbProviderType.SelectedValue) == "DK")
                                {
                                    claim.OrderingProviderName = cmbReferralProvider.Text.Trim();
                                    claim.OrderingProviderID = Convert.ToInt64(cmbReferralProvider.SelectedValue);
                                    claim.OrderingProviderNPI = sOrderingProviderNPI.Trim();
                                }
                                else
                                {
                                    claim.SupervisingProviderName = cmbReferralProvider.Text.Trim();
                                    claim.SupervisingProviderID = Convert.ToInt64(cmbReferralProvider.SelectedValue);
                                    claim.SupervisingProviderNPI = sSupervisingProviderNPI.Trim();
                                }

                                if (IsValidDate(mskOnsiteDate.Text))
                                { claim.ClaimDate = Convert.ToDateTime(mskOnsiteDate.Text.ToString()); }
                                claim.ClaimDateQualifier = Convert.ToString(cmbBox14DateQualifier.SelectedValue);

                                if (IsValidDate(mskBox15Date.Text))
                                { claim.OtherClaimDate = Convert.ToDateTime(mskBox15Date.Text.ToString()); }

                                claim.OtherClaimDateQualifier = Convert.ToString(cmbBox15DateQualifier.SelectedValue);
                                claim.CPTCode = tran.CPTCode.Trim();

                                claim.Dx1Code = tran.Dx1Code.Trim();
                                claim.Dx2Code = tran.Dx2Code.Trim();
                                claim.Dx3Code = tran.Dx3Code.Trim();
                                claim.Dx4Code = tran.Dx4Code.Trim();

                                claim.Mod1Code = tran.Mod1Code.Trim();
                                claim.Mod2Code = tran.Mod2Code.Trim();
                                claim.Mod3Code = tran.Mod3Code.Trim();
                                claim.Mod4Code = tran.Mod4Code.Trim();

                                claim.Unit = tran.Unit;
                                claim.FacilityName = Convert.ToString(cmbFacility.Text).Trim();

                                claim.ChargeFromDOS = tran.DateServiceFrom;
                                claim.ChargeToDOS = tran.DateServiceTill;

                                if (IsValidDate(mskHospitaliztionFrom.Text))
                                { claim.HospitalizationFromDOS = Convert.ToDateTime(mskHospitaliztionFrom.Text.ToString()); }

                                if (IsValidDate(mskHospitaliztionTo.Text))
                                { claim.HospitalizationToDOS = Convert.ToDateTime(mskHospitaliztionTo.Text.ToString()); }

                                gloStripControl.DateOfBirthIntegers dateOfBirth = new gloStripControl.DateOfBirthIntegers();
                                dateOfBirth = oPatientControl.GetAge(oPatientControl.PatientDateOfBirth);

                                claim.AgeYears = dateOfBirth.DOBYears;
                                claim.AgeMonths = dateOfBirth.DOBMonths;
                                claim.AgeDays = dateOfBirth.DOBDays;

                                if (oPatientControl.PatientGender == "Male") { claim.PatientGender = enumGender.Male.ToString(); }
                                else if (oPatientControl.PatientGender == "Female") { claim.PatientGender = enumGender.Female.ToString(); }
                                else { claim.PatientGender = enumGender.Other.ToString(); }

                                claim.PriorAuthorization = sPriorAuthorization;
                                claim.RenderingProviderName = Convert.ToString(tran.RefferingProvider).Trim();
                                claim.RenderingProviderNPI = ClsRuleEngine.GetBillingProviderNPI(Convert.ToInt64(tran.RefferingProviderId));

                                claim.ClaimFacility = oClaimFacility;
                                claim.TransactionMasterID = 0;
                                claim.TransactionID = 0;

                                claims.Add(claim);

                                claim = null;
                            }
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show("ERROR : " + ex.Message, _messageBoxCaption, MessageBoxButtons.OK, MessageBoxIcon.Information);
            }
            finally
            {
                if (ds != null)
                {
                    ds.Dispose();
                    ds = null;
                }

                if (lstInsurance != null)
                {
                    lstInsurance.Clear();
                    lstInsurance = null;
                }
            }
            return claims;
        }

        //private Boolean ValidateRules()
        //{
        //    List<ChargeRules.Claim> ClaimsList = null;
        //    ChargeRules.BusinessOperation businessOperation = null;
        //    Boolean dlgResultReviewScren = true;
        //    try
        //    {
        //        ClaimsList = this.GenerateClaimRuleObject();
        //        businessOperation = new BusinessOperation();
        //        triggeredRuleInfo = businessOperation.EvaluateRules(ClaimsList, false);
        //        if (triggeredRuleInfo != null && triggeredRuleInfo.Count > 0)
        //        {
        //            gloUIControlLibrary.WPFForms.frmTriggeredRules frmTriggeredRules = new gloUIControlLibrary.WPFForms.frmTriggeredRules(triggeredRuleInfo);
        //            System.Windows.Interop.WindowInteropHelper _interophelper = new System.Windows.Interop.WindowInteropHelper(frmTriggeredRules);
        //            _interophelper.Owner = this.Handle;
        //            frmTriggeredRules.ShowDialog();
        //            dlgResultReviewScren = Convert.ToBoolean(frmTriggeredRules.DialogResult);
        //        }
        //        return dlgResultReviewScren;
        //    }
        //    catch (Exception ex)
        //    {
        //        gloAuditTrail.gloAuditTrail.ExceptionLog(ex, false);
        //        return false;
        //    }
        //}
        private Boolean ValidateRules()
        {
            List<ChargeRules.Claim> ClaimsList = null;
            ChargeRules.BusinessOperation businessOperation = null;
            Boolean dlgResultReviewScren = true;
            List<gloUIControlLibrary.Classes.ClaimRules.TriggeredRuleInfo> lstTriggeredRules = new List<gloUIControlLibrary.Classes.ClaimRules.TriggeredRuleInfo>();
            triggeredRuleInfoGlobal = new List<gloUIControlLibrary.Classes.ClaimRules.TriggeredRuleInfo>();
            try
            {
                ClaimsList = this.GenerateClaimRuleObject();
                if (gloGlobal.gloPMGlobal.IsCommunicationServiceEnable && Uri.IsWellFormedUriString(gloGlobal.gloPMGlobal.sCommunicationServiceURL, UriKind.Absolute) == true)
                {
                    #region "Global Rules"
                    try
                    {
                        var JSONClaimList = Newtonsoft.Json.JsonConvert.SerializeObject(ClaimsList);

                        WSHttpBinding httpsws = new WSHttpBinding("WSHttpBinding_IQCommunicatorService");
                        httpsws.Security.Mode = SecurityMode.Transport;
                        string strEPAddress = gloGlobal.gloPMGlobal.sCommunicationServiceURL;
                        EndpointAddress ep = new EndpointAddress(strEPAddress);
                        ChargeRules.QCommService.QCommunicatorServiceClient client = new ChargeRules.QCommService.QCommunicatorServiceClient(httpsws, ep);

                        string sRuleResult = client.PopulateRules(JSONClaimList);
                        triggeredRuleInfo = Newtonsoft.Json.JsonConvert.DeserializeObject<List<gloUIControlLibrary.Classes.ClaimRules.TriggeredRuleInfo>>(sRuleResult);
                        if (triggeredRuleInfo != null && triggeredRuleInfo.Count > 0)
                        {
                            foreach (var item in triggeredRuleInfo)
                            {
                                lstTriggeredRules.Add(item);
                                triggeredRuleInfoGlobal.Add(item);
                            }
                            if (triggeredRuleInfo != null && triggeredRuleInfo.Count > 0)
                            {
                                DataTable dtRule = new DataTable();

                                dtRule.Columns.Add("nRuleID");
                                dtRule.Columns.Add("sRuleName");
                                dtRule.Columns.Add("sRuleDescription");
                                dtRule.Columns.Add("nRuleType");
                                dtRule.Columns.Add("sErrorMessage");
                                dtRule.Columns.Add("sRuleCategory");

                                foreach (gloUIControlLibrary.Classes.ClaimRules.TriggeredRuleInfo oRule in triggeredRuleInfo)
                                {

                                    dtRule.Rows.Add();
                                    dtRule.Rows[dtRule.Rows.Count - 1]["nRuleID"] = oRule.RuleId;
                                    dtRule.Rows[dtRule.Rows.Count - 1]["sRuleName"] = oRule.RuleName;
                                    dtRule.Rows[dtRule.Rows.Count - 1]["sRuleDescription"] = oRule.RuleMessage;
                                    dtRule.Rows[dtRule.Rows.Count - 1]["nRuleType"] = oRule.RuleTypeInfo.GetHashCode();
                                    dtRule.Rows[dtRule.Rows.Count - 1]["sErrorMessage"] = oRule.RuleMessage;
                                    dtRule.Rows[dtRule.Rows.Count - 1]["sRuleCategory"] = oRule.RuleCategory;
                                }
                                gloCharges.SaveGlobalTriggeredRules(dtRule);
                                gloAuditTrail.gloAuditTrail.CreateAuditLog(gloAuditTrail.ActivityModule.ChargeRule, gloAuditTrail.ActivityCategory.ChargeRuleEvaluation, gloAuditTrail.ActivityType.SaveWithErrors, "Claim saved with errors", 0, _InitialTransaction.TransactionID, 0, gloAuditTrail.ActivityOutCome.Success, gloAuditTrail.SoftwareComponent.gloPM, true);

                            }
                        }
                        triggeredRuleInfo = null;
                    }
                    catch (Exception ex)
                    {
                        triggeredRuleInfo = null;
                        gloAuditTrail.gloAuditTrail.ExceptionLog(ex, false);
                    }
                    #endregion
                }

                businessOperation = new BusinessOperation();
                triggeredRuleInfo = businessOperation.EvaluateRules(ClaimsList, false);
                if (triggeredRuleInfo != null && triggeredRuleInfo.Count > 0)
                {
                    foreach (var item in triggeredRuleInfo)
                    {
                        lstTriggeredRules.Add(item);
                        triggeredRuleInfoGlobal.Add(item);
                    }
                }

                //if (triggeredRuleInfo != null && triggeredRuleInfo.Count > 0)
                //{
                //    gloUIControlLibrary.WPFForms.frmTriggeredRules frmTriggeredRules = new gloUIControlLibrary.WPFForms.frmTriggeredRules(triggeredRuleInfo);
                //    System.Windows.Interop.WindowInteropHelper _interophelper = new System.Windows.Interop.WindowInteropHelper(frmTriggeredRules);
                //    _interophelper.Owner = this.Handle;
                //    frmTriggeredRules.ShowDialog();
                //    dlgResultReviewScren = Convert.ToBoolean(frmTriggeredRules.DialogResult);
                //}
                if (lstTriggeredRules != null && lstTriggeredRules.Count > 0)
                {
                    gloUIControlLibrary.WPFForms.frmTriggeredRules frmTriggeredRules = new gloUIControlLibrary.WPFForms.frmTriggeredRules(lstTriggeredRules);
                    System.Windows.Interop.WindowInteropHelper _interophelper = new System.Windows.Interop.WindowInteropHelper(frmTriggeredRules);
                    _interophelper.Owner = this.Handle;
                    frmTriggeredRules.ShowDialog();
                    dlgResultReviewScren = Convert.ToBoolean(frmTriggeredRules.DialogResult);
                }
                return dlgResultReviewScren;
            }
            catch (Exception ex)
            {
                gloAuditTrail.gloAuditTrail.ExceptionLog(ex, false);
                return false;
            }
        }
        private Boolean IsClaimRulesEnabled()
        {

            DataTable dt = null;
            Boolean result = false;
            try
            {

                gloDatabaseLayer.DBLayer oDB = new gloDatabaseLayer.DBLayer(_DatabaseConnectionString);
                oDB.Connect(false);
                string _sqlRetrieveQuery = String.Empty;
                _sqlRetrieveQuery = "SELECT sSettingsValue As ClaimRuleEnabled FROM dbo.settings WHERE sSettingsName='bEnableclaimRule'";
                if (_sqlRetrieveQuery != "")
                {
                    oDB.Retrive_Query(_sqlRetrieveQuery, out dt);
                }
                oDB.Dispose();
                oDB = null;

                if (dt != null)
                {
                    if (dt.Rows.Count > 0)
                    {
                        result = Convert.ToBoolean(dt.Rows[0]["ClaimRuleEnabled"]);
                    }
                }

            }
            catch (Exception ex)
            {
                gloAuditTrail.gloAuditTrail.ExceptionLog(ex, false);
                MessageBox.Show(ex.Message, _messageBoxCaption, MessageBoxButtons.OK, MessageBoxIcon.Error);
                result = false;
            }
            finally
            {
                if (dt != null)
                {
                    dt.Dispose();
                    dt = null;
                }
            }
            return result;
        }

        #endregion

        private TransactionInsurancePlan getResponsibleInsurance()
        {
            Int64 _ResponsibleContactID = 0;
            DataTable _dtParty = null;
            Int16 _TempParty = 1;
            _dtParty = gloCharges.GetCurrentPartyNumber(_TransactionID, _MasterTransactionID);
            //DataTable _dtParty = GetCurrentPartyNumber();
            TransactionInsurancePlan _InsurancePlan = new TransactionInsurancePlan();
            try
            {
                if (_dtParty != null && _dtParty.Rows.Count > 0)
                {

                    for (int iCount = 1; iCount <= c1Insurance.Rows.Count - 1; iCount++)
                    {
                        if (c1Insurance.GetCellCheck(iCount, COL_SELECT_CURRENT_RESPONSIBLE_PARTY) == CheckEnum.Checked)
                        {
                            _TempParty = Convert.ToInt16(iCount);
                        }
                    }
                    //**
                }
                _dtParty = null;

                if (c1Insurance.Rows.Count > 0)
                {
                    for (int i = 1; i < c1Insurance.Rows.Count; i++)
                    {
                        if (c1Insurance.GetData(i, COL_INSURANCERESPONSIBILITY) != null && c1Insurance.GetData(i, COL_INSURANCERESPONSIBILITY).ToString().Trim().Length > 0)
                        {

                            Int16 _Party = 0;

                            if (Int16.TryParse(c1Insurance.GetData(i, COL_INSURANCERESPONSIBILITY).ToString(), out  _Party) == true)
                            {
                                if (_Party > 0)
                                {
                                    if (_TempParty == _Party)
                                    {
                                        _ResponsibleContactID = Convert.ToInt64(c1Insurance.GetData(i, COL_INSURANCECONTACTID));
                                        _InsurancePlan.ContactID = _ResponsibleContactID;
                                        _InsurancePlan.InsuranceID = Convert.ToInt64(c1Insurance.GetData(i, COL_INSURANCEID));

                                    }
                                }
                            }
                            else
                            {

                            }
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                gloAuditTrail.gloAuditTrail.ExceptionLog(ex, false);
            }
            return _InsurancePlan;
        }

        #region Patient Appointments linking with Charges

        [DefaultValue(false)]
        private bool PatientHasAppointments { get; set; }

        [DefaultValue(false)]
        private bool DeletePatientAppointments { get; set; }

        private bool ValidateAppointmentsLinkingToCharges()
        {
            bool bReturned = false;
            try
            {
                if (this.lstAppointmentIDs.Any())
                {
                    if (UC_gloBillingTransactionLines != null)
                    {
                        if (this.MorePatientAppointmentsAvailable && gloGlobal.gloPMGlobal.EnableAppointmentLinkingToCharges)
                        {
                            if (MessageBox.Show("More patient appointments are available for the DOS that are selected. Do you want to link them?", _messageBoxCaption, MessageBoxButtons.YesNo, MessageBoxIcon.Question) == System.Windows.Forms.DialogResult.Yes)
                            { bReturned = false; }
                            else { bReturned = true; }
                        }
                        else { bReturned = true; }

                        if (bReturned == true)
                        {
                            using (DataTable dtTVP = new DataTable())
                            {
                                List<Int32> lstDates = new List<Int32>();

                                long nMinimumDOS = UC_gloBillingTransactionLines.GetMinDOS();
                                long nMaximumFromDOS = UC_gloBillingTransactionLines.GetLastMaxDOS();

                                long nMaximumDOS = UC_gloBillingTransactionLines.GetMaxToDOS();
                                if (nMaximumDOS == 0 || nMaximumDOS < nMaximumFromDOS) { nMaximumDOS = nMaximumFromDOS; }

                                dtTVP.Columns.Add("nAppointmentIDs", System.Type.GetType("System.Int64"));

                                foreach (Int64 i in this.lstAppointmentIDs)
                                {
                                    DataRow dRow = dtTVP.NewRow();
                                    dRow["nAppointmentIDs"] = i;
                                    dtTVP.Rows.Add(dRow);
                                }

                                using (DataTable dtReturned = gloCharges.GetTVPAppointments(dtTVP))
                                {
                                    lstDates = dtReturned
                                      .AsEnumerable()
                                      .Select(p => gloDateMaster.gloDate.DateAsNumber(Convert.ToString(p["AppointmentDate"])))
                                      .ToList();
                                }
                                if (gloGlobal.gloPMGlobal.EnableAppointmentLinkingToCharges == true)
                                {
                                    //Case 1: Associated date is less than Service line FromDOS
                                    if ((lstDates.Any(p => p < nMinimumDOS)))
                                    { bReturned = false; }
                                    else
                                    { bReturned = true; }

                                    if (bReturned == true && nMaximumDOS > 0)
                                    {
                                        //Case 2: Associated date is more than Service line ToDOS
                                        if (lstDates.Any(p => p > nMaximumDOS))
                                        { bReturned = false; }
                                        else
                                        { bReturned = true; }
                                    }

                                    if (bReturned == true && nMaximumDOS == 0)
                                    {
                                        //Case 3: Associated date is more than Service line FromDOS
                                        if (lstDates.Any(p => p > nMaximumFromDOS))
                                        { bReturned = false; }
                                        else
                                        { bReturned = true; }
                                    }

                                    if (bReturned == false)
                                    {
                                        if (MessageBox.Show("Charge DOS are changed. Do you want to re-associate selected patient appointments?", _messageBoxCaption, MessageBoxButtons.YesNo, MessageBoxIcon.Question) == System.Windows.Forms.DialogResult.Yes)
                                        { bReturned = false; }
                                        else { bReturned = true; }
                                    }
                                }
                            }
                        }
                    }
                }
                else if (this.PatientHasAppointments && !this.lstAppointmentIDs.Any() && gloGlobal.gloPMGlobal.EnableAppointmentLinkingToCharges)
                {
                    if (MessageBox.Show("Patient has appointments that can be linked to this Charge. Do you want to link them?", _messageBoxCaption, MessageBoxButtons.YesNo, MessageBoxIcon.Question) == System.Windows.Forms.DialogResult.Yes)
                    { bReturned = false; }
                    else { bReturned = true; }
                }
                else { bReturned = true; }
            }
            catch (Exception ex)
            {
                gloAuditTrail.gloAuditTrail.ExceptionLog(ex, false);
                MessageBox.Show(ex.Message, _messageBoxCaption, MessageBoxButtons.OK, MessageBoxIcon.Error);
            }
            return bReturned;
        }

        private void btnPatientAppointments_Click(object sender, EventArgs e)
        {
            gloPMGeneral.gloAppointmentsChargesLinking.frmPatientAppointments frmPatientAppointments = null;

            DataTable dtAppointments = null;

            try
            {
                if (UC_gloBillingTransactionLines != null)
                {
                    long nMinimumDOS = UC_gloBillingTransactionLines.GetMinDOS();
                    long nMaximumDOS = UC_gloBillingTransactionLines.GetMaxToDOS();

                    long nMaximumFromDOS = UC_gloBillingTransactionLines.GetLastMaxDOS();
                    if (nMaximumDOS == 0 || nMaximumDOS < nMaximumFromDOS)
                    {
                        nMaximumDOS = nMaximumFromDOS;
                    }

                    DataTable dtTVP = new DataTable();
                    dtTVP.Columns.Add("nAppointmentIDs", System.Type.GetType("System.Int64"));

                    foreach (Int64 i in this.lstAppointmentIDs)
                    {
                        DataRow dRow = dtTVP.NewRow();
                        dRow["nAppointmentIDs"] = i;
                        dtTVP.Rows.Add(dRow);
                    }

                    dtAppointments = gloCharges.GetLinkedAppointments(PatientID, _MasterTransactionID, nMinimumDOS, nMaximumDOS, dtTVP);

                    if (dtTVP != null)
                    {
                        dtTVP.Dispose();
                        dtTVP = null;
                    }

                    if (dtAppointments != null && dtAppointments.Rows.Count > 0)
                    {
                        frmPatientAppointments = new gloPMGeneral
                           .gloAppointmentsChargesLinking.
                           frmPatientAppointments
                           (_DatabaseConnectionString, PatientID, nMinimumDOS, nMaximumDOS, this._MasterTransactionID);

                        frmPatientAppointments.AppointmentsData = dtAppointments;

                        if (this.lstAppointmentIDs.Any())
                        { foreach (Int64 element in this.lstAppointmentIDs) { frmPatientAppointments.Appointments.Add(element); } }

                        this.LoadAppointmentsInList(dtAppointments);
                        this.MorePatientAppointmentsAvailable = false;

                        frmPatientAppointments.ShowDialog(this);

                        if (frmPatientAppointments.AppointmentsSet)
                        {
                            this.lstAppointmentIDs.Clear();
                            if (frmPatientAppointments.AppointmentIDs.Any())
                            {
                                this.DeletePatientAppointments = false;
                                foreach (Int64 element in frmPatientAppointments.AppointmentIDs)
                                { if (!this.lstAppointmentIDs.Contains(element)) { this.lstAppointmentIDs.Add(element); } }
                            }
                            else
                            {
                                this.lstAppointmentIDs.Clear();
                                this.DeletePatientAppointments = true;
                            }
                        }

                        this.CheckForPriorAppointments();
                    }
                    else
                    { MessageBox.Show("No appointments were found for this patient.", _messageBoxCaption, MessageBoxButtons.OK, MessageBoxIcon.Information); }
                }
            }
            catch (Exception ex)
            {
                gloAuditTrail.gloAuditTrail.ExceptionLog(ex, false);
                MessageBox.Show(ex.Message, _messageBoxCaption, MessageBoxButtons.OK, MessageBoxIcon.Error);
            }
            finally
            {
                if (frmPatientAppointments != null)
                {
                    frmPatientAppointments.Dispose();
                    frmPatientAppointments = null;
                }

                if (dtAppointments != null)
                {
                    dtAppointments.Dispose();
                    dtAppointments = null;
                }
            }
        }

        private DataTable GetLinkedPatientAppointments()
        {
            DataTable dtReturned = null;

            try
            {
                if (UC_gloBillingTransactionLines != null)
                {
                    dtReturned = gloCharges.GetLinkedPatientAppointments(this.PatientID, _MasterTransactionID);
                }
            }
            catch (Exception ex)
            {
                gloAuditTrail.gloAuditTrail.ExceptionLog(ex, false);
                MessageBox.Show(ex.Message, _messageBoxCaption, MessageBoxButtons.OK, MessageBoxIcon.Error);
            }
            return dtReturned;
        }

        private DataTable GetPatientAppointments()
        {
            DataTable dtReturned = null;

            try
            {
                if (UC_gloBillingTransactionLines != null)
                {
                    long nMinimumDOS = UC_gloBillingTransactionLines.GetMinDOS();
                    long nMaximumDOS = UC_gloBillingTransactionLines.GetMaxToDOS();

                    long nMaximumFromDOS = UC_gloBillingTransactionLines.GetLastMaxDOS();
                    if (nMaximumDOS == 0 || nMaximumDOS < nMaximumFromDOS) { nMaximumDOS = nMaximumFromDOS; }

                    DataTable dtTVP = new DataTable();
                    dtTVP.Columns.Add("nAppointmentIDs", System.Type.GetType("System.Int64"));

                    foreach (Int64 i in this.lstAppointmentIDs)
                    {
                        DataRow dRow = dtTVP.NewRow();
                        dRow["nAppointmentIDs"] = i;
                        dtTVP.Rows.Add(dRow);
                    }

                    dtReturned = gloCharges.GetAppointments(this.PatientID, nMinimumDOS, nMaximumDOS, dtTVP);
                }
            }
            catch (Exception ex)
            {
                gloAuditTrail.gloAuditTrail.ExceptionLog(ex, false);
                MessageBox.Show(ex.Message, _messageBoxCaption, MessageBoxButtons.OK, MessageBoxIcon.Error);
            }
            return dtReturned;
        }

        private void btnClearPatientAppointments_Click(object sender, EventArgs e)
        {
            DataTable dtAppointments = null;

            try
            {
                if (this.lstAppointmentIDs.Any())
                {
                    this.lstAppointmentIDs.Clear();
                    this.ListOfPatientAppointments.Clear();
                    this.MorePatientAppointmentsAvailable = false;

                    this.DeletePatientAppointments = true;

                    dtAppointments = this.GetPatientAppointments();

                    if (dtAppointments != null && dtAppointments.Rows.Count > 0)
                    {
                        this.SetPatientAppointmentsAvailable();
                        this.PatientHasAppointments = true;
                    }
                    else
                    {
                        this.ResetPatientAppointments();
                        this.PatientHasAppointments = false;
                    }
                }
            }
            catch (Exception ex)
            {
                gloAuditTrail.gloAuditTrail.ExceptionLog(ex, false);
                MessageBox.Show(ex.Message, _messageBoxCaption, MessageBoxButtons.OK, MessageBoxIcon.Error);
            }
            finally
            {
                if (dtAppointments != null)
                {
                    dtAppointments.Dispose();
                    dtAppointments = null;
                }
            }

        }

        private void FillLinkedPatientAppointments()
        {
            DataTable dtPatientAppointments = null;

            try
            {
                dtPatientAppointments = gloCharges.GetLinkedPatientAppointments(this.PatientID, this._MasterTransactionID);

                foreach (DataRow elementRow in dtPatientAppointments.Rows)
                {
                    long nAppointmentID = Convert.ToInt64(elementRow["nAppointmentID"]);
                    this.lstAppointmentIDs.Add(nAppointmentID);
                }

                if (dtPatientAppointments.Rows.Count > 0)
                {
                    this.PatientHasAppointments = true;
                    this.SetPatientAppointmentsLinked();
                }

            }
            catch (Exception ex)
            {
                gloAuditTrail.gloAuditTrail.ExceptionLog(ex, false);
                MessageBox.Show(ex.Message, _messageBoxCaption, MessageBoxButtons.OK, MessageBoxIcon.Error);
            }
            finally
            {
                if (dtPatientAppointments != null)
                {
                    dtPatientAppointments.Dispose();
                    dtPatientAppointments = null;
                }
            }

        }

        private void FillPatientAppointments()
        {
            DataTable dtApp = null;

            try
            {
                dtApp = this.GetPatientAppointments();
                this.CheckForPriorAppointments(dtApp);
            }
            catch (Exception ex)
            {
                gloAuditTrail.gloAuditTrail.ExceptionLog(ex, false);
                MessageBox.Show(ex.Message, _messageBoxCaption, MessageBoxButtons.OK, MessageBoxIcon.Error);
            }
            finally
            {
                if (dtApp != null)
                {
                    dtApp.Dispose();
                    dtApp = null;
                }
            }

        }

        private void ResetPatientAppointments()
        {
            txtPatientAppointments.Text = "";
        }

        private void CheckForPriorAppointments()
        {
            try
            {
                if (this.lstAppointmentIDs.Any())
                { this.SetPatientAppointmentsLinked(); }
                else
                {
                    this.FillPatientAppointments();
                }
            }
            catch (Exception ex)
            {
                gloAuditTrail.gloAuditTrail.ExceptionLog(ex, false);
                MessageBox.Show(ex.Message, _messageBoxCaption, MessageBoxButtons.OK, MessageBoxIcon.Error);
            }
        }

        private void CheckForPriorAppointments(DataTable AppointmentsData)
        {
            try
            {
                if (AppointmentsData.Rows.Count > 0)
                {
                    this.PatientHasAppointments = true;
                    this.SetPatientAppointmentsAvailable();
                }
                else
                {
                    this.PatientHasAppointments = false;
                    this.ResetPatientAppointments();
                }
            }
            catch (Exception ex)
            {
                gloAuditTrail.gloAuditTrail.ExceptionLog(ex, false);
                MessageBox.Show(ex.Message, _messageBoxCaption, MessageBoxButtons.OK, MessageBoxIcon.Error);
            }
        }

        private void SetPatientAppointmentsLinked()
        {
            txtPatientAppointments.Text = "<Linked>";
            txtPatientAppointments.TextAlign = HorizontalAlignment.Center;
            txtPatientAppointments.ForeColor = Color.Maroon;
        }

        private void SetPatientAppointmentsAvailable()
        {
            txtPatientAppointments.Text = "<Available>";
            txtPatientAppointments.TextAlign = HorizontalAlignment.Center;
            txtPatientAppointments.ForeColor = Color.Maroon;
        }

        #endregion

        private void tls_btnInsurancePayment_Click(object sender, EventArgs e)
        {
            try
            {
                IsInsurancePaymentClicked = true;
                tls_btnSaveNClose_Click(sender, e);
                DataTable dtModified = null;
                dtModified = gloCharges.GetModifiyTransaction(LastnTransactionMasterId);

                if (LastnTransactionId != Convert.ToInt64(dtModified.Rows[0]["TransactionID"]) ||
                     LastnTransactionMasterId != Convert.ToInt64(dtModified.Rows[0]["TransactionMasterID"]) ||
                    LastnTransactionModifiedDate != Convert.ToDateTime(dtModified.Rows[0]["ModifyDate"]))
                {
                    string strMsg = string.Format(" Claim # " + dtModified.Rows[0]["ClaimNo"] + " already modified on another place.\n Claim will be Reloaded.");
                    MessageBox.Show(strMsg, gloGlobal.gloPMGlobal.MessageBoxCaption, System.Windows.Forms.MessageBoxButtons.OK, System.Windows.Forms.MessageBoxIcon.Information);
                    _TransactionID = Convert.ToInt64(dtModified.Rows[0]["TransactionID"]);
                   nCurrentResponsibleParty = 0;
                    ReloadTransaction();
                    _IsFormLoading = true;
                    PerformFormLoad();
                    _IsFormLoading = false;
                }

            }
            catch (Exception ex)
            {
                MessageBox.Show(ex.ToString(), gloGlobal.gloPMGlobal.MessageBoxCaption, MessageBoxButtons.OK, MessageBoxIcon.Error);
            }
        }


    }
}
