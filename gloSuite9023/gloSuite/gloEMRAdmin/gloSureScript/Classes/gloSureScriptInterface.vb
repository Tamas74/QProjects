Imports System.Xml
Imports System.IO
Imports System.Security.Cryptography
Imports System.Windows.Forms
Imports System.Text
Imports System.ServiceModel

Public Enum RefillStatus
    eApproved
    eApprovedWithChanges
    eDenied
    eDeniedWithNewRxToFollow
End Enum
Public Enum PrescriberType
    eAddPrescriber
    eAddPrescriberToLocation
End Enum
Public Class gloSureScriptInterface
    Implements IDisposable
    Public XMLFilePath As String = ""
    Private disposedValue As Boolean = False        ' To detect redundant calls
    Public SPI As String
    Public DirectAddress As String
    ' IDisposable
    ''''' added by kishor to check LunhDigitCheckAlgorithm for NPI if flase npi not pass through LunhDigitCheckAlgorithm
    Public Shared IsLunhDigitCheckAlgorithmEnble As Boolean = True
    Protected Overridable Sub Dispose(ByVal disposing As Boolean)
        If Not Me.disposedValue Then
            If disposing Then
                ' TODO: free managed resources when explicitly called
            End If

            ' TODO: free shared unmanaged resources
        End If
        Me.disposedValue = True
    End Sub
    Public StatusMessageType As String = ""
    Public MessageName As String = ""
#Region " IDisposable Support "
    ' This code added by Visual Basic to correctly implement the disposable pattern.
    Public Sub Dispose() Implements IDisposable.Dispose
        ' Do not change this code.  Put cleanup code in Dispose(ByVal disposing As Boolean) above.
        Dispose(True)
        GC.SuppressFinalize(Me)
    End Sub
#End Region
    Public Event ErrorGenerated()

    'sarika For Removing Provider validations
    Public strMessage As String = ""


#Region "Private Functions"
    ''' <summary>
    ''' Used to read reponse message generated by surescript when a NewRx or
    ''' RefillResponse messgae is posted
    ''' </summary>
    ''' <param name="strfilename"></param>
    ''' <param name="sMessageName"></param>
    ''' <remarks></remarks>
    Public Sub ReadResponse(ByVal strfilename As String, ByVal sMessageName As String)
        Try

            Dim oErrorMessage As SureScriptErrorMessage

            Select Case sMessageName

                'Case "RefillRequest"
                '    If InsertRefillPrescription() Then
                '        gloSurescriptGeneral.InformationMessage("Message has been processed")
                '    End If
                'Case "Error"
                '    oErrorMessage = New SureScriptErrorMessage
                '    If ReadFreeStandingError(oErrorMessage) Then
                '        gloSurescriptGeneral.InformationMessage("Message has been processed")
                '    End If
                Case "AddPrescriberResponse"
                    Dim oPrescriber As New Prescriber
                    If ReadAddPrescriberResponseMessage(oPrescriber, strfilename) Then
                        'gloSurescriptGeneral.InformationMessage("Message has been processed")
                    End If
                    If Not IsNothing(oPrescriber) Then
                        oPrescriber.Dispose()
                        oPrescriber = Nothing
                    End If

                Case "AddPrescriberLocationResponse"
                    Dim oPrescriber As New Prescriber
                    If ReadAddPrescriberLocationResponseMessage(oPrescriber, strfilename) Then
                        'gloSurescriptGeneral.InformationMessage("Message has been processed")
                    End If
                    If Not IsNothing(oPrescriber) Then
                        oPrescriber.Dispose()
                        oPrescriber = Nothing
                    End If
                    'UpdatePrescriberLocation
                Case "UpdatePrescriberLocationResponse"
                    Dim ostatus As New StatusMessage
                    If ReadStatusMessage(ostatus, strfilename) Then
                        'gloSurescriptGeneral.InformationMessage("Message has been processed")
                    End If
                    If Not IsNothing(ostatus) Then
                        ostatus.Dispose()
                        ostatus = Nothing
                    End If
                Case "GetPrescriberResponse"
                    ' Dim oPrescriber As New Prescriber
                    'If GetPrescriberResponse(oPrescriber, strfilename) Then

                    'End If
            End Select
        Catch ex As gloSurescriptDBException
            Throw ex
        Catch ex As GloSurescriptException
            Throw ex
        Catch ex As Exception
            Throw New GloSurescriptException(ex.Message)

        End Try
    End Sub

    Public Function ExtractXMLEpcs(ByVal cntFromDB As Object) As String
        Dim stream As MemoryStream = Nothing
        Dim content As Byte() = Nothing
        Dim oFile As System.IO.FileStream = Nothing
        Try
            If Not IsNothing(cntFromDB) Then
                content = CType(cntFromDB, Byte())
                stream = New MemoryStream(content)
                Dim strfilename As String = gloSettings.FolderSettings.AppTempFolderPath & (Format(Date.Now, "yyyyMMddhhmmssmmm") & ".xml")
                oFile = New System.IO.FileStream(strfilename, System.IO.FileMode.Create)
                'Dim xmlDoc = New XmlDocument()
                'xmlDoc.Load(stream)
                stream.WriteTo(oFile)
                oFile.Close()
                Return strfilename
            Else
                MessageBox.Show("Due to technical issue, further request can not process.  Try Later.", gloSurescriptGeneral.MessageBoxCaption, MessageBoxButtons.OK, MessageBoxIcon.Exclamation)
                Return ""
            End If
        Catch ex As Exception
            Throw New GloSurescriptException(ex.Message)
        Finally
            If Not IsNothing(stream) Then
                stream.Dispose()
                stream = Nothing
            End If
            If Not IsNothing(content) Then
                content = Nothing
            End If
            If Not IsNothing(oFile) Then
                oFile.Dispose()
                oFile = Nothing
            End If
        End Try

    End Function
    ''' <summary>
    ''' Function in use it is used to extract the binary response from
    ''' Surescript for NewRx and RefillResponse and process the same
    ''' </summary>
    ''' <param name="cntFromDB"></param>
    ''' <returns></returns>
    ''' <remarks></remarks>
    Public Function ExtractXML(ByVal cntFromDB As Object) As String
        Dim stream As MemoryStream
        Try
            If Not IsNothing(cntFromDB) Then
                Dim content As Byte() = CType(cntFromDB, Byte())
                stream = New MemoryStream(content)
                Dim strfilename As String = gloSettings.FolderSettings.AppTempFolderPath & (Format(Date.Now, "yyyyMMddhhmmssmmm") & ".xml")
                Dim oFile As New System.IO.FileStream(strfilename, System.IO.FileMode.Create)
                stream.WriteTo(oFile)
                oFile.Close()
                Dim odoc As XmlDocument = New XmlDocument
                odoc.Load(strfilename)
                Return strfilename
            Else
                Return ""
            End If
        Catch ex As Exception
            Throw New GloSurescriptException(ex.Message)
        Finally
            If Not IsNothing(stream) Then
                stream.Dispose()
                stream = Nothing
            End If
        End Try

    End Function
    Private Function GenerateFileName(ByVal eMessageType As MessageType) As String
        Dim strfilename As String = ""

        Select Case eMessageType

            Case MessageType.eError
                strfilename = "Error"
            Case MessageType.eNewRx
                strfilename = "NewRx"
            Case MessageType.eRefillRequest
                strfilename = "RefillRequest"
            Case MessageType.eRefillResponse
                strfilename = "RefillResponse"
            Case MessageType.eStatus
                strfilename = "Status"
            Case MessageType.eVerify
                strfilename = "Verify"
            Case MessageType.eCancelRx
                strfilename = "CancelRx"
        End Select
        Dim dtdate As DateTime = Date.UtcNow
        Dim strtemp As String = strfilename & dtdate.Month.ToString & dtdate.Day.ToString & dtdate.Year.ToString & dtdate.Hour.ToString & dtdate.Minute.ToString & dtdate.Second.ToString & dtdate.Millisecond.ToString


        strfilename = gloSettings.FolderSettings.AppTempFolderPath & strtemp & ".xml"
        Return strfilename
    End Function

#End Region
    ''' <summary>
    ''' Used to Read Response generated for Add Prescriber
    ''' </summary>
    ''' <param name="objPrescriber"></param>
    ''' <param name="strfilepath"></param>
    ''' <returns></returns>
    ''' <remarks></remarks>
    Public Function ReadAddPrescriberResponseMessage(ByRef objPrescriber As Prescriber, ByVal strfilepath As String) As Boolean

        Dim ds As DataSet = Nothing
        'Dim strfilepath As String = gloSurescriptGeneral.RootPath & "\VerifyNewRx.xml"
        MessageName = ""
        StatusMessageType = ""
        SPI = ""
        DirectAddress = ""
        Try
            Dim blnMessageStatus As Boolean
            ds = New DataSet
            ds.ReadXml(strfilepath)

            If Not IsNothing(ds) Then
                If ds.Tables.Count > 0 Then
                    For Each dt As DataTable In ds.Tables
                        Select Case dt.TableName.ToString
                            Case "Header"
                                For Each dtRow As DataRow In dt.Rows
                                    For Each dtcolumn As DataColumn In dt.Columns
                                        Select Case dtcolumn.ColumnName
                                            Case "From"
                                                objPrescriber.MessageFrom = dtRow(dtcolumn)
                                            Case "To"
                                                objPrescriber.MessageTo = dtRow(dtcolumn)
                                            Case "MessageID"
                                                objPrescriber.MessageID = dtRow(dtcolumn)
                                            Case "RelatesToMessageID"
                                                objPrescriber.RelatesToMessageId = dtRow(dtcolumn)
                                            Case "SentTime"
                                                objPrescriber.DateTimeStamp = dtRow(dtcolumn)
                                                objPrescriber.DateReceived = Date.Now
                                        End Select
                                    Next
                                Next
                            Case "AddPrescriberResponse"
                                objPrescriber.MessageName = "AddPrResponse"
                                StatusMessageType = "AddPrResponse"
                                blnMessageStatus = True
                            Case "Approved"
                                blnMessageStatus = True
                            Case "Error"
                                blnMessageStatus = False
                            Case "Identification"
                                For Each dtRow As DataRow In dt.Rows
                                    For Each dtcolumn As DataColumn In dt.Columns
                                        Select Case dtcolumn.ColumnName
                                            Case "SPI"
                                                objPrescriber.PrescriberID = dtRow(dtcolumn)
                                                SPI = objPrescriber.PrescriberID

                                            Case "DirectAddress"
                                                objPrescriber.DirectAddress = dtRow(dtcolumn)
                                                DirectAddress = objPrescriber.DirectAddress
                                        End Select
                                    Next
                                Next
                        End Select
                    Next
                End If
            End If

            If blnMessageStatus = False Then
                Dim ostatus As New StatusMessage
                Try
                    ReadStatusMessage(ostatus, strfilepath)
                    Exit Function
                Catch ex As Exception
                    Return False
                Finally
                    If Not IsNothing(ostatus) Then
                        ostatus.Dispose()
                        ostatus = Nothing
                    End If
                End Try
            End If
            Dim strmessage As New System.Text.StringBuilder

            If Not IsNothing(objPrescriber.PrescriberID) Then
                strmessage.Append(vbCrLf)
                strmessage.Append("SPI : " & objPrescriber.PrescriberID)
                strmessage.Append(vbCrLf)
                strmessage.Append("Prescriber Added Successfully")
            End If

            StatusMessageType = strmessage.ToString
            Dim objSureScriptDBLayer As New gloSureScriptDBLayer

            If objSureScriptDBLayer.InsertintoMessageTransaction(CType(objPrescriber, SureScriptMessage)) Then


            End If

            If Not IsNothing(objSureScriptDBLayer) Then
                objSureScriptDBLayer.Dispose()
                objSureScriptDBLayer = Nothing
            End If

            Return True
        Catch ex As gloSurescriptDBException
            Throw ex
        Catch ex As GloSurescriptException
            Throw ex
        Catch ex As Exception
            Throw New GloSurescriptException(ex.Message)
        Finally

        End Try
    End Function
    ''' <summary>
    ''' Used to Read Response generated for Add Prescriber Location
    ''' </summary>
    ''' <param name="objPrescriber"></param>
    ''' <param name="strfilepath"></param>
    ''' <returns></returns>
    ''' <remarks></remarks>
    Public Function ReadAddPrescriberLocationResponseMessage(ByVal objPrescriber As Prescriber, ByVal strfilepath As String) As Boolean
        ''Dim areader As XmlReader
        Dim ds As DataSet
        'Dim strfilepath As String = gloSurescriptGeneral.RootPath & "\VerifyNewRx.xml"
        MessageName = ""
        StatusMessageType = ""
        Try
            '' areader = XmlReader.Create(strfilepath)
            Dim blnMessageStatus As Boolean

            ds = New DataSet
            ds.ReadXml(strfilepath)
            If Not IsNothing(ds) Then
                If ds.Tables.Count > 0 Then
                    For Each dt As DataTable In ds.Tables
                        Select Case dt.TableName.ToString
                            Case "Header"
                                For Each dtRow As DataRow In dt.Rows
                                    For Each dtcolumn As DataColumn In dt.Columns
                                        Select Case dtcolumn.ColumnName
                                            Case "From"
                                                objPrescriber.MessageFrom = dtRow(dtcolumn)
                                            Case "To"
                                                objPrescriber.MessageTo = dtRow(dtcolumn)
                                            Case "MessageID"
                                                objPrescriber.MessageID = dtRow(dtcolumn)
                                            Case "RelatesToMessageID"
                                                objPrescriber.RelatesToMessageId = dtRow(dtcolumn)
                                            Case "SentTime"
                                                objPrescriber.DateTimeStamp = dtRow(dtcolumn)
                                                objPrescriber.DateReceived = Date.Now
                                        End Select
                                    Next
                                Next
                            Case "AddPrescriberResponse"
                                objPrescriber.MessageName = "AddPrResponse"
                                StatusMessageType = "AddPrResponse"
                                blnMessageStatus = True
                            Case "Approved"
                                blnMessageStatus = True
                            Case "Error"
                                blnMessageStatus = False
                            Case "Identification"
                                For Each dtRow As DataRow In dt.Rows
                                    For Each dtcolumn As DataColumn In dt.Columns
                                        Select Case dtcolumn.ColumnName
                                            Case "SPI"
                                                objPrescriber.PrescriberID = dtRow(dtcolumn)
                                                SPI = objPrescriber.PrescriberID

                                            Case "DirectAddress"
                                                objPrescriber.DirectAddress = dtRow(dtcolumn)
                                                DirectAddress = objPrescriber.DirectAddress
                                        End Select
                                    Next
                                Next
                        End Select
                    Next
                End If
            End If

            If blnMessageStatus = False Then
                Dim ostatus As New StatusMessage
                Try
                    ReadStatusMessage(ostatus, strfilepath)
                    Exit Function
                Catch ex As Exception
                    Return False
                Finally
                    If Not IsNothing(ostatus) Then
                        ostatus.Dispose()
                        ostatus = Nothing
                    End If
                End Try
            End If

            Dim strmessage As New System.Text.StringBuilder

            If Not IsNothing(objPrescriber.PrescriberID) Then
                strmessage.Append(vbCrLf)
                strmessage.Append("SPI : " & objPrescriber.PrescriberID)
                strmessage.Append(vbCrLf)
                strmessage.Append("Prescriber Location Added Successfully")
            End If

            StatusMessageType = strmessage.ToString
            Dim objSureScriptDBLayer As New gloSureScriptDBLayer

            If objSureScriptDBLayer.InsertintoMessageTransaction(CType(objPrescriber, SureScriptMessage)) Then


            End If

            If Not IsNothing(objSureScriptDBLayer) Then
                objSureScriptDBLayer.Dispose()
                objSureScriptDBLayer = Nothing
            End If

            Return True
        Catch ex As gloSurescriptDBException
            Throw ex
        Catch ex As GloSurescriptException
            Throw ex
        Catch ex As Exception
            Throw New GloSurescriptException(ex.Message)
        Finally

        End Try
    End Function
    ''' <summary>
    ''' Reads the response message generated for Update Prescriber Location Response
    ''' </summary>
    ''' <param name="objPrescriber"></param>
    ''' <param name="strfilepath"></param>
    ''' <returns></returns>
    ''' <remarks></remarks>
    Public Function ReadUpdatePrescriberLocationResponseMessage(ByRef objPrescriber As Prescriber, ByVal strfilepath As String) As Boolean
        Dim areader As XmlReader
        'Dim strfilepath As String = gloSurescriptGeneral.RootPath & "\VerifyNewRx.xml"
        MessageName = ""
        StatusMessageType = ""
        Try
            areader = XmlReader.Create(strfilepath)
            While areader.Read

                Dim blnIsRefillsQualifier As Boolean = False

                If areader.NodeType = XmlNodeType.Element Then
                    Select Case areader.Name
                        'this is the message id for the Refillrequest that shall go in the MessageId field
                        Case "From"
                            objPrescriber.MessageFrom = areader.ReadInnerXml
                        Case "To"
                            objPrescriber.MessageTo = areader.ReadInnerXml
                        Case "MessageID"
                            objPrescriber.MessageID = areader.ReadInnerXml
                        Case "RelatesToMessageID"
                            objPrescriber.RelatesToMessageId = areader.ReadInnerXml
                        Case "SentTime"
                            objPrescriber.DateTimeStamp = areader.ReadInnerXml
                            objPrescriber.DateReceived = Date.Now
                        Case "UpdatePrescriberLocationResponse"
                            objPrescriber.MessageName = "UpdatePrLocResponse"
                            StatusMessageType = "UpdatePrLocResponse"
                        Case "SPI"
                            objPrescriber.PrescriberID = areader.ReadInnerXml
                    End Select

                End If
            End While

            Dim strmessage As New System.Text.StringBuilder

            If Not IsNothing(objPrescriber.PrescriberID) Then
                strmessage.Append(vbCrLf)
                strmessage.Append("SPI : " & objPrescriber.PrescriberID)
                strmessage.Append(vbCrLf)
                strmessage.Append("Prescriber Location Updated Successfully")
            End If

            StatusMessageType = strmessage.ToString
            Dim objSureScriptDBLayer As New gloSureScriptDBLayer

            If objSureScriptDBLayer.InsertintoMessageTransaction(CType(objPrescriber, SureScriptMessage)) Then


            End If

            If Not IsNothing(objSureScriptDBLayer) Then
                objSureScriptDBLayer.Dispose()
                objSureScriptDBLayer = Nothing
            End If

            Return True
        Catch ex As gloSurescriptDBException
            Throw ex
        Catch ex As GloSurescriptException
            Throw ex
        Catch ex As Exception
            Throw New GloSurescriptException(ex.Message)
        Finally
            If Not IsNothing(areader) Then
                areader = Nothing
            End If
        End Try
    End Function

    ''' <summary>
    ''' Used to read status message generated by surescript
    ''' </summary>
    ''' <param name="objErrorMessage"></param>
    ''' <param name="strfilepath"></param>
    ''' <returns></returns>
    ''' <remarks></remarks>
    Public Function ReadStatusMessage(ByVal objErrorMessage As StatusMessage, ByVal strfilepath As String) As Boolean
        ''Dim areader As XmlReader
        Dim ds As DataSet
        MessageName = ""
        StatusMessageType = ""
        SPI = ""
        DirectAddress = ""
        Try
            ds = New DataSet
            ds.ReadXml(strfilepath)

            If Not IsNothing(ds) Then
                If ds.Tables.Count > 0 Then
                    For Each dt As DataTable In ds.Tables
                        Select Case dt.TableName.ToString
                            Case "Header"
                                For Each dtRow As DataRow In dt.Rows
                                    For Each dtcolumn As DataColumn In dt.Columns
                                        Select Case dtcolumn.ColumnName
                                            Case "From"
                                                objErrorMessage.MessageFrom = dtRow(dtcolumn)
                                            Case "To"
                                                objErrorMessage.MessageTo = dtRow(dtcolumn)
                                            Case "MessageID"
                                                objErrorMessage.MessageID = dtRow(dtcolumn)
                                            Case "RelatesToMessageID"
                                                objErrorMessage.RelatesToMessageId = dtRow(dtcolumn)
                                            Case "SentTime"
                                                objErrorMessage.DateTimeStamp = dtRow(dtcolumn)
                                                objErrorMessage.DateReceived = Date.Now
                                        End Select
                                    Next
                                Next
                            Case "Error"
                                For Each dtRow As DataRow In dt.Rows
                                    For Each dtcolumn As DataColumn In dt.Columns
                                        Select Case dtcolumn.ColumnName
                                            Case "Code"
                                                objErrorMessage.MessageName = "Error"
                                                objErrorMessage.StatusCode = dtRow(dtcolumn)
                                                If objErrorMessage.StatusCode = "000" Or objErrorMessage.StatusCode = "010" Then
                                                    MessageName = "Status"
                                                Else
                                                    MessageName = "Error"
                                                End If
                                            Case "Description"
                                                objErrorMessage.Description = dtRow(dtcolumn)
                                        End Select
                                    Next
                                Next
                            Case "Status"

                                For Each dtRow As DataRow In dt.Rows
                                    For Each dtcolumn As DataColumn In dt.Columns
                                        Select Case dtcolumn.ColumnName
                                            Case "Code"
                                                objErrorMessage.MessageName = "Status"
                                                StatusMessageType = "Status"
                                                objErrorMessage.StatusCode = dtRow(dtcolumn)
                                                If objErrorMessage.StatusCode = "000" Or objErrorMessage.StatusCode = "010" Then
                                                    MessageName = "Status"
                                                Else
                                                    MessageName = "Error"
                                                End If
                                            Case "Description"
                                                objErrorMessage.Description = dtRow(dtcolumn)
                                        End Select
                                    Next
                                Next

                                'MessageName = "Status"
                            Case "Verify"
                                If objErrorMessage.MessageID = "0" Then
                                    objErrorMessage.MessageName = "Status"
                                Else
                                    objErrorMessage.MessageName = "Verify"
                                End If
                        End Select


                    Next
                End If
            End If

            Dim strmessage As New System.Text.StringBuilder
            If objErrorMessage.MessageName = "Status" Then
                strmessage.Append("Prescriber Transaction has been Processed successfully")
                If Not IsNothing(objErrorMessage.StatusCode) Then
                    strmessage.Append(vbCrLf)
                    strmessage.Append("Status code: " & objErrorMessage.StatusCode)
                    strmessage.Append(vbCrLf)
                    If objErrorMessage.StatusCode = "000" Then
                        strmessage.Append("Description :Transaction successful-acknowledged by receiver")
                    ElseIf objErrorMessage.StatusCode = "010" Then
                        strmessage.Append("Description :Transaction successful-accepted by receiver")
                    End If
                End If
                If Not IsNothing(objErrorMessage.Description) Then
                    strmessage.Append(vbCrLf)
                    strmessage.Append(objErrorMessage.Description)
                End If
            ElseIf objErrorMessage.MessageName = "Verify" Then
                strmessage.Append("Prescriber Transaction has been Processed successfully")
                If Not IsNothing(objErrorMessage.StatusCode) Then
                    strmessage.Append(vbCrLf)
                    strmessage.Append("Status code: " & objErrorMessage.StatusCode)
                End If
                If Not IsNothing(objErrorMessage.Description) Then
                    strmessage.Append(vbCrLf)
                    strmessage.Append(objErrorMessage.Description)
                End If
            ElseIf objErrorMessage.MessageName = "Error" Then
                strmessage.Append("Prescriber Transaction could not be posted successfully")
                If Not IsNothing(objErrorMessage.StatusCode) Then
                    strmessage.Append(vbCrLf)
                    strmessage.Append("Error code: " & objErrorMessage.StatusCode)
                End If
                If Not IsNothing(objErrorMessage.Description) Then
                    strmessage.Append(vbCrLf)
                    strmessage.Append("Error Description: " & objErrorMessage.Description)
                End If
            End If
            StatusMessageType = strmessage.ToString
            Dim objSureScriptDBLayer As New gloSureScriptDBLayer

            'Insert acknowledgement details in acknowledgement transaction
            If objSureScriptDBLayer.InsertAcknowledgements(objErrorMessage, True) Then
                'Insert data in message transaction
                If objSureScriptDBLayer.InsertintoMessageTransaction(CType(objErrorMessage, SureScriptMessage)) Then

                End If
            End If
            If Not IsNothing(objSureScriptDBLayer) Then
                objSureScriptDBLayer.Dispose()
                objSureScriptDBLayer = Nothing
            End If
            Return True
        Catch ex As gloSurescriptDBException
            Throw ex
        Catch ex As GloSurescriptException
            Throw ex
        Catch ex As Exception
            Throw New GloSurescriptException(ex.Message)
        Finally
            
        End Try
    End Function
    ''' <summary>
    ''' Used to Add New Prescriber to the Surescript network
    ''' </summary>
    ''' <param name="objPrescriber"></param>
    ''' <returns></returns>
    ''' <remarks></remarks>
    Public Function GenerateAddPrescriber(ByRef objPrescriber As Prescriber) As Boolean
        ''sarika for removing provider validations
        'strMessage = ValidateAddPrescriber(objPrescriber)
        'If strMessage.Length > 0 Then
        '    Exit Function
        'End If

        ''---
        Dim strInfo As New System.Text.StringBuilder
        Dim strfilepath As String = GenerateFileName(MessageType.eRefillResponse)
        XMLFilePath = strfilepath
        Dim xmlwriter As XmlTextWriter = Nothing
        Try
            If File.Exists(strfilepath) Then
                File.Delete(strfilepath)
            End If

            xmlwriter = New XmlTextWriter(strfilepath, ASCIIEncoding.UTF8)

            Dim dtdate As DateTime = DateTime.UtcNow
            Dim strdate As String = Format(dtdate, "yyyy-MM-dd")
            Dim strtime As String = Format(dtdate, "hh:mm:ss")
            Dim strmillisec As String = Format(dtdate, "mmm")

            Dim strtemp As String = dtdate.Month.ToString & dtdate.Day.ToString & dtdate.Year.ToString & dtdate.Hour.ToString & dtdate.Minute.ToString & dtdate.Second.ToString & dtdate.Millisecond.ToString

            'Dim strUTCFormat As String = dtdate.Year.ToString & "-" & "0" & dtdate.Month.ToString & "-" & dtdate.Day.ToString & "T" & dtdate.Hour.ToString & ":" & dtdate.Minute.ToString & ":" & dtdate.Second.ToString & ".0Z"
            ''strUTCFormat = strdate & "T" & strtime & ":0Z"
            'strUTCFormat = getUTCDate(DateTime.Now)
            Dim strUTCFormat As String = DateTime.UtcNow.ToString("yyyy-MM-ddTHH:mm:ss.FZ")
            Dim _blnGenerateDirectoryUploadFile As Boolean = False

            'Added condition for generating file depending on version
            Dim sPortalID As String = String.Empty

            If gloSurescriptGeneral.blnStagingServer Then
                ''staging get the respective portal id against 1 common staging account ID i.e. 338
                If gloSurescriptGeneral.blnNCPDP10dot6 = True Then
                    _blnGenerateDirectoryUploadFile = GenerateDirectoryUploadFile4dot5(xmlwriter, strtemp, strUTCFormat, "AddPr" & strtemp)
                    sPortalID = gloSurescriptGeneral.sSTAGING10DOT6PORTALID '' "2273"
                Else
                    _blnGenerateDirectoryUploadFile = GenerateDirectoryUploadFile(xmlwriter, strtemp, strUTCFormat, "AddPr" & strtemp)
                    sPortalID = gloSurescriptGeneral.sSTAGING8DOT1PORTALID ''  "422"
                End If
            Else ''production get the respective portal id against 1 common production account ID i.e. 261
                If gloSurescriptGeneral.blnNCPDP10dot6 = True Then
                    _blnGenerateDirectoryUploadFile = GenerateDirectoryUploadFile4dot5(xmlwriter, strtemp, strUTCFormat, "AddPr" & strtemp)
                    sPortalID = gloSurescriptGeneral.sSSPRODUCTION10dot6PORTALID ''1018
                Else
                    _blnGenerateDirectoryUploadFile = GenerateDirectoryUploadFile(xmlwriter, strtemp, strUTCFormat, "AddPr" & strtemp)
                    sPortalID = gloSurescriptGeneral.sSSPRODUCTIONPORTALID ''  "264"
                End If
            End If
           

            If _blnGenerateDirectoryUploadFile Then
                If gloSurescriptGeneral.blnStagingServer Then
                    objPrescriber.MessageFrom = "mailto:GLOSTM.dp@surescripts.com"
                Else ''setting is production
                    If gloSurescriptGeneral.blnNCPDP10dot6 = True Then
                        objPrescriber.MessageFrom = "mailto:GLOS45.dp@surescripts.com"
                    Else
                        objPrescriber.MessageFrom = "mailto:GLOSTM.dp@surescripts.com" ''as per old activation document it is GLOSTM
                    End If
                End If


                objPrescriber.MessageTo = "SSSDIR.dp@surescripts.com"
                objPrescriber.MessageID = "AddPr" & strtemp
                objPrescriber.RelatesToMessageId = ""
                objPrescriber.TransactionID = objPrescriber.ProviderID
                objPrescriber.MessageName = "AddPr"
                objPrescriber.DateReceived = Date.Now
                objPrescriber.DateTimeStamp = strUTCFormat

                xmlwriter.WriteStartElement("Body")

                xmlwriter.WriteStartElement("AddPrescriber")
                xmlwriter.WriteStartElement("Prescriber")
                xmlwriter.WriteStartElement("DirectoryInformation")
                If gloSurescriptGeneral.blnStagingServer Then
                    xmlwriter.WriteElementString("PortalID", sPortalID) 'The PortalID
                    xmlwriter.WriteElementString("AccountID", gloSurescriptGeneral.sSTAGING10DOT6ACCOUNTID) '' The staging AccountID i.e "338" is same for 10.6 and 8.1 message only we have 2 different portal ids
                Else
                    xmlwriter.WriteElementString("PortalID", sPortalID) 'The PortalID "264"
                    xmlwriter.WriteElementString("AccountID", gloSurescriptGeneral.sSSPRODUCTIONACCOUNTID) 'The production AccountID i.e "261" is same for 10.6 and 8.1 message only we have 2 different portal ids
                End If

                xmlwriter.WriteElementString("BackupPortalID", "-1") 'The AccountID 
                xmlwriter.WriteElementString("ServiceLevel", objPrescriber.ServiceLevel) 'The service level

                If objPrescriber.IsDirectMessageEnabled Then
                    ''Every Network Address assigned to a Net2Net Rest Recipient MUST have exactly 1 routable entity 
                    ''registered with a DefaultLocationServiceLevel for the ClinicalMessage and ClinicalEvent Service Levels.
                    xmlwriter.WriteElementString("DefaultLocationServiceLevel", objPrescriber.ServiceLevel) 'DefaultLocationServiceLevel
                End If


                xmlwriter.WriteElementString("ActiveStartTime", objPrescriber.ActiveStartDate)
                xmlwriter.WriteElementString("ActiveEndTime", objPrescriber.ActiveEndDate)



                '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
                ''first check 10.6 is ON
                ''then check if direct messaging is available, if yes then only generate the ADVSAVE tag.
                '<UseCases>
                '         <UseCase>
                '                   <UseCaseCode>ADVSAVE</UseCaseCode>
                '         </UseCase>
                '</UseCases>
                If gloSurescriptGeneral.blnNCPDP10dot6 = True Then
                    If objPrescriber.IsDirectMessageEnabled Then
                        ''Start USECASES
                        xmlwriter.WriteStartElement("UseCases")
                        ''Start UseCase
                        xmlwriter.WriteStartElement("UseCase")
                        xmlwriter.WriteElementString("UseCaseCode", "ADVSAVE")
                        xmlwriter.WriteEndElement() ''End UseCase element
                        xmlwriter.WriteEndElement() ''End USECASES element
                    End If
                End If
                '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

                xmlwriter.WriteEndElement() 'End DirectoryInformation element

                xmlwriter.WriteStartElement("Identification")

                If gloSurescriptGeneral.blnNCPDP10dot6 = True Then

                    If objPrescriber.ProviderSSN <> "" Then ''added in SS 10.6
                        xmlwriter.WriteElementString("SocialSecurity", objPrescriber.ProviderSSN)
                    End If

                    '''''since NPI is mandatory for 10.6 NPI number is present and create the XML tag with NPI number which will be used for prescriber registration.
                    xmlwriter.WriteElementString("NPI", objPrescriber.NPI)
                    ''''added by kishor if ControlledSubstance enable  
                    If objPrescriber.IsControlledSubstance Then
                        xmlwriter.WriteElementString("DEANumber", objPrescriber.DEA)
                    End If
                    If objPrescriber.IsDirectMessageEnabled Then '128 is EPA
                        xmlwriter.WriteElementString("DirectAddress", objPrescriber.DirectAddress) 'objPrescriber.PrescriberName.FirstName & objPrescriber.PrescriberName.LastName & "@glostream.cert.direct-ci.com")
                    End If

                Else
                    '''''DEA number case (0005460) - if DEA number is not there then if NPI number is present then user can send the NPI number
                    If objPrescriber.DEA <> "" Then
                        xmlwriter.WriteElementString("DEANumber", objPrescriber.DEA)
                    Else
                        '''''check whether the NPI number is present and create the XML tag with NPI number
                        xmlwriter.WriteElementString("NPI", objPrescriber.NPI)
                    End If
                End If


                xmlwriter.WriteEndElement() 'End Identification Element

                If objPrescriber.ClinicName.Trim.Length > 0 Then
                    xmlwriter.WriteElementString("ClinicName", objPrescriber.ClinicName)
                End If

                xmlwriter.WriteStartElement("Name")

                If objPrescriber.PrescriberName.LastName.Length > 35 Then
                    strInfo.Append("Last Name(35), ")
                    xmlwriter.WriteElementString("LastName", objPrescriber.PrescriberName.LastName.Substring(0, 35))
                Else
                    xmlwriter.WriteElementString("LastName", objPrescriber.PrescriberName.LastName)
                End If
                If objPrescriber.PrescriberName.FirstName.Length > 35 Then
                    strInfo.Append("First Name(35), ")
                    xmlwriter.WriteElementString("FirstName", objPrescriber.PrescriberName.FirstName.Substring(0, 35))
                Else
                    xmlwriter.WriteElementString("FirstName", objPrescriber.PrescriberName.FirstName)
                End If

                If objPrescriber.PrescriberName.Suffix.Trim <> "" Then
                    If objPrescriber.PrescriberName.Suffix.Length > 10 Then
                        strInfo.Append("Suffix(10), ")
                        xmlwriter.WriteElementString("Suffix", objPrescriber.PrescriberName.Suffix.Substring(0, 10))
                    Else
                        xmlwriter.WriteElementString("Suffix", objPrescriber.PrescriberName.Suffix)
                    End If
                End If
                
                If objPrescriber.PrescriberName.Prefix.Trim <> "" Then
                    If objPrescriber.PrescriberName.Prefix.Length > 10 Then
                        strInfo.Append("Prefix(10), ")
                        xmlwriter.WriteElementString("Prefix", objPrescriber.PrescriberName.Prefix.Substring(0, 10))
                    Else
                        xmlwriter.WriteElementString("Prefix", objPrescriber.PrescriberName.Prefix)
                    End If
                End If

                'xmlwriter.WriteElementString("LastName", objPrescriber.PrescriberName.LastName.Substring(0, 35))
                'xmlwriter.WriteElementString("FirstName", objPrescriber.PrescriberName.FirstName.Substring(0, 35))
                xmlwriter.WriteEndElement() 'End Name Element

                xmlwriter.WriteStartElement("Specialty")
                xmlwriter.WriteElementString("Qualifier", "AM")
                xmlwriter.WriteElementString("SpecialtyCode", "FP")
                xmlwriter.WriteEndElement() 'End Specialty Element

                xmlwriter.WriteStartElement("Address")
                If objPrescriber.PrescriberAddress.Address1.Length > 35 Then
                    strInfo.Append("Address Line 1(35), ")
                    xmlwriter.WriteElementString("AddressLine1", objPrescriber.PrescriberAddress.Address1.Substring(0, 35))
                Else
                    xmlwriter.WriteElementString("AddressLine1", objPrescriber.PrescriberAddress.Address1)
                End If

                If objPrescriber.PrescriberAddress.Address2.Trim <> "" Then
                    If objPrescriber.PrescriberAddress.Address2.Length > 35 Then
                        strInfo.Append("Address Line 2(35), ")
                        xmlwriter.WriteElementString("AddressLine2", objPrescriber.PrescriberAddress.Address2.Substring(0, 35))
                    Else
                        xmlwriter.WriteElementString("AddressLine2", objPrescriber.PrescriberAddress.Address2)
                    End If
                End If
                'xmlwriter.WriteElementString("AddressLine1", objPrescriber.PrescriberAddress.Address1.Substring(0, 35))
                'If objPrescriber.PrescriberAddress.Address2.Trim.Length > 0 Then
                '    xmlwriter.WriteElementString("AddressLine2", objPrescriber.PrescriberAddress.Address2.Substring(0, 35))
                'End If

                If objPrescriber.PrescriberAddress.City.Length > 35 Then
                    strInfo.Append("City(35), ")
                    xmlwriter.WriteElementString("City", objPrescriber.PrescriberAddress.City.Substring(0, 35))
                Else
                    xmlwriter.WriteElementString("City", objPrescriber.PrescriberAddress.City)
                End If
                'xmlwriter.WriteElementString("City", objPrescriber.PrescriberAddress.City.Substring(0, 35))
                xmlwriter.WriteElementString("State", objPrescriber.PrescriberAddress.State)
                xmlwriter.WriteElementString("ZipCode", objPrescriber.PrescriberAddress.Zip)
                xmlwriter.WriteEndElement() 'End Address Element

                xmlwriter.WriteStartElement("PhoneNumbers")

                xmlwriter.WriteStartElement("Phone")
                xmlwriter.WriteElementString("Number", GetPhoneNumber(objPrescriber.PrescriberPhone.Phone))
                xmlwriter.WriteElementString("Qualifier", "TE")
                xmlwriter.WriteEndElement() 'End Phone Element

                xmlwriter.WriteStartElement("Phone")
                xmlwriter.WriteElementString("Number", GetPhoneNumber(objPrescriber.PrescriberPhone.Fax))
                xmlwriter.WriteElementString("Qualifier", "FX")
                xmlwriter.WriteEndElement() 'End Phone Element

                xmlwriter.WriteEndElement() 'End PhoneNumbers element
                xmlwriter.WriteEndElement()  'End Prescriber element

                xmlwriter.WriteEndElement()  'End AddPrescriber Element
                xmlwriter.WriteEndElement()  'End Body Element
                xmlwriter.WriteEndElement()  'End Message Element
                xmlwriter.WriteEndDocument() 'End Document
                xmlwriter.Close()            'Close xml file

                ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
                Dim strMessage As String = ""
                If strInfo.ToString.Length > 0 Then
                    If strInfo.ToString.Trim <> "" Then
                        If strInfo.ToString.Trim.EndsWith(",") Then
                            strMessage = strInfo.ToString.Trim.Substring(0, Len(strInfo.ToString.Trim) - 1)
                            strInfo = New System.Text.StringBuilder()
                            strInfo.Append(strMessage)
                        End If
                    End If
                End If
                If strInfo.ToString.Length > 0 Then
                    If MessageBox.Show("Following data fields exceed number of characters allowed in x12 standards and will therefore be truncated before sending to Surescripts and PBM’s (Allowed characters are shown in parenthesis) " & vbNewLine & vbNewLine & vbNewLine & strInfo.ToString & vbNewLine & vbNewLine & vbNewLine & "Do you want to continue?", "gloEMR", MessageBoxButtons.YesNo, MessageBoxIcon.Information) = Windows.Forms.DialogResult.No Then
                        Return False
                        Exit Function
                    End If
                End If

                ''code added to validate file against xsd (only for testing purpose)
                'Try
                '    Dim Xsettings As New XmlReaderSettings()
                '    Xsettings.Schemas.Add(Nothing, IIf(gloSurescriptGeneral.blnNCPDP10dot6 = True, "C:\\SS_Directories_4_4_External.xsd", "C:\\SS_Directories_4_2_External.xsd"))
                '    Xsettings.ValidationType = ValidationType.Schema

                '    Dim document As New XmlDocument()
                '    document.Load(strfilepath)

                '    Dim reader As XmlReader = XmlReader.Create(New StringReader(document.InnerXml), Xsettings)


                '    While reader.Read()


                '    End While
                'Catch e As Exception
                '    MessageBox.Show(e.Message.ToString())
                'End Try
                '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''


                'Once the message has been created post the message to Surescript N/w
                'Surescript n/w shall send a status message immediately,read the status
                'message.
                'strfilepath = "E:\Developer Working Folder\gloCCHIT2007\gloEMRAdmin\gloEMRAdmin\bin\Temp\SampleTestMessage.xml"
                Dim strfilename As String = ""
                Dim NoOfAttempt As Integer = 1
                While (NoOfAttempt <= 5)
                    strfilename = ExtractXML(gloSurescriptGeneral.ConvertFiletoBinary(strfilepath))
                    If strfilename <> "" Then
                        Exit While
                    Else
                        NoOfAttempt = NoOfAttempt + 1
                    End If
                End While

                If strfilename <> "" Then
                    ReadResponse(strfilename, "AddPrescriberResponse")
                    'Once the RefillResponse is generated now generate a FreeStanding verify message
                    'to inform surescript that RefillRequest has been processed successfully
                    Dim oSurescriptDBLayer As New gloSureScriptDBLayer
                    oSurescriptDBLayer.InsertintoMessageTransaction(CType(objPrescriber, SureScriptMessage))
                Else
                    Return False
                End If

            End If

            Return True

        Catch ex As gloSurescriptDBException
            If ex.Message.Contains("Data at the root level is invalid.") Then
                System.Windows.Forms.MessageBox.Show("Invalid User or Password", "gloEMR", System.Windows.Forms.MessageBoxButtons.OK, Windows.Forms.MessageBoxIcon.Error)
            Else
                gloSurescriptGeneral.ErrorMessage(ex.Message)
            End If
        Catch ex As GloSurescriptException
            If ex.Message.Contains("Data at the root level is invalid.") Then
                System.Windows.Forms.MessageBox.Show("Invalid User or Password", "gloEMR", System.Windows.Forms.MessageBoxButtons.OK, Windows.Forms.MessageBoxIcon.Error)
            Else
                gloSurescriptGeneral.ErrorMessage(ex.Message)
            End If
        Catch ex As Exception
            Throw New GloSurescriptException(ex.Message)
        Finally
            If Not IsNothing(strInfo) Then
                strInfo = Nothing
            End If
        End Try
        'End If
    End Function

    Public Function getUTCDate(ByVal dtactivedate As DateTime) As String
        Dim oUTCTime As DateTime
        Dim localZone As TimeZone = TimeZone.CurrentTimeZone
        oUTCTime = localZone.ToUniversalTime(dtactivedate)

        Dim dtdate As DateTime = oUTCTime
        Dim strdate As String = Format(dtdate, "yyyy-MM-dd")
        Dim strtime As String = Format(dtdate, "hh:mm:ss")
        Dim strUTCFormat As String = dtdate.Year.ToString & "-" & "0" & dtdate.Month.ToString & "-" & dtdate.Day.ToString & "T" & dtdate.Hour.ToString & ":" & dtdate.Minute.ToString & ":" & dtdate.Second.ToString & ".0Z"
        strUTCFormat = strdate & "T" & strtime & ".0Z"
        Return strUTCFormat
    End Function
    ''' <summary>
    ''' Used to add Prescriber Location for existing Prescriber
    ''' </summary>
    ''' <param name="objPrescriber"></param>
    ''' <returns></returns>
    ''' <remarks></remarks>
    Public Function GenerateAddPrescriberLocation(ByRef objPrescriber As Prescriber) As Boolean
        'sarika for removing provider validations
        'strMessage = ValidateAddPrescriberLocation(objPrescriber)
        '--
        Dim strfilepath As String = GenerateFileName(MessageType.eRefillResponse)
        XMLFilePath = strfilepath
        Dim xmlwriter As XmlTextWriter = Nothing
        Dim strInfo As New System.Text.StringBuilder
        Try
            If File.Exists(strfilepath) Then
                File.Delete(strfilepath)
            End If
            xmlwriter = New XmlTextWriter(strfilepath, Nothing)



            Dim dtdate As DateTime = Date.UtcNow
            Dim strdate As String = Format(dtdate, "yyyy-MM-dd")
            Dim strtime As String = Format(dtdate, "hh:mm:ss")
            Dim strmillisec As String = Format(dtdate, "mmm")
            Dim strtemp As String = dtdate.Month.ToString & dtdate.Day.ToString & dtdate.Year.ToString & dtdate.Hour.ToString & dtdate.Minute.ToString & dtdate.Second.ToString & dtdate.Millisecond.ToString

            'Dim strUTCFormat As String = dtdate.Year.ToString & "-" & "0" & dtdate.Month.ToString & "-" & dtdate.Day.ToString & "T" & dtdate.Hour.ToString & ":" & dtdate.Minute.ToString & ":" & dtdate.Second.ToString & ".0Z"
            'strUTCFormat = strdate & "T" & strtime & ".0Z"
            Dim strUTCFormat As String = DateTime.UtcNow.ToString("yyyy-MM-ddTHH:mm:ss.FZ")
            Dim _blnGenerateDirectoryUploadFile As Boolean = False

            'Added condition for generating file depending on version
            Dim sPortalID As String = String.Empty

            If gloSurescriptGeneral.blnStagingServer Then
                ''staging get the respective portal id against 1 common staging account ID i.e. 338
                If gloSurescriptGeneral.blnNCPDP10dot6 = True Then
                    _blnGenerateDirectoryUploadFile = GenerateDirectoryUploadFile4dot5(xmlwriter, strtemp, strUTCFormat, "AddPrLoc" & strtemp)
                    sPortalID = gloSurescriptGeneral.sSTAGING10DOT6PORTALID '' "2273"
                Else
                    _blnGenerateDirectoryUploadFile = GenerateDirectoryUploadFile(xmlwriter, strtemp, strUTCFormat, "AddPrLoc" & strtemp)
                    sPortalID = gloSurescriptGeneral.sSTAGING8DOT1PORTALID ''  "422"
                End If
            Else ''production get the respective portal id against 1 common production account ID i.e. 261
                If gloSurescriptGeneral.blnNCPDP10dot6 = True Then
                    _blnGenerateDirectoryUploadFile = GenerateDirectoryUploadFile4dot5(xmlwriter, strtemp, strUTCFormat, "AddPrLoc" & strtemp)
                    sPortalID = gloSurescriptGeneral.sSSPRODUCTION10dot6PORTALID ''1018
                Else
                    _blnGenerateDirectoryUploadFile = GenerateDirectoryUploadFile(xmlwriter, strtemp, strUTCFormat, "AddPrLoc" & strtemp)
                    sPortalID = gloSurescriptGeneral.sSSPRODUCTIONPORTALID ''  "264"
                End If
            End If

            If _blnGenerateDirectoryUploadFile Then
                If gloSurescriptGeneral.blnStagingServer Then
                    objPrescriber.MessageFrom = "mailto:GLOSTM.dp@surescripts.com"
                Else ''setting is production
                    If gloSurescriptGeneral.blnNCPDP10dot6 = True Then
                        objPrescriber.MessageFrom = "mailto:GLOS45.dp@surescripts.com"
                    Else
                        objPrescriber.MessageFrom = "mailto:GLOSTM.dp@surescripts.com" ''as per old activation document it is GLOSTM
                    End If
                End If
                objPrescriber.MessageTo = "SSSDIR.dp@surescripts.com"
                objPrescriber.MessageID = "AddPrLoc" & strtemp
                objPrescriber.TransactionID = objPrescriber.ProviderID
                objPrescriber.RelatesToMessageId = ""
                objPrescriber.MessageName = "AddPrLoc"
                objPrescriber.DateReceived = Date.Now
                objPrescriber.DateTimeStamp = strUTCFormat

                xmlwriter.WriteStartElement("Body")

                xmlwriter.WriteStartElement("AddPrescriberLocation")
                xmlwriter.WriteStartElement("Prescriber")
                xmlwriter.WriteStartElement("DirectoryInformation")

                If gloSurescriptGeneral.blnStagingServer Then
                    xmlwriter.WriteElementString("PortalID", sPortalID) 'The PortalID
                    xmlwriter.WriteElementString("AccountID", gloSurescriptGeneral.sSTAGING10DOT6ACCOUNTID) '' The staging AccountID i.e "338" is same for 10.6 and 8.1 message only we have 2 different portal ids
                Else
                    xmlwriter.WriteElementString("PortalID", sPortalID) 'The PortalID "264"
                    xmlwriter.WriteElementString("AccountID", gloSurescriptGeneral.sSSPRODUCTIONACCOUNTID) 'The production AccountID i.e "261" is same for 10.6 and 8.1 message only we have 2 different portal ids
                End If

                xmlwriter.WriteElementString("ServiceLevel", objPrescriber.ServiceLevel) 'The service level

                If objPrescriber.IsDirectMessageEnabled Then
                    ''Every Network Address assigned to a Net2Net Rest Recipient MUST have exactly 1 routable entity 
                    ''registered with a DefaultLocationServiceLevel for the ClinicalMessage and ClinicalEvent Service Levels.
                    xmlwriter.WriteElementString("DefaultLocationServiceLevel", objPrescriber.ServiceLevel) 'DefaultLocationServiceLevel
                End If

                xmlwriter.WriteElementString("ActiveStartTime", objPrescriber.ActiveStartDate)
                xmlwriter.WriteElementString("ActiveEndTime", objPrescriber.ActiveEndDate)


                '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
                ''first check 10.6 is ON
                ''then check if direct messaging is available, if yes then only generate the ADVSAVE tag.
                '<UseCases>
                '         <UseCase>
                '                   <UseCaseCode>ADVSAVE</UseCaseCode>
                '         </UseCase>
                '</UseCases>
                If gloSurescriptGeneral.blnNCPDP10dot6 = True Then
                    If objPrescriber.IsDirectMessageEnabled Then
                        ''Start USECASES
                        xmlwriter.WriteStartElement("UseCases")
                        ''Start UseCase
                        xmlwriter.WriteStartElement("UseCase")
                        xmlwriter.WriteElementString("UseCaseCode", "ADVSAVE")
                        xmlwriter.WriteEndElement() ''End UseCase element
                        xmlwriter.WriteEndElement() ''End USECASES element
                    End If
                End If

                xmlwriter.WriteEndElement() 'End DirectoryInformation element

                xmlwriter.WriteStartElement("Identification")

                If gloSurescriptGeneral.blnNCPDP10dot6 = True Then
                    If objPrescriber.ProviderSSN <> "" Then ''added in SS 10.6
                        xmlwriter.WriteElementString("SocialSecurity", objPrescriber.ProviderSSN)
                    End If
                    '''''since NPI is mandatory for 10.6 NPI number is present and create the XML tag with NPI number which will be used for prescriber registration.
                    xmlwriter.WriteElementString("NPI", objPrescriber.NPI)
                    ''''added by kishor if ControlledSubstance enable  
                    If objPrescriber.IsControlledSubstance Then
                        xmlwriter.WriteElementString("DEANumber", objPrescriber.DEA)
                    End If
                    If objPrescriber.IsDirectMessageEnabled Then
                        xmlwriter.WriteElementString("DirectAddress", objPrescriber.DirectAddress) 'objPrescriber.PrescriberName.FirstName & objPrescriber.PrescriberName.LastName & "@glostream.cert.direct-ci.com")
                    End If
                Else
                    '''''DEA number case (0005460) - if DEA number is not there then if NPI number is present then user can send the NPI number
                    If objPrescriber.DEA <> "" Then
                        xmlwriter.WriteElementString("DEANumber", objPrescriber.DEA)
                    Else
                        '''''check whether the NPI number is present and create the XML tag with NPI number
                        xmlwriter.WriteElementString("NPI", objPrescriber.NPI)
                    End If
                End If

                xmlwriter.WriteElementString("SPI", objPrescriber.PrescriberID)
                xmlwriter.WriteEndElement() 'End Identification Element

                If objPrescriber.ClinicName.Trim.Length > 0 Then
                    xmlwriter.WriteElementString("ClinicName", objPrescriber.ClinicName)
                End If

                xmlwriter.WriteStartElement("Name")
                If objPrescriber.PrescriberName.LastName.Length > 35 Then
                    strInfo.Append("Last Name(35), ")
                    xmlwriter.WriteElementString("LastName", objPrescriber.PrescriberName.LastName.Substring(0, 35))
                Else
                    xmlwriter.WriteElementString("LastName", objPrescriber.PrescriberName.LastName)
                End If
                If objPrescriber.PrescriberName.FirstName.Length > 35 Then
                    strInfo.Append("First Name(35), ")
                    xmlwriter.WriteElementString("FirstName", objPrescriber.PrescriberName.FirstName.Substring(0, 35))
                Else
                    xmlwriter.WriteElementString("FirstName", objPrescriber.PrescriberName.FirstName)
                End If

                'xmlwriter.WriteElementString("LastName", objPrescriber.PrescriberName.LastName.Substring(0, 35))
                'xmlwriter.WriteElementString("FirstName", objPrescriber.PrescriberName.FirstName.Substring(0, 35))
                xmlwriter.WriteEndElement() 'End Name Element

                xmlwriter.WriteStartElement("Specialty")
                xmlwriter.WriteElementString("Qualifier", "AM")
                xmlwriter.WriteElementString("SpecialtyCode", "FP")
                xmlwriter.WriteEndElement() 'End Specialty Element

                xmlwriter.WriteStartElement("Address")
                If objPrescriber.PrescriberAddress.Address1.Length > 35 Then
                    strInfo.Append("Address Line 1(35), ")
                    xmlwriter.WriteElementString("Address Line 1", objPrescriber.PrescriberAddress.Address1.Substring(0, 35))
                Else
                    xmlwriter.WriteElementString("AddressLine1", objPrescriber.PrescriberAddress.Address1)
                End If
                If objPrescriber.PrescriberAddress.Address2.Length > 35 Then
                    strInfo.Append("Address Line 2(35), ")
                    xmlwriter.WriteElementString("Address Line 2", objPrescriber.PrescriberAddress.Address2.Substring(0, 35))
                Else
                    xmlwriter.WriteElementString("AddressLine2", objPrescriber.PrescriberAddress.Address2)
                End If
                'xmlwriter.WriteElementString("AddressLine1", objPrescriber.PrescriberAddress.Address1.Substring(0, 35))
                'If objPrescriber.PrescriberAddress.Address2.Trim.Length > 0 Then
                '    xmlwriter.WriteElementString("AddressLine2", objPrescriber.PrescriberAddress.Address2.Substring(0, 35))
                'End If

                If objPrescriber.PrescriberAddress.City.Length > 35 Then
                    strInfo.Append("City(35), ")
                    xmlwriter.WriteElementString("City", objPrescriber.PrescriberAddress.City.Substring(0, 35))
                Else
                    xmlwriter.WriteElementString("City", objPrescriber.PrescriberAddress.City)
                End If
                'xmlwriter.WriteElementString("City", objPrescriber.PrescriberAddress.City.Substring(0, 35))
                xmlwriter.WriteElementString("State", objPrescriber.PrescriberAddress.State)
                xmlwriter.WriteElementString("ZipCode", objPrescriber.PrescriberAddress.Zip)
                xmlwriter.WriteEndElement() 'End Address Element

                xmlwriter.WriteStartElement("PhoneNumbers")

                xmlwriter.WriteStartElement("Phone")
                xmlwriter.WriteElementString("Number", GetPhoneNumber(objPrescriber.PrescriberPhone.Phone))
                xmlwriter.WriteElementString("Qualifier", "TE")
                xmlwriter.WriteEndElement() 'End Phone Element

                ''this case was done in 7040 dev support team, later on after discussion of SS team it was decided to integrate the changes in 7031 on 21 Aug 2013.
                ''Bug #54171: problem 000496
                '' change number to fax number, to solve error of same phone number and fax number is going previously
                xmlwriter.WriteStartElement("Phone")
                xmlwriter.WriteElementString("Number", GetPhoneNumber(objPrescriber.PrescriberPhone.Fax))
                xmlwriter.WriteElementString("Qualifier", "FX")
                xmlwriter.WriteEndElement() 'End Phone Element

                xmlwriter.WriteEndElement() 'End PhoneNumbers element
                xmlwriter.WriteEndElement()  'End Prescriber element

                xmlwriter.WriteEndElement()  'End AddPrescriber Element
                xmlwriter.WriteEndElement()  'End Body Element
                xmlwriter.WriteEndElement()  'End Message Element
                xmlwriter.WriteEndDocument() 'End Document
                xmlwriter.Close()            'Close xml file

                Dim strMessage As String = ""
                If strInfo.ToString.Length > 0 Then
                    If strInfo.ToString.Trim <> "" Then
                        If strInfo.ToString.Trim.EndsWith(",") Then
                            strMessage = strInfo.ToString.Trim.Substring(0, Len(strInfo.ToString.Trim) - 1)
                            strInfo = New System.Text.StringBuilder()
                            strInfo.Append(strMessage)
                        End If
                    End If
                End If
                If strInfo.ToString.Length > 0 Then
                    If MessageBox.Show("Following data fields exceed number of characters allowed in x12 standards and will therefore be truncated before sending to Surescripts and PBM’s (Allowed characters are shown in parenthesis) " & vbNewLine & vbNewLine & vbNewLine & strInfo.ToString & vbNewLine & vbNewLine & vbNewLine & "Do you want to continue?", "gloEMR", MessageBoxButtons.YesNo, MessageBoxIcon.Information) = Windows.Forms.DialogResult.No Then
                        Return False
                        Exit Function
                    End If
                End If

                'Once the message has been created post the message to Surescript N/w
                'Surescript n/w shall send a status message immediately,read the status
                'message.
                Dim strfilename As String = ""
                Dim NoOfAttempt As Integer = 1
                While (NoOfAttempt <= 5)
                    strfilename = ExtractXML(gloSurescriptGeneral.ConvertFiletoBinary(strfilepath))
                    If strfilename <> "" Then
                        Exit While
                    Else
                        NoOfAttempt = NoOfAttempt + 1
                    End If
                End While


                If strfilename <> "" Then
                    ReadResponse(strfilename, "AddPrescriberLocationResponse")
                    'Once the RefillResponse is generated now generate a FreeStanding verify message
                    'to inform surescript that RefillRequest has been processed successfully
                    Dim oSurescriptDBLayer As New gloSureScriptDBLayer
                    oSurescriptDBLayer.InsertintoMessageTransaction(CType(objPrescriber, SureScriptMessage))
                Else
                    Return False
                End If


            End If
            Return True

        Catch ex As gloSurescriptDBException
            gloSurescriptGeneral.ErrorMessage(ex.Message)
        Catch ex As GloSurescriptException
            gloSurescriptGeneral.ErrorMessage(ex.Message)
        Catch ex As Exception
            Throw New GloSurescriptException(ex.Message)
        Finally
            If Not IsNothing(strInfo) Then
                strInfo = Nothing
            End If
        End Try
        'End If
    End Function


    ''' <summary>
    ''' Used to Update Existing Prescriber
    ''' </summary>
    ''' <param name="objPrescriber"></param>
    ''' <returns></returns>
    ''' <remarks></remarks>
    Public Function GenerateUpdatePrescriberLocation(ByVal objPrescriber As Prescriber) As Boolean
        'sarika for removing provider validations
        '    strMessage = ValidateAddPrescriberLocation(objPrescriber)
        '--
        Dim strInfo As New System.Text.StringBuilder
        Dim strfilepath As String = GenerateFileName(MessageType.eRefillResponse)
        XMLFilePath = strfilepath
        Dim xmlwriter As XmlTextWriter = Nothing
        Try
            If File.Exists(strfilepath) Then
                File.Delete(strfilepath)
            End If
            xmlwriter = New XmlTextWriter(strfilepath, Nothing)



            Dim dtdate As DateTime = Date.UtcNow
            Dim strdate As String = Format(dtdate, "yyyy-MM-dd")
            Dim strtime As String = Format(dtdate, "hh:mm:ss")
            Dim strmillisec As String = Format(dtdate, "mmm")
            Dim strtemp As String = dtdate.Month.ToString & dtdate.Day.ToString & dtdate.Year.ToString & dtdate.Hour.ToString & dtdate.Minute.ToString & dtdate.Second.ToString & dtdate.Millisecond.ToString

            'Dim strUTCFormat As String = dtdate.Year.ToString & "-" & "0" & dtdate.Month.ToString & "-" & dtdate.Day.ToString & "T" & dtdate.Hour.ToString & ":" & dtdate.Minute.ToString & ":" & dtdate.Second.ToString & ".0Z"
            'strUTCFormat = strdate & "T" & strtime & ".0Z"
            Dim strUTCFormat As String = DateTime.UtcNow.ToString("yyyy-MM-ddTHH:mm:ss.FZ")
            Dim _blnGenerateDirectoryUploadFile As Boolean = False

            'Added condition for generating file depending on version
            Dim sPortalID As String = String.Empty

            If gloSurescriptGeneral.blnStagingServer Then
                ''staging get the respective portal id against 1 common staging account ID i.e. 338
                If gloSurescriptGeneral.blnNCPDP10dot6 = True Then
                    _blnGenerateDirectoryUploadFile = GenerateDirectoryUploadFile4dot5(xmlwriter, strtemp, strUTCFormat, "UpPrLoc" & strtemp)
                    sPortalID = gloSurescriptGeneral.sSTAGING10DOT6PORTALID '' "2273"
                Else
                    _blnGenerateDirectoryUploadFile = GenerateDirectoryUploadFile(xmlwriter, strtemp, strUTCFormat, "UpPrLoc" & strtemp)
                    sPortalID = gloSurescriptGeneral.sSTAGING8DOT1PORTALID ''  "422"
                End If
            Else ''production get the respective portal id against 1 common production account ID i.e. 261
                If gloSurescriptGeneral.blnNCPDP10dot6 = True Then
                    _blnGenerateDirectoryUploadFile = GenerateDirectoryUploadFile4dot5(xmlwriter, strtemp, strUTCFormat, "UpPrLoc" & strtemp)
                    sPortalID = gloSurescriptGeneral.sSSPRODUCTION10dot6PORTALID ''1018
                Else
                    _blnGenerateDirectoryUploadFile = GenerateDirectoryUploadFile(xmlwriter, strtemp, strUTCFormat, "UpPrLoc" & strtemp)
                    sPortalID = gloSurescriptGeneral.sSSPRODUCTIONPORTALID ''  "264"
                End If
            End If

            If _blnGenerateDirectoryUploadFile Then
                If gloSurescriptGeneral.blnStagingServer Then
                    objPrescriber.MessageFrom = "mailto:GLOSTM.dp@surescripts.com"
                Else ''setting is production
                    If gloSurescriptGeneral.blnNCPDP10dot6 = True Then
                        objPrescriber.MessageFrom = "mailto:GLOS45.dp@surescripts.com"
                    Else
                        objPrescriber.MessageFrom = "mailto:GLOSTM.dp@surescripts.com" ''as per old activation document it is GLOSTM
                    End If
                End If
                objPrescriber.MessageTo = "SSSDIR.dp@surescripts.com"
                objPrescriber.MessageID = "UpPrLoc" & strtemp
                objPrescriber.TransactionID = objPrescriber.ProviderID
                objPrescriber.RelatesToMessageId = ""

                objPrescriber.MessageName = "UpdatePrLoc"
                objPrescriber.DateReceived = Date.Now
                objPrescriber.DateTimeStamp = strUTCFormat

                xmlwriter.WriteStartElement("Body")

                xmlwriter.WriteStartElement("UpdatePrescriberLocation")
                xmlwriter.WriteStartElement("Prescriber")
                xmlwriter.WriteStartElement("DirectoryInformation")

                If gloSurescriptGeneral.blnStagingServer Then
                    xmlwriter.WriteElementString("PortalID", sPortalID) 'The PortalID
                    xmlwriter.WriteElementString("AccountID", gloSurescriptGeneral.sSTAGING10DOT6ACCOUNTID) '' The staging AccountID i.e "338" is same for 10.6 and 8.1 message only we have 2 different portal ids
                Else
                    xmlwriter.WriteElementString("PortalID", sPortalID) 'The PortalID "264"
                    xmlwriter.WriteElementString("AccountID", gloSurescriptGeneral.sSSPRODUCTIONACCOUNTID) 'The production AccountID i.e "261" is same for 10.6 and 8.1 message only we have 2 different portal ids
                End If

                xmlwriter.WriteElementString("ServiceLevel", objPrescriber.ServiceLevel) 'The service level

                If objPrescriber.IsDirectMessageEnabled Then
                    ''Every Network Address assigned to a Net2Net Rest Recipient MUST have exactly 1 routable entity 
                    ''registered with a DefaultLocationServiceLevel for the ClinicalMessage and ClinicalEvent Service Levels.
                    xmlwriter.WriteElementString("DefaultLocationServiceLevel", objPrescriber.ServiceLevel) 'DefaultLocationServiceLevel
                End If

                xmlwriter.WriteElementString("ActiveStartTime", objPrescriber.ActiveStartDate)
                xmlwriter.WriteElementString("ActiveEndTime", objPrescriber.ActiveEndDate)

                '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
                ''first check 10.6 is ON
                ''then check if direct messaging is available, if yes then only generate the ADVSAVE tag.
                '<UseCases>
                '         <UseCase>
                '                   <UseCaseCode>ADVSAVE</UseCaseCode>
                '         </UseCase>
                '</UseCases>
                If gloSurescriptGeneral.blnNCPDP10dot6 = True Then
                    If objPrescriber.IsDirectMessageEnabled Then
                        ''Start USECASES
                        xmlwriter.WriteStartElement("UseCases")
                        ''Start UseCase
                        xmlwriter.WriteStartElement("UseCase")
                        xmlwriter.WriteElementString("UseCaseCode", "ADVSAVE")
                        xmlwriter.WriteEndElement() ''End UseCase element
                        xmlwriter.WriteEndElement() ''End USECASES element
                    End If
                End If

                xmlwriter.WriteEndElement() 'End DirectoryInformation element

                xmlwriter.WriteStartElement("Identification")

                If gloSurescriptGeneral.blnNCPDP10dot6 = True Then
                    If objPrescriber.ProviderSSN <> "" Then ''added in SS 10.6
                        xmlwriter.WriteElementString("SocialSecurity", objPrescriber.ProviderSSN)
                    End If

                    '''''since NPI is mandatory for 10.6 NPI number is present and create the XML tag with NPI number which will be used for prescriber registration.
                    xmlwriter.WriteElementString("NPI", objPrescriber.NPI)
                    ''''added by kishor if ControlledSubstance enable  
                    If objPrescriber.IsControlledSubstance Then
                        xmlwriter.WriteElementString("DEANumber", objPrescriber.DEA)
                    End If
                    If objPrescriber.IsDirectMessageEnabled Then
                        xmlwriter.WriteElementString("DirectAddress", objPrescriber.DirectAddress) 'objPrescriber.PrescriberName.FirstName & objPrescriber.PrescriberName.LastName & "@glostream.cert.direct-ci.com")
                    End If
                Else
                    '''''DEA number case (0005460) - if DEA number is not there then if NPI number is present then user can send the NPI number
                    If objPrescriber.DEA <> "" Then
                        xmlwriter.WriteElementString("DEANumber", objPrescriber.DEA)
                    Else
                        '''''check whether the NPI number is present and create the XML tag with NPI number
                        xmlwriter.WriteElementString("NPI", objPrescriber.NPI)
                    End If
                End If

                xmlwriter.WriteElementString("SPI", objPrescriber.PrescriberID)
                xmlwriter.WriteEndElement() 'End Identification Element

                If objPrescriber.ClinicName.Trim.Length > 0 Then
                    xmlwriter.WriteElementString("ClinicName", objPrescriber.ClinicName)
                End If

                xmlwriter.WriteStartElement("Name")

                If objPrescriber.PrescriberName.LastName.Length > 35 Then
                    strInfo.Append("Last Name(35), ")
                    xmlwriter.WriteElementString("LastName", objPrescriber.PrescriberName.LastName.Substring(0, 35))
                Else
                    xmlwriter.WriteElementString("LastName", objPrescriber.PrescriberName.LastName)
                End If
                If objPrescriber.PrescriberName.FirstName.Length > 35 Then
                    strInfo.Append("First Name(35), ")
                    xmlwriter.WriteElementString("FirstName", objPrescriber.PrescriberName.FirstName.Substring(0, 35))
                Else
                    xmlwriter.WriteElementString("FirstName", objPrescriber.PrescriberName.FirstName)
                End If
                'xmlwriter.WriteElementString("LastName", objPrescriber.PrescriberName.LastName.Substring(0, 35))
                'xmlwriter.WriteElementString("FirstName", objPrescriber.PrescriberName.FirstName.Substring(0, 35))
                xmlwriter.WriteEndElement() 'End Name Element

                xmlwriter.WriteStartElement("Address")

                If objPrescriber.PrescriberAddress.Address1.Length > 35 Then
                    strInfo.Append("Address Line 1(35), ")
                    xmlwriter.WriteElementString("AddressLine1", objPrescriber.PrescriberAddress.Address1.Substring(0, 35))
                Else
                    xmlwriter.WriteElementString("AddressLine1", objPrescriber.PrescriberAddress.Address1)
                End If
                If objPrescriber.PrescriberAddress.Address2.Length > 35 Then
                    strInfo.Append("Address Line 2(35), ")
                    xmlwriter.WriteElementString("AddressLine2", objPrescriber.PrescriberAddress.Address2.Substring(0, 35))
                Else
                    xmlwriter.WriteElementString("AddressLine2", objPrescriber.PrescriberAddress.Address2)
                End If
                'xmlwriter.WriteElementString("AddressLine1", objPrescriber.PrescriberAddress.Address1.Substring(0, 35))
                'If objPrescriber.PrescriberAddress.Address2.Trim.Length > 0 Then
                '    xmlwriter.WriteElementString("AddressLine2", objPrescriber.PrescriberAddress.Address2.Substring(0, 35))
                'End If

                If objPrescriber.PrescriberAddress.City.Length > 35 Then
                    strInfo.Append("City(35), ")
                    xmlwriter.WriteElementString("City", objPrescriber.PrescriberAddress.City.Substring(0, 35))
                Else
                    xmlwriter.WriteElementString("City", objPrescriber.PrescriberAddress.City)
                End If
                'xmlwriter.WriteElementString("City", objPrescriber.PrescriberAddress.City.Substring(0, 35))

                xmlwriter.WriteElementString("State", objPrescriber.PrescriberAddress.State)
                xmlwriter.WriteElementString("ZipCode", objPrescriber.PrescriberAddress.Zip)
                xmlwriter.WriteEndElement() 'End Address Element

                xmlwriter.WriteStartElement("PhoneNumbers")

                xmlwriter.WriteStartElement("Phone")
                xmlwriter.WriteElementString("Number", GetPhoneNumber(objPrescriber.PrescriberPhone.Phone))
                xmlwriter.WriteElementString("Qualifier", "TE")
                xmlwriter.WriteEndElement() 'End Phone Element

                ''this case was done in 7040 dev support team, later on after discussion of SS team it was decided to integrate the changes in 7031 on 21 Aug 2013.
                'Bug #54171: problem 00014740
                '' change number to fax number, to solve error of same phone number and fax number is going previously
                xmlwriter.WriteStartElement("Phone")
                xmlwriter.WriteElementString("Number", GetPhoneNumber(objPrescriber.PrescriberPhone.Fax))
                xmlwriter.WriteElementString("Qualifier", "FX")
                xmlwriter.WriteEndElement() 'End Phone Element

                xmlwriter.WriteEndElement() 'End PhoneNumbers element
                xmlwriter.WriteEndElement()  'End Prescriber element

                xmlwriter.WriteEndElement()  'End AddPrescriber Element
                xmlwriter.WriteEndElement()  'End Body Element
                xmlwriter.WriteEndElement()  'End Message Element
                xmlwriter.WriteEndDocument() 'End Document
                xmlwriter.Close()            'Close xml file

                Dim strMessage As String = ""
                If strInfo.ToString.Length > 0 Then
                    If strInfo.ToString.Trim <> "" Then
                        If strInfo.ToString.Trim.EndsWith(",") Then
                            strMessage = strInfo.ToString.Trim.Substring(0, Len(strInfo.ToString.Trim) - 1)
                            strInfo = New System.Text.StringBuilder()
                            strInfo.Append(strMessage)
                        End If
                    End If
                End If
                If strInfo.ToString.Length > 0 Then
                    'If MessageBox.Show(strMessage & vbCrLf & "Do you want to continue?", "gloEMR", MessageBoxButtons.YesNo, MessageBoxIcon.Information) = Windows.Forms.DialogResult.No Then
                    If MessageBox.Show("Following data fields exceed number of characters allowed in x12 standards and will therefore be truncated before sending to Surescripts and PBM’s (Allowed characters are shown in parenthesis) " & vbNewLine & vbNewLine & vbNewLine & strInfo.ToString & vbNewLine & vbNewLine & vbNewLine & "Do you want to continue?", "gloEMR", MessageBoxButtons.YesNo, MessageBoxIcon.Information) = Windows.Forms.DialogResult.No Then
                        Return False
                        Exit Function
                    End If
                End If

                'Once the message has been created post the message to Surescript N/w
                'Surescript n/w shall send a status message immediately,read the status
                'message.
                Dim strfilename As String = ExtractXML(gloSurescriptGeneral.ConvertFiletoBinary(strfilepath))
                If strfilename <> "" Then
                    ReadResponse(strfilename, "UpdatePrescriberLocationResponse")
                    'Once the RefillResponse is generated now generate a FreeStanding verify message
                    'to inform surescript that RefillRequest has been processed successfully
                    Dim oSurescriptDBLayer As New gloSureScriptDBLayer
                    oSurescriptDBLayer.InsertintoMessageTransaction(CType(objPrescriber, SureScriptMessage))
                Else
                    Return False
                End If
            End If
            Return True

        Catch ex As gloSurescriptDBException
            gloSurescriptGeneral.ErrorMessage(ex.Message)
        Catch ex As GloSurescriptException
            gloSurescriptGeneral.ErrorMessage(ex.Message)
        Catch ex As Exception
            Throw New GloSurescriptException(ex.Message)
        Finally
            If Not IsNothing(strInfo) Then
                strInfo = Nothing
            End If
        End Try
        'End If
    End Function


    ''' <summary>
    ''' Gets the Prescriber information for the requested SPI
    ''' </summary>
    ''' <param name="objPrescriber"></param>
    ''' <returns></returns>
    ''' <remarks></remarks>
    ''' 
    Public Function GenerateGetPrescriber(ByVal objPrescriber As Prescriber) As Boolean
        'If ValidateAddPrescriberLocation(objPrescriber) Then

        Dim strfilepath As String = GenerateFileName(MessageType.eRefillResponse)
        XMLFilePath = strfilepath
        Dim xmlwriter As XmlTextWriter = Nothing
        Try
            If File.Exists(strfilepath) Then
                File.Delete(strfilepath)
            End If
            xmlwriter = New XmlTextWriter(strfilepath, Nothing)



            Dim dtdate As DateTime = Date.UtcNow
            Dim strdate As String = Format(dtdate, "yyyy-MM-dd")
            Dim strtime As String = Format(dtdate, "hh:mm:ss")
            Dim strmillisec As String = Format(dtdate, "mmm")
            Dim strtemp As String = dtdate.Month.ToString & dtdate.Day.ToString & dtdate.Year.ToString & dtdate.Hour.ToString & dtdate.Minute.ToString & dtdate.Second.ToString & dtdate.Millisecond.ToString

            'Dim strUTCFormat As String = dtdate.Year.ToString & "-" & "0" & dtdate.Month.ToString & "-" & dtdate.Day.ToString & "T" & dtdate.Hour.ToString & ":" & dtdate.Minute.ToString & ":" & dtdate.Second.ToString & ".0Z"
            'strUTCFormat = strdate & "T" & strtime & ".0Z"
            Dim strUTCFormat As String = DateTime.UtcNow.ToString("yyyy-MM-ddTHH:mm:ss.FZ")

            If GenerateDirectoryUploadFile(xmlwriter, strtemp, strUTCFormat, "GetPr" & strtemp) Then
                If gloSurescriptGeneral.blnStagingServer Then
                    objPrescriber.MessageFrom = "mailto:GLOSTM.dp@surescripts.com"
                Else ''setting is production
                    If gloSurescriptGeneral.blnNCPDP10dot6 = True Then
                        objPrescriber.MessageFrom = "mailto:GLOS45.dp@surescripts.com"
                    Else
                        objPrescriber.MessageFrom = "mailto:GLOSTM.dp@surescripts.com" ''as per old activation document it is GLOSTM
                    End If
                End If
                objPrescriber.MessageTo = "SSSDIR.dp@surescripts.com"
                objPrescriber.MessageID = "GetPr" & strtemp
                objPrescriber.TransactionID = objPrescriber.ProviderID
                objPrescriber.RelatesToMessageId = ""
                objPrescriber.MessageName = "GetPr"
                objPrescriber.DateReceived = Date.Now
                objPrescriber.DateTimeStamp = strUTCFormat

                xmlwriter.WriteStartElement("Body")

                xmlwriter.WriteStartElement("AddPrescriberLocation")
                xmlwriter.WriteStartElement("Prescriber")
                xmlwriter.WriteStartElement("DirectoryInformation")
                If gloSurescriptGeneral.blnStagingServer Then
                    xmlwriter.WriteElementString("PortalID", gloSurescriptGeneral.sSTAGING8DOT1PORTALID) 'The PortalID "422"
                    xmlwriter.WriteElementString("AccountID", gloSurescriptGeneral.sSTAGING10DOT6ACCOUNTID) '' The AccountID  "338"
                Else
                    xmlwriter.WriteElementString("PortalID", gloSurescriptGeneral.sSSPRODUCTIONPORTALID) 'The PortalID "264"
                    xmlwriter.WriteElementString("AccountID", gloSurescriptGeneral.sSSPRODUCTIONACCOUNTID) 'The AccountID "261"
                End If
                xmlwriter.WriteElementString("ServiceLevel", "3") 'The service level
                xmlwriter.WriteElementString("ActiveStartTime", objPrescriber.ActiveStartDate)
                xmlwriter.WriteElementString("ActiveEndTime", objPrescriber.ActiveEndDate)
                xmlwriter.WriteEndElement() 'End DirectoryInformation element

                xmlwriter.WriteStartElement("Identification")
                xmlwriter.WriteElementString("SPI", objPrescriber.PrescriberID)
                xmlwriter.WriteEndElement() 'End Identification Element

                xmlwriter.WriteEndElement() 'End PhoneNumbers element
                xmlwriter.WriteEndElement()  'End Prescriber element

                xmlwriter.WriteEndElement()  'End AddPrescriber Element
                xmlwriter.WriteEndElement()  'End Body Element
                xmlwriter.WriteEndElement()  'End Message Element
                xmlwriter.WriteEndDocument() 'End Document
                xmlwriter.Close()            'Close xml file

                'Once the message has been created post the message to Surescript N/w
                'Surescript n/w shall send a status message immediately,read the status
                'message.
                Dim strfilename As String = ExtractXML(gloSurescriptGeneral.ConvertFiletoBinary(strfilepath))
                If strfilename <> "" Then
                    ReadResponse(strfilename, "GetPrescriberResponse")
                    'Once the RefillResponse is generated now generate a FreeStanding verify message
                    'to inform surescript that RefillRequest has been processed successfully
                    Dim oSurescriptDBLayer As New gloSureScriptDBLayer
                    oSurescriptDBLayer.InsertintoMessageTransaction(CType(objPrescriber, SureScriptMessage))
                Else
                    Return False
                End If

            End If
            Return True

        Catch ex As gloSurescriptDBException
            gloSurescriptGeneral.ErrorMessage(ex.Message)
        Catch ex As GloSurescriptException
            gloSurescriptGeneral.ErrorMessage(ex.Message)
        Catch ex As Exception
            Throw New GloSurescriptException(ex.Message)
        End Try
        'End If
    End Function



    Private Function GenerateDirectoryUploadFile(ByRef myxmlwriter As XmlWriter, ByVal strtemp As String, ByVal strUTCFormat As String, ByVal strmessagename As String) As Boolean
        Dim oeRxService As New gloSureScript.eRxService.eRxMessage
        Try

            myxmlwriter.WriteStartDocument()

            myxmlwriter.WriteStartElement("Message") 'Open the Main Parent Node 

            myxmlwriter.WriteAttributeString("xmlns", "http://www.surescripts.com/messaging")

            myxmlwriter.WriteStartElement("Header")

            myxmlwriter.WriteElementString("To", "mailto:SSSDIR.dp@surescripts.com") 'The Child 

            ' myxmlwriter.WriteElementString("From", "mailto:6272787850001.spi@surescripts.com") 'The Child 
            myxmlwriter.WriteElementString("From", "mailto:GLOSTM.dp@surescripts.com") 'The Child 

            Dim MessageID As String = strmessagename
            myxmlwriter.WriteElementString("MessageID", MessageID) 'The Child 

            '  xmlwriter.WriteElementString("RelatesToMessageID", "") 'The Child 
            myxmlwriter.WriteElementString("SentTime", strUTCFormat) 'The Child 

            myxmlwriter.WriteStartElement("Security")
            myxmlwriter.WriteStartElement("UsernameToken")


            'get username and password from staging server.
            Dim stagingUserNamePassword As String = oeRxService.getLoginCredentials()
            Dim strArry As String() = stagingUserNamePassword.Split("|")
            Dim stagingUserName As String = ""
            Dim stagingPassword As String = ""
            If strArry.Length > 0 Then
                stagingUserName = strArry(0)
            End If

            If strArry.Length > 1 Then
                stagingPassword = strArry(1)
            End If



            If gloSurescriptGeneral.blnStagingServer Then
                'myxmlwriter.WriteElementString("Username", "glostream") 'The Child 
                myxmlwriter.WriteElementString("Username", stagingUserName) 'The Child 

            Else
                myxmlwriter.WriteElementString("Username", "GlostreamDir40") 'The Child 
            End If

            Dim shapwd As SHA1
            shapwd = New SHA1CryptoServiceProvider()
            'Convert.ToBase64String(shapwd.ComputeHash(Encoding.UTF8.GetBytes("los9270!")))
            myxmlwriter.WriteStartElement("Password")
            myxmlwriter.WriteAttributeString("Type", "PasswordDigest")
            ' myxmlwriter.WriteValue(FormsAuthentication.HashPasswordForStoringInConfigFile("los9270!", "SHA1")) 'The Child 
            ' myxmlwriter.WriteValue(Convert.ToBase64String(Encoding.UTF8.GetBytes("los9270!")))
            'myxmlwriter.WriteValue(Convert.ToBase64String(shapwd.ComputeHash(Encoding.Unicode.GetBytes("los9270!"))))
            If gloSurescriptGeneral.blnStagingServer Then

                'myxmlwriter.WriteValue(getPwdHash("los9270!"))
                myxmlwriter.WriteValue(getPwdHash(stagingPassword))
            Else
                myxmlwriter.WriteValue(getPwdHash("los7000!"))
                'myxmlwriter.WriteValue(getPwdHash("los6800!"))

            End If

            myxmlwriter.WriteEndElement()

            myxmlwriter.WriteElementString("Nonce", strtemp) 'The Child 

            myxmlwriter.WriteElementString("Created", strUTCFormat) 'The Child 

            myxmlwriter.WriteEndElement() 'End UsernameToken Element

            myxmlwriter.WriteEndElement() 'End Security Element

            myxmlwriter.WriteEndElement() 'End Header Element



            Return True
        Catch ex As Exception
            Return False

        End Try
    End Function
    'code added to access WCF service binding runtime
    Public Class ServiceClass
        Private Sub New()
        End Sub

        Friend Shared Function GetWCFSvc(ByVal siteUrl As String) As eRxWCFStaging.IeRxClient
            Dim client As eRxWCFStaging.IeRxClient = Nothing
            Try
                Dim serviceUri As New Uri(siteUrl)
                Dim endpointAddress As New ServiceModel.EndpointAddress(serviceUri)
                'Create the binding here
                Dim binding As WSHttpBinding = BindingFactory.CreateInstance()
                client = New eRxWCFStaging.IeRxClient(binding, endpointAddress)
                Return client
            Catch ex As Exception
                Throw ex
                Return client
            End Try
        End Function

    End Class

    Friend NotInheritable Class BindingFactory
        Private Sub New()
        End Sub
        Friend Shared Function CreateInstance() As WSHttpBinding
            Dim binding As New WSHttpBinding()
            Try
                binding.Security.Mode = SecurityMode.Transport
                binding.ReliableSession.Enabled = False
                binding.Security.Transport.ClientCredentialType = HttpClientCredentialType.None
                binding.UseDefaultWebProxy = True
                binding.ReliableSession.InactivityTimeout = New TimeSpan(0, 10, 0)


                binding.OpenTimeout = New TimeSpan(0, 10, 0)
                binding.CloseTimeout = New TimeSpan(0, 10, 0)
                binding.SendTimeout = New TimeSpan(0, 10, 10)
                binding.ReceiveTimeout = New TimeSpan(0, 10, 0)
                binding.MaxBufferPoolSize = 99999999999999
                binding.MaxReceivedMessageSize = 2147483647


                binding.ReaderQuotas.MaxArrayLength = 2147483647
                binding.ReaderQuotas.MaxDepth = 64
                binding.ReaderQuotas.MaxStringContentLength = 2147483647
                binding.ReaderQuotas.MaxBytesPerRead = 568556652
                binding.ReaderQuotas.MaxNameTableCharCount = 568556652

                Return binding
            Catch ex As Exception
                Throw ex
                Return binding
            Finally
                If Not IsNothing(binding) Then
                    binding = Nothing
                End If
            End Try
        End Function

    End Class

    '''code added to access WCF service binding runtime

    Private Function GenerateDirectoryUploadFile4dot5(ByRef myxmlwriter As XmlWriter, ByVal strtemp As String, ByVal strUTCFormat As String, ByVal strmessagename As String) As Boolean
        Dim oeRxService As eRxWCFStaging.IeRxClient = Nothing
        oeRxService = ServiceClass.GetWCFSvc(gloSurescriptGeneral.eRx10dot6StagingWebserviceURL)
        Try

            myxmlwriter.WriteStartDocument()

            myxmlwriter.WriteStartElement("Message") 'Open the Main Parent Node 

            myxmlwriter.WriteAttributeString("xmlns", "http://www.surescripts.com/messaging")

            ''added new tags in 10.6 

            myxmlwriter.WriteAttributeString("xmlns:xsi", "http://www.w3.org/2001/XMLSchema-instance")
            myxmlwriter.WriteAttributeString("version", "004")
            myxmlwriter.WriteAttributeString("release", "005")
            myxmlwriter.WriteAttributeString("xsi:schemaLocation", "http://www.surescripts.com/messaging SS_Directories_4_5_External.xsd")

            '''''''''''''''

            myxmlwriter.WriteStartElement("Header")

            myxmlwriter.WriteElementString("To", "mailto:SSSDIR.dp@surescripts.com") 'The Child 

            If gloSurescriptGeneral.blnStagingServer Then
                
                myxmlwriter.WriteElementString("From", "mailto:GLOSTM.dp@surescripts.com")

            Else ''setting is production
                If gloSurescriptGeneral.blnNCPDP10dot6 = True Then
                    myxmlwriter.WriteElementString("From", "mailto:GLOS45.dp@surescripts.com")
                Else
                    myxmlwriter.WriteElementString("From", "mailto:GLOSTM.dp@surescripts.com") ''as per old activation document it is GLOSTM
                End If
            End If


            Dim MessageID As String = strmessagename
            myxmlwriter.WriteElementString("MessageID", MessageID) 'The Child 

            '  xmlwriter.WriteElementString("RelatesToMessageID", "") 'The Child 
            myxmlwriter.WriteElementString("SentTime", strUTCFormat) 'The Child 

            myxmlwriter.WriteStartElement("Security")
            myxmlwriter.WriteStartElement("UsernameToken")


            'get username and password from staging server.
            Dim stagingUserNamePassword As String

            Dim strArry As String()
            Dim stagingUserName As String = ""
            Dim stagingPassword As String = ""
            'Bug #79671: 00000868: While saving provider user not getting posted successfully message
            If gloSurescriptGeneral.blnStagingServer Then
                stagingUserNamePassword = oeRxService.GetLoginCredentials()
                strArry = stagingUserNamePassword.Split("|")
                If strArry.Length > 0 Then
                    stagingUserName = strArry(0)
                End If

                If strArry.Length > 1 Then
                    stagingPassword = strArry(1)
                End If
                'myxmlwriter.WriteElementString("Username", "glostream") 'The Child 
                myxmlwriter.WriteElementString("Username", stagingUserName) 'The Child 

            Else
                myxmlwriter.WriteElementString("Username", "GlostreamDir40") 'The Child 
            End If

            Dim shapwd As SHA1
            shapwd = New SHA1CryptoServiceProvider()
            'Convert.ToBase64String(shapwd.ComputeHash(Encoding.UTF8.GetBytes("los9270!")))
            myxmlwriter.WriteStartElement("Password")

            ''commented tag in 10.6 changes
            'myxmlwriter.WriteAttributeString("Type", "PasswordDigest")

            ' myxmlwriter.WriteValue(FormsAuthentication.HashPasswordForStoringInConfigFile("los9270!", "SHA1")) 'The Child 
            ' myxmlwriter.WriteValue(Convert.ToBase64String(Encoding.UTF8.GetBytes("los9270!")))
            'myxmlwriter.WriteValue(Convert.ToBase64String(shapwd.ComputeHash(Encoding.Unicode.GetBytes("los9270!"))))
            If gloSurescriptGeneral.blnStagingServer Then

                'myxmlwriter.WriteValue(getPwdHash("los9270!"))
                myxmlwriter.WriteValue(getPwdHash(stagingPassword))
            Else
                myxmlwriter.WriteValue(getPwdHash("los7000!"))
                'myxmlwriter.WriteValue(getPwdHash("los6800!"))

            End If

            myxmlwriter.WriteEndElement()

            myxmlwriter.WriteElementString("Nonce", strtemp) 'The Child 

            myxmlwriter.WriteElementString("Created", strUTCFormat) 'The Child 

            myxmlwriter.WriteEndElement() 'End UsernameToken Element

            myxmlwriter.WriteEndElement() 'End Security Element

            myxmlwriter.WriteEndElement() 'End Header Element



            Return True
        Catch ex As Exception
            Return False
        Finally
            If Not IsNothing(oeRxService) Then
                oeRxService.Close()
                oeRxService = Nothing
            End If
        End Try
    End Function



    Private Function getPwdHash(ByVal strpwd As String) As String
        Dim bytHash As Byte()
        Dim uEncode As New System.Text.UnicodeEncoding()
        'Store the source string in a byte array     
        Dim bytSource() As Byte = uEncode.GetBytes(strpwd.ToUpper)
        Dim pwdsha1 As New SHA1CryptoServiceProvider()
        'Create the hash         
        bytHash = pwdsha1.ComputeHash(bytSource)
        'return as a base64 encoded string       
        Return Convert.ToBase64String(bytHash)
    End Function
#Region "Validate data before processing"
    ''' <summary>
    ''' Used to validate message header before it is sent
    ''' </summary>
    ''' <param name="omessage"></param>
    ''' <param name="oError"></param>
    ''' <param name="blnIsRefill"></param>
    ''' <returns></returns>
    ''' <remarks></remarks>
    Private Function ValidateMessageHeader(ByVal omessage As SureScriptMessage, ByVal oError As SureScriptErrorMessage, Optional ByVal blnIsRefill As Boolean = False) As Boolean
        Try
            Dim objto As New System.Text.RegularExpressions.Regex("mailto:(\d{7}|\d{10}|\d{13}).(ncpdp|spi|tp)@surescripts.com")
            Dim objdate As New System.Text.RegularExpressions.Regex("((19|20)\d{2})-(((0[1-9]|1[0-2])-(0[1-9]|[12][0-9]))|(((0[13-9])|(1[0-2]))-30)|((0[13578]|1[02])-31))T(([0-1]\d)|(2[0-4])):([0-5]\d):([0-5]\d)(.\d|.|)Z")
            If omessage.MessageID.Trim = "" Then
                oError.ErrorCode = "900"
                oError.DescriptionCode = "000"
                oError.Description = "MessageId invalid"

                gloSurescriptGeneral.UpdateLog("Message could not be read as MessageID is not available")
                gloSurescriptGeneral.InformationMessage("Message could not read as MessageID is not available")
                Exit Function
            ElseIf omessage.MessageFrom.Trim = "" Then
                oError.ErrorCode = "900"
                oError.DescriptionCode = "001"
                oError.Description = "SenderId not on file"


                gloSurescriptGeneral.UpdateLog("Message could not be read as MessageFrom is not available")
                gloSurescriptGeneral.InformationMessage("Message could not read as MessageFrom is not available")
                Exit Function


            ElseIf omessage.MessageTo.Trim = "" Then
                oError.ErrorCode = "900"
                oError.DescriptionCode = "002"
                oError.Description = "ReceiverId not on file"

                gloSurescriptGeneral.UpdateLog("Message could not be read as MessageTo is not available")
                gloSurescriptGeneral.InformationMessage("Message could not read as MessageTo is not available")
                Exit Function

            ElseIf omessage.DateTimeStamp.ToString = "" Then
                oError.ErrorCode = "900"
                oError.DescriptionCode = "029"
                oError.Description = "Date is invalid"

                gloSurescriptGeneral.UpdateLog("Message could not be read as senttime is not available")
                gloSurescriptGeneral.InformationMessage("Message could not read as senttime is not available")
                Exit Function
            End If

            If blnIsRefill = False Then
                If omessage.RelatesToMessageId = "" Then
                    oError.ErrorCode = "900"
                    oError.DescriptionCode = "026"
                    oError.Description = "Initiator Reference is invalid"

                    gloSurescriptGeneral.UpdateLog("Message could not be read as Relates to MessageID is not available")
                    gloSurescriptGeneral.InformationMessage("Message could not read as Relates to MessageID is not available")
                    Exit Function
                End If
            End If
            If objto.Match(omessage.MessageFrom).Success = False Then
                oError.ErrorCode = "900"
                oError.DescriptionCode = "001"
                oError.Description = "SenderId not on file"

                gloSurescriptGeneral.UpdateLog("Message could not be read as MessageFrom is not available")
                gloSurescriptGeneral.InformationMessage("Message could not read as MessageFrom is not available")
                Exit Function
            End If
            If objto.Match(omessage.MessageTo).Success = False Then
                oError.ErrorCode = "900"
                oError.DescriptionCode = "001"
                oError.Description = "SenderId not on file"

                gloSurescriptGeneral.UpdateLog("Message could not be read as MessageFrom is not available")
                gloSurescriptGeneral.InformationMessage("Message could not read as MessageFrom is not available")
                Exit Function
            End If

            If objdate.Match(omessage.DateTimeStamp).Success = False Then
                oError.ErrorCode = "900"
                oError.DescriptionCode = "029"
                oError.Description = "Date is invalid"

                gloSurescriptGeneral.UpdateLog("Message could not be read as senttime is not available")
                gloSurescriptGeneral.InformationMessage("Message could not read as senttime is not available")
                Exit Function
            End If
            Return True
        Catch ex As Exception
            Throw New GloSurescriptException(ex.Message)
        End Try
    End Function

    ''' <summary>
    ''' Validates Prescriber to be added to surescript network
    ''' </summary>
    ''' <param name="objPrescriber"></param>
    ''' <returns></returns>
    ''' <remarks></remarks>
    ''' 

    'code commented by sarika 20090525 -- For Removing Provider Validations
    'Private Function ValidateAddPrescriber(ByVal objPrescriber As Prescriber) As Boolean
    '    Try

    '        If objPrescriber.DEA.Trim = "" Then
    '            gloSurescriptGeneral.UpdateLog("Message could not be read as DEA not available")
    '            gloSurescriptGeneral.InformationMessage("Message could not read as DEA not available")
    '            Exit Function
    '        ElseIf objPrescriber.PrescriberName.FirstName.Trim = "" Then
    '            gloSurescriptGeneral.UpdateLog("Message could not be read as FirstName not available")
    '            gloSurescriptGeneral.InformationMessage("Message could not read as FirstName not available")
    '            Exit Function
    '        ElseIf objPrescriber.PrescriberName.LastName.Trim = "" Then
    '            gloSurescriptGeneral.UpdateLog("Message could not be read as LastName not available")
    '            gloSurescriptGeneral.InformationMessage("Message could not read as LastName not available")
    '            Exit Function
    '        ElseIf objPrescriber.PrescriberAddress.Address1.Trim = "" Then
    '            gloSurescriptGeneral.UpdateLog("Message could not be generated as Prescriber Address not available")
    '            gloSurescriptGeneral.InformationMessage("Message could not be generated as Prescriber Address not available")
    '            Exit Function
    '        ElseIf objPrescriber.PrescriberAddress.City.Trim = "" Then
    '            gloSurescriptGeneral.UpdateLog("Message could not be generated as Prescriber City not available")
    '            gloSurescriptGeneral.InformationMessage("Message could not be generated as Prescriber City not available")
    '            Exit Function
    '        ElseIf objPrescriber.PrescriberAddress.State.Trim = "" Then
    '            gloSurescriptGeneral.UpdateLog("Message could not be generated as Prescriber State not available")
    '            gloSurescriptGeneral.InformationMessage("Message could not be generated as Prescriber State not available")
    '            Exit Function
    '        ElseIf objPrescriber.PrescriberAddress.Zip.Trim = "" Then
    '            gloSurescriptGeneral.UpdateLog("Message could not be generated as Prescriber ZipCode not available")
    '            gloSurescriptGeneral.InformationMessage("Message could not be generated as Prescriber Zipcode not available")
    '            Exit Function
    '        ElseIf objPrescriber.PrescriberPhone.Phone.Trim = "" Then
    '            gloSurescriptGeneral.UpdateLog("Message could not be generated as Prescriber Phone not available")
    '            gloSurescriptGeneral.InformationMessage("Message could not be generated as Prescriber Phone not available")
    '            Exit Function
    '        ElseIf objPrescriber.ActiveStartDate.Trim = "" Then
    '            gloSurescriptGeneral.UpdateLog("Message could not be generated as Prescriber Active Start Date not available")
    '            gloSurescriptGeneral.InformationMessage("Message could not be generated as Prescriber Active Start Date not available")
    '            Exit Function
    '        ElseIf objPrescriber.ActiveEndDate.Trim = "" Then
    '            gloSurescriptGeneral.UpdateLog("Message could not be generated as Prescriber Active End Date not available")
    '            gloSurescriptGeneral.InformationMessage("Message could not be generated as Prescriber Active End Date not available")
    '            Exit Function
    '        ElseIf objPrescriber.ServiceLevel.Trim = "" Then
    '            gloSurescriptGeneral.UpdateLog("Message could not be generated as Prescriber Service Level not available")
    '            gloSurescriptGeneral.InformationMessage("Message could not be generated as Prescriber Service Level not available")
    '            Exit Function
    '        End If
    '        Return True
    '    Catch ex As Exception
    '        Throw New GloSurescriptException(ex.Message)
    '    End Try
    'End Function

    'added new method for additional validations for NCPDP 10.6
    Public Function ValidateAddPrescriber4dot4(ByVal objPrescriber As Prescriber) As String
        Dim strInfo As New System.Text.StringBuilder
        Dim sServiceLevel As String = ""
        Dim odblayer As gloSureScriptDBLayer = Nothing
        Try

            If objPrescriber.NPI.Trim = "" Then
                'If objPrescriber.DEA.Trim = "" And objPrescriber.NPI.Trim = "" Then 'commented for 10.6
                gloSurescriptGeneral.UpdateLog("Message could not be read NPI not available")
                ' gloSurescriptGeneral.InformationMessage("Message could not read as DEA not available")
                strInfo.Append("Prescriber NPI, ")
                ' Exit Function
            End If
            If objPrescriber.PrescriberName.FirstName.Trim = "" Then
                gloSurescriptGeneral.UpdateLog("Message could not be read as FirstName not available")
                ' gloSurescriptGeneral.InformationMessage("Message could not read as FirstName not available")
                strInfo.Append("Prescriber FirstName, ")
                '  Exit Function
            End If
            If objPrescriber.PrescriberName.LastName.Trim = "" Then
                gloSurescriptGeneral.UpdateLog("Message could not be read as LastName not available")
                '   gloSurescriptGeneral.InformationMessage("Message could not read as LastName not available")
                strInfo.Append("Prescriber LastName, ")
                'Exit Function
            End If
            If objPrescriber.PrescriberAddress.Address1.Trim = "" Then
                gloSurescriptGeneral.UpdateLog("Message could not be generated as Prescriber Address not available")
                '    gloSurescriptGeneral.InformationMessage("Message could not be generated as Prescriber Address not available")
                strInfo.Append("Prescriber Address, ")
                ' Exit Function
            End If
            If objPrescriber.PrescriberAddress.City.Trim = "" Then
                gloSurescriptGeneral.UpdateLog("Message could not be generated as Prescriber City not available")
                ' gloSurescriptGeneral.InformationMessage("Message could not be generated as Prescriber City not available")
                'Exit Function
                strInfo.Append("Prescriber City, ")
            End If
            If objPrescriber.PrescriberAddress.State.Trim = "" Then
                gloSurescriptGeneral.UpdateLog("Message could not be generated as Prescriber State not available")
                'gloSurescriptGeneral.InformationMessage("Message could not be generated as Prescriber State not available")
                strInfo.Append("Prescriber State, ")
                ' Exit Function
            End If
            If objPrescriber.PrescriberAddress.Zip.Trim = "" Then
                gloSurescriptGeneral.UpdateLog("Message could not be generated as Prescriber ZipCode not available")
                'gloSurescriptGeneral.InformationMessage("Message could not be generated as Prescriber Zipcode not available")
                strInfo.Append("Prescriber ZipCode, ")
                ' Exit Function
            End If
            If objPrescriber.PrescriberPhone.Phone.Trim = "" Then
                gloSurescriptGeneral.UpdateLog("Message could not be generated as Prescriber Phone not available")
                'gloSurescriptGeneral.InformationMessage("Message could not be generated as Prescriber Phone not available")
                '  Exit Function
                strInfo.Append("Prescriber Phone, ")
            End If

            If objPrescriber.PrescriberPhone.Fax.Trim = "" Then
                gloSurescriptGeneral.UpdateLog("Message could not be generated as Prescriber Fax not available")
                'gloSurescriptGeneral.InformationMessage("Message could not be generated as Prescriber Phone not available")
                '  Exit Function
                strInfo.Append("Prescriber Fax, ")
            End If

            If objPrescriber.ActiveStartDate.Trim = "" Then
                gloSurescriptGeneral.UpdateLog("Message could not be generated as Prescriber Active Start Date not available")
                '  gloSurescriptGeneral.InformationMessage("Message could not be generated as Prescriber Active Start Date not available")
                ' Exit Function
                strInfo.Append("Prescriber Active Start Date, ")
            End If
            If objPrescriber.ActiveEndDate.Trim = "" Then
                gloSurescriptGeneral.UpdateLog("Message could not be generated as Prescriber Active End Date not available")
                'gloSurescriptGeneral.InformationMessage("Message could not be generated as Prescriber Active End Date not available")
                ' Exit Function
                strInfo.Append("Prescriber Active End Date, ")
            End If
            If objPrescriber.ServiceLevel.Trim = "" Then
                gloSurescriptGeneral.UpdateLog("Message could not be generated as Prescriber Service Level not available")
                'gloSurescriptGeneral.InformationMessage("Message could not be generated as Prescriber Service Level not available")
                ' Exit Function
                strInfo.Append("Prescriber Service Level, ")
            Else
                sServiceLevel = GetServiceLevelCode(objPrescriber.ServiceLevel.Trim)

            End If

            Dim strMessage As String = ""
            If strInfo.ToString.Length > 0 Then
                If strInfo.ToString.Trim <> "" Then
                    If strInfo.ToString.Trim.EndsWith(",") Then
                        strMessage = strInfo.ToString.Trim.Substring(0, Len(strInfo.ToString.Trim) - 1) & " missing."
                        strInfo = New System.Text.StringBuilder()
                        strInfo.Append(strMessage)
                    End If

                End If
            End If
            If ValidateSpecialChar(objPrescriber.PrescriberName.FirstName.Trim & objPrescriber.PrescriberName.LastName.Trim) Then
                strInfo.Append("No special characters allowed in prescriber First Name or Last Name except single quote(') and hyphen(-) ")
            End If


            'prescriber detail validations
            If objPrescriber.DEA.Trim = "" And objPrescriber.NPI.Trim = "" Then

            ElseIf objPrescriber.NPI.Trim <> "" Then

                If objPrescriber.NPI.Length < 10 Or objPrescriber.NPI.Length > 10 Then ''''''NPI should be 10 digits only, if NPI is < 10 or > 10 digits then give message that NPI should be exactly 10 digits only. 

                    strInfo.Append("NPI number should be 10 digits.")

                Else
                    ''''using Luhn algorithm validate the NPI
                    odblayer = New gloSureScriptDBLayer
                    Dim _retVal As Boolean = True ''''bydefault assumed that NPI is valid NPI
                    If IsLunhDigitCheckAlgorithmEnble Then
                        _retVal = odblayer.ValidateNPIwithLuhn(objPrescriber.NPI)
                    End If
                    If _retVal = False Then
                        strInfo.Append("NPI in Prescriber does not pass the Luhn check digit")
                    End If
                    End If
            End If


            If objPrescriber.PrescriberLocation = True Then
                strInfo.Append(vbCrLf & "SPI number Missing.")
            End If


            If DateTime.Compare(Convert.ToDateTime(objPrescriber.ActiveEndDate), Convert.ToDateTime(objPrescriber.ActiveStartDate)) <= 0 Then
                strInfo.Append(vbCrLf & "Active End Date should be always greater than Active Start Date.")
            End If

            '''' Address Line 1 Validation
            If objPrescriber.PrescriberAddress.Address1.Trim <> "" Then
                Dim regex As RegularExpressions.Regex = New RegularExpressions.Regex("(?i)\b(?:p\.?\s*[o]\.?\s*b(?:[o]x)?|b[o]x)", RegularExpressions.RegexOptions.IgnoreCase)
                If regex.Match(objPrescriber.PrescriberAddress.Address1.Trim).Success Then
                    strInfo.Append(vbCrLf & "Address Line1 cannot start with PO Box.")
                End If
                regex = Nothing
            End If

            If sServiceLevel = "Disabled" Then
                If (DateTime.Compare(Convert.ToDateTime(objPrescriber.ActiveEndDate), DateTime.Now)) <= 0 Then
                    strInfo.Append(vbCrLf & "Active End Date should be always greater than Today.")
                End If
            End If

            '    If chckDisable.Checked = False Then
            '        If DateTime.Compare(dtpActiveEndTime.Value, DateTime.Now) >= 0 Then
            '            ' MessageBox.Show("Active End Date should be always greater than Today", gstrMessageBoxCaption, MessageBoxButtons.OK, MessageBoxIcon.Exclamation)
            '            'dtpActiveEndTime.Focus()
            '            'Exit Function

            '            strSurescriptMsg.Append(vbCrLf & "Active End Date should be always greater than Today.")

            '        End If
            '    End If





            Return strInfo.ToString()
        Catch ex As Exception
            Throw New GloSurescriptException(ex.Message)
            If Not IsNothing(odblayer) Then
                odblayer.Dispose()
                odblayer = Nothing
            End If
        Finally
            If Not IsNothing(odblayer) Then
                odblayer.Dispose()
                odblayer = Nothing
            End If
        End Try

    End Function
    Private Function ValidateSpecialChar(ByVal sString As String)
        If sString.Contains("?") Or sString.Contains("""") Or sString.Contains("(") Or sString.Contains("!") Or sString.Contains("@") Or sString.Contains("#") Or sString.Contains("%") Or sString.Contains("^") Or sString.Contains("*") Or sString.Contains(")") Or sString.Contains("~") Or sString.Contains("`") Or sString.Contains("_") Or sString.Contains("+") Or sString.Contains("=") Or sString.Contains("{") Or sString.Contains("}") Or sString.Contains("[") Or sString.Contains("]") Or sString.Contains(",") Or sString.Contains("/") Or sString.Contains(";") Or sString.Contains(":") Or sString.Contains("|") Or sString.Contains("\") Then
            Return True
        Else
            Return False
        End If
    End Function
    'method for  validations for NCPDP 8.1
    Public Function ValidateAddPrescriber(ByVal objPrescriber As Prescriber) As String
        Dim strInfo As New System.Text.StringBuilder
        Dim sServiceLevel As String = ""

        Try

            If objPrescriber.DEA.Trim = "" And objPrescriber.NPI.Trim = "" Then
                gloSurescriptGeneral.UpdateLog("Message could not be read as DEA and NPI not available")
                ' gloSurescriptGeneral.InformationMessage("Message could not read as DEA not available")
                strInfo.Append("Prescriber DEA or NPI, ")
                ' Exit Function
            End If
            If objPrescriber.PrescriberName.FirstName.Trim = "" Then
                gloSurescriptGeneral.UpdateLog("Message could not be read as FirstName not available")
                ' gloSurescriptGeneral.InformationMessage("Message could not read as FirstName not available")
                strInfo.Append("Prescriber FirstName, ")
                '  Exit Function
            End If
            If objPrescriber.PrescriberName.LastName.Trim = "" Then
                gloSurescriptGeneral.UpdateLog("Message could not be read as LastName not available")
                '   gloSurescriptGeneral.InformationMessage("Message could not read as LastName not available")
                strInfo.Append("Prescriber LastName, ")
                'Exit Function
            End If
            If objPrescriber.PrescriberAddress.Address1.Trim = "" Then
                gloSurescriptGeneral.UpdateLog("Message could not be generated as Prescriber Address not available")
                '    gloSurescriptGeneral.InformationMessage("Message could not be generated as Prescriber Address not available")
                strInfo.Append("Prescriber Address, ")
                ' Exit Function
            End If
            If objPrescriber.PrescriberAddress.City.Trim = "" Then
                gloSurescriptGeneral.UpdateLog("Message could not be generated as Prescriber City not available")
                ' gloSurescriptGeneral.InformationMessage("Message could not be generated as Prescriber City not available")
                'Exit Function
                strInfo.Append("Prescriber City, ")
            End If
            If objPrescriber.PrescriberAddress.State.Trim = "" Then
                gloSurescriptGeneral.UpdateLog("Message could not be generated as Prescriber State not available")
                'gloSurescriptGeneral.InformationMessage("Message could not be generated as Prescriber State not available")
                strInfo.Append("Prescriber State, ")
                ' Exit Function
            End If
            If objPrescriber.PrescriberAddress.Zip.Trim = "" Then
                gloSurescriptGeneral.UpdateLog("Message could not be generated as Prescriber ZipCode not available")
                'gloSurescriptGeneral.InformationMessage("Message could not be generated as Prescriber Zipcode not available")
                strInfo.Append("Prescriber ZipCode, ")
                ' Exit Function
            End If
            If objPrescriber.PrescriberPhone.Phone.Trim = "" Then
                gloSurescriptGeneral.UpdateLog("Message could not be generated as Prescriber Phone not available")
                'gloSurescriptGeneral.InformationMessage("Message could not be generated as Prescriber Phone not available")
                '  Exit Function
                strInfo.Append("Prescriber Phone, ")
            End If

            If objPrescriber.PrescriberPhone.Fax.Trim = "" Then
                gloSurescriptGeneral.UpdateLog("Message could not be generated as Prescriber Fax not available")
                'gloSurescriptGeneral.InformationMessage("Message could not be generated as Prescriber Phone not available")
                '  Exit Function
                strInfo.Append("Prescriber Fax, ")
            End If

            If objPrescriber.ActiveStartDate.Trim = "" Then
                gloSurescriptGeneral.UpdateLog("Message could not be generated as Prescriber Active Start Date not available")
                '  gloSurescriptGeneral.InformationMessage("Message could not be generated as Prescriber Active Start Date not available")
                ' Exit Function
                strInfo.Append("Prescriber Active Start Date, ")
            End If
            If objPrescriber.ActiveEndDate.Trim = "" Then
                gloSurescriptGeneral.UpdateLog("Message could not be generated as Prescriber Active End Date not available")
                'gloSurescriptGeneral.InformationMessage("Message could not be generated as Prescriber Active End Date not available")
                ' Exit Function
                strInfo.Append("Prescriber Active End Date, ")
            End If
            If objPrescriber.ServiceLevel.Trim = "" Then
                gloSurescriptGeneral.UpdateLog("Message could not be generated as Prescriber Service Level not available")
                'gloSurescriptGeneral.InformationMessage("Message could not be generated as Prescriber Service Level not available")
                ' Exit Function
                strInfo.Append("Prescriber Service Level, ")
            Else
                sServiceLevel = GetServiceLevelCode(objPrescriber.ServiceLevel.Trim)

            End If

            Dim strMessage As String = ""
            If strInfo.ToString.Length > 0 Then
                If strInfo.ToString.Trim <> "" Then
                    If strInfo.ToString.Trim.EndsWith(",") Then
                        strMessage = strInfo.ToString.Trim.Substring(0, Len(strInfo.ToString.Trim) - 1) & " missing."
                        strInfo = New System.Text.StringBuilder()
                        strInfo.Append(strMessage)
                    End If

                End If
            End If

            'prescriber detail validations
            If objPrescriber.DEA.Trim = "" And objPrescriber.NPI.Trim = "" Then

            ElseIf objPrescriber.NPI.Trim <> "" Then

                If objPrescriber.NPI.Length < 10 Or objPrescriber.NPI.Length > 10 Then ''''''NPI should be 10 digits only, if NPI is < 10 or > 10 digits then give message that NPI should be exactly 10 digits only. 
                    gloSurescriptGeneral.UpdateLog("NPI number should be 10 digits.")
                    ' gloSurescriptGeneral.InformationMessage("Message could not read as DEA not available")
                    strInfo.Append("NPI number should be 10 digits.")
                    ' Exit Function
                End If
            End If


            If objPrescriber.PrescriberLocation = True Then
                strInfo.Append(vbCrLf & "SPI number Missing.")
            End If


            If DateTime.Compare(Convert.ToDateTime(objPrescriber.ActiveEndDate), Convert.ToDateTime(objPrescriber.ActiveStartDate)) <= 0 Then
                strInfo.Append(vbCrLf & "Active End Date should be always greater than Active Start Date.")
            End If

            If sServiceLevel = "Disabled" Then
                If (DateTime.Compare(Convert.ToDateTime(objPrescriber.ActiveEndDate), DateTime.Now)) <= 0 Then
                    strInfo.Append(vbCrLf & "Active End Date should be always greater than Today.")
                End If
            End If

            '    If chckDisable.Checked = False Then
            '        If DateTime.Compare(dtpActiveEndTime.Value, DateTime.Now) >= 0 Then
            '            ' MessageBox.Show("Active End Date should be always greater than Today", gstrMessageBoxCaption, MessageBoxButtons.OK, MessageBoxIcon.Exclamation)
            '            'dtpActiveEndTime.Focus()
            '            'Exit Function

            '            strSurescriptMsg.Append(vbCrLf & "Active End Date should be always greater than Today.")

            '        End If
            '    End If





            Return strInfo.ToString()
        Catch ex As Exception
            Throw New GloSurescriptException(ex.Message)
        End Try
    End Function

    Private Function GetServiceLevelCode(ByVal sServiceLevelCode As String) As String

        If sServiceLevelCode = "0000000000000000" Then
            Return "Disable"
        ElseIf sServiceLevelCode = "0000000000000011" Then
            Return "NewAndRefill"
        ElseIf sServiceLevelCode = "0000000000000001" Then
            Return "New"
        ElseIf sServiceLevelCode = "0000000000000010" Then
            Return "Refill"
        Else
            Return "Invalid"
        End If


    End Function

    '---------------------


    ''' <summary>
    ''' Validates existing Prescriber,before adding it to new location
    ''' </summary>
    ''' <param name="objPrescriber"></param>
    ''' <returns></returns>
    ''' <remarks></remarks>
    'Public Function ValidateAddPrescriberLocation(ByVal objPrescriber As Prescriber) As Boolean
    '    Try

    '        If objPrescriber.DEA.Trim = "" Then
    '            gloSurescriptGeneral.UpdateLog("Message could not be read as DEA not available")
    '            gloSurescriptGeneral.InformationMessage("Message could not read as DEA not available")
    '            Exit Function
    '        ElseIf objPrescriber.PrescriberID.Trim = "" Then
    '            gloSurescriptGeneral.UpdateLog("Message could not be read as Prescriber ID not available")
    '            gloSurescriptGeneral.InformationMessage("Message could not read as Prescriber ID not available")
    '            Exit Function
    '        ElseIf objPrescriber.PrescriberName.FirstName.Trim = "" Then
    '            gloSurescriptGeneral.UpdateLog("Message could not be read as FirstName not available")
    '            gloSurescriptGeneral.InformationMessage("Message could not read as FirstName not available")
    '            Exit Function
    '        ElseIf objPrescriber.PrescriberName.LastName.Trim = "" Then
    '            gloSurescriptGeneral.UpdateLog("Message could not be read as LastName not available")
    '            gloSurescriptGeneral.InformationMessage("Message could not read as LastName not available")
    '            Exit Function
    '        ElseIf objPrescriber.PrescriberAddress.Address1.Trim = "" Then
    '            gloSurescriptGeneral.UpdateLog("Message could not be generated as Prescriber Address not available")
    '            gloSurescriptGeneral.InformationMessage("Message could not be generated as Prescriber Address not available")
    '            Exit Function
    '        ElseIf objPrescriber.PrescriberAddress.City.Trim = "" Then
    '            gloSurescriptGeneral.UpdateLog("Message could not be generated as Prescriber City not available")
    '            gloSurescriptGeneral.InformationMessage("Message could not be generated as Prescriber City not available")
    '            Exit Function
    '        ElseIf objPrescriber.PrescriberAddress.State.Trim = "" Then
    '            gloSurescriptGeneral.UpdateLog("Message could not be generated as Prescriber State not available")
    '            gloSurescriptGeneral.InformationMessage("Message could not be generated as Prescriber State not available")
    '            Exit Function
    '        ElseIf objPrescriber.PrescriberAddress.Zip.Trim = "" Then
    '            gloSurescriptGeneral.UpdateLog("Message could not be generated as Prescriber ZipCode not available")
    '            gloSurescriptGeneral.InformationMessage("Message could not be generated as Prescriber Zipcode not available")
    '            Exit Function
    '        ElseIf objPrescriber.PrescriberPhone.Phone.Trim = "" Then
    '            gloSurescriptGeneral.UpdateLog("Message could not be generated as Prescriber Phone not available")
    '            gloSurescriptGeneral.InformationMessage("Message could not be generated as Prescriber Phone not available")
    '            Exit Function
    '        ElseIf objPrescriber.ActiveStartDate.Trim = "" Then
    '            gloSurescriptGeneral.UpdateLog("Message could not be generated as Prescriber Active Start Date not available")
    '            gloSurescriptGeneral.InformationMessage("Message could not be generated as Prescriber Active Start Date not available")
    '            Exit Function
    '        ElseIf objPrescriber.ActiveEndDate.Trim = "" Then
    '            gloSurescriptGeneral.UpdateLog("Message could not be generated as Prescriber Active End Date not available")
    '            gloSurescriptGeneral.InformationMessage("Message could not be generated as Prescriber Active End Date not available")
    '            Exit Function
    '        ElseIf objPrescriber.ServiceLevel.Trim = "" Then
    '            gloSurescriptGeneral.UpdateLog("Message could not be generated as Prescriber Service Level not available")
    '            gloSurescriptGeneral.InformationMessage("Message could not be generated as Prescriber Service Level not available")
    '            Exit Function
    '        End If
    '        Return True
    '    Catch ex As Exception
    '        Throw New GloSurescriptException(ex.Message)
    '    End Try
    'End Function


    Public Function ValidateAddPrescriberLocation(ByVal objPrescriber As Prescriber) As String
        Dim strInfo As New System.Text.StringBuilder
        Dim odblayer As gloSureScriptDBLayer = Nothing

        Try

            If objPrescriber.DEA.Trim = "" And objPrescriber.NPI.Trim = "" Then
                gloSurescriptGeneral.UpdateLog("Message could not be read as DEA and NPI not available")
                ' gloSurescriptGeneral.InformationMessage("Message could not read as DEA not available")
                strInfo.Append("Prescriber DEA or NPI, ")
                ' Exit Function
            ElseIf objPrescriber.PrescriberID.Trim = "" Then
                gloSurescriptGeneral.UpdateLog("Message could not be read as Prescriber ID not available")
                'gloSurescriptGeneral.InformationMessage("Message could not read as Prescriber ID not available")
                'Exit Function
                strInfo.Append("Prescriber ID, ")
            ElseIf objPrescriber.PrescriberName.FirstName.Trim = "" Then
                gloSurescriptGeneral.UpdateLog("Message could not be read as FirstName not available")
                'gloSurescriptGeneral.InformationMessage("Message could not read as FirstName not available")
                'Exit Function
                strInfo.Append("Prescriber FirstName, ")
            ElseIf objPrescriber.PrescriberName.LastName.Trim = "" Then
                gloSurescriptGeneral.UpdateLog("Message could not be read as LastName not available")
                '  gloSurescriptGeneral.InformationMessage("Message could not read as LastName not available")
                ' Exit Function
                strInfo.Append("Prescriber LastName, ")
            ElseIf objPrescriber.PrescriberAddress.Address1.Trim = "" Then
                gloSurescriptGeneral.UpdateLog("Message could not be generated as Prescriber Address not available")
                ' gloSurescriptGeneral.InformationMessage("Message could not be generated as Prescriber Address not available")
                ' Exit Function
                strInfo.Append("Prescriber Address1, ")
            ElseIf objPrescriber.PrescriberAddress.City.Trim = "" Then
                gloSurescriptGeneral.UpdateLog("Message could not be generated as Prescriber City not available")
                '     gloSurescriptGeneral.InformationMessage("Message could not be generated as Prescriber City not available")
                'Exit Function
                strInfo.Append("Prescriber City, ")
            ElseIf objPrescriber.PrescriberAddress.State.Trim = "" Then
                gloSurescriptGeneral.UpdateLog("Message could not be generated as Prescriber State not available")
                'gloSurescriptGeneral.InformationMessage("Message could not be generated as Prescriber State not available")
                'Exit Function
                strInfo.Append("Prescriber State, ")
            ElseIf objPrescriber.PrescriberAddress.Zip.Trim = "" Then
                gloSurescriptGeneral.UpdateLog("Message could not be generated as Prescriber ZipCode not available")
                'gloSurescriptGeneral.InformationMessage("Message could not be generated as Prescriber Zipcode not available")
                'Exit Function
                strInfo.Append("Prescriber PrescriberAddress, ")
            ElseIf objPrescriber.PrescriberPhone.Phone.Trim = "" Then
                gloSurescriptGeneral.UpdateLog("Message could not be generated as Prescriber Phone not available")
                'gloSurescriptGeneral.InformationMessage("Message could not be generated as Prescriber Phone not available")
                'Exit Function
                strInfo.Append("Prescriber Phone, ")
            ElseIf objPrescriber.PrescriberPhone.Fax.Trim = "" Then
                gloSurescriptGeneral.UpdateLog("Message could not be generated as Prescriber Fax not available")
                'gloSurescriptGeneral.InformationMessage("Message could not be generated as Prescriber Phone not available")
                '  Exit Function
                strInfo.Append("Prescriber Fax, ")
            ElseIf objPrescriber.ActiveStartDate.Trim = "" Then
                gloSurescriptGeneral.UpdateLog("Message could not be generated as Prescriber Active Start Date not available")
                'gloSurescriptGeneral.InformationMessage("Message could not be generated as Prescriber Active Start Date not available")
                'Exit Function
                strInfo.Append("Prescriber ActiveStartDate, ")
            ElseIf objPrescriber.ActiveEndDate.Trim = "" Then
                gloSurescriptGeneral.UpdateLog("Message could not be generated as Prescriber Active End Date not available")
                'gloSurescriptGeneral.InformationMessage("Message could not be generated as Prescriber Active End Date not available")
                'Exit Function
                strInfo.Append("Prescriber ActiveEndDate, ")
            ElseIf objPrescriber.ServiceLevel.Trim = "" Then
                gloSurescriptGeneral.UpdateLog("Message could not be generated as Prescriber Service Level not available")
                'gloSurescriptGeneral.InformationMessage("Message could not be generated as Prescriber Service Level not available")
                'Exit Function
                strInfo.Append("Prescriber ServiceLevel, ")
            End If

            If ValidateSpecialChar(objPrescriber.PrescriberName.FirstName.Trim & objPrescriber.PrescriberName.LastName.Trim) Then
                strInfo.Append("No special characters allowed in prescriber First Name or Last Name except single quote(') and hyphen(-) ")
            End If


            'prescriber detail validations
            If objPrescriber.DEA.Trim = "" And objPrescriber.NPI.Trim = "" Then

            ElseIf objPrescriber.NPI.Trim <> "" Then

                If objPrescriber.NPI.Length < 10 Or objPrescriber.NPI.Length > 10 Then ''''''NPI should be 10 digits only, if NPI is < 10 or > 10 digits then give message that NPI should be exactly 10 digits only. 
                    gloSurescriptGeneral.UpdateLog("NPI number should be 10 digits.")
                    ' gloSurescriptGeneral.InformationMessage("Message could not read as DEA not available")
                    strInfo.Append("NPI number should be 10 digits, ")
                    ' Exit Function
                Else
                    If gloSurescriptGeneral.blnNCPDP10dot6 = True Then
                        ''''using Luhn algorithm validate the NPI
                        odblayer = New gloSureScriptDBLayer
                        Dim _retVal As Boolean = True ''''bydefault assumed that NPI is valid NPI
                        If IsLunhDigitCheckAlgorithmEnble Then
                            _retVal = odblayer.ValidateNPIwithLuhn(objPrescriber.NPI)
                        End If
                        If _retVal = False Then
                            strInfo.Append("NPI in Prescriber does not pass the Luhn check digit.")

                        End If
                    End If
                End If
            End If
            '''' Address Line 1 Validation
            If objPrescriber.PrescriberAddress.Address1.Trim <> "" Then
                ''  Dim regex As RegularExpressions.Regex = New RegularExpressions.Regex("(?i)\b(?:P(?:[0o]st|.?) ?0O? ?(?:B(?:.|[0o]x)?)?|B[0o]x) *([0-9]+)\b")
                '' "(?i)\b(?:P(?:[0o]st|.?) ?0O? ?(?:B(?:.|[0o]x)?)?|B[0o]x)\b"
                ''"(?i)\b(?:P(?: |.?) ?0O? ?(?:B(?:.|[0o]x)?)?|B[0o]x)\b"
                Dim regex As RegularExpressions.Regex = New RegularExpressions.Regex("(?i)\b(?:p\.?\s*[o]\.?\s*b(?:[o]x)?|b[o]x)", RegularExpressions.RegexOptions.IgnoreCase)
                If regex.Match(objPrescriber.PrescriberAddress.Address1.Trim).Success Then
                    strInfo.Append(vbCrLf & "Address Line1 cannot start with PO Box.")
                End If
                regex = Nothing
            End If

            Return strInfo.ToString
        Catch ex As Exception
            Throw New GloSurescriptException(ex.Message)
            If Not IsNothing(odblayer) Then
                odblayer.Dispose()
                odblayer = Nothing
            End If
        Finally
            If Not IsNothing(odblayer) Then
                odblayer.Dispose()
                odblayer = Nothing
            End If
        End Try
    End Function

#End Region
#Region "Convert data before processing"

    Private Function GetPhoneNumber(ByVal strphone As String) As String
        Try

            Dim strtemp As String = strphone.Replace("(", "")
            strtemp = strtemp.Replace(")", "")
            strtemp = strtemp.Replace("-", "")
            strtemp = strtemp.Replace(" ", "")
            Return strtemp
        Catch ex As Exception

        End Try
    End Function
    Private Function Getdatetype(ByVal dtdate As DateTime) As String
        Try
            If IsDate(dtdate) Then
                Dim strdate As String = Format(dtdate, "yyyyMMdd")
                'Dim dttempdate As Date = dtdate.Date
                'Dim strtemp As String = dttempdate.Year.ToString & dttempdate.Month.ToString & dttempdate.Day.ToString
                Return strdate
            Else
                Return ""
            End If
        Catch ex As Exception

        End Try
    End Function
    Private Function Getdatetimetype(ByVal dtdate As DateTime) As String
        Try
            Dim strdate As String = Format(dtdate, "yyyyMMddhhmmss")
            'Dim strtemp As String = dtdate.Year.ToString & dtdate.Month.ToString & dtdate.Day.ToString & dtdate.Hour.ToString & dtdate.Minute.ToString & dtdate.Second.ToString
            Return strdate
        Catch ex As Exception

        End Try
    End Function
#End Region



End Class

